---
kind: ConfigMap
apiVersion: v1
metadata:
  name: primeapps-auth-config-test
  namespace: primeapps
data:
  AuthDBConnection: "server=pre-test.database.svc.cluster.local;port=5432;username=postgres;password=pr!m€Appsi0d;database=auth;command timeout=0;keepalive=30;"
  TenantDBConnection: "server=pre-test.database.svc.cluster.local;port=5432;username=postgres;password=pr!m€Appsi0d;database=test;command timeout=0;keepalive=30;"
  PlatformDBConnection: "server=pre-test.database.svc.cluster.local;port=5432;username=postgres;password=pr!m€Appsi0d;database=platform;command timeout=0;keepalive=30;"
  Authority: "https://auth-test.primeapps.io"
  ForwardHeaders: "true"
  HttpsRedirection: "true"
  ValidationSkipDomains: "localhost;primeapps.io;"
  SentryDsn: "https://270a56df0bd64502b8e36883a61ae32e:cc219c09992a419b81d33248eb4097d8@log.primeapps.io/14"
---
apiVersion: v1
data:
  aspnetapp.pfx: MIIEcgIBAzCCBDgGCSqGSIb3DQEHAaCCBCkEggQlMIIEITCCAxcGCSqGSIb3DQEHBqCCAwgwggMEAgEAMIIC/QYJKoZIhvcNAQcBMBwGCiqGSIb3DQEMAQYwDgQIjpB3mdeeIIECAggAgIIC0JaqNna7TqGTDcn4dm7FFzRZ9eR8mbwIPP890dw8mZnTKjUTqajdGajlArmAb6jNyYADgmG2seQupZpdJy9GrHKc1q2nCBC2CG3dh7M1PjhKZscvFO142AEU0k0r1MeYMWlfNUEZm2HhRfYJMuek9V8Wxt2wTa/tfFdtYflEwOjYWgfmGLNgA3oZmKCGp7EMo2cUKhxXLZHu1VYKPgEGeqwy+A8WvsucbRAd6/3q0J24aJCawU9LZ2HBivPF+p0O7gYsUXdFqwKKrQrqQsUNbO3CAeZ9wBW1zOpMaP79dEVYw9+Nj2fp0g/CyyN6y8RbTYympbxrLaKE/dusbiCAv4vBuOxFGdxMdzuZiQRDl3z1+gb/w2JxHkInDEvCGXD85UNWDhmtP2MMkiAmavbxTUtg/Sq/Oo7I7zCeIg/xwoBQ4c3ipFff0y3fs1ncMjwGvkGPE2NLM+o12jTMynniv4YivG0qoGz3FhUBMIpW/caYcFBIB4Hnr6uC5LrGQ1bdweY6o5JCy0fjfxEM1GbSSY49pFgCdiSCWJTXGRR6noXQEsA6DG160l/3D7Otjo38LdlAnGews5oDXjhBWSXOryA6HAxPp92Iau7X3Th42pPJW4lx7Yk7jgk+9TzDn0ia63azGmh4zcZONGOAwzDPEQwdGgLaSSBafUaXehMLBpo1zUtWDi5jZ6XNJIXC/2XwgG9NOvZxdiwL/UOTq1D/xpAtatizLD832XDUbFNS7pUhQAik2829UyPd4/YTRDLVYuak/j8FLnNjEuFuvgDHuSMU4QCbGN+bQFhB4liqLREmpoRM2XgbE5APzZEuDBhlH70ilm/eqGEPlr1rtL9Q9JwlJ6W4QmdpwjCQGaCnlRjjNEtC1uQwwiyWWmZRBIebt8D1UxtQ5sYYnRPPOX/6JlT3jE4xIzgmxTjXlWEEih8fx4tMPWsPIM6Sv5ZX9f/ZPDCCAQIGCSqGSIb3DQEHAaCB9ASB8TCB7jCB6wYLKoZIhvcNAQwKAQKggbQwgbEwHAYKKoZIhvcNAQwBAzAOBAj5AmqafG+tXQICCAAEgZAgFNmJqqZ4VJ97kfT+chShaXvIa/Ttyt1Ez9eaw0+Uc6CfQ1wDOimOy/n4eZL+tJ5YWZ9zJNyAxRK13T1Syqgu6O5L9bokB5EVXbq/TH+ag2nYu0NnSpxd4uUzpWs5Aryy8ICAhLkxfIPsbb63NUukACehmGQBVRL6UI8HR080rBSPB2irgxLmz/2/wK3LbM0xJTAjBgkqhkiG9w0BCRUxFgQU2uYQgW4widWarW6YvlTKcW8GMv0wMTAhMAkGBSsOAwIaBQAEFF0XkY3se2LsyEvsEDIdo4rjj279BAgVBQEp6zBt1QICCAA=
kind: Secret
metadata:
  name: primeapps-auth-test-selfsigned-ssl
  namespace: primeapps
type: Opaque
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: primeapps-auth-test
  namespace: primeapps
  labels:
    k8s-app: "primeapps-auth-test"
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      k8s-app: primeapps-auth-test
  template:
    metadata:
      labels:
        k8s-app: primeapps-auth-test
    spec:
      volumes:
        - name: "self-signed-ssl"
          secret:
            secretName: primeapps-auth-test-selfsigned-ssl
      containers:
        - name: primeapps-auth-test
          image: primeapps/primeapps-auth:1.19.211.1-debian
          volumeMounts:
            - mountPath: "/etc/self-signed-ssl"
              name: self-signed-ssl
          env:
            - name: ASPNETCORE_Kestrel__Certificates__Default__Path
              value: /etc/self-signed-ssl/aspnetapp.pfx
            - name: ConnectionStrings__AuthDBConnection
              valueFrom:
                configMapKeyRef:
                  name: primeapps-auth-config-test
                  key: AuthDBConnection
            - name: ConnectionStrings__TenantDBConnection
              valueFrom:
                configMapKeyRef:
                  name: primeapps-auth-config-test
                  key: TenantDBConnection
            - name: ConnectionStrings__PlatformDBConnection
              valueFrom:
                configMapKeyRef:
                  name: primeapps-auth-config-test
                  key: PlatformDBConnection
            - name: AppSettings__Authority
              valueFrom:
                configMapKeyRef:
                  name: primeapps-auth-config-test
                  key: Authority
            - name: AppSettings__ForwardHeaders
              valueFrom:
                configMapKeyRef:
                  name: primeapps-auth-config-test
                  key: ForwardHeaders
            - name: AppSettings__HttpsRedirection
              valueFrom:
                configMapKeyRef:
                  name: primeapps-auth-config-test
                  key: HttpsRedirection
            - name: AppSettings__ValidationSkipDomains
              valueFrom:
                configMapKeyRef:
                  name: primeapps-auth-config-test
                  key: ValidationSkipDomains
            - name: Sentry__Dsn
              valueFrom:
                configMapKeyRef:
                  name: primeapps-auth-config-test
                  key: SentryDsn
          readinessProbe:
            httpGet:
              path: /
              port: 80
              scheme: HTTP
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 2
            successThreshold: 1
            failureThreshold: 1                  
---
kind: Service
apiVersion: v1
metadata:
  name: primeapps-auth-service-test
  namespace: primeapps
spec:
  type: "ClusterIP"
  selector:
    k8s-app: primeapps-auth-test
  ports:
    - name: "http"
      protocol: TCP
      port: 80
      targetPort: 80
---
kind: Ingress
apiVersion: extensions/v1beta1
metadata:
  name: primeapps-auth-ingress-test
  namespace: primeapps
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
    nginx.ingress.kubernetes.io/server-snippet: |-
      add_header X-Robots-Tag "noindex, nofollow";
spec:
  tls:
    - hosts:
        - auth-test.primeapps.io
      secretName: primeapps-wildcard-ssl
  rules:
    - host: auth-test.primeapps.io
      http:
        paths:
          - path: "/"
            backend:
              serviceName: primeapps-auth-service-test
              servicePort: 80