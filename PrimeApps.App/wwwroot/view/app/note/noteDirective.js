"use strict";angular.module("primeapps").directive("noteList",["convert","$localStorage","NoteService","FileUploader","config","$filter","helper","$cookies","$mdDialog","mdToast",function(e,t,a,n,i,o,l,r,s,p){return{restrict:"EA",scope:{moduleId:"=",recordId:"="},templateUrl:"view/app/note/noteList.html",controller:["$rootScope","$scope",function(e,n){n.user=e.user,n.pagingIcon="fa-chevron-right",n.config=e.config,n.$parent.loadingNotes=!0,n.$parent.allNotesLoaded=!1,n.$parent.currentPage=1,n.$parent.limit=10,n.addActivity=n.$parent.addActivity,n.blobUrl=blobUrl;var l,d,c=plupload.guid();n.modules=e.modules,n.globalization=e.globalization,n.newNoteForm=!1,n.newsfeed=!0,n.$parent.$parent.module&&(n.newsfeed=!1);var u={module_id:n.$parent.module.id,record_id:n.recordId,limit:n.$parent.limit,offset:0};a.count(u).then(function(t){a.find(u).then(function(a){e.processLanguages(a.data),n.$parent.notes=a.data,n.$parent.loadingNotes=!1,n.$parent.$parent.notesCount=t.data,t.data<=n.$parent.limit&&(n.$parent.hidePaging=!0)})}),n.loadMore=function(){n.$parent.allNotesLoaded||(u.offset=n.$parent.currentPage*n.$parent.limit,n.pagingIcon="fa-spinner fa-spin",a.find(u).then(function(t){if(e.processLanguages(t.data),t=t.data,n.$parent.notes=n.$parent.notes.concat(t),n.pagingIcon="fa-chevron-right",n.$parent.currentPage=n.$parent.currentPage+1,0===t.length)if(n.user.profile.has_admin_rights)n.$parent.allNotesLoaded=!0;else{if(n.$parent.allNotesLoaded)return;u.offset=n.$parent.currentPage*n.$parent.limit,n.pagingIcon="fa-spinner fa-spin",a.find(u).then(function(t){e.processLanguages(t.data),t=t.data,n.$parent.notes=n.$parent.notes.concat(t),n.pagingIcon="fa-chevron-right",n.$parent.currentPage=n.$parent.currentPage+1,n.$parent.allNotesLoaded=!0})}}))},n.addNote=function(t){if(t&&t.languages[e.globalization.Label].text.trim()){n.noteCreating=!0;var i=t.languages[e.globalization.Label].text,l={languages:t.languages};e.languageStringify(l),i.length>3800?(p.warning(o("translate")("Note.LimitWarn")),n.noteCreating=!1):a.create(l).then(function(t){t=t.data,e.processLanguage(t);for(var a=new Date,i=a.getDay(),l=(a.getDate(),a.getMonth()+1,a.getFullYear()),r=/(<([^>]+)>)/gi,s=t.text.replace(r,"").split(" "),p=0;p<s.length;p++){if(moment(s[p],"DD/MM/YYYY",!0).isValid()||moment(s[p],"DD.MM.YYYY",!0).isValid()){var d=moment(1e3*moment(s[p],"DD/MM/YYYY HH:mm").unix());t.text=t.text.replace(s[p],'<a href="" ng-click="addActivity('+d+', \'date\')" data-placement="right" bs-tooltip data-title="Etkinlik eklemek için tıklayınız"/>'+s[p]+"</a>")}var c=s[p].toLowerCase();if(o("filter")(m,{code:c},!0).length>0){var u,g=o("filter")(m,{code:c},!0)[0];if("day"===g.type){var _;if("haftaya"===s[p-1]||"hafta"===s[p-1]||"Hafta"===s[p-1]||"Haftaya"===s[p-1]){g.value>i?u=g.value-i+7:(_=i-g.value,u=7-_);var f=s[p-1]+" "+s[p];t.text=t.text.replace(f,'<a href="" ng-click="addActivity('+u+', \'null\')" data-placement="right" bs-tooltip data-title="Etkinlik eklemek için tıklayınız"/>'+s[p-1]+" "+s[p]+"</a>")}else g.value>i?u=g.value-i:(_=i-g.value,u=7-_),t.text=t.text.replace(s[p],'<a href="" ng-click="addActivity('+u+', \'null\')" data-placement="right" bs-tooltip data-title="Etkinlik eklemek için tıklayınız"/>'+s[p]+"</a>")}else if("dayTime"===g.type)u=g.value,t.text=t.text.replace(s[p],'<a href="" ng-click="addActivity('+u+', \'null\')" data-placement="right" bs-tooltip data-title="Etkinlik eklemek için tıklayınız"/>'+s[p]+"</a>");else if("month"===g.type&&(s[p-1]=parseInt(s[p-1]),s[p-1]===parseInt(s[p-1],10))){var h=s[p-1]+"."+g.value+"."+l;u=moment(1e3*moment(h,"DD/MM/YYYY HH:mm").unix());var v=s[p-1]+" "+s[p];t.text=t.text.replace(v,'<a href="" ng-click="addActivity('+u+', \'month\')" data-placement="top" bs-tooltip data-title="Etkinlik eklemek için tıklayınız"/>'+s[p-1]+" "+s[p]+"</a>")}}}var y=new Date;t.created_at=y.setSeconds(y.getSeconds()-1),n.$parent.notes.unshift(t),n.$parent.$parent.notesCount=n.$parent.notesCount+1,n.noteCreating=!1,n.newNoteForm=!1,n.note=null})["catch"](function(){n.noteCreating=!1})}},n.addComment=function(t){var i=t.subNote.languages[e.globalization.Label].text;if(i&&i.trim()){t.noteCreating=!0;var l={languages:t.subNote.languages};l.record_id=n.recordId,l.note_id=t.id,l.module_id=n.$parent.module.id,e.languageStringify(l),i.length>3800?(p.warning(o("translate")("Note.LimitWarn")),t.noteCreating=!1):a.create(l).then(function(a){t.notes||(t.notes=[]),t.notes.unshift(a.data),e.processLanguage(t),t.noteCreating=!1,t.showForm=!1,n.$parent.allNotesLoaded=!1})}},n.updateNote=function(t){var n=t.languages[e.globalization.Label].text;if(n&&n.trim()){t.noteUpdating=!0;var i={languages:t.languages};i.id=t.id,e.languageStringify(i),a.update(i).then(function(){t.noteUpdating=!1,t.showFormEdit=!1})}},n.deleteNote=function(e,t,i){var l=s.confirm().title(o("translate")("Common.AreYouSure")).targetEvent(e).ok(o("translate")("Common.Yes")).cancel(o("translate")("Common.No"));s.show(l).then(function(){a["delete"](t.id).then(function(){i?i.notes.splice(i.notes.indexOf(t),1):n.$parent.notes.splice(n.$parent.notes.indexOf(t),1),n.$parent.$parent.notesCount=n.$parent.notesCount-1})},function(){})},n.like=function(t,i){var l={note_id:t.id,user_id:n.user.id};a.like(l).then(function(){n.likeButton=!0;var l=t.id;a.get(l).then(function(t){var a=t.data;if(e.processLanguage(a),n.likeButton=!1,"sub"===i)for(var r=o("filter")(n.$parent.notes,{id:a.note_id},!0)[0],s=0;s<r.notes.length;s++){var p=r.notes[s];p.id===l&&(p.likes=a.likes)}else o("filter")(n.$parent.notes,{id:a.id},!0)[0].likes=a.likes})})},n.noteLikesList=function(e,t){n.likes=t;var a=angular.element(document.body);s.show({parent:a,templateUrl:"view/app/note/noteLikes.html",clickOutsideToClose:!1,scope:n,preserveScope:!0})},n.close=function(){s.hide()},n.imgUpload={settings:{multi_selection:!1,url:"storage/upload",headers:{Authorization:"Bearer "+t.read("access_token"),Accept:"application/json","X-Tenant-Id":r.get(preview?"preview_tenant_id":"tenant_id"),"X-App-Id":r.get(preview?"preview_app_id":"app_id")},multipart_params:{container:c,type:"note",upload_id:0,response_list:""},filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png"}],max_file_size:"2mb"},resize:{quality:90}},events:{filesAdded:function(e){e.start(),tinymce.activeEditor.windowManager.open({title:o("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+o("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,t,a){e.settings.multipart_params.response_list="",e.settings.multipart_params.upload_id=0,tinymce.activeEditor.windowManager.close();var n=JSON.parse(a.response);l(i.storage_host+n.public_url,{alt:t.name}),l=null},chunkUploaded:function(e,t,a){var n=JSON.parse(a.response);n.upload_id&&(e.settings.multipart_params.upload_id=n.upload_id),e.settings.multipart_params.response_list+=""==e.settings.multipart_params.response_list?n.e_tag:"|"+n.e_tag},error:function(e,t){switch(this.settings.multipart_params.response_list="",this.settings.multipart_params.upload_id=0,t.code){case-600:tinymce.activeEditor.windowManager.alert(o("translate")("EMail.MaxImageSizeExceeded"))}d&&(d(),d=null)}}},n.fileUpload={settings:{multi_selection:!1,unique_names:!1,url:"storage/upload",headers:{Authorization:"Bearer "+t.read("access_token"),Accept:"application/json","X-Tenant-Id":r.get(preview?"preview_tenant_id":"tenant_id"),"X-App-Id":r.get(preview?"preview_app_id":"app_id")},multipart_params:{container:c,type:"note",upload_id:0,response_list:""},filters:{mime_types:[{title:"Email Attachments",extensions:"pdf,doc,docx,xls,xlsx,csv"}],max_file_size:"50mb"}},events:{filesAdded:function(e){e.start(),tinymce.activeEditor.windowManager.open({title:o("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+o("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,t,a){this.settings.multipart_params.response_list="",this.settings.multipart_params.upload_id=0;var n=JSON.parse(a.response);l(i.storage_host+n.public_url,{alt:t.name}),l=null,tinymce.activeEditor.windowManager.close()},chunkUploaded:function(e,t,a){var n=JSON.parse(a.response);n.upload_id&&(e.settings.multipart_params.upload_id=n.upload_id),e.settings.multipart_params.response_list+=""==e.settings.multipart_params.response_list?n.e_tag:"|"+n.e_tag},error:function(e,t){switch(this.settings.multipart_params.response_list="",this.settings.multipart_params.upload_id=0,t.code){case-600:tinymce.activeEditor.windowManager.alert(o("translate")("EMail.MaxFileSizeExceeded"))}d&&(d(),d=null)}}},n.tinymceTemplate={onChange:function(){},valid_elements:"@[id|class|title|style],a[name|href|target|title|alt|ng-click],#p,blockquote,-ol,-ul,-li,br,img[src|height|width],-sub,-sup,-b,-i,-u,-span,hr",inline:!1,height:125,language:e.language,plugins:["advlist autolink lists link image charmap print preview anchor placeholder","searchreplace visualblocks code fullscreen","insertdatetime table contextmenu paste imagetools wordcount textcolor colorpicker"],toolbar:" link image imagetools ",menubar:"false",placeholder_attrs:{style:{position:"absolute",top:"5px",left:0,color:"lightgrey",padding:"1%",width:"98%",overflow:"hidden","white-space":"pre-wrap"}},skin:"custom",theme:"modern",file_picker_callback:function(e,t,a){if(l=e,"file"==a.filetype){var n=document.getElementById("uploadFile");n.click()}if("image"==a.filetype){var n=document.getElementById("uploadImage");n.click()}},image_advtab:!0,file_browser_callback_types:"image file",paste_data_images:!0,paste_as_text:!0,spellchecker_language:e.language,images_upload_handler:function(e,t,a){var i=e.blob();l=t,d=a,n.imgUpload.uploader.addFile(i)},resize:!1,width:"99,9%",toolbar_items_size:"small",statusbar:!1};var m=[{code:"pazartesi",type:"day",value:1},{code:"salı",type:"day",value:2},{code:"&ccedil;arşamba",type:"day",value:3},{code:"perşembe",type:"day",value:4},{code:"cuma",type:"day",value:5},{code:"cumartesi",type:"day",value:6},{code:"pazar",type:"day",value:7},{code:"bug&uuml;n",type:"dayTime",value:0},{code:"yarın",type:"dayTime",value:1},{code:"ocak",type:"month",value:1},{code:"şubat",type:"month",value:2},{code:"mart",type:"month",value:3},{code:"nisan",type:"month",value:4},{code:"mayıs",type:"month",value:5},{code:"haziran",type:"month",value:6},{code:"temmuz",type:"month",value:7},{code:"ağustos",type:"month",value:8},{code:"eyl&uuml;l",type:"month",value:9},{code:"ekim",type:"month",value:10},{code:"kasım",type:"month",value:11},{code:"aralık",type:"month",value:12}]}]}}]).directive("noteForm",["$filter","$localStorage","FileUploader","config","convert","entityTypes","NoteService","$cookies",function(e,t,a,n,i,o,l,r){return{restrict:"EA",scope:{recordId:"=",show:"="},templateUrl:"view/app/note/noteForm.html",controller:["$scope","$rootScope",function(a,i){a.noteCreating=!1,a.globalization=i.globalization;var o,s,p=plupload.guid();a.create=function(t){if(t&&t.languages[i.globalization.Label].text.trim()){var n=t.languages[i.globalization.Label].text;a.noteCreating=!0;var o={languages:t.languages};o.record_id=a.recordId,o.module_id=a.$parent.module.id,i.languageStringify(o),n.length>3800?(mdToast.warning(e("translate")("Note.LimitWarn")),a.noteCreating=!1):l.create(o).then(function(e){e=e.data,i.processLanguage(e);var t=new Date;e.created_at=t.setSeconds(t.getSeconds()-1),a.$parent.notes.unshift(e),a.$parent.$parent.notesCount=a.$parent.notesCount+1,a.noteCreating=!1,a.show=!1,a.note=null})["catch"](function(){a.noteCreating=!1})}},a.imgUploadForm={settings:{multi_selection:!1,url:"storage/upload",multipart_params:{container:p,type:"note",upload_id:0,response_list:""},filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png"}],max_file_size:"2mb"},resize:{quality:90}},events:{filesAdded:function(t){t.start(),tinymce.activeEditor.windowManager.open({title:e("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+e("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,t,a){e.settings.multipart_params.response_list="",e.settings.multipart_params.upload_id=0,tinymce.activeEditor.windowManager.close();var i=JSON.parse(a.response);o(n.storage_host+i.public_url,{alt:t.name}),o=null},chunkUploaded:function(e,t,a){var n=JSON.parse(a.response);n.upload_id&&(e.settings.multipart_params.upload_id=n.upload_id),e.settings.multipart_params.response_list+=""==e.settings.multipart_params.response_list?n.e_tag:"|"+n.e_tag},error:function(t,a){switch(this.settings.multipart_params.response_list="",this.settings.multipart_params.upload_id=0,a.code){case-600:tinymce.activeEditor.windowManager.alert(e("translate")("EMail.MaxImageSizeExceeded"))}s&&(s(),s=null)}}},a.fileUploadForm={settings:{multi_selection:!1,unique_names:!1,url:"storage/upload",headers:{Authorization:"Bearer "+t.read("access_token"),Accept:"application/json","X-Tenant-Id":r.get(preview?"preview_tenant_id":"tenant_id"),"X-App-Id":r.get(preview?"preview_app_id":"app_id")},multipart_params:{container:p,type:"note",upload_id:0,response_list:""},filters:{mime_types:[{title:"Email Attachments",extensions:"pdf,doc,docx,xls,xlsx,csv"}],max_file_size:"50mb"}},events:{filesAdded:function(t){t.start(),tinymce.activeEditor.windowManager.open({title:e("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+e("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,t,a){this.settings.multipart_params.response_list="",this.settings.multipart_params.upload_id=0;var n=JSON.parse(a.response);o(n.public_url,{alt:t.name}),o=null,tinymce.activeEditor.windowManager.close()},chunkUploaded:function(e,t,a){var n=JSON.parse(a.response);n.upload_id&&(e.settings.multipart_params.upload_id=n.upload_id),e.settings.multipart_params.response_list+=""==e.settings.multipart_params.response_list?n.e_tag:"|"+n.e_tag},error:function(t,a){switch(this.settings.multipart_params.response_list="",this.settings.multipart_params.upload_id=0,a.code){case-600:tinymce.activeEditor.windowManager.alert(e("translate")("EMail.MaxFileSizeExceeded"))}s&&(s(),s=null)}}},a.tinymceTemplate={onChange:function(){},inline:!1,height:80,language:i.language,plugins:["advlist autolink lists link image charmap print preview anchor placeholder","searchreplace visualblocks code fullscreen","insertdatetime table contextmenu paste imagetools wordcount textcolor colorpicker"],toolbar:" link image imagetools ",menubar:"false",placeholder_attrs:{style:{position:"absolute",top:"5px",left:0,color:"lightgrey",padding:"1%",width:"98%",overflow:"hidden","white-space":"pre-wrap"}},skin:"custom",theme:"modern",file_picker_callback:function(e,t,a){if(o=e,"file"==a.filetype){var n=document.getElementById("uploadFile");n.click()}if("image"==a.filetype){var n=document.getElementById("uploadImage");n.click()}},image_advtab:!0,file_browser_callback_types:"image file",paste_data_images:!0,paste_as_text:!0,spellchecker_language:i.language,images_upload_handler:function(e,t,n){var i=e.blob();o=t,s=n,a.imgUploadForm.uploader.addFile(i)},resize:!1,width:"99,9%",toolbar_items_size:"small",statusbar:!1}}]}}]).directive("compile",["$compile",function(e){return function(t,a,n){t.$watch(function(e){return e.$eval(n.compile)},function(n){a.html(n),e(a.contents())(t)})}}]).directive("onEnter",function(){return function(e,t,a){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(a.onEnter,{event:t})}),t.preventDefault())})}});