"use strict";angular.module("primeapps").controller("ViewFormController",["$rootScope","$scope","$state","$stateParams","$location","$filter","$cache","$q","helper","operators","ModuleService","ViewService","$http","config","mdToast",function(e,t,a,l,i,r,s,o,u,n,c,v,d,m,f){var p=i.search().clone,h=i.search().id,w=r("filter")(e.modules,{name:l.type},!0)[0];if(t.costumeDate="this_day()",t.dateFormat=[{label:r("translate")("View.Second"),value:"s"},{label:r("translate")("View.Minute"),value:"m"},{label:r("translate")("View.Hour"),value:"h"},{label:r("translate")("View.Day"),value:"D"},{label:r("translate")("View.Week"),value:"W"},{label:r("translate")("View.Month"),value:"M"},{label:r("translate")("View.Year"),value:"Y"}],t.costumeDateFilter=[{name:"thisNow",label:r("translate")("View.Now"),value:"now()"},{name:"thisToday",label:r("translate")("View.StartOfTheDay"),value:"today()"},{name:"thisWeek",label:r("translate")("View.StartOfThisWeek"),value:"this_week()"},{name:"thisMonth",label:r("translate")("View.StartOfThisMonth"),value:"this_month()"},{name:"thisYear",label:r("translate")("View.StartOfThisYear"),value:"this_year()"},{name:"year",label:r("translate")("View.NowYear"),value:"year()"},{name:"month",label:r("translate")("View.NowMonth"),value:"month()"},{name:"day",label:r("translate")("View.NowDay"),value:"day()"},{name:"costume",label:r("translate")("View.CustomDate"),value:"costume"},{name:"todayNextPrev",label:r("translate")("View.FromTheBeginningOfTheDay"),value:"costumeN",nextprevdatetype:"D"},{name:"weekNextPrev",label:r("translate")("View.FromTheBeginningOfTheWeek"),value:"costumeW",nextprevdatetype:"M"},{name:"monthNextPrev",label:r("translate")("View.FromTheBeginningOfTheMonth"),value:"costumeM",nextprevdatetype:"M"},{name:"yearNextPrev",label:r("translate")("View.FromTheBeginningOfTheYear"),value:"costumeY",nextprevdatetype:"Y"}],t.dateChange=function(e){"costume"!=e.costumeDate&&"costumeN"!=e.costumeDate&&"costumeW"!=e.costumeDate&&"costumeM"!=e.costumeDate&&"costumeY"!=e.costumeDate&&(e.value=e.costumeDate),("costumeN"===e.costumeDate||"costumeW"===e.costumeDate||"costumeM"===e.costumeDate||"costumeY"===e.costumeDate)&&(e.value="",e.valueX="",e.nextprevdatetype="")},t.nextPrevDateChange=function(e){t.setCostumDate(e)},t.nextPrevDateTypeChange=function(e){t.setCostumDate(e)},t.setCostumDate=function(e){if(null===e.valueX||""===e.valueX||void 0===e.valueX)return e.value="",!1;switch(void 0===e.nextprevdatetype&&(e.nextprevdatetype=t.dateFormat[0].value),e.costumeDate){case"costumeN":e.value="today("+e.valueX+e.nextprevdatetype+")";break;case"costumeM":e.value="this_month("+e.valueX+e.nextprevdatetype+")";break;case"costumeW":e.value="this_week("+e.valueX+e.nextprevdatetype+")";break;case"costumeY":e.value="this_year("+e.valueX+e.nextprevdatetype+")"}},!w)return f.warning(r("translate")("Common.NotFound")),void a.go("app.dashboard");t.module=w;var g=w.name+"_"+w.name,y=s.get(g);if(!y||!y.views||y.views.length<1)return void a.go("app.moduleList",{type:w.name});if(h){var _=y.views;if(t.view=angular.copy(r("filter")(_,{id:parseInt(h)},!0)[0]),t.view.label=t.view["label_"+e.language],t.isOwner=t.view.created_by===e.user.id,!t.view)return void a.go("app.moduleList",{type:w.name});t.view.filter_logic&&"tr"===e.language&&(t.view.filter_logic=t.view.filter_logic.replace(/or/g,"veya").replace(/and/g,"ve"))}else t.view={},t.view.system_type="custom",t.view.sharing_type="me";r("filter")(e.approvalProcesses,{module_id:w.id},!0)[0]&&(t.showProcessFilter=!0,t.currenProcessField={field:"process.process_requests.process_status",order:t.view.fields?t.view.fields.length:0},t.currenProcessFilter=r("filter")(t.view.filters,{field:"process.process_requests.process_status"},!0),t.currenProcessFilter=!t.currenProcessFilter||t.currenProcessFilter.length<1?{field:"process.process_requests.process_status",operator:"equals",value:"0"}:t.currenProcessFilter[0],t.currenProcessFilter.field="process.process_requests.process_status",t.processFilter=t.currenProcessFilter.value),t.fields=v.getFields(t.module,angular.copy(t.view));document.querySelector("#availableFields"),document.querySelector("#selectedFields");t.$on("dragulardrop",function(){t.viewForm.$setValidity("field",!0)}),c.getPicklists(t.module,!0).then(function(a){t.modulePicklists=a,t.view.filterList=[];for(var l=0;10>l;l++){var i={};i.field=null,i.operator=null,i.value=null,i.no=l+1,t.view.filterList.push(i)}if(t.view.filters){t.view.filters=r("orderBy")(t.view.filters,"no");for(var s=0;s<t.view.filters.length;s++){"process.process_requests.process_status"===t.view.filters[s].field&&t.view.filters.splice(s,1);var o=t.view.filters[s].field,u=t.view.filters[s].value;o.indexOf(".")>-1&&(o=o.split(".")[0],t.view.filters[s].field=o);var c=r("filter")(t.module.fields,{name:o},!0)[0],v=null;if(!c)return;switch(c.data_type){case"picklist":v=r("filter")(t.modulePicklists[c.picklist_id],{labelStr:u},!0)[0];break;case"multiselect":v=[];var d=u.split("|");angular.forEach(d,function(e){var a=r("filter")(t.modulePicklists[c.picklist_id],{labelStr:e},!0)[0];a&&v.push(a)});break;case"tag":v=[];var m=u.split("|");angular.forEach(m,function(e){v.push(e)});break;case"lookup":if("users"===c.lookup_type){var f={};if("0"===u||"[me]"===u)f.id=0,f.email="[me]",f.full_name=r("translate")("Common.LoggedInUser");else if("-"!=u){var p=r("filter")(e.users,{id:parseInt(u)},!0)[0];f.id=p.id,f.email=p.Email,f.full_name=p.FullName}v=[f]}else v=u;break;case"date":case"date_time":case"time":t.isCostumeDate(t.view.filters[s])?(v=t.view.filters[s].value,t.view.filterList[s].costumeDate=t.view.filters[s].costumeDate,t.view.filterList[s].valueX=t.view.filters[s].valueX,t.view.filterList[s].nextprevdatetype=t.view.filters[s].nextprevdatetype):(v=new Date(u),t.view.filterList[s].costumeDate="costume",t.view.filters[s].costumeDate="costume");break;case"checkbox":v=r("filter")(t.modulePicklists.yes_no,{system_code:u},!0)[0];break;default:v=u}t.view.filterList[s].field=c,t.view.filterList[s].operator=n[t.view.filters[s].operator],t.view.filterList[s].value=v,("empty"===t.view.filters[s].operator||"not_empty"===t.view.filters[s].operator)&&(t.view.filterList[s].value=null,t.view.filterList[s].disabled=!0)}}}),t.multiselect=function(e,a){var l=[];return angular.forEach(t.modulePicklists[a.picklist_id],function(t){t.inactive||t.labelStr.toLowerCase().indexOf(e)>-1&&l.push(t)}),l},t.tags=function(e,t){return d.get(m.apiUrl+"tag/get_tag/"+t.id).then(function(t){var a=t.data;return a.filter(function(t){return-1!=t.text.toLowerCase().indexOf(e.toLowerCase())})})},t.lookupUser=u.lookupUser;var b=function(e){if(e.operator){var t=new Date(e.value);switch(e.operator.name){case"greater":t.setHours(23),t.setMinutes(59),t.setSeconds(59),t.setMilliseconds(99);break;case"less":t.setHours(0),t.setMinutes(0),t.setSeconds(0),t.setMilliseconds(0)}e.value=t}};t.dateTimeChanged=function(e){b(e)},t.isCostumeDate=function(e){return e.value.indexOf("now(")>-1?(e.costumeDate="now()",!0):e.value.indexOf("today(")>-1?/\d+/.test(e.value)?(e.costumeDate="costumeN",e.valueX=parseFloat(e.value.replace(/[^\d.-]/g,"")),e.nextprevdatetype=e.value.match(/([A-z])\)/g,"")[0].match(/[A-z]/g,"")[0],!0):(e.costumeDate="today()",!0):"year()"===e.value?(e.costumeDate="year()",!0):"month()"===e.value?(e.costumeDate="month()",!0):"day()"===e.value?(e.costumeDate="day()",!0):e.value.indexOf("this_week(")>-1?/\d+/.test(e.value)?(e.costumeDate="costumeW",e.valueX=parseFloat(e.value.replace(/[^\d.-]/g,"")),e.nextprevdatetype=e.value.match(/([A-z])\)/g,"")[0].match(/[A-z]/g,"")[0],!0):(e.costumeDate="this_week()",!0):e.value.indexOf("this_month(")>-1?/\d+/.test(e.value)?(e.costumeDate="costumeM",e.valueX=parseFloat(e.value.replace(/[^\d.-]/g,"")),e.nextprevdatetype=e.value.match(/([A-z])\)/g,"")[0].match(/[A-z]/g,"")[0],!0):(e.costumeDate="this_month()",!0):e.value.indexOf("this_year(")>-1?/\d+/.test(e.value)?(e.costumeDate="costumeY",e.valueX=parseFloat(e.value.replace(/[^\d.-]/g,"")),e.nextprevdatetype=e.value.match(/([A-z])\)/g,"")[0].match(/[A-z]/g,"")[0],!0):(e.costumeDate="this_year()",!0):!1},t.operatorChanged=function(e,a){var l=t.view.filterList[a];l&&l.operator&&("date_time"===e.data_type&&l.value&&"costume"===l.costumeDate&&b(l),"empty"===l.operator.name||"not_empty"===l.operator.name?(l.value=null,l.disabled=!0):l.disabled=!1)},t.save=function(){function l(){var e=!0;return p&&(h=!1),t.fields.selectedFields.length<1&&(t.viewForm.$setValidity("field",!1),e=!1),e}function i(){s.remove(g),a.go("app.moduleList",{type:w.name})}function o(e,a){400===a&&(e.model_state&&e.model_state["view._filter_logic"]&&t.viewForm.filterLogic.$setValidity("filterLogic",!1),e.model_state&&e.model_state["request._filter_logic"]&&t.viewForm.filterLogic.$setValidity("filterLogicFilters",!1))}if(t.viewForm.$valid&&l()){t.submitting=!0;var u={};u.module_id=w.id,u.label=t.view.label,u.sharing_type=t.view.sharing_type,u.fields=[],u.filters=[],t.view.filter_logic&&(u.filter_logic=t.view.filter_logic.replace(/veya/g,"or").replace(/ve/g,"and"),("("!==u.filter_logic.charAt(0)||")"!==u.filter_logic.charAt(u.filter_logic.length-1))&&(u.filter_logic="("+u.filter_logic+")"));for(var n=0;n<t.fields.selectedFields.length;n++){var d=t.fields.selectedFields[n],m={};if(m.field=d.name,m.order=n+1,u.fields.push(m),d.lookup_type&&"relation"!=d.lookup_type){var f=r("filter")(e.modules,{name:d.lookup_type},!0)[0],_=r("filter")(f.fields,{primary:!0},!0)[0],b={};b.field=d.name+"."+f.name+"."+_.name+".primary",b.order=n+1,u.fields.push(b)}}var k=angular.copy(t.view.filterList);angular.forEach(k,function(t){if(t.field&&t.operator&&("empty"===t.operator.name||"not_empty"===t.operator.name||null!=t.value&&void 0!=t.value)){var a=t.field,l=a.name;if("lookup"===a.data_type&&"users"!=a.lookup_type){var i=r("filter")(e.modules,{name:a.lookup_type},!0)[0],s=r("filter")(i.fields,{primary:!0},!0)[0];l=a.name+"."+a.lookup_type+"."+s.name;var o=l+".primary";if(!r("filter")(u.fields,{field:o},!0)[0]){var n={};n.field=a.name,n.order=u.fields.length+1,u.fields.push(n);var c={};c.field=o,c.order=u.fields.length,u.fields.push(c)}}var v={};if(v.field=l,v.operator=t.operator.name,v.value=t.value,v.no=t.no,a=t.field.lookupModulePrimaryField&&"users"!==t.field.lookup_type?t.field.lookupModulePrimaryField:t.field,"empty"!==t.operator.name&&"not_empty"!==t.operator.name){if("picklist"===a.data_type&&(v.value=v.value.label[e.user.tenant_language]),"multiselect"===a.data_type){var d="";angular.forEach(v.value,function(t){d+=t.label[e.user.tenant_language]+"|"}),v.value=d.slice(0,-1)}if("tag"===a.data_type){var d="";angular.forEach(v.value,function(e){d+=e.text+"|"}),v.value=d.slice(0,-1)}"lookup"===a.data_type&&"users"===a.lookup_type&&(v.value=0===v.value[0].id?"[me]":v.value[0].id),"checkbox"===a.data_type&&(v.value=v.value.system_code)}else v.value="-";u.filters.push(v)}}),"custom"===t.view.sharing_type&&(t.view.shares?(u.shares=[],angular.forEach(t.view.shares,function(e){u.shares.push(e.id)})):u.sharing_type="me"),t.currenProcessFilter&&"0"!=t.currenProcessFilter.value&&u.filters.push(t.currenProcessFilter),t.currenProcessField&&"0"!=t.currenProcessFilter.value&&u.fields.push(t.currenProcessField),h?v.update(u,t.view.id,t.view._rev).then(function(){i()})["catch"](function(e){o(e.data,e.status)})["finally"](function(){t.submitting=!1}):v.create(u).then(function(e){var a=y.viewState;a||(a={},a.sort_field="created_at",a.sort_direction="desc",a.row_per_page=10),a.active_view=e.data.id,c.setViewState(a,t.module.id,a.id).then(function(){i()})["finally"](function(){t.submitting=!1})})["catch"](function(e){o(e.data,e.status)})["finally"](function(){t.submitting=!1})}}}]);