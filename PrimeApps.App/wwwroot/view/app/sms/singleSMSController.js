"use strict";angular.module("primeapps").controller("SingleSMSController",["$rootScope","$scope","$filter","ModuleService","$mdDialog","mdToast","TemplateService",function(e,t,a,n,l,s,i){function m(e){switch(!1){case null==e.match(p):return h;case null==e.match(f):return M;default:return g}}function r(e){var t,a;return a=function(){var a,n,l;for(l=[],a=0,n=e.length;n>a;a++)t=e[a],null!=t.match(S)&&l.push(t);return l}.call(this),a.length}function c(e){if(t.txtSMS){t.txtSMS=t.txtSMS.replace(/(\r\n|\n|\r)/gm," ");var a,n,l,s;return a=m(e),n=e.length,a===M&&(n+=r(e)),s=_[a],n>s&&(s=T[a]),l=Math.ceil(n/s)}}function o(e){var t=document.createElement("div");return t.innerHTML=e,t.innerText}var d="@£$¥èéùìòÇ\\nØø\\rÅåΔ_ΦΓΛΩΠΨΣΘΞÆæßÉ !\\\"#¤%&'()*+,-./0123456789:;<=>?¡ABCDEFGHIJKLMNOPQRSTUVWXYZÄÖÑÜ§¿abcdefghijklmnopqrstuvwxyzäöñüà",u="\\^{}\\\\\\[~\\]|€",p=RegExp("^["+d+"]*$"),f=RegExp("^["+d+u+"]*$"),S=RegExp("^[\\"+u+"]*$"),h="GSM_7BIT",M="GSM_7BIT_EX",g="UTF16",_={GSM_7BIT:160,GSM_7BIT_EX:160,UTF16:70},T={GSM_7BIT:153,GSM_7BIT_EX:153,UTF16:67};t.formType="sms",i.getAll("email").then(function(e){t.templates=[];for(var a=0;a<e.data.length;a++)"SMS"===e.data[a].subject&&t.templates.push(e.data[a]);t.loadingModal=!1})["catch"](function(){t.loadingModal=!1}),t.moduleFields=i.getFields(t.$parent.module,t.$parent.view),t.smstemplate={},t.smstemplate.system_type="custom",t.smstemplate.sharing_type="me",t.loadingModal=!0,t.txtSMS="",t.totalSMS=0,t.tinymceModel="",t.getTagTextRaw=function(e){return e.name.indexOf("seperator")<0?"{"+e.name+"}":void 0},t.searchTags=function(e){for(var a=[],n=0;n<t.moduleFields.length;n++){var l=t.moduleFields[n];if("seperator"===l.name)return;l.label.indexOf(e)>=0&&a.push(l)}return t.tags=a,a},t.backTemplate=function(){t.tinymceModel=t.smstemplate.tinymce_content,t.smstemplate.template_name&&(t.template=a("filter")(t.templates,{name:t.smstemplate.template_name},!0)[0])},t.addCustomField=function(e,a){a&&(t.tinymceModel||(t.tinymceModel=""),t.tinymceModel+="{"+a.name+"}")},t.tinymceOptions=function(a){t[a]={init_instance_callback:function(e){t.iframeElement[a]=e.iframeElement},resize:!1,width:"136%",height:160,language:e.language,menubar:!1,statusbar:!1,toolbar:!1}},t.iframeElement={},t.tinymceOptions("tinymceTemplate"),t.tinymceOptions("tinymceTemplateEdit"),t.calculateSMS=function(){t.totalSMS=c(t.txtSMS)},t.filterKey=function(e){var t=new RegExp("^[^\n\r]*$"),a=String.fromCharCode(e.which),n=angular.element(e.srcElement).val();t.test(a)&&t.test(n)||event.preventDefault()},t.phoneField=a("filter")(t.allFields,{name:"mobile"})[0],t.submitSMS=function(){t.smsModalForm.validate()&&(t.selectedIds=[],t.selectedIds.push(t.$parent.record.id),t.submittingModal=!0,n.sendSMS(t.$parent.module.id,t.selectedIds,angular.toJson(t.$parent.findRequest),t.$parent.$parent.isAllSelected,t.txtSMS.replace(/(\r\n|\n|\r)/gm," "),t.phoneField.name,t.template).then(function(){t.submittingModal=!1,l.hide(),t.$parent.isAllSelected&&(t.$parent.isAllSelected=!1),t.$parent.selectedRows&&(t.$parent.selectedRows=[]),s.success(a("translate")("SMS.MessageQueued"))})["catch"](function(){t.submittingModal=!1,t.smsModal.hide(),t.$parent.isAllSelected=!1,t.$parent.selectedRows=[],s.error(a("translate")("Common.Error"))}))},t.close=function(){t.template={},l.hide()},t.customFieldOptions={dataSource:a("filter")(t.allFields,function(e){return"checkbox"!==e.data_type&&"text_multi"!==e.data_type},!0),dataTextField:"label",dataValueField:"name"},t.phoneFieldOptions={dataSource:a("filter")(t.allFields,function(e){return"number"==e.data_type||"text_single"==e.data_type},!0),dataTextField:"label",dataValueField:"name"},t.setTemplate=function(){t.smstemplate.template_subject=t.Subject,t.smstemplate.tinymce_content=t.tinymceModel},t.setContent=function(e){if(e){var n=a("filter")(t.templates,{id:e.id},!0)[0];n?(t.tinymceModel=o(n.content),t.calculateSMS(t.tinymceModel),t.smstemplate.template_name=n.name,t.currentTemplate=n):(t.tinymceModel=null,t.calculateSMS(t.tinymceModel),t.smstemplate.template_name=null)}},t.templateOptions={dataSource:{transport:{read:function(e){e.success(t.templates)}}},dataBound:t.templates,change:function(){var e=this.value();t.setContent(e)},dataTextField:"name",dataValueField:"id"},t.templateSave=function(){var e={};e.module_id=t.$parent.module.id,e.module=t.module.name,e.name=t.smstemplate.template_name,e.subject="SMS",e.content=t.smstemplate.tinymce_content,e.sharing_type=t.smstemplate.sharing_type,e.template_type=2,e.active=!0,"custom"===t.smstemplate.sharing_type&&(e.shares=[],angular.forEach(t.smstemplate.shares,function(t){e.shares.push(t.id)}));var n;t.currentTemplate?(e.id=t.currentTemplate.id,n=i.update(e)):n=i.create(e),n.then(function(e){t.currentTemplate=e.data,i.getAll("sms").then(function(e){t.templates=[];for(var n=0;n<e.data.length;n++)t.templates.push(e.data[n]);t.template=t.currentTemplate,t.setContent(t.currentTemplate),s.success(a("translate")("Template.SuccessMessage"))})})},t.templateDelete=function(){var e=t.template;i["delete"](e).then(function(){i.getAll("email","","SMS").then(function(e){t.templates=[];for(var a=0;a<e.data.length;a++)"SMS"===e.data[a].subject&&t.templates.push(e.data[a])}),s.success(a("translate")("Template.SuccessDelete"))})},t.sharesOptions={dataSource:t.users,filter:"contains",dataTextField:"full_name",dataValueField:"id"}}]);