"use strict";angular.module("primeapps").controller("BulkSMSController",["$rootScope","$scope","ngToast","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","config","ModuleService","TemplateService",function(e,t,n,a,l,r,s,m,i,c,o,p,u,d,f){function $(e){var t=document.createElement("div");return t.innerHTML=e,t.innerText}function h(e){switch(!1){case null==e.match(T):return F;case null==e.match(_):return E;default:return b}}function g(e){var t,n;return n=function(){var n,a,l;for(l=[],n=0,a=e.length;a>n;n++)t=e[n],null!=t.match(v)&&l.push(t);return l}.call(this),n.length}function M(e){if(t.tinymceModel){t.tinymceModel=t.tinymceModel.replace(/(\r\n|\n|\r)/gm," ");var n,a,l,r;return n=h(e),a=e.length,n===E&&(a+=g(e)),r=R[n],a>r&&(r=q[n]),l=Math.ceil(a/r)}}var S="@£$¥èéùìòÇ\\nØø\\rÅåΔ_ΦΓΛΩΠΨΣΘΞÆæßÉ !\\\"#¤%&'()*+,-./0123456789:;<=>?¡ABCDEFGHIJKLMNOPQRSTUVWXYZÄÖÑÜ§¿abcdefghijklmnopqrstuvwxyzäöñüà",y="\\^{}\\\\\\[~\\]|€",T=RegExp("^["+S+"]*$"),_=RegExp("^["+S+y+"]*$"),v=RegExp("^[\\"+y+"]*$"),F="GSM_7BIT",E="GSM_7BIT_EX",b="UTF16",R={GSM_7BIT:160,GSM_7BIT_EX:160,UTF16:70},q={GSM_7BIT:153,GSM_7BIT_EX:153,UTF16:67};t.formType="sms",t.getTagTextRaw=function(e){return e.name.indexOf("seperator")<0?"{"+e.name+"}":void 0},t.moduleFields=f.getFields(t.$parent.$parent.$parent.module,t.$parent.$parent.$parent.view),t.searchTags=function(e){var n=[];return angular.forEach(t.moduleFields,function(t){"seperator"!=t.name&&t.label.indexOf(e)>=0&&n.push(t)}),t.tags=n,n},t.setTemplate=function(){t.smstemplate.template_subject=t.Subject,t.smstemplate.tinymce_content=t.tinymceModel},f.getAll("email").then(function(e){t.templates=e.data}),t.setContent=function(e){var n=a("filter")(t.templates,{id:e},!0)[0];e?(t.tinymceModel=$(n.content),t.smstemplate.template_name=n.name,t.currentTemplate=n):(t.tinymceModel=null,t.smstemplate.template_name=null)},t.moduleFields=f.getFields(t.module),t.phoneFields=[],angular.forEach(t.moduleFields,function(e){"mobile"!==e.name||e.deleted||"users"==e.parent_type||t.phoneFields.push(e)}),t.phoneField=t.phoneFields.length>0?t.phoneFields[0]:t.moduleFields[0],t.templateSave=function(){var e={};e.module_id=t.$parent.$parent.$parent.module.id,e.name=t.smstemplate.template_name,e.subject="SMS",e.content=t.smstemplate.tinymce_content,e.sharing_type=t.smstemplate.sharing_type,e.template_type=2,e.active=!0,"custom"===t.smstemplate.sharing_type&&(e.shares=[],angular.forEach(t.smstemplate.shares,function(t){e.shares.push(t.id)}));var l;t.currentTemplate?(e.id=t.currentTemplate.id,l=f.update(e)):l=f.create(e),l.then(function(e){f.getAll("email").then(function(l){t.templates=l.data,t.template=e.data.id,n.create({content:a("translate")("Template.SuccessMessage"),className:"success"})})})},t.smstemplate={},t.smstemplate.system_type="custom",t.smstemplate.sharing_type="me",t.backTemplate=function(){t.tinymceModel=t.smstemplate.tinymce_content},t.templateDelete=function(){var e;e=t.template,f["delete"](e).then(function(){f.getAll("email").then(function(e){t.templates=e.data}),n.create({content:a("translate")("Template.SuccessDelete"),className:"success"})})},t.tinymceOptions=function(n){t[n]={init_instance_callback:function(e){t.iframeElement[n]=e.iframeElement},resize:!1,width:"136%",height:160,language:e.language,menubar:!1,statusbar:!1,toolbar:!1}},t.iframeElement={},t.tinymceOptions("tinymceTemplate"),t.tinymceOptions("tinymceTemplateEdit"),t.loadingModal=!1,t.tinymceModel="",t.totalSMS=0,t.addCustomField=function(e,n){t.tinymceModel+="{"+n.name+"}"},t.calculateSMS=function(){t.totalSMS=M(t.tinymceModel)},t.filterKey=function(e){var t=new RegExp("^[^\n\r]*$"),n=String.fromCharCode(e.which),a=angular.element(e.srcElement).val();t.test(n)&&t.test(a)||event.preventDefault()},t.submitSMS=function(){if(t.smsModalForm.$valid){var e=t.$parent.$parent.selectedRecords.map(function(e){return e.id});t.queryRequest={},t.$parent.$parent.isAllSelected&&(t.queryRequest.query=angular.toJson(t.$parent.$parent.findRequest)),t.submittingModal=!0,d.sendSMS(t.$parent.$parent.module.id,e,t.queryRequest.query||null,t.$parent.$parent.$parent.isAllSelected,null,t.phoneField.name,t.template).then(function(){t.submittingModal=!1,t.smsModal.hide(),t.phoneField.name,t.$parent.$parent.$parent.isAllSelected=!1,t.$parent.$parent.$parent.selectedRecords=[],t.$parent.$parent.$parent.selectedRows=[],n.create({content:a("translate")("SMS.MessageQueued"),className:"success"})})["catch"](function(){t.submittingModal=!1,t.smsModal.hide(),t.$parent.$parent.isAllSelected=!1,t.$parent.$parent.selectedRecords=[],t.$parent.$parent.selectedRows=[],n.create({content:a("translate")("Common.Error"),className:"danger"})})}}}]);