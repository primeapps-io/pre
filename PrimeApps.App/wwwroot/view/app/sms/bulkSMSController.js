"use strict";angular.module("primeapps").controller("BulkSMSController",["$rootScope","$scope","$filter","ModuleService","TemplateService","$mdDialog","mdToast",function(e,t,a,l,n,s,r){function i(e){var t=document.createElement("div");return t.innerHTML=e,t.innerText}function m(e){switch(!1){case null==e.match(d):return h;case null==e.match(f):return S;default:return y}}function o(e){var t,a;return a=function(){var a,l,n;for(n=[],a=0,l=e.length;l>a;a++)t=e[a],null!=t.match(g)&&n.push(t);return n}.call(this),a.length}function u(e){if(!e)return 0;e=e.replace(/(\r\n|\n|\r)/gm," ");var t,a,l,n;return t=m(e),a=e.length,t===S&&(a+=o(e)),n=M[t],a>n&&(n=T[t]),l=Math.ceil(a/n)}var p="@£$¥èéùìòÇ\\nØø\\rÅåΔ_ΦΓΛΩΠΨΣΘΞÆæßÉ !\\\"#¤%&'()*+,-./0123456789:;<=>?¡ABCDEFGHIJKLMNOPQRSTUVWXYZÄÖÑÜ§¿abcdefghijklmnopqrstuvwxyzäöñüà",c="\\^{}\\\\\\[~\\]|€",d=RegExp("^["+p+"]*$"),f=RegExp("^["+p+c+"]*$"),g=RegExp("^[\\"+c+"]*$"),h="GSM_7BIT",S="GSM_7BIT_EX",y="UTF16",M={GSM_7BIT:160,GSM_7BIT_EX:160,UTF16:70},T={GSM_7BIT:153,GSM_7BIT_EX:153,UTF16:67};t.formType="sms",t.loadingModal=!0,t.getTagTextRaw=function(e){return e.name.indexOf("seperator")<0?"{"+e.name+"}":void 0},t.moduleFields=n.getFields(t.$parent.module,t.$parent.view),t.searchTags=function(e){var a=[];return angular.forEach(t.moduleFields,function(t){"seperator"!==t.name&&t.label.indexOf(e)>=0&&a.push(t)}),t.tags=a,a},t.setTemplate=function(){t.smstemplate.template_subject=t.Subject,t.smstemplate.tinymce_content=t.tinymceModel,t.formType="template",t.currentTemplate?("profile"===t.currentTemplate.sharing_type?t.smstemplate.profile=t.getProfilisByIds(t.currentTemplate.profile_list):t.smstemplate.profiles=null,t.smstemplate.shares="custom"===t.currentTemplate.sharing_type?t.getUsersByIds(t.currentTemplate.shares):[],t.smstemplate.sharing_type=t.currentTemplate.sharing_type,t.smstemplate.language=t.currentTemplate.language):(t.smstemplate.sharing_type="me",t.smstemplate.language=e.globalization.Label,t.smstemplate.profile=null,t.smstemplate.shares=[])},t.profilesOptions={dataSource:e.profiles,filter:"contains",dataTextField:"languages."+e.globalization.Label+".name",dataValueField:"id",optionLabel:a("translate")("Common.Select")},t.getProfilisByIds=function(t){for(var l=[],n=0;n<t.length;n++){var s=a("filter")(e.profiles,{id:parseInt(t[n])},!0);s&&l.push(s[0])}return l},t.getUsersByIds=function(t){for(var l=[],n=0;n<t.length;n++){var s=a("filter")(e.users,{id:parseInt(t[n].user_id)},!0);s&&l.push(s[0])}return l},n.getAll("email","","SMS").then(function(e){t.templates=[];for(var a=0;a<e.data.length;a++)t.templates.push(e.data[a]);t.loadingModal=!1})["catch"](function(){t.loadingModal=!1}),t.setContent=function(e){if(t.currentTemplate=null,e){var l=a("filter")(t.templates,{id:e.id},!0)[0];l?(t.tinymceModel=i(l.content),t.calculateSMS(t.tinymceModel),t.smstemplate.template_name=l.name,t.currentTemplate=l):(t.tinymceModel=null,t.calculateSMS(t.tinymceModel),t.smstemplate.template_name=null)}},t.moduleFields=n.getFields(t.module),t.phoneFields=[],angular.forEach(t.moduleFields,function(e){"mobile"!==e.name||e.deleted||"users"===e.parent_type||t.phoneFields.push(e)}),t.phoneField=t.phoneFields.length>0?t.phoneFields[0]:t.moduleFields[0],t.templateSave=function(){function e(){return t.smstemplate.template_name&&t.smstemplate.language?t.smstemplate.tinymce_content?!0:(r.error(a("translate")("Template.ContentRequired")),!1):(r.error(a("translate")("Module.RequiredError")),!1)}if(t.saving=!0,t.clicked=!0,!e())return void(t.saving=!1);var l={};if(l.module_id=t.$parent.module.id,l.module=t.module.name,l.name=t.smstemplate.template_name,l.subject="SMS",l.content=t.smstemplate.tinymce_content,l.sharing_type=t.smstemplate.sharing_type,l.template_type=2,l.active=!0,"custom"===t.smstemplate.sharing_type&&(l.shares=[],angular.forEach(t.smstemplate.shares,function(e){l.shares.push(e.id)})),"profile"===t.smstemplate.sharing_type){for(var s=[],i=0;i<t.smstemplate.profile.length;i++)s.push(t.smstemplate.profile[i].id);l.profiles=s}else l.profiles=null;var m;t.currentTemplate?(l.id=t.currentTemplate.id,m=n.update(l)):m=n.create(l),m.then(function(e){t.$parent.template=e.data,n.getAll("email").then(function(e){t.saving=!1,t.clicked=!1,t.templates=[];for(var l=0;l<e.data.length;l++)"SMS"===e.data[l].subject&&t.templates.push(e.data[l]);t.setContent(t.$parent.template),t.template=t.$parent.template,r.success(a("translate")("Template.SuccessMessage"))})["catch"](function(){t.saving=!1,t.clicked=!1})})["catch"](function(){t.saving=!1,t.clicked=!1})},t.smstemplate={},t.smstemplate.system_type="custom",t.smstemplate.sharing_type="me",t.backTemplate=function(){t.currentTemplate&&(t.tinymceModel=t.smstemplate.tinymce_content),t.smstemplate.template_name&&(t.template=a("filter")(t.templates,{name:t.smstemplate.template_name},!0)[0])},t.templateDelete=function(){var e=t.template;n["delete"](e).then(function(){n.getAll("email").then(function(e){t.templates=[];for(var a=0;a<e.data.length;a++)"SMS"===e.data[a].subject&&t.templates.push(e.data[a])}),r.success(a("translate")("Template.SuccessDelete"))})},t.tinymceOptions=function(a){t[a]={init_instance_callback:function(e){t.iframeElement[a]=e.iframeElement},resize:!1,width:"136%",height:160,language:e.language,menubar:!1,statusbar:!1,toolbar:!1}},t.iframeElement={},t.tinymceOptions("tinymceTemplate"),t.tinymceOptions("tinymceTemplateEdit"),t.tinymceModel="",t.totalSMS=0,t.addCustomField=function(e,a){t.tinymceModel+="{"+a.name+"}"},t.calculateSMS=function(e){t.totalSMS=u(e)},t.filterKey=function(e){var t=new RegExp("^[^\n\r]*$"),a=String.fromCharCode(e.which),l=angular.element(e.srcElement).val();t.test(a)&&t.test(l)||event.preventDefault()},t.submitSMS=function(){if(t.submittingModal=!0,t.clicked=!0,!t.smsModalForm.validate())return r.error(a("translate")("Module.RequiredError")),void(t.submittingModal=!1);var e=t.$parent.selectedRecords.map(function(e){return e.id});t.queryRequest={},t.$parent.isAllSelected&&(t.queryRequest.query=angular.toJson(t.$parent.findRequest)),t.submittingModal=!0,l.sendSMS(t.$parent.module.id,e,t.queryRequest.query||null,t.$parent.isAllSelected,null,t.phoneField.name,t.template).then(function(){t.submittingModal=!1,t.clicked=!1,t.close(),t.phoneField.name,t.$parent.isAllSelected=!1,t.$parent.selectedRecords=[],t.$parent.selectedRows=[],t.refreshGrid(),r.success(a("translate")("SMS.MessageQueued"))})["catch"](function(){t.submittingModal=!1,t.clicked=!1,t.close(),t.$parent.isAllSelected=!1,t.$parent.selectedRecords=[],t.$parent.selectedRows=[],r.error(a("translate")("Common.Error"))})},t.close=function(){t.$parent.template={},s.hide()},t.selectedRecordOpstions={dataSource:t.selectedRecords,dataTextField:"displayName",dataValueField:"id"},t.templateOptions={dataSource:{transport:{read:function(e){e.success(t.templates)}}},dataBound:t.templates,change:function(){var e=this.value();t.setContent(e)},dataTextField:"name",dataValueField:"id"},t.phoneFieldOptions={dataSource:a("filter")(t.moduleFields,function(e){return("number"==e.data_type||"text_single"==e.data_type)&&!e.deleted&&"users"!=e.parent_type},!0),valueTemplate:'<span class="k-state-default">{{dataItem.label}}  {{dataItem.labelExt}}  </span>',template:'<span class="k-state-default">{{dataItem.label}}  {{dataItem.labelExt}}  </span>',dataTextField:"label",dataValueField:"name"},t.sharesOptions={dataSource:t.users,filter:"contains",dataTextField:"full_name",dataValueField:"id"}}]);