"use strict";function getCode(e,a){var t=new XMLHttpRequest;t.open("GET",e,!1),t.onload=function(){return 200==this.status?a(t.responseText):void 0},t.send({})}var runController=function(code,callback){return angular.isObject(code)?(eval(code),callback(!0)):void getCode(code.url,function(result){return eval(result),callback(result)})};angular.module("primeapps").controller("DashboardController",["$rootScope","$scope","guidEmpty","entityTypes","helper","config","$http","$localStorage","operations","$filter","$cache","activityTypes","DashboardService","ModuleService","$window","$state","$modal","dragularService","$timeout","$interval","$aside",function(e,a,t,r,o,n,i,l,d,s,h,c,u,m,p,f,b,_,g,D,v){a.operations=d,a.hasPermission=o.hasPermission,a.isFullScreen=!0,a.loading=!0,a.showNewDashboardSetting=s("filter")(e.moduleSettings,{key:"new_dashboard"},!0)[0],p.scrollTo(0,0);var w=e.user.profile.start_page.toLowerCase();if("dashboard"!=w)return void(window.location="#/app/"+w);a.icons=m.getIcons(),a.showFullScreen=function(e){a.fullScreenDashlet=a.fullScreenDashlet?null:e},a.openMenu=function(){},a.DashletTypes=[{label:s("translate")("Dashboard.Chart"),name:"chart"},{label:s("translate")("Dashboard.Widget"),name:"widget"}];var y=s("translate")("Dashboard.Column");a.dashletWidths=[{label:"1 "+y,value:3},{label:"2 "+y,value:6},{label:"3 "+y,value:9},{label:"4 "+y,value:12}],a.dashletHeights=[{label:"50 px",value:80},{label:"100 px",value:130},{label:"300 px",value:330},{label:"400 px",value:430},{label:"500 px",value:530},{label:"600 px",value:630}],a.getUser=function(a){var t=s("filter")(e.users,{id:a},!0)[0];return t.full_name?t.full_name:a},a.showComponent=[];var M=[];if(components)for(var S=JSON.parse(components),C=0;C<S.length;C++)M["component-"+S[C].Id]=S[C];a.loadDashboard=function(){var t=function(){u.getDashlets(a.activeDashboard.id).then(function(t){t=t.data;for(var r=0;r<t.length;r++){var o=t[r];if("component"===o.dashlet_type&&(h.get("component-"+o.id)?runController(h.get(a.showComponent[o.id]),function(){a.componetiGoster=!0}):runController(!1,function(e){a.showComponent[o.id]=!0,h.put(h.get("component-"+id),e)})),"chart"===o.dashlet_type){if(o.chart_item.config={dataEmptyMessage:s("translate")("Dashboard.ChartEmptyMessage")},o.chart_item.chart.showPercentValues="1",o.chart_item.chart.showPercentInTooltip="0",o.chart_item.chart.animateClockwise="1",o.chart_item.chart.enableMultiSlicing="0",o.chart_item.chart.isHollow="0",o.chart_item.chart.is2D="0",o.chart_item.chart.formatNumberScale="0",o.chart_item.chart.xaxisname=o.chart_item.chart["xaxisname_"+e.user.language],o.chart_item.chart.yaxisname=o.chart_item.chart["yaxisname_"+e.user.language],o.chart_item.chart.caption=o.chart_item.chart["caption_"+e.user.language],"tr"===a.locale&&(o.chart_item.chart.decimalSeparator=",",o.chart_item.chart.thousandSeparator="."),"chart"===o.dashlet_type&&"owner"===o.chart_item.chart.report_group_field&&o.chart_item.data&&o.chart_item.data.data)for(var n=0;n<o.chart_item.data.data.length;n++)o.chart_item.data.data[n].label=a.getUser(parseInt(o.chart_item.data.data[n].label));var i=s("filter")(e.modules,{id:o.chart_item.chart.report_module_id},!0)[0];if(i){var l;if(o.chart_item.chart.report_aggregation_field.indexOf(".")<0)l=s("filter")(i.fields,{name:o.chart_item.chart.report_aggregation_field},!0)[0];else{var d=o.chart_item.chart.report_aggregation_field.split("."),c=s("filter")(e.modules,{name:d[1]},!0)[0];l=s("filter")(c.fields,{name:d[2]},!0)[0]}l&&"currency"===l.data_type&&(o.chart_item.chart.numberPrefix=e.currencySymbol),!l||"currency"!==l.data_type&&"number_decimal"!==l.data_type||(o.chart_item.chart.forceDecimals="1")}}}a.dashlets=t,h.put("dashlets",t)})["finally"](function(){a.loading=!1})};void 0===a.showNewDashboardSetting||null===a.showNewDashboardSetting||"true"===a.showNewDashboardSetting.value?(a.showNewDashboard=!0,t()):a.getSummaryJsonValue=function(e){var a=angular.fromJson(e);return a.x};for(var r=0;r<e.modules.length;r++)m.getPicklists(e.modules[r]);a.$on("sample-data-removed",function(){t()}),a.widgetDetail=function(e){window.location=0!=e.view_id?"#/app/modules/"+e.widget_data.modulename+"?viewid="+e.view_id:"#/app/reports?id="+e.report_id},a.chartDetail=function(e){e&&(window.location="#/app/reports?id="+e)}};var k=h.get("dashlets"),$=h.get("activeDashboard"),x=h.get("dashboards"),O=h.get("dashboardprofile");k&&(a.loading=!1,a.dashlets=k),$&&x?(a.dashboards=x,a.activeDashboard=$,a.dashboardprofile=O,a.loadDashboard()):u.getDashboards().then(function(t){a.dashboards=t.data,a.activeDashboard=s("filter")(a.dashboards,{sharing_type:"me",user_id:e.user.id},!0)[0],a.activeDashboard||(a.activeDashboard=e.user.profile.has_admin_rights?s("filter")(a.dashboards,{sharing_type:"everybody"},!0)[0]:s("filter")(a.dashboards,{sharing_type:"profile",profile_id:e.user.profile.id},!0)[0],a.activeDashboard||(a.activeDashboard=s("filter")(a.dashboards,{sharing_type:"everybody"},!0)[0])),a.dashboardprofile=[],angular.forEach(e.profiles,function(e){var t=s("filter")(a.dashboards,{sharing_type:"profile",profile_id:e.id},!0)[0];t||a.dashboardprofile.push(e)}),h.put("activeDashboard",a.activeDashboard),h.put("dashboards",a.dashboards),h.put("dashboardprofile",a.dashboardprofile),a.loadDashboard()}),a.changeDashboard=function(){a.loading=!0,h.put("activeDashboard",a.activeDashboard),a.loadDashboard()},a.dashboardformModal=function(e){a.currentDashboard=e?angular.copy(e):{},a.formModal=a.formModal||b({scope:a,templateUrl:"view/app/dashboard/formModal.html",animation:"",backdrop:"static",show:!1}),a.formModal.$promise.then(function(){a.formModal.show()})},a.bindDragDrop=function(){g(function(){function e(e,a,r,o){o||(o=10),angular.element(e).on("dragularenter",function(){a.scrollTop+=r,t=D(function(){a.scrollTop+=r},o)}),angular.element(e).on("dragularleave dragularrelease",function(){D.cancel(t)})}a.drakePicklist&&(a.drakePicklist.destroy(),a.drakePicklist=null);var t,r=document.querySelector("#dashletOrderContainer"),o=document.querySelector("#dashletOptionContainer"),n=document.getElementById("rightTopBar"),i=document.getElementById("rightBottomBar");a.drakePicklist=_([r],{scope:a,containersModel:[a.dashlets],classes:{mirror:"gu-mirror-option",transit:"gu-transit-option"},lockY:!0,moves:function(e,a,t){return t.classList.contains("option-handle")}}),angular.element(r).on("dragulardrop",function(){}),e(n,o,-5),e(i,o,5)},100)},a.dashboardOrderChangeModal=function(){a.currentDashlet=angular.copy(a.dashlets),a.dashboardOrderModal=a.dashboardOrderModal||v({scope:a,templateUrl:"view/app/dashboard/dashboardOrderChange.html",animation:"am-slide-left",placement:"left",backdrop:!1,show:!1}),a.dashboardOrderModal.$promise.then(function(){a.dashboardOrderModal.show(),a.bindDragDrop()})},a.cancelChangeOrder=function(){a.dashlets=a.currentDashlet,a.dashboardOrderModal.hide()},a.saveDashboard=function(t){if(t.$submitted&&t.$valid){var r={};if(r["description_"+e.user.language]=a.currentDashboard["description_"+e.user.language],r["name_"+e.user.language]=a.currentDashboard["name_"+e.user.language],"en"===e.user.language?(r.name_tr=a.currentDashboard.id?a.currentDashboard.name_tr:a.currentDashboard.name_en,r.description_tr=a.currentDashboard.id?a.currentDashboard.description_tr:a.currentDashboard.description_en):(r.name_en=a.currentDashboard.id?a.currentDashboard.name_en:a.currentDashboard.name_tr,r.description_en=a.currentDashboard.id?a.currentDashboard.description_en:a.currentDashboard.description_tr),!a.currentDashboard.id){r.profile_id=a.currentDashboard.profile_id,r.sharing_type=3,a.loading=!0;{angular.copy(a.activeDashboard)}u.createDashbord(r).then(function(){a.formModal.hide(),h.remove("dashlets"),h.remove("activeDashboard"),h.remove("dashboards"),h.remove("dashboardprofile"),f.reload()})}}},a.saveDashlet=function(e){if(e.$submitted&&e.$valid){var t={dashlet_type:a.currentDashlet.dashlet_type,dashboard_id:a.activeDashboard.id,y_tile_length:a.currentDashlet.y_tile_length,x_tile_height:a.currentDashlet.x_tile_height};t.name_tr=a.currentDashlet.name_tr,t.name_en=a.currentDashlet.name_en,"chart"===a.currentDashlet.dashlet_type?t.chart_id=a.currentDashlet.board:(t.widget_id=a.currentDashlet.board,t.y_tile_length=3,t.x_tile_height=150,t.view_id=a.currentDashlet.view_id,t.color=a.currentDashlet.color,t.icon=a.currentDashlet.icon),a.formModalDashlet.hide(),a.loading=!0,a.currentDashlet.id?u.dashletUpdate(a.currentDashlet.id,t).then(function(){a.loadDashboard()}):(t.order=a.dashlets?a.dashlets.length:0,u.createDashlet(t).then(function(){a.loadDashboard()}))}},a.dashletOrderSave=function(){a.loading=!0,a.dashboardOrderModal.hide(),u.dashletOrderChange(a.dashlets).then(function(){a.loading=!1})},a.openNewDashlet=function(e){a.currentDashlet={},e&&(a.currentDashlet=angular.copy(e),e.chart_item?(a.currentDashlet.name=a.currentDashlet.chart_item.chart.caption,a.currentDashlet.board=a.currentDashlet.chart_item.chart.id):(a.currentDashlet.name=a.currentDashlet.name,a.currentDashlet.board=a.currentDashlet.widget.id,a.currentDashlet.widget.view_id?(a.currentDashlet.dataSource="view",u.getView(a.currentDashlet.widget.view_id).then(function(e){a.currentDashlet.module_id=e.data.module_id,a.setViews(),a.currentDashlet.view_id=a.currentDashlet.widget.view_id,a.currentDashlet.color=a.currentDashlet.widget.color,a.currentDashlet.icon=a.currentDashlet.widget.icon})):a.currentDashlet.dataSource="report"),a.changeDashletType()),a.formModalDashlet=a.formModalDashlet||b({scope:a,templateUrl:"view/app/dashboard/formModalDashlet.html",animation:"",backdrop:"static",show:!1}),a.formModalDashlet.$promise.then(function(){a.formModalDashlet.show()})},a.changeDashletType=function(){"chart"===a.currentDashlet.dashlet_type.name||"chart"===a.currentDashlet.dashlet_type?u.getCharts().then(function(e){a.boards=e.data,a.boardLabel=a.DashletTypes[0].label}):u.getWidgets().then(function(e){a.boards=e.data,a.boardLabel=s("translate")("Report.Single")})},a.selectModule=function(){a.setViews()},a.setViews=function(){u.getViews(a.currentDashlet.module_id).then(function(e){a.views=e.data})},a.dashletDelete=function(e){u.dashletDelete(e).then(function(){a.loadDashboard()})},a.changeDashletMode=function(){a.dashletMode=a.dashletMode===!0?!1:!0},a.changeView=function(){a.currentDashlet.name_en=s("filter")(a.views,{id:a.currentDashlet.view_id},!0)[0].label_en,a.currentDashlet.name_tr=s("filter")(a.views,{id:a.currentDashlet.view_id},!0)[0].label_tr},a.changeBoard=function(){a.currentDashlet.name_en=s("filter")(a.boards,{id:a.currentDashlet.board},!0)[0].name_en,a.currentDashlet.name_tr=s("filter")(a.boards,{id:a.currentDashlet.board},!0)[0].name_tr},"undefined"!=typeof Tawk_API&&(Tawk_API.visitor={name:e.user.full_name,email:e.user.email})}]);