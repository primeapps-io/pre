"use strict";angular.module("primeapps").controller("SingleEMailController",["$rootScope","$scope","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","config","$http","ModuleService","TemplateService","$cookies","$mdDialog","mdToast","components","$timeout",function(e,t,a,n,l,i,s,r,o,m,c,d,u,p,g,f,h,_,y,b){function v(e){var a=[];return p.getTemplates(t.type,"module").then(function(n){if(0!==n.data.length){t.quoteTemplates=n.data;for(var l=0;l<t.quoteTemplates.length;l++)a[l]={text:t.quoteTemplates[l].name,id:l,onclick:function(){e.setProgressState(!0),t.addTemplate("attachment",t.quoteTemplates[this.settings.id],e)}}}}),a}function E(e,a){e?t.isCc=a:t.isBcc=a}t.loadingModal=!0,t.module=a("filter")(e.modules,{name:s.type},!0)[0],t.loadingModal=!1,t.nonEmails={},t.isBcc=!0,t.isCc=!0;var T=function(){t.loadingModal=!0,g.getAll("email",t.module.name).then(function(e){t.templates=[];for(var a=0;a<e.data.length;a++)"SMS"!==e.data[a].subject&&t.templates.push(e.data[a]);t.loadingModal=!1})["catch"](function(){t.loadingModal=!1})};T(),t.profilesOptions={dataSource:e.profiles,filter:"contains",dataTextField:"languages."+e.globalization.Label+".name",dataValueField:"id",optionLabel:a("translate")("Common.Select")},t.iframeElement={},t.tinymceOptions=function(n){t[n]={setup:function(e){e.addButton("addParameter",{type:"button",text:a("translate")("EMail.AddParameter"),onclick:function(){tinymce.activeEditor.execCommand("mceInsertContent",!1,"#")}}),e.on("init",function(){t.loadingModal=!1})},onChange:function(){},inline:!1,height:200,language:e.language,plugins:["advlist autolink lists link image charmap print preview anchor table","searchreplace visualblocks code fullscreen","insertdatetime table contextmenu paste imagetools wordcount textcolor colorpicker"],toolbar:"addParameter | addQuoteTemplate | styleselect | bold italic underline | forecolor backcolor | alignleft aligncenter alignright alignjustify | link image imagetools | table bullist numlist  blockquote code fullscreen",menubar:"false",templates:[{title:"Test template 1",content:"Test 1"},{title:"Test template 2",content:"Test 2"}],skin:"lightgray",theme:"modern",file_picker_callback:function(e,t,a){if(k=e,"file"==a.filetype){var n=document.getElementById("uploadFile");n.click()}if("image"==a.filetype){var n=document.getElementById("uploadImage");n.click()}},image_advtab:!0,file_browser_callback_types:"image file",paste_data_images:!0,paste_as_text:!0,spellchecker_language:e.language,images_upload_handler:function(e,a,n){var l=e.blob();k=a,w=n,t.imgUpload.uploader.addFile(l)},init_instance_callback:function(e){t.iframeElement[n]=e.iframeElement},resize:!1,width:"99,9%",toolbar_items_size:"small",statusbar:!1,convert_urls:!1,remove_script_host:!1}},t.tinymceOptions("tinymceTemplate"),t.tinymceOptions("tinymceTemplateEdit"),t.formType="email",t.getProfilisByIds=function(t){for(var n=[],l=0;l<t.length;l++){var i=a("filter")(e.profiles,{id:parseInt(t[l])},!0);i&&n.push(i[0])}return n},t.getUsersByIds=function(t){for(var n=[],l=0;l<t.length;l++){var i=a("filter")(e.users,{id:parseInt(t[l].user_id)},!0);i&&n.push(i[0])}return n},t.templateSave=function(){function e(){return t.template_name&&t.template_subject&&t.templateLanguage?t.tinymce_content?!0:(_.error(a("translate")("Template.ContentRequired")),!1):(_.error(a("translate")("Module.RequiredError")),!1)}if(t.saving=!0,t.clicked=!0,!e())return void(t.saving=!1);var n={};if(n.module=t.module.name,n.name=t.template_name,n.subject=t.template_subject,n.content=t.tinymce_content,n.sharing_type=t.newtemplate.sharing_type,n.template_type=2,n.active=!0,n.language=t.templateLanguage,"custom"===t.newtemplate.system_type&&(n.shares=[],angular.forEach(t.newtemplate.shares,function(e){n.shares.push(e.id)})),"profile"===t.newtemplate.sharing_type){for(var l=[],i=0;i<t.newtemplate.profile.length;i++)l.push(t.newtemplate.profile[i].id);n.profiles=l}else n.profiles=null;var s;t.currentTemplate?(n.id=t.currentTemplate.id,s=g.update(n)):s=g.create(n),s.then(function(e){t.currentTemplate=e.data,g.getAll("email",t.module.name).then(function(n){t.saving=!1,t.clicked=!1,t.templates=[];for(var l=0;l<n.data.length;l++)"SMS"!==n.data[l].subject&&t.templates.push(n.data[l]);t.template=e.data,_.success(a("translate")("Template.SuccessMessage")),t.templateOptions.dataSource.read(),t.setContent(t.currentTemplate),t.formType="email"})["catch"](function(){t.saving=!1,t.clicked=!1})})["catch"](function(){t.saving=!1,t.clicked=!1})},t.templateDelete=function(){var e;e=t.template,g["delete"](e.id).then(function(){g.getAll("email",t.module.name).then(function(e){t.templates=[];for(var a=0;a<e.data.length;a++)"SMS"!==e.data[a].subject&&t.templates.push(e.data[a]);t.templateOptions.dataSource.read(),t.currentTemplate=null,t.template=null,t.tinymceModel=null,t.subject=null,t.template_subject=null,t.tinymce_content=null,t.templateLanguage=null,t.template_name=null,t.template_subject=null}),_.success(a("translate")("Template.SuccessDelete"))})},t.setContent=function(e){var n=a("filter")(t.templates,{id:e.id},!0)[0];n?(t.newtemplate.system_type="custom",t.newtemplate.sharing_type="me",t.tinymceModel=n.content,t.subject=n.subject,t.currentTemplate=n,t.template_name=n.name,t.editPermission="custom"===n.system_type):(t.tinymceModel=null,t.subject=null,t.currentTemplate=null,t.template_name=null,t.template_subject=null,t.tinymce_content=null,t.newtemplate.system_type=null,t.shares=[],t.templateLanguage=null)},t.setTemplate=function(){t.template_subject=t.subject,t.tinymce_content=t.tinymceModel,t.currentTemplate?("profile"===t.currentTemplate.sharing_type?t.newtemplate.profile=t.getProfilisByIds(t.currentTemplate.profile_list):t.newtemplate.profiles=null,t.newtemplate.shares="custom"===t.currentTemplate.sharing_type?t.getUsersByIds(t.currentTemplate.shares):[],t.newtemplate.sharing_type=t.currentTemplate.sharing_type,t.templateLanguage=t.currentTemplate.language):(t.newtemplate.sharing_type="me",t.templateLanguage=e.globalization.Label,t.newtemplate.profile=null,t.newtemplate.shares=[])},t.backTemplate=function(){t.subject=t.template_subject,t.tinymceModel=t.tinymce_content,t.template_name&&(t.template=a("filter")(t.templates,{name:t.template_name},!0)[0])},t.newtemplate={},t.newtemplate.system_type="custom",t.newtemplate.sharing_type="me";var k,w;e.system.messaging.PersonalEMail||e.system.messaging.SystemEMail||_.error(a("translate")("EMail.MessageQueued"));var M=angular.copy(e.system.messaging.SystemEMail||{}),S=angular.copy(e.system.messaging.PersonalEMail||{}),x=plupload.guid();t.moduleFields=g.getFields(t.module),t.emailFields=[],angular.forEach(t.moduleFields,function(e){"email"!==e.data_type||e.deleted||"users"===e.parent_type||t.emailFields.push(e)}),t.emailFields.length>0&&(t.emailField=t.emailFields[0]),t.senderAlias=null,t.senders=[],M.senders&&M.senders.length>0&&M.senders.forEach(function(e){e.type=a("translate")("EMail.System"),t.senders.push(e)}),S.senders&&S.senders.length>0&&S.senders.forEach(function(e){e.type=a("translate")("EMail.Personal"),t.senders.push(e)}),t.getTagTextRaw=function(e){return b(function(){t.$broadcast("$tinymce:refreshContent")},50),e.name.indexOf("seperator")<0?'<i style="color:#0f1015;font-style:normal">{'+e.name+"}</i>":void 0},t.searchTags=function(e){var a=[];return angular.forEach(t.moduleFields,function(t){"seperator"!==t.name&&t.label.indexOf(e)>=0&&a.push(t)}),t.tags=a,a},t.primaryField=a("filter")(t.module.fields,{primary:!0})[0],t.recordId=t.$parent.id,t.addressType=function(e){return a("translate")("EMail."+e)},t.imgUpload={settings:{multi_selection:!1,url:"storage/upload",multipart_params:{container:x,type:"mail",upload_id:0,response_list:""},filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png"}],max_file_size:"2mb"},resize:{quality:90}},events:{filesAdded:function(e){e.start(),tinymce.activeEditor.windowManager.open({title:a("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+a("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,t,a){e.settings.multipart_params.response_list="",e.settings.multipart_params.upload_id=0,tinymce.activeEditor.windowManager.close();var n=JSON.parse(a.response);k(n.public_url,{alt:t.name}),k=null},error:function(e,t){switch(t.code){case-600:tinymce.activeEditor.windowManager.alert(a("translate")("EMail.MaxImageSizeExceeded"))}w&&(w(),w=null)}}},t.fileUpload={settings:{multi_selection:!1,unique_names:!1,url:d.apiUrl+"Document/upload_attachment",headers:{Authorization:"Bearer "+m.read("access_token"),Accept:"application/json","X-Tenant-Id":f.get(preview?"preview_tenant_id":"tenant_id"),"X-App-Id":f.get(preview?"preview_app_id":"app_id")},multipart_params:{container:x},filters:{mime_types:[{title:"Email Attachments",extensions:"pdf,doc,docx,xls,xlsx,csv"}],max_file_size:"50mb"}},events:{filesAdded:function(e){e.start(),tinymce.activeEditor.windowManager.open({title:a("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+a("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,t,a){var n=JSON.parse(a.response);k(n.public_url,{alt:t.name}),k=null,tinymce.activeEditor.windowManager.close()},chunkUploaded:function(e,t,a){var n=JSON.parse(a.response);n.upload_id&&(e.settings.multipart_params.upload_id=n.upload_id),e.settings.multipart_params.response_list+=""==e.settings.multipart_params.response_list?n.e_tag:"|"+n.e_tag},error:function(e,t){switch(this.settings.multipart_params.response_list="",this.settings.multipart_params.upload_id=0,t.code){case-600:tinymce.activeEditor.windowManager.alert(a("translate")("EMail.MaxFileSizeExceeded"))}w&&(w(),w=null)}}},t.tinymceOptions={setup:function(n){n.addButton("addQuoteTemplate",{type:"menubutton",text:a("translate")("EMail.AddPdfTemplate",{module:e.getLanguageValue(t.module.languages,"label","singular")}),icon:!1,menu:v(n)}),n.addButton("addParameter",{type:"button",text:a("translate")("EMail.AddParameter"),onclick:function(){tinymce.activeEditor.execCommand("mceInsertContent",!1,"#")}}),n.on("init",function(){t.loadingModal=!1,t.editor=n})},onChange:function(){},inline:!1,height:200,language:e.language,plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime table contextmenu paste imagetools wordcount textcolor colorpicker"],toolbar:"addParameter | addQuoteTemplate | styleselect | bold italic underline | forecolor backcolor | alignleft aligncenter alignright alignjustify | link image imagetools | table bullist numlist  blockquote code fullscreen",menubar:"false",templates:[{title:"Test template 1",content:"Test 1"},{title:"Test template 2",content:"Test 2"}],skin:"lightgray",theme:"modern",file_picker_callback:function(e,t,a){if(k=e,"file"==a.filetype){var n=document.getElementById("uploadFile");n.click()}if("image"==a.filetype){var n=document.getElementById("uploadImage");n.click()}},image_advtab:!0,file_browser_callback_types:"image file",paste_data_images:!0,paste_as_text:!0,spellchecker_language:e.language,images_upload_handler:function(e,a,n){var l=e.blob();k=a,w=n,t.imgUpload.uploader.addFile(l)},init_instance_callback:function(e){t.iframeElement=e.iframeElement},resize:!1,width:"99,9%",toolbar_items_size:"small",statusbar:!1,convert_urls:!1,remove_script_host:!1},t.addCustomField=function(e,t){tinymce.activeEditor.execCommand("mceInsertContent",!1,"{"+t.name+"}")},t.addTemplate=function(n,l,i){if(l){t.templateAdding={},t.templateAdding[n]=!0;var s=a("filter")(t.module.fields,{primary:!0},!0)[0],r=t.$parent.record[s.name]+".pdf";if(l.link)"link"===n?tinymce.activeEditor.execCommand("mceInsertContent",!1,'<a href="'+l.link.fileurl+'">'+r+"</a>"):(t.attachmentLink=l.link.fileurl,t.attachmentName=r.substring(0,50),t.quoteTemplateName=" ( "+l.name+" ) "),t.templateAdding[n]=!1,i.setProgressState(!1),t.$apply();else{var o=d.apiUrl+"Document/export?module="+t.type+"&id="+t.$parent.record.id+"&templateId="+l.id+"&format=pdf&locale="+e.locale+"&timezoneOffset="+(new Date).getTimezoneOffset()+"&save="+!0;u.get(o).then(function(e){l.link=e.data,"link"===n?tinymce.activeEditor.execCommand("mceInsertContent",!1,'<a href="'+e.data.fileurl+'">'+r+"</a>"):(t.attachmentLink=e.data.fileurl,t.attachmentName=r.substring(0,50),t.quoteTemplateName=" ( "+l.name+" ) "),t.templateAdding[n]=!1,i.setProgressState(!1)})}}},t.submitEMail=function(){if(!t.emailModalForm.validate())return void _.error(a("translate")("Module.RequiredError"));if(!t.isCc||!t.isBcc)return void _.error(t.nonEmails.cc||t.nonEmails.bcc);t.selectedIds=[],t.selectedIds.push(t.$parent.record.id),t.queryRequest={},t.queryRequest.query="*:*";var e=t.senderAlias.type===a("translate")("EMail.System")?1:3;t.submittingModal=!0;var n=function(){p.sendEMail(t.module.id,t.selectedIds,t.queryRequest.query,!1,t.template,t.emailField.name,t.Cc,t.Bcc,t.senderAlias.alias,t.senderAlias.email,e,x,t.subject,t.attachmentLink,t.attachmentName).then(function(){y.run("AfterSingleEmail","Script",t),t.submittingModal=!1,t.close(),t.$parent.isAllSelected=!1,t.$parent.selectedRows=[],t.$parent.emailSent&&t.$parent.emailSent(),_.success(a("translate")("EMail.MessageQueued"))})["catch"](function(){t.submittingModal=!1,t.close(),t.isAllSelected=!1,t.selectedRows=[],_.error(a("translate")("Common.Error"))})};n()},t.close=function(){t.template={},h.hide()},t.senderOptions={dataSource:t.senders,valueTemplate:'<span class="k-state-default">{{dataItem.alias}} <{{dataItem.email}}> - {{dataItem.type}}  </span>',template:'<span class="k-state-default">{{dataItem.alias}} <{{dataItem.email}}> - {{dataItem.type}}  </span>',dataTextField:"alias",dataValueField:"email"},t.emailFieldOptions={dataSource:a("filter")(t.emailFields,{data_type:"email"},!0),valueTemplate:'<span class="k-state-default">{{dataItem.label}}  {{dataItem.labelExt}}  </span>',template:'<span class="k-state-default">{{dataItem.label}}  {{dataItem.labelExt}}  </span>',dataTextField:"label",dataValueField:"name"},t.templateOptions={dataSource:new kendo.data.DataSource({transport:{read:function(e){e.success(t.templates)}}}),dataBound:t.templates,change:t.setContent,dataTextField:"name",dataValueField:"id"},t.users=e.users,t.sharesOptions={dataSource:t.users,filter:"contains",dataTextField:"full_name",dataValueField:"id"},t.deleteTemplate=function(){kendo.confirm(a("translate")("Common.AreYouSure")).then(function(){t.templateDelete(),t.formType="email"},function(){})},t.checkEmails=function(e,n){if(e){const l=e.split(",");var i=a("filter")(l,function(e){return e.indexOf("@")<=0||e.contains("*")||e.indexOf("@")>=e.length},!0);if(i&&i.length>0){const s=a("translate")("Setup.Settings.ErrorEmail")+" "+i.toString();_.error(s),E(n,!1),t.nonEmails[n?"cc":"bcc"]=s}else E(n,!0),t.nonEmails[n?"cc":"bcc"]=""}else E(n,!0),t.nonEmails[n?"cc":"bcc"]=""}}]);