"use strict";angular.module("primeapps").controller("BulkEMailController",["$rootScope","$scope","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","config","ModuleService","TemplateService","$cookies","$mdDialog","mdToast","components",function(e,t,a,l,n,i,s,m,o,r,d,c,p,u,f,g,h,_){t.loadingModal=!0,t.module=a("filter")(e.modules,{name:s.type},!0)[0];var y,b;t.formType="email",e.system.messaging.PersonalEMail||e.system.messaging.SystemEMail||h.error(a("translate")("EMail.MessageQueued"));var w=angular.copy(e.system.messaging.SystemEMail||{}),v=angular.copy(e.system.messaging.PersonalEMail||{}),T=plupload.guid();t.emailField=a("filter")(t.$parent.allFields,{data_type:"email"})[0],t.senderAlias=null,t.senders=[],w.senders&&w.senders.length>0&&w.senders.forEach(function(e){e.type="System",t.senders.push(e)}),t.getTagTextRaw=function(e){return e.name.indexOf("seperator")>=0?void 0:'<i style="color:#0f1015;font-style:normal">{'+e.name+"}</i>"},t.moduleFields=u.getFields(t.module),t.emailFields=[],angular.forEach(t.moduleFields,function(e){"email"!==e.data_type||e.deleted||"users"===e.parent_type||t.emailFields.push(e)}),t.emailFields.length>0&&(t.emailField=t.emailFields[0]),t.searchTags=function(e){var a=[];return angular.forEach(t.moduleFields,function(t){"seperator"!==t.name&&t.label.indexOf(e)>=0&&a.push(t)}),t.tags=a,a},v.senders&&v.senders.length>0&&v.senders.forEach(function(e){e.type="Personal",t.senders.push(e)}),t.imgUpload={settings:{multi_selection:!1,url:"storage/upload",multipart_params:{container:T,type:"mail",upload_id:0,response_list:""},filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png"}],max_file_size:"2mb"},resize:{quality:90}},events:{filesAdded:function(e){e.start(),tinymce.activeEditor.windowManager.open({title:a("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+a("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,t,a){e.settings.multipart_params.response_list="",e.settings.multipart_params.upload_id=0,tinymce.activeEditor.windowManager.close();var l=JSON.parse(a.response);y(c.storage_host+l.public_url,{alt:t.name}),y=null},chunkUploaded:function(e,t,a){var l=JSON.parse(a.response);l.upload_id&&(e.settings.multipart_params.upload_id=l.upload_id),e.settings.multipart_params.response_list+=""==e.settings.multipart_params.response_list?l.e_tag:"|"+l.e_tag},error:function(e,t){switch(this.settings.multipart_params.response_list="",this.settings.multipart_params.upload_id=0,t.code){case-600:tinymce.activeEditor.windowManager.alert(a("translate")("EMail.MaxImageSizeExceeded"))}b&&(b(),b=null)}}},u.getAll("email",t.module.name).then(function(e){t.templates=[];for(var a=0;a<e.data.length;a++)t.templates.push(e.data[a]);t.loadingModal=!1})["catch"](function(){t.loadingModal=!1}),t.addressType=function(e){return a("translate")("EMail."+e)},t.fileUpload={settings:{multi_selection:!1,unique_names:!1,url:c.apiUrl+"Document/upload_attachment",headers:{Authorization:"Bearer "+r.read("access_token"),Accept:"application/json","X-Tenant-Id":f.get("tenant_id")},multipart_params:{container:T},filters:{mime_types:[{title:"Email Attachments",extensions:"pdf,doc,docx,xls,xlsx,csv"}],max_file_size:"50mb"}},events:{filesAdded:function(e){e.start(),tinymce.activeEditor.windowManager.open({title:a("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+a("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,t,a){var l=JSON.parse(a.response);y(c.storage_host+l.public_url,{alt:t.name}),y=null,tinymce.activeEditor.windowManager.close()},error:function(e,t){switch(t.code){case-600:tinymce.activeEditor.windowManager.alert(a("translate")("EMail.MaxFileSizeExceeded"))}b&&(b(),b=null)}}},t.iframeElement={},t.tinymceOptions=function(l){t[l]={setup:function(e){e.addButton("addParameter",{type:"button",text:a("translate")("EMail.AddParameter"),onclick:function(){tinymce.activeEditor.execCommand("mceInsertContent",!1,"#")}}),e.on("init",function(){t.loadingModal=!1})},onChange:function(){},inline:!1,height:200,language:e.language,plugins:["advlist autolink lists link image charmap print preview anchor table","searchreplace visualblocks code fullscreen","insertdatetime table contextmenu paste imagetools wordcount textcolor colorpicker"],toolbar:"addParameter | addQuoteTemplate | styleselect | bold italic underline | forecolor backcolor | alignleft aligncenter alignright alignjustify | link image imagetools | table bullist numlist  blockquote code fullscreen",menubar:"false",templates:[{title:"Test template 1",content:"Test 1"},{title:"Test template 2",content:"Test 2"}],skin:"lightgray",theme:"modern",file_picker_callback:function(e,t,a){if(y=e,"file"==a.filetype){var l=document.getElementById("uploadFile");l.click()}if("image"==a.filetype){var l=document.getElementById("uploadImage");l.click()}},image_advtab:!0,file_browser_callback_types:"image file",paste_data_images:!0,paste_as_text:!0,spellchecker_language:e.language,images_upload_handler:function(e,a,l){var n=e.blob();y=a,b=l,t.imgUpload.uploader.addFile(n)},init_instance_callback:function(e){t.iframeElement[l]=e.iframeElement},resize:!1,width:"99,9%",toolbar_items_size:"small",statusbar:!1,convert_urls:!1,remove_script_host:!1}},t.tinymceOptions("tinymceTemplate"),t.tinymceOptions("tinymceTemplateEdit"),t.newtemplate={},t.newtemplate.system_type="custom",t.newtemplate.sharing_type="me",t.addCustomField=function(e,t){tinymce.activeEditor.execCommand("mceInsertContent",!1,"{"+t.name+"}")},t.showAddTemplate=function(){t.quoteTemplate&&(t.addTemplatePopover=t.addTemplatePopover||$popover(angular.element(document.getElementById("addTemplate")),{templateUrl:"view/app/email/addTemplate.html",placement:"bottom-right",autoClose:!0,scope:t,show:!0}))},t.addTemplate=function(a){if(t.quoteTemplate){t.templateAdding={},t.templateAdding[a]=!0;var l=t.$parent.selectedRecords[0].displayName+".pdf";if(t.quoteTemplate.link)"link"===a?tinymce.activeEditor.execCommand("mceInsertContent",!1,'<a href="'+t.quoteTemplate.link.fileurl+'">'+l+"</a>"):(t.attachmentLink=t.quoteTemplate.link.fileurl,t.attachmentName=l),t.templateAdding[a]=!1,t.addTemplatePopover.hide();else{var n=c.apiUrl+"Document/export?module="+t.type+"&id="+t.$parent.selectedRecords[0].id+"&templateId="+t.quoteTemplate.id+"&access_token="+r.read("access_token")+"&format=pdf&locale="+e.locale+"&timezoneOffset="+(new Date).getTimezoneOffset()+"&save="+!0;$http.get(n).then(function(e){t.quoteTemplate.link=e.data,"link"===a?tinymce.activeEditor.execCommand("mceInsertContent",!1,'<a href="'+e.data.fileurl+'">'+l+"</a>"):(t.attachmentLink=e.data.fileurl,t.attachmentName=l),t.templateAdding[a]=!1,t.addTemplatePopover.hide()})}}},t.submitEMail=function(){if(t.emailModalForm.validate()){var e=t.$parent.selectedRecords.map(function(e){return e.id});t.queryRequest={},t.$parent.isAllSelected&&(t.queryRequest.query=angular.toJson(t.$parent.findRequest)),t.submittingModal=!0;var l="System"==t.senderAlias.type?1:3;_.run("BeforeBulkEmail","Script",t),p.sendEMail(t.module.id,e,t.queryRequest.query||null,t.$parent.isAllSelected,t.template,t.emailField.name,t.Cc,t.Bcc,t.senderAlias.alias,t.senderAlias.email,l,T,t.Subject).then(function(){_.run("AfterBulkEmail","Script",t),t.submittingModal=!1,t.close(),t.$parent.isAllSelected=!1,t.templateSubject=t.Subject,t.$parent.selectedRecords=[],t.$parent.selectedRows=[],t.$parent.emailSent&&t.$parent.emailSent(),h.success(a("translate")("EMail.MessageQueued"))})["catch"](function(){t.submittingModal=!1,t.close(),t.$parent.isAllSelected=!1,t.$parent.selectedRecords=[],t.$parent.selectedRows=[],h.error(a("translate")("Common.Error"))})}},t.setTemplate=function(){t.newtemplate.template_subject=t.Subject,t.newtemplate.tinymce_content=t.tinymceModel,t.currentTemplate?(t.newtemplate.sharing_type=t.currentTemplate.sharing_type,t.newtemplate.shares=t.currentTemplate.shares):t.newtemplate.sharing_type="me"},t.backTemplate=function(){t.Subject=t.newtemplate.template_subject,t.tinymceModel=t.newtemplate.tinymce_content,t.newtemplate.template_name&&(t.template=a("filter")(t.templates,{name:t.newtemplate.template_name},!0)[0])},t.templateDelete=function(){var e=t.template;u["delete"](e.id).then(function(){u.getAll("email",t.module.name).then(function(e){t.templates=[];for(var a=0;a<e.data.length;a++)"SMS"!=e.data[a].subject&&t.templates.push(e.data[a]);t.templateOptions.dataSource.read(),t.template=null,t.tinymceModel=null,t.Subject=null,t.newtemplate.template_subject=null,t.newtemplate.tinymce_content=null}),h.success(a("translate")("Template.SuccessDelete"))})},t.setContent=function(e){var l=a("filter")(t.templates,{id:e.id},!0)[0];l?(t.newtemplate.system_type="custom",t.newtemplate.sharing_type="me",t.tinymceModel=l.content,t.Subject=l.subject,t.currentTemplate=l,t.newtemplate.template_name=l.name):(t.tinymceModel=null,t.Subject=null,t.currentTemplate=null,t.newtemplate.template_name=null,t.newtemplate.template_subject=null,t.newtemplate.tinymce_content=null,t.newtemplate.sharing_type=null,t.newtemplate.shares=null)},t.templateSave=function(){var e={};if(e.module=t.module.name,e.name=t.newtemplate.template_name,e.subject=t.newtemplate.template_subject,e.content=t.newtemplate.tinymce_content,e.sharing_type=t.newtemplate.sharing_type,e.template_type=2,e.active=!0,"custom"===t.newtemplate.sharing_type){e.shares=[];for(var l=0;l<t.newtemplate.shares;l++){var n=t.newtemplate.shares[l];e.shares.push(n.id)}}var i;t.currentTemplate?(e.id=t.currentTemplate.id,i=u.update(e)):i=u.create(e),i.then(function(e){t.currentTemplate=e.data,u.getAll("email",t.module.name).then(function(l){t.templates=[];for(var n=0;n<l.data.length;n++)"SMS"!=l.data[n].subject&&t.templates.push(l.data[n]);t.template=e.data,h.success(a("translate")("Template.SuccessMessage")),t.templateOptions.dataSource.read(),t.setContent(t.currentTemplate)})})},t.close=function(){t.template={},g.hide()},t.senderOptions={dataSource:t.senders,valueTemplate:'<span class="k-state-default">{{dataItem.alias}} <{{dataItem.email}}> - {{dataItem.type}}  </span>',template:'<span class="k-state-default">{{dataItem.alias}} <{{dataItem.email}}> - {{dataItem.type}}  </span>',dataTextField:"alias",dataValueField:"email"},t.emailFieldOptions={dataSource:a("filter")(t.emailFields,{data_type:"email"},!0),valueTemplate:'<span class="k-state-default">{{dataItem.label}}  {{dataItem.labelExt}}  </span>',template:'<span class="k-state-default">{{dataItem.label}}  {{dataItem.labelExt}}  </span>',dataTextField:"label",dataValueField:"name"},t.templateOptions={dataSource:new kendo.data.DataSource({transport:{read:function(e){e.success(t.templates)}}}),dataBound:t.templates,change:t.setContent,dataTextField:"name",dataValueField:"id"},t.sharesOptions={dataSource:t.users,filter:"contains",dataTextField:"full_name",dataValueField:"id"},t.selectedRecordOpstions={dataSource:t.selectedRecords,dataTextField:"displayName",dataValueField:"id"},t.deleteTemplate=function(){kendo.confirm(a("translate")("Common.AreYouSure")).then(function(){t.templateDelete(),t.formType="email"},function(){})}}]);