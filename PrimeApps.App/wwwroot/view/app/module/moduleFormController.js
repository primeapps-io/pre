"use strict";angular.module("primeapps").controller("ModuleFormController",["$rootScope","$scope","ngToast","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","config","$timeout","operations","$modal","FileUploader","activityTypes","transactionTypes","ModuleService","DocumentService","$http","resizeService","components",function(e,r,t,a,o,i,n,l,d,u,s,c,m,p,f,g,y,_,h,v,k,F,b,w){if(r.$parent.$parent.formType){var M=r.$parent.$parent;r.formType=M.formType,r.type=M.type,r.id=M.id,r.subtype=M.stype,r.parentType=M.ptype,r.parentId=M.pid,r.returnTab=M.rtab,r.previousParentType=M.pptype,r.previousParentId=M.ppid,r.previousReturnTab=M.prtab,r.back=M.back,r.many=M.many,r.clone=M.clone,r.revise=M.revise,r.paramField=M.field,r.paramValue=M.value,r.actionButtonDisabled=!1}else r.type=l.type,r.subtype=l.stype,r.id=i.search().id,r.parentType=i.search().ptype,r.parentId=i.search().pid,r.returnTab=i.search().rtab,r.previousParentType=i.search().pptype,r.previousParentId=i.search().ppid,r.previousReturnTab=i.search().prtab,r.back=i.search().back,r.many=i.search().many,r.clone=i.search().clone,r.revise=i.search().revise,r.paramField=i.search().field,r.paramValue=i.search().value,r.isDisabled=!1;if(r.operations=f,r.hasPermission=o.hasPermission,r.hasDocumentsPermission=o.hasDocumentsPermission,r.hasAdminRights=o.hasAdminRights,r.hasFieldFullPermission=v.hasFieldFullPermission,r.hasSectionFullPermission=v.hasSectionFullPermission,r.hasActionButtonDisplayPermission=v.hasActionButtonDisplayPermission,r.lookupUserAndGroup=o.lookupUserAndGroup,r.lookupUser=o.lookupUser,r.loading=!0,r.image={},r.document={},r.hasProcessEditPermission=!1,r.userAdded=!1,r.parentId&&u.scrollTo(0,0),r.module=a("filter")(e.modules,{name:r.type},!0)[0],r.preview){var L=a("filter")(r.module.sections,{name:"system"},!0)[0];L.display_form=!0}if(w.run("BeforeFormLoaded","script",r),r.currentSectionComponentsTemplate=currentSectionComponentsTemplate,!r.id)for(var S=0;S<r.module.fields.length;S++){var C=r.module.fields[S];C.show_lock&&(C.show_lock=!1)}if(e.activeModuleName=r.parentType,!r.module)return t.create({content:a("translate")("Common.NotFound"),className:"warning"}),void n.go("app.dashboard");r.dropdownFields=a("filter")(r.module.fields,{data_type:"lookup",show_as_dropdown:!0},!0),r.dropdownFieldDatas={};for(var A=0;A<r.dropdownFields.length;A++)r.dropdownFieldDatas[r.dropdownFields[A].name]=[];if(!r.id&&!r.hasPermission(r.type,r.operations.write)&&!o.hasCustomProfilePermission("bulk_update"))return t.create({content:a("translate")("Common.Forbidden"),className:"warning"}),void n.go("app.dashboard");r.primaryField=a("filter")(r.module.fields,{primary:!0})[0],r.currentUser=v.processUser(e.user),r.currentDayMin=o.getCurrentDateMin().toISOString(),r.currentDayMax=o.getCurrentDateMax().toISOString(),r.currentHour=o.floorMinutes(new Date),r.relatedToField=a("filter")(r.module.fields,{name:"related_to"},!0)[0],r.record={},r.customLeaveFields={},r.id||(r.title=a("translate")("Module.New",{title:r.module["label_"+e.language+"_singular"]}));var N=function(){if("leaves"===r.module.name||"izinler"===r.module.name){var t=a("filter")(e.modules,{name:"holidays"},!0)[0];if(t){var i=a("filter")(t.fields,{name:"country"},!0)[0];o.getPicklists([i.picklist_id]).then(function(r){var t=r[i.picklist_id],o=a("filter")(t,{value:"tr"},!0)[0],n=a("filter")(t,{value:"en"},!0)[0],l=window.localStorage.NG_TRANSLATE_LANG_KEY||"tr",d={};d.limit=1e3,d.filters="tr"===e.language?[{field:"country",operator:"equals",value:o.labelStr,no:1}]:[{field:"country",operator:"is",value:n.labelStr}],v.findRecords("holidays",d).then(function(r){for(var t=r.data,o=[],i=0;i<t.length;i++)if(!t[i].half_day){var n=moment(t[i].date).format("DD-MM-YYYY");o.push(n)}var d=[1,2,3,4,5],u=a("filter")(e.moduleSettings,{key:"work_saturdays"},!0);u.length>0&&"t"===u[0].value&&d.push(6),e.holidaysData=t,moment.locale(l,{week:{dow:1},workingWeekdays:d,holidays:o,holidayFormat:"DD-MM-YYYY"})})})}}};N();for(var P=0;P<e.approvalProcesses.length;P++){var E=e.approvalProcesses[P];E.module_id===r.module.id&&(r.currentModuleProcess=E)}if(r.currentModuleProcess)for(var U=r.currentModuleProcess.profiles.split(","),A=0;A<U.length;A++)U[A]===e.user.profile.id.toString()&&(r.hasProcessEditPermission=!0);if(r.parentType)if("activities"===r.type||"mails"===r.type||r.many)r.parentModule=r.parentType;else{var T=a("filter")(r.module.fields,{name:r.parentType},!0)[0];T?r.parentModule=T.lookup_type:(r.parentType=null,r.parentId=null)}r.picklistFilter=function(){return function(e){return r.componentFilter={},r.componentFilter.item=e,r.componentFilter.result=!0,w.run("PicklistFilter","Script",r),!e.hidden&&!e.inactive&&r.componentFilter.result}};var D=function(e){var t=!1;if(1===e.process_status)return!0;if(r.module.dependencies.length>0){var o=a("filter")(r.module.dependencies,{dependency_type:"freeze"},!0);angular.forEach(o,function(o){var i=a("filter")(r.module.fields,{name:o.parent_field},!0);angular.forEach(i,function(r){angular.forEach(o.values_array,function(a){!e[r.name]||a!==e[r.name]&&a!==e[r.name].id||(t=!0)})})})}return t};v.getPicklists(r.module).then(function(o){r.picklistsModule=o;var i=a("filter")(r.module.fields,{name:"owner"},!0)[0],l=function(){angular.forEach(r.module.fields,function(e){v.setDependency(e,r.module,r.record,r.picklistsModule,r),"activities"!==r.module.name&&(!r.record.id&&e.default_value&&"picklist"===e.data_type||e.default_value&&"picklist"===e.data_type&&e.default_value===r.record[e.name].id)&&(r.record[e.name]=a("filter")(r.picklistsModule[e.picklist_id],{id:e.default_value})[0],r.fieldValueChange(e))})};if(w.run("BeforeFormPicklistLoaded","Script",r),r.module&&"izinler"===r.module.name){var d=a("filter")(r.module.fields,{name:"to_entry_type"},!0)[0],u=a("filter")(r.module.fields,{name:"from_entry_type"},!0)[0];r.customLeaveFields.to_entry_type=d,r.customLeaveFields.from_entry_type=u,r.record.to_entry_type||r.record.from_entry_type||!d||(r.record.to_entry_type=o[d.picklist_id][0],r.record.from_entry_type=o[d.picklist_id][0])}if(!r.id){if(r.loading=!1,r.record.owner=r.currentUser,!e.branchAvailable){var s=a("filter")(r.module.fields,{name:"kullanici_olustur"},!0)[0];s&&(s.hidden=!1)}if((e.isEmployee===r.module.name||"calisanlar"===r.module.name)&&v.getUserLicenseStatus().then(function(e){r.userLicenseControl=e.data,r.userLicenseKalan=r.userLicenseControl.total-r.userLicenseControl.used}),r.subtype&&"activities"===r.type&&(r.record.activity_type=a("filter")(_,{system_code:r.subtype},!0)[0],r.subtypeNameLang=a("translate")("Module.New",{title:r.record.activity_type.label[e.language]})),r.parentId){var c=a("filter")(e.modules,{name:r.parentModule},!0)[0];v.getRecord(r.parentModule,r.parentId).then(function(t){var i=a("filter")(c.fields,{primary:!0,deleted:!1},!0)[0],n={};if(n.id=t.data.id,n.primary_value=t.data[i.name],"calisanlar"===r.parentModule&&(n.e_posta=t.data.e_posta),e.isEmployee&&r.parentModule===e.isEmployee&&e.newEpostaFieldName&&(n[e.newEpostaFieldName]=t.data[e.newEpostaFieldName]),"activities"!==r.type&&"mails"!==r.type||!r.relatedToField){r.record[r.parentType]=n;var d=a("filter")(r.module.dependencies,{dependent_field:r.parentType},!0)[0];if(d&&d.deleted!==!0){var u=a("filter")(r.module.fields,{name:d.field},!0)[0];r.record[d.field]=a("filter")(r.picklistsModule[u.picklist_id],{id:d.values[0]},!0)[0];var s=a("filter")(r.module.fields,{name:d.dependent_field},!0)[0];s.hidden=!1}l()}else r.record.related_to=n,r.record.related_module=a("filter")(o[9e5],{value:r.parentType},!0)[0]})}else l();return v.setDefaultValues(r.module,r.record,o),v.setDisplayDependency(r.module,r.record),r.paramField&&(r.record[r.paramField]=r.paramValue,e.hideSipPhone()),void w.run("FieldChange","Script",r,r.record,i)}v.getRecord(r.module.name,r.id).then(function(o){if(0===Object.keys(o.data).length)return t.create({content:a("translate")("Common.Forbidden"),className:"warning"}),void n.go("app.dashboard");var d=v.processRecordSingle(o.data,r.module,r.picklistsModule);if(e.isEmployee===r.module.name||"calisanlar"===r.module.name){var u=a("filter")(r.module.fields,{name:"kullanici_olustur"},!0)[0];u&&(u.hidden=!0,d[u.name]=!1)}else(e.isEmployee===r.module.name||"calisanlar"===r.module.name)&&v.getUserLicenseStatus().then(function(e){r.userLicenseControl=e.data,r.userLicenseKalan=r.userLicenseControl.total-r.userLicenseControl.used});if(!r.hasPermission(r.type,r.operations.modify,o.data)||D(d)&&!r.hasAdminRights)return t.create({content:a("translate")("Common.Forbidden"),className:"warning"}),void n.go("app.dashboard");w.run("BeforeFormRecordLoaded","Script",r,d),v.formatRecordFieldValues(angular.copy(o.data),r.module,r.picklistsModule),r.title=r.primaryField.valueFormatted,r.recordState=angular.copy(d),v.setDisplayDependency(r.module,d);for(var s=0;s<r.module.fields.length;s++){var c=r.module.fields[s],m=!1;if(c.encrypted&&c.encryption_authorized_users_list.length>0&&d[c.name])for(var p=0;p<c.encryption_authorized_users_list.length;p++){var f=c.encryption_authorized_users_list[p];e.user.id===parseInt(f)&&(m=!0)}c.show_lock=c.encrypted&&!m?!0:!1}if(r.relatedToField&&d.related_to){var g=a("filter")(e.modules,{id:d[r.relatedToField.lookup_relation].id-9e5},!0)[0],y=a("filter")(g.fields,{primary:!0},!0)[0];v.getRecord(g.name,d.related_to,!0).then(function(e){e=e.data,e.primary_value=e[y.name],d.related_to=e,r.record=d,r.recordState=angular.copy(r.record),"activities"!==r.module.name&&l(),r.module&&r.module.fields&&r.module.fields.length>0&&r.fieldValueChange(r.module.fields[0]),r.loading=!1})["catch"](function(e){404===e.status&&(d.related_to=null,r.record=d,r.recordState=angular.copy(r.record)),r.loading=!1})}else r.record=d,r.clone&&(r.record.owner=r.currentUser),"activities"!==r.module.name&&l(),r.loading=!1;r.record.currency&&(r.currencySymbol=r.record.currency.value||e.currencySymbol),v.customActions(r.module,r.record),w.run("FieldChange","Script",r,r.record,i),w.run("AfterFormRecordLoaded","Script",r)})["catch"](function(){r.loading=!1}),w.run("AfterFormPicklistLoaded","Script",r)}),r.lookup=function(t){if(r.searchTerm=t,"users"===r.currentLookupField.lookup_type&&!r.currentLookupField.lookupModulePrimaryField){var o={};o.data_type="text_single",o.name="full_name",r.currentLookupField.lookupModulePrimaryField=o}if("profiles"===r.currentLookupField.lookup_type&&!r.currentLookupField.lookupModulePrimaryField){var o={};o.data_type="text_single",o.name="name",r.currentLookupField.lookupModulePrimaryField=o}if("roles"===r.currentLookupField.lookup_type&&!r.currentLookupField.lookupModulePrimaryField){var o={};o.data_type="text_single",o.name="label_"+e.user.tenantLanguage,r.currentLookupField.lookupModulePrimaryField=o}if("relation"===r.currentLookupField.lookup_type){if(!r.record.related_module)return r.$broadcast("angucomplete-alt:clearInput",r.currentLookupField.name),d.defer().promise;var i=a("filter")(e.modules,{name:r.record.related_module.value},!0)[0];if(!i)return r.$broadcast("angucomplete-alt:clearInput",r.currentLookupField.name),d.defer().promise;r.currentLookupField.lookupModulePrimaryField=a("filter")(i.fields,{primary:!0},!0)[0]}return"number"!==r.currentLookupField.lookupModulePrimaryField.data_type&&"number_auto"!==r.currentLookupField.lookupModulePrimaryField.data_type||!isNaN(parseFloat(t))?(r.customFilters=null,w.run("BeforeLookup","Script",r),r.lookupCurrentData?r.lookupCurrentData:"users"===r.currentLookupField.lookup_type?v.lookup(t,r.currentLookupField,r.record,["email"],!1,r.customFilters):"profiles"===r.currentLookupField.lookup_type?v.lookup(t,r.currentLookupField,r.record,null,!1,r.customFilters):"roles"===r.currentLookupField.lookup_type?v.lookup(t,r.currentLookupField,r.record,null,!1,r.customFilters):"calisanlar"===r.currentLookupField.lookup_type?v.lookup(t,r.currentLookupField,r.record,["e_posta"],!1,r.customFilters):e.isEmployee&&r.currentLookupField.lookup_type===e.isEmployee&&e.newEpostaFieldName?v.lookup(t,r.currentLookupField,r.record,[e.newEpostaFieldName],!1,r.customFilters):v.lookup(t,r.currentLookupField,r.record,null,!1,r.customFilters)):(r.$broadcast("angucomplete-alt:clearInput",r.currentLookupField.name),d.defer().promise)},r.multiselect=function(t,a){var o=[];return angular.forEach(r.picklistsModule[a.picklist_id],function(r){r.inactive||r.hidden||(r.labelLang=r.label[e.user.language],(r.labelLang.toLowerCase().indexOf(t.toLowerCase())>-1||r.labelLang.toUpperCase().indexOf(t.toUpperCase())>-1||r.labelLang.toLowerCaseTurkish().indexOf(t.toLowerCaseTurkish())>-1||r.labelLang.toUpperCaseTurkish().indexOf(t.toUpperCaseTurkish())>-1)&&o.push(r))}),o},r.tags=function(e,r){return F.get(m.apiUrl+"tag/get_tag/"+r.id).then(function(r){var t=r.data;return t.filter(function(r){return-1!==r.text.toLowerCase().indexOf(e.toLowerCase())})})},r.setCurrentLookupField=function(e){r.currentLookupField=e},r.uploader=new y({url:"storage/record_file_upload",headers:{appId:e.user.app_id,"X-App-Id":e.user.app_id}}),r.entityIdFunc=function(){return r.recordId},r.addUser=function(o){if(r.openCreateUserModal=function(){r.userCreateModal=r.userCreateModal||g({scope:r,templateUrl:"view/app/module/createUserModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal",keyboard:!1}),r.userCreateModal.$promise.then(r.userCreateModal.show)},0===r.userLicenseKalan||r.userLicenseKalan<0){if(!e.branchAvailable){var i=a("filter")(r.module.fields,{name:"kullanici_profili"},!0)[0],n=a("filter")(r.module.fields,{name:"kullanici_rolu"},!0)[0];r.record.kullanici_olustur=!1,r.record.kullanici_profili=null,r.record.kullanici_rolu=null,i&&(i.hidden=!0),n&&(n.hidden=!0)}return t.create({content:a("translate")("Setup.Users.LicenceRequired"),className:"warning"}),void(r.submitting=!1)}v.getUserEmailControl(e.isEmployee&&e.newEpostaFieldName?r.record[e.newEpostaFieldName]:r.record.e_posta).then(function(i){var n="Available"===i.data;if(!n){if(t.create({content:a("translate")("Setup.Users.NewUserError"),className:"warning"}),!e.branchAvailable){var l=a("filter")(r.module.fields,{name:"kullanici_profili"},!0)[0],u=a("filter")(r.module.fields,{name:"kullanici_rolu"},!0)[0];r.record.kullanici_olustur=!1,r.record.kullanici_profili=null,r.record.kullanici_rolu=null,l&&(l.hidden=!0),u&&(u.hidden=!0)}return void(r.submitting=!1)}var c=r.record.kullanici_profili?r.record.kullanici_profili.id:null,m=r.record.kullanici_rolu?r.record.kullanici_rolu.id:null,p=function(o,i,n){var l={};l.email=e.isEmployee&&e.newEpostaFieldName?r.record[e.newEpostaFieldName]:r.record.e_posta,l.first_name=e.newAdFieldName?r.record[e.newAdFieldName]:r.record.ad,l.last_name=e.newSoyadFieldName?r.record[e.newSoyadFieldName]:r.record.soyad,l.profile=i,l.role=o,l.full_name=l.first_name+" "+l.last_name,l&&l.email&&l.profile&&l.role&&l.first_name&&l.last_name&&(r.userInviting=!0,l.profile_id=l.profile,l.role_id=l.role,l.dont_send_mail=!0,r.addedUser=angular.copy(l),v.addUser(l).then(function(t){if(t.data){r.userCreatePassword=t.data.password,r.userCreateEmail=e.isEmployee&&e.newEpostaFieldName?r.record[e.newEpostaFieldName]:r.record.e_posta,r.userLicenseAvailable=r.userLicenseKalan-1,r.userLicensesBought=r.userLicenseControl.total,r.userAdded=!0;var o=[];o.push(v.myAccount()),o.push(v.getAllUser()),d.all(o).then(function(r){var t=r[0].data,o=r[1].data;e.user=t.user,e.workgroups=t.instances;var i=s.read("Workgroup");if(e.workgroup=t.instances[0],i){var n=a("filter")(t.instances,{instanceID:i},!0)[0];n&&(e.workgroup=n)}var l=t.user.isDemo||!1;e.users=l?a("filter")(o,function(e){return e.id===t.user.id},!0):o}),r.submit(n),r.openCreateUserModal()}})["catch"](function(e){r.submitting=!1,409===e.status&&t.create({content:a("translate")("Setup.Users.NewUserError"),className:"warning"})}))};e.branchAvailable?v.getRecord("branches",r.record.branch.id).then(function(e){m=e.data.branch,c=r.record.profile.id,p(m,c,o)})["catch"](function(){r.submitting=!1}):p(m,c,o)})},r.submit=function(o){function i(){var e=!0;return angular.forEach(r.module.fields,function(t){o[t.name]&&("lookup"===t.data_type&&"object"!=typeof o[t.name]&&(r.moduleForm[t.name].$setValidity("object",!1),e=!1),"image"===t.data_type&&r.image[t.name]&&r.image[t.name].UniqueName&&null!=o[t.name]&&(o[t.name]=r.image[t.name].UniqueName),"document"===t.data_type&&r.document[t.name]&&r.document[t.name].UniqueName&&null!=o[t.name]&&(o[t.name]=r.document[t.name].UniqueName))}),e}function l(o){r.addedUser=!1,r.recordId=o.id,w.run("BeforeFormSubmitResult","Script",r,o),r.success=function(){var i={type:r.type,id:o.id};r.saveAndNew?(r.record={},r.moduleForm.$setPristine(),u.scrollTo(0,0),t.create({content:a("translate")("Module.SuccessMessage",{title:r.module["label_"+e.language+"_singular"]}),className:"success"}),r.uploader.clearQueue(),r.$broadcast("angucomplete-alt:clearInput"),"activities"===r.module.name&&(r.record.activity_type=r.activity_type_id,r.record.related_module=p.related_module,r.record.related_to=p.related_to),a("filter")(r.module.fields,{name:"owner"},!0)[0]&&(r.record.owner=r.currentUser,r.$broadcast("angucomplete-alt:changeInput","owner",r.currentUser)),angular.forEach(r.module.fields,function(e){"lookup"===e.data_type&&(a("filter")(r.module.dependencies,{child_field:e.name},!0)[0]||(r.record[e.name]=p[e.name],r.$broadcast("angucomplete-alt:changeInput",e.name,p[e.name])))}),v.setDefaultValues(r.module,r.record,r.picklistsModule)):(r.parentId&&(i.type=r.parentModule,i.id=r.parentId,i.rptype=r.returnTab,r.previousParentType&&(i.rpptype=r.previousParentType,i.rppid=r.previousParentId,i.rprtab=r.previousReturnTab)),r.back&&(i.back=r.back));var l=r.module.name+"_"+r.module.name;if(r.parentId){l=(r.relatedToField?"related_to":r.parentType)+r.parentId+"_"+(r.many?r.many:r.module.name);var d=r.parentType+"_"+r.parentType;c.remove(l),c.remove(d)}else c.remove(l);e.activePages&&e.activePages[r.module.name]&&(e.activePages[r.module.name]=null),(r.module.display_calendar||"activities"===r.module.name)&&c.remove("calendar_events"),r.saveAndNew?"activities"===r.type&&(r.submitting=!1,r.record.activity_type=a("filter")(_,{system_code:r.subtype},!0)[0],r.subtypeNameLang=a("translate")("Module.New",{title:r.record.activity_type.label[e.language]})):e.isEmployee===r.module.name||"calisanlar"===r.module.name?(r.goModuleDetail=function(){n.go("app.moduleDetail",i),r.userCreateModal.hide()},r.id||!r.record.kullanici_olustur&&!e.branchAvailable?n.go("app.moduleDetail",i):r.loading=!0):n.go("app.moduleDetail",i),r.izinTuruData=null},r.success()}function d(e,t){r.addedUser=!1,409===t&&(r.moduleForm[e.field].$setValidity("unique",!1),e.field2&&r.moduleForm[e.field2].$setValidity("unique",!1))}if(r.submitting=!0,!r.moduleForm.$valid||!i())return void(r.submitting=!1);if(w.run("BeforeFormSubmit","Script",r,o),!r.id||r.clone){if(r.executeCode=!1,w.run("BeforeCreate","Script",r,o),r.executeCode)return void(r.submitting=!1)}else if(r.executeCode=!1,w.run("BeforeUpdate","Script",r,o),r.executeCode)return void(r.submitting=!1);if(!(r.id||"calisanlar"!==r.module.name&&r.module.name!==e.isEmployee||!r.record.kullanici_olustur&&!e.branchAvailable||r.userAdded))return void r.addUser(o);if(e.branchAvailable&&r.branchManager&&(angular.forEach(r.record.Authorities,function(e){var t=a("filter")(r.authorities,{user_id:e.id},!0)[0];t||F.post(m.apiUrl+"user_custom_shares/create/",{shared_user_id:r.branchManager.id,user_id:e.id})}),angular.forEach(r.authorities,function(e){var t=a("filter")(r.record.Authorities,{id:e.user_id},!0)[0];t||F["delete"](m.apiUrl+"user_custom_shares/delete/"+e.id)})),delete o.Authorities,"izinler"===r.module.name){var s="";if(r.skipValidation?(delete o.goreve_baslama_tarihi,delete o.calisan_data,delete o.dogum_tarihi,delete o.izin_turu_data,delete o.alinan_izinler):s=v.customValidations(r.module,o),""!=s)return t.create({content:s,className:"warning",timeout:8e3}),void(r.submitting=!1)}r.clone&&(delete r.record.created_at,delete r.record.created_by,delete r.record.updated_at,delete r.record.updated_by,angular.forEach(r.module.fields,function(e){"number_auto"===e.data_type&&delete o[e.name]}),r.recordState=null),o=v.prepareRecord(o,r.module,r.recordState);var p=angular.copy(r.record);if(r.activity_type_id=a("filter")(_,{id:o.activity_type},!0)[0],(o.activity_type_system||null===o.activity_type_system)&&delete o.activity_type_system,r.id){for(var f=0;f<r.module.fields.length;f++){var g=r.module.fields[f],y=!1;if(g.encrypted&&g.encryption_authorized_users_list.length>0&&o[g.name])for(var h=0;h<g.encryption_authorized_users_list.length;h++){var k=g.encryption_authorized_users_list[h];e.user.id===parseInt(k)&&(y=!0)}g.encrypted&&!y&&delete o[g.name]}r.clone?(r.revise&&(o.master_id=o.id),delete o.id,delete o.process_id,delete o.process_status,delete o.process_status_order,delete o.process_request_updated_at,delete o.process_request_updated_by,delete o.operation_type,o.auto_id&&(o.auto_id=""),v.insertRecord(r.module.name,o).then(function(e){o.master_id?"quotes"===r.module.name&&v.getRecord(r.module.name,o.master_id).then(function(t){var a=v.processRecordSingle(t.data,r.module,r.picklistsModule),o=angular.copy(a);a=v.prepareRecord(a,r.module,o),v.updateRecord(r.module.name,a).then(function(){r.submitting=!1,l(e.data)})}):(r.submitting=!1,l(e.data)),o.id=e.data.id,w.run("AfterCreate","Script",r,o)})["catch"](function(){d(data,status),r.submitting=!1})):v.updateRecord(r.module.name,o).then(function(t){var i=a("filter")(e.approvalProcesses,{module_id:r.module.id},!0);if(i){for(var n=!1,d=0;d<i.length;d++)(0===i[d].user_id||i[d].user_id===r.currentUser.id)&&i[d].operations.indexOf("update")>-1&&(n=!0);n?setTimeout(function(){l(t.data)},2e3):l(t.data)}else l(t.data);w.run("AfterUpdate","Script",r,o)})["catch"](function(e){d(e.data,e.status)})["finally"](function(){var t=a("filter")(e.approvalProcesses,{module_id:r.module.id},!0);if(t){for(var o=!1,i=0;i<t.length;i++)(0===t[i].user_id||t[i].user_id===r.currentUser.id)&&t[i].operations.indexOf("update")>-1&&(o=!0);o?setTimeout(function(){r.submitting=!1},2e3):r.submitting=!1}else r.submitting=!1})}else v.insertRecord(r.module.name,o).then(function(t){var i=a("filter")(e.approvalProcesses,{module_id:r.module.id},!0);if(i){for(var n=!1,d=0;d<i.length;d++)(0===i[d].user_id||i[d].user_id===r.currentUser.id)&&i[d].operations.indexOf("insert")>-1&&(n=!0);n?setTimeout(function(){l(t.data)},2e3):l(t.data)}else l(t.data);o.id=t.data.id,w.run("AfterCreate","Script",r,o)})["catch"](function(e){d(e.data,e.status)})["finally"](function(){var t=a("filter")(e.approvalProcesses,{module_id:r.module.id},!0);if(t){for(var o=!1,i=0;i<t.length;i++)(0===t[i].user_id||t[i].user_id===r.currentUser.id)&&t[i].operations.indexOf("insert")>-1&&(o=!0);o?setTimeout(function(){r.submitting=!1},2e3):r.submitting=!1}else r.submitting=!1})},r.calculate=function(e){v.calculate(e,r.module,r.record)},r.fieldValueChange=function(t){return"activities"===r.module.name&&"related_module"===t.name&&(r.dropdownFieldDatas.related_to=[]),t.valueChangeDontRun?void delete t.valueChangeDontRun:(v.setDependency(t,r.module,r.record,r.picklistsModule,r),v.setDisplayDependency(r.module,r.record),v.setCustomCalculations(r.module,r.record,r.picklistsModule,r),v.customActions(r.module,r.record,r.moduleForm,r.picklistsModule,r),w.run("FieldChange","Script",r,r.record,t),r.moduleForm[t.name]&&r.moduleForm[t.name].$error&&r.moduleForm[t.name].$error.unique&&r.moduleForm[t.name].$setValidity("unique",!0),void(r.record.currency&&(r.currencySymbol=r.record.currency.value||e.currencySymbol)))},r.hideCreateNew=function(e){return"users"===e.lookup_type?!0:"relation"!==e.lookup_type||r.record.related_module?!1:!0},r.openFormModal=function(e){r.primaryValueModal=e,r.formModal=r.formModal||g({scope:r,templateUrl:"view/app/module/moduleFormModal.html",animation:"",backdrop:"static",show:!1}),r.formModal.$promise.then(r.formModal.show)},v.getActionButtons(r.module.id).then(function(e){r.actionButtons=a("filter")(e,function(e){return"Detail"!==e.trigger&&"List"!==e.trigger&&"Relation"!==e.trigger},!0)}),r.showModuleFrameModal=function(e){if(new RegExp("https:").test(e)){var t,a,o;t="myPop1",a=document.body.offsetWidth-200,o=document.body.offsetHeight-200;var i=screen.width/2-a/2,n=screen.height/2-o/2;window.open(e,t,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+a+", height="+o+", top="+n+", left="+i)}else r.frameUrl=e,r.frameModal=r.frameModal||g({scope:r,controller:"ActionButtonFrameController",templateUrl:"view/app/actionbutton/actionButtonFrameModal.html",backdrop:"static",show:!1}),r.frameModal.$promise.then(r.frameModal.show)},r.openLocationModal=function(e){r.filedName=e,r.locationModal=r.frameModal||g({scope:r,controller:"locationFormModalController",templateUrl:"view/app/location/locationFormModal.html",backdrop:"static",show:!1}),r.locationModal.$promise.then(r.locationModal.show)},r.removeDocument=function(t){var a={};a.module=r.module.name,a.recordId=r.record.id,a.fieldName=t.name,a.fileNameExt=o.getFileExtension(r.record[t.name]),a.instanceId=e.workgroup.tenant_id,r.record[t.name]=null,"document"===t.data_type&&(r.uploaderBasic[t.name].queue=[]),"image"===t.data_type&&(r.uploaderImage[t.name].queue=[]),angular.forEach(r.moduleForm[t.name].$error,function(e,a){r.moduleForm[t.name].$setValidity(a,e)})},r.checkUploadFile=function(e){var r=e.target.files,t=e.target.id,a=angular.element(document.getElementById("lbl_"+t))[0];isAcceptedExtension(r[0])&&(a.innerText=r[0].name)},r.fileLoadingCounter=0,r.uploaderBasic=function(i){r.document[i.name]={};var n=r.uploaderBasic[i.name]=new y({url:"storage/record_file_upload",headers:{appId:e.user.app_id,"X-App-Id":e.user.app_id},queueLimit:1});return n.onAfterAddingFile=function(e){r.fileLoadingCounter++;var t=e.uploader.queue[0].file.name;r.record[i.name]=t,r.document[i.name].Name=e.uploader.queue[0].file.name,r.document[i.name].Size=e.uploader.queue[0].file.size,r.document[i.name].Type=e.uploader.queue[0].file.type,e.upload()},n.onWhenAddingFileFailed=function(e,r){switch(r.name){case"docFilter":t.create({content:a("translate")("Setup.Settings.DocumentTypeError"),className:"warning"});break;case"sizeFilter":t.create({content:a("translate")("Setup.Settings.SizeError"),className:"warning"})}},n.filters.push({name:"docFilter",fn:function(e){var r=o.getFileExtension(e.name);return"txt"===r||"docx"===r||"pdf"===r||"doc"===r||"xlsx"===r||"xls"===r}}),n.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}}),n.onSuccessItem=function(e,t){r.document[i.name].UniqueName=t.unique_name,r.fileLoadingCounter--},n},r.uploaderImage=function(i){function n(e){var r=d.defer(),t=new FileReader;return t.onload=function(e){r.resolve(e.target.result)},t.readAsDataURL(e),r.promise}r.image[i.name]={};var l={Authorization:"Bearer "+s.read("access_token"),Accept:"application/json"};e.preview?l["X-App-Id"]=e.user.app_id:l["X-Tenant-Id"]=e.user.tenant_id;var u=r.uploaderImage[i.name]=new y({url:"storage/record_file_upload",headers:l,queueLimit:1});u.onAfterAddingFile=function(e){n(e._file).then(function(t){e.image=t;new Image;b.resizeImage(e.image,{width:1024},function(t,a){if(!t){e._file=c(a),e.file.size=e._file.size,r.fileLoadingCounter++;var o=e.uploader.queue[0].file.name;r.record[i.name]=o,r.image[i.name].Name=e.uploader.queue[0].file.name,r.image[i.name].Size=e.uploader.queue[0].file.size,r.image[i.name].Type=e.uploader.queue[0].file.type,e.upload()}})})},u.onWhenAddingFileFailed=function(e,r){switch(r.name){case"imgFilter":t.create({content:a("translate")("Setup.Settings.ImageError"),className:"warning"});break;case"sizeFilter":t.create({content:a("translate")("Setup.Settings.SizeError"),className:"warning"})}},u.filters.push({name:"imgFilter",fn:function(e){var r=o.getFileExtension(e.name);return"jpg"===r||"jpeg"===r||"png"===r||"doc"===r||"gif"===r}}),u.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}}),u.onSuccessItem=function(e,t){r.image[i.name].UniqueName=t.public_url,r.fileLoadingCounter--};var c=function(e){for(var r=atob(e.split(",")[1]),t=e.split(",")[0].split(":")[1].split(";")[0],a=[],o=0;o<r.length;o++)a.push(r.charCodeAt(o));return new Blob([new Uint8Array(a)],{type:t})};return u},r.webhookRequest=function(o){var i={},n=[],l=o.parameters.split(","),d=o.headers.split(",");if(r.webhookRequesting={},r.webhookRequesting[o.id]=!0,angular.forEach(l,function(e){var t=e.split("|"),a=t[0],o=t[1],n=t[2];i[a]=o!==r.module.name?r.record[o]?r.record[o][n]:null:r.record[n]?r.record[n]:null}),angular.forEach(d,function(t){var a=t.split("|"),o=a[0],i=a[1],l=a[2],d=a[3];switch(o){case"module":var u=d;n[l]=i!==r.module.name?r.record[i]?r.record[i][u]:null:r.record[u]?r.record[u]:null;break;case"static":switch(d){case"{:app:}":n[l]=e.user.app_id;break;case"{:tenant:}":n[l]=e.user.tenant_id;break;case"{:user:}":n[l]=e.user.id;break;default:n[l]=null}break;case"custom":n[l]=d;break;default:n[l]=null}}),"post"===o.method_type)F.post(o.url,i,{headers:n}).then(function(){t.create({content:a("translate")("Module.ActionButtonWebhookSuccess"),className:"success"}),r.webhookRequesting[o.id]=!1})["catch"](function(){t.create({content:a("translate")("Module.ActionButtonWebhookFail"),className:"warning"}),r.webhookRequesting[o.id]=!1});else if("get"===o.method_type){var u="";for(var s in i)u+=s+"="+i[s]+"&";u.length>0&&(u=u.substring(0,u.length-1)),F.get(o.url+"?"+u).then(function(){t.create({content:a("translate")("Module.ActionButtonWebhookSuccess"),className:"success"}),r.webhookRequesting[o.id]=!1})["catch"](function(){t.create({content:a("translate")("Module.ActionButtonWebhookFail"),className:"warning"}),r.webhookRequesting[o.id]=!1})}},r.$on("$locationChangeStart",function(e){r.moduleForm&&r.moduleForm.$dirty&&(confirm(a("translate")("Module.LeavePageWarning"))||e.preventDefault())}),r.setDropdownData=function(e){e.filters&&e.filters.length>0&&(r.dropdownFieldDatas[e.name]=null),r.currentLookupField=e,r.lookup().then(function(t){r.dropdownFieldDatas[e.name]=t})},r.getAttachments=function(){o.hasDocumentsPermission(r.operations.read)&&k.getEntityDocuments(e.workgroup.tenant_id,r.id,r.module.id).then(function(t){r.documentsResultSet=k.processDocuments(t.data,e.users),r.documents=r.documentsResultSet.documentList,r.loadingDocuments=!1})},w.run("AfterFormLoaded","script",r)}]);