"use strict";angular.module("primeapps").controller("ModuleListController",["$rootScope","$scope","$sce","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","config","exportFile","operations","ModuleService","$http","components","HelpService","mdToast","$mdDialog","customScripting",function(e,t,a,i,r,l,o,n,s,d,u,c,p,g,m,f,v,w,h,y,_,b){function V(e,a,r){for(var l=t.freezeFields||[],o=0;o<e.length;o++){var n=e[o],s=i("filter")(t.module.fields,{name:n.parent_field,deleted:!1},!0)[0];s&&r?l.push(s):s&&S(a,n,s)}return r?l:void 0}function S(e,a,i){for(var r=0;r<e.length;r++)if(!e[r].freeze){var l=f.processRecordSingle(angular.copy(e[r]),t.module,t.modulePicklists),o=!1;if(1===l.process_status)return;if(a.values_array&&a.values_array.length>0)for(var n=0;n<a.values_array.length;n++){var s=parseInt(a.values_array[n]);!l[i.name]||s!==l[i.name]&&s!==l[i.name].id||(o=!0)}else"Yes"===l[i.name]&&(o=!0);e[r].freeze=o}}function k(){return i("filter")(t.module.dependencies,{dependency_type:"freeze",deleted:!1},!0)}function F(e){if(null!=e.group&&null!=e.group.filters&&e.group.filters.length>0){t.logic="";for(var a=0;a<e.group.filters.length;a++){var i=e.group.filters[a];if(null!=i.group)t.logic+=1!==i.group.level&&0!==a?" "+e.group.logic+" ":"",t.logic+=F(i);else if(null!=i.operator&&""!=i.operator){C++;var i=t.processViewFilter(i,C);if(!i)continue;T.push(i),t.logic+=(0===a?"":" "+e.group.logic+" ")+C}}}return t.logic="("+t.logic+")",t.logic}t.type=n.type,t.operations=m,t.hasPermission=r.hasPermission,t.loading=!0,t.module=t.modulus[t.type],t.lookupUser=r.lookupUser,t.lookupProfile=r.lookupProfile,t.lookupRole=r.lookupRole,t.searchingDocuments=!1,t.isAdmin=e.user.profile.has_admin_rights,t.hasActionButtonDisplayPermission=f.hasActionButtonDisplayPermission,t.hideDeleteAll=i("filter")(e.deleteAllHiddenModules,t.type+"|"+t.type,!0)[0],t.actionButtonDisabled=!1,t.showExportButton=!0,t.hasViewPermission=!1,t.views=[],t.chartTypes=f.getChartsTypes(),t.showHelp=!1,t.primaryField=t.module.primaryField.name,t.hasBulkUpdatePermission=!1,t.buttonsParametersData={},t.tenantLanguage=tenantLanguage;var M=i("filter")(t.module.helps,{modal_type:"side_modal",module_type:"module_list"},!0)[0];M&&(t.showHelp=!0),t.goUrl=function(e){window.location=e},t.goUrl2=function(e){var a=window.getSelection();0===a.toString().length&&(window.location="#/app/record/"+t.module.name+"?id="+e)};var x=t.locale||t.language;if(t.isAdmin||(r.hasCustomProfilePermission("view")&&(t.hasViewPermission=!0),r.hasCustomProfilePermission("record_bulk_update")&&(t.hasBulkUpdatePermission=!0)),t.reportTypeOptions={dataSource:[{value:"summary",title:i("translate")("Report.SummaryReport")},{value:"tabular",title:i("translate")("Report.ListViewReport")},{value:"single",title:i("translate")("Report.Single")}],dataTextField:"title",dataValueField:"value",change:function(){}},!t.module)return y.warning(i("translate")("Common.NotFound")),void o.go("app.dashboard");if(e.breadcrumblist=[{title:i("translate")("Layout.Menu.Dashboard"),link:"#/app/dashboard"},{title:e.getLanguageValue(t.module.languages,"label","plural")}],t.bulkUpdate={},t.filter={},!t.hasPermission(t.type,t.operations.read))return y.error(i("translate")("Common.Forbidden")),void o.go("app.dashboard");t.changeAggregationType=function(){t.changeView(!1,!0)},f.getActionButtons(t.module.id).then(function(a){t.actionButtons=a,t.toolbarOptions={resizable:!0,items:[]},e.processLanguages(a);for(var i=0;a.length>i;i++){const r=e.getLanguageValue(a[i].languages,"label");if("Detail"!==a[i].trigger&&"Form"!==a[i].trigger&&"Relation"!==a[i].trigger){if("Scripting"===a[i].type&&t.hasActionButtonDisplayPermission(a[i],!0)){var l={template:'<md-button class="btn '+a[i].color+'"   ng-click="runScript('+i+')"  aria-label="'+r+'" > <i class="'+a[i].icon+'"></i> <span>'+r+"</span></md-button>",overflowTemplate:'<md-button ng-click="runScript('+i+')"   class="action-dropdown-item"><i class="'+a[i].icon+'"></i><span> '+r+"</span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(l)}if("Webhook"===a[i].type&&t.hasActionButtonDisplayPermission(a[i],!0)){var l={template:'<md-button class="btn '+a[i].color+'"  ng-click="webhookRequest('+i+')"    aria-label="'+r+'" > <i class="'+a[i].icon+'"></i> <span>'+r+"</span></md-button>",overflowTemplate:'<md-button ng-click="webhookRequest('+i+')"  class="action-dropdown-item" ><i class="'+a[i].icon+'"></i><span> '+r+" </span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(l)}if("ModalFrame"===a[i].type&&t.hasActionButtonDisplayPermission(a[i],!0)){var l={template:'<md-button class="btn '+a[i].color+'"  ng-click="showModuleFrameModal(\''+a[i].url+'\')"   aria-label="'+r+'" > <i class="'+a[i].icon+'"></i> <span>'+r+"</span></md-button>",overflowTemplate:"<md-button  ng-click=\"showModuleFrameModal('"+a[i].url+'\')"   class="action-dropdown-item"><i class="'+a[i].icon+'"></i><span> '+r+" </span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(l)}if("CallMicroflow"===a[i].type&&t.hasActionButtonDisplayPermission(a[i],!0)){var l={template:'<md-button class="btn '+a[i].color+'"  ng-click="runMicroflow('+a[i].microflow_id+","+i+')"   aria-label="'+r+'" > <i class="'+a[i].icon+'"></i> <span>'+r+"</span></md-button>",overflowTemplate:'<md-button ng-click="runMicroflow('+a[i].microflow_id+","+i+')"   class="action-dropdown-item"><i class="'+a[i].icon+'"></i><span> '+r+"</span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(l)}}}}),t.fields=[],t.fieldskey={},t.selectedRows=[],t.selectedRecords=[],t.isAllSelected=!1,t.currentUser=f.processUser(e.user),t.currentDayMin=r.getCurrentDateMin().toISOString(),t.currentDayMax=r.getCurrentDateMax().toISOString(),t.currentHour=r.floorMinutes(new Date),t.allFields=[],t.numberFields=[],t.dateFields=[],t.calculationFields=[],t.aggregationTypes=[{label:i("translate")("Report.sum"),value:"sum"},{label:i("translate")("Report.avg"),value:"avg"},{label:i("translate")("Report.min"),value:"min"},{label:i("translate")("Report.max"),value:"max"}];for(var R=0;R<t.module.fields.length;R++){var D=t.module.fields[R];f.hasFieldDisplayPermission(D)&&(t.allFields.push(Object.assign({},D)),t.fieldskey[D.name]=D,"numeric"===D.data_type||"number"===D.data_type||"number_auto"===D.data_type||"currency"===D.data_type||"number_decimal"===D.data_type?t.numberFields.push(D):("date"===D.data_type||"date_time"===D.data_type)&&t.dateFields.push(D))}t.parseInt=function(e){return parseInt(e)},t.colorPaletOptions={columns:6,palette:["#D24D57","#BE90D4","#5AABE3","#87D37C","#F4D03E","#B8BEC2","#DC3023","#8e44ad","#19B5FE","#25A65B","#FFB61E","#959EA4","#C3272B","#763668","#1F4688","#006442","#CA6924","#4D5C66"]};var P=function(e){var a=t.freezeDependencies||k(t.module.dependencies);a&&a.length>0&&(V(a,e,!1),t.isAllSelected&&(t.isAllSelected=!1,t.selectAll(void 0,e)))};t.chartFilter=function(a){e.activeView.aggregation.aggregation_type&&e.activeView.aggregation.field||(e.activeView.aggregation={aggregation_type:"count",field:"created_by"},t.totalCount=!0);var r=t.fieldskey[e.activeView.group_field];if("groupField"===a&&(t.reportSummary.chart.xaxisname=e.getLanguageValue(r.languages,"label"),t.reportSummary.chart.yaxisname=t.totalCount?i("translate")("Report.count"):"Report."+e.activeView.aggregation.aggregation_type),"aggregationType"===a&&(t.reportSummary.chart.yaxisname=i("translate")(t.totalCount?"Report.count":"Report."+e.activeView.aggregation.aggregation_type)),r&&"lookup"===r.data_type)var l=r.name+"."+r.lookup_type+"."+r.lookupModulePrimaryField.name;var o={module_name:t.module.name,aggregation_field:e.activeView.aggregation.aggregation_type+"("+e.activeView.aggregation.field+")",chart_type:t.reportSummary.chart.chart_type,aggregation_type:e.activeView.aggregation.aggregation_type,group_by:l||e.activeView.group_field,filters:e.activeView.filters,filter_logic:e.activeView.filter_logic};f.chartFilter(o).then(function(e){t.reportSummary.data=e.data,t.reportSummary.isNew||t.initilazSummaryReport()})},t.widgetFilter=function(){e.activeView.aggregation.aggregation_type&&e.activeView.aggregation.field||(e.activeView.aggregation={aggregation_type:"count",field:"created_by"},t.totalCount=!0);var a=e.activeView.aggregation.aggregation_type+"("+e.activeView.aggregation.field+")",i={fields:[a],limit:1,offset:0,filters:e.activeView.filters};f.findRecords(t.module.name,i).then(function(t){e.activeView.value=t.data[0][e.activeView.aggregation.aggregation_type]})},t.filtera={group:{logic:"and",filters:[],level:1}};var C=0,T=[];t.count=0,t.processViewFilter=function(a,i){var r=t.fieldskey[a.field],l={field:a.field,operator:a.operator,no:i};switch(r.data_type){case"date_time":case"date":if(a.value&&a.value.name)switch(a.value.value){case"costumeN":if(!a.valueX&&!a.nextprevdatetype&&!a.nextprevdatetype.value)return!1;l.value="today("+a.valueX+a.nextprevdatetype.value+")";break;case"costumeM":if(!a.valueX&&!a.nextprevdatetype&&!a.nextprevdatetype.value)return!1;l.value="this_month("+a.valueX+a.nextprevdatetype.value+")";break;case"costumeW":if(!a.valueX&&!a.nextprevdatetype&&!a.nextprevdatetype.value)return!1;l.value="this_week("+a.valueX+a.nextprevdatetype.value+")";break;case"costumeY":if(!a.valueX&&!a.nextprevdatetype&&!a.nextprevdatetype.value)return!1;l.value="this_year("+a.valueX+a.nextprevdatetype.value+")";break;default:if("costume"===a.value.name){if(!a.costumeDate)return!1;l.value=a.costumeDate}else l.value=a.value.value}break;case"multiselect":for(var o=[],n=0;n<a.value.length;n++){var s=a.value[n];o.push(e.getLanguageValue(s.languages,"label"))}l.value=o;break;case"tag":for(var o="",n=0;n<a.value.length;n++)o+=a.value[n].text+"|";l.value=o.slice(0,-1);break;case"lookup":"users"===r.lookup_type?l.value=a.value.id:(l.field=r.name+"."+r.lookup_type+"."+r.lookupModulePrimaryField.name,l.value=a.value);break;case"picklist":l.value=e.getLanguageValue(a.value.languages,"label");break;default:l.value=a.value}return("empty"===l.operator||"not_empty"===l.operator)&&(l.value="-"),l},t.setListGrid=function(a){var i="tabular"===e.activeView.report_type?e.activeView:t.newGridData;"report"===a?(i.report_type="tabular",i.view_type="report"):(i.report_type="",i.view_type="grid"),i.aggregations=null,i.aggregation=null,t.changeView(i,!1)},t.reportTypeChange=function(){switch(e.activeView.report_type){case"tabular":t.setListGrid("report");break;case"summary":t.reportSummary={config:{dataEmptyMessage:i("translate")("Dashboard.ChartEmptyMessage")}},t.totalCount=!0,e.activeView.aggregation={field:"",aggregation_type:""},t.reportSummary.config={dataEmptyMessage:i("translate")("Dashboard.ChartEmptyMessage")},t.reportSummary.isNew=!0,t.reportSummary.chart={languages:{}},t.reportSummary.chart[e.globalization.Label]={xaxisname:"",yaxisname:""},t.reportSummary.chart.chart_type="column3d",t.reportSummary.chart.report_aggregation_field=e.activeView.aggregation.field,t.reportSummary.chart.showToolTip=e.isMobile()?"0":"1",t.reportSummary.chart.showPercentValues="1",t.reportSummary.chart.showPercentInTooltip="0",t.reportSummary.chart.animateClockwise="1",t.reportSummary.chart.enableMultiSlicing="0",t.reportSummary.chart.isHollow="0",t.reportSummary.chart.is2D="0",t.reportSummary.chart.formatNumberScale="0",t.reportSummary.chart.exportEnabled="1",t.reportSummary.chart.exportTargetWindow="_self",t.reportSummary.chart.exportFileName=t.reportSummary.chart.languages?e.getLanguageValue(t.reportSummary.chart.languages,"caption"):"",t.reportSummary.chart.exportFormats="PNG="+i("translate")("Report.ExportImage")+"|PDF="+i("translate")("Report.ExportPdf")+"|XLS=Export Chart Data";break;case"single":t.totalCount=!0,e.activeView.aggregation={field:"created_by",aggregation_type:"count"},t.widgetFilter()}},t.changeViewType=function(a){return e.activeView.view_type===a?!1:void("grid"===a?t.setListGrid("grid"):"report"===a?(e.activeView.view_type="report",e.activeView.report_type="tabular",t.setViewAggregationsFields(t.viewFields.selectedFields)):"calendar"===a&&(e.activeView.view_type="calendar",e.activeView.report_type="",t.setViewCalendar()))},t.viewFilter=function(){C=0,T=[];F(t.filtera);return e.activeView.filters=T,e.activeView.filter_logic=T.length>1?t.logic:"","single"===e.activeView.report_type?(t.widgetFilter(),!0):"summary"===e.activeView.report_type?(t.chartFilter(),!0):"calendar"===e.activeView.view_type?(t.refreshViewCalendar(),!1):void t.changeView(!1,!0)},t.initilazSummaryReport=function(){if(t.module){if(e.activeView.group_field.indexOf(".")<0){var a=t.fieldskey[e.activeView.group_field];a&&(t.reportSummary.groupField=e.getLanguageValue(a.languages,"label"))}else{var r=e.activeView.group_field.split("."),l=i("filter")(e.modules,{name:r[1]},!0)[0],o=i("filter")(t.module.fields,{name:r[0]},!0)[0],n=i("filter")(l.fields,{name:r[2]},!0)[0];t.reportSummary.groupField=e.getLanguageValue(n.languages,"label")+" ("+e.getLanguageValue(o.languages,"label")+")"}e.activeView.aggregations&&angular.isArray(e.activeView.aggregations)&&(e.activeView.aggregation=e.activeView.aggregations[0]);var s;if(e.activeView.aggregation.field.indexOf(".")<0)s=t.fieldskey[e.activeView.aggregation.field];else{var d=e.activeView.aggregation.field.split("."),u=t.module[d[1]];s=i("filter")(u.fields,{name:d[2]},!0)[0]}s&&"currency"===s.data_type&&(t.reportSummary.chart.numberPrefix=e.currencySymbol),!s||"currency"!==s.data_type&&"number_decimal"!==s.data_type||(t.reportSummary.chart.forceDecimals="1")}t.loading=!1},t.setSummary=function(a){t.reportSummary={config:{dataEmptyMessage:i("translate")("Dashboard.ChartEmptyMessage")}},t.current={field:"",direction:""},f.getChart(a.id).then(function(a){var r=angular.isObject(a.data.chart.languages)?a.data.chart.languages:JSON.parse(a.data.chart.languages);t.reportSummary=a.data,t.reportSummary.config={dataEmptyMessage:i("translate")("Dashboard.ChartEmptyMessage")},t.reportSummary.chart.showToolTip=e.isMobile()?"0":"1",t.reportSummary.chart.showPercentValues="1",t.reportSummary.chart.showPercentInTooltip="0",t.reportSummary.chart.animateClockwise="1",t.reportSummary.chart.enableMultiSlicing="0",t.reportSummary.chart.isHollow="0",t.reportSummary.chart.is2D="0",t.reportSummary.chart.formatNumberScale="0",t.reportSummary.chart.exportEnabled="1",t.reportSummary.chart.exportTargetWindow="_self",t.reportSummary.chart.exportFileName=e.getLanguageValue(t.reportSummary.chart.languages,"caption"),t.reportSummary.chart.exportFormats="PNG="+i("translate")("Report.ExportImage")+"|PDF="+i("translate")("Report.ExportPdf")+"|XLS=Export Chart Data",t.reportSummary.chart.xaxisname=r[e.globalization.Label].xaxis_name,t.reportSummary.chart.yaxisname=r[e.globalization.Label].yaxis_name,"tr"===t.locale&&(t.reportSummary.chart.decimalSeparator=",",t.reportSummary.chart.thousandSeparator="."),t.initilazSummaryReport()})},t.setSingleReport=function(a){f.getWidget(a.id).then(function(a){var i=a.data[0];e.activeView.color=i.color,e.activeView.field=i.field,e.activeView.icon=i.icon,e.activeView.type=i.type,e.activeView.value=i.value,e.activeView.aggregation={field:i.field,aggregation_type:i.type},t.loading=!1})},t.setView=function(a){if(a){if(o.go("app.moduleList",{type:t.module.name,viewid:a.id},{notify:!1}),e.activeView=a,"report"===a.view_type)switch(("summary"===a.report_type||"single"===a.report_type)&&a.aggregations&&a.aggregations.length>0&&(t.totalCount="count"===a.aggregations[0].aggregation_type?!0:!1),a.report_type){case"summary":t.setSummary(a);break;case"tabular":if(e.activeView=a,a.aggregations)for(var r=0;r<a.fields.length;r++)if(t.fieldskey[a.fields[r].field]&&("numeric"===t.fieldskey[a.fields[r].field].data_type||"number"===t.fieldskey[a.fields[r].field].data_type||"number_auto"===t.fieldskey[a.fields[r].field].data_type||"currency"===t.fieldskey[a.fields[r].field].data_type||"number_decimal"===t.fieldskey[a.fields[r].field].data_type)){var l=i("filter")(a.aggregations,{field:a.fields[r].field})[0];l||a.aggregations.push({field:a.fields[r].field})}t.changeView(e.activeView);break;case"single":t.setSingleReport(a)}else"grid"===a.view_type&&t.changeView(e.activeView);"calendar"===a.view_type&&(e.activeView.settings&&!angular.isObject(e.activeView.settings)&&(e.activeView.settings=JSON.parse(e.activeView.settings)),t.loading=!1,t.setViewCalendar()),"report"===e.activeView.view_type&&"tabular"===e.activeView.report_type&&e.activeView.aggregations&&e.activeView.aggregations.length>0&&e.activeView.aggregations[0].aggregation_type&&(e.activeView.aggregation=e.activeView.aggregations[0]),e.activeView.filter_logic_json&&(t.filtera=JSON.parse(e.activeView.filter_logic_json))}},t.getProfilisByIds=function(t){for(var a=[],r=0;r<t.length;r++){var l=i("filter")(e.profiles,{id:parseInt(t[r])},!0);l&&a.push(l[0])}return a},t.saveModal=function(a){if(!a.validate()||!t.validSelectedFields())return y.error(i("translate")("Module.RequiredError")),!0;if("profile"===e.activeView.sharing_type&&(e.activeView.profile=t.getProfilisByIds(e.activeView.profiles)),"report"===e.activeView.view_type&&"summary"===e.activeView.report_type&&!e.activeView.group_field)return void y.error(i("translate")("Module.RequiredError"));e.preview&&(e.activeView.editable="custom"===e.activeView.system_type?!0:!1),t.viewIsSaveing=!1;var r=angular.element(document.body);_.show({parent:r,templateUrl:"view/app/module/common/viewSaveModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})},t.viewNameMax=function(){t.viewName.length>50&&(t.viewName=e.activeView["label_"+e.language],y.error(i("translate")("View.ViewNameMaxLength",{maxLength:50})))},t.SaveView=function(a){if(!t.viewSaveModalForm.validate())return y.error(i("translate")("Module.RequiredError")),void(t.viewIsSaveing=!1);if("add"===a&&(t.viewIsSaveing=!0),t.viewFields&&t.viewFields.selectedFields){e.activeView.fields=[];for(var r=0;r<t.viewFields.selectedFields.length;r++){var l=t.viewFields.selectedFields[r].name;"lookup"!==t.viewFields.selectedFields[r].data_type||t.viewFields.selectedFields[r].labelExt?e.activeView.fields.push({field:t.viewFields.selectedFields[r].name,order:r}):(l=l.split(".")[0],e.activeView.fields.push({field:l,order:r}),e.activeView.fields.push({field:t.viewFields.selectedFields[r].name+".primary",order:r}))}}e.activeView.filter_logic_json=JSON.stringify(t.filtera);var o={filters:e.activeView.filters,module_id:e.activeView.module_id,sharing_type:e.activeView.sharing_type,filter_logic_json:e.activeView.filter_logic_json,view_type:e.activeView.view_type,languages:e.activeView.languages};if("report"===e.activeView.view_type&&(o.report_type=e.activeView.report_type),"grid"===e.activeView.view_type&&(o.fields=e.activeView.fields,o.report_type=""),"edit"===a&&(o.id=e.activeView.id),"custom"===e.activeView.sharing_type){if(o.shares=[],e.activeView.shares.length<1)return y.error(i("translate")("Module.RequiredError")),t.viewIsSaveing=!1,!1;for(var n=0;n<e.activeView.shares.length;n++)o.shares.push(e.activeView.shares[n].id)}if("profile"===e.activeView.sharing_type){if(o.profiles=[],!e.activeView.profile)return void(t.viewIsSaveing=!1);for(var r=0;r<e.activeView.profile.length;r++)o.profiles.push(e.activeView.profile[r].id)}switch(e.activeView.report_type){case"summary":o.group_field=e.activeView.group_field,o.sort_field=e.activeView.sort_field,o.sort_direction="asc",o.aggregations=[{field:e.activeView.aggregation.field,aggregation_type:e.activeView.aggregation.aggregation_type}],o.chart={type:t.reportSummary.chart.chart_type,languages:{}},o.chart.languages[e.globalization.Label]={caption:o.languages[e.globalization.Label].label,xaxis_name:t.reportSummary.chart.xaxisname,yaxis_name:t.reportSummary.chart.yaxisname};break;case"tabular":o.fields=e.activeView.fields,o.aggregations=e.activeView.aggregations;break;case"single":o.aggregations=[{field:e.activeView.aggregation.field||"created_by",aggregation_type:e.activeView.aggregation.aggregation_type||"count"}],o.widget={color:e.activeView.color,icon:e.activeView.icon,languages:{}},o.widget.languages[e.globalization.Label]={name:e.getLanguageValue(e.activeView.languages,"label")}}e.preview&&(o["default"]=e.activeView["default"],o.system_type=e.activeView.editable?"custom":"system"),"calendar"===o.view_type&&(o.settings=JSON.stringify(e.activeView.settings)),o.languages[e.globalization.Label].label=t.viewName?t.viewName:e.activeView["label_"+e.language],e.languageStringify(o),f.saveView(a,o).then(function(){y.success(i("translate")("View.ViewUpdateSucces")),f.getViews(t.module).then(function(a){e.processLanguages(a),t.views=a,t.views.reverse(),e.activeView=t.views[0];var r=i("filter")(t.views,{"default":!0},!0)[0];if(r){var l=t.views.indexOf(r);t.views[l]=e.activeView,t.views[0]=r}if(e.activeView.shares){for(var o=[],n=0;n<e.activeView.shares.length;n++)o.push({id:e.activeView.shares[n].user_id,full_name:e.activeView.shares[n].user.full_name});e.activeView.shares=o}t.setView(e.activeView)}),t.closeLightBox(),e.closeSide("sideModal")})},t.sharesOptions={dataSource:t.users,filter:"contains",dataTextField:"full_name",dataValueField:"id",optionLabel:i("translate")("Common.Select")},t.profilesOptions={dataSource:e.profiles,filter:"contains",dataTextField:"languages."+e.globalization.Label+".name",dataValueField:"id",optionLabel:i("translate")("Common.Select")},t.reloadFieldSelection=function(){var e=$("#available-fields").data("kendoListBox"),a=$("#selected-fields").data("kendoListBox");if(e)for(t.selectedFieldsOptions.dataSource=new kendo.data.DataSource({data:t.viewFields.selectedFields}),t.availableFieldsOptions.dataSource=new kendo.data.DataSource({data:t.preview?t.viewFields.availableFields:i("filter")(t.viewFields.availableFields,{name:"!is_sample"},!0)}),e.setDataSource(t.availableFieldsOptions.dataSource),a.setDataSource(t.selectedFieldsOptions.dataSource),R=0;e.options.dataSource._data.length>R;R++)e.options.dataSource._data[R].name.includes("seperator-")&&e.enable($(".k-item").eq(R),!1)},t.refreshColumn=function(a){setTimeout(function(){var r=$("#selected-fields").data("kendoListBox"),l=$("#available-fields").data("kendoListBox"),o=r.wrapper.find(".k-item"),n=l.wrapper.find(".k-item"),s=[],d=[];$.each(o,function(e,t){s.push(r.dataItem(t))}),$.each(n,function(e,t){d.push(l.dataItem(t))}),t.viewFields.selectedFields=s,t.viewFields.availableFields=i("orderBy")(d,"order"),a||t.reloadFieldSelection(),"tabular"===e.activeView.report_type&&t.setViewAggregationsFields(t.viewFields.selectedFields),t.changeView(!1,!0)},200)},t.changeView=function(a,r){t.selectedRows.length>0&&(t.isAllSelected=!1,t.selectedRows=[]),r||(e.activeView=a,a.filter_logic_json&&(t.filtera=JSON.parse(a.filter_logic_json)),t.viewFields=f.getViewFields(t.module,e.activeView),t.availableFieldsOptions={disabled:!0,draggable:!0,dataTextField:"label",dataValueField:"name",connectWith:"selected-fields",dataSource:t.preview?t.viewFields.availableFields:i("filter")(t.viewFields.availableFields,{name:"!is_sample"},!0),dropSources:["selected-fields"],template:"<div class='list-title'>#:label#</div>",enable:function(){},reorder:function(e){e.preventDefault()},add:function(e){var a=e.dataItems[0];if(a.labelExt){var r=a.name.substring(0,a.name.lastIndexOf(".")),l=i("filter")(t.viewFields.availableFields,function(e){return e.name.indexOf(r)>-1&&e.labelExt===a.labelExt});l&&l.length>0&&(a.parent_id=l[0].parent_id,a.order+=a.parent_id)}else a.parent_id=0;t.refreshColumn()}},t.selectedFieldsOptions={draggable:!0,dataTextField:"label",dataValueField:"name",template:"<div class='list-title'>#:label# #:labelExt ?? ''#</div>",connectWith:"available-fields",dataSource:t.viewFields.selectedFields,dropSources:["available-fields"],reorder:function(){t.refreshColumn(!0)},add:function(){t.refreshColumn()}},t.reloadFieldSelection());var l={moduleName:t.module.name};if("report"===e.activeView.view_type&&e.activeView.report_type&&(l.report=e.activeView),e.isMobile()){for(var o=[],n=t.viewFields.selectedFields.length>3?3:t.viewFields.selectedFields.length,s=0;n>s;s++)o.push(t.viewFields.selectedFields[s]);t.viewFields.selectedFields=o}var d=f.generatRowtmpl(t.viewFields.selectedFields,!1,l);if("report"===e.activeView.view_type&&"tabular"===e.activeView.report_type&&e.activeView.aggregations&&d.columns.map(function(a){for(var i=0;i<e.activeView.aggregations.length;i++)if(a.field===e.activeView.aggregations[i].field&&e.activeView.aggregations[i].aggregation_type){var r=e.activeView.aggregations[i].aggregation_type+"("+e.activeView.aggregations[i].field+")";a.footerTemplate="<div> {{ 'Report."+e.activeView.aggregations[i].aggregation_type+"' | translate  }} : {{ "+r.replace("(","_").replace(")","")+"}} </div>";var l={fields:[r],limit:1,offset:0,filters:e.activeView.filters};f.findRecords(t.module.name,l).then(function(e){t[e.config.data.fields[0].replace("(","_").replace(")","")]=e.data[0][[e.config.data.fields[0].split("(")[0]]]})}}),t.findRequest={module:t.module.name,filter_logic:e.activeView.filter_logic,filters:e.activeView.filters,convert:!0,fields:d.requestFields},t.freezeDependencies=k(t.module.dependencies),t.freezeDependencies&&(t.freezeFields=V(t.freezeDependencies,void 0,!0),t.freezeFields))for(var u=0;u<t.freezeFields.length;u++)t.findRequest.fields.indexOf(t.freezeFields[u].name)<0&&t.findRequest.fields.push(t.freezeFields[u].name);c.put(t.module.name+"-activeView",e.activeView),c.put(t.module.name+"-activeViewFields",t.viewFields.selectedFields),e.activeView.filter_logic_json=JSON.stringify(t.filtera),t.loading=!0,t.executeCode=!1,w.run("BeforeListRequest","Script",t),t.executeCode||(t.mainGridOptions={dataSource:{serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:function(a){$.ajax({url:"/api/record/find_custom?locale="+x,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(t.findRequest,a.data)),success:function(i){if(i.data&&i.data.length>0&&P(i.data),a.success(i),t.loading=!1,e.isMobile()||$(".k-pager-wrap").removeClass("k-pager-sm"),"report"===e.activeView.view_type&&i.total_count<1)$(".k-grid-footer").addClass("hide");else{var r=!1;if(e.activeView.aggregations)for(var l=0;l<e.activeView.aggregations.length;l++){var o=e.activeView.aggregations[l];o.field&&o.aggregation_type&&(r=!0)}r?"":$(".k-grid-footer").addClass("hide")}},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}},rowTemplate:'<tr ng-click="goUrl2(dataItem.id)">'+d.rowtempl+"</tr>",altRowTemplate:'<tr class="k-alt" ng-click="goUrl2(dataItem.id)">'+d.rowtempl+"</tr>",scrollable:!1,sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100,500],buttonCount:5,info:!0},columns:d.columns})},f.getViews(t.module).then(function(a){if(e.processLanguages(a),t.views=a,t.shadowViews=angular.copy(a),t.views.length<1)return void(t.loading=!1);t.views.reverse();var r=!1,l=i("filter")(t.views,{"default":!0},!0)[0]||t.views[0];!e.activeView||e.activeView&&e.activeView.module_id!==t.module.id?e.activeView=l:(e.activeView=i("filter")(t.views,{id:e.activeView.id},!0)[0],r=!0);var o=-1;r?(o=t.views.indexOf(l),t.views[o]=t.views[0],t.views[0]=l):(o=t.views.indexOf(e.activeView),t.views[o]=t.views[0],t.views[0]=e.activeView);for(var s=0;s<t.views.length;s++)if(t.views[s].shares&&t.views[s].shares.length>0){for(var d=[],u=0;u<t.views[s].shares.length;u++)d.push({id:t.views[s].shares[u].user_id,full_name:t.views[s].shares[u].user.full_name});t.views[s].shares=d}if(n.viewid)return t.viewid=n.viewid,e.activeView=i("filter")(t.views,{id:parseInt(t.viewid)},!0)[0],e.activeView.filter_logic_json&&(t.filtera=JSON.parse(e.activeView.filter_logic_json)),t.setView(e.activeView),!0;var p=c.get(t.module.name+"-activeView");return p?(t.setView(p),!0):void t.setView(e.activeView)}),t.showModuleFrameModal=function(e){var t,a,i;t="myPop1",a=document.body.offsetWidth-200,i=document.body.offsetHeight-200;var r=screen.width/2-a/2,l=screen.height/2-i/2;window.open(e,t,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+a+", height="+i+", top="+l+", left="+r)},t.trustAsHtml=function(e){return a.trustAsHtml(e)},t.webhookRequest=function(a){if(!t.selectedRows||t.selectedRows.length<1)return void y.warning(i("translate")("Module.NoRecordSelected"));var r=t.actionButtons[a],l=r.parameters.split(","),o=r.headers.split(",");t.webhookRequesting={},t.webhookRequesting[r.id]=!0,f.getRecords(t.module.name,t.selectedRows).then(function(a){if(!a||!a.data||a.data.length<1)return void y.error(i("translate")("Common.NotFoundRecord"));for(var n=0;n<a.data.length;n++){var s={},d={"Content-Type":"application/json"},u=f.processRecordSingle(a.data[n],t.module,t.modulePicklists);if(angular.forEach(l,function(e){var a=e.split("|"),i=a[0],r=a[1],l=a[2];s[i]=r!==t.module.name?u[r]?u[r][l]:null:u[l]?u[l]:null}),angular.forEach(o,function(a){var i=a.split("|"),r=i[0],l=i[1],o=i[2],n=i[3];switch(r){case"module":var s=n;d[o]=l!==t.module.name?u[l]?u[l][s]:null:u[s]?u[s]:null;break;case"static":switch(n){case"{:app:}":d[o]=e.user.app_id;break;case"{:tenant:}":d[o]=e.user.tenant_id;break;case"{:user:}":d[o]=e.user.id;break;default:d[o]=null}break;case"custom":d[o]=n;break;default:d[o]=null}}),"post"===r.method_type)v.post(r.url,s,{headers:d}).then(function(){t.webhookRequesting[r.id]=!1})["catch"](function(){y.warning(i("translate")("Module.ActionButtonWebhookFail")),t.webhookRequesting[r.id]=!1});else if("get"===r.method_type){var c="";for(var p in s)c+=p+"="+s[p]+"&";c.length>0&&(c=c.substring(0,c.length-1)),v.get(r.url+"?"+c).then(function(){t.webhookRequesting[r.id]=!1})["catch"](function(){y.warning(i("translate")("Module.ActionButtonWebhookFail")),t.webhookRequesting[r.id]=!1})}}y.success(i("translate")("Module.ActionButtonWebhookSuccess"))})},t.runMicroflow=function(a,r){var l=t.actionButtons[r];if(0===t.selectedRows.length)return void y.error(i("translate")("Module.RequiredRecord"));if(t.buttonsParametersData={},t.actionButtonsData={data:{record_ids:t.selectedRows,module_id:t.module.id,record_name:l.record_name},workflow_id:a,button:l},l.parameters){t.showMicroflowParameters=!0,t.showScriptParameters=!1,t.buttonsParameters=JSON.parse(l.parameters),t.picklistItems={},angular.forEach(t.buttonsParameters,function(e){(3===e.type||4===e.type)&&v.get(p.apiUrl+"picklist/get/"+e.lowerType).then(function(a){t.picklistItems[e.key]=a.data})});var o=angular.element(document.body);_.show({parent:o,templateUrl:"view/app/module/actionButtonsParameterModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})}else f.runMicroflow(a,t.actionButtonsData.data).then(function(t){200===t.status&&"popup"===l.message_type&&e.getLanguageValue(l.languages,"message")&&y.success(e.getLanguageValue(l.languages,"message"))})["catch"](function(e){400===e.status&&y.error(i("translate")("Module.RequiredRecord"))})},t.runMicroflowParameters=function(a){a.validate()&&(t.actionButtonsData.data.parameters=t.buttonsParametersData,f.runMicroflow(t.actionButtonsData.workflow_id,t.actionButtonsData.data).then(function(a){200===a.status&&"popup"===t.actionButtonsData.button.message_type&&e.getLanguageValue(t.actionButtonsData.button.languages,"message")&&y.success(e.getLanguageValue(t.actionButtonsData.button.languages,"message"))})["catch"](function(e){400===e.status&&y.error(i("translate")("Module.RequiredRecord"))}),t.closeLightBox())},t.numberOptionsButtons={format:"{0:n0}",decimals:0},t.recordDelete=function(e,a){var r=_.confirm().title(i("translate")("Common.AreYouSure")).targetEvent(e).ok(i("translate")("Common.Yes")).cancel(i("translate")("Common.No"));_.show(r).then(function(){f.getRecord(t.module.name,a).then(function(e){if(!t.hasPermission(t.type,m.modify,e.data))return void y.error(i("translate")("Common.Forbidden"));var r=f.processRecordSingle(e.data,t.module,t.modulePicklists);t.executeCode=!1,w.run("BeforeDelete","Script",t,r),t.executeCode||f.deleteRecord(t.module.name,a).then(function(){t.refreshGrid(),y.success(i("translate")("Module.DeleteMessage"))})})},function(){t.status="You decided to keep your debt."
})},t.hideCreateNew=function(e){return"users"===e.lookup_type?!0:"relation"===e.lookup_type&&!t.record.related_module},t.deleteView=function(a){var r=_.confirm().title(i("translate")("Common.AreYouSure")).targetEvent(a).ok(i("translate")("Common.Yes")).cancel(i("translate")("Common.No"));_.show(r).then(function(){f.deleteView(e.activeView.id).then(function(){y.success({content:i("translate")("View has been deleted successfully"),timeout:5e3}),t.closeLightBox(),f.getViews(t.module).then(function(a){e.processLanguages(a),t.views=a,t.views.reverse(),e.closeSide("sideModal")})})},function(){t.status="You decided to keep your debt."})},t["export"]=function(){if(!(t.tableParams.total()<1)){var a=!1;try{a=!!new Blob}catch(r){}if(!a)return void y.warning({content:i("translate")("Module.ExportUnsupported"),timeout:8e3});if(t.tableParams.total()>3e3)return void y.warning({content:i("translate")("Module.ExportWarning"),timeout:8e3});var l=e.getLanguageValue(t.module.languages,"label","plural")+"-"+i("date")(new Date,"dd-MM-yyyy")+".xls";t.exporting=!0,f.getCSVData(t,t.type).then(function(e){y.success({content:i("translate")("Module.ExcelExportSuccess"),timeout:5e3}),g.excel(e,l),t.exporting=!1})}},t.showActivityButtons=function(){},t.showDataTransferButtons=function(){},t.openExportDialog=function(){t.pdfCreating=!0,t.loadingModal=!0;var a=function(){var e=angular.element(document.body);_.show({parent:e,templateUrl:"view/app/module/modulePdfModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})};f.getTemplates(t.module.name,"module").then(function(r){if(0===r.data.length)y.warning(e.preview?i("translate")("Setup.Templates.TemplateDefined"):i("translate")("Setup.Templates.TemplateNotFound")),t.pdfCreating=!1;else{var l=r.data;t.quoteTemplates=i("filter")(l,{active:!0},!0),t.isShownWarning=!0;for(var o=0;o<t.quoteTemplates.length;o++){var n=t.quoteTemplates[o];if(n.permissions.length>0){var s=i("filter")(n.permissions,{profile_id:e.user.profile.id},!0)[0];n.isShown="none"===s.type?!1:!0,n.isShown===!0&&(t.isShownWarning=!1)}else n.isShown=!0,t.isShownWarning=!1}t.quoteTemplatesOptions={dataSource:i("filter")(t.quoteTemplates,{isShown:!0},!0),dataTextField:"name",dataValueField:"id"},t.quoteTemplate=t.quoteTemplates[0],t.loadingModal=!1,a()}})["catch"](function(){t.pdfCreating=!1})},t.selectRow=function(e,a){return e.target.checked?(a.selected=!0,t.selectedRows.push(a.id),void t.selectedRecords.push({id:a.id,displayName:a[t.module.primaryField.name]})):(a.selected=!1,t.selectedRows=t.selectedRows.filter(function(e){return e!==a.id}),void(t.isAllSelected=!1))},t.isRowSelected=function(e){return t.selectedRows.filter(function(t){return t===e}).length>0},t.selectAll=function(e,a){if(t.selectedRows=[],t.isAllSelected){t.isAllSelected=!1;for(var i=0;i<a.length;i++)a[i].selected&&(a[i].selected=!1)}else{t.isAllSelected=!0;for(var i=0;i<a.length;i++)!a[i].freeze||t.user.profile.has_admin_rights?(a[i].selected=!0,t.selectRow(e,a[i])):a[i].selected=!1}},t.deleteSelecteds=function(e){if(!t.selectedRows||!t.selectedRows.length)return void y.warning(i("translate")("Module.NoRecordSelected"));var a=_.confirm().title(i("translate")("Common.AreYouSure")).textContent(i("translate")("Module.SelectedRecordsCount")+t.selectedRows.length).targetEvent(e).ok(i("translate")("Common.Yes")).cancel(i("translate")("Common.No"));_.show(a).then(function(){f.deleteRecordBulk(t.module.name,t.selectedRows).then(function(){y.success(i("translate")("Module.DeleteMessage")),t.selectedRows=[],t.isAllSelected=!1,t.refreshGrid()})},function(){t.status="You decided to keep your debt."})},t.addCustomField=function(e,t){tinymce.activeEditor.execCommand("mceInsertContent",!1,"{"+t.name+"}")},t.showEMailModal=function(){if(t.executeCode=!1,!e.system.messaging.SystemEMail&&!e.system.messaging.PersonalEMail)return void y.warning(i("translate")("EMail.NoProvider"));if(0==t.selectedRows.length&&!t.isAllSelected)return void y.warning(i("translate")("Module.NoRecordSelected"));w.run("BeforeModalLoad","Script",t);var a=angular.element(document.body);t.executeCode||_.show({parent:a,templateUrl:"view/app/email/bulkEMailModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})},t.showSMSModal=function(){if(!e.system.messaging.SMS)return void y.warning(i("translate")("SMS.NoProvider"));if(0==t.selectedRows.length&&!t.isAllSelected)return void y.warning(i("translate")("Module.NoRecordSelected"));var a=angular.element(document.body);_.show({parent:a,templateUrl:"view/app/sms/bulkSMSModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})},t.collectiveApproval=function(){t.loading=!0;var e=[];angular.forEach(t.selectedRows,function(a){var r=i("filter")(t.grid.dataSource.data(),{id:a},!0)[0];angular.isUndefined(r)||2!==r["process.process_requests.process_status"]&&e.push(r.id)}),e.length>0&&f.approveMultipleProcessRequest(e,t.module.name).then(function(){y.success(e.length+i("translate")("Module.ApprovedRecordCount")),t.loading=!1,t.refresh(!0)})},t.showCollectiveApproval=function(){t.selected=t.selectedRows.length,!t.selectedRows||t.selectedRows.length>0||y.warning(i("translate")("Module.NoRecordSelected"))},t.dropdownHide=function(){var e=angular.element(document.getElementById("dropdownMenu1"));e[0]&&e[0].click(),e[1]&&e[1].click()},t.closeLightBox=function(){_.hide()},t.showLightBox=function(a,r,l,o,n){if(r){t.showImageData={},t.multiSelectAndTagDatas={};var s=n?e.modulus[n.related_module]:t.module,d=o?i("filter")(s.fields,{name:o,deleted:!1})[0]:t.module.primaryField.name;l?t.showImageData={url:a.target.src,title:r[d]||e.getLanguageValue(d.languages,"label"),type:o?"location":"image",map_url:"http://www.google.com/maps/place/"+r[d.name]}:r[o]&&(d=i("filter")(s.fields,{name:o,deleted:!1})[0],t.multiSelectAndTagDatas={array:r[o].split(";"),title:r[d]||e.getLanguageValue(d.languages,"label")}),_.show({contentElement:"#mdLightbox",parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:!1})}},t.setCurrentLookupField=function(){};var O=function(){if("users"===t.field.lookup_type&&!t.field.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="full_name",t.field.lookupModulePrimaryField=a}if("profiles"===t.field.lookup_type&&!t.field.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="name",t.field.lookupModulePrimaryField=a}if("roles"===t.field.lookup_type&&!t.field.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="label_"+e.user.tenantLanguage,t.field.lookupModulePrimaryField=a}if("relation"===t.field.lookup_type){if(!t.record.related_module)return t.$broadcast("angucomplete-alt:clearInput",t.field.name),s.defer().promise;var r=i("filter")(e.modules,{name:t.record.related_module.value},!0)[0];if(!r)return t.$broadcast("angucomplete-alt:clearInput",t.field.name),s.defer().promise;t.field.lookupModulePrimaryField=i("filter")(r.fields,{primary:!0},!0)[0]}};t.inputReset=function(){if(t.bulkUpdate.value=null,"picklist"===t.field.data_type&&(t.optionId=t.field.picklist_id),"lookup"===t.field.data_type){t.currentLookupField=t.field;var a=new kendo.data.DataSource({serverFiltering:!0,transport:{read:function(a){var i={module:t.currentLookupField.lookup_type,convert:!1};if((!a.data.filter||a.data.filter&&0===a.data.filter.filters.length)&&(a.data.filter={},a.data.filter.filters=[],a.data.filter.logic="and",O()),a.data.filter.filters.length>0){var r=a.data.filter.filters[0].operator;r.contains("_")&&(a.data.filter.filters[0].operator=""!==r?r.replace("_",""):"startswith"),t.lookupSearchValue=a.data.filter.filters[0].value}$.ajax({url:"/api/record/find_custom",contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(i,a.data)),success:function(e){a.success(e)},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}});t["lookupOptions"+t.field.id]={dataSource:a,optionLabel:i("translate")("Common.Select"),dataTextField:t.field.lookupModulePrimaryField.name,dataValueField:"id"};var r=angular.element(document.getElementById(t.field.name)).data("kendoDropDownList");r&&(r.setOptions({dataTextField:t.field.lookupModulePrimaryField.name}),r.setDataSource(a))}},t.updateSelected=function(e){if(t.selectedRows&&t.selectedRows.length&&e.validate()){t.submittingModal=!0;var a={},r=t.field.name;a.ids=t.selectedRows;var l={};if(a.records=[],"picklist"!==t.field.data_type&&"multiselect"!==t.field.data_type&&"date"!==t.field.data_type&&"tag"!==t.field.data_type)l[r]=t.bulkUpdate.value;else switch(t.field.data_type){case"picklist":l[r]=t.bulkUpdate.value.id;break;case"multiselect":for(var o=[],n=0;n<t.bulkUpdate.value.length;n++)o.push(t.bulkUpdate.value[n].id);l[r]=o;break;case"tag":for(var s=[],d=0;d<t.bulkUpdate.value.length;d++){var u=i("filter")(t.field.tag.dataSource._view,{id:parseInt(t.bulkUpdate.value[d])},!0)[0];u&&s.push(u.text)}l[r]=s.toString();break;case"date":var c=moment(t.bulkUpdate.value).format().split("+");l[r]=c[0]}a.records.push(l),f.updateRecordBulk(t.module.name,a).then(function(){t.closeLightBox(),y.success(i("translate")("Module.UpdateRecordBulkSuccess")),t.refreshGrid(),t.isAllSelected=!1,t.selectedRows=[],t.selectedRecords=[],t.bulkUpdate.value=null,t.field=null})}},t.openCalendar=function(e){f.openCalendar(e)},t.openExcelTemplate=function(){t.excelCreating=!0,t.hasQuoteTemplateDisplayPermission=f.hasQuoteTemplateDisplayPermission;var a=function(){var e=angular.element(document.body);_.show({parent:e,templateUrl:"view/app/module/moduleExcelModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})};t.quoteTemplates&&(a(),t.quoteTemplate=t.quoteTemplates[0]),f.getTemplates(t.module.name,"excel").then(function(r){if(0===r.data.length)y.warning(e.preview?i("translate")("Setup.Templates.TemplateDefined"):i("translate")("Setup.Templates.TemplateNotFound")),t.excelCreating=!1;else{var l=r.data;t.quoteTemplates=i("filter")(l,{active:!0},!0),t.isShownWarning=!0;for(var o=0;o<t.quoteTemplates.length;o++){var n=t.quoteTemplates[o];n.isShown="everybody"===n.sharing_type?!0:n.profile_list[e.user.profile.id]?!0:!1,n.isShown===!0&&(t.isShownWarning=!1)}t.quoteTemplate=t.quoteTemplates[0],a()}})["catch"](function(){t.excelCreating=!1})},t.UpdateMultiselect=function(a,i){var r=[];return angular.forEach(t.modulePicklists[i.picklist_id],function(t){if(!t.inactive){var i=e.getLanguageValue(t.languages,"label");i&&i.toLowerCase().indexOf(a)>-1&&r.push(t)}}),r},f.getPicklists(t.module,!0).then(function(a){var r=angular.copy(t.sharesOptions);r.dataSource.push({full_name:i("translate")("Common.LoggedInUser"),id:"[me]"}),e.processPicklistLanguages(a),t.modulePicklists=a,t.picklistOptions=[];for(var l=0;l<t.module.fields.length;l++){var o=t.module.fields[l];switch(o.data_type){case"picklist":"picklist"!==o.data_type||o.deleted||(o.picklist=t.modulePicklists[o.picklist_id]);break;case"multiselect":o.options={dataSource:t.modulePicklists[o.picklist_id],filter:"contains",dataTextField:"languages."+e.globalization.Label+".label",dataValueField:"id",optionLabel:i("translate")("Common.Select")};break;case"tag":var n=new kendo.data.DataSource({transport:{read:{url:"/api/tag/get_tag/"+o.id,type:"GET",dataType:"json",beforeSend:e.beforeSend()}}});n.read(),o.tag={dataSource:n,dataTextField:"text",dataValueField:"id",valuePrimitive:!0,filter:"contains",tagMode:"multiple",change:function(){var e=this.value(),t=this.options.tagMode,a=t;a=e.length<=5?"multiple":"single",a!==t&&(this.value([]),this.setOptions({tagMode:a}),this.value(e))}};break;case"lookup":"users"===o.lookup_type&&(o.dataOptions=r);break;case"date":case"date_time":case"time":}}}),t.showUpdateModal=function(a){if(!t.selectedRows||!t.selectedRows.length)return void y.warning(i("translate")("Module.NoRecordSelected"));if(t.selectedRows.length>100)return void y.warning(i("translate")("Module.RecordLimit"));var r=[],l=function(){if(r=angular.copy(t.module.fields),!t.isAdmin&&!t.hasBulkUpdatePermission){for(var e=0;e<t.module.sections.length;e++){var a=t.module.sections[e];f.hasSectionFullPermission(a)&&f.hasSectionDisplayPermission(a)&&!f.hasSectionReadOnlyPermission(a)||(r=i("filter")(r,function(e){return e.section!==a.name},!0))}for(var e=0;e<r.length;e++)if(!f.hasFieldFullPermission(r[e])||!f.hasFieldDisplayPermission(r[e])||f.hasFieldReadOnlyPermission(r[e])){var l=r.indexOf(r[e]);r.splice(l,1)}}};l(),t.fieldOptions={dataSource:i("filter")(r,function(e){return"number"!==e.data_type||e.deleted?"number_decimal"!==e.data_type||e.deleted?"currency"!==e.data_type||e.deleted||(e=f.setMinMaxValueForField(e),t["currencyOptions"+e.id]={culture:kendo.cultures.current.name,format:"c",decimals:kendo.cultures.current.numberFormat.currency.decimals}):e=f.setMinMaxValueForField(e):(e=f.setMinMaxValueForField(e),t["numberOptions"+e.id]={format:"{0:n0}",decimals:0}),!("checkbox"===e.data_type&&!preview&&"is_sample"===e.name||"image"===e.data_type||"location"===e.data_type||"document"===e.data_type||"number_auto"===e.data_type||"updated_at"===e.name||"updated_by"===e.name||"created_at"===e.name||"created_by"===e.name||!e.validation||e.validation.readonly||e.custom_label)},!0),dataTextField:"languages."+e.globalization.Label+".label",dataValueField:"id",autoBind:!1,filter:"contains",optionLabel:i("translate")("Common.Select")},t.selected=t.selectedRows.length;var o=angular.element(document.body);_.show({parent:o,templateUrl:"view/app/module/bulkUpdateModal.html",clickOutsideToClose:!0,targetEvent:a,scope:t,preserveScope:!0}),angular.element(document).ready(function(){t.bulkUpdateModalForm.options.rules.range=f.rangeRuleForForms()})},t.showDeleteModal=function(){t.selected=t.selectedRows.length},t.showExportDataModal=function(e){t["export"].moduleAllColumn=null;var a=angular.element(document.body);_.show({parent:a,templateUrl:"view/app/module/exportData.html",clickOutsideToClose:!1,targetEvent:e,scope:t,preserveScope:!0})},t.recordProcessDetail=function(a){t.previousApprovers&&delete t.previousApprovers,t.processOrderParam&&delete t.processOrderParam,t.currentApprover&&delete t.currentApprover,t.updateTime&&delete t.updateTime,t.rejectApprover&&delete t.rejectApprover;for(var r,l=0;l<e.approvalProcesses.length;l++){var o=e.approvalProcesses[l];o.module_id===t.module.id&&(r=o)}"dynamicApprover"===r.approver_type&&(t.loadingProcessPopup=!0,t.processStatusParam=a["process.process_requests.process_status"],f.getRecord(t.module.name,a.id).then(function(a){var r,l,o,n,s=a.data,d=[];if(1===s.process_status){if(r=s.process_status_order,1===s.process_status_order)l=i("filter")(e.users,{email:s.custom_approver},!0)[0].full_name;else{l=i("filter")(e.users,{email:s["custom_approver_"+s.process_status_order]},!0)[0].full_name;var u=i("filter")(e.users,{email:s.custom_approver},!0)[0].full_name;d.push(u);for(var c=2;c<s.process_status_order;c++)d.push(i("filter")(e.users,{email:s["custom_approver_"+c]},!0)[0].full_name);t.previousApprovers=d}t.processOrderParam=r,t.currentApprover=l}else if(2===s.process_status){o=s.process_request_updated_at;var u=i("filter")(e.users,{email:s.custom_approver},!0)[0].full_name;d.push(u);for(var c=2;c<s.process_status_order+1;c++)d.push(i("filter")(e.users,{email:s["custom_approver_"+c]},!0)[0].full_name);t.previousApprovers=d,t.updateTime=moment(o).utc().format("DD-MM-YYYY HH:mm")}else 3===s.process_status&&(o=s.process_request_updated_at,n=i("filter")(e.users,{id:s.process_request_updated_by},!0)[0].full_name,t.rejectApprover=n,t.updateTime=moment(o).utc().format("DD-MM-YYYY HH:mm"));t.loadingProcessPopup=!1}))},t.filterModalOpen=function(){e.buildToggler("sideModal","view/app/module/filter-view.html"),setTimeout(function(){var e=$("#available-fields").data("kendoListBox");if(e)for(R=0;e.options.dataSource.length>R;R++)e.options.dataSource[R].name.includes("seperator-")&&e.enable($(".k-item").eq(R),!1)},200)},t.refreshGrid=function(){$("#kendo-grid").data("kendoGrid").dataSource.read()},t.goToRecord=function(e,t,a,i){f.goToRecord(e,t,a,i)},t.getTagAndMultiDatas=function(e,a){var i=[];if(e[a]){for(var r=e[a].split(";"),l=0;l<r.length;l++)i.push(t.getPicklistValue(a,r[l]));return f.getTagAndMultiDatas(e,i)}},t.getImageStyle=function(e){return e?f.getImageStyle(e,t.module.name):void 0},t.getRatingCount=function(e){return e?f.getRatingCount(e,t.module.name):void 0},t.getLocationUrl=function(e){return e?f.getLocationUrl(e):void 0},t.newGridData={module_id:t.module.id,languages:{},active:!0,sharing_type:"everybody",isNew:!0,filter_logic_json:'{"group":{"logic":"and","filters":[],"level":1}}',"default":!0,view_type:"grid",report_feed:"module",report_type:"",sort_direction:"",filters:[],fields:[{field:t.module.primaryField.name,order:1}]},t.newGridData.languages[e.globalization.Label]={label:"All"+e.getLanguageValue(t.module.languages,"label","plural")},t.openNewDashlet=function(){t.views=[],t.activeView=angular.copy(t.newGridData),t.views.push(t.activeView),t.changeView(t.activeView),t.filterModalOpen()},t.changeTotalCount=function(a){t.totalCount=a,a&&(e.activeView.aggregation={aggregation_type:"count",field:"created_by"},e.activeView.aggregations[0]=e.activeView.aggregation,"summary"===e.activeView.report_type?t.chartFilter():t.widgetFilter())},t.setViewAggregationsFields=function(t){if("report"!==e.activeView.view_type)return!1;var a=[];if("tabular"===e.activeView.report_type){for(var r=0;r<t.length;r++){var l=t[r];if(("numeric"===l.data_type||"number"===l.data_type||"number_auto"===l.data_type||"currency"===l.data_type||"number_decimal"===l.data_type)&&!l.deleted){if(e.activeView.aggregations&&e.activeView.aggregations.length>0)var o=i("filter")(e.activeView.aggregations,{field:l.name})[0];a.push(o?o:{field:l.name,aggregation_type:""})}}e.activeView.aggregations=a}},t.controlRemove=function(e,a){return e.showRemove=t.hasPermission(a?a:t.module.name,m.remove)},t.controlCopy=function(e,a){return e.showCopy=t.hasPermission(a?a:t.module.name,m.write)},t.controlEdit=function(e,a){return e.showEdit=t.hasPermission(a?a:t.module.name,m.modify)},t.validSelectedFields=function(){return"view"===t.activeView.view_type||"tabular"===t.activeView.report_type?t.viewFields.selectedFields.length>=1:!0},t.runScript=function(e){var a=t.actionButtons[e];if(a.parameters){t.showMicroflowParameters=!1,t.showScriptParameters=!0,t.buttonsParameters=JSON.parse(a.parameters);var i=angular.element(document.body);_.show({parent:i,templateUrl:"view/app/module/actionButtonsParameterModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})}else b.run(t,a.template)},t.runScriptParameters=function(e){e.validate()&&(t.actionButtonsData.data.parameters=t.buttonsParametersData,b.run(t,t.actionButtonsData.button.template),t.closeLightBox())},t.shortChange=function(e,a){t.reportSummary.fieldName=e,t.reportSummary.reverse=a,t.reportSummary.data=i("orderBy")(t.reportSummary.data,t.reportSummary.fieldName,t.reportSummary.reverse)},t.downloadImg=function(e){if(e){var t=e.split("/"),a=t[t.length-1];v({method:"GET",url:e,responseType:"arraybuffer"}).then(function(e){if(e.data){var t=new Uint8Array(e.data),i=new Blob([t],{type:"application/octet-stream"});saveAs(i,a)}},function(){})}},t.revertFilter=function(){var a=i("filter")(t.shadowViews,{id:e.activeView.id},!0)[0];t.setView(Object.assign({},a))},t.setViewCalendar=function(){return e.activeView.settings&&e.activeView.settings.startdatefield?(t.findRequest={module:t.module.name,take:5e3,filter_logic:e.activeView.filter_logic,filters:e.activeView.filters,convert:!0,fields:[t.primaryField,e.activeView.settings.startdatefield]},t.enddateisAvailable=!1,e.activeView.settings.enddatefield&&"end"!==e.activeView.settings.enddatefield?(t.findRequest.fields.push(e.activeView.settings.enddatefield),t.enddateisAvailable=!0):e.activeView.settings.enddatefield="end",t.calenderDefaultDate=new Date,void(t.calendarOptions={add:function(e){e.preventDefault()},edit:function(e){window.location="#/app/record/"+t.module.name+"?id="+e.event.id,e.preventDefault()},resize:function(t){return"end"===e.activeView.settings.enddatefield&&t.preventDefault(),!1},resizeEnd:function(e){return t.enddateisAvailable||e.preventDefault(),!1},navigate:function(e){return e.date.getMonth()===t.calenderDefaultDate.getMonth()&&t.calenderDefaultDate.getFullYear()===e.date.getFullYear()?!1:void 0},"delete":function(e){e.preventDefault(),t.recordDelete(e,5)},views:["day",{type:"month",selected:!0},"week","agenda","timeline"],allDaySlot:!1,dataSource:{transport:{read:function(a){$.ajax({url:"/api/record/find_custom?locale="+x,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(t.findRequest,a.data)),success:function(i){if(i.total_count<1)return a.success({}),!1;var r=f.kendoCaleanderDataProcces(i.data,e.activeView.settings,t.primaryField,t.enddateisAvailable);return a.success(r),!0},beforeSend:e.beforeSend()})},update:function(a){var i=a.data,r={id:i.id};r[e.activeView.settings.startdatefield]=i[e.activeView.settings.startdatefield],t.enddateisAvailable&&(r[e.activeView.settings.enddatefield]=i[e.activeView.settings.enddatefield]),f.updateRecord(t.module.name,r).then(function(){a.success(a.data)})}},schema:{model:{id:"id",fields:{id:{type:"number"},start:{type:"date",from:e.activeView.settings.startdatefield},end:{type:"date",from:e.activeView.settings.enddatefield},isAllDay:{type:"boolean"}}}}}})):!1},t.refreshViewCalendar=function(){t.findRequest={module:t.module.name,take:5e3,filter_logic:e.activeView.filter_logic,filters:e.activeView.filters,convert:!0,fields:[t.primaryField,e.activeView.settings.startdatefield]};$("#viewCalendar").data("kendoScheduler").dataSource.read()},t.languageOptions=f.getLanguageOptions(),t.getPicklistValue=function(e,a){if(e&&a){var r=i("filter")(t.module.fields,{name:e},!0)[0];if(r)for(var l=t.modulePicklists[r.picklist_id],o=0;o<l.length;o++){var n=f.getPicklistValue(l[o],a);if(n&&n!==!0)return n}}}}]);