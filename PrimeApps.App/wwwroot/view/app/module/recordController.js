"use strict";angular.module("primeapps").controller("RecordController",["$rootScope","$scope","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","config","$timeout","operations","FileUploader","ModuleService","DocumentService","$http","resizeService","components","mdToast","$mdDialog","exportFile","AppService","customScripting",function(e,t,a,o,n,l,i,r,d,s,u,c,m,p,f,g,y,_,h,v,b,k,w,M,S){function F(e,a){const o=e.data;o[0]&&o[0].total_count?a.total=o[0].total_count:delete a.total,("flat"===a.detail_view_type||"flat"===t.module.detail_view_type)&&t.returnParentType===a.id&&(t.activeType="tab",t.tab="general"),t.returnTab==a.id&&(t.activeType="tab",t.tab=a.id.toString(),t.changeTab(a))}function T(e){const a=[],o={};t.type!==t.manyToManyRelation.related_module?(o[t.type+"_id"]=e,o[t.manyToManyRelation.related_module+"_id"]=n.search().pid):(o[t.type+"1_id"]=e,o[t.manyToManyRelation.related_module+"2_id"]=n.search().pid),a.push(o);const l={records:a};return l.tableName=t.manyToManyRelation.many_to_many_table_name,l}function C(e,a,o){const n=[],l={};if(a)l[t.module.name+"_id"]=parseInt(t.id),l[e+"_id"]=o,n.push(l);else{for(var i=0;i<t.selectedRecords[e].length;i++)l[t.module.name+"_id"]=t.id,l[e+"_id"]=t.selectedRecords[e][i],n.push(Object.assign({},l));t.selectedRecords[e]=[],t.isAllSelected[e]=!1}return n}function L(e){return e.validation.min=e.validation.min||Number.MIN_SAFE_INTEGER,e.validation.max=e.validation.max||Number.MAX_SAFE_INTEGER,e}function R(e,o){var n=a("filter")(t.module.fields,{data_type:"number_auto",deleted:!1});if(n)for(var l=0;l<n.length;l++){var i=n[l];e?delete o[i.name]:i.display_detail=!1}}function P(o){if("p_profiles"===t.module.name&&o&&o.name!==t.profileInfo.name){const n=e.globalization.Label;var l=a("filter")(e.profiles,{id:t.profileInfo.profile_id},!0)[0];l&&(angular.isObject(l.languages)?l.languages[n].name=o.name:(e.user.profile.languages=JSON.parse(l.languages),l.languages[n].name=o.name),e.user.profile&&(angular.isObject(e.user.profile.languages)?e.user.profile.languages[n].name=o.name:(e.user.profile.languages=JSON.parse(e.user.profile.languages),e.user.profile.languages[n].name=o.name)))}}function D(e,t){if(e&&e.length>0){var o=a("filter")(e,{field:t.name},!0)[0];!o||"number"!==t.data_type&&"number_auto"!==t.data_type||(o.operator=o.operator.startsWith("starts")||"contains"===o.operator?"equals":o.operator)}}function x(o,n){var l=t.fieldskey[o.field.name],i={field:o.field,operator:o.operator,no:n};switch(o.field.multiselectLookupField&&""!=o.field.multiselectLookupField&&Y.push(o.field.multiselectLookupField),l.data_type){case"date_time":case"date":if(o.value&&o.value.name)switch(o.value.value){case"costumeN":if(!o.valueX&&!o.nextprevdatetype&&!o.nextprevdatetype.value)return!1;i.value="today("+o.valueX+o.nextprevdatetype.value+")";break;case"costumeM":if(!o.valueX&&!o.nextprevdatetype&&!o.nextprevdatetype.value)return!1;i.value="this_month("+o.valueX+o.nextprevdatetype.value+")";break;case"costumeW":if(!o.valueX&&!o.nextprevdatetype&&!o.nextprevdatetype.value)return!1;i.value="this_week("+o.valueX+o.nextprevdatetype.value+")";break;case"costumeY":if(!o.valueX&&!o.nextprevdatetype&&!o.nextprevdatetype.value)return!1;i.value="this_year("+o.valueX+o.nextprevdatetype.value+")";break;default:if("costume"===o.value.name){if(!o.costumeDate)return!1;i.value=o.costumeDate}else i.value=o.value.value}break;case"multiselect":for(var r=[],d=0;d<o.value.length;d++){var s=o.value[d];r.push(e.getLanguageValue(s.languages,"label"))}i.value=r;break;case"tag":for(var r="",d=0;d<o.value.length;d++)r+=o.value[d].text+"|";i.value=r.slice(0,-1);break;case"lookup":"users"===l.lookup_type?i.value=o.value.id:(i.field=l.name+"."+l.lookup_type+"."+l.lookupModulePrimaryField.name,i.value=o.value);break;case"picklist":i.value=a("filter")(t.fieldskey[o.field.name].picklist,{id:parseInt(o.value)},!0)[0].labelStr;break;default:i.value=o.value}return("empty"===i.operator||"not_empty"===i.operator)&&(i.value="-"),i}function A(e){if(null!=e.group&&null!=e.group.filters&&e.group.filters.length>0)for(var o="",n=a("filter")(e.group.filters,function(e){return e.key},!0),l=0;l<e.group.filters.length;l++){var i=e.group.filters[l];if(null!=i.group)o+=1!==i.group.level&&0!==l?" "+i.group.logic+" ":"",o+=A(i);else if(null!=i.operator&&""!==i.operator){H++;var i=x(i,H);if(!i)continue;J.push({no:i.no,field:i.field.name,operator:i.operator.name,value:i.value}),1===e.group.level&&0===l&&l!==n.length-1&&(t.logic+="("),o+=(0===l?"":" "+e.group.logic+" ")+J.length,1===e.group.level&&l===n.length-1&&0!==l&&(t.logic+=")")}}return o&&!o.contains("undefined")&&(o="("+o+")"),o}function I(t,o){if(o){const n=a("filter")(e.modulus[o].fields,{primary:!0},!0)[0],l=a("filter")(e.modulus[o].fields,{primary_lookup:!0},!0)[0];var i=0;n&&(i=t.indexOf(n.name),0>i&&t.push(n.name)),l&&(i=t.indexOf(l.name),0>i&&t.push(l.name))}}t.formUniqKey="".generateRandomKey(10),t.formType||(t.type=i.type,t.subtype=i.stype,t.id=n.search().id,t.parentType=n.search().ptype,t.parentId=n.search().pid,t.returnTab=n.search().rtab,t.previousParentType=n.search().pptype,t.previousParentId=n.search().ppid,t.previousReturnTab=n.search().prtab,t.backUrlAtt=n.search().back,t.back=n.search().back,t.many=n.search().many,t.clone=n.search().clone,t.revise=n.search().revise,t.paramField=n.search().field,t.paramValue=n.search().value,t.fastRecordModal=!1),e.sideinclude=!1,t.isDisabled=!1,t.actionButtonDisabled=!1,t.operations=p,t.hasPermission=o.hasPermission,t.hasDocumentsPermission=o.hasDocumentsPermission,t.hasAdminRights=o.hasAdminRights,t.hasFieldFullPermission=g.hasFieldFullPermission,t.hasFieldReadOnlyPermission=g.hasFieldReadOnlyPermission,t.hasSectionFullPermission=g.hasSectionFullPermission,t.hasSectionDisplayPermission=g.hasSectionDisplayPermission,t.hasSectionReadOnlyPermission=g.hasSectionReadOnlyPermission,t.lookupUserAndGroup=o.lookupUserAndGroup,t.lookupUser=o.lookupUser,t.loading=!0,t.image={},t.document={},t.hasProcessEditPermission=!1,t.userAdded=!1,t.isActive={},t.tab="general",t.isAdmin=e.user.profile.has_admin_rights,t.googleMapsApiKey=googleMapsApiKey,t.relationsGridOptions=[],t.showHelp=!1,t.buttonsParametersData={},t.tenantLanguage=tenantLanguage,e.expressionLookupModuleId=[],e.hideFieldValue={},t.profileInfo={},t.generalTabLoading=!0,e.globalLoading=!0;const O=t.locale||t.language;t.goUrl2=function(e,t){const a=window.getSelection();0===a.toString().length&&(window.location="#/app/record/"+t+"?id="+e)},t.imageDownload=function(e,t){d.download(e,t)},t.parentId&&d.scrollTo(0,0),t.backUrlAtt&&(t.tab="document"),t.module=angular.copy(e.modulus[t.type]),t.module.relations=a("filter")(t.module.relations,{detail_view_type:"!none"},!0),t.manyToManyRelation=void 0,t.module.relations&&t.parentType&&(t.manyToManyRelation=a("filter")(t.module.relations,{related_module:t.parentType,relation_type:"many_to_many",deleted:!1})[0]),t.getRelationsTabFilter=function(e){return e.deleted===!1&&"tab"===e.detail_view_type&&t.hasPermission(e.related_module,p.read)?e:void 0};const B=a("filter")(t.module.helps,function(e){return"side_modal"===e.modal_type&&"module_detail"===e.module_type},!0)[0];if(B&&(t.showHelp=!0),t.module.sections=a("filter")(t.module.sections,function(e){return e.display_detail&&!e.deleted}),e.breadcrumblist=[{title:e.getLanguageValue(t.module.languages,"label","plural"),link:"#/app/modules/"+t.module.name},{title:t.title}],t.tabconfig=t.module.detail_view_type?"flat"!==t.module.detail_view_type:"flat"!==e.detailViewType,t.module.default_tab&&(t.tab=t.module.default_tab),v.run("BeforeFormLoaded","script",t),t.currentSectionComponentsTemplate=currentSectionComponentsTemplate,!t.module)return b.warning(a("translate")("Common.NotFound")),void l.go("app.dashboard");if(!t.id&&!t.hasPermission(t.type,t.operations.write))return b.error(a("translate")("Common.Forbidden")),void l.go("app.dashboard");if(t.primaryField=t.module.primaryField,t.currentUser=g.processUser(e.user),t.currentDayMin=o.getCurrentDateMin().toISOString(),t.currentDayMax=o.getCurrentDateMax().toISOString(),t.currentHour=o.floorMinutes(new Date),t.relatedToField=a("filter")(t.module.fields,{name:"related_to"},!0)[0],t.record={},t.formType&&t.recordModal&&(t.record=t.recordModal),t.id||(t.title=a("translate")("Module.New",{title:e.getLanguageValue(t.module.languages,"label","singular")})),t.currentModuleProcess){const N=t.currentModuleProcess.profiles.split(",");for(var q=0;q<N.length;q++)N[q]===e.user.profile.id.toString()&&(t.hasProcessEditPermission=!0)}if(t.parentType)if(t.many)t.parentModule=t.parentType;else{const V=a("filter")(t.module.fields,{name:t.parentType},!0)[0];V?t.parentModule=V.lookup_type:(t.parentType=null,t.parentId=null)}t.picklistFilter=function(){return function(e){return t.componentFilter={},t.componentFilter.item=e,t.componentFilter.result=!0,v.run("PicklistFilter","Script",t),!e.hidden&&!e.inactive&&t.componentFilter.result}};const U=function(e){var o=!1;if(1===e.process_status)return!0;if(t.module.dependencies.length>0){const n=a("filter")(t.module.dependencies,{dependency_type:"freeze",deleted:!1},!0);for(var l=0;l<n.length;l++){const i=n[l],r=a("filter")(t.module.fields,{name:i.parent_field},!0);for(var d=0;d<r.length;d++){const s=r[d];if(i.values_array&&i.values_array.length>0)for(var u=0;u<i.values_array.length;u++){const c=parseInt(i.values_array[u]);!e[s.name]||c!==e[s.name]&&c!==e[s.name].id||(o=!0)}}}}return e.freeze=o?o:void 0,o};t.addNewTagItem=function(){const e=angular.element(document.getElementById(t.field.name+(t.fastRecordModal?"_m":""))).data("kendoMultiSelect");if(e&&e._prev){const o=e.dataSource,n=e._prev;var l=0;if(o._data.length>0){const i=a("orderBy")(o._data,"id");l=i[i.length-1].id+1}const r={text:n,id:l};o.add(r);const d=o.data().find(function(e){return e.text===n});d&&(t.record[t.field.name]||(t.record[t.field.name]=[]),t.record[t.field.name].push(r.id))}},t.getRecord=function(o){o&&(t.loading=o,e.globalLoading=o),g.getPicklists(t.module).then(function(n){e.processPicklistLanguages(n),t.picklistsModule=n;const i=a("filter")(t.module.fields,{name:"owner"},!0)[0],r=function(){for(var n=0;n<t.module.fields.length;n++){var l=t.module.fields[n];if(g.setDependency(l,t.module,t.record,t.picklistsModule,t),(!t.record.id&&l.default_value&&"picklist"===l.data_type||l.default_value&&"picklist"===l.data_type&&t.record[l.name]&&parseInt(l.default_value)===t.record[l.name].id)&&(t.record[l.name]=t.record[l.name]||a("filter")(t.picklistsModule[l.picklist_id],{id:l.default_value})[0],t.fieldValueChange(l)),"picklist"!==l.data_type||l.deleted||(t["customOptions"+l.picklist_id]={dataSource:new kendo.data.DataSource({transport:{read:function(e){e.success(a("filter")(t.picklistsModule[t.optionId],function(e){return t.componentFilter={},t.componentFilter.item=e,t.componentFilter.result=!0,v.run("PicklistFilter","Script",t),!e.hidden&&!e.inactive&&t.componentFilter.result},!0))}}}),dataTextField:"label",dataValueField:"id",ingoreCase:!0,filter:t.picklistsModule[l.picklist_id].length>10?"startswith":null,filtering:function(e){if(e.filter&&e.filter.value&&e.filter.value.indexOf("i")>-1){var t=e.filter.value,a=e.filter.field,o=e.filter.operator;e.preventDefault();var n=t.replace(/i/gim,"İ").toLocaleUpperCase(),l=t.toLocaleUpperCase().replace(/İ/gim,"I");this.dataSource.filter({logic:"or",filters:[{field:a,operator:o,value:t,ignoreCase:!0},{field:a,operator:o,value:n,ignoreCase:!0},{field:a,operator:o,value:l,ignoreCase:!0},{field:a,operator:o,value:l.toLocaleLowerCase(),ignoreCase:!0}]})}},autoBind:!1,optionLabel:a("translate")("Common.Select")}),"multiselect"!==l.data_type||l.deleted||(t["customOptions"+l.picklist_id]={dataSource:new kendo.data.DataSource({data:a("filter")(t.picklistsModule[l.picklist_id],function(e){return t.componentFilter={},t.componentFilter.item=e,t.componentFilter.result=!0,v.run("PicklistFilter","Script",t),!e.hidden&&!e.inactive&&t.componentFilter.result},!0)}),tagMode:t.id?t.record[l.name].length<=5?"multiple":"single":"multiple",dataTextField:"label",dataValueField:"id",filter:"contains",filtering:function(e){if(e.filter&&e.filter.value.indexOf("i")>-1){var t=e.filter.value,a=e.filter.field,o=e.filter.operator;e.preventDefault();var n=t.replace(/i/gim,"İ").toLocaleUpperCase(),l=t.toLocaleUpperCase().replace(/İ/gim,"I");this.dataSource.filter({logic:"or",filters:[{field:a,operator:o,value:t,ignoreCase:!0},{field:a,operator:o,value:n,ignoreCase:!0},{field:a,operator:o,value:l,ignoreCase:!0},{field:a,operator:o,value:l.toLocaleLowerCase(),ignoreCase:!0}]})}},valuePrimitive:!0,autoClose:!1,optionLabel:a("translate")("Common.Select"),change:function(e){const o=e.sender.element[0].name;if(o){const n=a("filter")(t.module.fields,{name:o,deleted:!1},!0)[0];n&&t.fieldValueChange(n)}const l=this.value(),i=this.options.tagMode;var r=i;r=l.length<=5?"multiple":"single",r!==i&&(this.value([]),this.setOptions({tagMode:r}),this.value(l))}}),"tag"===l.data_type&&!l.deleted){const i=new kendo.data.DataSource({transport:{read:{url:"/api/tag/get_tag/"+l.id,type:"GET",dataType:"json",beforeSend:e.beforeSend()}},requestEnd:function(e){const o=e.response;if(o&&o.length>0){const n=a("filter")(t.module.fields,{id:o[0].field_id,deleted:!1},!0)[0];if(n&&t.record[n.name])for(var l=0;l<t.record[n.name].length;l++){const i=a("filter")(o,{text:t.record[n.name][l]},!0)[0];i&&(t.record[n.name][l]=i.id)}}}});o&&i.read(),t["tagOptions"+l.id]={dataSource:i,dataTextField:"text",dataValueField:"id",valuePrimitive:!0,filter:"contains",tagMode:t.id?t.record[l.name].length<=5?"multiple":"single":"multiple",noDataTemplate:"#var value = instance.input.val();# <div>No data found. </div><div ng-show=\"showAddNewTagButton('"+l.name+'\')" style="text-transform: inherit">Do you want to add new item ?</div><md-button ng-show="showAddNewTagButton(\''+l.name+'\')" class="btn btn-secondary" ng-click="addNewTagItem()" aria-label="New Item"> <i class="fas fa-plus"></i> <span>#:value#</span></md-button></div>',change:function(e){const o=this.value(),n=this.options.tagMode;var l=n;l=o.length<=5?"multiple":"single",l!==n&&(this.value([]),this.setOptions({tagMode:l}),this.value(o));var i=e.sender.element[0].name;if(i){const r=a("filter")(t.module.fields,{name:i,deleted:!1},!0)[0];r&&t.fieldValueChange(r)}}}}if(("lookup"===l.data_type||"multiselect_lookup"===l.data_type)&&!l.deleted){const i=new kendo.data.DataSource({serverFiltering:!0,transport:{read:function(o){o.data.filter||(o.data.filter={filters:[]});var n=Object.assign({},o.data.filter.filters[0]);const l={module:t.currentLookupField.lookup_type,convert:!1,is_search:!!n.value,field_name:t.currentLookupField.name};if(!o.data.filter||o.data.filter&&0===o.data.filter.filters.length){o.data.filter={},o.data.filter.filters=[],o.data.filter.logic="and";const i=t.record[t.currentLookupField.name]?t.record[t.currentLookupField.name][t.currentLookupField.lookupModulePrimaryField.name]:"";if(z(),t.currentLookupField&&t.currentLookupField.filters.length>0)for(var r=0;r<t.currentLookupField.filters.length;r++){const n=t.currentLookupField.filters[r];o.data.filter.filters.push({field:n.filter_field,operator:n.operator,value:n.value})}var d={field:t.currentLookupField.lookupModulePrimaryField.name,operator:t.currentLookupField.lookup_search_type&&""!==t.currentLookupField.lookup_search_type?t.currentLookupField.lookup_search_type.replace("_",""):"startswith",value:t.record[t.currentLookupField.name]&&i?i:""};("number"===t.currentLookupField.lookupModulePrimaryField.data_type||"number_auto"===t.currentLookupField.lookupModulePrimaryField.data_type)&&(d.operator=""!==i?"equals":"not_empty",d.value="not_empty"===d.value?"-":d.value)}if(o.data.filter.filters.length>0){if(D(o.data.filter.filters,t.currentLookupField.lookupModulePrimaryField),o.data.filter.filters=g.fieldLookupFilters(t.currentLookupField,t.record,o.data.filter.filters,l),l.fields.push(t.currentLookupField.lookupModulePrimaryField.name),I(l.fields,t.currentLookupField.lookup_type),"number"===t.currentLookupField.lookupModulePrimaryField.data_type||"number_auto"===t.currentLookupField.lookupModulePrimaryField.data_type)o.data.filter.filters[0].operator||(o.data.filter.filters[0].operator="equals");else if(o.data.filter.filters.length>0){const s=o.data.filter.filters[0].operator;s.contains("_")&&(o.data.filter.filters[0].operator=""!==s?s.replace("_",""):"startswith")}t.lookupSearchValue=t.lookupInput?t.lookupInput._prev:""}$.ajax({url:"/api/record/find_custom",contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(l,o.data)),success:function(n){if(e.processLanguages(n.data),n.data&&t.record[t.currentLookupField.name]&&(!o.data.filter||o.data.filter.filters.length<1))if("multiselect_lookup"===t.currentLookupField.data_type)for(var l=0;l<t.record[t.currentLookupField.name].length;l++){var i=a("filter")(n.data,{id:t.record[t.currentLookupField.name][l].id},!0);(!i||i.length<1)&&n.data.push(angular.copy(t.record[t.currentLookupField.name][l]))}else if("lookup"===t.currentLookupField.data_type){var r=a("filter")(n.data,{id:t.record[t.currentLookupField.name].id},!0)[0];r||n.data.push(angular.copy(t.record[t.currentLookupField.name]))}var d=n.total||0;if(t.effectedField){if(1>d)t.record[t.effectedField]=null;else if(n.data&&t.record[t.effectedField]){var s=t.currentLookupField.lookupModulePrimaryField.name,u=t.record[t.effectedField][s];const r=a("filter")(n.data,function(e){return e[s]===u},!0)[0];r||(t.record[t.effectedField]=null)}t.effectedField=void 0}if(t.lookupValue){const r=a("filter")(n.data,{id:t.lookupValue.id},!0)[0];r||n.data.push(t.lookupValue),t.lookupValue=void 0}o.success(n)},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}});var r="single",d=!0;"multiselect_lookup"===l.data_type&&(t.currentLookupField=l,r="multiple",d=!1),t["lookupOptions"+l.id]={dataSource:i,optionLabel:a("translate")("Common.Select"),autoBind:!1,dataTextField:l.lookupModulePrimaryField.name,dataValueField:"id",tagMode:r,autoClose:d,ignoreCase:!1,noDataTemplate:"<div>"+a("translate")("Common.NoDataFound")+" </div><div ng-if=\"(field.name !== 'owner' || formType === 'null') && field.lookup_type !== 'users'\"><div style=\"text-transform: inherit\" ng-if=\"lookupSearchValue!==''\">"+a("translate")("Module.AddNewItem")+'</div><md-button ng-if="lookupSearchValue!==\'\'" class="btn btn-secondary" ng-click="fastNewRecordModal(field.lookup_type,true,lookupSearchValue,field.name)"> <i class="fas fa-plus"></i> <span>{{lookupSearchValue}}</span></md-button></div>'},t.parentType===l.name&&(t.parentTypeField=l,t.setCurrentLookupField(t.parentTypeField,"lookup"+t.parentTypeField.id),t["lookupOptions"+t.parentTypeField.id].dataSource.read())}if("rating"!==l.data_type||l.deleted||(t["ratingOption"+l.id]={max:l.max||5,precision:"half",value:t.record[l.name],change:function(e){var o=e.sender.element[0].name;if(o){const n=a("filter")(t.module.fields,{name:o,deleted:!1},!0)[0];n&&t.fieldValueChange(n)}}}),"number"!==l.data_type||l.deleted||(l=L(l),t["numberOptions"+l.id]={format:"#",decimals:0,max:l.validation.max,min:l.validation.min}),"number_decimal"===l.data_type&&!l.deleted){l=L(l);var s=t["numberDecimalOptions"+l.id]={max:l.validation.max,min:l.validation.min,decimals:l.decimal_places||kendo.cultures.current.numberFormat.currency.decimals,rounding:l.rounding?l.rounding:null,round:!!l.rounding};s.format=g.renderNumberDecimalFormat(l.decimal_places)}if("currency"===l.data_type&&!l.deleted){l=L(l);var u=t["currencyOptions"+l.id]={culture:kendo.cultures.current.name,format:"c",decimals:l.decimal_places||kendo.cultures.current.numberFormat.currency.decimals,max:l.validation.max,min:l.validation.min,rounding:l.rounding,round:!!l.rounding};u.format=g.renderCurrencyFormat(l.currency_symbol,l.decimal_places)}}};if(v.run("BeforeFormPicklistLoaded","Script",t),!t.id){if(t.loading=!1,t.generalTabLoading=!1,e.globalLoading=!1,t.record.owner=t.currentUser,t.record.owner.full_name=t.currentUser.primary_value,t.parentId){const d=a("filter")(e.modules,{name:t.parentModule},!0)[0];g.getRecord(t.parentModule,t.parentId).then(function(e){var o=a("filter")(d.fields,{primary:!0,deleted:!1},!0)[0],l=a("filter")(d.fields,{primary_lookup:!0,deleted:!1},!0)[0],i=(a("filter")(t.module.fields,{lookup_type:t.parentModule,data_type:"lookup",deleted:!1},!0)[0],{});if(i.id=e.data.id,o&&(i[o.name]=(o.auto_number_prefix?o.auto_number_prefix:"")+e.data[o.name]),l&&(i[l.name]=(l.auto_number_prefix?l.auto_number_prefix:"")+e.data[l.name]),i.primary_value=e.data[l?l.name:o.name],t.lookupValue=i,t.relatedToField)t.record.related_to=i,t.record.related_module=a("filter")(n[9e5],{value:t.parentType},!0)[0];else{t.record[t.parentType]=i;const s=a("filter")(t.module.dependencies,{dependent_field:t.parentType},!0)[0];if(s&&s.deleted!==!0){const u=a("filter")(t.module.fields,{name:s.field},!0)[0];t.record[s.field]=a("filter")(t.picklistsModule[u.picklist_id],{id:s.values[0]},!0)[0];const c=a("filter")(t.module.fields,{name:s.dependent_field},!0)[0];c.hidden=!1}r()}})}else r();return g.setDefaultValues(t.module,t.record,n),g.setDisplayDependency(t.module,t.record),v.run("FieldChange","Script",t,t.record,i),j(),void t.setProfileSharingConfigs()}if(g.getRecord(t.module.name,t.id).then(function(o){if(0===Object.keys(o.data).length)return b.error(a("translate")("Common.Forbidden")),void l.go("app.dashboard");t.getRecordData=Object.assign({},o.data);const n=g.processRecordSingle(o.data,t.module,t.picklistsModule);if("p_profiles"===t.module.name&&(t.profileInfo={name:n.name,profile_id:parseInt(n.profile_id)}),j(),t.ActionButtonsLoad(t.module.id),!t.hasPermission(t.type,t.operations.modify)&&!t.hasPermission(t.type,t.operations.modify,o.data)&&t.hasPermission(t.type,t.operations.read)&&!t.hasPermission(t.type,t.operations.read,o.data))return b.error(a("translate")("Common.Forbidden")),void l.go("app.dashboard");t.hasPermission(t.type,t.operations.modify)?t.hasPermission(t.type,t.operations.modify,o.data)||(n.freeze=!0):U(n),v.run("BeforeFormRecordLoaded","Script",t,n),g.formatRecordFieldValues(Object.assign({},o.data),t.module,t.picklistsModule),t.title=angular.isObject(n[t.primaryField.name])?n[t.primaryField.name].label:n[t.primaryField.name],e.breadcrumblist[1].title=t.title,t.recordState=Object.assign({},n);for(var d=0;d<t.module.fields.length;d++){const s=t.module.fields[d];var u=!1;if(s.encrypted&&s.encryption_authorized_users_list.length>0&&n[s.name])for(var c=0;c<s.encryption_authorized_users_list.length;c++){const m=s.encryption_authorized_users_list[c];e.user.id===parseInt(m)&&(u=!0)}s.show_lock=s.encrypted&&!u}if(t.relatedToField&&n.related_to){const p=a("filter")(e.modules,{id:n[t.relatedToField.lookup_relation].id-9e5},!0)[0],f=a("filter")(p.fields,{primary:!0},!0)[0];g.getRecord(p.name,n.related_to,!0).then(function(a){a=a.data,a.primary_value=a[f.name],n.related_to=a,t.record=n,t.recordState=Object.assign({},t.record),r(),t.module&&t.module.fields&&t.module.fields.length>0&&t.fieldValueChange(t.module.fields[0]),t.loading=!1,t.generalTabLoading=!1,e.globalLoading=!1})["catch"](function(a){404===a.status&&(n.related_to=null,t.record=n,t.recordState=Object.assign({},t.record)),t.loading=!1,t.generalTabLoading=!1,e.globalLoading=!1})}else t.record=n,r(),t.clone&&(t.currentUser.full_name=t.currentUser.primary_value,t.record.owner=t.currentUser,R()),t.loading=!1,t.generalTabLoading=!1,e.globalLoading=!1;t.record.currency&&(t.currencySymbol=t.record.currency.value||e.currencySymbol),v.run("FieldChange","Script",t,t.record,i),v.run("AfterFormRecordLoaded","Script",t),g.setDisplayDependency(t.module,n),t.setProfileSharingConfigs()})["catch"](function(){t.loading=!1,t.generalTabLoading=!1,e.globalLoading=!1}),t["export"]=function(o){if(o.total&&!(o.total<1)){var n=!1;try{n=!!new Blob}catch(l){}if(!n)return void b.messages(a("translate")("Module.ExportUnsupported"));if(o.total>3e3)return void b.messages(a("translate")("Module.ExportWarning"));const i=e.getLanguageValue(o.languages,"label","plural")+"-"+a("date")(new Date,"dd-MM-yyyy")+".xls";t.exporting=!0,g.getCSVData(t,o,t.module).then(function(e){b.success(a("translate")("Module.ExcelExportSuccess")),w.excel(e,i),t.exporting=!1})}},t.selectedRows={},t.selectedRecords={},t.isAllSelected={},t.tabRelations={},t.showTabs=!1,t.module.relations)for(var s=0;s<t.module.relations.length;s++){const u=t.module.relations[s];if(t.selectedRows[u.related_module]=[],t.selectedRecords[u.related_module]=[],t.isAllSelected[u.related_module]=!1,!u.deleted){t.toolbarRelationOptions["relation"+u.id]={resizable:!0,items:[]},"flat"===u.detail_view_type&&t.getRelatedActionButtons(u),"tab"!==u.detail_view_type||t.showGeneralTab||(t.showTabs=!0);const c=a("filter")(e.modules,{name:u.related_module},!0)[0];var m={};if("many_to_many"===u.relation_type){if(!c)continue;m={fields:["total_count()"],filters:[{field:t.module.name+"_id",operator:"equals",value:t.id,no:1}],limit:1,offset:0,many_to_many:t.module.name,many_to_many_table_name:u.many_to_many_table_name,relatedModule:"relation"+u.id}}else m={fields:["total_count()"],filters:[{field:u.relation_field,operator:"equals",value:t.id,no:1}],limit:1,offset:0,relatedModule:"relation"+u.id};"flat"===u.detail_view_type||"flat"===t.module.detail_view_type?setTimeout(function(){t.generateRelationsTable(u)},100):(t.tabRelations["relation"+u.id]=u,g.findRecords(u.related_module,m).then(function(e){F(e,t.tabRelations[e.config.data.relatedModule])}))}}v.run("AfterFormPicklistLoaded","Script",t)})},t.getRecord(),t.grid=[],t.selectRow=function(e,a,o){a.isChecked=e.target.checked,t.selectedRecords[o]=[];const n=t.grid[o].dataSource.data();for(var l=!0,i=0;i<n.length;i++)n[i].isChecked?t.selectedRecords[o].push(n[i].id||n[i][t.forManyToManyFielName]):(t.isAllSelected[o]=!1,l=!1);l&&(t.isAllSelected[o]=!0)},t.selectAll=function(e,a){const o=t.grid[a].dataSource.data();t.selectedRecords[a]=[];for(var n=0;n<o.length;n++)o[n].isChecked=e.target.checked,e.target.checked&&t.selectedRecords[a].push(o[n].id||o[n][t.forManyToManyFielName])},t.refreshGrid=function(e){t.grid[e].dataSource.read()},t.setCurrentLookupField=function(e,o){e.filters&&(e.filters=a("filter")(e.filters,{deleted:!1},!0)),t.currentLookupField=e,o&&(e.filters&&e.filters.length>0&&t["lookupOptions"+e.id]&&t["lookupOptions"+e.id].dataSource.read(),t.lookupInput=o,t.lookupSearchValue=o._prev)},t.uploader=new f({url:"storage/record_file_upload"}),t.entityIdFunc=function(){return t.recordId},t.recordDelete=function(e,n,l){const i=k.confirm().title(a("translate")("Common.AreYouSure")).targetEvent(e).ok(a("translate")("Common.Yes")).cancel(a("translate")("Common.No"));k.show(i).then(function(){g.getRecord(l,n).then(function(e){if(!o.hasPermission(t.type,p.modify,e.data))return void b.error(a("translate")("Common.Forbidden"));const i=e;t.executeCode=!1,v.run("BeforeDelete","Script",t,i),t.executeCode||g.deleteRecord(l,n).then(function(){t.refreshGrid(l),b.success(a("translate")("Module.DeleteMessage")),t.isAllSelected[l]=!1})})},function(){t.status="You decided to keep your debt."})},t.deleteSelectedsSubTable=function(e,o){const n=k.confirm().title(a("translate")("Common.AreYouSure")).targetEvent(e).ok(a("translate")("Common.Yes")).cancel(a("translate")("Common.No"));k.show(n).then(function(){g.deleteRecordBulk(o,t.selectedRecords[o]).then(function(){t.refreshGrid(o),t.selectedRecords[o]=[],t.selectedRows[o]=[],t.isAllSelected[o]=!1})},function(){t.status="You decided to keep your debt."})},t.getAddHideFieldValueForExpression=function(o){var n=Object.keys(e.hideFieldValue),l=Object.keys(o),i=a("filter")(t.module.fields,{display_detail:!1}),r=t.module.display_dependencies;if(i)for(var d=0;d<i.length;d++){const s=i[d].name,u=a("filter")(t.module.fields,{name:s})[0];angular.isUndefined(o[s])&&t.getRecordData&&"lookup"!==u.data_type&&(o[s]=t.getRecordData[s])}if(r)for(var c=0;c<r.length;c++){const m=r[c].dependent_field,p=a("filter")(t.module.fields,{name:m})[0];angular.isUndefined(o[m])&&t.getRecordData&&"lookup"!==p.data_type&&(o[m]=t.getRecordData[m])}for(var f=0;f<n.length;f++)if(-1===l.indexOf(n[f])){var g=n[f],y={},_=e.hideFieldValue[g];y[g]=_.substring(1,_.length-1),o=Object.assign(o,y)}return o},t.submit=function(o,n){function i(){for(var e=!0,o=0;o<t.module.fields.length;o++){const n=t.module.fields[o];if(m[n.name]||"date"===n.data_type||"date_time"===n.data_type||"time"===n.data_type||"picklist"===n.data_type&&"checkbox"===n.view_type&&!n.hidden)if("document"===n.data_type&&t.document[n.name]&&t.document[n.name].UniqueName&&null!=m[n.name])m[n.name]=t.document[n.name].UniqueName;else if("document"!==n.data_type||m[n.name]||n.hidden||!n.validation.required)if("lookup"===n.data_type&&"object"!=typeof m[n.name])e=!1;else if("multiselect_lookup"!==n.data_type||angular.isArray(m[n.name]))if("image"===n.data_type&&t.image[n.name]&&t.image[n.name].UniqueName&&null!=m[n.name])m[n.name]=t.image[n.name].UniqueName;else if("date"===n.data_type||"date_time"===n.data_type||"time"===n.data_type)delete m[n.name+"str"];else if("tag"===n.data_type)for(var l=0;l<m[n.name].length;l++){const i=a("filter")(t["tagOptions"+n.id].dataSource._view,{id:parseInt(m[n.name][l])},!0)[0];i&&(m[n.name][l]=i.text)}else m[n.name]||"picklist"!==n.data_type||"checkbox"!==n.view_type||n.hidden||!n.validation.required||(e=!1);else e=!1;else e=!1}return e}function r(){var e=g.setExpression(t.module,t.record,t.picklistsModule,null,!0,!0);return e}function s(o){t.addedUser=!1,t.recordId=o.id,t.uploader.queue.length>0&&(t.uploader.onCompleteAll(),t.uploader.uploadAll()),v.run("BeforeFormSubmitResult","Script",t,o),t.success=function(){const n=o[t.module.primaryField.name]||t.title;b.success(!t.id||t.clone?n+" "+a("translate")("Module.SuccessfullyAdded"):n+" "+a("translate")("Module.SuccessfullyUpdated"));const i={type:t.type,id:o.id};t.parentId&&(i.type=t.parentModule,i.id=t.parentId,i.rptype=t.returnTab,t.previousParentType&&(i.rpptype=t.previousParentType,i.rppid=t.previousParentId,i.rprtab=t.previousReturnTab)),t.back&&(i.back=t.back);var r=t.module.name+"_"+t.module.name;if(t.parentId){r=(t.relatedToField?"related_to":t.parentType)+t.parentId+"_"+(t.many?t.many:t.module.name);const d=t.parentType+"_"+t.parentType;u.remove(r),u.remove(d)}else u.remove(r);e.activePages&&e.activePages[t.module.name]&&(e.activePages[t.module.name]=null),t.fastRecordModal?(k.hide(),g.getRecord(t.type,t.recordId).then(function(e){var a=e.data,o=t.lookupName;if(t.modalCustomScopeRecord[o]=a,t.fastRecordModal){var n=angular.element(document.getElementById(o+(t.fastRecordModal?"_m":""))).data("kendoDropDownList");n&&n.value(a.id)}})):t.parentModule&&t.parentId?l.go("app.record",{type:t.parentModule,id:t.parentId,rtab:t.returnTab}):l.go("app.record",{type:t.module.name,id:t.recordId})},t.success()}function c(o,n){if(t.addedUser=!1,409===n){const l=o.field2?a("filter")(t.module.fields,{name:o.field2,deleted:!1})[0]:a("filter")(t.module.fields,{name:o.field,deleted:!1})[0];var i=l.name,r="";if("picklist"===l.data_type)r=t.record[i].label;else if("multiselect"===l.data_type){for(var d=[],s=0;s<t.record[i].length;s++){var u=t.record[o.field][s];const c=a("filter")(t["customOptions"+l.picklist_id].dataSource._pristineData,{id:u},!0)[0];c&&d.push(c.label)}r=d.join(",")}else if("tag"===l.data_type)r=t.record[i].join(",");else if("lookup"===l.data_type){var m=t.record[i];r=m[l.lookupModulePrimaryField.name]}else r=t.record[i];b.warning(a("translate")("Common.Conflict",{fieldName:e.getLanguageValue(l.languages,"label"),value:r}))}}var m=Object.assign({},o);if(m=t.getAddHideFieldValueForExpression(m),t.submitting=!0,!t.moduleForm.validate()||!i())return n.preventDefault(),t.submitting=!1,void b.error(a("translate")("Module.RequiredError"));var p=r();if(void 0!==p)return t.submitting=!1,n.preventDefault(),void b.error(p);if("p_profiles"===t.module.name&&t.profileConfig&&(t.profileConfig.config||t.generateAllProfileConfig(),angular.forEach(t.menuItems,function(o){if(o.module_id){var n=a("filter")(e.modules,{id:o.module_id},!0)[0];
n&&"users"!==n.name&&"profiles"!==n.name&&"roles"!==n.name&&(t.profileConfig.config[n.name]?(t.profileConfig.config[n.name].actions.read&&t.profileConfig.config[n.name].actions.read.enable||(!t.profileConfig.config[n.name].actions.read&&t.profileConfig.config[n.name].actions.create.enable?(t.profileConfig.config[n.name].actions.read={},t.profileConfig.config[n.name].actions.read.enable=!0,t.profileConfig.config[n.name].actions.read.filters=[]):(t.profileConfig.config[n.name].fields||(t.profileConfig.config[n.name].fields={}),t.profileConfig.config[n.name].fields.dont_show=[],t.profileConfig.config[n.name].fields.readonly=[],t.profileConfig.config[n.name].sections||(t.profileConfig.config[n.name].sections={}),t.profileConfig.config[n.name].sections.dont_show=[],t.profileConfig.config[n.name].sections.readonly=[],t.profileConfig.config[n.name].records||(t.profileConfig.config[n.name].records={}),t.profileConfig.config[n.name].records.type="organization",t.profileConfig.config[n.name].records.filters=[],t.profileConfig.config[n.name].actions.read||(t.profileConfig.config[n.name].actions.read={},t.profileConfig.config[n.name].actions.read.enable=!1,t.profileConfig.config[n.name].actions.read.filters=[]),t.profileConfig.config[n.name].actions.create?t.profileConfig.config[n.name].actions.create.enable=!1:(t.profileConfig.config[n.name].actions.create={},t.profileConfig.config[n.name].actions.create.enable=!1,t.profileConfig.config[n.name].actions.create.filters=[]),t.profileConfig.config[n.name].actions["delete"]?t.profileConfig.config[n.name].actions["delete"].enable=!1:(t.profileConfig.config[n.name].actions["delete"]={},t.profileConfig.config[n.name].actions["delete"].enable=!1,t.profileConfig.config[n.name].actions["delete"].filters=[]),t.profileConfig.config[n.name].actions.update?t.profileConfig.config[n.name].actions.update.enable=!1:(t.profileConfig.config[n.name].actions.update={},t.profileConfig.config[n.name].actions.update.enable=!1,t.profileConfig.config[n.name].actions.update.filters=[]))),t.profileConfig.config[n.name].enable_filter||(t.profileConfig.config[n.name].enable_filter=!1,t.profileConfig.config[n.name].filters=null)):t.profileConfig.config[n.name]=t.getProfileDefaultModel(n.name))}}),m.configs=JSON.stringify(t.profileConfig)),v.run("BeforeFormSubmit","Script",t,m),!t.id||t.clone){if(t.executeCode=!1,v.run("BeforeCreate","Script",t,m),t.executeCode)return void(t.submitting=!1)}else if(t.executeCode=!1,v.run("BeforeUpdate","Script",t,m),t.executeCode)return void(t.submitting=!1);if(t.clone&&(delete t.record.created_at,delete t.record.created_by,delete t.record.updated_at,delete t.record.updated_by,R(!0,m),t.recordState=null),m=g.prepareRecord(m,t.module,t.recordState),"p_profiles"===t.module.name&&(m.configs=JSON.stringify(t.profileConfig)),t.id){for(var f=0;f<t.module.fields.length;f++){var y=t.module.fields[f],_=!1;if(y.encrypted&&y.encryption_authorized_users_list.length>0&&m[y.name])for(var h=0;h<y.encryption_authorized_users_list.length;h++){const w=y.encryption_authorized_users_list[h];e.user.id===parseInt(w)&&(_=!0)}y.encrypted&&!_&&delete m[y.name]}t.clone?(t.revise&&(m.master_id=m.id),delete m.id,delete m.process_id,delete m.process_status,delete m.process_status_order,delete m.process_request_updated_at,delete m.process_request_updated_by,delete m.operation_type,delete m.freeze,m.auto_id&&(m.auto_id=""),g.insertRecord(t.module.name,m).then(function(e){m.master_id||(t.submitting=!1,s(e.data)),m.id=e.data.id,t.clone&&(t.clone=void 0,d.location.href="#/app/record/"+t.type+"?id="+m.id),v.run("AfterCreate","Script",t,m)})["catch"](function(e){c(e.data,e.status),t.submitting=!1})):g.updateRecord(t.module.name,m).then(function(e){t.recordState=Object.assign({},t.record),P(e.data),s(e.data),v.run("AfterUpdate","Script",t,m)})["catch"](function(e){c(e.data,e.status)})["finally"](function(){t.submitting=!1}),t.generalTabLoading=!1}else g.insertRecord(t.module.name,m).then(function(e){if(t.manyToManyRelation){const a=T(e.data.id),o=t.manyToManyRelation.many_to_many_table_name.indexOf(t.type),n=t.manyToManyRelation.many_to_many_table_name.indexOf(t.manyToManyRelation.related_module);var l="",i="";n>o?(l=t.type,i=t.manyToManyRelation.related_module):(l=t.manyToManyRelation.related_module,i=t.type),g.addRelations(l,i,a)}s(e.data),m.id=e.data.id,v.run("AfterCreate","Script",t,m)})["catch"](function(e){c(e.data,e.status)})["finally"](function(){t.submitting=!1})},t.calculate=function(e){g.calculate(e,t.module,t.record)},t.setReadonly=function(e){return profileConfigs.config[t.module.name]?profileConfigs.config[t.module.name].fields&&profileConfigs.config[t.module.name].fields.readonly&&profileConfigs.config[t.module.name].fields.readonly.includes(e.name)?!0:profileConfigs.config[t.module.name].sections&&profileConfigs.config[t.module.name].sections.readonly&&profileConfigs.config[t.module.name].sections.readonly.includes(e.section)?!0:!1:void 0},t.fieldValueChange=function(o){if(t.effectedField=void 0,o.valueChangeDontRun)return void delete o.valueChangeDontRun;g.setDependency(o,t.module,t.record,t.picklistsModule,t),t.loading||g.setDisplayDependency(t.module,t.record);var n=g.setExpression(t.module,t.record,t.picklistsModule,o,!1,!1);if(void 0!==n&&b.error(n),v.run("FieldChange","Script",t,t.record,o),t.record.currency&&(t.currencySymbol=t.record.currency.value||e.currencySymbol),"picklist"===o.data_type){const l=a("filter")(t.module.dependencies,function(e){return e.parent_field===o.name&&("list_field"===e.dependency_type||"list_value"===e.dependency_type)},!0);if(!l||!l.length)return;for(var i=0;i<l.length;i++){var r=l[i];if(!r.deleted){const d=a("filter")(t.module.fields,{name:r.child_field},!0)[0];t.optionId&&t["customOptions"+t.optionId].dataSource.read(),t.optionId=d.picklist_id,t["customOptions"+t.optionId].dataSource.read()}}}if("lookup"===o.data_type){const s=a("filter")(t.module.fields,function(e){return"lookup"===e.data_type&&!e.deleted&&"updated_by"!==e.name&&"created_by"!==e.name&&"owner"!==e.name},!0);if(s)for(var u=0;u<s.length;u++){const c=s[u];for(var m=0;m<c.filters.length;m++){const p=c.filters[m];if(p.filter_field.contains(".")){const f=p.filter_field.split(".");if(f[0]===o.name&&t.record[c.name]){const y=angular.element(document.getElementById(c.name+(t.fastRecordModal?"_m":""))).data("kendoDropDownList");y&&(t.currentLookupField=c,t.effectedField=c.name,y.dataSource.read())}}}}}},t.hideCreateNew=function(e){return"users"===e.lookup_type?!0:"relation"===e.lookup_type&&!t.record.related_module},t.openFormModal=function(e){t.primaryValueModal=e;const a=angular.element(document.body);k.show({parent:a,templateUrl:"view/app/module/moduleFormModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})},t.ActionButtonsLoad=function(){g.getActionButtons(t.module.id).then(function(a){t.actionButtons=a,t.toolbarOptions={resizable:!0,items:[]},e.processLanguages(a);for(var o=0;a.length>o;o++)if(W(a[o]),"List"!==a[o].trigger&&"Relation"!==a[o].trigger){const n=e.getLanguageValue(a[o].languages,"label");if("Scripting"===a[o].type&&g.hasActionButtonDisplayPermission(a[o],!1,t.record,t.module)){var l={template:'<md-button ng-show="actionButtons['+o+'].isShown" class="btn '+a[o].color+'"  ng-click="runScript('+o+')" aria-label="'+n+'" > <i class="'+a[o].icon+'"></i> <span>'+n+"</span></md-button>",overflowTemplate:'<md-button ng-show="actionButtons['+o+'].isShown" ng-click="runScript('+o+')"  class="action-dropdown-item"><i class="'+a[o].icon+'"></i><span> '+n+"</span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(l)}if("Webhook"===a[o].type&&g.hasActionButtonDisplayPermission(a[o],!1,t.record,t.module)){var l={template:'<md-button ng-show="actionButtons['+o+'].isShown" class="btn '+a[o].color+'"  ng-click="webhookRequest('+o+')"   aria-label="'+n+'" > <i class="'+a[o].icon+'"></i> <span>'+n+"</span></md-button>",overflowTemplate:'<md-button ng-show="actionButtons['+o+'].isShown" ng-click="webhookRequest('+o+')"  class="action-dropdown-item "><i class="'+a[o].icon+'"></i><span> '+n+" </span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(l)}if("ModalFrame"===a[o].type&&g.hasActionButtonDisplayPermission(a[o],!1,t.record,t.module)){var l={template:'<md-button ng-show="actionButtons['+o+'].isShown" class="btn '+a[o].color+'" ng-click="showModuleFrameModal(\''+a[o].url+'\')"   aria-label="'+n+'" > <i class="'+a[o].icon+'"></i> <span>'+n+"</span></md-button>",overflowTemplate:'<md-button ng-show="actionButtons['+o+'].isShown"  ng-click="showModuleFrameModal(\''+a[o].url+'\')"   class="action-dropdown-item"><i class="'+a[o].icon+'"></i><span> '+n+" </span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(l)}if("CallMicroflow"===a[o].type&&g.hasActionButtonDisplayPermission(a[o],!1,t.record,t.module)){var l={template:'<md-button ng-show="actionButtons['+o+'].isShown" class="btn '+a[o].color+'"  ng-click="runMicroflow('+a[o].microflow_id+","+o+","+!1+')" aria-label="'+n+'" > <i class="'+a[o].icon+'"></i> <span>'+n+"</span></md-button>",overflowTemplate:'<md-button ng-show="actionButtons['+o+'].isShown"   ng-click="runMicroflow('+a[o].microflow_id+","+o+","+!1+')" class="action-dropdown-item"><i class="'+a[o].icon+'"></i><span> '+n+"</span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(l)}}var i=$("#action-buttons-record-area").data("kendoToolBar");i&&(t.actionButtonsBackup=Object.assign([],t.toolbarOptions.items),i.destroy(),t.toolbarOptions.items=[],m(function(){t.toolbarOptions.items=Object.assign([],t.actionButtonsBackup)},50))})},t.showModuleFrameModal=function(e){if(new RegExp("https:").test(e)){var a,o,n;a="myPop1",o=document.body.offsetWidth-200,n=document.body.offsetHeight-200;var l=screen.width/2-o/2,i=screen.height/2-n/2;window.open(e,a,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+o+", height="+n+", top="+i+", left="+l)}else t.frameUrl=e},t.openLocationModal=function(e){t.filedName=e;const a=angular.element(document.body);k.show({parent:a,controller:"locationFormModalController",templateUrl:"view/app/location/locationFormModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})},t.removeDocument=function(a){var n={};n.module=t.module.name,n.recordId=t.record.id,n.fieldName=a.name,n.fileNameExt=o.getFileExtension(t.record[a.name]),n.instanceId=e.workgroup.tenant_id,t.record[a.name]=null,"document"===a.data_type&&(t.uploaderBasic[a.name].queue=[]),"image"===a.data_type&&(t.croppedImage=t.croppedImage||{},t.croppedImage[a.id]=void 0),angular.element("input[type='file']").val(null)},t.fileLoadingCounter=0,t.uploaderBasic=function(n){t.isFinishUpload=!1,t.document[n.name]={};const l={};e.preview?l["X-App-Id"]=e.user.app_id:l["X-Tenant-Id"]=e.user.tenant_id;const i=t.uploaderBasic[n.name]=new f({url:"storage/record_file_upload",headers:l,queueLimit:1});return i.onAfterAddingFile=function(e){t.fileLoadingCounter++,t.record[n.name]=e.uploader.queue[0].file.name,t.document[n.name].Name=e.uploader.queue[0].file.name,t.document[n.name].Size=e.uploader.queue[0].file.size,t.document[n.name].Type=e.uploader.queue[0].file.type,e.upload()},i.onWhenAddingFileFailed=function(e,t){switch(t.name){case"docFilter":b.warning(a("translate")("Setup.Settings.DocumentTypeError"));break;case"sizeFilter":b.warning(a("translate")("Setup.Settings.SizeError"))}},i.filters.push({name:"docFilter",fn:function(e){const t=o.getFileExtension(e.name);return"txt"===t||"docx"===t||"pdf"===t||"doc"===t||"xlsx"===t||"xls"===t}}),i.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}}),i.onSuccessItem=function(e,a){t.document[n.name].UniqueName=a.unique_name,t.fileLoadingCounter--},i.onErrorItem=function(e,a){t.document[n.name].UniqueName=a.unique_name,t.fileLoadingCounter--},t.isFinishUpload=!0,i},t.getFileDownload=function(e,t){d.location.href=void 0===t?"storage/record_file_download?fileName="+e:"storage/record_file_download?fileName="+t},t.uploaderImage=function(n){function l(e){const t=r.defer(),a=new FileReader;return a.onload=function(e){t.resolve(e.target.result)},a.readAsDataURL(e),t.promise}t.image[n.name]={};const i={Authorization:"Bearer "+s.read("access_token"),Accept:"application/json"};e.preview?i["X-App-Id"]=e.user.app_id:i["X-Tenant-Id"]=e.user.tenant_id;const d=t.uploaderImage[n.name]=new f({url:"storage/record_file_upload",headers:i,queueLimit:1});d.onAfterAddingFile=function(e){l(e._file).then(function(a){t.copyImg=a,e.image=a,h.resizeImage(e.image,{width:1024},function(a,l){if(!a){e._file=u(l),e.file.size=e._file.size,t.fileLoadingCounter++,t.record[n.name]=e.uploader.queue[0].file.name,t.image[n.name].Name=e.uploader.queue[0].file.name,t.image[n.name].Size=e.uploader.queue[0].file.size,t.image[n.name].Type=e.uploader.queue[0].file.type;const i=e.uploader.queue[0].file.name.split(".");e.uploader.queue[0].file.name=o.getSlug(i[0])+"."+i[1],e.upload()}})})},d.onWhenAddingFileFailed=function(e,t){switch(t.name){case"imgFilter":b.warning(a("translate")("Setup.Settings.ImageError"));break;case"sizeFilter":b.warning(a("translate")("Setup.Settings.SizeError"))}},d.filters.push({name:"imgFilter",fn:function(e){const t=o.getFileExtension(e.name);return"jpg"===t||"jpeg"===t||"png"===t||"doc"===t||"gif"===t}}),d.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}}),d.onSuccessItem=function(e,a){t.croppedImage=t.croppedImage||{},t.croppedImage[n.id]=t.copyImg,t.image[n.name].UniqueName=a.public_url,t.fileLoadingCounter--};const u=function(e){const t=atob(e.split(",")[1]),a=e.split(",")[0].split(":")[1].split(";")[0],o=[];for(var n=0;n<t.length;n++)o.push(t.charCodeAt(n));return new Blob([new Uint8Array(o)],{type:a})};return d},t.webhookRequest=function(o,n){const l=n?t.relationActionButtons[o]:t.actionButtons[o];if(!l)return void b.warning(a("translate")("Module.ActionButtonWebhookFail"));const i={},r=[],d=l.parameters.split(","),s=l.headers.split(",");t.webhookRequesting={},t.webhookRequesting[l.id]=!0;for(var u=0;u<d.length;u++){const c=d[u],m=c.split("|"),p=m[0],f=m[1],g=m[2];i[p]=f!==t.module.name?t.record[f]?t.record[f][g]:null:t.record[g]?t.record[g]:null}for(var u=0;u<s.length;u++){const c=s[u],y=c.split("|"),h=y[0],f=y[1],v=y[2],k=y[3];switch(h){case"module":const g=k;r[v]=f!==t.module.name?t.record[f]?t.record[f][g]:null:t.record[g]?t.record[g]:null;break;case"static":switch(k){case"{:app:}":r[v]=e.user.app_id;break;case"{:tenant:}":r[v]=e.user.tenant_id;break;case"{:user:}":r[v]=e.user.id;break;default:r[v]=null}break;case"custom":r[v]=k;break;default:r[v]=null}}if("post"===l.method_type)_.post(l.url,i,{headers:r}).then(function(){b.success(a("translate")("Module.ActionButtonWebhookSuccess")),t.webhookRequesting[l.id]=!1})["catch"](function(){b.warning(a("translate")("Module.ActionButtonWebhookSuccess")),t.webhookRequesting[l.id]=!1});else if("get"===l.method_type){var w="";for(var v in i)w+=v+"="+i[v]+"&";w.length>0&&(w=w.substring(0,w.length-1)),_.get(l.url+"?"+w).then(function(){b.success(a("translate")("Module.ActionButtonWebhookSuccess")),t.webhookRequesting[l.id]=!1})["catch"](function(){b.warning(a("translate")("Module.ActionButtonWebhookFail")),t.webhookRequesting[l.id]=!1})}},t.getAttachments=function(){o.hasDocumentsPermission(t.operations.read)&&y.getEntityDocuments(e.workgroup.tenant_id,t.id,t.module.id).then(function(a){e.processLanguages(a.data.documents),t.documentsResultSet=y.processDocuments(a.data,e.users),t.documents=t.documentsResultSet.documentList,t.loadingDocuments=!1})},v.run("AfterFormLoaded","script",t),t.changeTab=function(e){t.generalTabLoading="general"!==e,t.isActive=[],t.isActive[e.id]=!0,e.id&&!t.relationsGridOptions[e.id]&&(t.getRelatedActionButtons(e),t.generateRelationsTable(e))},t.findRequest=[],t.generateRelationsTable=function(o){const n=[];var l={},i="dataItem.id";"many_to_many"===o.relation_type?(t.forManyToManyFielName=t.module.name!==o.related_module?o.related_module+"_id":o.related_module+"1_id",i="dataItem['"+t.forManyToManyFielName+"']",l={module:o.related_module,convert:!0,filters:[{field:t.module.name!==o.related_module?t.module.name+"_id":t.module.name+"1_id",operator:"equals",value:t.id,no:1}],many_to_many:t.module.name,many_to_many_table_name:o.many_to_many_table_name}):l="related_to"===o.relation_type?{module:o.related_module,convert:!0,filters:[{field:"related_to",operator:"equals",value:e.getLanguageValue(t.module.languages,"label","singular"),no:1}],many_to_many:t.module.name,many_to_many_table_name:o.many_to_many_table_name}:{module:o.related_module,convert:!0,filters:[{field:o.relation_field,operator:"equals",value:t.id,no:1}]};for(var r=0;r<o.display_fields.length;r++){const d=o.display_fields[r];var s=void 0;if(d.indexOf(".")>-1){const u=d.split(".");var c={};switch(u[1]){case"users":c=M.getUserModule();break;case"profiles":c=M.getProfileModule();break;case"roles":c=M.getRoleModule();break;default:c=t.modulus[u[1]]}s=Object.assign({},a("filter")(c.fields,{name:u[2]},!0)[0]);var m=a("filter")(t.modulus[o.related_module].fields,{name:u[0]},!0)[0];s.labelExt="("+e.getLanguageValue(m.languages,"label")+")",s.label=s.label||e.getLanguageValue(s.languages,"label"),s.name=d}else s=Object.assign({},a("filter")(t.modulus[o.related_module].fields,{name:d},!0)[0]);s&&g.hasFieldDisplayPermission(s)&&s.display_detail&&n.push(s)}const p=g.generatRowtmpl(n,!0,{module:t.module,relatedModule:o});l.fields=p.requestFields,t.findRequest[o.id]=l,t.relatedModule=o,t.relationsGridOptions[o.id]={dataSource:{serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:function(a){$.ajax({url:"/api/record/find_custom?locale="+O,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(t.findRequest[o.id],a.data)),success:function(e){a.success(e),o.total=e.total||0,v.run("SubListLoaded","Script",t,t.record,void 0,o.related_module)},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}},rowTemplate:'<tr ng-click="goUrl2('+i+",'"+o.related_module+"')\">"+p.rowtempl+"</tr>",altRowTemplate:'<tr class="k-alt" ng-click="goUrl2('+i+",'"+o.related_module+"')\">"+p.rowtempl+"</tr>",sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100,500],buttonCount:5,info:!0},columns:p.columns}},t.copyHref=function(){d.location.href="#/app/record/"+t.type+"?clone=true&id="+t.record.id+(t.parentId?"&ptype="+t.parentType+"&pid="+t.parentId:"")},t["delete"]=function(){t.executeCode=!1,v.run("BeforeDelete","Script",t,t.record),t.executeCode||g.deleteRecord(t.module.name,t.record.id).then(function(){return b.success(a("translate")("Module.SuccessDeleteRecordMessage")),v.run("AfterDelete","Script",t,t.record),E(),t.parentId?void l.go("app.moduleDetail",{type:t.parentModule,id:t.parentId}):void l.go("app.moduleList",{type:t.type})})},t.showConfirm=function(e){const o=k.confirm().title(a("translate")("Common.AreYouSure")).targetEvent(e).ok(a("translate")("Common.Yes")).cancel(a("translate")("Common.No"));k.show(o).then(function(){t["delete"]()},function(){})};const E=function(){var a=t.module.name+"_"+t.module.name;if(t.parentId){a=(t.relatedToField?"related_to":t.parentType)+t.parentId+"_"+t.module.name;const o=t.parentType+"_"+t.parentType;u.remove(a),u.remove(o)}else u.remove(a),"opportunities"===t.module.name&&u.remove("opportunity"+t.id+"_stage_history");e.activePages&&e.activePages[t.module.name]&&(e.activePages[t.module.name]=null)};t.openExportDialog=function(){t.pdfCreating=!0,t.loadingModal=!0;var e=function(){const e=angular.element(document.body);k.show({parent:e,templateUrl:"view/app/module/modulePdfModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})};t.quoteTemplates?(t.quoteTemplate=t.quoteTemplates[0],t.loadingModal=!1,e()):g.getTemplates(t.module.name,"module").then(function(o){if(0===o.data.length)b.warning(a("translate")("Setup.Templates.TemplateNotFound")),t.pdfCreating=!1;else{const n=o.data;t.quoteTemplates=a("filter")(n,{active:!0},!0),t.quoteTemplatesOptions={dataSource:t.quoteTemplates,dataTextField:"name",dataValueField:"id"},t.quoteTemplate=t.quoteTemplates[0],t.loadingModal=!1,e()}})["catch"](function(){t.loadingModal=!1,t.pdfCreating=!1})},t.showSingleSMSModal=function(){if(!e.system.messaging.SMS)return void b.warning(a("translate")("SMS.NoProvider"));const o=angular.element(document.body);k.show({parent:o,templateUrl:"view/app/sms/singleSMSModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})},t.showQuoteEMailModal=function(){if(!e.system.messaging.SystemEMail&&!e.system.messaging.PersonalEMail)return void b.warning(a("translate")("EMail.NoProvider"));const o=angular.element(document.body);k.show({parent:o,templateUrl:"view/app/email/singleEmailModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})},t.getDownloadUrl=function(o){t.isDownLoad=!0,d.open("/attach/export?module="+t.type+"&id="+t.id+"&templateId="+t.quoteTemplate.id+"&format="+o+"&locale="+e.locale+"&timezoneOffset="+-1*(new Date).getTimezoneOffset(),"_blank"),b.success(a("translate")("Module.DownloadPdfWordMessage",{value:"pdf"===o?"Pdf":"Word"})),t.isDownLoad=!1},t.close=function(){k.hide()},t.setId=function(e,a,o){t.field=e,o||(t.optionId=a?e.picklist_id:e.id)},t.setDateManualDisable=function(e){t.record[e]=null},t.setDateManualDisable=function(e){t.record[e]=null},t.openCalendar=function(e){var a=void 0;switch(e.data_type){case"date":a="kendoDatePicker";break;case"date_time":a="kendoDateTimePicker";break;case"time":a="kendoTimePicker"}if(a){const o=angular.element(document.getElementById(e.name+(t.fastRecordModal?"_m":""))).data(a);if(o){var n=e.validation.readonly===!0;o.readonly(n||this.setReadonly(e)),n&&this.setReadonly(e)||o.open()}}},t.documentDownload=function(e){d.location="storage/record_file_download?fileName="+e};const z=function(){if("users"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){const o={};o.data_type="text_single",o.name="full_name",t.currentLookupField.lookupModulePrimaryField=o}if("profiles"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){const o={};o.data_type="text_single",o.name="name",t.currentLookupField.lookupModulePrimaryField=o}if("roles"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){const o={};o.data_type="text_single",o.name="label_"+e.user.tenantLanguage,t.currentLookupField.lookupModulePrimaryField=o}if("relation"===t.currentLookupField.lookup_type){if(!t.record.related_module)return r.defer().promise;const n=a("filter")(e.modules,{name:t.record.related_module.value},!0)[0];if(!n)return r.defer().promise;t.currentLookupField.lookupModulePrimaryField=a("filter")(n.fields,{primary:!0},!0)[0]}v.run("BeforeLookup","Script",t)};t.closeLightBox=function(){k.hide()},t.showLightBox=function(o,n,l,i,r){if(n){t.showImageData={},t.multiSelectAndTagDatas={};const d=r?e.modulus[r.related_module]:t.module;var s=i?a("filter")(d.fields,{name:i,deleted:!1})[0]:t.primaryField.name;l?t.showImageData={url:o.target.src,title:n[s]||e.getLanguageValue(s.languages,"label"),type:i?"location":"image",map_url:"http://www.google.com/maps/place/"+n[s.name]}:n[i]&&(s=a("filter")(d.fields,{name:i,deleted:!1})[0],t.multiSelectAndTagDatas={array:n[i].split(";"),title:n[s]||e.getLanguageValue(s.languages,"label")}),k.show({contentElement:"#mdLightbox",parent:angular.element(document.body),targetEvent:o,clickOutsideToClose:!0,fullscreen:!1})}},t.formType=null,t.fastNewRecordModal=function(a,o,n,l,i){t.lookupInput.close(),e.fastRecordAddModal(a,o,n,l,i,t)};const j=function(){for(var e=0;2>e;e++){var o=["shared_read","shared_edit"];t["lookupOptions_"+o[e]]={dataSource:new kendo.data.DataSource({transport:{read:function(e){e.success(t.record[t.field]?t.record[t.field]:[])}}}),dataTextField:"name",dataValueField:"id",autoBind:!1,filtering:function(e){e.filter&&t.lookupUserAndGroup(t.module.id,!1,e.filter.value).then(function(e){if(e&&e.length>0){const o=t["lookupOptions_"+t.field].dataSource;o._data=[];for(var n=0;n<e.length;n++){const l=o._data.length>0?a("filter")(o._data,{id:e[n].id},!0)[0]:!1;l||o.add(e[n])}}})}}}};t.goToRecord=function(e,t,a,o){g.goToRecord(e,t,a,o)},t.getTagAndMultiDatas=function(e,t){return t?g.getTagAndMultiDatas(e,t):void 0},t.getImageStyle=function(e,t){return e&&t?g.getImageStyle(e,t.related_module):void 0},t.getRatingCount=function(e,t){return e&&t?g.getRatingCount(e,t.related_module):void 0},t.getLocationUrl=function(e){return e?g.getLocationUrl(e):void 0},t.deleteRelation=function(e,o,n,l){const i=k.confirm().title(a("translate")("Common.AreYouSure")).targetEvent(e).ok(a("translate")("Common.Yes")).cancel(a("translate")("Common.No"));k.show(i).then(function(){const e=C(o.related_module,n,l);var i=void 0;e&&e.length>0&&(i=o.many_to_many_table_name?{records:e,tableName:o.many_to_many_table_name}:e,g.deleteRelation(t.module.name,o.related_module,i).then(function(){b.success(a("translate")("Module.DeleteMessage")),t.grid[o.related_module].dataSource.read(),o.total=o.total-e.length}))},function(){})},t.toolbarRelationOptions=[],t.getRelatedActionButtons=function(o){t.relationActionButtons=[],e.modulus[o.related_module]&&g.getActionButtons(e.modulus[o.related_module].id).then(function(n){if(n.length>0){var l=a("filter")(n,function(e){return"Detail"!==e.trigger&&"Form"!==e.trigger&&"List"!==e.trigger},!0);if(e.processLanguages(l),t.relationActionButtons["relation"+o.id]=l,l)for(var i=0;i<l.length;i++){var r=l[i];r.module_name=o.related_module,W(r);const d=e.getLanguageValue(r.languages,"label");if("Scripting"===l[i].type&&g.hasActionButtonDisplayPermission(l[i],!1,t.record,t.module)){var s="relation"+o.id,u={template:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown" class="btn '+l[i].color+'"  ng-click="runScript('+i+",'"+s+'\')" aria-label="'+d+'" > <i class="'+l[i].icon+'"></i> <span>'+d+"</span></md-button>",overflowTemplate:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown"  ng-click="runScript('+i+",'"+s+'\')"  class="action-dropdown-item"><i class="'+l[i].icon+'"></i><span> '+d+"</span></md-button>",overflow:"auto"};t.toolbarRelationOptions[s].items.push(u)}if("Webhook"===l[i].type&&g.hasActionButtonDisplayPermission(l[i],!1,t.record,t.module)){var u={template:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown" class="btn '+l[i].color+'"  ng-click="webhookRequest('+i+', true)"   aria-label="'+d+'" > <i class="'+l[i].icon+'"></i> <span>'+d+"</span></md-button>",overflowTemplate:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown" ng-click="webhookRequest('+i+')"  class="action-dropdown-item "><i class="'+l[i].icon+'"></i><span> '+d+" </span></md-button>",overflow:"auto"};t.toolbarRelationOptions["relation"+o.id].items.push(u)}if("ModalFrame"===l[i].type&&g.hasActionButtonDisplayPermission(l[i],!1,t.record,t.module)){var u={template:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown" class="btn '+l[i].color+'"  ng-click="showModuleFrameModal(\''+l[i].url+'\')"   aria-label="'+d+'" > <i class="'+l[i].icon+'"></i> <span>'+d+"</span></md-button>",overflowTemplate:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown"  ng-click="showModuleFrameModal(\''+l[i].url+'\')"   class="action-dropdown-item"><i class="'+l[i].icon+'"></i><span> '+d+" </span></md-button>",overflow:"auto"};t.toolbarRelationOptions["relation"+o.id].items.push(u)}if("CallMicroflow"===l[i].type&&g.hasActionButtonDisplayPermission(l[i],!1,t.record,t.module)){var u={template:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown" class="btn '+l[i].color+'"  ng-click="runMicroflow('+l[i].microflow_id+","+i+","+!0+')"   aria-label="'+d+'" > <i class="'+l[i].icon+'"></i> <span>'+d+"</span></md-button>",overflowTemplate:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown"  ng-click="runMicroflow('+l[i].microflow_id+","+i+","+!0+')"  class="action-dropdown-item"><i class="'+l[i].icon+'"></i><span> '+d+"</span></md-button>",overflow:"auto"};t.toolbarRelationOptions["relation"+o.id].items.push(u)}}}})},t.runMicroflow=function(a,o,n){var l=null;if(l=n?t.relationActionButtons[o]:t.actionButtons[o],t.actionButtonsData={data:{module_id:t.module.id},workflow_id:a,button:l},l.record_name&&(t.actionButtonsData.data.record_name=l.record_name,t.actionButtonsData.data.record_ids=[parseInt(t.id)]),t.buttonsParametersData={},l.parameters){t.showMicroflowParameters=!0,t.showScriptParameters=!1,t.buttonParameterNameTitle=e.getLanguageValue(l.languages,"label"),t.buttonsParameters=JSON.parse(l.parameters),t.picklistItems={},angular.forEach(t.buttonsParameters,function(a){(3===a.type||4===a.type)&&_.get(c.apiUrl+"picklist/get/"+a.lowerType).then(function(o){t.picklistItems[a.key]=o.data,e.processLanguage(t.picklistItems)})});var i=angular.element(document.body);k.show({parent:i,templateUrl:"view/app/module/actionButtonsParameterModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})}else g.runMicroflow(a,t.actionButtonsData.data).then(function(t){var a=e.getLanguageValue(l.languages,"message");200===t.status&&"popup"===l.message_type&&a&&b.success(a)})},t.runMicroflowParameters=function(a){a.validate()&&(t.actionButtonsData.data.parameters=t.buttonsParametersData,g.runMicroflow(t.actionButtonsData.workflow_id,t.actionButtonsData.data).then(function(a){var o=e.getLanguageValue(t.actionButtonsData.button.languages,"message");200===a.status&&"popup"===t.actionButtonsData.button.message_type&&o&&b.success(o)}),t.closeLightBox())},t.numberOptionsButtons={format:"{0:n0}",decimals:0};const G=function(){return a("filter")(t.module.fields,function(e){return e.display_detail&&g.hasFieldDisplayPermission(e)},!0)};t.displayFields=G(),t.openAddModal=function(a,o){t.currentRelateModule=o,t.manyToManyModule=t.modulus[o.related_module],t.manyToManyModule.gridName=t.manyToManyModule.name+"-manytomany",t.manyToManyModule.related_module=t.manyToManyModule.name,t.manyToManyModule.tableName=o.many_to_many_table_name,t.selectedRecords[t.manyToManyModule.gridName]=[];const n=[];n.push(t.manyToManyModule.primaryField);const l=g.generatRowtmpl(n,!0,{relatedModule:t.manyToManyModule,moduleName:t.manyToManyModule.name,tableOptinosMenuHide:!0});l.rowtempl=l.rowtempl.replaceAll(t.manyToManyModule.name,t.manyToManyModule.gridName),l.rowtempl=l.rowtempl.replaceAll('id="{{dataItem.id}}"','id="'+t.manyToManyModule.gridName+'{{dataItem.id}}"'),l.rowtempl=l.rowtempl.replaceAll('for="{{dataItem.id}}"','for="'+t.manyToManyModule.gridName+'{{dataItem.id}}"'),t.findRequest[t.relatedModule.id].grid_fields=l.requestFields;t.locale||t.language;t.manyToManyGridOptions={dataSource:{serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:function(a){$.ajax({url:"/api/record/get_relation_data",contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(t.findRequest[t.relatedModule.id],a.data)),success:function(e){a.success(e)},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}},rowTemplate:"<tr>"+l.rowtempl+"</tr>",altRowTemplate:'<tr class="k-alt">'+l.rowtempl+"</tr>",sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100,500],buttonCount:5,info:!0},columns:[{width:"60px",headerTemplate:'<input type="checkbox" id="header-chb-'+t.manyToManyModule.gridName+"'\" ng-model=\"isAllSelected['"+t.manyToManyModule.gridName+"']\" ng-click=\"selectAll($event,'"+t.manyToManyModule.gridName+'\')" id="header-chb-manytomany" class="k-checkbox header-checkbox"><label class="k-checkbox-label" for="header-chb-'+t.manyToManyModule.gridName+"'\"></label>"},{field:t.manyToManyModule.primaryField.name,media:"(min-width: 575px)",title:e.getLanguageValue(t.manyToManyModule.primaryField.languages,"label")},{title:"Items",media:"(max-width: 575px)"}]};const i=angular.element(document.body);k.show({parent:i,templateUrl:"view/app/module/moduleAddModal.html",clickOutsideToClose:!0,targetEvent:a,scope:t,preserveScope:!0}),t.isAllSelected[t.manyToManyModule.gridName]=!1
},t.addRecords=function(){const e=t.selectedRecords[t.manyToManyModule.gridName];if(!e||!e.length)return void b.warning(a("translate")("Module.NoRecordSelected"));t.recordsAdding=!0;const o=[];for(var n=0;n<e.length;n++){var l={};l[t.module.name+"_id"]=t.id,l[t.manyToManyModule.name+"_id"]=e[n],o.push(l)}const i={tableName:t.manyToManyModule.tableName,records:o};g.addRelations(t.module.name,t.manyToManyModule.name,i).then(function(){t.recordsAdding=!1,t.refreshGrid(t.manyToManyModule.name),t.closeLightBox()})},t.controlRemove=function(e,a){return e.showRemove=t.hasPermission(a?a.related_module:t.module.name,p.remove)},t.controlCopy=function(e,a){return e.showCopy=t.hasPermission(a?a.related_module:t.module.name,p.write)},t.controlEdit=function(e,a){return e.showEdit=t.hasPermission(a?a.related_module:t.module.name,p.modify)},angular.element(document).ready(function(){t.fileNotSelected=!1,t.moduleForm.options.rules.range=g.rangeRuleForForms(),m(function(){},500)}),t.showAddNewTagButton=function(e){if(e){const a=angular.element(document.getElementById(e+(t.fastRecordModal?"_m":""))).data("kendoMultiSelect");if(a)return""!==a._prev}return!1},t.runScript=function(a,o){var n=null;if(n=o?t.relationActionButtons[o][a]:t.actionButtons[a],t.buttonsParametersData={},t.actionButtonsData={data:{record_ids:[parseInt(t.id)],module_id:t.module.id,record_name:n.record_name},button:n},n.parameters&&"CallMicroflow"===n.type){t.showMicroflowParameters=!1,t.showScriptParameters=!0,t.buttonParameterNameTitle=e.getLanguageValue(n.languages,"label"),t.buttonsParameters=JSON.parse(n.parameters),t.picklistItems={},angular.forEach(t.buttonsParameters,function(a){(3===a.type||4===a.type)&&_.get(c.apiUrl+"picklist/get/"+a.lowerType).then(function(o){t.picklistItems[a.key]=o.data,e.processLanguage(t.picklistItems)})});var l=angular.element(document.body);k.show({parent:l,templateUrl:"view/app/module/actionButtonsParameterModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})}else{S.run(t,n.template);var i=e.getLanguageValue(n.languages,"message");"popup"===n.message_type&&i&&b.success(i)}},t.runScriptParameters=function(a){if(a.validate()){t.actionButtonsData.data.parameters=t.buttonsParametersData,S.run(t,t.actionButtonsData.button.template);var o=e.getLanguageValue(t.actionButtonsData.button.languages,"message");"popup"===t.actionButtonsData.button.message_type&&o&&b.success(o),t.closeLightBox()}};var W=function(e){e.isShown=!1,e.dependent_field?t.record[e.dependent_field]&&t.record[e.dependent_field].labelStr==e.dependent&&(e.isShown=!0):e.isShown=!0};if(t.downloadImg=function(e){if(e){const t=e.split("/"),a=t[t.length-1];_({method:"GET",url:e,responseType:"arraybuffer"}).then(function(e){if(e.data){const t=new Uint8Array(e.data),o=new Blob([t],{type:"application/octet-stream"});saveAs(o,a)}},function(){})}},t.languageOptions=g.getLanguageOptions(),t.backToText=a("translate")("Common.BackTo",{moduleName:e.getLanguageValue(t.module.languages,"label","plural")}),!t.module.fakeSection){var X=Object.assign({},t.module.sections[0]);X.id=-1,X.type="component",X.order=1,t.module.sections.push(X),t.module.fakeSection=!0}t.setProfileSharingConfigs=function(){function o(e){var a=t.menuItems[e],n=!1;if(a&&a.module_id){var l=g.moduleFilterById(a.module_id)[0];l&&l.components.length>0&&(n=!0)}a.route&&""!=a.route&&null!=a.route?t.profileConfig.start_page=(!n&&a.module_id?"modules/":"")+a.route:a.menu_items&&a.menu_items[0]&&a.menu_items[0].route?t.profileConfig.start_page=a.menu_items[0].route:o(e+1)}"p_profiles"===t.module.name&&(t.menuFieldSelectedModulOptions={placeholder:a("translate")("Setup.Profiles.ChooseField"),dataTextField:"languages."+e.globalization.Label+".label",dataValueField:"name",valuePrimitive:!0,autoBind:!1},t.menuSectionSelectedModulOptions={placeholder:a("translate")("Setup.Profiles.ChooseArea"),dataTextField:"languages."+e.globalization.Label+".label",dataValueField:"name",valuePrimitive:!0,autoBind:!1},t.menuPicklistOptions={dataTextField:"languages."+e.globalization.Label+".name",dataValueField:"id",change:function(){t.setMenuTree()}},g.getMenuList().then(function(o){e.processLanguages(o.data),t.menuDataSource=o.data,t.profileConfig=t.id&&t.record.configs&&null!==t.record.configs?JSON.parse(t.record.configs):{start_page:"dashboard",other_permissions:{"is_persistent ":!1,send_email:!1,send_sms:!1,export_data:!1,import_data:!1,word_pdf_download:!1,smtp_settings:!1,dashboard:!0,change_email:!1}};var n=a("filter")(t.menuDataSource,{"default":!0})[0];t.profileConfig.menu=t.profileConfig.menu?t.profileConfig.menu:n.id.toString(),t.setMenuTree()}),t.setMenuTree=function(){return t.menuTreeOptions=void 0,t.profileConfig.menu&&""!=t.profileConfig.menu?void g.getMenuItemsByMenuId(t.profileConfig.menu).then(function(a){t.menuItems=g.proccesMenuItems(a.data),o(0),t.menuTreeOptions={dataSource:new kendo.data.HierarchicalDataSource({data:t.menuItems}),template:function(t){return t.item.languages=JSON.parse(t.item.languages),t.item.module_id?'<strong style="cursor:pointer" ng-click="selectModul('+t.item.module_id+')" flex md-truncate>'+e.getLanguageValue(t.item.languages,"label")+'</strong > <span><i ng-if="dataItem.deleted" class="fas fa-eye-slash"></i></span>':'<strong  ng-disabled="true"  flex md-truncate>'+e.getLanguageValue(t.item.languages,"label")+' </strong > <span><i ng-if="dataItem.deleted" class="fas fa-eye-slash"></i></span>'},dragAndDrop:!1,autoBind:!0,dataTextField:"languages."+e.globalization.Label+".label",dataValueField:"id"}}):!1},t.generateAllProfileConfig=function(){t.profileConfig.config={},angular.forEach(t.menuItems,function(o){if(o.module_id){var n=a("filter")(e.modules,{id:o.module_id},!0)[0];n&&"users"!==n.name&&"profiles"!==n.name&&"roles"!==n.name&&(t.profileConfig.config[n.name]=t.getProfileDefaultModel(n.name))}})},t.getProfileDefaultModel=function(e){return{records:{type:"organization",filters:[]},fields:{readonly:[],dont_show:[]},sections:{readonly:[],dont_show:[]},actions:{create:{enable:"p_profiles"===e,filters:[]},update:{enable:"p_profiles"===e,filters:[]},"delete":{enable:"p_profiles"===e,filters:[]},read:{enable:"p_profiles"===e}},enable_filter:!1}},t.selectModul=function(o){if(o){t.menuSelectedModul=g.moduleFilterById(o)[0],t.fieldskey={};var n=[];if(t.usersArray=[],t.users.length>0)for(var l=0;l<t.users.length;l++)t.usersArray.push({id:t.users[l].id,full_name:t.users[l].full_name});t.sharesOptions={dataSource:t.usersArray,filter:"contains",dataTextField:"full_name",dataValueField:"id",optionLabel:a("translate")("Common.Select")};var i=Object.assign({},t.sharesOptions);i.dataSource.push({full_name:a("translate")("Common.LoggedInUser"),id:"[me]"});for(var l=0;l<t.menuSelectedModul.fields.length;l++){var r=t.menuSelectedModul.fields[l];if(g.hasFieldDisplayPermission(r))if("multiselect_lookup"===r.data_type)for(var d=e.modulus[r.lookup_type],s=0;s<d.fields.length;s++){var u=d.fields[s];if(g.hasFieldDisplayPermission(u)&&"multiselect_lookup"!==u.data_type&&("lookup"!==u.data_type||"users"===u.lookup_type)){var c=r.name+"."+d.name+"."+u.name;"lookup"===u.data_type&&"users"===u.lookup_type&&(u.dataOptions=i),n.push({name:c,label:u.label+" ("+r.label+")",data_type:r.data_type,lookuplabel:r.label,multiselectLookupField:r.name}),t.fieldskey[c]=u}}else{var m={name:r.name,label:r.label,data_type:r.data_type,lookuplabel:"- "+t.menuSelectedModul.languages[e.globalization.Label].label.plural};t.fieldskey[r.name]=r,"lookup"===t.fieldskey[r.name].data_type&&"users"===t.fieldskey[r.name].lookup_type&&(t.fieldskey[r.name].dataOptions=i),n.push(m)}}t.allFields=n,t.profileConfig.config||t.generateAllProfileConfig(),t.profileConfig.config[t.menuSelectedModul.name]||(t.profileConfig.config[t.menuSelectedModul.name]=t.getProfileDefaultModel(t.menuSelectedModul.name)),t.setProfileConfig()}},t.setProfileConfig=function(){t.record.configs=JSON.stringify(t.profileConfig)})},t.tinymceOptions={setup:function(e){e.on("FullscreenStateChanged",function(){$(".mce-panel.mce-arrow-down, .mce-panel.mce-arrow-up").hide()})},toolbar:"styleselect | bold italic underline | forecolor backcolor | alignleft aligncenter alignright alignjustify | link image imagetools | table bullist numlist  blockquote code fullscreen",menubar:"false",plugins:["advlist autolink lists link image charmap print preview anchor table","searchreplace visualblocks code fullscreen","insertdatetime table contextmenu paste imagetools wordcount textcolor colorpicker"],convert_urls:!1},t.profileEnableFilterChange=function(){t.profileConfig.config[t.menuSelectedModul.name].enable_filter&&!t.profileConfig.config[t.menuSelectedModul.name].filters&&(t.profileConfig.config[t.menuSelectedModul.name].filters={logic:"and",filters:[],level:1})};var J=[],Y=[],H=0;t.viewFilter=function(){setTimeout(function(){H=0,J=[],Y=[];var e={group:t.profileConfig.config[t.menuSelectedModul.name].filters};if(t.checkFilterValid(e)){var a=A(e);t.profileConfig.config[t.menuSelectedModul.name].findRequestFilters=J,t.profileConfig.config[t.menuSelectedModul.name].findRequestFields=Y,t.profileConfig.config[t.menuSelectedModul.name].filter_logic=J.length>1?a:""}},500)},t.checkFilterValid=function(e){if(e.group&&e.group.filters&&e.group.filters.length>0){for(var a=0;a<e.group.filters.length;a++){var o=e.group.filters[a];if(null!=o.group){if(!t.checkFilterValid(o))return!1}else{if(null==o.operator||""===o.operator||null==o.operator.name||""===o.operator.name)return!1;if(!("lookup"!==o.field.data_type&&"picklist"!==o.field.data_type&&"multiselect"!==o.field.data_type&&"multiselect_lookup"!==o.field.data_type||null!==o.value&&""!==o.value))return!1}}return!0}return!1}}]);