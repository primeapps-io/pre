"use strict";angular.module("primeapps").controller("RecordController",["$rootScope","$scope","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","config","$timeout","operations","FileUploader","ModuleService","DocumentService","$http","resizeService","components","mdToast","$mdDialog","exportFile","AppService","customScripting",function(e,t,o,a,n,r,i,l,d,s,u,c,m,p,f,g,y,h,_,v,b,w,k,M,S){function F(e,o){const a=e.data;a[0]&&a[0].total_count?o.total=a[0].total_count:delete o.total,("flat"===o.detail_view_type||"flat"===t.module.detail_view_type)&&t.returnParentType===o.id&&(t.activeType="tab",t.tab="general"),t.returnTab==o.id&&(t.activeType="tab",t.tab=o.id.toString(),t.changeTab(o))}function T(e){const o=[],a={};t.type!==t.manyToManyRelation.related_module?(a[t.type+"_id"]=e,a[t.manyToManyRelation.related_module+"_id"]=n.search().pid):(a[t.type+"1_id"]=e,a[t.manyToManyRelation.related_module+"2_id"]=n.search().pid),o.push(a);const r={records:o};return r.tableName=t.manyToManyRelation.many_to_many_table_name,r}function R(e,o,a){const n=[],r={};if(o)r[t.module.name+"_id"]=parseInt(t.id),r[e+"_id"]=a,n.push(r);else{for(var i=0;i<t.selectedRecords[e].length;i++)r[t.module.name+"_id"]=t.id,r[e+"_id"]=t.selectedRecords[e][i],n.push(Object.assign({},r));t.selectedRecords[e]=[],t.isAllSelected[e]=!1}return n}function P(e){return e.validation.min=e.validation.min||Number.MIN_SAFE_INTEGER,e.validation.max=e.validation.max||Number.MAX_SAFE_INTEGER,e}t.formType||(t.type=i.type,t.subtype=i.stype,t.id=n.search().id,t.parentType=n.search().ptype,t.parentId=n.search().pid,t.returnTab=n.search().rtab,t.previousParentType=n.search().pptype,t.previousParentId=n.search().ppid,t.previousReturnTab=n.search().prtab,t.backUrlAtt=n.search().back,t.back=n.search().back,t.many=n.search().many,t.clone=n.search().clone,t.revise=n.search().revise,t.paramField=n.search().field,t.paramValue=n.search().value,t.fastRecordModal=!1),e.sideinclude=!1,t.isDisabled=!1,t.actionButtonDisabled=!1,t.operations=p,t.hasPermission=a.hasPermission,t.hasDocumentsPermission=a.hasDocumentsPermission,t.hasAdminRights=a.hasAdminRights,t.hasFieldFullPermission=g.hasFieldFullPermission,t.hasFieldReadOnlyPermission=g.hasFieldReadOnlyPermission,t.hasSectionFullPermission=g.hasSectionFullPermission,t.hasSectionDisplayPermission=g.hasSectionDisplayPermission,t.hasSectionReadOnlyPermission=g.hasSectionReadOnlyPermission,t.lookupUserAndGroup=a.lookupUserAndGroup,t.lookupUser=a.lookupUser,t.loading=!0,t.image={},t.document={},t.hasProcessEditPermission=!1,t.userAdded=!1,t.isActive={},t.tab="general",t.customLeaveFields={},t.isAdmin=e.user.profile.has_admin_rights,t.googleMapsApiKey=googleMapsApiKey,t.relationsGridOptions=[],t.showHelp=!1,t.buttonsParametersData={},t.tenantLanguage=tenantLanguage,e.expressionLookupModuleId=[],e.hideFieldValue={},t.goUrl2=function(e,t){const o=window.getSelection();0===o.toString().length&&(window.location="#/app/record/"+t+"?id="+e)},t.imageDownload=function(e,t){d.download(e,t)},t.parentId&&d.scrollTo(0,0),t.backUrlAtt&&(t.tab="document"),t.module=e.modulus[t.type],t.manyToManyRelation=void 0,t.module.relations&&t.parentType&&(t.manyToManyRelation=o("filter")(t.module.relations,{related_module:t.parentType,relation_type:"many_to_many",deleted:!1})[0]);const A=o("filter")(t.module.helps,function(e){return"side_modal"===e.modal_type&&"module_detail"===e.module_type},!0)[0];if(A&&(t.showHelp=!0),t.module.sections=o("filter")(t.module.sections,function(e){return t.preview&&("system"===e.name||"system_information"===e.name)&&(e.display_detail=!0),e.display_detail&&!e.deleted}),e.breadcrumblist=[{title:o("translate")("Layout.Menu.Dashboard"),link:"#/app/dashboard"},{title:e.getLanguageValue(t.module.languages,"label","plural"),link:"#/app/modules/"+t.module.name},{title:t.title}],t.tabconfig=t.module.detail_view_type?"flat"!==t.module.detail_view_type:"flat"!==e.detailViewType,t.module.default_tab&&(t.tab=t.module.default_tab),v.run("BeforeFormLoaded","script",t),t.currentSectionComponentsTemplate=currentSectionComponentsTemplate,!t.id)for(var D=0;D<t.module.fields.length;D++){var C=t.module.fields[D];C.show_lock&&(C.show_lock=!1)}if(!t.module)return b.warning(o("translate")("Common.NotFound")),void r.go("app.dashboard");t.dropdownFields=o("filter")(t.module.fields,{data_type:"lookup",show_as_dropdown:!0},!0),t.dropdownFieldDatas={};for(var L=0;L<t.dropdownFields.length;L++)t.dropdownFieldDatas[t.dropdownFields[L].name]=[];if(!t.id&&!t.hasPermission(t.type,t.operations.write))return b.error(o("translate")("Common.Forbidden")),void r.go("app.dashboard");t.primaryField=o("filter")(t.module.fields,{primary:!0})[0],t.currentUser=g.processUser(e.user),t.currentDayMin=a.getCurrentDateMin().toISOString(),t.currentDayMax=a.getCurrentDateMax().toISOString(),t.currentHour=a.floorMinutes(new Date),t.relatedToField=o("filter")(t.module.fields,{name:"related_to"},!0)[0],t.record={},t.formType&&t.recordModal&&(t.record=t.recordModal),t.id||(t.title=o("translate")("Module.New",{title:e.getLanguageValue(t.module.languages,"label","singular")}));for(var x=0;x<e.approvalProcesses.length;x++){const I=e.approvalProcesses[x];I.module_id===t.module.id&&(t.currentModuleProcess=I)}if(t.currentModuleProcess){const B=t.currentModuleProcess.profiles.split(",");for(var L=0;L<B.length;L++)B[L]===e.user.profile.id.toString()&&(t.hasProcessEditPermission=!0)}if(t.parentType)if(t.many)t.parentModule=t.parentType;else{const O=o("filter")(t.module.fields,{name:t.parentType},!0)[0];O?t.parentModule=O.lookup_type:(t.parentType=null,t.parentId=null)}t.picklistFilter=function(){return function(e){return t.componentFilter={},t.componentFilter.item=e,t.componentFilter.result=!0,v.run("PicklistFilter","Script",t),!e.hidden&&!e.inactive&&t.componentFilter.result}};const N=function(e){var a=!1;if(1===e.process_status)return!0;if(t.module.dependencies.length>0){const n=o("filter")(t.module.dependencies,{dependency_type:"freeze",deleted:!1},!0);for(var r=0;r<n.length;r++){const i=n[r],l=o("filter")(t.module.fields,{name:i.parent_field},!0);for(var d=0;d<l.length;d++){const s=l[d];if(i.values_array&&i.values_array.length>0)for(var u=0;u<i.values_array.length;u++){const c=parseInt(i.values_array[u]);!e[s.name]||c!==e[s.name]&&c!==e[s.name].id||(a=!0)}}}}return e.freeze=a?a:void 0,a};t.addNewTagItem=function(){const e=angular.element(document.getElementById(t.field.name)).data("kendoMultiSelect");if(e&&e._prev){const a=e.dataSource,n=e._prev;var r=0;if(a._data.length>0){const i=o("orderBy")(a._data,"id");r=i[i.length-1].id+1}const l={text:n,id:r};a.add(l);const d=a.data().find(function(e){return e.text===n});d&&(t.record[t.field.name]||(t.record[t.field.name]=[]),t.record[t.field.name].push(l.id))}},t.getRecord=function(a){a&&(t.loading=a),g.getPicklists(t.module).then(function(n){const i=[];e.processPicklistLanguages(n),t.picklistsModule=n;const d=o("filter")(t.module.fields,{name:"owner"},!0)[0],s=function(){for(var n=0;n<t.module.fields.length;n++){var r=t.module.fields[n];if(g.setDependency(r,t.module,t.record,t.picklistsModule,t),(!t.record.id&&r.default_value&&"picklist"===r.data_type||r.default_value&&"picklist"===r.data_type&&t.record[r.name]&&parseInt(r.default_value)===t.record[r.name].id)&&(t.record[r.name]=t.record[r.name]||o("filter")(t.picklistsModule[r.picklist_id],{id:r.default_value})[0],t.fieldValueChange(r)),"picklist"!==r.data_type||r.deleted||(t["customOptions"+r.picklist_id]={dataSource:new kendo.data.DataSource({transport:{read:function(e){e.success(o("filter")(t.picklistsModule[t.optionId],function(e){return t.componentFilter={},t.componentFilter.item=e,t.componentFilter.result=!0,v.run("PicklistFilter","Script",t),!e.hidden&&!e.inactive&&t.componentFilter.result},!0))}}}),dataTextField:"label",dataValueField:"id",ingoreCase:!0,filter:t.picklistsModule[r.picklist_id].length>10?"startswith":null,filtering:function(e){if(e.filter&&e.filter.value&&e.filter.value.indexOf("i")>-1){var t=e.filter.value,o=e.filter.field,a=e.filter.operator;e.preventDefault();var n=t.replace(/i/gim,"İ").toLocaleUpperCase(),r=t.toLocaleUpperCase().replace(/İ/gim,"I");this.dataSource.filter({logic:"or",filters:[{field:o,operator:a,value:t,ignoreCase:!0},{field:o,operator:a,value:n,ignoreCase:!0},{field:o,operator:a,value:r,ignoreCase:!0},{field:o,operator:a,value:r.toLocaleLowerCase(),ignoreCase:!0}]})}},autoBind:!1,optionLabel:o("translate")("Common.Select")}),"multiselect"!==r.data_type||r.deleted||(t["customOptions"+r.picklist_id]={dataSource:new kendo.data.DataSource({data:o("filter")(t.picklistsModule[r.picklist_id],function(e){return t.componentFilter={},t.componentFilter.item=e,t.componentFilter.result=!0,v.run("PicklistFilter","Script",t),!e.hidden&&!e.inactive&&t.componentFilter.result},!0)}),tagMode:t.id?t.record[r.name].length<=5?"multiple":"single":"multiple",dataTextField:"label",dataValueField:"id",filter:"contains",filtering:function(e){if(e.filter&&e.filter.value.indexOf("i")>-1){var t=e.filter.value,o=e.filter.field,a=e.filter.operator;e.preventDefault();var n=t.replace(/i/gim,"İ").toLocaleUpperCase(),r=t.toLocaleUpperCase().replace(/İ/gim,"I");this.dataSource.filter({logic:"or",filters:[{field:o,operator:a,value:t,ignoreCase:!0},{field:o,operator:a,value:n,ignoreCase:!0},{field:o,operator:a,value:r,ignoreCase:!0},{field:o,operator:a,value:r.toLocaleLowerCase(),ignoreCase:!0}]})}},valuePrimitive:!0,autoClose:!1,optionLabel:o("translate")("Common.Select"),change:function(e){const a=e.sender.element[0].name;if(a){const n=o("filter")(t.module.fields,{name:a,deleted:!1},!0)[0];n&&t.fieldValueChange(n)}const r=this.value(),i=this.options.tagMode;var l=i;l=r.length<=5?"multiple":"single",l!==i&&(this.value([]),this.setOptions({tagMode:l}),this.value(r))}}),"tag"===r.data_type&&!r.deleted){const i=new kendo.data.DataSource({transport:{read:{url:"/api/tag/get_tag/"+r.id,type:"GET",dataType:"json",beforeSend:e.beforeSend()}},requestEnd:function(e){const a=e.response;if(a&&a.length>0){const n=o("filter")(t.module.fields,{id:a[0].field_id,deleted:!1},!0)[0];if(n&&t.record[n.name])for(var r=0;r<t.record[n.name].length;r++){const i=o("filter")(a,{text:t.record[n.name][r]},!0)[0];i&&(t.record[n.name][r]=i.id)}}}});a&&i.read(),t["tagOptions"+r.id]={dataSource:i,dataTextField:"text",dataValueField:"id",valuePrimitive:!0,filter:"contains",tagMode:t.id?t.record[r.name].length<=5?"multiple":"single":"multiple",noDataTemplate:"#var value = instance.input.val();# <div>No data found. </div><div ng-show=\"showAddNewTagButton('"+r.name+'\')" style="text-transform: inherit">Do you want to add new item ?</div><md-button ng-show="showAddNewTagButton(\''+r.name+'\')" class="btn btn-secondary" ng-click="addNewTagItem()" aria-label="New Item"> <i class="fas fa-plus"></i> <span>#:value#</span></md-button></div>',change:function(e){const a=this.value(),n=this.options.tagMode;var r=n;r=a.length<=5?"multiple":"single",r!==n&&(this.value([]),this.setOptions({tagMode:r}),this.value(a));var i=e.sender.element[0].name;if(i){const l=o("filter")(t.module.fields,{name:i,deleted:!1},!0)[0];l&&t.fieldValueChange(l)}}}}if("lookup"!==r.data_type||r.deleted||(t["lookupOptions"+r.id]={dataSource:new kendo.data.DataSource({serverFiltering:!0,transport:{read:function(a){const n={module:t.currentLookupField.lookup_type,convert:!1};var r=Object.assign({},a.data.filter.filters[0]);if(!a.data.filter||a.data.filter&&0===a.data.filter.filters.length){a.data.filter={},a.data.filter.filters=[],a.data.filter.logic="and";const i=t.record[t.currentLookupField.name]?t.record[t.currentLookupField.name][t.currentLookupField.lookupModulePrimaryField.name]:"";if(U(),t.currentLookupField&&t.currentLookupField.filters.length>0)for(var l=0;l<t.currentLookupField.filters.length;l++){const r=t.currentLookupField.filters[l];a.data.filter.filters.push({field:r.filter_field,operator:r.operator,value:r.value})}var d={field:t.currentLookupField.lookupModulePrimaryField.name,operator:t.currentLookupField.lookup_search_type&&""!==t.currentLookupField.lookup_search_type?t.currentLookupField.lookup_search_type.replace("_",""):"startswith",value:t.record[t.currentLookupField.name]&&i?i:""};"number"===t.currentLookupField.lookupModulePrimaryField.data_type&&(d.operator=""!==i?"equals":"not_empty",d.value="not_empty"===d.value?"-":d.value)}if(a.data.filter.filters.length>0){if(a.data.filter.filters=g.fieldLookupFilters(t.currentLookupField,t.record,a.data.filter.filters,n),n.fields.push(t.currentLookupField.lookupModulePrimaryField.name),"number"===t.currentLookupField.lookupModulePrimaryField.data_type){var s="equals";a.data.filter.filters[0].operator=s}else{const u=a.data.filter.filters[0].operator;u.contains("_")&&(a.data.filter.filters[0].operator=""!==u?u.replace("_",""):"startswith")}t.lookupSearchValue=t.lookupInput?t.lookupInput._prev:""}r.value&&0===o("filter")(a.data.filter.filters,{value:r.value,field:r.field,operator:r.operator}).length&&a.data.filter.filters.push(r),$.ajax({url:"/api/record/find_custom",contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(n,a.data)),success:function(t){e.processLanguages(t.data),a.success(t)},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}}),optionLabel:o("translate")("Common.Select"),autoBind:!1,dataTextField:r.lookupModulePrimaryField.name,dataValueField:"id",noDataTemplate:"<div>"+o("translate")("Common.NoDataFound")+" </div><div ng-if=\"(field.name !== 'owner' || formType === 'null') && field.lookup_type !== 'users'\"><div style=\"text-transform: inherit\" ng-if=\"lookupSearchValue!==''\">"+o("translate")("Module.AddNewItem")+'</div><md-button ng-if="lookupSearchValue!==\'\'" class="btn btn-secondary" ng-click="fastNewRecordModal(field.lookup_type,true,lookupSearchValue,field.name)"> <i class="fas fa-plus"></i> <span>{{lookupSearchValue}}</span></md-button></div>'}),"rating"!==r.data_type||r.deleted||(t["ratingOption"+r.id]={max:r.max||5,precision:"half",value:t.record[r.name],change:function(e){var a=e.sender.element[0].name;if(a){const n=o("filter")(t.module.fields,{name:a,deleted:!1},!0)[0];n&&t.fieldValueChange(n)}}}),"number"!==r.data_type||r.deleted||(r=P(r),t["numberOptions"+r.id]={format:"#",decimals:0,max:r.validation.max,min:r.validation.min}),"number_decimal"===r.data_type&&!r.deleted){r=P(r);var l=t["numberDecimalOptions"+r.id]={max:r.validation.max,min:r.validation.min,rounding:r.rounding};l.format=g.renderNumberDecimalFormat(r.decimal_places)}if("currency"===r.data_type&&!r.deleted){r=P(r);var d=t["currencyOptions"+r.id]={culture:kendo.cultures.current.name,format:"c",decimals:r.decimal_places||kendo.cultures.current.numberFormat.currency.decimals,max:r.validation.max,min:r.validation.min,rounding:r.rounding};d.format=g.renderCurrencyFormat(r.currency_symbol,r.decimal_places)}}};if(v.run("BeforeFormPicklistLoaded","Script",t),!t.id){if(t.loading=!1,t.record.owner=t.currentUser,t.record.owner.full_name=t.currentUser.primary_value,t.parentId){const u=o("filter")(e.modules,{name:t.parentModule},!0)[0];g.getRecord(t.parentModule,t.parentId).then(function(e){const a=o("filter")(u.fields,{primary:!0,deleted:!1},!0)[0],r={};if(r.id=e.data.id,r[a.name]=e.data[a.name],r.primary_value=e.data[a.name],t.relatedToField)t.record.related_to=r,t.record.related_module=o("filter")(n[9e5],{value:t.parentType},!0)[0];else{t.record[t.parentType]=r;const i=o("filter")(t.module.dependencies,{dependent_field:t.parentType},!0)[0];if(i&&i.deleted!==!0){const l=o("filter")(t.module.fields,{name:i.field},!0)[0];t.record[i.field]=o("filter")(t.picklistsModule[l.picklist_id],{id:i.values[0]},!0)[0];const d=o("filter")(t.module.fields,{name:i.dependent_field},!0)[0];d.hidden=!1}s()}})}else s();return g.setDefaultValues(t.module,t.record,n),g.setDisplayDependency(t.module,t.record),v.run("FieldChange","Script",t,t.record,d),void E()}if(g.getRecord(t.module.name,t.id).then(function(a){if(0===Object.keys(a.data).length)return b.error(o("translate")("Common.Forbidden")),void r.go("app.dashboard");t.getRecordData=Object.assign({},a.data);const n=g.processRecordSingle(a.data,t.module,t.picklistsModule);if(E(),t.ActionButtonsLoad(t.module.id),!t.hasPermission(t.type,t.operations.modify)&&!t.hasPermission(t.type,t.operations.modify,a.data)&&t.hasPermission(t.type,t.operations.read)&&!t.hasPermission(t.type,t.operations.read,a.data))return b.error(o("translate")("Common.Forbidden")),void r.go("app.dashboard");t.hasPermission(t.type,t.operations.modify)?t.hasPermission(t.type,t.operations.modify,a.data)||(n.freeze=!0):t.clone||t.hasPermission(t.type,t.operations.modify,a.data)||!t.hasPermission(t.type,t.operations.read,a.data)&&!t.hasPermission(t.type,t.operations.read)?N(n):n.freeze=!0,v.run("BeforeFormRecordLoaded","Script",t,n),g.formatRecordFieldValues(Object.assign({},a.data),t.module,t.picklistsModule),t.title=t.primaryField.valueFormatted,e.breadcrumblist[2].title=t.title,t.recordState=Object.assign({},n);for(var i=0;i<t.module.fields.length;i++){const l=t.module.fields[i];var u=!1;if(l.encrypted&&l.encryption_authorized_users_list.length>0&&n[l.name])for(var c=0;c<l.encryption_authorized_users_list.length;c++){const m=l.encryption_authorized_users_list[c];e.user.id===parseInt(m)&&(u=!0)}l.show_lock=l.encrypted&&!u}if(t.relatedToField&&n.related_to){const p=o("filter")(e.modules,{id:n[t.relatedToField.lookup_relation].id-9e5},!0)[0],f=o("filter")(p.fields,{primary:!0},!0)[0];g.getRecord(p.name,n.related_to,!0).then(function(e){e=e.data,e.primary_value=e[f.name],n.related_to=e,t.record=n,t.recordState=Object.assign({},t.record),s(),t.module&&t.module.fields&&t.module.fields.length>0&&t.fieldValueChange(t.module.fields[0]),t.loading=!1})["catch"](function(e){404===e.status&&(n.related_to=null,t.record=n,t.recordState=Object.assign({},t.record)),t.loading=!1})}else t.record=n,s(),t.clone&&(t.currentUser.full_name=t.currentUser.primary_value,t.record.owner=t.currentUser),t.loading=!1;t.record.currency&&(t.currencySymbol=t.record.currency.value||e.currencySymbol),g.customActions(t.module,t.record),v.run("FieldChange","Script",t,t.record,d),v.run("AfterFormRecordLoaded","Script",t),g.setDisplayDependency(t.module,n)})["catch"](function(){t.loading=!1}),t["export"]=function(a){if(a.total&&!(a.total<1)){var n=!1;try{n=!!new Blob}catch(r){}if(!n)return void b.messages(o("translate")("Module.ExportUnsupported"));if(a.total>3e3)return void b.messages(o("translate")("Module.ExportWarning"));const i=e.getLanguageValue(a.languages,"label","plural")+"-"+o("date")(new Date,"dd-MM-yyyy")+".xls";t.exporting=!0,g.getCSVData(t,a,t.module).then(function(e){b.success(o("translate")("Module.ExcelExportSuccess")),k.excel(e,i),t.exporting=!1})}},t.selectedRows={},t.selectedRecords={},t.isAllSelected={},t.tabRelations=[],t.module.relations)for(var c=0;c<t.module.relations.length;c++){const m=t.module.relations[c];if(t.selectedRows[m.related_module]=[],t.selectedRecords[m.related_module]=[],t.isAllSelected[m.related_module]=!1,!m.deleted){t.toolbarRelationOptions["relation"+m.id]={resizable:!0,items:[]},t.getRelatedActionButtons(m);const p=o("filter")(e.modules,{name:m.related_module},!0)[0];var f={};if("many_to_many"===m.relation_type){if(!p)continue;f={fields:["total_count()"],filters:[{field:t.module.name+"_id",operator:"equals",value:t.id,no:1}],limit:1,offset:0,many_to_many:t.module.name,many_to_many_table_name:m.many_to_many_table_name}}else f={fields:["total_count()"],filters:[{field:m.relation_field,operator:"equals",value:t.id,no:1}],limit:1,offset:0};"flat"===m.detail_view_type||"flat"===t.module.detail_view_type?setTimeout(function(){t.generateRelationsTable(m)},100):(t.tabRelations.push(m),i.push(g.findRecords(m.related_module,f)))}}l.all(i).then(function(e){for(var o=0;o<e.length;o++)F(e[o],t.tabRelations[o])}),v.run("AfterFormPicklistLoaded","Script",t)})},t.getRecord(),t.grid=[],t.isOpen=!1,t.demo={isOpen:!1,count:1e3,selectedDirection:"left"},t.selectRow=function(e,o,a){o.isChecked=e.target.checked,t.selectedRecords[a]=[];const n=t.grid[a].dataSource.data();for(var r=!0,i=0;i<n.length;i++)n[i].isChecked?t.selectedRecords[a].push(n[i].id||n[i][t.forManyToManyFielName]):(t.isAllSelected[a]=!1,r=!1);r&&(t.isAllSelected[a]=!0)},t.isOpenTest=!1,t.selectAll=function(e,o){const a=t.grid[o].dataSource.data();t.selectedRecords[o]=[];for(var n=0;n<a.length;n++)a[n].isChecked=e.target.checked,e.target.checked&&t.selectedRecords[o].push(a[n].id||a[n][t.forManyToManyFielName]);e.target.checked&&(t.isOpenTest=!0)},t.refreshGrid=function(e){t.grid[e].dataSource.read()},t.setCurrentLookupField=function(e,o){t.currentLookupField=e,o&&(e.filters&&e.filters.length>0&&t["lookupOptions"+e.id]&&t["lookupOptions"+e.id].dataSource.read(),t.lookupInput=o,t.lookupSearchValue=o._prev)},t.uploader=new f({url:"storage/record_file_upload"}),t.entityIdFunc=function(){return t.recordId},t.recordDelete=function(e,n,r){const i=w.confirm().title(o("translate")("Common.AreYouSure")).targetEvent(e).ok(o("translate")("Common.Yes")).cancel(o("translate")("Common.No"));w.show(i).then(function(){g.getRecord(r,n).then(function(e){if(!a.hasPermission(t.type,p.modify,e.data))return void b.error(o("translate")("Common.Forbidden"));const i=e;t.executeCode=!1,v.run("BeforeDelete","Script",t,i),t.executeCode||g.deleteRecord(r,n).then(function(){t.refreshGrid(r),b.success(o("translate")("Module.DeleteMessage")),t.isAllSelected[r]=!1})})},function(){t.status="You decided to keep your debt."})},t.deleteSelectedsSubTable=function(e,a){const n=w.confirm().title(o("translate")("Common.AreYouSure")).targetEvent(e).ok(o("translate")("Common.Yes")).cancel(o("translate")("Common.No"));w.show(n).then(function(){g.deleteRecordBulk(a,t.selectedRecords[a]).then(function(){t.refreshGrid(a),t.selectedRecords[a]=[],t.selectedRows[a]=[],t.isAllSelected[a]=!1})},function(){t.status="You decided to keep your debt."})},t.getAddHideFieldValueForExpression=function(a){var n=Object.keys(e.hideFieldValue),r=Object.keys(a),i=o("filter")(t.module.fields,{display_detail:!1}),l=t.module.display_dependencies;if(i)for(var d=0;d<i.length;d++)!a[i[d].name]&&t.getRecordData&&(a[i[d].name]=t.getRecordData[i[d].name]);if(l)for(var d=0;d<l.length;d++)!a[l[d].dependent_field]&&t.getRecordData&&(a[l[d].dependent_field]=t.getRecordData[l[d].dependent_field]);for(var d=0;d<n.length;d++)if(-1===r.indexOf(n[d])){var s=n[d],u={},c=e.hideFieldValue[s];u[s]=c.substring(1,c.length-1),a=Object.assign(a,u)}return a},t.submit=function(a,n){function i(){for(var e=!0,a=0;a<t.module.fields.length;a++){const n=t.module.fields[a];if(f[n.name]||"date"===n.data_type||"date_time"===n.data_type||"time"===n.data_type||"picklist"===n.data_type&&"checkbox"===n.view_type&&!n.hidden)if("document"===n.data_type&&t.document[n.name]&&t.document[n.name].UniqueName&&null!=f[n.name])f[n.name]=t.document[n.name].UniqueName;else if("document"!==n.data_type||f[n.name]||n.hidden||!n.validation.required)if("lookup"===n.data_type&&"object"!=typeof f[n.name])e=!1;else if("image"===n.data_type&&t.image[n.name]&&t.image[n.name].UniqueName&&null!=f[n.name])f[n.name]=t.image[n.name].UniqueName;else if("date"===n.data_type||"date_time"===n.data_type||"time"===n.data_type)delete f[n.name+"str"];else if("tag"===n.data_type)for(var r=0;r<f[n.name].length;r++){const i=o("filter")(t["tagOptions"+n.id].dataSource._view,{id:parseInt(f[n.name][r])},!0)[0];i&&(f[n.name][r]=i.text)}else f[n.name]||"picklist"!==n.data_type||"checkbox"!==n.view_type||n.hidden||!n.validation.required||(e=!1);else e=!1}return e}function l(){var e=g.setExpression(t.module,t.record,t.picklistsModule,null,!0,!1,!0);return e}function s(a){t.addedUser=!1,t.recordId=a.id,t.uploader.queue.length>0&&(t.uploader.onCompleteAll(),t.uploader.uploadAll()),v.run("BeforeFormSubmitResult","Script",t,a),t.success=function(){const n=a[t.module.primaryField.name]?a[t.module.primaryField.name]:t.title;b.success(!t.id||t.clone?n+" "+o("translate")("Module.SuccessfullyAdded"):n+" "+o("translate")("Module.SuccessfullyUpdated"));const i={type:t.type,id:a.id};t.parentId&&(i.type=t.parentModule,i.id=t.parentId,i.rptype=t.returnTab,t.previousParentType&&(i.rpptype=t.previousParentType,i.rppid=t.previousParentId,i.rprtab=t.previousReturnTab)),t.back&&(i.back=t.back);var l=t.module.name+"_"+t.module.name;if(t.parentId){l=(t.relatedToField?"related_to":t.parentType)+t.parentId+"_"+(t.many?t.many:t.module.name);const d=t.parentType+"_"+t.parentType;u.remove(l),u.remove(d)}else u.remove(l);e.activePages&&e.activePages[t.module.name]&&(e.activePages[t.module.name]=null),t.fastRecordModal?(w.hide(),g.getRecord(t.type,t.recordId).then(function(e){var o=e.data,a=t.lookupName;if(t.modalCustomScopeRecord[a]=o,t.fastRecordModal){var n=angular.element(document.getElementById(a)).data("kendoDropDownList");n.value(o.id)}})):t.parentModule&&t.parentId?r.go("app.record",{type:t.parentModule,id:t.parentId,rtab:t.returnTab}):r.go("app.record",{type:t.module.name,id:t.recordId})},t.success()}function m(a,n){if(t.addedUser=!1,409===n){const r=o("filter")(t.module.fields,{name:a.field,deleted:!1})[0];b.warning(o("translate")("Common.Conflict",{fieldName:e.getLanguageValue(r.languages,"label"),value:t.record[a.field]}))}}var p,f=Object.assign({},a);if(f=t.getAddHideFieldValueForExpression(f),t.submitting=!0,!t.moduleForm.validate()||!i())return n.preventDefault(),t.submitting=!1,void b.error(o("translate")("Module.RequiredError"));var y=l();if(void 0!==y)return t.submitting=!1,n.preventDefault(),void b.error(y);if(v.run("BeforeFormSubmit","Script",t,f),!t.id||t.clone){if(t.executeCode=!1,v.run("BeforeCreate","Script",t,f),t.executeCode)return void(t.submitting=!1)}else if(t.executeCode=!1,v.run("BeforeUpdate","Script",t,f),t.executeCode)return void(t.submitting=!1);if(e.branchAvailable&&t.branchManager){for(var _=0;_<t.record.Authorities.length;_++){var k=t.record.Authorities[_];p=o("filter")(t.authorities,{user_id:k.id},!0)[0],p||h.post(c.apiUrl+"user_custom_shares/create/",{shared_user_id:t.branchManager.id,user_id:k.id})}for(var _=0;_<t.authorities.length;_++){const k=t.authorities[_];p=o("filter")(t.record.Authorities,{id:k.user_id},!0)[0],p||h["delete"](c.apiUrl+"user_custom_shares/delete/"+k.id)}}if(delete f.Authorities,t.clone){delete t.record.created_at,delete t.record.created_by,delete t.record.updated_at,delete t.record.updated_by;for(var _=0;_<t.module.fields.length;_++){const M=t.module.fields[_];"number_auto"===M.data_type&&delete f[M.name]}t.recordState=null}if(f=g.prepareRecord(f,t.module,t.recordState),t.id){for(var S=0;S<t.module.fields.length;S++){var M=t.module.fields[S],F=!1;if(M.encrypted&&M.encryption_authorized_users_list.length>0&&f[M.name])for(var R=0;R<M.encryption_authorized_users_list.length;R++){const P=M.encryption_authorized_users_list[R];e.user.id===parseInt(P)&&(F=!0)}M.encrypted&&!F&&delete f[M.name]}t.clone?(t.revise&&(f.master_id=f.id),delete f.id,delete f.process_id,delete f.process_status,delete f.process_status_order,delete f.process_request_updated_at,delete f.process_request_updated_by,delete f.operation_type,delete f.freeze,f.auto_id&&(f.auto_id=""),g.insertRecord(t.module.name,f).then(function(e){f.master_id||(t.submitting=!1,s(e.data)),f.id=e.data.id,t.clone&&(t.clone=void 0,d.location.href="#/app/record/"+t.type+"?id="+t.record.id),v.run("AfterCreate","Script",t,f)})["catch"](function(e){m(e.data,e.status),t.submitting=!1})):g.updateRecord(t.module.name,f).then(function(a){var n=o("filter")(e.approvalProcesses,{module_id:t.module.id},!0);if(n){for(var r=!1,i=0;i<n.length;i++)(0===n[i].user_id||n[i].user_id===t.currentUser.id)&&n[i].operations.indexOf("update")>-1&&(r=!0);r?setTimeout(function(){s(a.data)},2e3):s(a.data)}else s(a.data);v.run("AfterUpdate","Script",t,f)})["catch"](function(e){m(e.data,e.status)})["finally"](function(){const a=o("filter")(e.approvalProcesses,{module_id:t.module.id},!0);if(a){for(var n=!1,r=0;r<a.length;r++)(0===a[r].user_id||a[r].user_id===t.currentUser.id)&&a[r].operations.indexOf("update")>-1&&(n=!0);n?setTimeout(function(){t.submitting=!1},2e3):t.submitting=!1}else t.submitting=!1})}else g.insertRecord(t.module.name,f).then(function(a){if(t.manyToManyRelation){const n=T(a.data.id),r=t.manyToManyRelation.many_to_many_table_name.indexOf(t.type),i=t.manyToManyRelation.many_to_many_table_name.indexOf(t.manyToManyRelation.related_module);var l="",d="";i>r?(l=t.type,d=t.manyToManyRelation.related_module):(l=t.manyToManyRelation.related_module,d=t.type),g.addRelations(l,d,n)}const u=o("filter")(e.approvalProcesses,{module_id:t.module.id},!0);if(u){for(var c=!1,m=0;m<u.length;m++)(0===u[m].user_id||u[m].user_id===t.currentUser.id)&&u[m].operations.indexOf("insert")>-1&&(c=!0);c?setTimeout(function(){s(a.data)},2e3):s(a.data)}else s(a.data);f.id=a.data.id,v.run("AfterCreate","Script",t,f)})["catch"](function(e){m(e.data,e.status)})["finally"](function(){const a=o("filter")(e.approvalProcesses,{module_id:t.module.id},!0);if(a){for(var n=!1,r=0;r<a.length;r++)(0===a[r].user_id||a[r].user_id===t.currentUser.id)&&a[r].operations.indexOf("insert")>-1&&(n=!0);n?setTimeout(function(){t.submitting=!1},2e3):t.submitting=!1}else t.submitting=!1})},t.calculate=function(e){g.calculate(e,t.module,t.record)},t.fieldValueChange=function(a){if(a.valueChangeDontRun)return void delete a.valueChangeDontRun;var n=g.setExpression(t.module,t.record,t.picklistsModule,a,!1,!1,!1);if(void 0!==n&&b.error(n),g.setDependency(a,t.module,t.record,t.picklistsModule,t),t.loading||g.setDisplayDependency(t.module,t.record),g.setCustomCalculations(t.module,t.record,t.picklistsModule,t),g.customActions(t.module,t.record,t.moduleForm,t.picklistsModule,t),v.run("FieldChange","Script",t,t.record,a),t.record.currency&&(t.currencySymbol=t.record.currency.value||e.currencySymbol),"picklist"===a.data_type){const r=o("filter")(t.module.dependencies,function(e){return e.parent_field===a.name&&("list_field"===e.dependency_type||"list_value"===e.dependency_type)},!0);if(!r||!r.length)return;for(var i=0;i<r.length;i++){var l=r[i];if(!l.deleted){const d=o("filter")(t.module.fields,{name:l.child_field},!0)[0];t["customOptions"+t.optionId].dataSource.read(),t.optionId=d.picklist_id,t["customOptions"+t.optionId].dataSource.read()}}}},t.hideCreateNew=function(e){return"users"===e.lookup_type?!0:"relation"===e.lookup_type&&!t.record.related_module},t.openFormModal=function(e){t.primaryValueModal=e;const o=angular.element(document.body);w.show({parent:o,templateUrl:"view/app/module/moduleFormModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})},t.ActionButtonsLoad=function(){g.getActionButtons(t.module.id).then(function(o){t.actionButtons=o,t.toolbarOptions={resizable:!0,items:[]},e.processLanguages(o);for(var a=0;o.length>a;a++)if(V(o[a]),"List"!==o[a].trigger&&"Relation"!==o[a].trigger){const n=e.getLanguageValue(o[a].languages,"label");if("Scripting"===o[a].type&&g.hasActionButtonDisplayPermission(o[a],!1,t.record,t.module)){var r={template:'<md-button ng-show="actionButtons['+a+'].isShown" class="btn '+o[a].color+'"  ng-click="runScript('+a+')" aria-label="'+n+'" > <i class="'+o[a].icon+'"></i> <span>'+n+"</span></md-button>",overflowTemplate:'<md-button ng-show="actionButtons['+a+'].isShown" ng-click="runScript('+a+')"  class="action-dropdown-item"><i class="'+o[a].icon+'"></i><span> '+n+"</span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(r)}if("Webhook"===o[a].type&&g.hasActionButtonDisplayPermission(o[a],!1,t.record,t.module)){var r={template:'<md-button ng-show="actionButtons['+a+'].isShown" class="btn '+o[a].color+'"  ng-click="webhookRequest('+a+')"   aria-label="'+n+'" > <i class="'+o[a].icon+'"></i> <span>'+n+"</span></md-button>",overflowTemplate:'<md-button ng-show="actionButtons['+a+'].isShown" ng-click="webhookRequest('+a+')"  class="action-dropdown-item "><i class="'+o[a].icon+'"></i><span> '+n+" </span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(r)
}if("ModalFrame"===o[a].type&&g.hasActionButtonDisplayPermission(o[a],!1,t.record,t.module)){var r={template:'<md-button ng-show="actionButtons['+a+'].isShown" class="btn '+o[a].color+'" ng-click="showModuleFrameModal(\''+o[a].url+'\')"   aria-label="'+n+'" > <i class="'+o[a].icon+'"></i> <span>'+n+"</span></md-button>",overflowTemplate:'<md-button ng-show="actionButtons['+a+'].isShown"  ng-click="showModuleFrameModal(\''+o[a].url+'\')"   class="action-dropdown-item"><i class="'+o[a].icon+'"></i><span> '+n+" </span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(r)}if("CallMicroflow"===o[a].type&&g.hasActionButtonDisplayPermission(o[a],!1,t.record,t.module)){var r={template:'<md-button ng-show="actionButtons['+a+'].isShown" class="btn '+o[a].color+'"  ng-click="runMicroflow('+o[a].microflow_id+","+a+","+!1+')" aria-label="'+n+'" > <i class="'+o[a].icon+'"></i> <span>'+n+"</span></md-button>",overflowTemplate:'<md-button ng-show="actionButtons['+a+'].isShown"   ng-click="runMicroflow('+o[a].microflow_id+","+a+","+!1+')" class="action-dropdown-item"><i class="'+o[a].icon+'"></i><span> '+n+"</span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(r)}}})},t.showModuleFrameModal=function(e){if(new RegExp("https:").test(e)){var o,a,n;o="myPop1",a=document.body.offsetWidth-200,n=document.body.offsetHeight-200;var r=screen.width/2-a/2,i=screen.height/2-n/2;window.open(e,o,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+a+", height="+n+", top="+i+", left="+r)}else t.frameUrl=e},t.openLocationModal=function(e){t.filedName=e;const o=angular.element(document.body);w.show({parent:o,controller:"locationFormModalController",templateUrl:"view/app/location/locationFormModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})},t.removeDocument=function(o){var n={};n.module=t.module.name,n.recordId=t.record.id,n.fieldName=o.name,n.fileNameExt=a.getFileExtension(t.record[o.name]),n.instanceId=e.workgroup.tenant_id,t.record[o.name]=null,"document"===o.data_type&&(t.uploaderBasic[o.name].queue=[]),"image"===o.data_type&&(t.croppedImage=t.croppedImage||{},t.croppedImage[o.id]=void 0),angular.element("input[type='file']").val(null)},t.checkUploadFile=function(e){const t=e.target.files,o=e.target.id,a=angular.element(document.getElementById("lbl_"+o))[0];isAcceptedExtension(t[0])&&(a.innerText=t[0].name)},t.fileLoadingCounter=0,t.uploaderBasic=function(n){t.isFinishUpload=!1,t.document[n.name]={};const r={};e.preview?r["X-App-Id"]=e.user.app_id:r["X-Tenant-Id"]=e.user.tenant_id;const i=t.uploaderBasic[n.name]=new f({url:"storage/record_file_upload",headers:r,queueLimit:1});return i.onAfterAddingFile=function(e){t.fileLoadingCounter++,t.record[n.name]=e.uploader.queue[0].file.name,t.document[n.name].Name=e.uploader.queue[0].file.name,t.document[n.name].Size=e.uploader.queue[0].file.size,t.document[n.name].Type=e.uploader.queue[0].file.type,e.upload()},i.onWhenAddingFileFailed=function(e,t){switch(t.name){case"docFilter":b.warning(o("translate")("Setup.Settings.DocumentTypeError"));break;case"sizeFilter":b.warning(o("translate")("Setup.Settings.SizeError"))}},i.filters.push({name:"docFilter",fn:function(e){const t=a.getFileExtension(e.name);return"txt"===t||"docx"===t||"pdf"===t||"doc"===t||"xlsx"===t||"xls"===t}}),i.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}}),i.onSuccessItem=function(e,o){t.document[n.name].UniqueName=o.unique_name,t.fileLoadingCounter--},i.onErrorItem=function(e,o){t.document[n.name].UniqueName=o.unique_name,t.fileLoadingCounter--},t.isFinishUpload=!0,i},t.getFileDownload=function(e,t){d.location.href=void 0===t?"storage/record_file_download?fileName="+e:"storage/record_file_download?fileName="+t},t.uploaderImage=function(n){function r(e){const t=l.defer(),o=new FileReader;return o.onload=function(e){t.resolve(e.target.result)},o.readAsDataURL(e),t.promise}t.image[n.name]={};const i={Authorization:"Bearer "+s.read("access_token"),Accept:"application/json"};e.preview?i["X-App-Id"]=e.user.app_id:i["X-Tenant-Id"]=e.user.tenant_id;const d=t.uploaderImage[n.name]=new f({url:"storage/record_file_upload",headers:i,queueLimit:1});d.onAfterAddingFile=function(e){r(e._file).then(function(o){t.copyImg=o,e.image=o,_.resizeImage(e.image,{width:1024},function(o,r){if(!o){e._file=u(r),e.file.size=e._file.size,t.fileLoadingCounter++,t.record[n.name]=e.uploader.queue[0].file.name,t.image[n.name].Name=e.uploader.queue[0].file.name,t.image[n.name].Size=e.uploader.queue[0].file.size,t.image[n.name].Type=e.uploader.queue[0].file.type;const i=e.uploader.queue[0].file.name.split(".");e.uploader.queue[0].file.name=a.getSlug(i[0])+"."+i[1],e.upload()}})})},d.onWhenAddingFileFailed=function(e,t){switch(t.name){case"imgFilter":b.warning(o("translate")("Setup.Settings.ImageError"));break;case"sizeFilter":b.warning(o("translate")("Setup.Settings.SizeError"))}},d.filters.push({name:"imgFilter",fn:function(e){const t=a.getFileExtension(e.name);return"jpg"===t||"jpeg"===t||"png"===t||"doc"===t||"gif"===t}}),d.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}}),d.onSuccessItem=function(e,o){t.croppedImage=t.croppedImage||{},t.croppedImage[n.id]=t.copyImg,t.image[n.name].UniqueName=o.public_url,t.fileLoadingCounter--};const u=function(e){const t=atob(e.split(",")[1]),o=e.split(",")[0].split(":")[1].split(";")[0],a=[];for(var n=0;n<t.length;n++)a.push(t.charCodeAt(n));return new Blob([new Uint8Array(a)],{type:o})};return d},t.webhookRequest=function(a,n){const r=n?t.relationActionButtons[a]:t.actionButtons[a];if(!r)return void b.warning(o("translate")("Module.ActionButtonWebhookFail"));const i={},l=[],d=r.parameters.split(","),s=r.headers.split(",");t.webhookRequesting={},t.webhookRequesting[r.id]=!0;for(var u=0;u<d.length;u++){const c=d[u],m=c.split("|"),p=m[0],f=m[1],g=m[2];i[p]=f!==t.module.name?t.record[f]?t.record[f][g]:null:t.record[g]?t.record[g]:null}for(var u=0;u<s.length;u++){const c=s[u],y=c.split("|"),_=y[0],f=y[1],v=y[2],w=y[3];switch(_){case"module":const g=w;l[v]=f!==t.module.name?t.record[f]?t.record[f][g]:null:t.record[g]?t.record[g]:null;break;case"static":switch(w){case"{:app:}":l[v]=e.user.app_id;break;case"{:tenant:}":l[v]=e.user.tenant_id;break;case"{:user:}":l[v]=e.user.id;break;default:l[v]=null}break;case"custom":l[v]=w;break;default:l[v]=null}}if("post"===r.method_type)h.post(r.url,i,{headers:l}).then(function(){b.success(o("translate")("Module.ActionButtonWebhookSuccess")),t.webhookRequesting[r.id]=!1})["catch"](function(){b.warning(o("translate")("Module.ActionButtonWebhookSuccess")),t.webhookRequesting[r.id]=!1});else if("get"===r.method_type){var k="";for(var v in i)k+=v+"="+i[v]+"&";k.length>0&&(k=k.substring(0,k.length-1)),h.get(r.url+"?"+k).then(function(){b.success(o("translate")("Module.ActionButtonWebhookSuccess")),t.webhookRequesting[r.id]=!1})["catch"](function(){b.warning(o("translate")("Module.ActionButtonWebhookFail")),t.webhookRequesting[r.id]=!1})}},t.setDropdownData=function(e){if(e.filters&&e.filters.length>0)t.dropdownFieldDatas[e.name]=null;else if(t.dropdownFieldDatas[e.name]&&t.dropdownFieldDatas[e.name].length>0)return;t.currentLookupField=e,t.lookup().then(function(o){t.dropdownFieldDatas[e.name]=o})},t.getAttachments=function(){a.hasDocumentsPermission(t.operations.read)&&y.getEntityDocuments(e.workgroup.tenant_id,t.id,t.module.id).then(function(o){e.processLanguages(o.data.documents),t.documentsResultSet=y.processDocuments(o.data,e.users),t.documents=t.documentsResultSet.documentList,t.loadingDocuments=!1})},t.getAttachments(),v.run("AfterFormLoaded","script",t),t.changeTab=function(e){t.isActive=[],t.isActive[e.id]=!0,t.grid&&t.grid[e.related_module]&&t.grid[e.related_module].dataSource.read(),t.generateRelationsTable(e)},t.findRequest=[],t.generateRelationsTable=function(a){const n=[];var r={},i="dataItem.id";"many_to_many"===a.relation_type?(t.forManyToManyFielName=t.module.name!==a.related_module?a.related_module+"_id":a.related_module+"1_id",i="dataItem['"+t.forManyToManyFielName+"']",r={module:a.related_module,convert:!0,filters:[{field:t.module.name!==a.related_module?t.module.name+"_id":t.module.name+"1_id",operator:"equals",value:t.id,no:1}],many_to_many:t.module.name,many_to_many_table_name:a.many_to_many_table_name}):r="related_to"===a.relation_type?{module:a.related_module,convert:!0,filters:[{field:"related_to",operator:"equals",value:e.getLanguageValue(t.module.languages,"label","singular"),no:1}],many_to_many:t.module.name,many_to_many_table_name:a.many_to_many_table_name}:{module:a.related_module,convert:!0,filters:[{field:a.relation_field,operator:"equals",value:t.id,no:1}]};for(var l=0;l<a.display_fields.length;l++){const d=a.display_fields[l];var s=void 0;if(d.indexOf(".")>-1){const u=d.split(".");var c={};switch(u[1]){case"users":c=M.getUserModule();break;case"profiles":c=M.getProfileModule();break;case"roles":c=M.getRoleModule();break;default:c=t.modulus[u[1]]}s=Object.assign({},o("filter")(c.fields,{name:u[2]},!0)[0]);var m=o("filter")(t.modulus[a.related_module].fields,{name:u[0]},!0)[0];s.labelExt="("+e.getLanguageValue(m.languages,"label")+")",s.label=s.label||e.getLanguageValue(s.languages,"label"),s.name=d}else s=Object.assign({},o("filter")(t.modulus[a.related_module].fields,{name:d},!0)[0]);s&&g.hasFieldDisplayPermission(s)&&n.push(s)}const p=g.generatRowtmpl(n,!0,{module:t.module,relatedModule:a}),f=t.locale||t.language;r.fields=p.requestFields,t.findRequest[a.id]=r,t.relationsGridOptions[a.id]={dataSource:{serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:function(o){$.ajax({url:"/api/record/find_custom?locale="+f,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(t.findRequest[a.id],o.data)),success:function(e){o.success(e),a.total=e.total,v.run("SubListLoaded","Script",t,t.record,void 0,a.related_module)},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}},rowTemplate:'<tr ng-click="goUrl2('+i+",'"+a.related_module+"')\">"+p.rowtempl+"</tr>",altRowTemplate:'<tr class="k-alt" ng-click="goUrl2('+i+",'"+a.related_module+"')\">"+p.rowtempl+"</tr>",sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100,500],buttonCount:5,info:!0},columns:p.columns}},t.copyHref=function(){d.location.href="#/app/record/"+t.type+"?clone=true&id="+t.record.id+(t.parentId?"&ptype="+t.parentType+"&pid="+t.parentId:"")},t["delete"]=function(){t.executeCode=!1,v.run("BeforeDelete","Script",t,t.record),t.executeCode||g.deleteRecord(t.module.name,t.record.id).then(function(){return b.success(o("translate")("Module.SuccessDeleteRecordMessage")),v.run("AfterDelete","Script",t,t.record),q(),t.parentId?void r.go("app.moduleDetail",{type:t.parentModule,id:t.parentId}):void r.go("app.moduleList",{type:t.type})})},t.showConfirm=function(e){const a=w.confirm().title(o("translate")("Common.AreYouSure")).targetEvent(e).ok(o("translate")("Common.Yes")).cancel(o("translate")("Common.No"));w.show(a).then(function(){t["delete"]()},function(){})};const q=function(){var o=t.module.name+"_"+t.module.name;if(t.parentId){o=(t.relatedToField?"related_to":t.parentType)+t.parentId+"_"+t.module.name;const a=t.parentType+"_"+t.parentType;u.remove(o),u.remove(a)}else u.remove(o),"opportunities"===t.module.name&&u.remove("opportunity"+t.id+"_stage_history");e.activePages&&e.activePages[t.module.name]&&(e.activePages[t.module.name]=null)};t.openExportDialog=function(){t.pdfCreating=!0,t.loadingModal=!0;const e=function(){const e=angular.element(document.body);w.show({parent:e,templateUrl:"view/app/module/modulePdfModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})};t.quoteTemplates?(t.quoteTemplatesOptions={dataSource:o("filter")(t.quoteTemplates,{isShown:!0},!0),dataTextField:"name",dataValueField:"id"},t.quoteTemplate=t.quoteTemplates[0],t.loadingModal=!1,e()):g.getTemplates(t.module.name,"module").then(function(a){if(0===a.data.length)b.warning(o("translate")("Setup.Templates.TemplateNotFound")),t.pdfCreating=!1;else{const n=a.data;t.quoteTemplates=o("filter")(n,{active:!0},!0),t.quoteTemplatesOptions={dataSource:t.quoteTemplates,dataTextField:"name",dataValueField:"id"},t.quoteTemplate=t.quoteTemplates[0],t.loadingModal=!1,e()}})["catch"](function(){t.pdfCreating=!1})},t.showSingleSMSModal=function(){if(!e.system.messaging.SMS)return void b.warning(o("translate")("SMS.NoProvider"));const a=angular.element(document.body);w.show({parent:a,templateUrl:"view/app/sms/singleSMSModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})},t.showQuoteEMailModal=function(){if(!e.system.messaging.SystemEMail&&!e.system.messaging.PersonalEMail)return void b.warning(o("translate")("EMail.NoProvider"));const a=angular.element(document.body);w.show({parent:a,templateUrl:"view/app/email/singleEmailModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})},t.getDownloadUrl=function(a){t.isDownLoad=!0,d.open("/attach/export?module="+t.type+"&id="+t.id+"&templateId="+t.quoteTemplate.id+"&access_token="+s.read("access_token")+"&format="+a+"&locale="+e.locale+"&timezoneOffset="+-1*(new Date).getTimezoneOffset(),"_blank"),b.success(o("translate")("Module.DownloadPdfWordMessage",{value:"pdf"===a?"Pdf":"Word"})),t.isDownLoad=!1},t.close=function(){w.hide()},t.setId=function(e,o,a){t.field=e,a||(t.optionId=o?e.picklist_id:e.id)},t.openCalendar=function(e){var t=void 0;switch(e.data_type){case"date":t="kendoDatePicker";break;case"date_time":t="kendoDateTimePicker";break;case"time":t="kendoTimePicker"}if(t){const o=angular.element(document.getElementById(e.name)).data(t);o&&o.open()}},t.documentDownload=function(e){d.location="storage/record_file_download?fileName="+e};const U=function(){if("users"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){const a={};a.data_type="text_single",a.name="full_name",t.currentLookupField.lookupModulePrimaryField=a}if("profiles"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){const a={};a.data_type="text_single",a.name="name",t.currentLookupField.lookupModulePrimaryField=a}if("roles"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){const a={};a.data_type="text_single",a.name="label_"+e.user.tenantLanguage,t.currentLookupField.lookupModulePrimaryField=a}if("relation"===t.currentLookupField.lookup_type){if(!t.record.related_module)return t.$broadcast("angucomplete-alt:clearInput",t.currentLookupField.name),l.defer().promise;const n=o("filter")(e.modules,{name:t.record.related_module.value},!0)[0];if(!n)return t.$broadcast("angucomplete-alt:clearInput",t.currentLookupField.name),l.defer().promise;t.currentLookupField.lookupModulePrimaryField=o("filter")(n.fields,{primary:!0},!0)[0]}v.run("BeforeLookup","Script",t)};t.closeLightBox=function(){w.hide()},t.showLightBox=function(a,n,r,i,l){if(n){t.showImageData={},t.multiSelectAndTagDatas={};const d=l?e.modulus[l.related_module]:t.module;var s=i?o("filter")(d.fields,{name:i,deleted:!1})[0]:t.primaryField.name;r?t.showImageData={url:a.target.src,title:n[s]||e.getLanguageValue(s.languages,"label"),type:i?"location":"image",map_url:"http://www.google.com/maps/place/"+n[s.name]}:n[i]&&(s=o("filter")(d.fields,{name:i,deleted:!1})[0],t.multiSelectAndTagDatas={array:n[i].split(";"),title:n[s]||e.getLanguageValue(s.languages,"label")}),w.show({contentElement:"#mdLightbox",parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,fullscreen:!1})}},t.formType=null,t.fastNewRecordModal=function(o,a,n,r,i){t.lookupInput.close(),e.fastRecordAddModal(o,a,n,r,i,t)};const E=function(){for(var e=0;2>e;e++){var a=["shared_read","shared_edit"];t["lookupOptions_"+a[e]]={dataSource:new kendo.data.DataSource({transport:{read:function(e){e.success(t.record[t.field]?t.record[t.field]:[])}}}),dataTextField:"name",dataValueField:"id",autoBind:!1,filtering:function(e){e.filter&&t.lookupUserAndGroup(t.module.id,!1,e.filter.value).then(function(e){if(e&&e.length>0){const a=t["lookupOptions_"+t.field].dataSource;a._data=[];for(var n=0;n<e.length;n++){const r=a._data.length>0?o("filter")(a._data,{id:e[n].id},!0)[0]:!1;r||a.add(e[n])}}})}}}};t.goToRecord=function(e,t,o,a){g.goToRecord(e,t,o,a)},t.getTagAndMultiDatas=function(e,t){return t?g.getTagAndMultiDatas(e,t):void 0},t.getImageStyle=function(e,t){return e&&t?g.getImageStyle(e,t.related_module):void 0},t.getRatingCount=function(e,t){return e&&t?g.getRatingCount(e,t.related_module):void 0},t.getLocationUrl=function(e){return e?g.getLocationUrl(e):void 0},t.deleteRelation=function(e,a,n,r){const i=w.confirm().title(o("translate")("Common.AreYouSure")).targetEvent(e).ok(o("translate")("Common.Yes")).cancel(o("translate")("Common.No"));w.show(i).then(function(){const e=R(a.related_module,n,r);var i=void 0;e&&e.length>0&&(i=a.many_to_many_table_name?{records:e,tableName:a.many_to_many_table_name}:e,g.deleteRelation(t.module.name,a.related_module,i).then(function(){b.success(o("translate")("Module.DeleteMessage")),t.grid[a.related_module].dataSource.read(),a.total=a.total-e.length}))},function(){})},t.toolbarRelationOptions=[],t.getRelatedActionButtons=function(a){t.relationActionButtons=[],g.getActionButtons(e.modulus[a.related_module].id).then(function(n){if(n.length>0){var r=o("filter")(n,function(e){return"Detail"!==e.trigger&&"Form"!==e.trigger&&"List"!==e.trigger},!0);if(e.processLanguages(r),t.relationActionButtons["relation"+a.id]=r,r)for(var i=0;i<r.length;i++){var l=r[i];l.module_name=a.related_module,V(l);const d=e.getLanguageValue(l.languages,"label");if("Scripting"===r[i].type&&g.hasActionButtonDisplayPermission(r[i],!1,t.record,t.module)){var s="relation"+a.id,u={template:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown" class="btn '+r[i].color+'"  ng-click="runScript('+i+",'"+s+'\')" aria-label="'+d+'" > <i class="'+r[i].icon+'"></i> <span>'+d+"</span></md-button>",overflowTemplate:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown"  ng-click="runScript('+i+",'"+s+'\')"  class="action-dropdown-item"><i class="'+r[i].icon+'"></i><span> '+d+"</span></md-button>",overflow:"auto"};t.toolbarRelationOptions[s].items.push(u)}if("Webhook"===r[i].type&&g.hasActionButtonDisplayPermission(r[i],!1,t.record,t.module)){var u={template:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown" class="btn '+r[i].color+'"  ng-click="webhookRequest('+i+', true)"   aria-label="'+d+'" > <i class="'+r[i].icon+'"></i> <span>'+d+"</span></md-button>",overflowTemplate:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown" ng-click="webhookRequest('+i+')"  class="action-dropdown-item "><i class="'+r[i].icon+'"></i><span> '+d+" </span></md-button>",overflow:"auto"};t.toolbarRelationOptions["relation"+a.id].items.push(u)}if("ModalFrame"===r[i].type&&g.hasActionButtonDisplayPermission(r[i],!1,t.record,t.module)){var u={template:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown" class="btn '+r[i].color+'"  ng-click="showModuleFrameModal(\''+r[i].url+'\')"   aria-label="'+d+'" > <i class="'+r[i].icon+'"></i> <span>'+d+"</span></md-button>",overflowTemplate:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown"  ng-click="showModuleFrameModal(\''+r[i].url+'\')"   class="action-dropdown-item"><i class="'+r[i].icon+'"></i><span> '+d+" </span></md-button>",overflow:"auto"};t.toolbarRelationOptions["relation"+a.id].items.push(u)}if("CallMicroflow"===r[i].type&&g.hasActionButtonDisplayPermission(r[i],!1,t.record,t.module)){var u={template:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown" class="btn '+r[i].color+'"  ng-click="runMicroflow('+r[i].microflow_id+","+i+","+!0+')"   aria-label="'+d+'" > <i class="'+r[i].icon+'"></i> <span>'+d+"</span></md-button>",overflowTemplate:"<md-button ng-show=\"relationActionButtons['"+s+"']["+i+'].isShown"  ng-click="runMicroflow('+r[i].microflow_id+","+i+","+!0+')"  class="action-dropdown-item"><i class="'+r[i].icon+'"></i><span> '+d+"</span></md-button>",overflow:"auto"};t.toolbarRelationOptions["relation"+a.id].items.push(u)}}}})},t.runMicroflow=function(e,o,a){var n=null;if(n=a?t.relationActionButtons[o]:t.actionButtons[o],t.actionButtonsData={data:{record_ids:[parseInt(t.id)],module_id:t.module.id,record_name:n.record_name},workflow_id:e,button:n},t.buttonsParametersData={},n.parameters){t.showMicroflowParameters=!0,t.showScriptParameters=!1,t.buttonsParameters=JSON.parse(n.parameters),t.picklistItems={},angular.forEach(t.buttonsParameters,function(e){(3===e.type||4===e.type)&&h.get(c.apiUrl+"picklist/get/"+e.lowerType).then(function(o){t.picklistItems[e.key]=o.data})});var r=angular.element(document.body);w.show({parent:r,templateUrl:"view/app/module/actionButtonsParameterModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})}else g.runMicroflow(e,t.actionButtonsData.data).then(function(e){200===e.status&&"popup"===n.message_type&&n.message&&b.success(n.message)})},t.runMicroflowParameters=function(e){e.validate()&&(t.actionButtonsData.data.parameters=t.buttonsParametersData,g.runMicroflow(t.actionButtonsData.workflow_id,t.actionButtonsData.data).then(function(e){200===e.status&&"popup"===t.actionButtonsData.button.message_type&&t.actionButtonsData.button.message&&b.success(t.actionButtonsData.button.message)}),t.closeLightBox())},t.numberOptionsButtons={format:"{0:n0}",decimals:0},t.getModuleFields=function(){return o("filter")(t.module.fields,function(e){return e.display_detail&&g.hasFieldDisplayPermission(e)},!0)},t.openAddModal=function(o,a){t.currentRelateModule=a,t.manyToManyModule=t.modulus[a.related_module],t.manyToManyModule.gridName=t.manyToManyModule.name+"-manytomany",t.manyToManyModule.related_module=t.manyToManyModule.name,t.manyToManyModule.tableName=a.many_to_many_table_name;const n=[];n.push(t.manyToManyModule.primaryField);const r=g.generatRowtmpl(n,!0,{relatedModule:t.manyToManyModule,moduleName:t.manyToManyModule.name,tableOptinosMenuHide:!0}),i={module:t.manyToManyModule.name,convert:!0,filters:[],fields:r.requestFields};r.rowtempl=r.rowtempl.replaceAll(t.manyToManyModule.name,t.manyToManyModule.gridName),r.rowtempl=r.rowtempl.replaceAll('id="{{dataItem.id}}"','id="'+t.manyToManyModule.gridName+'{{dataItem.id}}"'),r.rowtempl=r.rowtempl.replaceAll('for="{{dataItem.id}}"','for="'+t.manyToManyModule.gridName+'{{dataItem.id}}"');const l=t.locale||t.language;t.manyToManyGridOptions={dataSource:{serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:function(t){$.ajax({url:"/api/record/find_custom?locale="+l,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(i,t.data)),success:function(e){t.success(e)},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}},rowTemplate:"<tr>"+r.rowtempl+"</tr>",altRowTemplate:'<tr class="k-alt">'+r.rowtempl+"</tr>",sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100,500],buttonCount:5,info:!0},columns:[{width:"60px",headerTemplate:'<input type="checkbox" id="header-chb-'+t.manyToManyModule.gridName+"'\" ng-model=\"isAllSelected['"+t.manyToManyModule.gridName+"']\" ng-click=\"selectAll($event,'"+t.manyToManyModule.gridName+'\')" id="header-chb-manytomany" class="k-checkbox header-checkbox"><label class="k-checkbox-label" for="header-chb-'+t.manyToManyModule.gridName+"'\"></label>"},{field:t.manyToManyModule.primaryField.name,media:"(min-width: 575px)",title:e.getLanguageValue(t.manyToManyModule.primaryField.languages,"label")},{title:"Items",media:"(max-width: 575px)"}]};const d=angular.element(document.body);w.show({parent:d,templateUrl:"view/app/module/moduleAddModal.html",clickOutsideToClose:!0,targetEvent:o,scope:t,preserveScope:!0}),t.isAllSelected[t.manyToManyModule.gridName]=!1},t.addRecords=function(){const e=t.selectedRecords[t.manyToManyModule.gridName];if(!e.length)return void b.warning(o("translate")("Module.NoRecordSelected"));t.recordsAdding=!0;const a=[];for(var n=0;n<e.length;n++){var r={};r[t.module.name+"_id"]=t.id,r[t.manyToManyModule.name+"_id"]=e[n],a.push(r)}const i={tableName:t.manyToManyModule.tableName,records:a};g.addRelations(t.module.name,t.manyToManyModule.name,i).then(function(){t.recordsAdding=!1,t.refreshGrid(t.manyToManyModule.name),t.closeLightBox()})},t.controlRemove=function(e,o){return e.showRemove=t.hasPermission(o?o.related_module:t.module.name,p.remove)},t.controlCopy=function(e,o){return e.showCopy=t.hasPermission(o?o.related_module:t.module.name,p.write)},t.controlEdit=function(e,o){return e.showEdit=t.hasPermission(o?o.related_module:t.module.name,p.modify)},angular.element(document).ready(function(){t.fileNotSelected=!1,t.moduleForm.options.rules.range=g.rangeRuleForForms(),m(function(){},500)}),t.showAddNewTagButton=function(e){if(e){const t=angular.element(document.getElementById(e)).data("kendoMultiSelect");if(t)return""!==t._prev}return!1},t.runScript=function(e,o){var a=null;if(a=o?t.relationActionButtons[o][e]:t.actionButtons[e],t.buttonsParametersData={},t.actionButtonsData={data:{record_ids:[parseInt(t.id)],module_id:t.module.id,record_name:a.record_name},button:a},a.parameters&&"CallMicroflow"===a.type){t.showMicroflowParameters=!1,t.showScriptParameters=!0,t.buttonsParameters=JSON.parse(a.parameters);var n=angular.element(document.body);w.show({parent:n,templateUrl:"view/app/module/actionButtonsParameterModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})}else S.run(t,a.template)},t.runScriptParameters=function(e){e.validate()&&(t.actionButtonsData.data.parameters=t.buttonsParametersData,S.run(t,t.actionButtonsData.button.template),t.closeLightBox())};var V=function(e){e.isShown=!1,e.dependent_field?t.record[e.dependent_field]&&t.record[e.dependent_field].labelStr==e.dependent&&(e.isShown=!0):e.isShown=!0};t.downloadImg=function(e){if(e){const t=e.split("/"),o=t[t.length-1];h({method:"GET",url:e,responseType:"arraybuffer"}).then(function(e){if(e.data){const t=new Uint8Array(e.data),a=new Blob([t],{type:"application/octet-stream"});saveAs(a,o)}},function(){})}},t.languageOptions=g.getLanguageOptions(),t.backToText=o("translate")("Common.BackTo",{moduleName:e.getLanguageValue(t.module.languages,"label","plural")})}]);