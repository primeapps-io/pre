"use strict";angular.module("primeapps").controller("RecordController",["$rootScope","$scope","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","config","$timeout","operations","FileUploader","ModuleService","DocumentService","$http","resizeService","components","mdToast","$mdDialog","exportFile",function(e,t,a,o,r,n,i,l,d,s,u,c,p,m,f,g,h,v,_,y,k,b,w){function F(e,a){var o=e.data;o[0]&&o[0].total_count?a.total=o[0].total_count:delete a.total,("flat"===a.detail_view_type||"flat"===t.module.detail_view_type)&&t.returnParentType===a.id&&(t.activeType="tab",t.tab="general"),t.isActive[n.params.rptype]=!0}t.formType||(t.type=i.type,t.subtype=i.stype,t.id=r.search().id,t.parentType=r.search().ptype,t.parentId=r.search().pid,t.returnTab=r.search().rtab,t.previousParentType=r.search().pptype,t.previousParentId=r.search().ppid,t.previousReturnTab=r.search().prtab,t.back=r.search().back,t.many=r.search().many,t.clone=r.search().clone,t.revise=r.search().revise,t.paramField=r.search().field,t.paramValue=r.search().value,t.fastRecordModal=!1),t.isDisabled=!1,t.actionButtonDisabled=!1,t.operations=m,t.hasPermission=o.hasPermission,t.hasDocumentsPermission=o.hasDocumentsPermission,t.hasAdminRights=o.hasAdminRights,t.hasFieldFullPermission=g.hasFieldFullPermission,t.hasSectionFullPermission=g.hasSectionFullPermission,t.hasActionButtonDisplayPermission=g.hasActionButtonDisplayPermission,t.lookupUserAndGroup=o.lookupUserAndGroup,t.lookupUser=o.lookupUser,t.loading=!0,t.image={},t.document={},t.hasProcessEditPermission=!1,t.userAdded=!1,t.isActive={},t.tab="general",t.customLeaveFields={},t.allFields=[],t.isAdmin=e.user.profile.has_admin_rights,t.googleMapsApiKey=googleMapsApiKey,t.relationsGridOptions=[],t.showHelp=!1,t.goUrl2=function(e,t){var a=window.getSelection();0===a.toString().length&&(window.location="#/app/record/"+t+"?id="+e)},t.imageDownload=function(e,t){d.download(e,t)},t.parentId&&d.scrollTo(0,0),t.module=e.modulus[t.type];var S=a("filter")(t.module.helps,function(e){return"side_modal"===e.modal_type&&("module_detail"===e.module_type||"module_form"===e.module_type)},!0)[0];if(S&&(t.showHelp=!0),t.preview&&t.module.sections&&t.module.sections.length>0)for(var M=0;M<t.module.sections.length;M++)("system"===t.module.sections[M].name||"system_information"===t.module.sections[M].name)&&(t.module.sections[M].display_detail=!0);t.module.sections=a("filter")(t.module.sections,function(e){return(e.display_form||e.display_detail)&&!e.deleted}),e.breadcrumblist=[{title:a("translate")("Layout.Menu.Dashboard"),link:"#/app/dashboard"},{title:t.module["label_"+t.language+"_plural"],link:"#/app/modules/"+t.module.name},{title:t.title}];for(var M=0;M<t.module.fields.length;M++){var T=t.module.fields[M];g.hasFieldDisplayPermission(T)&&t.allFields.push(angular.copy(T))}if(t.tabconfig=t.module.detail_view_type?"flat"!==t.module.detail_view_type?!0:!1:"flat"!==e.detailViewType?!0:!1,t.module.default_tab&&(t.tab=t.module.default_tab),y.run("BeforeFormLoaded","script",t),t.currentSectionComponentsTemplate=currentSectionComponentsTemplate,!t.id)for(var P=0;P<t.module.fields.length;P++){var T=t.module.fields[P];T.show_lock&&(T.show_lock=!1)}if(e.activeModuleName=t.parentType,!t.module)return k.warning(a("translate")("Common.NotFound")),void n.go("app.dashboard");t.dropdownFields=a("filter")(t.module.fields,{data_type:"lookup",show_as_dropdown:!0},!0),t.dropdownFieldDatas={};for(var M=0;M<t.dropdownFields.length;M++)t.dropdownFieldDatas[t.dropdownFields[M].name]=[];if(!t.id&&!t.hasPermission(t.type,t.operations.write))return k.error(a("translate")("Common.Forbidden")),void n.go("app.dashboard");t.primaryField=a("filter")(t.module.fields,{primary:!0})[0],t.currentUser=g.processUser(e.user),t.currentDayMin=o.getCurrentDateMin().toISOString(),t.currentDayMax=o.getCurrentDateMax().toISOString(),t.currentHour=o.floorMinutes(new Date),t.relatedToField=a("filter")(t.module.fields,{name:"related_to"},!0)[0],t.record={},t.formType&&t.recordModal&&(t.record=t.recordModal),t.id||(t.title=a("translate")("Module.New",{title:t.module["label_"+e.language+"_singular"]}));for(var C=0;C<e.approvalProcesses.length;C++){var D=e.approvalProcesses[C];D.module_id===t.module.id&&(t.currentModuleProcess=D)}if(t.currentModuleProcess)for(var R=t.currentModuleProcess.profiles.split(","),M=0;M<R.length;M++)R[M]===e.user.profile.id.toString()&&(t.hasProcessEditPermission=!0);if(t.parentType)if(t.many)t.parentModule=t.parentType;else{var A=a("filter")(t.module.fields,{name:t.parentType},!0)[0];A?t.parentModule=A.lookup_type:(t.parentType=null,t.parentId=null)}t.picklistFilter=function(){return function(e){return t.componentFilter={},t.componentFilter.item=e,t.componentFilter.result=!0,y.run("PicklistFilter","Script",t),!e.hidden&&!e.inactive&&t.componentFilter.result}};var I=function(e){var o=!1;if(1===e.process_status)return!0;if(t.module.dependencies.length>0)for(var r=a("filter")(t.module.dependencies,{dependency_type:"freeze",deleted:!1},!0),n=0;n<r.length;n++)for(var i=r[n],l=a("filter")(t.module.fields,{name:i.parent_field},!0),d=0;d<l.length;d++){var s=l[d];if(i.values_array&&i.values_array.length>0)for(var u=0;u<i.values_array.length;u++){var c=parseInt(i.values_array[u]);!e[s.name]||c!==e[s.name]&&c!==e[s.name].id||(o=!0)}}return e.freeze=o?o:void 0,o};t.addNewTagItem=function(e){var o=t["tagOptions"+t.optionId].dataSource;if(e||o._filter){e=e||o._filter.filters[0].value;var r=0;if(o._data.length>0){var n=a("orderBy")(o._data,"id");r=n[n.length-1].id+1}var i={text:e,id:r};o.add(i);var l=o.data().find(function(t){return t.text===e});l&&(t.record[t.field.name]||(t.record[t.field.name]=[]),t.record[t.field.name].push(i.id))}},t.getRecord=function(o){o&&(t.loading=o),g.getPicklists(t.module).then(function(o){t.picklistsModule=o;var r=a("filter")(t.module.fields,{name:"owner"},!0)[0],i=function(){for(var o=0;o<t.module.fields.length;o++){var r=t.module.fields[o];if(g.setDependency(r,t.module,t.record,t.picklistsModule,t),(!t.record.id&&r.default_value&&"picklist"===r.data_type||r.default_value&&"picklist"===r.data_type&&t.record[r.name]&&parseInt(r.default_value)===t.record[r.name].id)&&(t.record[r.name]=t.record[r.name]||a("filter")(t.picklistsModule[r.picklist_id],{id:r.default_value})[0],t.fieldValueChange(r)),"picklist"!==r.data_type||r.deleted||(t["customOptions"+r.picklist_id]={dataSource:new kendo.data.DataSource({transport:{read:function(e){e.success(a("filter")(t.picklistsModule[t.optionId],function(e){return t.componentFilter={},t.componentFilter.item=e,t.componentFilter.result=!0,y.run("PicklistFilter","Script",t),!e.hidden&&!e.inactive&&t.componentFilter.result},!0))}}}),dataTextField:"label_"+t.language,dataValueField:"id",filter:t.picklistsModule[r.picklist_id].length>10?"startswith":null,autoBind:!1,optionLabel:a("translate")("Common.Select")}),"multiselect"!==r.data_type||r.deleted||(t["customOptions"+r.picklist_id]={dataSource:new kendo.data.DataSource({data:a("filter")(t.picklistsModule[r.picklist_id],function(e){return t.componentFilter={},t.componentFilter.item=e,t.componentFilter.result=!0,y.run("PicklistFilter","Script",t),!e.hidden&&!e.inactive&&t.componentFilter.result},!0)}),tagMode:t.id&&t.record[r.name].length<=5?"multiple":"single",dataTextField:"label_"+t.language,dataValueField:"id",filter:"contains",valuePrimitive:!0,autoClose:!1,optionLabel:a("translate")("Common.Select"),change:function(e){var o=e.sender.element[0].name;if(o){var r=a("filter")(t.module.fields,{name:o,deleted:!1},!0)[0];r&&t.fieldValueChange(r)}var n=this.value(),i=this.options.tagMode,l=i;l=n.length<=5?"multiple":"single",l!==i&&(this.value([]),this.setOptions({tagMode:l}),this.value(n))}}),"tag"===r.data_type&&!r.deleted){var n=new kendo.data.DataSource({transport:{read:{url:"/api/tag/get_tag/"+r.id,type:"GET",dataType:"json",beforeSend:e.beforeSend()}}});n.read().then(function(){var e=n.view();if(e&&e.length>0){var o=a("filter")(t.module.fields,{id:e[0].field_id,deleted:!1},!0)[0];if(o)for(var r=0;r<t.record[o.name].length;r++)t.record[o.name][r]=a("filter")(e,{text:t.record[o.name][r]},!0)[0].id}}),t["tagOptions"+r.id]={dataSource:n,dataTextField:"text",dataValueField:"id",valuePrimitive:!0,filter:"contains",tagMode:t.id&&t.record[r.name].length<=5?"multiple":"single",noDataTemplate:'#var value = instance.input.val(); # <div>No data found. </div><div style="text-transform: inherit">Do you want to add new item ?</div><md-button class="btn btn-secondary" ng-click="addNewTagItem(#:value#)" aria-label="New Item"> <i class="fas fa-plus"></i> <span>#:value#</span></md-button></div>',change:function(){var e=this.value(),t=this.options.tagMode,a=t;a=e.length<=5?"multiple":"single",a!==t&&(this.value([]),this.setOptions({tagMode:a}),this.value(e))}}}"lookup"!==r.data_type||r.deleted||(t["lookupOptions"+r.id]={dataSource:{serverFiltering:!0,transport:{read:function(a){var o={module:t.currentLookupField.lookup_type,convert:!1};if(!a.data.filter||a.data.filter&&0===a.data.filter.filters.length){a.data.filter={},a.data.filter.filters=[],a.data.filter.logic="and";var r=t.record[t.currentLookupField.name]?t.record[t.currentLookupField.name][t.currentLookupField.lookupModulePrimaryField.name]:"";L(),a.data.filter.filters.push({field:t.currentLookupField.lookupModulePrimaryField.name,operator:t.currentLookupField.lookup_search_type&&""!==t.currentLookupField.lookup_search_type?t.currentLookupField.lookup_search_type.replace("_",""):"startswith",value:t.record[t.currentLookupField.name]&&r?r:""})}if(a.data.filter.filters.length>0){var n=a.data.filter.filters[0].operator;n.contains("_")&&(a.data.filter.filters[0].operator=""!==n?n.replace("_",""):"startswith"),t.lookupSearchValue=a.data.filter.filters[0].value!==t["lookupOptions"+t.currentLookupField.id].optionLabel?a.data.filter.filters[0].value:""}$.ajax({url:"/api/record/find_custom",contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(o,a.data)),success:function(e){a.success(e)},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}},optionLabel:a("translate")("Common.Select"),autoBind:!1,dataTextField:r.lookupModulePrimaryField.name,dataValueField:"id",noDataTemplate:'<div>No data found. </div><div ng-if="(field.name !== \'owner\' || formType === \'null\') && field.lookup_type !== \'users\'"><div style="text-transform: inherit" ng-if="lookupSearchValue!==\'\'">Do you want to add new item ?</div><md-button ng-if="lookupSearchValue!==\'\'" class="btn btn-secondary" ng-click="fastNewRecordModal(field.lookup_type,true,lookupSearchValue,field.name)"> <i class="fas fa-plus"></i> <span>{{lookupSearchValue}}</span></md-button></div>'}),"rating"!==r.data_type||r.deleted||(t["ratingOption"+r.id]={max:r.max||5,precision:"half",value:t.record[r.name]})}};if(y.run("BeforeFormPicklistLoaded","Script",t),!t.id){if(t.loading=!1,t.record.owner=t.currentUser,t.record.owner.full_name=t.currentUser.primary_value,t.parentId){var d=a("filter")(e.modules,{name:t.parentModule},!0)[0];g.getRecord(t.parentModule,t.parentId).then(function(e){var r=a("filter")(d.fields,{primary:!0,deleted:!1},!0)[0],n={};if(n.id=e.data.id,n.primary_value=e.data[r.name],t.relatedToField)t.record.related_to=n,t.record.related_module=a("filter")(o[9e5],{value:t.parentType},!0)[0];else{t.record[t.parentType]=n;var l=a("filter")(t.module.dependencies,{dependent_field:t.parentType},!0)[0];if(l&&l.deleted!==!0){var s=a("filter")(t.module.fields,{name:l.field},!0)[0];t.record[l.field]=a("filter")(t.picklistsModule[s.picklist_id],{id:l.values[0]},!0)[0];var u=a("filter")(t.module.fields,{name:l.dependent_field},!0)[0];u.hidden=!1}i()}})}else i();return g.setDefaultValues(t.module,t.record,o),g.setDisplayDependency(t.module,t.record),y.run("FieldChange","Script",t,t.record,r),void q()}if(g.getRecord(t.module.name,t.id).then(function(o){if(0===Object.keys(o.data).length)return k.error(a("translate")("Common.Forbidden")),void n.go("app.dashboard");var l=g.processRecordSingle(o.data,t.module,t.picklistsModule);if(q(),!t.hasPermission(t.type,t.operations.modify,o.data)||I(l)&&!t.hasAdminRights)return k.error(a("translate")("Common.Forbidden")),void n.go("app.dashboard");y.run("BeforeFormRecordLoaded","Script",t,l),g.formatRecordFieldValues(angular.copy(o.data),t.module,t.picklistsModule),t.title=t.primaryField.valueFormatted,e.breadcrumblist[2].title=t.title,t.recordState=angular.copy(l),g.setDisplayDependency(t.module,l);for(var d=0;d<t.module.fields.length;d++){var s=t.module.fields[d],u=!1;if(s.encrypted&&s.encryption_authorized_users_list.length>0&&l[s.name])for(var c=0;c<s.encryption_authorized_users_list.length;c++){var p=s.encryption_authorized_users_list[c];e.user.id===parseInt(p)&&(u=!0)}s.show_lock=s.encrypted&&!u?!0:!1}if(t.relatedToField&&l.related_to){var m=a("filter")(e.modules,{id:l[t.relatedToField.lookup_relation].id-9e5},!0)[0],f=a("filter")(m.fields,{primary:!0},!0)[0];g.getRecord(m.name,l.related_to,!0).then(function(e){e=e.data,e.primary_value=e[f.name],l.related_to=e,t.record=l,t.recordState=angular.copy(t.record),i(),t.module&&t.module.fields&&t.module.fields.length>0&&t.fieldValueChange(t.module.fields[0]),t.loading=!1})["catch"](function(e){404===e.status&&(l.related_to=null,t.record=l,t.recordState=angular.copy(t.record)),t.loading=!1})}else t.record=l,i(),t.clone&&(t.record.owner=t.currentUser),t.loading=!1;t.record.currency&&(t.currencySymbol=t.record.currency.value||e.currencySymbol),g.customActions(t.module,t.record),y.run("FieldChange","Script",t,t.record,r),y.run("AfterFormRecordLoaded","Script",t)})["catch"](function(){t.loading=!1}),t["export"]=function(o){if(!(o.total<1)){var r=!1;try{r=!!new Blob}catch(n){}if(!r)return void k.messages(a("translate")("Module.ExportUnsupported"));if(o.total>3e3)return void k.messages(a("translate")("Module.ExportWarning"));var i=o["label_"+e.language+"_plural"]+"-"+a("date")(new Date,"dd-MM-yyyy")+".xls";t.exporting=!0,g.getCSVData(t,o).then(function(e){k.success(a("translate")("Module.ExcelExportSuccess")),w.excel(e,i),t.exporting=!1})}},t.selectedRows={},t.selectedRecords={},t.isAllSelected={},t.module.relations)for(var s=[],u=0;u<t.module.relations.length;u++){var c=t.module.relations[u];if(t.selectedRows[c.related_module]=[],t.selectedRecords[c.related_module]=[],t.isAllSelected[c.related_module]=!1,c.deleted)return;var p=a("filter")(e.modules,{name:c.related_module},!0)[0],m={};if("many_to_many"===c.relation_type){if(!p)return;var f=a("filter")(p.fields,{primary:!0},!0)[0],h=c.related_module+"_id."+c.related_module+"."+f.name;m={fields:["total_count()",h],filters:[{field:t.module.name+"_id",operator:"equals",value:t.id,no:1}],limit:1,offset:0,many_to_many:t.module.name}}else m={fields:["total_count()"],filters:[{field:c.relation_field,operator:"equals",value:t.id,no:1}],limit:1,offset:0};("flat"===c.detail_view_type||"flat"===t.module.detail_view_type)&&t.generateRelationsTable(c),s.push(g.findRecords(c.related_module,m))}l.all(s).then(function(e){for(var a=0;a<e.length;a++)F(e[a],t.module.relations[a])}),y.run("AfterFormPicklistLoaded","Script",t)})},t.getRecord(),t.grid=[],t.isOpen=!1,t.demo={isOpen:!1,count:1e3,selectedDirection:"left"},t.selectRow=function(e,a,o){a.isChecked=e.target.checked,t.selectedRecords[o]=[];for(var r=t.grid[o].dataSource.data(),n=!0,i=0;i<r.length;i++)r[i].isChecked?t.selectedRecords[o].push(r[i].id):(t.isAllSelected[o]=!1,n=!1);n&&(t.isAllSelected[o]=!0)},t.isOpenTest=!1,t.selectAll=function(e,a){var o=t.grid[a].dataSource.data();t.selectedRecords[a]=[];for(var r=0;r<o.length;r++)o[r].isChecked=e.target.checked,e.target.checked&&t.selectedRecords[a].push(o[r].id);e.target.checked&&(t.isOpenTest=!0)},t.refreshGrid=function(e){t.grid[e].dataSource.read()},t.setCurrentLookupField=function(e,a){t.currentLookupField=e,a&&(t.lookupInput=a,t.lookupSearchValue=a._prev)},t.uploader=new f({url:"storage/record_file_upload"}),t.entityIdFunc=function(){return t.recordId},t.recordDelete=function(e,r,n){var i=b.confirm().title(a("translate")("Common.AreYouSure")).targetEvent(e).ok(a("translate")("Common.Yes")).cancel(a("translate")("Common.No"));b.show(i).then(function(){g.getRecord(n,r).then(function(e){if(!o.hasPermission(t.type,m.modify,e.data))return void k.error(a("translate")("Common.Forbidden"));var i=e;t.executeCode=!1,y.run("BeforeDelete","Script",t,i),t.executeCode||g.deleteRecord(n,r).then(function(){t.refreshGrid(n),k.success(a("translate")("Module.DeleteMessage")),t.isAllSelected[n]=!1})})},function(){t.status="You decided to keep your debt."})},t.deleteSelectedsSubTable=function(e,o){var r=b.confirm().title(a("translate")("Common.AreYouSure")).targetEvent(e).ok(a("translate")("Common.Yes")).cancel(a("translate")("Common.No"));b.show(r).then(function(){g.deleteRecordBulk(o,t.selectedRecords[o]).then(function(){t.refreshGrid(o),t.selectedRecords[o]=[],t.selectedRows[o]=[],t.isAllSelected[o]=!1})},function(){t.status="You decided to keep your debt."})},t.submit=function(o,r){function i(){for(var e=!0,o=0;o<t.module.fields.length;o++){var r=t.module.fields[o];if((s[r.name]||"date"===r.data_type||"date_time"===r.data_type||"time"===r.data_type)&&("lookup"===r.data_type&&"object"!=typeof s[r.name]&&(e=!1),"image"===r.data_type&&t.image[r.name]&&t.image[r.name].UniqueName&&null!=s[r.name]&&(s[r.name]=t.image[r.name].UniqueName),"document"===r.data_type&&t.document[r.name]&&t.document[r.name].UniqueName&&null!=s[r.name]&&(s[r.name]=t.document[r.name].UniqueName),("date"===r.data_type||"date_time"===r.data_type||"time"===r.data_type)&&delete s[r.name+"str"],"tag"===r.data_type))for(var n=0;n<s[r.name].length;n++){var i=a("filter")(t["tagOptions"+r.id].dataSource._view,{id:parseInt(s[r.name][n])},!0)[0];i&&(s[r.name][n]=i.text)}}return e}function l(o){t.addedUser=!1,t.recordId=o.id,t.uploader.queue.length>0&&(t.uploader.onCompleteAll(),t.uploader.uploadAll()),y.run("BeforeFormSubmitResult","Script",t,o),t.success=function(){var r=o[t.module.primaryField.name]?o[t.module.primaryField.name]:t.title;k.success(!t.id||t.clone?r+" "+a("translate")("Module.SuccessfullyAdded"):r+" "+a("translate")("Module.SuccessfullyUpdated"));var i={type:t.type,id:o.id};t.parentId&&(i.type=t.parentModule,i.id=t.parentId,i.rptype=t.returnTab,t.previousParentType&&(i.rpptype=t.previousParentType,i.rppid=t.previousParentId,i.rprtab=t.previousReturnTab)),t.back&&(i.back=t.back);var l=t.module.name+"_"+t.module.name;if(t.parentId){l=(t.relatedToField?"related_to":t.parentType)+t.parentId+"_"+(t.many?t.many:t.module.name);var d=t.parentType+"_"+t.parentType;u.remove(l),u.remove(d)}else u.remove(l);e.activePages&&e.activePages[t.module.name]&&(e.activePages[t.module.name]=null),t.fastRecordModal?(b.hide(),g.getRecord(t.type,t.recordId).then(function(e){var a=e.data,o=t.lookupName;if(t.modalCustomScopeRecord[o]=a,t.fastRecordModal){var r=angular.element(document.getElementById(o)).data("kendoDropDownList");r.value(a.id)}})):n.go("app.moduleList",{type:t.module.name})},t.success()}function d(o,r){if(t.addedUser=!1,409===r){var n=a("filter")(t.module.fields,{name:o.field,deleted:!1})[0];k.warning(a("translate")("Common.Conflict",{fieldName:n["label_"+e.language],value:t.record[o.field]}))}}var s=angular.copy(r);if(t.moduleForm=o,t.submitting=!0,!t.moduleForm.validate()||!i())return t.submitting=!1,void k.error(a("translate")("Module.RequiredError"));if(y.run("BeforeFormSubmit","Script",t,s),!t.id||t.clone){if(t.executeCode=!1,y.run("BeforeCreate","Script",t,s),t.executeCode)return void(t.submitting=!1)}else if(t.executeCode=!1,y.run("BeforeUpdate","Script",t,s),t.executeCode)return void(t.submitting=!1);if(e.branchAvailable&&t.branchManager){for(var p=0;p<t.record.Authorities.length;p++){var m=t.record.Authorities[p],f=a("filter")(t.authorities,{user_id:m.id},!0)[0];f||v.post(c.apiUrl+"user_custom_shares/create/",{shared_user_id:t.branchManager.id,user_id:m.id})}for(var p=0;p<t.authorities.length;p++){var m=t.authorities[p],f=a("filter")(t.record.Authorities,{id:m.user_id},!0)[0];f||v["delete"](c.apiUrl+"user_custom_shares/delete/"+m.id)}}if(delete s.Authorities,t.clone){delete t.record.created_at,delete t.record.created_by,delete t.record.updated_at,delete t.record.updated_by;for(var p=0;p<t.module.fields.length;p++){var h=t.module.fields[p];"number_auto"===h.data_type&&delete s[h.name]}t.recordState=null}s=g.prepareRecord(s,t.module,t.recordState);angular.copy(t.record);if(t.id){for(var _=0;_<t.module.fields.length;_++){var h=t.module.fields[_],w=!1;if(h.encrypted&&h.encryption_authorized_users_list.length>0&&s[h.name])for(var F=0;F<h.encryption_authorized_users_list.length;F++){var S=h.encryption_authorized_users_list[F];e.user.id===parseInt(S)&&(w=!0)}h.encrypted&&!w&&delete s[h.name]}t.clone?(t.revise&&(s.master_id=s.id),delete s.id,delete s.process_id,delete s.process_status,delete s.process_status_order,delete s.process_request_updated_at,delete s.process_request_updated_by,delete s.operation_type,s.auto_id&&(s.auto_id=""),g.insertRecord(t.module.name,s).then(function(e){s.master_id||(t.submitting=!1,l(e.data)),y.run("AfterCreate","Script",t,s)})["catch"](function(e){d(e.data,e.status),t.submitting=!1})):g.updateRecord(t.module.name,s).then(function(o){var r=a("filter")(e.approvalProcesses,{module_id:t.module.id},!0);if(r){for(var n=!1,i=0;i<r.length;i++)(0===r[i].user_id||r[i].user_id===t.currentUser.id)&&r[i].operations.indexOf("update")>-1&&(n=!0);n?setTimeout(function(){l(o.data)},2e3):l(o.data)}else l(o.data);y.run("AfterUpdate","Script",t,s)})["catch"](function(e){d(e.data,e.status)})["finally"](function(){var o=a("filter")(e.approvalProcesses,{module_id:t.module.id},!0);if(o){for(var r=!1,n=0;n<o.length;n++)(0===o[n].user_id||o[n].user_id===t.currentUser.id)&&o[n].operations.indexOf("update")>-1&&(r=!0);r?setTimeout(function(){t.submitting=!1},2e3):t.submitting=!1}else t.submitting=!1})}else g.insertRecord(t.module.name,s).then(function(o){var r=a("filter")(e.approvalProcesses,{module_id:t.module.id},!0);if(r){for(var n=!1,i=0;i<r.length;i++)(0===r[i].user_id||r[i].user_id===t.currentUser.id)&&r[i].operations.indexOf("insert")>-1&&(n=!0);n?setTimeout(function(){l(o.data)},2e3):l(o.data)}else l(o.data);y.run("AfterCreate","Script",t,s)})["catch"](function(e){d(e.data,e.status)})["finally"](function(){var o=a("filter")(e.approvalProcesses,{module_id:t.module.id},!0);if(o){for(var r=!1,n=0;n<o.length;n++)(0===o[n].user_id||o[n].user_id===t.currentUser.id)&&o[n].operations.indexOf("insert")>-1&&(r=!0);r?setTimeout(function(){t.submitting=!1},2e3):t.submitting=!1}else t.submitting=!1})},t.calculate=function(e){g.calculate(e,t.module,t.record)},t.fieldValueChange=function(o){if(o.valueChangeDontRun)return void delete o.valueChangeDontRun;if(g.setDependency(o,t.module,t.record,t.picklistsModule,t),g.setDisplayDependency(t.module,t.record),g.setCustomCalculations(t.module,t.record,t.picklistsModule,t),g.customActions(t.module,t.record,t.moduleForm,t.picklistsModule,t),y.run("FieldChange","Script",t,t.record,o),t.record.currency&&(t.currencySymbol=t.record.currency.value||e.currencySymbol),"picklist"===o.data_type){var r=a("filter")(t.module.dependencies,function(e){return e.parent_field===o.name&&("list_field"===e.dependency_type||"list_value"===e.dependency_type)},!0);if(!r||!r.length)return;for(var n=0;n<r.length;n++){var i=r[n];if(!i.deleted){var l=a("filter")(t.module.fields,{name:i.child_field},!0)[0];t.optionId=l.picklist_id,t["customOptions"+t.optionId].dataSource.read()}}}},t.hideCreateNew=function(e){return"users"===e.lookup_type?!0:"relation"!==e.lookup_type||t.record.related_module?!1:!0},t.openFormModal=function(e){t.primaryValueModal=e;var a=angular.element(document.body);b.show({parent:a,templateUrl:"view/app/module/moduleFormModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})},g.getActionButtons(t.module.id).then(function(e){t.actionButtons=e,t.toolbarOptions={resizable:!0,items:[]};for(var a=0;e.length>a;a++)if("List"!==e[a].trigger&&"Relation"!==e[a].trigger){if("Scripting"===e[a].action_type&&t.hasActionButtonDisplayPermission(e[a])){var o={template:'<md-button class="btn btn-secondary" ng-click="customScripting('+[a]+')" aria-label="'+e[a].name+'" > <i class="'+e[a].icon+'"></i> <span>'+e[a].name+"</span></md-button>",overflowTemplate:'<md-button ng-click="customScripting('+[a]+')"  class="action-dropdown-item"><i class="'+e[a].icon+'"></i><span> '+e[a].name+"</span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(o)}if("Webhook"===e[a].action_type&&t.hasActionButtonDisplayPermission(e[a])){var o={template:'<md-button class="btn btn-secondary '+e[a].css_class+'"  ng-click="webhookRequest('+a+')"   aria-label="'+e[a].name+'" > <i class="'+e[a].icon+'"></i> <span>'+e[a].name+"</span></md-button>",overflowTemplate:'<md-button ng-click="webhookRequest('+a+')"  class="action-dropdown-item "><i class="'+e[a].icon+'"></i><span> '+e[a].name+" </span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(o)}if("ModalFrame"===e[a].action_type&&t.hasActionButtonDisplayPermission(e[a])){var o={template:'<md-button class="btn btn-secondary '+e[a].css_class+'"  ng-click="showModuleFrameModal(\''+e[a].url+'\')"   aria-label="'+e[a].name+'" > <i class="'+e[a].icon+'"></i> <span>'+e[a].name+"</span></md-button>",overflowTemplate:"<md-button  ng-click=\"showModuleFrameModal('"+e[a].url+'\')"   class="action-dropdown-item '+e[a].css_class+'"><i class="'+e[a].icon+'"></i><span> '+e[a].name+" </span></md-button>",overflow:"auto"};t.toolbarOptions.items.push(o)}}}),t.showModuleFrameModal=function(e){if(new RegExp("https:").test(e)){var a,o,r;a="myPop1",o=document.body.offsetWidth-200,r=document.body.offsetHeight-200;var n=screen.width/2-o/2,i=screen.height/2-r/2;window.open(e,a,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+o+", height="+r+", top="+i+", left="+n)}else t.frameUrl=e},t.openLocationModal=function(e){t.filedName=e;var a=angular.element(document.body);b.show({parent:a,controller:"locationFormModalController",templateUrl:"view/app/location/locationFormModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})},t.removeDocument=function(a){var r={};r.module=t.module.name,r.recordId=t.record.id,r.fieldName=a.name,r.fileNameExt=o.getFileExtension(t.record[a.name]),r.instanceId=e.workgroup.tenant_id,t.record[a.name]=null,"document"===a.data_type&&(t.uploaderBasic[a.name].queue=[]),"image"===a.data_type&&(t.uploaderImage[a.name].queue=[],t.croppedImage[a.id]=void 0)},t.checkUploadFile=function(e){var t=e.target.files,a=e.target.id,o=angular.element(document.getElementById("lbl_"+a))[0];isAcceptedExtension(t[0])&&(o.innerText=t[0].name)},t.fileLoadingCounter=0,t.uploaderBasic=function(e){t.isFinishUpload=!1,t.document[e.name]={};var r=t.uploaderBasic[e.name]=new f({url:"storage/record_file_upload",queueLimit:1});return r.onAfterAddingFile=function(a){t.fileLoadingCounter++;var o=a.uploader.queue[0].file.name;t.record[e.name]=o,t.document[e.name].Name=a.uploader.queue[0].file.name,t.document[e.name].Size=a.uploader.queue[0].file.size,t.document[e.name].Type=a.uploader.queue[0].file.type,a.upload()},r.onWhenAddingFileFailed=function(e,t){switch(t.name){case"docFilter":k.warning(a("translate")("Setup.Settings.DocumentTypeError"));break;case"sizeFilter":k.warning(a("translate")("Setup.Settings.SizeError"))}},r.filters.push({name:"docFilter",fn:function(e){var t=o.getFileExtension(e.name);return"txt"===t||"docx"===t||"pdf"===t||"doc"===t||"xlsx"===t||"xls"===t}}),r.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}}),r.onSuccessItem=function(a,o){t.document[e.name].UniqueName=o.unique_name,t.fileLoadingCounter--},r.onErrorItem=function(a,o){t.document[e.name].UniqueName=o.unique_name,t.fileLoadingCounter--},t.isFinishUpload=!0,r},t.uploaderImage=function(r){function n(e){var t=l.defer(),a=new FileReader;return a.onload=function(e){t.resolve(e.target.result)},a.readAsDataURL(e),t.promise}t.image[r.name]={};var i={Authorization:"Bearer "+s.read("access_token"),Accept:"application/json"};e.preview?i["X-App-Id"]=e.user.app_id:i["X-Tenant-Id"]=e.user.tenant_id;var d=t.uploaderImage[r.name]=new f({url:"storage/record_file_upload",headers:i,queueLimit:1});d.onAfterAddingFile=function(e){n(e._file).then(function(a){t.copyImg=a,e.image=a;new Image;_.resizeImage(e.image,{width:1024},function(a,o){if(!a){e._file=u(o),e.file.size=e._file.size,t.fileLoadingCounter++;var n=e.uploader.queue[0].file.name;t.record[r.name]=n,t.image[r.name].Name=e.uploader.queue[0].file.name,t.image[r.name].Size=e.uploader.queue[0].file.size,t.image[r.name].Type=e.uploader.queue[0].file.type,e.upload()}})})},d.onWhenAddingFileFailed=function(e,t){switch(t.name){case"imgFilter":k.warning(a("translate")("Setup.Settings.ImageError"));break;case"sizeFilter":k.warning(a("translate")("Setup.Settings.SizeError"))}},d.filters.push({name:"imgFilter",fn:function(e){var t=o.getFileExtension(e.name);return"jpg"===t||"jpeg"===t||"png"===t||"doc"===t||"gif"===t}}),d.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}}),d.onSuccessItem=function(e,a){t.croppedImage=t.croppedImage||{},t.croppedImage[r.id]=t.copyImg,t.image[r.name].UniqueName=a.public_url,t.fileLoadingCounter--};var u=function(e){for(var t=atob(e.split(",")[1]),a=e.split(",")[0].split(":")[1].split(";")[0],o=[],r=0;r<t.length;r++)o.push(t.charCodeAt(r));return new Blob([new Uint8Array(o)],{type:a})};return d},t.webhookRequest=function(o){var r=t.actionButtons[o];if(!r)return void k.warning(a("translate")("Module.ActionButtonWebhookFail"));var n={},i=[],l=r.parameters.split(","),d=r.headers.split(",");t.webhookRequesting={},t.webhookRequesting[r.id]=!0;for(var s=0;s<l.length;s++){var u=l[s],c=u.split("|"),p=c[0],m=c[1],f=c[2];n[p]=m!==t.module.name?t.record[m]?t.record[m][f]:null:t.record[f]?t.record[f]:null}for(var s=0;s<d.length;s++){var u=d[s],g=u.split("|"),h=g[0],m=g[1],_=g[2],y=g[3];switch(h){case"module":var f=y;i[_]=m!==t.module.name?t.record[m]?t.record[m][f]:null:t.record[f]?t.record[f]:null;break;case"static":switch(y){case"{:app:}":i[_]=e.user.app_id;break;case"{:tenant:}":i[_]=e.user.tenant_id;break;case"{:user:}":i[_]=e.user.id;break;default:i[_]=null}break;case"custom":i[_]=y;break;default:i[_]=null}}if("post"===r.method_type)v.post(r.url,n,{headers:i}).then(function(){k.success(a("translate")("Module.ActionButtonWebhookSuccess")),t.webhookRequesting[r.id]=!1})["catch"](function(){k.warning(a("translate")("Module.ActionButtonWebhookSuccess")),t.webhookRequesting[r.id]=!1});else if("get"===r.method_type){var b="";for(var _ in n)b+=_+"="+n[_]+"&";b.length>0&&(b=b.substring(0,b.length-1)),v.get(r.url+"?"+b).then(function(){k.success(a("translate")("Module.ActionButtonWebhookSuccess")),t.webhookRequesting[r.id]=!1})["catch"](function(){k.warning(a("translate")("Module.ActionButtonWebhookFail")),t.webhookRequesting[r.id]=!1})}},t.setDropdownData=function(e){if(e.filters&&e.filters.length>0)t.dropdownFieldDatas[e.name]=null;else if(t.dropdownFieldDatas[e.name]&&t.dropdownFieldDatas[e.name].length>0)return;t.currentLookupField=e,t.lookup().then(function(a){t.dropdownFieldDatas[e.name]=a})},t.getAttachments=function(){o.hasDocumentsPermission(t.operations.read)&&h.getEntityDocuments(e.workgroup.tenant_id,t.id,t.module.id).then(function(a){t.documentsResultSet=h.processDocuments(a.data,e.users),t.documents=t.documentsResultSet.documentList,t.loadingDocuments=!1})},t.getAttachments(),y.run("AfterFormLoaded","script",t),t.changeTab=function(e){t.isActive=[],t.isActive[e.id]=!0,t.generateRelationsTable(e)},t.findRequest=[],t.generateRelationsTable=function(o){var r=[],n={};if("many_to_many"===o.relation_type){{var i=e.modulus[o.related_module].primaryField;o.related_module+"_id."+o.related_module+"."+i.name}n={module:o.related_module,convert:!0,filters:[{field:t.module.name.substring(0,t.module.label_en_singular.length),operator:"equals",value:t.id,no:1}],many_to_many:t.module.name}
}else n={module:o.related_module,convert:!0,filters:[{field:o.relation_field,operator:"equals",value:t.id,no:1}]};o.display_fields.forEach(function(e){var n=angular.copy(a("filter")(t.modulus[o.related_module].fields,{name:e},!0)[0]);n&&n.data_type&&"lookup"===n.data_type&&(n.name=n.name+"."+n.lookup_type+"."+n.lookupModulePrimaryField.name),n&&r.push(n)});var l=g.generatRowtmpl(r,!0,{module:t.module,relatedModule:o}),d=t.locale||t.language;n.fields=l.requestFields,t.findRequest[o.id]=n,t.relationsGridOptions[o.id]={dataSource:{serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:function(a){$.ajax({url:"/api/record/find_custom?locale="+d,contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify(Object.assign(t.findRequest[o.id],a.data)),success:function(e){a.success(e)},beforeSend:e.beforeSend()})}},schema:{data:"data",total:"total",model:{id:"id"}}},rowTemplate:"<tr ng-click=\"goUrl2(dataItem.id,'"+o.related_module+"')\">"+l.rowtempl+"</tr>",altRowTemplate:'<tr class="k-alt" ng-click="goUrl2(dataItem.id,\''+o.related_module+"')\">"+l.rowtempl+"</tr>",sortable:!0,noRecords:!0,pageable:{refresh:!1,pageSize:10,pageSizes:[10,25,50,100,500],buttonCount:5,info:!0},columns:l.columns}},t.copyHref=function(){d.location.href="#/app/record/"+t.type+"?clone=true&id="+t.record.id+(t.parentId?"&ptype="+t.parentType+"&pid="+t.parentId:"")},t["delete"]=function(){t.executeCode=!1,y.run("BeforeDelete","Script",t,t.record),t.executeCode||g.deleteRecord(t.module.name,t.record.id).then(function(){return k.success(a("translate")("Module.SuccessDeleteRecordMessage")),y.run("AfterDelete","Script",t,t.record),x(),t.parentId?void n.go("app.moduleDetail",{type:t.parentModule,id:t.parentId}):void n.go("app.moduleList",{type:t.type})})},t.showConfirm=function(e){var o=b.confirm().title(a("translate")("Common.AreYouSure")).targetEvent(e).ok(a("translate")("Common.Yes")).cancel(a("translate")("Common.No"));b.show(o).then(function(){t["delete"]()},function(){})};var x=function(){var a=t.module.name+"_"+t.module.name;if(t.parentId){a=(t.relatedToField?"related_to":t.parentType)+t.parentId+"_"+t.module.name;var o=t.parentType+"_"+t.parentType;u.remove(a),u.remove(o)}else u.remove(a),"opportunities"===t.module.name&&u.remove("opportunity"+t.id+"_stage_history");e.activePages&&e.activePages[t.module.name]&&(e.activePages[t.module.name]=null),(t.module.display_calendar||"activities"===t.module.name)&&u.remove("calendar_events")};t.openExportDialog=function(){t.pdfCreating=!0,t.loadingModal=!0;var o=function(){var e=angular.element(document.body);b.show({parent:e,templateUrl:"view/app/module/modulePdfModal.html",clickOutsideToClose:!1,scope:t,preserveScope:!0})};t.quoteTemplates?(t.quoteTemplatesOptions={dataSource:a("filter")(t.quoteTemplates,{isShown:!0},!0),dataTextField:"name",dataValueField:"id"},t.quoteTemplate=t.quoteTemplates[0],t.loadingModal=!1,o()):g.getTemplates(t.module.name,"module").then(function(r){if(0===r.data.length)k.warning(a("translate")("Setup.Templates.TemplateNotFound")),t.pdfCreating=!1;else{var n=r.data;t.quoteTemplates=a("filter")(n,{active:!0},!0),t.isShownWarning=!0;for(var i=0;i<t.quoteTemplates.length;i++){var l=t.quoteTemplates[i];if(l.permissions.length>0){var d=a("filter")(l.permissions,{profile_id:e.user.profile.id},!0)[0];l.isShown="none"===d.type?!1:!0,l.isShown===!0&&(t.isShownWarning=!1)}else l.isShown=!0,t.isShownWarning=!1}t.quoteTemplatesOptions={dataSource:a("filter")(t.quoteTemplates,{isShown:!0},!0),dataTextField:"name",dataValueField:"id"},t.quoteTemplate=t.quoteTemplates[0],t.loadingModal=!1,o()}})["catch"](function(){t.pdfCreating=!1})},t.showSingleSMSModal=function(){if(!e.system.messaging.SMS)return void k.warning(a("translate")("SMS.NoProvider"));var o=angular.element(document.body);b.show({parent:o,templateUrl:"view/app/sms/singleSMSModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})},t.showQuoteEMailModal=function(){if(!e.system.messaging.SystemEMail&&!e.system.messaging.PersonalEMail)return void k.warning(a("translate")("EMail.NoProvider"));var o=angular.element(document.body);b.show({parent:o,templateUrl:"view/app/email/singleEmailModal.html",clickOutsideToClose:!0,scope:t,preserveScope:!0})},t.getDownloadUrl=function(o){t.isDownLoad=!0,d.open("/attach/export?module="+t.type+"&id="+t.id+"&templateId="+t.quoteTemplate.id+"&access_token="+s.read("access_token")+"&format="+o+"&locale="+e.locale+"&timezoneOffset="+-1*(new Date).getTimezoneOffset(),"_blank"),k.success(a("translate")("Module.DownloadPdfWordMessage",{value:"pdf"===o?"Pdf":"Word"})),t.isDownLoad=!1},t.close=function(){b.hide()},t.setId=function(e,a,o){t.field=e,o||(t.optionId=a?e.picklist_id:e.id)},t.openCalendar=function(e){var t=void 0;switch(e.data_type){case"date":t="kendoDatePicker";break;case"date_time":t="kendoDateTimePicker";break;case"time":t="kendoTimePicker"}if(t){var a=angular.element(document.getElementById(e.name)).data(t);a&&a.open()}},t.documentDownload=function(e){d.location="storage/record_file_download?fileName="+e};var L=function(){if("users"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){var o={};o.data_type="text_single",o.name="full_name",t.currentLookupField.lookupModulePrimaryField=o}if("profiles"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){var o={};o.data_type="text_single",o.name="name",t.currentLookupField.lookupModulePrimaryField=o}if("roles"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){var o={};o.data_type="text_single",o.name="label_"+e.user.tenantLanguage,t.currentLookupField.lookupModulePrimaryField=o}if("relation"===t.currentLookupField.lookup_type){if(!t.record.related_module)return t.$broadcast("angucomplete-alt:clearInput",t.currentLookupField.name),l.defer().promise;var r=a("filter")(e.modules,{name:t.record.related_module.value},!0)[0];if(!r)return t.$broadcast("angucomplete-alt:clearInput",t.currentLookupField.name),l.defer().promise;t.currentLookupField.lookupModulePrimaryField=a("filter")(r.fields,{primary:!0},!0)[0]}y.run("BeforeLookup","Script",t)};t.closeLightBox=function(){b.hide()},t.showLightBox=function(e,a){a&&(t.showImageData={url:a,title:t.title},b.show({contentElement:"#mdLightbox",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:!1}))},t.formType=null,t.fastNewRecordModal=function(a,o,r,n,i){t.lookupInput.close();var l=t;e.fastRecordAddModal(a,o,r,n,i,l)};var q=function(){for(var e=0;2>e;e++){var o=["shared_read","shared_edit"];t["lookupOptions_"+o[e]]={dataSource:new kendo.data.DataSource({transport:{read:function(e){e.success(t.record[t.field]?t.record[t.field]:[])}}}),dataTextField:"name",dataValueField:"id",autoBind:!1,filtering:function(e){e.filter&&t.lookupUserAndGroup(t.module.id,!1,e.filter.value).then(function(e){if(e&&e.length>0){var o=t["lookupOptions_"+t.field].dataSource;o._data=[];for(var r=0;r<e.length;r++){var n=o._data.length>0?a("filter")(o._data,{id:e[r].id},!0)[0]:!1;n||o.add(e[r])}}})}}}};t.goToRecord=function(e,t,a,o){g.goToRecord(e,t,a,o)}}]);