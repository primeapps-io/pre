angular.module("primeapps").factory("ModuleService",["$rootScope","$http","config","$q","$filter","$cache","$window","helper","operations","ngTableParams","icons2","dataTypes","operators","yesNo","components",function($rootScope,$http,config,$q,$filter,$cache,$window,helper,operations,ngTableParams,icons2,dataTypes,operators,yesNo,components){return{myAccount:function(){return $http.post(config.apiUrl+"User/MyAccount",{})},getAllUser:function(){return $http.get(config.apiUrl+"User/get_all")},getUserLicenseStatus:function(){return $http.post(config.apiUrl+"License/GetUserLicenseStatus",{})},addUser:function(e){return $http.post(config.apiUrl+"User/add_user",e)},deleteUser:function(e,t){return $http.post(config.apiUrl+"Instance/Dismiss",{UserID:e.ID,EMail:e.email,HasAccount:e.hasAccount,InstanceID:t})},getUserEmailControl:function(e){return $http.get(config.apiUrl+"User/get_user_email_control?Email="+e)},get:function(e){return $http.get(config.apiUrl+"template/get/"+e)},create:function(e){return $http.post(config.apiUrl+"module/create",e)},update:function(e,t){return $http.put(config.apiUrl+"module/update/"+t,e)},"delete":function(e){return $http["delete"](config.apiUrl+"module/delete/"+e)},createModuleRelation:function(e,t){return $http.post(config.apiUrl+"module/create_relation/"+t,e)},updateModuleRelation:function(e,t){return $http.put(config.apiUrl+"module/update_relation/"+t+"/"+e.id,e)},deleteModuleRelation:function(e){return $http["delete"](config.apiUrl+"module/delete_relation/"+e)},createModuleDependency:function(e,t){return $http.post(config.apiUrl+"module/create_dependency/"+t,e)},updateModuleDependency:function(e,t){return $http.put(config.apiUrl+"module/update_dependency/"+t+"/"+e.id,e)},deleteModuleDependency:function(e){return $http["delete"](config.apiUrl+"module/delete_dependency/"+e)},getRecord:function(e,t,a){return $http.get(config.apiUrl+"record/get/"+e+"/"+t,{ignoreNotFound:a})},getRecords:function(e,t){return $http.post(config.apiUrl+"record/get_all_by_id/"+e,t)},findCustom:function(e,t){return $http.post(config.apiUrl+"record/find_custom?locale="+e,t)},findRecords:function(e,t){return $rootScope.activeModuleName=null,$http.post(config.apiUrl+"record/find/"+e,t)},insertRecord:function(e,t){return $http.post(config.apiUrl+"record/create/"+e+"?timezone_offset="+-1*(new Date).getTimezoneOffset(),t)},runMicroflow:function(e,t){return $http.post(config.apiUrl+"bpm/start_workflow/"+e,t)},updateRecord:function(e,t){return delete t.process_id,delete t.process_status,delete t.process_status_order,delete t.operation_type,delete t.process_request_updated_by,delete t.process_request_updated_at,delete t.freeze,$http.put(config.apiUrl+"record/update/"+e+"?timezone_offset="+-1*(new Date).getTimezoneOffset(),t)},deleteRecord:function(e,t){if($rootScope.branchAvailable&&"calisanlar"===e){var a=$q.defer(),r=this;return this.getRecord(e,t).then(function(l){if(l.data){var i=$filter("filter")($rootScope.workgroup.users,{email:l.data.e_posta},!0)[0];i&&r.deleteUser(i,$rootScope.workgroup.tenant_id),$http["delete"](config.apiUrl+"record/delete/"+e+"/"+t).then(function(e){return a.resolve(e),a.promise})}}),a.promise}return $http["delete"](config.apiUrl+"record/delete/"+e+"/"+t)},addRelations:function(e,t,a){return $http.post(config.apiUrl+"record/add_relations/"+e+"/"+t,a)},deleteRelation:function(e,t,a){return $http({method:"DELETE",url:config.apiUrl+"record/delete_relation/"+e+"/"+t,data:a,headers:{"Content-type":"application/json;charset=utf-8"}})},insertRecordBulk:function(e,t){for(var a=0;a<t.length;a++){t[a]}return $http.post(config.apiUrl+"record/create_bulk/"+e,t)},deleteRecordBulk:function(e,t){return $http({method:"DELETE",url:config.apiUrl+"record/delete_bulk/"+e,data:t,headers:{"Content-type":"application/json;charset=utf-8"}})},updateRecordBulk:function(e,t){return delete t.records.shared_users_edit,delete t.records.shared_users,delete t.records.shared_user_groups_edit,delete t.records.shared_user_groups,delete t.records.shared_read,$http({method:"Put",url:config.apiUrl+"record/update_bulk/"+e,data:t,headers:{"Content-type":"application/json;charset=utf-8"}})},findPicklist:function(e){return $http.post(config.apiUrl+"picklist/find",e)},setViewState:function(e,t,a){return a&&(e.id=a),e.module_id=t,$http.put(config.apiUrl+"view/set_view_state",e)},deleteView:function(e){return $http["delete"](config.apiUrl+"view/delete/"+e)},approveMultipleProcessRequest:function(e,t){return $http.put(config.apiUrl+"process_request/approve_multiple_request",{record_ids:e,module_name:t})},approveProcessRequest:function(e,t,a){return $http.put(config.apiUrl+"process_request/approve",{record_id:a,module_name:t,operation_type:e})},rejectProcessRequest:function(e,t,a,r){return $http.put(config.apiUrl+"process_request/reject",{record_id:r,module_name:t,operation_type:e,message:a})},deleteProcessRequest:function(e,t){return $http.put(config.apiUrl+"process_request/delete",{record_id:t,module_id:e})},send_approval:function(e,t,a){return $http.put(config.apiUrl+"process_request/send_approval",{record_id:a,module_name:t,operation_type:e})},sendApprovalManuel:function(e){return $http.post(config.apiUrl+"process_request/send_approval_manuel",e)},getProcess:function(e){return $http.get(config.apiUrl+"process/get/"+e)},sendSMS:function(e,t,a,r,l,i,n){return $http.post(config.apiUrl+"messaging/send_sms",{module_id:e,ids:t,query:a,is_all_selected:r,message:l,phone_field:i,template_id:n.id})},sendEMail:function(e,t,a,r,l,i,n,o,s,d,u,p,c,f,m){return $http.post(config.apiUrl+"messaging/send_email_job",{module_id:e,Ids:t,Query:a,is_all_selected:r,template_id:l.id,e_mail_field:i,Cc:n,Bcc:o,sender_alias:s,provider_type:u,sender_e_mail:d,attachment_container:p,subject:c,attachment_link:f,attachment_name:m})},getTemplates:function(e,t){return $http.get(config.apiUrl+"template/get_all?moduleName="+e+"&type="+t)},processRecordSingle:function(e,t,a){for(var r=0;r<t.fields.length;r++){var l=t.fields[r];this.processRecordField(e,l,a)}return e},formatRecordFieldValues:function(e,t,a){for(var r=0;r<t.fields.length;r++){var l=t.fields[r];this.formatFieldValue(l,e[l.name],a,e,t)}},processRecordMulti:function(e,t,a,r,l,i,n,o,s,d,u,p){for(var c=[],f=function(e,t,a,r,l,i,n,o,s,d,u,p){var c="#/app/record/";if(u.external_link)return void(e.link=p?u.external_link+"?id="+e.value_id+"&back="+a:u.external_link+"?id="+t.id+"&back="+a);var f;if(d&&(f=d.$parent.record),d&&!f&&(f=d.$parent.$parent.record),d&&!f&&(f=d.$parent.$parent.$parent.record),e.primary||"email"===e.data_type||"url"===e.data_type||"lookup"===e.data_type||"location"===e.data_type){if(e.primary&&!e.isJoin)return void(e.link=c+a+"?id="+t.id+(l?"&ptype="+r+"&pid="+l+"&rtab="+i+(f&&f.freeze?"&freeze=true":"")+(o?"&pptype="+n+"&ppid="+o+"&prtab="+s:""):""));if(e.primary&&e.isJoin&&"users"!==e.value_type&&"profiles"!==e.value_type&&"roles"!==e.value_type)return void(e.link=c+e.value_type+"?id="+e.value_id+(l?"&ptype="+r+"&pid="+l+(f&&f.freeze?"&freeze=true":""):"&back="+a));if("lookup"===e.data_type&&"users"!==e.lookup_type&&"profiles"!==e.lookup_type&&"roles"!==e.lookup_type){var m=e.lookup_type;"object"==typeof e.lookup_type&&(m=e.lookup_type.id);var g=t[e.name+"."+m+".id"];return void(e.link=c+m+"?id="+g+(l?"&ptype="+r+"&pid="+l+"&rtab="+i+(f&&f.freeze?"&freeze=true":"")+(o?"&pptype="+n+"&ppid="+o+"&prtab="+s:""):"&back="+a))}"email"===e.data_type&&(e.link="mailto:"+e.value),"url"===e.data_type&&(e.link=e.value),"location"===e.data_type&&(e.link="http://www.google.com/maps/place/"+e.value)}},m=function(e,t,a,r,l){switch(e.data_type){case"text_single":e.mask&&l?t.valueFormatted=$filter("mask")(l,e.mask):(t.value=l,t.valueFormatted=e.valueFormatted);break;case"lookup":if(!a[r])return;t.value=a[r],t.lookup_type="relation"!==e.lookup_type?e.lookup_type:a[e.lookup_relation],t.valueFormatted=t.value;break;case"picklist":case"multiselect":case"tag":case"checkbox":t.value=e.valueFormatted,t.valueFormatted=e.valueFormatted;break;default:t.value=l,t.valueFormatted=e.valueFormatted}},g=0;g<e.length;g++){var _=e[g],v=_;v.id=_.id||_[t.name+"_id"],_["process.process_requests.process_id"]?(v.isProcessItem=!0,v["process.process_requests.process_status"]=_["process.process_requests.process_status"]):v.isProcessItem=!1,v.shared_users_edit=_.shared_users_edit,v.shared_users=_.shared_users,v.shared_user_groups_edit=_.shared_user_groups_edit,v.shared_user_groups=_.shared_user_groups,v.shared_read=_.shared_read,v.fields=[];for(var h=0;h<r.length;h++){var b=r[h],k=angular.copy(t),y=b.field,$=!1;if(b.field.indexOf(".")>-1){var w=b.field.split(".");if(null!=w[3]&&"primary"===w[3])continue;k=$filter("filter")($rootScope.modules,{name:w[1]},!0)[0],y=w[2],$=!0}for(var S=0;S<k.fields.length;S++){var x=k.fields[S];if(y===x.name&&this.hasFieldDisplayPermission(x)){if(null==a){var R=this.getPicklists(t);a=R.$$state.value}this.processRecordsField(_,x,!0),this.formatFieldValue(x,_[b.field],a,_,t);var F={data_type:x.data_type,name:x.name,primary:x.primary,value:"",isJoin:$,isHtml:x.multiline_type_use_html,image_size_list:x.image_size_list};"rating"===x.data_type&&(F.max=x.validation.min_length);for(var I in _)if(_.hasOwnProperty(I)){var L=_[I],M=!1;if(I.indexOf(".")>-1){var j=I.split(".");$&&x.primary&&(F.value_id=_[j[0]+"."+j[1]+".id"],F.value_type=j[1],M=!0),I=j[2]}if(I!==x.name)continue;m(x,F,_,I,L),f(F,_,l,n,i,o,s,d,u,p,x,M)}F.order=b.order||x.order,v[x.name+"_data"]=F}}}c.push(v)}return c},processRecordField:function(e,t,a){var r=this,l=t.name;switch(t.data_type){case"lookup":var i={},n=null===e[l+".id"];void 0===e[l+".id"]&&(t.inline_edit=!1,n=!0);for(var o in e)if(e.hasOwnProperty(o)){var s=e[o];if(o.startsWith(l+".")){if(!n){var d=o.split(".");if(d[0]!==t.name)continue;i[d[1]]="languages"===d[1]?JSON.parse(s):s}delete e[o]}}if(n)return;if("users"===t.lookup_type)i.primary_value=i.full_name;else if("profiles"===t.lookup_type)i.primary_value=$rootScope.getLanguageValue(i.languages,"name");else if("roles"===t.lookup_type)i.primary_value=$rootScope.getLanguageValue(i.languages,"label");else if("relation"===t.lookup_type)i=e[t.lookup_relation]&&e.related_to?e.related_to:null;else{var u=$filter("filter")($rootScope.modules,{name:t.lookup_type},!0)[0],p=$filter("filter")(u.fields,{primary:!0,deleted:!1},!0)[0];i.primary_value=i[p.name]}e[l]=i;break;case"picklist":e[l]=$filter("filter")(a[t.picklist_id],function(t){return!t.inactive&&r.getPicklistValue(t,e[l])},!0)[0];break;case"multiselect":var c=[];if(e[l]){angular.isArray(e[l])||(e[l]=e[l].split(";"));for(var f=0;f<e[l].length;f++){const m=e[l][f],g=$filter("filter")(a[t.picklist_id],function(e){return!e.inactive&&r.getPicklistValue(e,m)},!0)[0];g&&c.push(g.id)}}e[l]=c;break;case"date":case"date_time":case"time":if(void 0===e[l]||null===e[l]||!e[l].length)return;e[l+"str"]="time"===t.data_type?kendo.toString(new Date(e[l]),"t"):kendo.toString(new Date(e[l]),"g");break;case"tag":void 0!==e[l]&&null!==e[l]&&e[l].length||(e[l]=[])}},processRecordsField:function(e,t){var a=t.name;switch(t.data_type){case"lookup":var r=$filter("filter")($rootScope.modules,{name:t.lookup_type},!0)[0];if(null===r||void 0===r)return;var l=$filter("filter")(r.fields,{primary:!0},!0)[0];e[a]=e[t.name+"."+t.lookup_type+"."+l.name+".primary"];break;case"date":case"date_time":case"time":if(void 0===e[a]||null===e[a]||!e[a].length)return;e[a]=new Date(e[a])}},processUser:function(e){var t={};return t.id=e.id,t.primary_value=e.first_name+" "+e.last_name,t.email=e.email,t},processRecords:function(e,t,a){for(var r=[],l=angular.copy(e),i=0;i<l.length;i++){for(var n=l[i],o=0;o<t.fields.length;o++){var s=t.fields[o];this.processRecordsField(n,s,a),this.formatFieldValue(s,n[s.name],a,n,t)}r.push(n)}return r},formatFieldValue:function(e,t,a,r,l){if(e.valueFormatted="",void 0!==t&&null!==t)switch(e.data_type){case"number_decimal":e.valueFormatted=$filter("number")(t,e.decimal_places);break;case"number_auto":var i=t.toString();e.auto_number_prefix&&(i=e.auto_number_prefix+i),e.auto_number_suffix&&(i+=e.auto_number_suffix),e.valueFormatted=i;break;case"currency":var n;if(r&&r.currency)if(angular.isObject(r.currency))n=r.currency.value;else{var o=$filter("filter")(l.fields,{name:"currency"},!0)[0],s=$filter("filter")(a[o.picklist_id],{labelStr:r.currency})[0];s&&s.value&&(n=s.value)}e.valueFormatted=$filter("currency")(t,n||e.currency_symbol||$rootScope.currencySymbol,e.decimal_places);break;case"date":e.valueFormatted=$filter("date")(t,"shortDate");break;case"date_time":e.valueFormatted=$filter("date")(t,"short");break;case"time":e.valueFormatted=$filter("date")(t,"shortTime");break;case"picklist":if(angular.isObject(t))e.valueFormatted=t.label[$rootScope.language];else{var d=$filter("filter")(a[e.picklist_id],{labelStr:t},!0)[0];e.valueFormatted=d?d.label[$rootScope.language]:t}break;case"multiselect":for(var u=0;u<t.length;u++){var p=t[u];if(angular.isObject(p))e.valueFormatted+=(p.label?p.label[$rootScope.language]:"")+"; ";else{var d=$filter("filter")(a[e.picklist_id],{labelStr:p},!0)[0];e.valueFormatted+=(d?d.label[$rootScope.language]:p)+"; "}}e.valueFormatted=e.valueFormatted.slice(0,-2);break;case"tag":for(var u=0;u<t.length;u++){var p=t[u];e.valueFormatted+=angular.isObject(p)?" "+p:" "+p+";"}break;case"checkbox":const c=$filter("filter")(a.yes_no,{system_code:t.toString()})[0];c&&(e.valueFormatted=$rootScope.getLanguageValue(c.languages,"label"));break;default:e.valueFormatted=t}},getPicklists:function(e,t){var a=$q.defer(),r=angular.copy(e.fields),l={},i=[];if(t)for(var n=0;n<e.fields.length;n++){var o=e.fields[n];if("lookup"===o.data_type&&"users"!==o.lookup_type&&"profiles"!==o.lookup_type&&"roles"!==o.lookup_type&&"relation"!==o.lookup_type){var s=$filter("filter")($rootScope.modules,{name:o.lookup_type},!0)[0];if(!s)continue;for(var d=0;d<s.fields.length;d++){var u=s.fields[d];("picklist"===u.data_type||"multiselect"===u.data_type)&&r.push(u)}}}for(var p=function(t,a){if(e.dependencies&&e.dependencies.length>0){var r=$filter("filter")(e.dependencies,{child_field:a.name},!0)[0];if(r&&r.deleted!==!0&&"list_field"===r.dependency_type)for(var l=0;l<t.length;l++){var i=t[l];i.hidden=!0}}},c=0;c<r.length;c++){var f=r[c];if(f.picklist_id){var m=$cache.get("picklist_"+f.picklist_id);if(9e5===f.picklist_id){if(m){l[f.picklist_id]=m;continue}for(var g=[],_=0;_<$rootScope.modules.length;_++){var v=$rootScope.modules[_];if(v.display&&helper.hasPermission(v.name,operations.read)){var h={};h.id=parseInt(v.id)+9e5,h.type=9e5,h.system_code=v.name,h.order=v.order,h.label=$rootScope.getLanguageValue(v.languages,"label","singular"),h.labelStr=$rootScope.getLanguageValue(v.languages,"label","singular"),h.value=v.name,h.languages={},h.languages[$rootScope.globalization.Label]={label:$rootScope.getLanguageValue(v.languages,"label")},g.push(h)}}g=$filter("orderBy")(g,"order"),l[9e5]=g,$cache.put("picklist_"+9e5,g);continue}m?(m=$filter("orderBy")(m,"label"),f.picklist_sortorder&&!f.deleted&&(m=$filter("orderBy")(m,f.picklist_sortorder)),p(m,f),l[f.picklist_id]=m):i.push(f.picklist_id)}}var b=$cache.get("picklist_activity_type");b&&(l.activity_type=b);var k=$cache.get("picklist_yes_no");return l.yes_no=k?k:$rootScope.yesNo,i.length<=0?(a.resolve(l),a.promise):(i=i.getUnique(),this.findPicklist(i).then(function(t){if(!t.data)return a.resolve(l),a.promise;for(var n=0;n<r.length;n++){var o=r[n];if(o.picklist_id&&!(i.indexOf(o.picklist_id)<0)){$rootScope.processLanguages(t.data);var s=helper.mergePicklists(t.data);if(l[o.picklist_id]=$filter("filter")(s,{type:o.picklist_id},!0),l[o.picklist_id]=$filter("orderBy")(l[o.picklist_id],"label"),o.picklist_sortorder&&!o.deleted&&(l[o.picklist_id]=$filter("orderBy")(l[o.picklist_id],o.picklist_sortorder)),e.dependencies&&e.dependencies.length>0){var d=$filter("filter")(e.dependencies,{child_field:o.name},!0)[0];if(d&&1!=d.deleted&&"list_field"===d.dependency_type)for(var u=0;u<l[o.picklist_id].length;u++){var c=l[o.picklist_id][u];c.hidden=!0}}p(l[o.picklist_id],o),$cache.put("picklist_"+o.picklist_id,l[o.picklist_id])}}a.resolve(l)})["catch"](function(e){a.reject(e.data)}),a.promise)},moduleFieldsConvertByKey:function(e){for(var t=[],a=0;a<e.length;a++)t[e[a].name]=e[a];return t},lookup:function(e,t,a,r,l,i){var n=$q.defer(),o=t.lookup_type,s=this,d="lookup"===t.data_type&&t.show_as_dropdown;if("text_single"!==t.lookupModulePrimaryField.data_type&&"picklist"!==t.lookupModulePrimaryField.data_type&&"email"!=t.lookupModulePrimaryField.data_type&&"number"!==t.lookupModulePrimaryField.data_type&&"number_auto"!==t.lookupModulePrimaryField.data_type)return n.resolve([]),n.promise;if("relation"===o&&(o=void 0!==a[t.lookup_relation]?a[t.lookup_relation].value:null),!o)return n.resolve([]),n.promise;if(!e&&!d)return n.resolve([]),n.promise;var u=$filter("filter")($rootScope.modules,{name:o},!0)[0],p=[];if(p.push(t.lookupModulePrimaryField.name),r)for(var c=0;c<r.length;c++){var f=r[c];f!==t.lookupModulePrimaryField.name&&"id"!==f&&p.push(f)}var m=[];if("number"!==t.lookupModulePrimaryField.data_type&&"number_auto"!==t.lookupModulePrimaryField.data_type)if(l)m.push({field:t.lookupModulePrimaryField.name,operator:"is",value:e,no:1});else switch(t.lookup_search_type){case"contains":m.push({field:t.lookupModulePrimaryField.name,operator:"contains",value:e,no:1});break;case"starts_with":m.push({field:t.lookupModulePrimaryField.name,operator:"starts_with",value:e,no:1});break;default:m.push({field:t.lookupModulePrimaryField.name,operator:"starts_with",value:e,no:1})}else m.push({field:t.lookupModulePrimaryField.name,operator:"equals",value:parseInt(e),no:1});var g={fields:p,filters:m,sort_field:t.lookupModulePrimaryField.name,sort_direction:"asc",limit:1e3,offset:0};d&&(g.filters=[],g.limit=1e5);var _=g.filters.length;("users"===u.name||$rootScope.branchAvailable&&"branches"===o)&&g.filters.push({field:"is_active",operator:"equals",value:!0,no:_+1}),"users"===u.name&&g.filters.push({field:"email",operator:"not_contain",value:"integration_",no:_+1});var v=s.moduleFieldsConvertByKey(u.fields);if(t.filters)for(var h=g.filters.length,b=0;b<t.filters.length;b++){var k=t.filters[b];h++;var y=null,$=k.value.match(/^\W+(.+)]/i);if(null!==$&&"users"!==t.lookup_type&&"profiles"!==t.lookup_type&&"roles"!==t.lookup_type){var w=$[1].split(".");1===w.length&&a[w[0]]&&(y=a[w[0]]),2===w.length&&a[w[0]]&&(y=a[w[0]][w[1]]),3===w.length&&a[w[0]]&&(y=a[w[0]][w[1]][w[2]]),null!=y&&(g.filters.push({field:k.filter_field,operator:k.operator,value:y,no:h}),g.fields.push(k.filter_field))}else{var S=v[k.filter_field];switch(S.data_type){case"multiselect":case"tag":y=k.value.split("|");break;default:y=k.value}g.filters.push({field:k.filter_field,operator:k.operator,value:y,no:h}),g.fields.push(k.filter_field)}}if(i)for(var x=0;x<i.length;x++){var R=i[x];R.no=g.filters.length+1,g.filters.push(R)}return this.findRecords(o,g).then(function(e){if(!e.data||!e.data.length)return n.resolve([]),n.promise;var a=[];if(r)s.getPicklists(u).then(function(r){for(var l=0;l<e.data.length;l++){var i=e.data[l],o=angular.copy(i);o=s.processRecordSingle(o,u,r),o.primary_value=i[t.lookupModulePrimaryField.name],a.push(o),n.resolve(a)}});else for(var l=0;l<e.data.length;l++){var i=e.data[l];"profiles"===o&&1===i.id&&(i.name="tr"===$rootScope.user.tenant_language?"Sistem Yöneticisi":"Administrator");var d=angular.copy(i);d.primary_value=i[t.lookupModulePrimaryField.name],a.push(d),n.resolve(a)}})["catch"](function(e){n.reject(e.data)}),n.promise},fieldLookupFilters:function(e,t,a,r){var l={};l={is:"is",is_not:"is_not",equals:"eq",not_equal:"neq",contains:"contains",not_contain:"doesnotcontain",starts_with:"startswith",ends_with:"endswith",empty:"isempty",not_empty:"isnotempty",greater:"gt",greater_equal:"gte",less:"lt",less_equal:"lte",not_in:"not_in"};var i=[],n=e.lookup_type,o=$rootScope.modulus[n],s=this.moduleFieldsConvertByKey(o.fields);if(r.fields||(r.fields=[]),a&&e.filters&&e.filters.length>0){for(var d=0,u=0;u<e.filters.length;u++){var p=e.filters[u],c=$filter("filter")(a,{field:p.filter_field,operator:p.operator,value:p.value},!0)[0];if(c){var f=a.indexOf(c);a.splice(f,1)}d++;var m=p.value,g=p.value.match(/^\W+(.+)]/i);if(null!==g&&"users"!==e.lookup_type&&"profiles"!==e.lookup_type&&"roles"!==e.lookup_type){var _=g[1].split(".");1===_.length&&t[_[0]]?m=t[_[0]]:2===_.length&&t[_[0]]?m=t[_[0]][_[1]]:3===_.length&&t[_[0]]?m=t[_[0]][_[1]][_[2]]:m.startsWith("[")&&m.endsWith("]")&&(m=null),null!=m&&(i.push({field:p.filter_field,operator:l[p.operator]||p.operator,value:m,no:d}),r.fields.push(p.filter_field))}else{var v=s[p.filter_field];if(v)switch(v.data_type){case"multiselect":case"tag":m=p.value.split("|");break;default:m=p.value}i.push({field:p.filter_field,operator:l[p.operator]||p.operator,value:m,no:d}),r.fields.push(p.filter_field)}}return a.length>0&&(angular.forEach(a,function(e){e.operator=l[e.operator]}),i=i.concat(a)),i}return a},prepareRecord:function(e,t,a){function r(e){var t=document.createElement("div");return t.innerHTML=e,t.innerHTML.toString()}var l=angular.copy(e),i=angular.copy(a);if(a)for(var n=0;n<t.dependencies.length;n++){var o=t.dependencies[n];if("display"===o.dependency_type&&!o.deleted){const s=$filter("filter")(t.fields,{name:o.parent_field,deleted:!1},!0)[0];if(!angular.equals(e[o.parent_field],a[o.parent_field]))if(o.values_array&&o.values_array.length>0){for(var d=!0,u=0;u<o.values_array.length;u++){var p=o.values_array[u];if(Array.isArray(e[o.parent_field]))for(var c=0;c<e[o.parent_field].length;c++){var f=e[o.parent_field][c];f.toString()===p&&(d=!1)}else e[o.parent_field]&&(angular.isObject(e[o.parent_field])&&e[o.parent_field].id.toString()===p||s&&"checkbox"===s.data_type)&&(d=!1)}d&&o.child_field&&(l[o.child_field]=null)}else!e[o.parent_field]&&o.child_field&&(l[o.child_field]=null)}}for(var n=0;n<t.fields.length;n++){var s=t.fields[n];if("string"==typeof l[s.name]&&""===l[s.name].trim()&&(l[s.name]=void 0),a||l[s.name]||l[s.name]===!1||0===l[s.name])if(!a||a[s.name]||a[s.name]===!1||0===a[s.name]||l[s.name])if("checkbox"===s.data_type&&null===l[s.name]&&a[s.name]&&(l[s.name]=!1),s.deleted)delete l[s.name];else if("tag"===s.data_type&&(angular.isArray(l[s.name])&&l[s.name].length<1||null===l[s.name])&&(a?angular.isArray(a[s.name])&&a[s.name].length<1||null===a[s.name]:!1))delete l[s.name];else if(void 0!==l[s.name]&&null!==l[s.name]){switch(i||(i={}),s.data_type){case"number":l[s.name]=parseInt(l[s.name]),i[s.name]=i[s.name]?parseInt(i[s.name]):null;break;case"number_decimal":break;case"checkbox":(null===l[s.name]||void 0===l[s.name])&&(l[s.name]=!1);break;case"currency":l[s.name]=parseFloat(l[s.name]),i[s.name]=i[s.name]?parseFloat(i[s.name]):null;break;case"date":var m=moment(l[s.name]).format().split("+"),g=moment(i[s.name]).format().split("+");l[s.name]=m[0],i[s.name]=i[s.name]?g[0]:null;break;case"picklist":case"lookup":l[s.name]=l[s.name].id,i[s.name]=i[s.name]?i[s.name].id:null;break;case"text_multi":var _=l[s.name];if(s.multiline_type_use_html===!0){var v=r(_);l[s.name]=v}break;case"multiselect":for(var h=[],b=[],u=0;u<l[s.name].length;u++){var k=l[s.name][u];h.push(k)}if(i[s.name])for(var c=0;c<i[s.name].length;c++){var y=i[s.name][c];b.push(y)}l[s.name]=h&&h.length?h:null,i[s.name]=b&&b.length?b:null;break;case"tag":l[s.name]=l[s.name].toString()}a&&angular.equals(i[s.name],l[s.name])&&delete l[s.name]}else l[s.name]=null;else delete l[s.name]}if(l.shared_read&&l.shared_read.length){l.shared_users=[],l.shared_user_groups=[];for(var $=0;$<l.shared_read.length;$++){var w=l.shared_read[$];"user"===w.type&&l.shared_users.push(w.id),"group"===w.type&&l.shared_user_groups.push(w.id)}l.shared_users.length||(l.shared_users=null),l.shared_user_groups.length||(l.shared_user_groups=null),delete l.shared_read}else l.shared_users=null,l.shared_user_groups=null,delete l.shared_read;if(l.shared_edit&&l.shared_edit.length){l.shared_users_edit=[],l.shared_user_groups_edit=[];for(var S=0;S<l.shared_edit.length;S++){var x=l.shared_edit[S];"user"===x.type&&l.shared_users_edit.push(x.id),"group"===x.type&&l.shared_user_groups_edit.push(x.id)}l.shared_users_edit.length||(l.shared_users_edit=null),l.shared_user_groups_edit.length||(l.shared_user_groups_edit=null),delete l.shared_edit}else l.shared_users_edit=null,l.shared_user_groups_edit=null,delete l.shared_edit;return l},prepareRecordBulk:function(e,t){for(var a=this,r=[],l=0;l<e.length;l++){var i=e[l],n=a.prepareRecord(i,t);r.push(n)}return r},calculate:function(field,module,record){if(module.calculations){var calculation=$filter("filter")(module.calculations,{field_1:field.name},!0)[0];if(calculation||(calculation=$filter("filter")(module.calculations,{field_2:field.name},!0)[0]),calculation){var calculations=$filter("filter")(module.calculations,{result_field:calculation.result_field},!0);calculations=$filter("orderBy")(calculations,"order");for(var result=0,resultField="",i=0;i<calculations.length;i++){var calculation=calculations[i];result=eval((result||record[calculation.field_1]||0)+calculation.operator+(record[calculation.field_2]||calculation.custom_value||0)),resultField=calculation.result_field}record[resultField]=result||0,this.setCustomCalculations(module,record)}}},setExpressionValueElementType:function(e,t,a){switch(t.data_type){case"picklist":if(!e)break;e=e.labelStr;break;case"multiselect":if(!e)break;for(var r=$filter("filter")($rootScope.moduleRecordData.module.fields,{name:t.name},!0)[0],l=$rootScope.moduleRecordData.picklist[r.picklist_id],i="",n=e.length,o=0;n>o;o++){var s=$filter("filter")(l,{id:e[o]},!0)[0];i+=s["label_"+$rootScope.language],o+1!==n&&(i+=", ")}e=i;break;case"date":case"date_time":case"time":e=a[t.name+"str"]}return e},expressionGetValue:function(e,t,a,r){var l="";switch(a.type){case"field":if(a.is_main===!0&&a.isLookup===!0){var i=a.name.split(".");if(!i)return;var n=i[0],o=i[1],s=i[i.length-1];if("created_by"===n){var d=e.created_by?e.created_by.full_name:e.owner.full_name;l+='"'+d+'"'}else if("updated_by"===n){var d=e.updated_by?e.updated_by.full_name:e.owner.full_name;l+='"'+d+'"'}else if("owner"===n)l+='"'+e.owner.full_name+'"';else if(e[n]&&e[n].id){var u="";"users"!==o&&"roles"!==o&&"profiles"!==o?u=e[n][s]:"users"===o?u=e[n].full_name:e[n].languages&&(u=$rootScope.getLanguageValue(e[a.name].languages,"label")||$rootScope.getLanguageValue(e[a.name].languages,"name")),l+="number"==typeof u?u:'"'+u+'"'}else e[a.name]&&e[a.name].id?("users"!==o&&"roles"!==o&&"profiles"!==o?u=e[a.name].name:"users"===o?u=e[a.name].full_name:e[a.name].languages&&(u=$rootScope.getLanguageValue(e[a.name].languages,"label")||$rootScope.getLanguageValue(e[a.name].languages,"name")),l+="number"==typeof u?u:'"'+u+'"'):l+='" "'}else if(a.is_main===!0&&a.isLookup===!1){var d=e[a.name];switch(t.data_type){case"text_single":case"text_multi":d=this.setExpressionValueElementType(d,a,e),(void 0===d||null===d||""===d.toString().trim())&&(d=""),l+='"'+d+'"';break;case"number":switch(d=this.setExpressionValueElementType(d,a,e),r){case!0:null===d||isNaN(d)?d=null:(d=Math.round(d),0>d&&(d="("+d+")")),l+=d;break;default:""===d||null===d||void 0===d||isNaN(d)?d=null:(d=Math.round(d),0>d&&(d="("+d+")")),l+=d}break;case"number_decimal":case"currency":switch(d=this.setExpressionValueElementType(d,a,e),r){case!0:null===d||isNaN(d)?d=null:0>d&&(d="("+d+")"),l+=d;break;default:""===d||null===d||void 0===d||isNaN(d)?d=null:0>d&&(d="("+d+")"),l+=d}}}else if(a.is_main===!1&&a.isLookup===!0){var p=a.name.split("."),d="";switch(e[p[0]]?e[p[0]][p[1]]?d=e[p[0]][p[1]]:e[p[0]][p[2]]&&(d=e[p[0]][p[2]]):$rootScope.user[p[2]]&&(d=$rootScope.user[p[2]]),t.data_type){case"text_single":case"text_multi":(void 0===d||null===d||""===d.trim())&&(d=""),l+='"'+d+'"';break;case"number":switch(r){case!0:null===d||isNaN(d)?d=null:(d=Math.round(d),0>d&&(d="("+d+")")),l+=d;break;default:""===d||null===d||void 0===d||isNaN(d)?d=null:(d=Math.round(d),0>d&&(d="("+d+")")),l+=d}break;case"number_decimal":case"currency":switch(r){case!0:null===d||isNaN(d)?d=null:0>d&&(d="("+d+")"),l+=d;break;default:""===d||null===d||void 0===d||isNaN(d)?d=null:0>d&&(d="("+d+")"),l+=d}}}break;case"operator":l+="length"===a.forTypeName?").length":a.value;break;case"function":l+="and"===a.name||"or"===a.name?a.value:"(";break;case"input":var c=parseInt(a.dataValue);l+=isNaN(c)?'"'+a.dataValue+'"':a.dataValue}return l},expressionRunOrder:function(e,t,a){for(var r=[],l=0;l<e.length;l++){var i=null;if(a)i=e[l].validation&&e[l].validation.custom?JSON.parse(e[l].validation.custom):null;else try{if(!isNaN(e[l].default_value)||!e[l].default_value){t[e[l].name]=t[e[l].name]?t[e[l].name]:e[l].default_value;continue}i=e[l].default_value?JSON.parse(e[l].default_value):null}catch(n){t[e[l].name]=t[e[l].name]?t[e[l].name]:e[l].default_value;continue}var o={label:e[l].name,fields:[],formulaJson:i,data_type:e[l].data_type,isRun:!1,isConstant:!1,treeIndex:[]};if(null!==i&&0!==i.length){if(a){for(var s=0;s<i.length;s++)for(var d=0;d<i[s].elements.length;d++)if(o.validationMsg=$rootScope.getLanguageValue(i[s].languages,"label"),"field"===i[s].elements[d].type){var u={label:i[s].elements[d].label,name:i[s].elements[d].name,isLookup:i[s].elements[d].isLookup};o.fields.push(u)}}else for(var n=0;n<i.elements.length;n++)if("field"===i.elements[n].type){var p={label:i.elements[n].label,name:i.elements[n].name,isLookup:i.elements[n].isLookup};o.fields.push(p)}0===o.fields.length&&(o.isConstant=!0),r.push(o)}}var c=[],f=[];r.forEach(function(e){0===e.fields.length?c.push(e):f.push(e)});var m=c.length;m>0&&(m-=1);for(var g=0;g<f.length;g++)for(var _=f[g],v=0;v<f.length;v++)if(g!==v){var h=f[v],b=$filter("filter")(f[g].fields,{name:f[v].label},!0);if(b.length>0){var k=f.indexOf(_),y=f.indexOf(h);y>k?(h.treeIndex.includes(_.label)||h.treeIndex.push(_.label),f[y]=_,f[k]=h):h.treeIndex.includes(_.label)||h.treeIndex.push(_.label)}}var $=c.concat(f);return $},exprressionDependencyControl:function(e,t){var a=$filter("filter")(e.fields,{name:t.label,deleted:!1},!0)[0];return!a||void 0!==a.hidden&&a.hidden===!0||void 0!==a.sectionObj.hidden&&a.sectionObj.hidden===!0?!0:!1},expressionRunValue:function(resultArr,record,currentField,module){var dependenciesFields=[];if(currentField&&(dependenciesFields=$filter("filter")(module.dependencies,{parent_field:currentField.name,deleted:!1},!0)),currentField)if(currentField&&"lookup"===currentField.data_type){var runLookup=$filter("filter")(resultArr,{fields:{name:currentField.lookup_type,isLookup:!0}}),addRunLookup=[];runLookup&&runLookup.length>0&&runLookup.forEach(function(e){if(e.treeIndex.length>0){var t=$filter("filter")(resultArr,{label:e.treeIndex[0]},!0)[0];addRunLookup.push(t)}});for(var lastRunLookup=addRunLookup.length>0?runLookup.concat(addRunLookup):runLookup,j=0;j<lastRunLookup.length;j++){for(var expressionResultLookup="",r=0;r<lastRunLookup[j].formulaJson.elements.length;r++)expressionResultLookup+=this.expressionGetValue(record,lastRunLookup[j],lastRunLookup[j].formulaJson.elements[r],!1);try{record[lastRunLookup[j].label]||this.setHideFieldValue(lastRunLookup[j].label,expressionResultLookup),record[lastRunLookup[j].label]=eval(expressionResultLookup)}catch(e){record[lastRunLookup[j].label]=""}}}else if(currentField&&dependenciesFields.length>0){var then=this;dependenciesFields.forEach(function(item){for(var runDep1=$filter("filter")(resultArr,{label:item.child_field},!0),runDep2=$filter("filter")(resultArr,{fields:{name:item.child_field}},!0),allRunDep=runDep1.concat(runDep2),that=this,j=0;j<allRunDep.length;j++){for(var expressionResult="",r=0;r<allRunDep[j].formulaJson.elements.length;r++)expressionResult+=then.expressionGetValue(record,allRunDep[j],allRunDep[j].formulaJson.elements[r],!1);try{record[allRunDep[j].label]||that.setHideFieldValue(allRunDep[j].label,expressionResult),record[allRunDep[j].label]=eval(expressionResult)}catch(e){record[allRunDep[j].label]=""}}})}else{var resultLastArr=$filter("filter")(resultArr,{fields:{name:currentField.name}},!0),addRunAnyExp=[];
resultLastArr&&resultLastArr.length>0&&resultLastArr.forEach(function(e){if(e.treeIndex.length>0){var t=$filter("filter")(resultArr,{label:e.treeIndex[0]},!0)[0];addRunAnyExp.push(t)}});var resultLastArrRun=addRunAnyExp.length>0?resultLastArr.concat(addRunAnyExp):resultLastArr;this.expressionRecursiveRunValue(resultLastArrRun,resultArr,record,currentField,module.fields,!1)}else for(var j=0;j<resultArr.length;j++){var expressionResult="";resultArr[j].isRun=!0;for(var r=0;r<resultArr[j].formulaJson.elements.length;r++)expressionResult+=this.expressionGetValue(record,resultArr[j],resultArr[j].formulaJson.elements[r],!1);try{record[resultArr[j].label]||this.setHideFieldValue(resultArr[j].label,expressionResult),record[resultArr[j].label]=eval(expressionResult)}catch(e){record[resultArr[j].label]=""}}},expressionRecursiveRunValue:function(resultLastArr,resultArr,record,currentField,moduleFields,validate){for(var j=0;j<resultLastArr.length;j++){var expressionResult="";resultLastArr[j].isRun=!0;for(var r=0;r<resultLastArr[j].formulaJson.elements.length;r++)expressionResult+=this.expressionGetValue(record,resultLastArr[j],resultLastArr[j].formulaJson.elements[r]);try{record[resultLastArr[j].label]||this.setHideFieldValue(resultLastArr[j].label,expressionResult),record[resultLastArr[j].label]=eval(expressionResult)}catch(e){record[resultLastArr[j].label]=""}var resultTreeExp=$filter("filter")(resultArr,{label:resultLastArr[j].treeIndex[0]},!0)[0];resultLastArr[j].treeIndex.length>0&&this.expressionRecursiveRunValue(resultTreeExp,resultArr,record,currentField,moduleFields,validate)}},setHideFieldValue:function(e,t){$rootScope.hideFieldValue[e]=t},expressionRunValidation:function(resultArr,record,currentField,isSave,module,isValidate){if(!currentField&&isSave){for(var j=0;j<resultArr.length;j++)if(!this.exprressionDependencyControl(module,resultArr[j])){var expressionResult="";resultArr[j].isRun=!0;for(var h=0;h<resultArr[j].formulaJson.length;h++)for(var k=0;k<resultArr[j].formulaJson[h].elements.length;k++)expressionResult+=this.expressionGetValue(record,resultArr[j],resultArr[j].formulaJson[h].elements[k],isValidate);try{var resultExp=eval(expressionResult);if(resultExp===!1)return resultArr[j].validationMsg}catch(e){return resultArr[j].validationMsg}}}else if(currentField&&!isSave)for(var resultLastArr=$filter("filter")(resultArr,{label:currentField.name},!0),j=0;j<resultLastArr.length;j++)if(!this.exprressionDependencyControl(module,resultLastArr[j])){var expressionResult2="";resultLastArr[j].isRun=!0;for(var h=0;h<resultLastArr[j].formulaJson.length;h++)for(var k=0;k<resultLastArr[j].formulaJson[h].elements.length;k++)expressionResult2+=this.expressionGetValue(record,resultLastArr[j],resultLastArr[j].formulaJson[h].elements[k],isValidate);try{var resultExp2=eval(expressionResult2);if(resultExp2===!1)return resultLastArr[j].validationMsg}catch(e){return resultLastArr[j].validationMsg}}},setExpression:function(e,t,a,r,l,i){var n=[],o=[];$rootScope.moduleRecordData={picklist:a,module:e};var s=$filter("filter")($rootScope.expressionRunOrderData.Value,{moduleName:e.name},!0)[0],d=$filter("filter")($rootScope.expressionRunOrderData.Validation,{moduleName:e.name},!0)[0];if(s&&d)n=s.value,o=d.validation;else{var u=$filter("filter")(e.fields,function(e){return("text_single"===e.data_type||"text_multi"===e.data_type||"number"===e.data_type||"number_decimal"===e.data_type||"currency"===e.data_type)&&e.deleted===!1},!0);n=this.expressionRunOrder(u,t,!1),o=this.expressionRunOrder(u,t,!0);var p={moduleName:e.name,value:n},c={moduleName:e.name,validation:o};$rootScope.expressionRunOrderData.Value.push(p),$rootScope.expressionRunOrderData.Validation.push(c)}return i||this.expressionRunValue(n,t,r,e),this.expressionRunValidation(o,t,r,i,e,!0)},setDefaultValues:function(e,t,a){for(var r=!1,l=0;l<e.fields.length;l++){var i=e.fields[l];if(!i.deleted){var n=i.name;if(void 0!==i.default_value&&null!==i.default_value&&!t[n]){switch(i.data_type){case"text_single":case"text_multi":case"number":case"number_decimal":case"currency":r||(this.setExpression(e,t,a,null,!1,!1),r=!0);break;case"url":case"email":case"image":t[n]=i.default_value;break;case"date":case"time":case"date_time":"[now]"===i.default_value?(t[n]=new Date,t[n+"str"]="time"===i.data_type?kendo.toString(new Date,"t"):kendo.toString(new Date,"g")):(t[n]=new Date(i.default_value),t[n+"str"]="time"===i.data_type?kendo.toString(new Date(i.default_value),"t"):kendo.toString(new Date(i.default_value),"g"));break;case"picklist":var o=$filter("filter")(a[i.picklist_id],{id:parseInt(i.default_value)},!0)[0];o||(o={},o.id=t[n],o.type=i.picklist_id,o.label={},o.label.tr=t[n],o.label.en=t[n],o.labelStr=t[n],o.required=!1,o.order=9999,helper.getPicklists([i.picklist_id],!0)),t[i.name]=o;break;case"lookup":var s="[me]"!==i.default_value?parseInt(i.default_value):$rootScope.user.id,d=angular.copy(i);this.getRecord(i.lookup_type,s,!0).then(function(e){var a={};a.id=e.data.id,a.primary_value=e.data[d.lookupModulePrimaryField.name],t[d.name]=a});break;case"multiselect":var u=i.default_value.split(";");t[n]=[];for(var p=0;p<u.length;p++){var c=parseInt(u[p]);isNaN(c)||t[n].push(c)}break;case"checkbox":t[i.name]="true"===i.default_value;break;case"tag":t[n]=[];for(var f=i.default_value.split(","),p=0;p<f.length;p++){if(i.tag&&i.tag.dataSource&&i.tag.dataSource._data.length>0)var m=$filter("filter")(i.tag.dataSource._data,{text:f[p]},!0)[0];m&&t[n].push(m.id)}}this.setDisplayDependency(e,t)}}}},setDependency:function(e,t,a,r,l){var i=this;if(!a.id&&a.event_start_date&&"event_start_date"===e.name){var n=new Date(a.event_start_date);0===n.getHours()&&0===n.getSeconds()&&0===n.getMilliseconds()&&(n.setHours(8),a.event_start_date=n),a.event_end_date=new Date(n.getTime()+36e5)}if(a.event_start_date&&a.event_end_date&&"event_end_date"===e.name){var o=new Date(a.event_start_date),s=new Date(a.event_end_date);o>s&&(a.event_start_date=new Date(s.getTime()-36e5))}if(!a.id&&"start_date"===e.calendar_date_type&&a[e.name]){var d=new Date(a[e.name]);0===d.getHours()&&0===d.getSeconds()&&0===d.getMilliseconds()&&(d.setHours(8),a[e.name]=d);var u=$filter("filter")(t.fields,{calendar_date_type:"end_date"},!0)[0];u&&(a[u.name]=new Date(d.getTime()+36e5))}if("end_date"===e.calendar_date_type&&a[e.name]){var p=$filter("filter")(t.fields,{calendar_date_type:"start_date"},!0)[0];if(p&&a[p.name]){var d=new Date(a[p.name]),c=new Date(a[e.name]);d>c&&(a[p.name]=new Date(c.getTime()-36e5))}}if("task_due_date"===e.name&&$rootScope.taskReminderAuto){var f=new Date(a.task_due_date);f.setTime(f.getTime()+288e5),a.task_reminder=f}if(t.dependencies){var m=$filter("filter")(t.dependencies,{parent_field:e.name},!0);if(m&&m.length)for(var g=0;g<m.length;g++){var _=m[g];if(!_.deleted){var v=$filter("filter")(t.fields,{name:_.child_field},!0)[0];if(_.clear)a[_.child_field]=void 0,l.$broadcast("angucomplete-alt:clearInput",_.child_field);else{if(!v)continue;switch(_.dependency_type){case"list_value":case"list_field":a.id||(a[_.child_field]=null);for(var h=r[v.picklist_id],b=0;b<h.length;b++){var k=h[b];delete k.hidden}if("list_value"===_.dependency_type){if(!a[_.parent_field])continue;var y=[];for(var $ in _.value_maps)if(_.value_maps.hasOwnProperty($)){var w=_.value_maps[$];$===a[_.parent_field].id.toString()&&(y=w)}if(!y.length)continue;for(var S=0;S<h.length;S++){var x=h[S];y.indexOf(x.id)<0&&(x.hidden=!0)}}else if("list_field"===_.dependency_type){if(!a[_.parent_field]){for(var R=0;R<h.length;R++){var F=h[R];F.hidden=!0}continue}for(var I=a[_.parent_field][_.field_map_parent],L=0;L<h.length;L++){var M=h[L];M[_.field_map_child]!==I&&(M.hidden=!0)}}break;case"list_text":a[_.child_field]=a[_.parent_field]?a[_.parent_field].value||a[_.parent_field].label[$rootScope.language]:null;break;case"lookup_text":a[_.child_field]=a[_.parent_field]?a[_.parent_field][_.field_map_parent]:null;break;case"lookup_list":case"lookup_field":if(!a[_.parent_field])continue;var j=a[_.parent_field][_.field_map_parent],A=r[v.picklist_id],C=null;if("lookup_list"===_.dependency_type){for(var D=0;D<A.length;D++){var V=A[D];V[_.field_map_child]===j&&(C=V)}!C||a.id&&a[_.child_field]||(a[_.child_field]=C)}else if("lookup_field"===_.dependency_type&&j){var P=$filter("filter")($rootScope.modules,{name:v.lookup_type},!0)[0],U=angular.copy(v);U.lookupModulePrimaryField=$filter("filter")(P.fields,{name:_.field_map_child},!0)[0];var N=[v.lookupModulePrimaryField.name];i.lookup(j,U,a,N,!0).then(function(e){if(e[0]){var r=e[0];r.primary_value=r[v.lookupModulePrimaryField.name],a[_.child_field]=r,v.valueChangeDontRun=!0,i.customActions(t,a,l.moduleForm),l.$broadcast("angucomplete-alt:changeInput",_.child_field,r)}})}break;case"display":if(!a.id)switch(v.data_type){case"checkbox":var E="true"===v.default_value;a[_.child_field]=v.default_value?E:null;break;default:a[_.child_field]=v.default_value?v.default_value:null}}}this.calculate(v,t,a)}}}},setDependencyFilter:function(e,t,a,r){var l=angular.copy(a),i=angular.copy(e);if(e.indexOf(".")>-1){var n=e.split(".");l=$filter("filter")($rootScope.modules,{name:n[1]},!0)[0],i=n[2]}if(l.dependencies&&l.dependencies.length){var o=$filter("filter")(l.dependencies,{parent_field:i},!0);if(o&&o.length)for(var s=angular.copy(l.fields),d=0;d<o.length;d++){var u=o[d];if(!u.deleted){var p=$filter("filter")(s,{name:u.child_field},!0)[0];if(p&&t&&"list_field"===u.dependency_type){for(var c=r[p.picklist_id],f=0;f<c.length;f++){var m=c[f];delete m.hidden}for(var g=t[u.field_map_parent],_=0;_<c.length;_++){var v=c[_];v[u.field_map_child]!==g&&(v.hidden=!0)}}}}}},setDisplayDependency:function(e,t){if(e.display_dependencies)for(var a=0;a<e.display_dependencies.length;a++){var r=e.display_dependencies[a];if(!r.deleted){var l=null;if(l=r.dependent_section?$filter("filter")(e.sections,{name:r.dependent_section},!0)[0]:$filter("filter")(e.fields,{name:r.dependent_field},!0)[0])if(void 0!==t[r.field]){var i=null,n=angular.copy(t[r.field]);if(angular.isArray(n)){if(!t[r.field].length){l.hidden=!0,delete t[r.dependent_field];continue}for(var o=0;o<n.length;o++){var s=n[o],d=$filter("filter")(r.values,s,!0)[0];!i&&d&&(i=d)}}else r.values?n&&(i="boolean"==typeof n?n:n.id?$filter("filter")(r.values,n.id,!0)[0]:$filter("filter")(r.values,n,!0)[0]):i=n;if(r.otherwise||i)if(r.otherwise&&i){if(l.hidden=!0,"p_employees"===e.name&&("profile"===r.dependent_field||"email"===r.dependent_field))continue;delete t[r.dependent_field]}else{if(!r.dependent_section){var u=$filter("filter")(e.fields,{name:r.field},!0)[0];if(u.hidden){l.hidden=!0,delete t[r.dependent_field];continue}}l.hidden=!1}else{if(l.hidden=!0,"p_employees"===e.name&&("profile"===r.dependent_field||"email"===r.dependent_field))continue;delete t[r.dependent_field]}}else l.hidden=!0,delete t[r.dependent_field]}}},customActions:function(){},customValidations:function(){},setCustomCalculations:function(){},updateView:function(e,t){return $http.put(config.apiUrl+"view/update/"+t,e)},generatTd:function(e){var t={mobileContent:"",normalContent:""};switch(e.data_type){case"rating":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><input class="rating-stars" kendo-rating k-precision="\'half\'" k-label="false" k-max="getRatingCount(\''+e.name+"')\"  ng-init=\"rating = dataItem['"+e.name+'\']"  ng-model="rating" ng-disabled="true" /></div>',t.normalContent='<td class="hide-on-m2"><input class="rating-stars" kendo-rating k-precision="\'half\'" k-label="false" k-max="getRatingCount(\''+e.name+"', relatedModule)\"  ng-init=\"rating = dataItem['"+e.name+'\']"  ng-model="rating" ng-disabled="true"/></td>';break;case"image":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="image-preview image-preview-60"><div class="image-holder"><img ng-click="$event.stopPropagation(); showLightBox($event, (dataItem[\''+e.name+"'] ? dataItem : ''), true)\" ng-src=\"{{dataItem['"+e.name+"'] ? (config.imageUrl+dataItem['"+e.name+"']): 'images/no-image.png'}}\"/></div></div></div>",t.normalContent='<td class="hide-on-m2"><div ng-style="getImageStyle(\''+e.name+'\')" class="image-preview image-preview-60"><div class="image-holder"><img ng-click="$event.stopPropagation(); showLightBox($event, (dataItem[\''+e.name+"'] ? dataItem : ''), true, undefined, relatedModule)\" ng-src=\"{{dataItem['"+e.name+"'] ? (config.imageUrl+dataItem['"+e.name+"']): 'images/no-image.png'}}\"/>\n</div></div></td>";break;case"text_multi":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button d-block"><span ng-bind-html="dataItem[\''+e.name+"'] \"></span></div></div>",t.normalContent='<td class="hide-on-m2"  ng-bind-html="dataItem[\''+e.name+"']\"></td>";break;case"lookup":var a=!0;("users"===e.lookup_type||"roles"===e.lookup_type||"profiles"===e.lookup_type)&&(a=!1),t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+": </span><div ng-show=\"dataItem['"+e.name+'\']" class="grid-list-button"><span>{{dataItem[\''+e.name+"']}}</span><a ng-if=\""+a+'"  ng-click="$event.stopPropagation(); goToRecord(\''+e.name+"','"+e.lookup_type+"',"+a+", dataItem, '"+e.external_link+'\')"><i class= "fas fa-external-link-alt"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div ng-if="'+a+'" ng-show="dataItem[\''+e.name+'\']" class="grid-list-button"><span>{{dataItem[\''+e.name+"']}}</span><a ng-click=\"$event.stopPropagation(); goToRecord('"+e.name+"','"+e.lookup_type+"',"+a+", dataItem,'"+e.external_link+'\')"><i class= "fas fa-external-link-alt"></i></a></div><span class="text-nowrap" ng-if="!'+a+"\">{{dataItem['"+e.name+"']}}</span></span></td>";break;case"url":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\"> <span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="{{dataItem[\''+e.name+'\']}}" target="_blank"><i class= "fas fa-external-link-alt"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\"> <span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="{{dataItem[\''+e.name+'\']}}" target="_blank"><i class= "fas fa-external-link-alt"></i></a></div></td>';break;case"email":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\" ><span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="mailto:{{dataItem[\''+e.name+'\']}}" ><i class= "fas fa-paper-plane"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\" ><span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="mailto:{{dataItem[\''+e.name+'\']}}"><i class= "fas fa-paper-plane"></i></a></div></td>';break;case"document":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\"><span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="storage/record_file_download?fileName={{dataItem[\''+e.name+'\']}}"><i class= "fas fa-download"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\"><span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="storage/record_file_download?fileName={{dataItem[\''+e.name+'\']}}"><i class= "fas fa-download"></i></a></div></td>';break;case"tag":case"multiselect":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+'\']"><span class="grid-multiselect-text" ng-repeat="data in getTagAndMultiDatas(dataItem, dataItem[\''+e.name+'\'])">{{data}}</span > <button ng-show="dataItem.show" aria-label="{{\'Common.ShowMore\' | translate}}" ng-click="$event.stopPropagation(); showLightBox($event, dataItem, false, \''+e.name+'\')"> <i class="fas fa-ellipsis-v"></i><md-tooltip md-autohide="true" md-direction="bottom">{{\'Common.ShowMore\' | translate}}</md-tooltip></button></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+'\']"><span class="grid-multiselect-text" ng-repeat="data in getTagAndMultiDatas(dataItem, \''+e.name+'\')">{{data}}</span > <button ng-show="dataItem.show" aria-label="{{\'Common.ShowMore\' | translate}}" ng-click="$event.stopPropagation(); showLightBox($event, dataItem, false, \''+e.name+'\', relatedModule)"> <i class="fas fa-ellipsis-v"></i><md-tooltip md-autohide="true" md-direction="bottom">{{\'Common.ShowMore\' | translate}}</md-tooltip></button></div></td>';break;case"location":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="image-preview image-preview-60"><div class="image-holder"><img ng-click="$event.stopPropagation(); showLightBox($event, (dataItem[\''+e.name+"'] ? dataItem : ''), true, '"+e.name+"')\" ng-src=\"{{dataItem['"+e.name+"'] ? getLocationUrl(dataItem['"+e.name+"']) : 'images/no-location.png'}}\"/></div></div></div>",t.normalContent='<td class="hide-on-m2"> <div class="image-preview image-preview-60"><div class="image-holder"><img ng-click="$event.stopPropagation(); showLightBox($event, (dataItem[\''+e.name+"'] ? dataItem : ''), true, '"+e.name+"', relatedModule)\" ng-src=\"{{dataItem['"+e.name+"'] ? getLocationUrl(dataItem['"+e.name+"']) : 'images/no-location.png'}}\"/></div></td>";break;default:t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button"><span>{{ dataItem[\''+e.name+"'] }}</span></div></div>",t.normalContent='<td class="hide-on-m2"><span class="text-nowrap">{{ dataItem[\''+e.name+"'] }}</span></td>"}return t},generatoptionsItem:function(e,t,a){var r="'"+e+"'";switch(t){case"remove":return' <md-menu-item ng-if="controlRemove(dataItem)">\n <md-button id="deleteButton-{{dataItem.id}}" ng-click="recordDelete($event,'+a+","+r+')">\n <i class="fas fa-trash"></i> <span> '+$filter("translate")("Common.Delete")+"</span>\n </md-button>\n </md-menu-item>\n";case"copy":return' <md-menu-item ng-if="controlCopy(dataItem, relatedModule)">\n <md-button ui-sref="app.record({type: relatedModule ? relatedModule.related_module : module.name,clone:true,id:'+a+'})">\n <i class="fas fa-copy"></i> '+$filter("translate")("Common.Copy")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"edit":return' <md-menu-item ng-if="controlEdit(dataItem, relatedModule)">\n <md-button ui-sref="app.record({type: relatedModule ? relatedModule.related_module : module.name,id:'+a+'})">\n <i class="fas fa-edit"></i> '+$filter("translate")("Common.Edit")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"send-sms":return' <md-menu-item ng-if="user.profile.send_sms">\n <md-button  ng-click="selectRowSingle($event,dataItem); showSMSModal()" >\n <i class="fas fa-sms"></i> '+$filter("translate")("Module.SendSMS")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"send-email":return' <md-menu-item>\n <md-button ui-sref="app.record({type: relatedModule ? relatedModule.related_module : module.name,clone:true,id:dataItem.id})">\n <i class="fas fa-envelope"></i> '+$filter("translate")("Module.SendEMail")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"download":return' <md-menu-item>\n <md-button ng-click="selectRowSingle($event,dataItem); showSMSModal()">\n <i class="fas fa-file-download"></i> '+$filter("translate")("Common.Download")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"remove_relation":return' <md-menu-item ng-if="controlRemove(dataItem, relatedModule)">\n <md-button id="deleteButton-{{dataItemId}}" ng-click="deleteRelation($event, relatedModule, true, '+a+')">\n <i class="fas fa-minus-circle"></i> <span> '+$filter("translate")("Module.RemoveRelation")+"</span>\n </md-button>\n </md-menu-item>\n"}},generatRowtmpl:function(e,t,a){var r=this,l={columns:[],rowtempl:"",requestFields:[]},i="",n=!1,o="dataItem.id",s="";if(a.relatedModule&&"many_to_many"===a.relatedModule.relation_type){n=!0;var d=a.module.name!==a.relatedModule.related_module?a.relatedModule.related_module+"_id":a.relatedModule.related_module+"1_id",u=d+"."+a.relatedModule.related_module+".";o="dataItem['"+d+"']"}var p=["edit","copy","remove"],c={},f="";if(t){n&&p.indexOf("remove_relation")<0&&p.push("remove_relation");for(var m=0;m<p.length;m++)s+=r.generatoptionsItem(a.relatedModule.related_module,p[m],o);c={width:"40px",headerTemplate:'<input type="checkbox"  ng-model="isAllSelected[\''+a.relatedModule.related_module+"']\"  ng-click=\"selectAll($event,'"+a.relatedModule.related_module+'\')" id="header-chb-'+a.relatedModule.related_module+'" class="k-checkbox header-checkbox"><label class="k-checkbox-label" for="header-chb-'+a.relatedModule.related_module+'"></label>'},f='<td ng-click="$event.stopPropagation();" class="position-relative">  <input ng-model="dataItem.isChecked"  type="checkbox" id="{{'+o+'}}" ng-click="selectRow($event,dataItem,\''+a.relatedModule.related_module+'\')" class="k-checkbox row-checkbox"><label class="k-checkbox-label" for="{{'+o+'}}"></label></td>'}else{for(var m=0;m<p.length;m++)s+=r.generatoptionsItem(a.moduleName,p[m],o);c={width:"40px",headerTemplate:"<input type='checkbox' ng-if=' grid.dataSource.data().length>0' ng-checked='isAllSelected'  ng-click='selectAll($event, grid.dataSource.data())' id='header-chb' class='k-checkbox header-checkbox'><label class='k-checkbox-label' for='header-chb'></label>"},f='<td ng-click="$event.stopPropagation();" class="position-relative"><input ng-click="selectRow($event,dataItem);$event.stopPropagation();" ng-disabled="dataItem.freeze && !user.profile.has_admin_rights" ng-checked="isRowSelected(dataItem.id) || dataItem.selected"  type="checkbox" id="{{dataItem.id}}" class="k-checkbox row-checkbox"><label class="k-checkbox-label" for="{{dataItem.id}}"></label></td>'}l.rowtempl=l.rowtempl+f,l.columns.push(c),e.map(function(e){if(e&&e.name){u&&(e.name=u+e.name),e.name.contains(".languages.")&&(e.name=e.name.substring(0,e.name.indexOf(".label"))),l.requestFields.push(e.name),l.columns.push({title:e.labelExt?e.label+" "+e.labelExt:e.label,field:e.name,media:"(min-width: 575px)",groupable:!1});var t=r.generatTd(e,i);l.rowtempl=l.rowtempl+t.normalContent,i+=t.mobileContent}});var g={field:"",width:"50px"},_="";_=n?'<td ng-click="$event.stopPropagation();" class="padding0"> <button class="md-icon-button md-button md-blue-theme md-ink-ripple" id="deleteButton-{{dataItemId}}" ng-click="deleteRelation($event, relatedModule, true, dataItem[\''+a.relatedModule.related_module+'_id\'])">\n <i class="fas fa-minus-circle"></i>\n </button></td>':'<td ng-click="$event.stopPropagation();" class="padding0"><md-menu md-position-mode="target-right target">\n<md-button ng-show="dataItem.showRemove || dataItem.showCopy || dataItem.showEdit" ng-disabled="dataItem.freeze && !user.profile.has_admin_rights" class="md-icon-button" aria-label=" " ng-click="$mdMenu.open()"> <i class="fas fa-ellipsis-v"></i></md-button>\n <md-menu-content width="2" class="md-dense">\n'+s+"\n </md-menu-content>\n </md-menu></td>",l.rowtempl=l.rowtempl+'<td class="show-on-m2">'+i+"</td>";var v={title:"Items",media:"(max-width: 575px)"};if(a.activeView&&"report"===a.activeView.view_type&&a.activeView.aggregations){v.footerTemplate="";for(var h=0;h<a.activeView.aggregations.length;h++){var b=a.activeView.aggregations[h].aggregation_type+"("+a.activeView.aggregations[h].field+")";v.footerTemplate=v.footerTemplate+"  <div> {{ fieldskey['"+a.activeView.aggregations[h].field+"']['label_'+language] }} {{ 'Report."+a.activeView.aggregations[h].aggregation_type+"' | translate  }} : {{ "+b.replace("(","_").replace(")","")+"}} </div>"}}if(l.columns.push(v),""==s||a.tableOptinosMenuHide||(l.rowtempl=l.rowtempl+_,l.columns.push(g)),a.activeView&&"grid"===a.activeView.view_type)for(var k="<td class='k-group-cell'>&nbsp;</td>",m=0;m<a.gridGroupBy.length;m++)l.rowtempl=k+l.rowtempl;return l},createView:function(e){return $http.post(config.apiUrl+"view/create",e)},updateView:function(e,t){return $http.put(config.apiUrl+"view/update/"+t,e)},deleteView:function(e){return $http["delete"](config.apiUrl+"view/delete/"+e)},getViews:function(e,t,a){var r=this,l=$q.defer();if(t){var i=[],n={};n.active=!0;for(var o=[],s=1,d=0;d<t.length;d++){var u,p=t[d];if(p.indexOf(".")>-1){var c=p.split("."),f=$filter("filter")($rootScope.modules,{name:c[1]},!0)[0];u=$filter("filter")(f.fields,{name:c[2]},!0)[0]}else u=$filter("filter")(e.fields,{name:p},!0)[0];if(u&&r.hasFieldDisplayPermission(u)){var m={};m.field=p,m.order=s,o.push(m),s++}}return n.fields=o,i.push(n),l.resolve(i),l.promise}return a&&a.views?(l.resolve(a.views),l.promise):($http.get(config.apiUrl+"view/get_all/"+e.id).then(function(t){if(!t.data)return l.resolve([]),l.promise;for(var a=[],i=0;i<t.data.length;i++){for(var n=t.data[i],o=[],s=0;s<n.fields.length;s++){var d,u=n.fields[s];if(u.field.indexOf(".")>-1){var p=u.field.split("."),c=$filter("filter")($rootScope.modules,{name:p[1]},!0)[0];if(!c)continue;d=$filter("filter")(c.fields,{name:p[2]},!0)[0]}else d=$filter("filter")(e.fields,{name:u.field},!0)[0];d&&r.hasFieldDisplayPermission(d)&&o.push(u)}n.fields=o,n.label=n["label_"+$rootScope.language],a.push(n)}l.resolve(t.data)})["catch"](function(e){l.reject(e.data)}),l.promise)},getViewState:function(e,t){var a=$q.defer();return t&&t.viewState?(a.resolve(t.viewState),a.promise):($http.get(config.apiUrl+"view/get_view_state/"+e).then(function(e){a.resolve(e.data)})["catch"](function(e){a.reject(e.data)}),a.promise)},getViewFields:function(e,t){var a=this,r=Object.assign({},e),l=r.fields,i={};i.selectedFields=[],i.availableFields=[],i.primaryField="",l=$filter("filter")(l,{display_list:!0,lookup_type:"!relation"},!0);var n={name:"seperator-main",label:$rootScope.getLanguageValue(e.languages,"label","singular"),order:0,seperator:!0};l.push(n);var o=0;return angular.forEach(l,function(e){if("lookup"===e.data_type&&"relation"!==e.lookup_type){var t=$filter("filter")($rootScope.modules,{name:e.lookup_type},!0)[0];if(o+=1e3,null===t||void 0===t)return;var a={name:"seperator-"+t.name,order:o,seperator:!0};a.label=$rootScope.getLanguageValue(t.languages,"label","singular")+" ("+$rootScope.getLanguageValue(e.languages,"label")+")",l.push(a);var r=t.fields;r=$filter("filter")(r,{display_list:!0},!0),angular.forEach(r,function(a){return"lookup"===a.data_type?void(a.field=Object.assign({},a)):(a=Object.assign({},a),a.label=$rootScope.getLanguageValue(a.languages,"label"),a.labelExt="("+e.label+")",a.name=e.name+"."+t.name+"."+a.name,a.order=parseInt(a.order)+o,a.id=a.order,a.parent_id=o,void l.push(a))})}}),angular.forEach(l,function(r){if(!r.deleted&&(a.hasFieldDisplayPermission(r)||"large"===r.multiline_type)){var l=null;t.fields&&(l=$filter("filter")(t.fields,{field:r.name},!0)[0]);var n={};if(n.name=r.name,n.label=r.label,n.labelExt=r.labelExt,n.order=r.order,n.id=r.id,r.name.indexOf("seperator-")<0&&(n.parent_id=r.parent_id?r.parent_id:0),n.lookup_type=r.lookup_type,n.seperator=r.seperator,n.multiline_type=r.multiline_type,n.data_type=r.data_type,"lookup"===r.data_type&&(n.external_link=r.external_link?escape(r.external_link):"",n.name=r.name+"."+r.lookup_type+"."+r.lookupModulePrimaryField.name),l)n.order=l.order,n.id=l.id?l.id:l.order,n.parent_id=l.parent_id,i.selectedFields.push(n);else{var o=$filter("filter")(e.fields,{primary:!0},!0)[0];r.name!==o.name?i.availableFields.push(n):(n.primary=!0,i.selectedFields.push(n))}}}),i.selectedFields=$filter("orderBy")(i.selectedFields,"order"),i.availableFields=$filter("orderBy")(i.availableFields,"order"),i},setFilters:function(e,t,a,r,l,i,n){if("lookup"===t.data_type&&"users"===t.lookup_type&&"[me]"===r&&(r=$rootScope.user.id),"email"===t.data_type&&"[me.email]"===r&&(r=$rootScope.user.email),"date"===t.data_type&&r){{moment(r).format("YYYY-MM-DD")}moment(r).isValid()&&(r=moment(r).format("YYYY-MM-DD"))}e||(e=[]),("empty"===l||"not_empty"===l)&&(r="-");var o=$filter("filter")(e,{field:a,operator:l,no:parseInt(i)},!0)[0];if(o)o.operator=l,o.value=r,"document"===t.data_type&&(o.document_search=t.document_search);else{i=i?parseInt(i):e.length+1;var s={};s.field=a,s.operator=l,s.value=r,s.no=i,s.isView=n,"document"===t.data_type&&(s.document_search=t.document_search),e.push(s)}return e},getCSVData:function(e,t){var a=this,r=$q.defer(),l=angular.copy(e.findRequest[t.id]);return l.take=3e3,a.findCustom(e.locale||e.language,l).then(function(e){for(var a=e.data.data,l=[],i=[],n=$rootScope.modulus[t.related_module].fields,o=$filter("filter")(t.display_fields,function(e){return e.contains(".")},!0),s=0;s<t.display_fields.length;s++){var d=$filter("filter")(n,{name:t.display_fields[s]},!0)[0];if(d)i.push($rootScope.getLanguageValue(d.languages,"label")+(d.parentField?" ("+$rootScope.getLanguageValue(d.parentField.languages,"label")+")":""));else if(o)for(var u=0;u<o.length;u++){var p=o[u].split(".");if(p){d=$filter("filter")(n,{name:p[0]},!0)[0],i.push($rootScope.getLanguageValue(d.languages,"label")+(d.lookupModulePrimaryField?" ("+d.lookupModulePrimaryField.label+")":"")),o.splice(u,1);break}}}l.push(i);for(var c=0;c<a.length;c++){for(var f=a[c],m=[],g=t.display_fields,_=0;_<g.length;_++){var v=f[g[_]];m.push(v)}l.push(m)}r.resolve(l)}),r.promise},getYesNo:function(e){var t={};return t.yes=$filter("filter")(e,{system_code:"true"})[0].label[$rootScope.language],t.no=$filter("filter")(e,{system_code:"false"})[0].label[$rootScope.language],t},getIcons:function(){return icons2.icons},getActionButtons:function(e,t){var a=$q.defer(),r="action_button_"+e,l=$cache.get(r);return!l||t||preview?($http.get(config.apiUrl+"action_button/get/"+e).then(function(e){$cache.put(r,e.data),a.resolve(e.data)})["catch"](function(e){a.reject(e.data)}),a.promise):(a.resolve(l),a.promise)},hasFieldDisplayPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0],a=function(e){if(!e.sectionObj||!e.sectionObj.permissions)return!0;var t=$filter("filter")(e.sectionObj.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"none"!==t.type:!0};return t&&"none"===t.type?!1:a(e)},hasFieldReadOnlyPermission:function(e){if(!e.permissions)return!1;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"read_only"===t.type:!1},hasFieldFullPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0],a=function(e){if(!e.sectionObj||!e.sectionObj.permissions)return!0;var t=$filter("filter")(e.sectionObj.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"full"===t.type:!0};return t&&"full"!==t.type?!1:a(e)},hasSectionDisplayPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"none"!==t.type:!0},hasSectionReadOnlyPermission:function(e){if(!e.permissions)return!1;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"read_only"===t.type:!1},hasSectionFullPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"full"===t.type:!0},hasActionButtonDisplayPermission:function(e,t,a,r){if(e.visible){var l=!1,i=!1;if("all_users"===e.visible)l=!0;else if("profiles"===e.visible)if(void 0!==e.permissions){var n=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];l=!!n}else l=!0;return i=t?!0:this.hasActionButtonDisplayCriteria(r,e,a),l===!0&&i===!0}if(!e.permissions)return!0;var o=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return o?"none"!==o.type:!0},convertRecordValue:function(e){var t=null;
switch(e.field.data_type){case"date_time":case"date":if(!e.value)switch(e.costumeDate){case"costumeN":t="today("+e.valueX+e.nextprevdatetype+")";break;case"costumeM":t="this_month("+e.valueX+e.nextprevdatetype+")";break;case"costumeW":t="this_week("+e.valueX+e.nextprevdatetype+")";break;case"costumeY":t="this_year("+e.valueX+e.nextprevdatetype+")";break;case"now()":t=Date.now().toLocaleString();break;default:t="costume"===e.value.name?e.costumeDate:e.value.value}break;case"multiselect":var a="";angular.forEach(e.value,function(e){a+=e.label[$rootScope.language]+"|"}),t=a.slice(0,-1);break;case"checkbox":t=e.value.system_code.toString();break;case"tag":var a="";angular.forEach(e.value,function(e){a+=e.text+"|"}),t=a.slice(0,-1);break;case"lookup":t="users"===e.lookup_type?0===e.value[0].id?"[me]":e.value.id:e.value;break;case"picklist":t=e.value.labelStr;break;default:t=e.value}return t},buttonsFiltersConvertForRun:function(e,t,a,r){e.filters.forEach(function(e){if(null!=e.group)a.buttonsFiltersConvertForRun(e.group,t,a,r);else{r+=1;var l=!1,i=e.field;if(!i)return void($rootScope.filterLogicButtons="false");var n=i.name,o=e.value,s=t[n];if(o=a.convertRecordValue(e),"object"==typeof o&&"object"==typeof s&&"lookup"===e.field.data_type&&"users"===e.field.lookup_type){s=s.email;for(var d=0;d<o.length;d++){var u=o[d].email;if("[me]"===u){o=$rootScope.user.email;break}if(u===s){o=u;break}}}if(angular.isObject(s)&&s.languages&&(s=s.languages[$rootScope.globalization.Label].label),(null===s||void 0===s||null===o||void 0===o)&&(l=!1),o&&s)switch(e.operator.name){case"contains":l=s.toString().contains(o.toString());break;case"is":case"equals":l=s.toString()===o.toString();break;case"is_not":case"not_equal":l=s.toString()!==o.toString();break;case"greater":l=parseFloat(s.toString())>parseFloat(o.toString());break;case"greater_equal":l=parseFloat(s.toString())>=parseFloat(o.toString());break;case"less":l=parseFloat(s.toString())<parseFloat(o.toString());break;case"less_equal":l=parseFloat(s.toString())<=parseFloat(o.toString());break;case"empty":l=""===s||null===s||void 0===s;break;case"not_empty":l=angular.isObject(s)||angular.isDefined(s)&&null!=s&&""!==s&&s.length>0;break;case"not_contain":l=!s.toString().contains(o.toString());break;case"starts_with":l=s.toString().startsWith(o.toString());break;case"ends_with":l=s.toString().endsWith(o.toString())}$rootScope.filterLogicButtons=$rootScope.filterLogicButtons.replace(r,l.toString().toLocaleLowerCase())}})},hasActionButtonDisplayCriteria:function(module,actionButton,record){if($rootScope.filterLogicButtons=null,actionButton.filter_logic_json){$rootScope.filterLogicButtons=actionButton.filter_logic;var filterJson=JSON.parse(actionButton.filter_logic_json);if(0===filterJson.filters.length)return!0;var fullModule=$rootScope.modulus[module.name];this.convertFilterFields(filterJson,fullModule,!1);var index=0;return this.buttonsFiltersConvertForRun(filterJson,record,this,index),$rootScope.filterLogicButtons=$rootScope.filterLogicButtons.replaceAll("or","||"),$rootScope.filterLogicButtons=$rootScope.filterLogicButtons.replaceAll("and","&&"),eval($rootScope.filterLogicButtons)}return!0},convertFilterFields:function(e,t,a,r){if(null!=e.filters&&e.filters.length>0){const l=this;angular.forEach(e.filters,function(e){if(null!=e.group)l.convertFilterFields(e.group,t,a);else if(null!=e.operator&&""!==e.operator)if(a)e.field=angular.isObject(e.field)?e.field.value||e.field.id:e.field;else if(t.fields)e.field=angular.isObject(e.field)?e.field:$filter("filter")(t.fields,{id:e.field,deleted:!1},!0)[0];else{var i=angular.isObject(e.field)?e.field.value:e.field;(i.contains("[")||i.contains("]"))&&(e.field=i.replaceAll("[","").replaceAll("]",""));const n=angular.isObject(e.field)?e.field.value:e.field,o=n.contains(".")?n.split("."):[n],s=$filter("filter")(t,{label:o[0]},!0)[0];s?(e.field=$filter("filter")(s.properties,{name:o[1]},!0)[0],e.field.value=i):angular.isObject(e.field)||(e.field={value:n,data_type:"text_single",operators:r.text_single})}})}},getDailyRates:function(){return $http.get(config.apiUrl+"exchange_rates/get_daily_rates")},getAllTenantSettingsByType:function(e,t){return $http.get(config.apiUrl+"settings/get_all/"+e+(t?"?user_id="+t:""))},tenantSettingUpdate:function(e){return $http.put(config.apiUrl+"settings/update/"+e.id,e)},getReportByModule:function(e){return $http.get(config.apiUrl+"report/get_report_by_module/"+e)},getChartsTypes:function(){var e=[{label:$filter("translate")("Report.Chart.ColumnChart2d"),name:"column2d"},{label:$filter("translate")("Report.Chart.ColumnChart3d"),name:"column3d"},{label:$filter("translate")("Report.Chart.LineChart"),name:"line"},{label:$filter("translate")("Report.Chart.AreaChart"),name:"area2d"},{label:$filter("translate")("Report.Chart.BarChart2d"),name:"bar2d"},{label:$filter("translate")("Report.Chart.BarChart3d"),name:"bar3d"},{label:$filter("translate")("Report.Chart.PieChart"),name:"pie3d"},{label:$filter("translate")("Report.Chart.DoughnutChart2d"),name:"doughnut2d"},{label:$filter("translate")("Report.Chart.DoughnutChart3d"),name:"doughnut3d"},{label:$filter("translate")("Report.Chart.ScrollColumnChart"),name:"scrollcolumn2d"},{label:$filter("translate")("Report.Chart.ScrollLineChart"),name:"scrollline2d"},{label:$filter("translate")("Report.Chart.ScrollAreaChart"),name:"scrollarea2d"},{label:$filter("translate")("Report.Chart.FunnelChart"),name:"funnel"},{label:$filter("translate")("Report.Chart.PyramidChart"),name:"pyramid"}];return e},chartFilter:function(e){return $http.post(config.apiUrl+"view/chart_filter",e)},getUsersLookupData:function(e){for(var t=[],a=0;a<e.dataSource.length;a++)t.push({id:e.dataSource[a].id,full_name:e.dataSource[a].full_name});return t.push({id:"[me]",full_name:$filter("translate")("Common.LoggedInUser")}),e.dataSource=t,e},getChart:function(e){return $http.get(config.apiUrl+"view/get_chart/"+e)},getWidget:function(e){return $http.get(config.apiUrl+"view/get_widget/"+e)},saveView:function(e,t){return"edit"===e?$http.put(config.apiUrl+"view/update/"+t.id,t):$http.post(config.apiUrl+"view/create",t)},goToRecord:function(e,t,a,r,l){if(e){var i=e.split(".");i&&i.length>2&&(i[i.length-1]="id"),i=i.join("."),a&&(l&&""!=l?$window.open(unescape(l)+"?id="+r[i],"_self"):$window.open("#/app/record/"+t+"?id="+r[i],"_self"))}},getTagAndMultiDatas:function(e,t){return t&&t.length>3?(e.show=!0,t.splice(3,t.length-3)):e.show=!1,t},getImageStyle:function(e,t){var a=$rootScope.modulus[t];if(a){var r=$filter("filter")(a.fields,{name:e,deleted:!1})[0];if(r&&r.image_size_list>0){var l={width:r.image_size_list+"px",height:r.image_size_list+"px"};return l}}},getRatingCount:function(e,t){var a=$rootScope.modulus[t];if(a){var r=$filter("filter")(a.fields,{name:e,deleted:!1})[0];if(r)return r.max||5}},getLocationUrl:function(e){return"https://maps.googleapis.com/maps/api/staticmap?zoom=10&size=300x150&maptype=roadmap&markers=color:red|"+e+"&key="+googleMapsApiKey},openCalendar:function(e){var t=void 0;switch(e.data_type){case"date":t="kendoDatePicker";break;case"date_time":t="kendoDateTimePicker";break;case"time":t="kendoTimePicker"}if(t){const a=angular.element(document.getElementById(e.name)).data(t);a&&a.open()}},rangeRuleForForms:function(){return function(e){const t=parseInt(e[0].ariaValueMin,10),a=parseInt(e[0].ariaValueMax,10);var r=parseInt(e[0].minLength,10),l=parseInt(e[0].maxLength,10);const i=e.val(),n=parseInt(i,10),o=e[0].id||e[0].nextSibling.id;if((-1===r||-1===l)&&o){var s=o.split("_");if(s&&s.length>1)var d=$filter("filter")($rootScope.modules,{id:parseInt(s[1])},!0)[0];if(d){var u=$filter("filter")(d.fields,{name:s[0]},!0)[0];u&&(r=u.validation.min_length||0,l=u.validation.max_length||("text_single"===u.data_type?50:16))}}return!isNaN(r)&&!isNaN(l)&&i&&r>-1&&l>-1?r<=i.length&&i.length<=l:isNaN(t)||isNaN(a)||isNaN(r)||isNaN(l)||-1===r||-1===l?!0:isNaN(n)?!0:n>=t&&a>=n&&r<=i.length&&i.length<=l}},setMinMaxValueForField:function(e){return e.validation.min=e.validation.min||Number.MIN_SAFE_INTEGER,e.validation.max=e.validation.max||Number.MAX_SAFE_INTEGER,e},renderCurrencyFormat:function(e,t){e=e||"$";for(var a="",r=0;t>r;r++)a+="0";return"₺"===e?"#."+a+e:e+"#."+a},renderNumberDecimalFormat:function(e){for(var t="",a=0;e>a;a++)t+="0";return"#."+t},kendoCaleanderDataProcces:function(e,t,a,r){for(var l=[],i=0;i<e.length;i++)if(e[i][t.startdatefield]){var n={};n[t.startdatefield]=e[i][t.startdatefield],r?n[t.enddatefield]=e[i][t.enddatefield]:n.end=e[i][t.startdatefield],n.id=e[i].id,n[a]=e[i][a],l.push(n)}return l},getLanguageOptions:function(){return{dataSource:$rootScope.globalizations,dataTextField:"Language",dataValueField:"Label",filter:$rootScope.globalizations.length>10?"startswith":null,optionLabel:$filter("translate")("Common.Select")}},getPicklistValue:function(e,t){if(e&&t){const a=$filter("filter")($rootScope.globalizations,function(e){return e.Culture.substr(0,2)===tenantLanguage},!0)[0];var r=e.languages[a?a.Label:$rootScope.globalization.Label];if(r&&r.label===t)return e.languages[$rootScope.globalization.Label].label}},getMenuList:function(){return $http.get(config.apiUrl+"menu/get_all")},getMenuItemsByMenuId:function(e){return $http.get(config.apiUrl+"menu/get_menu_items/"+e)},proccesMenuItems:function(e){for(var t=[],a=0;a<e.length;a++){var r=e[a];r.expanded=!0,r.parent||(r.menu_items&&(r.items=r.menu_items),t.push(r))}return t=$filter("orderBy")(t,"order",!1)},moduleFilterById:function(e){return $filter("filter")($rootScope.modules,{id:e},!0)}}}]);