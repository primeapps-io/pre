angular.module("primeapps").factory("ModuleService",["$rootScope","$http","config","$q","$filter","$cache","$window","helper","operations","ngTableParams","icons2","dataTypes","operators","yesNo","components",function($rootScope,$http,config,$q,$filter,$cache,$window,helper,operations,ngTableParams,icons2,dataTypes,operators,yesNo,components){return{myAccount:function(){return $http.post(config.apiUrl+"User/MyAccount",{})},getAllUser:function(){return $http.get(config.apiUrl+"User/get_all")},getUserLicenseStatus:function(){return $http.post(config.apiUrl+"License/GetUserLicenseStatus",{})},addUser:function(e){return $http.post(config.apiUrl+"User/add_user",e)},deleteUser:function(e,t){return $http.post(config.apiUrl+"Instance/Dismiss",{UserID:e.ID,EMail:e.email,HasAccount:e.hasAccount,InstanceID:t})},getUserEmailControl:function(e){return $http.get(config.apiUrl+"User/get_user_email_control?Email="+e)},get:function(e){return $http.get(config.apiUrl+"template/get/"+e)},create:function(e){return $http.post(config.apiUrl+"module/create",e)},update:function(e,t){return $http.put(config.apiUrl+"module/update/"+t,e)},"delete":function(e){return $http["delete"](config.apiUrl+"module/delete/"+e)},createModuleRelation:function(e,t){return $http.post(config.apiUrl+"module/create_relation/"+t,e)},updateModuleRelation:function(e,t){return $http.put(config.apiUrl+"module/update_relation/"+t+"/"+e.id,e)},deleteModuleRelation:function(e){return $http["delete"](config.apiUrl+"module/delete_relation/"+e)},createModuleDependency:function(e,t){return $http.post(config.apiUrl+"module/create_dependency/"+t,e)},updateModuleDependency:function(e,t){return $http.put(config.apiUrl+"module/update_dependency/"+t+"/"+e.id,e)},deleteModuleDependency:function(e){return $http["delete"](config.apiUrl+"module/delete_dependency/"+e)},getRecord:function(e,t,a){return $http.get(config.apiUrl+"record/get/"+e+"/"+t,{ignoreNotFound:a})},getRecords:function(e,t){return $http.post(config.apiUrl+"record/get_all_by_id/"+e,t)},findCustom:function(e,t){return $http.post(config.apiUrl+"record/find_custom?locale="+e,t)},findRecords:function(e,t){return $rootScope.activeModuleName=null,$http.post(config.apiUrl+"record/find/"+e,t)},insertRecord:function(e,t){return $http.post(config.apiUrl+"record/create/"+e+"?timezone_offset="+-1*(new Date).getTimezoneOffset(),t)},updateRecord:function(e,t){return delete t.process_id,delete t.process_status,delete t.process_status_order,delete t.operation_type,delete t.process_request_updated_by,delete t.process_request_updated_at,delete t.freeze,$http.put(config.apiUrl+"record/update/"+e+"?timezone_offset="+-1*(new Date).getTimezoneOffset(),t)},deleteRecord:function(e,t){if($rootScope.branchAvailable&&"calisanlar"===e){var a=$q.defer(),r=this;return this.getRecord(e,t).then(function(l){if(l.data){var i=$filter("filter")($rootScope.workgroup.users,{email:l.data.e_posta},!0)[0];i&&r.deleteUser(i,$rootScope.workgroup.tenant_id),$http["delete"](config.apiUrl+"record/delete/"+e+"/"+t).then(function(e){return a.resolve(e),a.promise})}}),a.promise}return $http["delete"](config.apiUrl+"record/delete/"+e+"/"+t)},addRelations:function(e,t,a){return $http.post(config.apiUrl+"record/add_relations/"+e+"/"+t,a)},deleteRelation:function(e,t,a){return $http({method:"DELETE",url:config.apiUrl+"record/delete_relation/"+e+"/"+t,data:a,headers:{"Content-type":"application/json;charset=utf-8"}})},insertRecordBulk:function(e,t){for(var a=0;a<t.length;a++){t[a]}return $http.post(config.apiUrl+"record/create_bulk/"+e,t)},deleteRecordBulk:function(e,t){return $http({method:"DELETE",url:config.apiUrl+"record/delete_bulk/"+e,data:t,headers:{"Content-type":"application/json;charset=utf-8"}})},updateRecordBulk:function(e,t){return delete t.records.shared_users_edit,delete t.records.shared_users,delete t.records.shared_user_groups_edit,delete t.records.shared_user_groups,delete t.records.shared_read,$http({method:"Put",url:config.apiUrl+"record/update_bulk/"+e,data:t,headers:{"Content-type":"application/json;charset=utf-8"}})},findPicklist:function(e){return $http.post(config.apiUrl+"picklist/find",e)},setViewState:function(e,t,a){return a&&(e.id=a),e.module_id=t,$http.put(config.apiUrl+"view/set_view_state",e)},deleteView:function(e){return $http["delete"](config.apiUrl+"view/delete/"+e)},approveMultipleProcessRequest:function(e,t){return $http.put(config.apiUrl+"process_request/approve_multiple_request",{record_ids:e,module_name:t})},approveProcessRequest:function(e,t,a){return $http.put(config.apiUrl+"process_request/approve",{record_id:a,module_name:t,operation_type:e})},rejectProcessRequest:function(e,t,a,r){return $http.put(config.apiUrl+"process_request/reject",{record_id:r,module_name:t,operation_type:e,message:a})},deleteProcessRequest:function(e,t){return $http.put(config.apiUrl+"process_request/delete",{record_id:t,module_id:e})},send_approval:function(e,t,a){return $http.put(config.apiUrl+"process_request/send_approval",{record_id:a,module_name:t,operation_type:e})},sendApprovalManuel:function(e){return $http.post(config.apiUrl+"process_request/send_approval_manuel",e)},getProcess:function(e){return $http.get(config.apiUrl+"process/get/"+e)},getAllProcess:function(){return $http.get(config.apiUrl+"process/get_all")},sendSMS:function(e,t,a,r,l,i,n){return $http.post(config.apiUrl+"messaging/send_sms",{module_id:e,ids:t,query:a,is_all_selected:r,message:l,phone_field:i,template_id:n.id})},sendEMail:function(e,t,a,r,l,i,n,o,d,s,p,u,c,m,f){return $http.post(config.apiUrl+"messaging/send_email_job",{module_id:e,Ids:t,Query:a,is_all_selected:r,template_id:l.id,e_mail_field:i,Cc:n,Bcc:o,sender_alias:d,provider_type:p,sender_e_mail:s,attachment_container:u,subject:c,attachment_link:m,attachment_name:f})},getTemplates:function(e,t){return $http.get(config.apiUrl+"template/get_all?moduleName="+e+"&type="+t)},processRecordSingle:function(e,t,a){for(var r=0;r<t.fields.length;r++){var l=t.fields[r];this.processRecordField(e,l,a)}return e},formatRecordFieldValues:function(e,t,a){for(var r=0;r<t.fields.length;r++){var l=t.fields[r];this.formatFieldValue(l,e[l.name],a,e,t)}},processRecordMulti:function(e,t,a,r,l,i,n,o,d,s,p,u){for(var c=[],m=function(e,t,a,r,l,i,n,o,d,s,p,u){var c="#/app/record/";if(p.external_link)return void(e.link=u?p.external_link+"?id="+e.value_id+"&back="+a:p.external_link+"?id="+t.id+"&back="+a);var m;if(s&&(m=s.$parent.record),s&&!m&&(m=s.$parent.$parent.record),s&&!m&&(m=s.$parent.$parent.$parent.record),e.primary||"email"===e.data_type||"url"===e.data_type||"lookup"===e.data_type||"location"===e.data_type){if(e.primary&&!e.isJoin)return void(e.link=c+a+"?id="+t.id+(l?"&ptype="+r+"&pid="+l+"&rtab="+i+(m&&m.freeze?"&freeze=true":"")+(o?"&pptype="+n+"&ppid="+o+"&prtab="+d:""):""));if(e.primary&&e.isJoin&&"users"!==e.value_type&&"profiles"!==e.value_type&&"roles"!==e.value_type)return void(e.link=c+e.value_type+"?id="+e.value_id+(l?"&ptype="+r+"&pid="+l+(m&&m.freeze?"&freeze=true":""):"&back="+a));if("lookup"===e.data_type&&"users"!==e.lookup_type&&"profiles"!==e.lookup_type&&"roles"!==e.lookup_type){var f=e.lookup_type;"object"==typeof e.lookup_type&&(f=e.lookup_type.id);var _=t[e.name+"."+f+".id"];return void(e.link=c+f+"?id="+_+(l?"&ptype="+r+"&pid="+l+"&rtab="+i+(m&&m.freeze?"&freeze=true":"")+(o?"&pptype="+n+"&ppid="+o+"&prtab="+d:""):"&back="+a))}"email"===e.data_type&&(e.link="mailto:"+e.value),"url"===e.data_type&&(e.link=e.value),"location"===e.data_type&&(e.link="http://www.google.com/maps/place/"+e.value)}},f=function(e,t,a,r,l){switch(e.data_type){case"text_single":e.mask&&l?t.valueFormatted=$filter("mask")(l,e.mask):(t.value=l,t.valueFormatted=e.valueFormatted);break;case"lookup":if(!a[r])return;t.value=a[r],t.lookup_type="relation"!==e.lookup_type?e.lookup_type:a[e.lookup_relation],t.valueFormatted=t.value;break;case"picklist":case"multiselect":case"tag":case"checkbox":t.value=e.valueFormatted,t.valueFormatted=e.valueFormatted;break;default:t.value=l,t.valueFormatted=e.valueFormatted}},_=0;_<e.length;_++){var g=e[_],h=g;h.id=g.id||g[t.name+"_id"],g["process.process_requests.process_id"]?(h.isProcessItem=!0,h["process.process_requests.process_status"]=g["process.process_requests.process_status"]):h.isProcessItem=!1,h.shared_users_edit=g.shared_users_edit,h.shared_users=g.shared_users,h.shared_user_groups_edit=g.shared_user_groups_edit,h.shared_user_groups=g.shared_user_groups,h.shared_read=g.shared_read,h.fields=[];for(var v=0;v<r.length;v++){var y=r[v],k=angular.copy(t),b=y.field,$=!1;if(y.field.indexOf(".")>-1){var w=y.field.split(".");if(null!=w[3]&&"primary"===w[3])continue;k=$filter("filter")($rootScope.modules,{name:w[1]},!0)[0],b=w[2],$=!0}for(var S=0;S<k.fields.length;S++){var I=k.fields[S];if(b===I.name&&this.hasFieldDisplayPermission(I)){if(null==a){var F=this.getPicklists(t);a=F.$$state.value}this.processRecordsField(g,I,!0),this.formatFieldValue(I,g[y.field],a,g,t);var M={data_type:I.data_type,name:I.name,primary:I.primary,value:"",isJoin:$,isHtml:I.multiline_type_use_html,image_size_list:I.image_size_list};"rating"===I.data_type&&(M.max=I.validation.min_length);for(var C in g)if(g.hasOwnProperty(C)){var U=g[C],x=!1;if(C.indexOf(".")>-1){var P=C.split(".");$&&I.primary&&(M.value_id=g[P[0]+"."+P[1]+".id"],M.value_type=P[1],x=!0),C=P[2]}if(C!==I.name)continue;f(I,M,g,C,U),m(M,g,l,n,i,o,d,s,p,u,I,x)}M.order=y.order||I.order,h[I.name+"_data"]=M}}}c.push(h)}return c},processRecordField:function(e,t,a){var r=t.name;switch(t.data_type){case"lookup":var l={},i=null===e[r+".id"];void 0===e[r+".id"]&&(t.inline_edit=!1,i=!0);for(var n in e)if(e.hasOwnProperty(n)){var o=e[n];if(n.startsWith(r+".")){if(!i){var d=n.split(".");if(d[0]!==t.name)continue;l[d[1]]=o}delete e[n]}}if(i)return;if("users"===t.lookup_type)l.primary_value=l.full_name;else if("profiles"===t.lookup_type)l.primary_value=l["name_"+$rootScope.language];else if("roles"===t.lookup_type)l.primary_value=l["label_"+$rootScope.user.tenant_language];else if("relation"===t.lookup_type)l=e[t.lookup_relation]&&e.related_to?e.related_to:null;else{var s=$filter("filter")($rootScope.modules,{name:t.lookup_type},!0)[0],p=$filter("filter")(s.fields,{primary:!0,deleted:!1},!0)[0];l.primary_value=l[p.name]}e[r]=l;break;case"picklist":var u=$filter("filter")(a[t.picklist_id],{labelStr:e[r],inactive:"!true"},!0)[0];e[r]=u;break;case"multiselect":var c=[];if(e[r]){angular.isArray(e[r])||(e[r]=e[r].split(";"));for(var m=0;m<e[r].length;m++){var f=e[r][m],u=$filter("filter")(a[t.picklist_id],function(e){return e["label_"+$rootScope.language]===f&&e.inactive!==!0},!0)[0];u&&c.push(u.id)}}e[r]=c;break;case"date":case"date_time":case"time":if(void 0===e[r]||null===e[r]||!e[r].length)return;e[r+"str"]="time"===t.data_type?kendo.toString(new Date(e[r]),"t"):kendo.toString(new Date(e[r]),"g");break;case"tag":void 0!==e[r]&&null!==e[r]&&e[r].length||(e[r]=[])}},processRecordsField:function(e,t){var a=t.name;switch(t.data_type){case"lookup":var r=$filter("filter")($rootScope.modules,{name:t.lookup_type},!0)[0];if(null===r||void 0===r)return;var l=$filter("filter")(r.fields,{primary:!0},!0)[0];e[a]=e[t.name+"."+t.lookup_type+"."+l.name+".primary"];break;case"date":case"date_time":case"time":if(void 0===e[a]||null===e[a]||!e[a].length)return;e[a]=new Date(e[a])}},processUser:function(e){var t={};return t.id=e.id,t.primary_value=e.first_name+" "+e.last_name,t.email=e.email,t},processRecords:function(e,t,a){for(var r=[],l=angular.copy(e),i=0;i<l.length;i++){for(var n=l[i],o=0;o<t.fields.length;o++){var d=t.fields[o];this.processRecordsField(n,d,a),this.formatFieldValue(d,n[d.name],a,n,t)}r.push(n)}return r},formatFieldValue:function(e,t,a,r,l){if(e.valueFormatted="",void 0!==t&&null!==t)switch(e.data_type){case"number_decimal":e.valueFormatted=$filter("number")(t,e.decimal_places||2);break;case"number_auto":var i=t.toString();e.auto_number_prefix&&(i=e.auto_number_prefix+i),e.auto_number_suffix&&(i+=e.auto_number_suffix),e.valueFormatted=i;break;case"currency":var n;if(r&&r.currency)if(angular.isObject(r.currency))n=r.currency.value;else{var o=$filter("filter")(l.fields,{name:"currency"},!0)[0],d=$filter("filter")(a[o.picklist_id],{labelStr:r.currency})[0];d&&d.value&&(n=d.value)}e.valueFormatted=$filter("currency")(t,n||e.currency_symbol||$rootScope.currencySymbol,e.decimal_places||2);break;case"date":e.valueFormatted=$filter("date")(t,"shortDate");break;case"date_time":e.valueFormatted=$filter("date")(t,"short");break;case"time":e.valueFormatted=$filter("date")(t,"shortTime");break;case"picklist":if(angular.isObject(t))e.valueFormatted=t.label[$rootScope.language];else{var s=$filter("filter")(a[e.picklist_id],{labelStr:t},!0)[0];e.valueFormatted=s?s.label[$rootScope.language]:t}break;case"multiselect":for(var p=0;p<t.length;p++){var u=t[p];if(angular.isObject(u))e.valueFormatted+=(u.label?u.label[$rootScope.language]:"")+"; ";else{var s=$filter("filter")(a[e.picklist_id],{labelStr:u},!0)[0];e.valueFormatted+=(s?s.label[$rootScope.language]:u)+"; "}}e.valueFormatted=e.valueFormatted.slice(0,-2);break;case"tag":for(var p=0;p<t.length;p++){var u=t[p];e.valueFormatted+=angular.isObject(u)?" "+u:" "+u+";"}break;case"checkbox":e.valueFormatted=$filter("filter")(a.yes_no,{system_code:t.toString()})[0].label[$rootScope.language];break;default:e.valueFormatted=t}},getPicklists:function(e,t){var a=$q.defer(),r=angular.copy(e.fields),l={},i=[];if(t)for(var n=0;n<e.fields.length;n++){var o=e.fields[n];if("lookup"===o.data_type&&"users"!==o.lookup_type&&"profiles"!==o.lookup_type&&"roles"!==o.lookup_type&&"relation"!==o.lookup_type){var d=$filter("filter")($rootScope.modules,{name:o.lookup_type},!0)[0];if(!d)continue;for(var s=0;s<d.fields.length;s++){var p=d.fields[s];("picklist"===p.data_type||"multiselect"===p.data_type)&&r.push(p)}}}for(var u=function(t,a){if(e.dependencies&&e.dependencies.length>0){var r=$filter("filter")(e.dependencies,{child_field:a.name},!0)[0];if(r&&r.deleted!==!0&&"list_field"===r.dependency_type)for(var l=0;l<t.length;l++){var i=t[l];i.hidden=!0}}},c=0;c<r.length;c++){var m=r[c];if(m.picklist_id){var f=$cache.get("picklist_"+m.picklist_id);if(9e5===m.picklist_id){if(f){l[m.picklist_id]=f;continue}for(var _=[],g=0;g<$rootScope.modules.length;g++){var h=$rootScope.modules[g];if(h.display&&"activities"!==h.name&&helper.hasPermission(h.name,operations.read)){var v={};v.id=parseInt(h.id)+9e5,v.type=9e5,v.system_code=h.name,v.order=h.order,v.label={},v.label.en=h.label_en_singular,v.label.tr=h.label_tr_singular,v.labelStr=h["label_"+$rootScope.user.tenant_language+"_singular"],v.value=h.name,_.push(v)}}_=$filter("orderBy")(_,"order"),l[9e5]=_,$cache.put("picklist_"+9e5,_);continue}f?(f=$filter("orderByLabel")(f,$rootScope.language),m.picklist_sortorder&&!m.deleted&&(f=$filter("orderBy")(f,m.picklist_sortorder)),u(f,m),l[m.picklist_id]=f):i.push(m.picklist_id)}}var y=$cache.get("picklist_activity_type");y&&(l.activity_type=y);var k=$cache.get("picklist_yes_no");return l.yes_no=k?k:yesNo,i.length<=0?(a.resolve(l),a.promise):(i=i.getUnique(),this.findPicklist(i).then(function(t){if(!t.data)return a.resolve(l),a.promise;for(var n=0;n<r.length;n++){var o=r[n];if(o.picklist_id&&!(i.indexOf(o.picklist_id)<0)){var d=helper.mergePicklists(t.data);if(l[o.picklist_id]=$filter("filter")(d,{type:o.picklist_id},!0),l[o.picklist_id]=$filter("orderByLabel")(l[o.picklist_id],$rootScope.language),o.picklist_sortorder&&!o.deleted&&(l[o.picklist_id]=$filter("orderBy")(l[o.picklist_id],o.picklist_sortorder)),e.dependencies&&e.dependencies.length>0){var s=$filter("filter")(e.dependencies,{child_field:o.name},!0)[0];if(s&&1!=s.deleted&&"list_field"===s.dependency_type)for(var p=0;p<l[o.picklist_id].length;p++){var c=l[o.picklist_id][p];c.hidden=!0}}u(l[o.picklist_id],o),$cache.put("picklist_"+o.picklist_id,l[o.picklist_id])}}a.resolve(l)})["catch"](function(e){a.reject(e.data)}),a.promise)},moduleFieldsConvertByKey:function(e){for(var t=[],a=0;a<e.length;a++)t[e[a].name]=e[a];return t},lookup:function(e,t,a,r,l,i){var n=$q.defer(),o=t.lookup_type,d=this,s="lookup"===t.data_type&&t.show_as_dropdown;if("text_single"!==t.lookupModulePrimaryField.data_type&&"picklist"!==t.lookupModulePrimaryField.data_type&&"email"!=t.lookupModulePrimaryField.data_type&&"number"!==t.lookupModulePrimaryField.data_type&&"number_auto"!==t.lookupModulePrimaryField.data_type)return n.resolve([]),n.promise;if("relation"===o&&(o=void 0!==a[t.lookup_relation]?a[t.lookup_relation].value:null),!o)return n.resolve([]),n.promise;if(!e&&!s)return n.resolve([]),n.promise;var p=$filter("filter")($rootScope.modules,{name:o},!0)[0],u=[];if(u.push(t.lookupModulePrimaryField.name),r)for(var c=0;c<r.length;c++){var m=r[c];m!==t.lookupModulePrimaryField.name&&"id"!==m&&u.push(m)}var f=[];if("number"!==t.lookupModulePrimaryField.data_type&&"number_auto"!==t.lookupModulePrimaryField.data_type)if(l)f.push({field:t.lookupModulePrimaryField.name,operator:"is",value:e,no:1});else switch(t.lookup_search_type){case"contains":f.push({field:t.lookupModulePrimaryField.name,operator:"contains",value:e,no:1});break;case"starts_with":f.push({field:t.lookupModulePrimaryField.name,operator:"starts_with",value:e,no:1});break;default:f.push({field:t.lookupModulePrimaryField.name,operator:"starts_with",value:e,no:1})}else f.push({field:t.lookupModulePrimaryField.name,operator:"equals",value:parseInt(e),no:1});var _={fields:u,filters:f,sort_field:t.lookupModulePrimaryField.name,sort_direction:"asc",limit:1e3,offset:0};s&&(_.filters=[],_.limit=1e3);var g=_.filters.length;("users"===p.name||$rootScope.branchAvailable&&"branches"===o)&&_.filters.push({field:"is_active",operator:"equals",value:!0,no:g+1}),"users"===p.name&&_.filters.push({field:"email",operator:"not_contain",value:"integration_",no:g+1});var h=d.moduleFieldsConvertByKey(p.fields);if(t.filters)for(var v=_.filters.length,y=0;y<t.filters.length;y++){var k=t.filters[y];v++;var b,$=k.value.match(/^\W+(.+)]/i);if(null!==$&&"users"!==t.lookup_type&&"profiles"!==t.lookup_type&&"roles"!==t.lookup_type){var w=$[1].split(".");1===w.length&&a[w[0]]&&(b=a[w[0]]),2===w.length&&a[w[0]]&&(b=a[w[0]][w[1]]),3===w.length&&a[w[0]]&&(b=a[w[0]][w[1]][w[2]]),null!=b&&(_.filters.push({field:k.filter_field,operator:k.operator,value:b,no:v}),_.fields.push(k.filter_field))}else{var S=h[k.filter_field];switch(S.data_type){case"multiselect":case"tag":b=k.value.split("|");break;default:b=k.value}_.filters.push({field:k.filter_field,operator:k.operator,value:b,no:v}),_.fields.push(k.filter_field)}}if(i)for(var I=0;I<i.length;I++){var F=i[I];F.no=_.filters.length+1,_.filters.push(F)}return this.findRecords(o,_).then(function(e){if(!e.data||!e.data.length)return n.resolve([]),n.promise;var a=[];if(r)d.getPicklists(p).then(function(r){for(var l=0;l<e.data.length;l++){var i=e.data[l],o=angular.copy(i);o=d.processRecordSingle(o,p,r),o.primary_value=i[t.lookupModulePrimaryField.name],a.push(o),n.resolve(a)}});else for(var l=0;l<e.data.length;l++){var i=e.data[l];"profiles"===o&&1===i.id&&(i.name="tr"===$rootScope.user.tenant_language?"Sistem Yöneticisi":"Administrator");var s=angular.copy(i);s.primary_value=i[t.lookupModulePrimaryField.name],a.push(s),n.resolve(a)}})["catch"](function(e){n.reject(e.data)}),n.promise},prepareRecord:function(e,t,a){function r(e){var t=document.createElement("div");return t.innerHTML=e,t.innerHTML.toString()}var l=angular.copy(e),i=angular.copy(a);if(a)for(var n=0;n<t.dependencies.length;n++){var o=t.dependencies[n];if("display"===o.dependency_type&&!o.deleted&&!angular.equals(e[o.parent_field],a[o.parent_field]))if(o.values_array&&o.values_array.length>0){for(var d=!0,s=0;s<o.values_array.length;s++){var p=o.values_array[s];if(Array.isArray(e[o.parent_field]))for(var u=0;u<e[o.parent_field].length;u++){var c=e[o.parent_field][u];c.toString()===p&&(d=!1)}else e[o.parent_field].id.toString()===p&&(d=!1)}d&&o.child_field&&(l[o.child_field]=null)}else!e[o.parent_field]&&o.child_field&&(l[o.child_field]=null)}for(var n=0;n<t.fields.length;n++){var m=t.fields[n];if("string"==typeof l[m.name]&&""===l[m.name].trim()&&(l[m.name]=void 0),a||l[m.name])if(!a||a[m.name]||l[m.name])if("checkbox"===m.data_type&&null===l[m.name]&&a[m.name]&&(l[m.name]=!1),m.deleted)delete l[m.name];else if("tag"===m.data_type&&(angular.isArray(l[m.name])&&l[m.name].length<1||null===l[m.name])&&(angular.isArray(a[m.name])&&a[m.name].length<1||null===a[m.name]))delete l[m.name];else if(void 0!==l[m.name]&&null!==l[m.name]){switch(i||(i={}),m.data_type){case"number":l[m.name]=parseInt(l[m.name]),i[m.name]=i[m.name]?parseInt(i[m.name]):null;break;case"number_decimal":break;case"checkbox":null===l[m.name]&&void 0===l[m.name]&&(l[m.name]=!1);break;case"currency":l[m.name]=parseFloat(l[m.name]),i[m.name]=i[m.name]?parseFloat(i[m.name]):null;break;case"date":var f=moment(l[m.name]).format().split("+"),_=moment(i[m.name]).format().split("+");l[m.name]=f[0],i[m.name]=i[m.name]?_[0]:null;break;case"picklist":case"lookup":l[m.name]=l[m.name].id,i[m.name]=i[m.name]?i[m.name].id:null;break;case"text_multi":var g=l[m.name];if(m.multiline_type_use_html===!0){var h=r(g);l[m.name]=h}break;case"multiselect":for(var v=[],y=[],s=0;s<l[m.name].length;s++){var k=l[m.name][s];v.push(k)}if(i[m.name])for(var u=0;u<i[m.name].length;u++){var b=i[m.name][u];y.push(b)}l[m.name]=v&&v.length?v:null,i[m.name]=y&&y.length?y:null;break;case"tag":l[m.name]=l[m.name].toString()}a&&angular.equals(i[m.name],l[m.name])&&delete l[m.name]}else l[m.name]=null;else delete l[m.name]}if(l.shared_read&&l.shared_read.length){l.shared_users=[],l.shared_user_groups=[];for(var $=0;$<l.shared_read.length;$++){var w=l.shared_read[$];"user"===w.type&&l.shared_users.push(w.id),"group"===w.type&&l.shared_user_groups.push(w.id)}l.shared_users.length||(l.shared_users=null),l.shared_user_groups.length||(l.shared_user_groups=null),delete l.shared_read}else l.shared_users=null,l.shared_user_groups=null,delete l.shared_read;if(l.shared_edit&&l.shared_edit.length){l.shared_users_edit=[],l.shared_user_groups_edit=[];for(var S=0;S<l.shared_edit.length;S++){var I=l.shared_edit[S];"user"===I.type&&l.shared_users_edit.push(I.id),"group"===I.type&&l.shared_user_groups_edit.push(I.id)}l.shared_users_edit.length||(l.shared_users_edit=null),l.shared_user_groups_edit.length||(l.shared_user_groups_edit=null),delete l.shared_edit}else l.shared_users_edit=null,l.shared_user_groups_edit=null,delete l.shared_edit;return l},prepareRecordBulk:function(e,t){for(var a=this,r=[],l=0;l<e.length;l++){var i=e[l],n=a.prepareRecord(i,t);r.push(n)}return r},calculate:function(field,module,record){if(module.calculations){var calculation=$filter("filter")(module.calculations,{field_1:field.name},!0)[0];if(calculation||(calculation=$filter("filter")(module.calculations,{field_2:field.name},!0)[0]),calculation){var calculations=$filter("filter")(module.calculations,{result_field:calculation.result_field},!0);calculations=$filter("orderBy")(calculations,"order");for(var result=0,resultField="",i=0;i<calculations.length;i++){var calculation=calculations[i];result=eval((result||record[calculation.field_1]||0)+calculation.operator+(record[calculation.field_2]||calculation.custom_value||0)),resultField=calculation.result_field}record[resultField]=result||0,this.setCustomCalculations(module,record)}}},setDefaultValues:function(e,t,a){for(var r=0;r<e.fields.length;r++){var l=e.fields[r];if(!l.deleted){var i=l.name;if(void 0!==l.default_value&&null!==l.default_value&&!t[i]){switch(l.data_type){case"text_single":case"text_multi":case"number":case"number_decimal":case"currency":case"url":case"email":case"image":t[i]=l.default_value;break;case"date":case"time":case"date_time":"[now]"===l.default_value?(t[i]=new Date,t[i+"str"]="time"===l.data_type?kendo.toString(new Date,"t"):kendo.toString(new Date,"g")):(t[i]=new Date(l.default_value),t[i+"str"]="time"===l.data_type?kendo.toString(new Date(l.default_value),"t"):kendo.toString(new Date(l.default_value),"g"));break;case"picklist":var n=$filter("filter")(a[l.picklist_id],{id:parseInt(l.default_value)},!0)[0];n||(n={},n.id=t[i],n.type=l.picklist_id,n.label={},n.label.tr=t[i],n.label.en=t[i],n.labelStr=t[i],n.required=!1,n.order=9999,helper.getPicklists([l.picklist_id],!0)),t[l.name]=n;break;case"lookup":var o="[me]"!==l.default_value?parseInt(l.default_value):$rootScope.user.id,d=angular.copy(l);this.getRecord(l.lookup_type,o,!0).then(function(e){var a={};a.id=e.data.id,a.primary_value=e.data[d.lookupModulePrimaryField.name],t[d.name]=a});break;case"multiselect":var s=l.default_value.split(";");t[i]=[];for(var p=0;p<s.length;p++){var u=s[p],c=$filter("filter")(a[l.picklist_id],{id:parseInt(u)},!0)[0];c||(c={},c.id=t[i],c.type=l.picklist_id,c.label={},c.label.tr=t[i],c.label.en=t[i],c.labelStr=t[i],c.required=!1,c.order=9999,c.inactive||helper.getPicklists([l.picklist_id],!0)),l.default_value&&t[i].push(c)}break;case"checkbox":t[l.name]="true"===l.default_value}this.setDisplayDependency(e,t)}}}},setDependency:function(e,t,a,r,l){var i=this;if(!a.id&&a.event_start_date&&"event_start_date"===e.name){var n=new Date(a.event_start_date);0===n.getHours()&&0===n.getSeconds()&&0===n.getMilliseconds()&&(n.setHours(8),a.event_start_date=n),a.event_end_date=new Date(n.getTime()+36e5)}if(a.event_start_date&&a.event_end_date&&"event_end_date"===e.name){var o=new Date(a.event_start_date),d=new Date(a.event_end_date);o>d&&(a.event_start_date=new Date(d.getTime()-36e5))}if(!a.id&&"start_date"===e.calendar_date_type&&a[e.name]){var s=new Date(a[e.name]);0===s.getHours()&&0===s.getSeconds()&&0===s.getMilliseconds()&&(s.setHours(8),a[e.name]=s);var p=$filter("filter")(t.fields,{calendar_date_type:"end_date"},!0)[0];p&&(a[p.name]=new Date(s.getTime()+36e5))}if("end_date"===e.calendar_date_type&&a[e.name]){var u=$filter("filter")(t.fields,{calendar_date_type:"start_date"},!0)[0];if(u&&a[u.name]){var s=new Date(a[u.name]),c=new Date(a[e.name]);s>c&&(a[u.name]=new Date(c.getTime()-36e5))}}if("task_due_date"===e.name&&$rootScope.taskReminderAuto){var m=new Date(a.task_due_date);m.setTime(m.getTime()+288e5),a.task_reminder=m}if(t.dependencies){var f=$filter("filter")(t.dependencies,{parent_field:e.name},!0);if(f&&f.length)for(var _=0;_<f.length;_++){var g=f[_];if(!g.deleted){var h=$filter("filter")(t.fields,{name:g.child_field},!0)[0];if(g.clear)a[g.child_field]=void 0,l.$broadcast("angucomplete-alt:clearInput",g.child_field);else{if(!h)continue;switch(g.dependency_type){case"list_value":case"list_field":a.id||(a[g.child_field]=null);for(var v=r[h.picklist_id],y=0;y<v.length;y++){var k=v[y];delete k.hidden}if("list_value"===g.dependency_type){if(!a[g.parent_field])continue;var b=[];for(var $ in g.value_maps)if(g.value_maps.hasOwnProperty($)){var w=g.value_maps[$];$===a[g.parent_field].id.toString()&&(b=w)}if(!b.length)continue;for(var S=0;S<v.length;S++){var I=v[S];b.indexOf(I.id)<0&&(I.hidden=!0)}}else if("list_field"===g.dependency_type){if(!a[g.parent_field]){for(var F=0;F<v.length;F++){var M=v[F];M.hidden=!0}continue}for(var C=a[g.parent_field][g.field_map_parent],U=0;U<v.length;U++){var x=v[U];x[g.field_map_child]!==C&&(x.hidden=!0)}}break;case"list_text":a[g.child_field]=a[g.parent_field]?a[g.parent_field].value||a[g.parent_field].label[$rootScope.language]:null;break;case"lookup_text":a[g.child_field]=a[g.parent_field]?a[g.parent_field][g.field_map_parent]:null;break;case"lookup_list":case"lookup_field":if(!a[g.parent_field])continue;var P=a[g.parent_field][g.field_map_parent],R=r[h.picklist_id],D=null;if("lookup_list"===g.dependency_type){for(var q=0;q<R.length;q++){var T=R[q];T[g.field_map_child]===P&&(D=T)}!D||a.id&&a[g.child_field]||(a[g.child_field]=D)}else if("lookup_field"===g.dependency_type&&P){var A=$filter("filter")($rootScope.modules,{name:h.lookup_type},!0)[0],B=angular.copy(h);B.lookupModulePrimaryField=$filter("filter")(A.fields,{name:g.field_map_child},!0)[0];var O=[h.lookupModulePrimaryField.name];i.lookup(P,B,a,O,!0).then(function(e){if(e[0]){var r=e[0];r.primary_value=r[h.lookupModulePrimaryField.name],a[g.child_field]=r,h.valueChangeDontRun=!0,i.customActions(t,a,l.moduleForm),l.$broadcast("angucomplete-alt:changeInput",g.child_field,r)}})}}}this.calculate(h,t,a)}}}},setDependencyFilter:function(e,t,a,r){var l=angular.copy(a),i=angular.copy(e);if(e.indexOf(".")>-1){var n=e.split(".");l=$filter("filter")($rootScope.modules,{name:n[1]},!0)[0],i=n[2]}if(l.dependencies&&l.dependencies.length){var o=$filter("filter")(l.dependencies,{parent_field:i},!0);if(o&&o.length)for(var d=angular.copy(l.fields),s=0;s<o.length;s++){var p=o[s];if(!p.deleted){var u=$filter("filter")(d,{name:p.child_field},!0)[0];if(u&&t&&"list_field"===p.dependency_type){for(var c=r[u.picklist_id],m=0;m<c.length;m++){var f=c[m];delete f.hidden}for(var _=t[p.field_map_parent],g=0;g<c.length;g++){var h=c[g];h[p.field_map_child]!==_&&(h.hidden=!0)}}}}}},setDisplayDependency:function(e,t){if(e.display_dependencies)for(var a=0;a<e.display_dependencies.length;a++){var r=e.display_dependencies[a];if(!r.deleted){var l=null;if(l=r.dependent_section?$filter("filter")(e.sections,{name:r.dependent_section},!0)[0]:$filter("filter")(e.fields,{name:r.dependent_field},!0)[0])if(void 0!==t[r.field]){var i=null,n=angular.copy(t[r.field]);if(angular.isArray(n)){if(!t[r.field].length){l.hidden=!0,delete t[r.dependent_field];continue}for(var o=0;o<n.length;o++){var d=n[o],s=$filter("filter")(r.values,d,!0)[0];!i&&s&&(i=s)}}else r.values?n&&(i="boolean"==typeof n?n:n.id?$filter("filter")(r.values,n.id,!0)[0]:$filter("filter")(r.values,n,!0)[0]):i=n;if(r.otherwise||i)if(r.otherwise&&i)l.hidden=!0,delete t[r.dependent_field];else{if(!r.dependent_section){var p=$filter("filter")(e.fields,{name:r.field},!0)[0];if(p.hidden){l.hidden=!0,delete t[r.dependent_field];continue}}l.hidden=!1}else l.hidden=!0,delete t[r.dependent_field]}else l.hidden=!0,delete t[r.dependent_field]}}},customActions:function(){},customValidations:function(){},setCustomCalculations:function(){},updateView:function(e,t){return $http.put(config.apiUrl+"view/update/"+t,e)},generatTd:function(e){var t={mobileContent:"",normalContent:""};switch(e.data_type){case"rating":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><input class="rating-stars" kendo-rating k-precision="\'half\'" k-label="false" k-max="getRatingCount(\''+e.name+"')\"  ng-init=\"rating = dataItem['"+e.name+'\']"  ng-model="rating" ng-disabled="true" /></div>',t.normalContent='<td class="hide-on-m2"><input class="rating-stars" kendo-rating k-precision="\'half\'" k-label="false" k-max="getRatingCount(\''+e.name+"', relatedModule)\"  ng-init=\"rating = dataItem['"+e.name+'\']"  ng-model="rating" ng-disabled="true"/></td>';break;case"image":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="image-preview image-preview-60"><div class="image-holder"><img ng-click="$event.stopPropagation(); showLightBox($event, (dataItem[\''+e.name+"'] ? dataItem : ''), true)\" ng-src=\"{{dataItem['"+e.name+"'] ? (config.imageUrl+dataItem['"+e.name+"']): 'images/no-image.png'}}\"/></div></div></div>",t.normalContent='<td class="hide-on-m2"><div ng-style="getImageStyle(\''+e.name+'\')" class="image-preview image-preview-60"><div class="image-holder"><img ng-click="$event.stopPropagation(); showLightBox($event, (dataItem[\''+e.name+"'] ? dataItem : ''), true, undefined, relatedModule)\" ng-src=\"{{dataItem['"+e.name+"'] ? (config.imageUrl+dataItem['"+e.name+"']): 'images/no-image.png'}}\"/>\n</div></div></td>";break;case"text_multi":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button d-block"><span ng-bind-html="dataItem[\''+e.name+"'] \"></span></div></div>",t.normalContent='<td class="hide-on-m2"  ng-bind-html="dataItem[\''+e.name+"']\"></td>";break;case"lookup":var a=!0;("users"===e.lookup_type||"roles"===e.lookup_type||"profiles"===e.lookup_type)&&(a=!1),t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+": </span><div ng-show=\"dataItem['"+e.name+'\']" class="grid-list-button"><span>{{dataItem[\''+e.name+"']}}</span><a ng-if=\""+a+'"  ng-click="$event.stopPropagation(); goToRecord(\''+e.name+"','"+e.lookup_type+"',"+a+', dataItem)"><i class= "fas fa-external-link-alt"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div ng-if="'+a+'" ng-show="dataItem[\''+e.name+'\']" class="grid-list-button"><span>{{dataItem[\''+e.name+"']}}</span><a ng-click=\"$event.stopPropagation(); goToRecord('"+e.name+"','"+e.lookup_type+"',"+a+', dataItem)"><i class= "fas fa-external-link-alt"></i></a></div><span class="text-nowrap" ng-if="!'+a+"\">{{dataItem['"+e.name+"']}}</span></span></td>";
break;case"url":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\"> <span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="{{dataItem[\''+e.name+'\']}}" target="_blank"><i class= "fas fa-external-link-alt"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\"> <span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="{{dataItem[\''+e.name+'\']}}" target="_blank"><i class= "fas fa-external-link-alt"></i></a></div></td>';break;case"email":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\" ><span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="mailto:{{dataItem[\''+e.name+'\']}}" ><i class= "fas fa-paper-plane"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\" ><span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="mailto:{{dataItem[\''+e.name+'\']}}"><i class= "fas fa-paper-plane"></i></a></div></td>';break;case"document":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\"><span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="storage/record_file_download?fileName={{dataItem[\''+e.name+'\']}}"><i class= "fas fa-download"></i></a></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+"']\"><span>{{dataItem['"+e.name+'\']}}</span><a ng-click="$event.stopPropagation();" href="storage/record_file_download?fileName={{dataItem[\''+e.name+'\']}}"><i class= "fas fa-download"></i></a></div></td>';break;case"tag":case"multiselect":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button" ng-show="dataItem[\''+e.name+'\']"><span class="grid-multiselect-text" ng-repeat="data in getTagAndMultiDatas(dataItem, dataItem[\''+e.name+'\'])">{{data}}</span > <button ng-show="dataItem.show" aria-label="{{\'Common.ShowMore\' | translate}}" ng-click="$event.stopPropagation(); showLightBox($event, dataItem, false, \''+e.name+'\')"> <i class="fas fa-ellipsis-v"></i><md-tooltip md-direction="bottom">{{\'Common.ShowMore\' | translate}}</md-tooltip></button></div></div>',t.normalContent='<td class="hide-on-m2"><div class="grid-list-button" ng-show="dataItem[\''+e.name+'\']"><span class="grid-multiselect-text" ng-repeat="data in getTagAndMultiDatas(dataItem, dataItem[\''+e.name+'\'])">{{data}}</span > <button ng-show="dataItem.show" aria-label="{{\'Common.ShowMore\' | translate}}" ng-click="$event.stopPropagation(); showLightBox($event, dataItem, false, \''+e.name+'\', relatedModule)"> <i class="fas fa-ellipsis-v"></i><md-tooltip md-direction="bottom">{{\'Common.ShowMore\' | translate}}</md-tooltip></button></div></td>';break;case"location":t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="image-preview image-preview-60"><div class="image-holder"><img ng-click="$event.stopPropagation(); showLightBox($event, (dataItem[\''+e.name+"'] ? dataItem : ''), true, '"+e.name+"')\" ng-src=\"{{dataItem['"+e.name+"'] ? getLocationUrl(dataItem['"+e.name+"']) : 'images/no-location.png'}}\"/></div></div></div>",t.normalContent='<td class="hide-on-m2"> <div class="image-preview image-preview-60"><div class="image-holder"><img ng-click="$event.stopPropagation(); showLightBox($event, (dataItem[\''+e.name+"'] ? dataItem : ''), true, '"+e.name+"', relatedModule)\" ng-src=\"{{dataItem['"+e.name+"'] ? getLocationUrl(dataItem['"+e.name+"']) : 'images/no-location.png'}}\"/></div></td>";break;default:t.mobileContent='<div class="mobile-grid-block"><span>'+e.label+': </span><div class="grid-list-button"><span>{{ dataItem[\''+e.name+"'] }}</span></div></div>",t.normalContent='<td class="hide-on-m2"><span class="text-nowrap">{{ dataItem[\''+e.name+"'] }}</span></td>"}return t},generatoptionsItem:function(e,t,a){var r="'"+e+"'";switch(t){case"remove":return' <md-menu-item ng-if="controlRemove(dataItem)">\n <md-button id="deleteButton-{{dataItem.id}}" ng-click="recordDelete($event,'+a+","+r+')">\n <i class="fas fa-trash"></i> <span> '+$filter("translate")("Common.Delete")+"</span>\n </md-button>\n </md-menu-item>\n";case"copy":return' <md-menu-item ng-if="controlCopy(dataItem, relatedModule)">\n <md-button ui-sref="app.record({type: relatedModule ? relatedModule.related_module : module.name,clone:true,id:'+a+'})">\n <i class="fas fa-copy"></i> '+$filter("translate")("Common.Copy")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"edit":return' <md-menu-item ng-if="controlEdit(dataItem, relatedModule)">\n <md-button ui-sref="app.record({type: relatedModule ? relatedModule.related_module : module.name,id:'+a+'})">\n <i class="fas fa-edit"></i> '+$filter("translate")("Common.Edit")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"send-sms":return' <md-menu-item ng-if="user.profile.send_sms">\n <md-button  ng-click="selectRowSingle($event,dataItem); showSMSModal()" >\n <i class="fas fa-sms"></i> '+$filter("translate")("Module.SendSMS")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"send-email":return' <md-menu-item>\n <md-button ui-sref="app.record({type: relatedModule ? relatedModule.related_module : module.name,clone:true,id:dataItem.id})">\n <i class="fas fa-envelope"></i> '+$filter("translate")("Module.SendEMail")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"download":return' <md-menu-item>\n <md-button ng-click="selectRowSingle($event,dataItem); showSMSModal()">\n <i class="fas fa-file-download"></i> '+$filter("translate")("Common.Download")+" <span></span>\n </md-button>\n </md-menu-item>\n";case"remove_relation":return' <md-menu-item ng-if="controlRemove(dataItem, relatedModule)">\n <md-button id="deleteButton-{{dataItemId}}" ng-click="deleteRelation($event, relatedModule, true, '+a+')">\n <i class="fas fa-minus-circle"></i> <span> '+$filter("translate")("Module.RemoveRelation")+"</span>\n </md-button>\n </md-menu-item>\n"}},generatRowtmpl:function(e,t,a){var r=this,l={columns:[],rowtempl:"",requestFields:[]},i="",n=!1,o="dataItem.id",d="";if(a.relatedModule&&"many_to_many"===a.relatedModule.relation_type){n=!0;var s=a.module.name!==a.relatedModule.related_module?a.relatedModule.related_module+"_id":a.relatedModule.related_module+"1_id",p=s+"."+a.relatedModule.related_module+".";o="dataItem['"+s+"']"}var u=["edit","copy","remove"],c={},m="";if(t){n&&u.indexOf("remove_relation")<0&&u.push("remove_relation");for(var f=0;f<u.length;f++)d+=r.generatoptionsItem(a.relatedModule.related_module,u[f],o);c={width:"60px",headerTemplate:'<input type="checkbox"  ng-model="isAllSelected[\''+a.relatedModule.related_module+"']\"  ng-click=\"selectAll($event,'"+a.relatedModule.related_module+'\')" id="header-chb-'+a.relatedModule.related_module+'" class="k-checkbox header-checkbox"><label class="k-checkbox-label" for="header-chb-'+a.relatedModule.related_module+'"></label>'},m='<td ng-click="$event.stopPropagation();" class="position-relative">  <input ng-model="dataItem.isChecked"  type="checkbox" id="{{'+o+'}}" ng-click="selectRow($event,dataItem,\''+a.relatedModule.related_module+'\')" class="k-checkbox row-checkbox"><label class="k-checkbox-label" for="{{'+o+'}}"></label></td>'}else{for(var f=0;f<u.length;f++)d+=r.generatoptionsItem(a.moduleName,u[f],o);c={width:"60px",headerTemplate:"<input type='checkbox' ng-if=' grid.dataSource.data().length>0' ng-checked='isAllSelected'  ng-click='selectAll($event, grid.dataSource.data())' id='header-chb' class='k-checkbox header-checkbox'><label class='k-checkbox-label' for='header-chb'></label>"},m='<td ng-click="$event.stopPropagation();" class="position-relative"><input ng-click="selectRow($event,dataItem);$event.stopPropagation();" ng-disabled="dataItem.freeze && !user.profile.has_admin_rights" ng-checked="isRowSelected(dataItem.id) || dataItem.selected"  type="checkbox" id="{{dataItem.id}}" class="k-checkbox row-checkbox"><label class="k-checkbox-label" for="{{dataItem.id}}"></label></td>'}l.rowtempl=l.rowtempl+m,l.columns.push(c),e.map(function(e){p&&(e.name=p+e.name),l.requestFields.push(e.name),l.columns.push({title:e.labelExt?e.label+" "+e.labelExt:e.label,field:e.name,media:"(min-width: 575px)"});var t=r.generatTd(e,i);l.rowtempl=l.rowtempl+t.normalContent,i+=t.mobileContent});var _={field:"",width:"50px"},g="";g=n?'<td ng-click="$event.stopPropagation();" class="padding0"> <button class="md-icon-button md-button md-blue-theme md-ink-ripple" id="deleteButton-{{dataItemId}}" ng-click="deleteRelation($event, relatedModule, true, dataItem[\''+a.relatedModule.related_module+'_id\'])">\n <i class="fas fa-minus-circle"></i>\n </button></td>':'<td ng-click="$event.stopPropagation();" class="padding0"><md-menu md-position-mode="target-right target">\n<md-button ng-show="dataItem.showRemove || dataItem.showCopy || dataItem.showEdit" ng-disabled="dataItem.freeze && !user.profile.has_admin_rights" class="md-icon-button" aria-label=" " ng-click="$mdMenu.open()"> <i class="fas fa-ellipsis-v"></i></md-button>\n <md-menu-content width="2" class="md-dense">\n'+d+"\n </md-menu-content>\n </md-menu></td>",l.rowtempl=l.rowtempl+'<td class="show-on-m2">'+i+"</td>";var h={title:"Items",media:"(max-width: 575px)"};if(a.report&&a.report.aggregations){h.footerTemplate="";for(var v=0;v<a.report.aggregations.length;v++){var y=a.report.aggregations[v].aggregation_type+"("+a.report.aggregations[v].field+")";h.footerTemplate=h.footerTemplate+"  <div> {{ fieldskey['"+a.report.aggregations[v].field+"']['label_'+language] }} {{ 'Report."+a.report.aggregations[v].aggregation_type+"' | translate  }} : {{ "+y.replace("(","_").replace(")","")+"}} </div>"}}return l.columns.push(h),""==d||a.tableOptinosMenuHide||(l.rowtempl=l.rowtempl+g,l.columns.push(_)),l},createView:function(e){return $http.post(config.apiUrl+"view/create",e)},updateView:function(e,t){return $http.put(config.apiUrl+"view/update/"+t,e)},deleteView:function(e){return $http["delete"](config.apiUrl+"view/delete/"+e)},getViews:function(e,t,a){var r=this,l=$q.defer();if(t){var i=[],n={};n.active=!0;for(var o=[],d=1,s=0;s<t.length;s++){var p,u=t[s];if(u.indexOf(".")>-1){var c=u.split("."),m=$filter("filter")($rootScope.modules,{name:c[1]},!0)[0];p=$filter("filter")(m.fields,{name:c[2]},!0)[0]}else p=$filter("filter")(e.fields,{name:u},!0)[0];if(p&&r.hasFieldDisplayPermission(p)){var f={};f.field=u,f.order=d,o.push(f),d++}}return n.fields=o,i.push(n),l.resolve(i),l.promise}return a&&a.views?(l.resolve(a.views),l.promise):($http.get(config.apiUrl+"view/get_all/"+e.id).then(function(t){if(!t.data)return l.resolve([]),l.promise;for(var a=[],i=0;i<t.data.length;i++){for(var n=t.data[i],o=[],d=0;d<n.fields.length;d++){var s,p=n.fields[d];if(p.field.indexOf(".")>-1){var u=p.field.split("."),c=$filter("filter")($rootScope.modules,{name:u[1]},!0)[0];if(!c)continue;s=$filter("filter")(c.fields,{name:u[2]},!0)[0]}else s=$filter("filter")(e.fields,{name:p.field},!0)[0];s&&r.hasFieldDisplayPermission(s)&&o.push(p)}n.fields=o,n.label=n["label_"+$rootScope.language],a.push(n)}l.resolve(t.data)})["catch"](function(e){l.reject(e.data)}),l.promise)},getViewState:function(e,t){var a=$q.defer();return t&&t.viewState?(a.resolve(t.viewState),a.promise):($http.get(config.apiUrl+"view/get_view_state/"+e).then(function(e){a.resolve(e.data)})["catch"](function(e){a.reject(e.data)}),a.promise)},getViewFields:function(e,t){var a=this,r=angular.copy(e.fields),l={};l.selectedFields=[],l.availableFields=[],l.allFields=[],l.primaryField="",t.report_type||(r=$filter("filter")(r,{display_list:!0,lookup_type:"!relation"},!0));var i={};i.name="seperator-main",i.label="tr"===$rootScope.language?e.label_tr_singular:e.label_en_singular,i.order=0,i.id=0,i.seperator=!0,r.push(i);var n=0;return angular.forEach(r,function(e){if("lookup"===e.data_type&&"relation"!=e.lookup_type){var t=angular.copy($filter("filter")($rootScope.modules,{name:e.lookup_type},!0)[0]);if(n+=1e3,null===t||void 0===t)return;var a={};a.name="seperator-"+t.name,a.order=n,a.id=n,a.seperator=!0,a.label="tr"===$rootScope.language?t.label_tr_singular+" ("+e.label_tr+")":t.label_en_singular+" ("+e.label_en+")",r.push(a);var l=angular.copy(t.fields);l=$filter("filter")(l,{display_list:!0},!0),angular.forEach(l,function(a){return"lookup"===a.data_type?void(a.field=a):(a.label="tr"===$rootScope.language?a.label_tr:a.label_en,a.labelExt="("+e.label+")",a.name=e.name+"."+t.name+"."+a.name,a.order=parseInt(a.order)+n,a.id=a.order,a.parent_id=n,void r.push(a))})}}),angular.forEach(r,function(r){if(!r.deleted&&(a.hasFieldDisplayPermission(r)||"large"===r.multiline_type)){var i=null;t.fields&&(i=$filter("filter")(t.fields,{field:r.name},!0)[0]);var n={};if(n.name=r.name,n.label=r.label,n.labelExt=r.labelExt,n.order=r.order,n.id=r.id,r.name.indexOf("seperator-")<0&&(n.parent_id=r.parent_id?r.parent_id:0),n.lookup_type=r.lookup_type,n.seperator=r.seperator,n.multiline_type=r.multiline_type,n.data_type=r.data_type,"lookup"==r.data_type&&(n.name=r.name+"."+r.lookup_type+"."+r.lookupModulePrimaryField.name),i)n.order=i.order,n.id=i.id?i.id:i.order,n.parent_id=i.parent_id,l.selectedFields.push(n);else{var o=$filter("filter")(e.fields,{primary:!0},!0)[0];r.name!=o.name?l.availableFields.push(n):(n.primary=!0,l.selectedFields.push(n))}}}),l.selectedFields=$filter("orderBy")(l.selectedFields,"order"),l.availableFields=$filter("orderBy")(l.availableFields,"order"),l},setFilters:function(e,t,a,r,l,i,n){if("lookup"===t.data_type&&"users"===t.lookup_type&&"[me]"===r&&(r=$rootScope.user.id),"email"===t.data_type&&"[me.email]"===r&&(r=$rootScope.user.email),"date"===t.data_type&&r){{moment(r).format("YYYY-MM-DD")}moment(r).isValid()&&(r=moment(r).format("YYYY-MM-DD"))}e||(e=[]),("empty"===l||"not_empty"===l)&&(r="-");var o=$filter("filter")(e,{field:a,operator:l,no:parseInt(i)},!0)[0];if(o)o.operator=l,o.value=r,"document"===t.data_type&&(o.document_search=t.document_search);else{i=i?parseInt(i):e.length+1;var d={};d.field=a,d.operator=l,d.value=r,d.no=i,d.isView=n,"document"===t.data_type&&(d.document_search=t.document_search),e.push(d)}return e},getCSVData:function(e,t,a){var r=this,l=$q.defer(),i=angular.copy(e.findRequest[t.id]);return i.take=3e3,r.findCustom(e.locale||e.language,i).then(function(e){for(var r=e.data.data,i=[],n=[],o=$rootScope.modulus[t.related_module].fields,d={},s={},p=0;p<o.length;p++)for(var u=o[p],c=0;c<t.display_fields.length;c++)if(u.name===t.display_fields[c])if(n.push(u["label_"+$rootScope.language]+(u.parentField?" ("+u.parentField["label_"+$rootScope.language]+")":"")),"lookup"===u.data_type)d[u.name]=u.lookupModulePrimaryField.valueFormatted;else{var m=a.name!==t.related_module?t.related_module+"_id":t.related_module+"1_id";s[u.name]=m+"."+t.related_module+"."+u.name}i.push(n);for(var c=0;c<r.length;c++){for(var f=r[c],_=[],g=t.display_fields,h=0;h<g.length;h++){var v=f[g[h]]||d[g[h]]||f[s[g[h]]];_.push(v)}i.push(_)}l.resolve(i)}),l.promise},getYesNo:function(e){var t={};return t.yes=$filter("filter")(e,{system_code:"true"})[0].label[$rootScope.language],t.no=$filter("filter")(e,{system_code:"false"})[0].label[$rootScope.language],t},getIcons:function(){return icons2.icons},getActionButtons:function(e,t){var a=$q.defer(),r="action_button_"+e,l=$cache.get(r);return l&&!t?(a.resolve(l),a.promise):($http.get(config.apiUrl+"action_button/get/"+e).then(function(e){$cache.put(r,e.data),a.resolve(e.data)})["catch"](function(e){a.reject(e.data)}),a.promise)},hasFieldDisplayPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0],a=function(e){if(!e.sectionObj||!e.sectionObj.permissions)return!0;var t=$filter("filter")(e.sectionObj.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"none"!==t.type:!0};return t&&"none"===t.type?!1:a(e)},hasFieldReadOnlyPermission:function(e){if(!e.permissions)return!1;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"read_only"===t.type:!1},hasFieldFullPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0],a=function(e){if(!e.sectionObj||!e.sectionObj.permissions)return!0;var t=$filter("filter")(e.sectionObj.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"full"===t.type:!0};return t&&"full"!==t.type?!1:a(e)},hasSectionDisplayPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"none"!==t.type:!0},hasSectionReadOnlyPermission:function(e){if(!e.permissions)return!1;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"read_only"===t.type:!1},hasSectionFullPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"full"===t.type:!0},hasActionButtonDisplayPermission:function(e){if(!e.permissions)return!0;var t=$filter("filter")(e.permissions,{profile_id:$rootScope.user.profile.id},!0)[0];return t?"none"!==t.type:!0},getDailyRates:function(){return $http.get(config.apiUrl+"exchange_rates/get_daily_rates")},getAllTenantSettingsByType:function(e,t){return $http.get(config.apiUrl+"settings/get_all/"+e+(t?"?user_id="+t:""))},tenantSettingUpdate:function(e){return $http.put(config.apiUrl+"settings/update/"+e.id,e)},getReportByModule:function(e){return $http.get(config.apiUrl+"report/get_report_by_module/"+e)},getChartsTypes:function(){var e=[{label:$filter("translate")("Report.Chart.ColumnChart2d"),name:"column2d"},{label:$filter("translate")("Report.Chart.ColumnChart3d"),name:"column3d"},{label:$filter("translate")("Report.Chart.LineChart"),name:"line"},{label:$filter("translate")("Report.Chart.AreaChart"),name:"area2d"},{label:$filter("translate")("Report.Chart.BarChart2d"),name:"bar2d"},{label:$filter("translate")("Report.Chart.BarChart3d"),name:"bar3d"},{label:$filter("translate")("Report.Chart.PieChart"),name:"pie3d"},{label:$filter("translate")("Report.Chart.DoughnutChart2d"),name:"doughnut2d"},{label:$filter("translate")("Report.Chart.DoughnutChart3d"),name:"doughnut3d"},{label:$filter("translate")("Report.Chart.ScrollColumnChart"),name:"scrollcolumn2d"},{label:$filter("translate")("Report.Chart.ScrollLineChart"),name:"scrollline2d"},{label:$filter("translate")("Report.Chart.ScrollAreaChart"),name:"scrollarea2d"},{label:$filter("translate")("Report.Chart.FunnelChart"),name:"funnel"},{label:$filter("translate")("Report.Chart.PyramidChart"),name:"pyramid"}];return e},chartFilter:function(e){return $http.post(config.apiUrl+"view/chart_filter",e)},getUsersLookupData:function(e){for(var t=[],a=0;a<e.dataSource.length;a++)t.push({id:e.dataSource[a].id,full_name:e.dataSource[a].full_name});return t.push({id:"[me]",full_name:$filter("translate")("Common.LoggedInUser")}),e.dataSource=t,e},getChart:function(e){return $http.get(config.apiUrl+"view/get_chart/"+e)},getWidget:function(e){return $http.get(config.apiUrl+"view/get_widget/"+e)},saveView:function(e,t){return"edit"===e?$http.put(config.apiUrl+"view/update/"+t.id,t):$http.post(config.apiUrl+"view/create",t)},goToRecord:function(e,t,a,r){if(e){var l=e.split(".");l&&l.length>2&&(l[l.length-1]="id"),l=l.join("."),a&&$window.open("#/app/record/"+t+"?id="+r[l],"_self")}},getTagAndMultiDatas:function(e,t){var a=t.split(";");return a&&a.length>3?(e.show=!0,a.splice(3,a.length-3)):e.show=!1,a},getImageStyle:function(e,t){var a=$rootScope.modulus[t];if(a){var r=$filter("filter")(a.fields,{name:e,deleted:!1})[0];if(r&&r.image_size_list>0){var l={width:r.image_size_list+"px",height:r.image_size_list+"px"};return l}}},getRatingCount:function(e,t){var a=$rootScope.modulus[t];if(a){var r=$filter("filter")(a.fields,{name:e,deleted:!1})[0];if(r)return r.max||5}},getLocationUrl:function(e){return"https://maps.googleapis.com/maps/api/staticmap?zoom=10&size=300x150&maptype=roadmap&markers=color:red|"+e+"&key="+googleMapsApiKey}}}]);