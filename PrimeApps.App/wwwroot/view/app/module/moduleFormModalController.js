"use strict";angular.module("primeapps").controller("ModuleFormModalController",["$rootScope","$scope","ngToast","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","operations","activityTypes","ModuleService",function(e,o,a,l,r,d,i,t,n,u,c,s,p,m,M){o.operations=p,o.hasPermission=r.hasPermission,o.hasFieldFullPermission=M.hasFieldFullPermission,o.loadingModal=!0;var f=o.$parent.currentLookupField.lookup_type;if("relation"===f&&(f=o.$parent.record.related_module.value),null!=f){if(o.moduleModal=l("filter")(e.modules,{name:f},!0)[0],!o.moduleModal)return o.formModal.hide(),a.create({content:l("translate")("Common.NotFound"),className:"warning"}),void i.go("app.dashboard");o.dropdownFields=l("filter")(o.moduleModal.fields,{data_type:"lookup",show_as_dropdown:!0},!0),o.dropdownFieldDatas={};for(var y=0;y<o.dropdownFields.length;y++)o.dropdownFieldDatas[o.dropdownFields[y].name]=[];if(o.setDropdownData=function(e){if(e.filters&&e.filters.length>0)o.dropdownFieldDatas[e.name]=null;else if(o.dropdownFieldDatas[e.name]&&o.dropdownFieldDatas[e.name].length>0)return;o.currentLookupFieldModal=e,o.lookupModal().then(function(a){o.dropdownFieldDatas[e.name]=a})},!o.hasPermission(f,o.operations.modify))return o.forbidden=!0,void(o.loadingModal=!1);if(o.primaryFieldModal=l("filter")(o.moduleModal.fields,{primary_lookup:!0})[0],o.primaryFieldModal||(o.primaryFieldModal=l("filter")(o.moduleModal.fields,{primary:!0})[0]),o.currentUser=M.processUser(e.user),o.currentDayMin=r.getCurrentDateMin().toISOString(),o.currentDayMax=r.getCurrentDateMax().toISOString(),o.currentHour=r.floorMinutes(new Date),o.recordModal={},o.recordModal.owner=o.currentUser,o.$parent.primaryValueModal)if(o.primaryFieldModal.combination){var F=o.$parent.primaryValueModal.split(" ");if(1===F.length)o.recordModal[o.primaryFieldModal.combination.field_1]=F[0];else if(2===F.length)o.recordModal[o.primaryFieldModal.combination.field_1]=F[0],o.recordModal[o.primaryFieldModal.combination.field_2]=F[1];else{o.recordModal[o.primaryFieldModal.combination.field_1]="";for(var y=0;y<F.length;y++)y<F.length-1&&(o.recordModal[o.primaryFieldModal.combination.field_1]=o.recordModal[o.primaryFieldModal.combination.field_1]+F[y]+" ");o.recordModal[o.primaryFieldModal.combination.field_1]=o.recordModal[o.primaryFieldModal.combination.field_1].slice(0,-1),o.recordModal[o.primaryFieldModal.combination.field_2]=F[F.length-1]}}else o.recordModal[o.primaryFieldModal.name]=o.$parent.primaryValueModal;if(o.$parent.calendarDate){var k=l("filter")(o.moduleModal.fields,{calendar_date_type:"start_date"},!0)[0],_=l("filter")(o.moduleModal.fields,{calendar_date_type:"end_date"},!0)[0];if(!k||!_){if("activities"!=o.moduleModal.name)return;k=l("filter")(o.moduleModal.fields,{name:"event_start_date"},!0)[0],_=l("filter")(o.moduleModal.fields,{name:"event_end_date"},!0)[0],o.recordModal.activity_type=l("filter")(m,{system_code:"event"},!0)[0]}var g=angular.copy(o.$parent.calendarDate),v=angular.copy(o.$parent.calendarDate);o.recordModal[k.name]=g.hour(8).toDate(),o.recordModal[_.name]=v.hour(9).toDate()}M.getPicklists(o.moduleModal).then(function(e){if(o.picklistsModuleModal=angular.copy(e),M.setDefaultValues(o.moduleModal,o.recordModal,e),"activities"===o.moduleModal.name){var a=l("filter")(o.moduleModal.fields,{name:"activity_type"},!0)[0];o.picklistsModuleModal[a.picklist_id]&&a&&angular.forEach(o.picklistsModuleModal[a.picklist_id],function(e){"event"!=e.value&&"event"!=e.system_code&&(e.hidden=!0)})}o.loadingModal=!1}),o.lookupModal=function(a){if("users"===o.currentLookupFieldModal.lookup_type&&!o.currentLookupFieldModal.lookupModulePrimaryField){var r={};r.data_type="text_single",r.name="full_name",o.currentLookupFieldModal.lookupModulePrimaryField=r}if("relation"===o.currentLookupField.lookup_type||"activities"===o.currentLookupField.lookup_type){if(!o.recordModal.related_module)return o.$broadcast("angucomplete-alt:clearInput",o.currentLookupField.name),n.defer().promise;var d=l("filter")(e.modules,{name:o.recordModal.related_module.value},!0)[0];if(!d)return o.$broadcast("angucomplete-alt:clearInput",o.currentLookupField.name),n.defer().promise;o.currentLookupFieldModal.lookupModulePrimaryField=l("filter")(d.fields,{primary:!0},!0)[0]}return"number"!==o.currentLookupFieldModal.lookupModulePrimaryField.data_type&&"number_auto"!==o.currentLookupFieldModal.lookupModulePrimaryField.data_type||!isNaN(parseFloat(a))?M.lookup(a,o.currentLookupFieldModal,o.recordModal):(o.$broadcast("angucomplete-alt:clearInput",o.currentLookupFieldModal.name),n.defer().promise)},o.multiselectModal=function(e,a){var l=[];return angular.forEach(o.picklistsModuleModal[a.picklist_id],function(o){o.inactive||(o.labelStr.toLowerCase().indexOf(e.toLowerCase())>-1||o.labelStr.toUpperCase().indexOf(e.toUpperCase())>-1||o.labelStr.toLowerCaseTurkish().indexOf(e.toLowerCaseTurkish())>-1||o.labelStr.toUpperCaseTurkish().indexOf(e.toUpperCaseTurkish())>-1)&&l.push(o)}),l},o.setCurrentLookupFieldModal=function(e){o.currentLookupFieldModal=e},o.submitModal=function(l){function r(){var e=!0;return angular.forEach(o.moduleModal.fields,function(a){l[a.name]&&"lookup"===a.data_type&&"object"!=typeof l[a.name]&&(o.moduleModalForm[a.name].$setValidity("object",!1),e=!1)}),e}o.moduleModalForm.$valid&&r()&&(o.submittingModal=!0,l=M.prepareRecord(l,o.moduleModal),M.insertRecord(o.moduleModal.name,l).then(function(l){o.$parent.isNewsfeed&&a.create({content:"Etkinlik Eklendi",className:"success"});var r=o.moduleModal.name+"_"+o.moduleModal.name;s.remove(r),e.activePages&&e.activePages[o.moduleModal.name]&&(e.activePages[o.moduleModal.name]=null);var d={};d.id=l.data.id,d.primary_value=o.$parent.primaryValueModal,o.$parent.record&&(o.$parent.record[o.$parent.currentLookupField.name]=d),o.$parent.formModalSuccess&&o.$parent.formModalSuccess(),o.submittingModal=!1,o.formModal.hide()})["catch"](function(e){409===e.status&&o.moduleModalForm[e.data.field].$setValidity("unique",!1)})["finally"](function(){o.submittingModal=!1}))},o.calculate=function(e){M.calculate(e,o.moduleModal,o.recordModal)},o.fieldValueChange=function(e){M.setDependency(e,o.moduleModal,o.recordModal,o.picklistsModuleModal),M.setDisplayDependency(o.moduleModal,o.recordModal),o.moduleModalForm[e.name].$error.unique&&o.moduleModalForm[e.name].$setValidity("unique",!0)},o.isModalField=function(e){return e.validation.required&&e.display_form&&!e.deleted?!0:!1}}}]);