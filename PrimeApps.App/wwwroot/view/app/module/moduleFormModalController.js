"use strict";angular.module("primeapps").controller("ModuleFormModalController",["$rootScope","$scope","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","operations","activityTypes","ModuleService",function(e,o,a,l,r,d,i,t,n,u,s,c,p,m){o.operations=c,o.hasPermission=l.hasPermission,o.hasFieldFullPermission=m.hasFieldFullPermission,o.loadingModal=!0;var M=o.$parent.currentLookupField.lookup_type;if("relation"===M&&(M=o.$parent.record.related_module.value),null!=M){if(o.moduleModal=a("filter")(e.modules,{name:M},!0)[0],!o.moduleModal)return o.formModal.hide(),mdToast.warning(a("translate")("Common.NotFound")),void d.go("app.dashboard");o.dropdownFields=a("filter")(o.moduleModal.fields,{data_type:"lookup",show_as_dropdown:!0},!0),o.dropdownFieldDatas={};for(var f=0;f<o.dropdownFields.length;f++)o.dropdownFieldDatas[o.dropdownFields[f].name]=[];if(o.setDropdownData=function(e){if(e.filters&&e.filters.length>0)o.dropdownFieldDatas[e.name]=null;else if(o.dropdownFieldDatas[e.name]&&o.dropdownFieldDatas[e.name].length>0)return;o.currentLookupFieldModal=e,o.lookupModal().then(function(a){o.dropdownFieldDatas[e.name]=a})},!o.hasPermission(M,o.operations.modify))return o.forbidden=!0,void(o.loadingModal=!1);if(o.primaryFieldModal=a("filter")(o.moduleModal.fields,{primary_lookup:!0})[0],o.primaryFieldModal||(o.primaryFieldModal=a("filter")(o.moduleModal.fields,{primary:!0})[0]),o.currentUser=m.processUser(e.user),o.currentDayMin=l.getCurrentDateMin().toISOString(),o.currentDayMax=l.getCurrentDateMax().toISOString(),o.currentHour=l.floorMinutes(new Date),o.recordModal={},o.recordModal.owner=o.currentUser,o.$parent.primaryValueModal)if(o.primaryFieldModal.combination){var y=o.$parent.primaryValueModal.split(" ");if(1===y.length)o.recordModal[o.primaryFieldModal.combination.field_1]=y[0];else if(2===y.length)o.recordModal[o.primaryFieldModal.combination.field_1]=y[0],o.recordModal[o.primaryFieldModal.combination.field_2]=y[1];else{o.recordModal[o.primaryFieldModal.combination.field_1]="";for(var f=0;f<y.length;f++)f<y.length-1&&(o.recordModal[o.primaryFieldModal.combination.field_1]=o.recordModal[o.primaryFieldModal.combination.field_1]+y[f]+" ");o.recordModal[o.primaryFieldModal.combination.field_1]=o.recordModal[o.primaryFieldModal.combination.field_1].slice(0,-1),o.recordModal[o.primaryFieldModal.combination.field_2]=y[y.length-1]}}else o.recordModal[o.primaryFieldModal.name]=o.$parent.primaryValueModal;if(o.$parent.calendarDate){var F=a("filter")(o.moduleModal.fields,{calendar_date_type:"start_date"},!0)[0],k=a("filter")(o.moduleModal.fields,{calendar_date_type:"end_date"},!0)[0];if(!F||!k){if("activities"!=o.moduleModal.name)return;F=a("filter")(o.moduleModal.fields,{name:"event_start_date"},!0)[0],k=a("filter")(o.moduleModal.fields,{name:"event_end_date"},!0)[0],o.recordModal.activity_type=a("filter")(p,{system_code:"event"},!0)[0]}var _=angular.copy(o.$parent.calendarDate),v=angular.copy(o.$parent.calendarDate);o.recordModal[F.name]=_.hour(8).toDate(),o.recordModal[k.name]=v.hour(9).toDate()}m.getPicklists(o.moduleModal).then(function(e){if(o.picklistsModuleModal=angular.copy(e),m.setDefaultValues(o.moduleModal,o.recordModal,e),"activities"===o.moduleModal.name){var l=a("filter")(o.moduleModal.fields,{name:"activity_type"},!0)[0];o.picklistsModuleModal[l.picklist_id]&&l&&angular.forEach(o.picklistsModuleModal[l.picklist_id],function(e){"event"!=e.value&&"event"!=e.system_code&&(e.hidden=!0)})}o.loadingModal=!1}),o.lookupModal=function(l){if("users"===o.currentLookupFieldModal.lookup_type&&!o.currentLookupFieldModal.lookupModulePrimaryField){var r={};r.data_type="text_single",r.name="full_name",o.currentLookupFieldModal.lookupModulePrimaryField=r}if("relation"===o.currentLookupField.lookup_type||"activities"===o.currentLookupField.lookup_type){if(!o.recordModal.related_module)return o.$broadcast("angucomplete-alt:clearInput",o.currentLookupField.name),t.defer().promise;var d=a("filter")(e.modules,{name:o.recordModal.related_module.value},!0)[0];if(!d)return o.$broadcast("angucomplete-alt:clearInput",o.currentLookupField.name),t.defer().promise;o.currentLookupFieldModal.lookupModulePrimaryField=a("filter")(d.fields,{primary:!0},!0)[0]}return"number"!==o.currentLookupFieldModal.lookupModulePrimaryField.data_type&&"number_auto"!==o.currentLookupFieldModal.lookupModulePrimaryField.data_type||!isNaN(parseFloat(l))?m.lookup(l,o.currentLookupFieldModal,o.recordModal):(o.$broadcast("angucomplete-alt:clearInput",o.currentLookupFieldModal.name),t.defer().promise)},o.multiselectModal=function(e,a){var l=[];return angular.forEach(o.picklistsModuleModal[a.picklist_id],function(o){o.inactive||(o.labelStr.toLowerCase().indexOf(e.toLowerCase())>-1||o.labelStr.toUpperCase().indexOf(e.toUpperCase())>-1||o.labelStr.toLowerCaseTurkish().indexOf(e.toLowerCaseTurkish())>-1||o.labelStr.toUpperCaseTurkish().indexOf(e.toUpperCaseTurkish())>-1)&&l.push(o)}),l},o.setCurrentLookupFieldModal=function(e){o.currentLookupFieldModal=e},o.submitModal=function(a){function l(){var e=!0;return angular.forEach(o.moduleModal.fields,function(l){a[l.name]&&"lookup"===l.data_type&&"object"!=typeof a[l.name]&&(o.moduleModalForm[l.name].$setValidity("object",!1),e=!1)}),e}o.moduleModalForm.$valid&&l()&&(o.submittingModal=!0,a=m.prepareRecord(a,o.moduleModal),m.insertRecord(o.moduleModal.name,a).then(function(a){o.$parent.isNewsfeed&&mdToast.success("Etkinlik Eklendi");var l=o.moduleModal.name+"_"+o.moduleModal.name;s.remove(l),e.activePages&&e.activePages[o.moduleModal.name]&&(e.activePages[o.moduleModal.name]=null);var r={};r.id=a.data.id,r.primary_value=o.$parent.primaryValueModal,o.$parent.record&&(o.$parent.record[o.$parent.currentLookupField.name]=r),o.$parent.formModalSuccess&&o.$parent.formModalSuccess(),o.submittingModal=!1,o.formModal.hide()})["catch"](function(e){409===e.status&&o.moduleModalForm[e.data.field].$setValidity("unique",!1)})["finally"](function(){o.submittingModal=!1}))},o.calculate=function(e){m.calculate(e,o.moduleModal,o.recordModal)},o.fieldValueChange=function(e){m.setDependency(e,o.moduleModal,o.recordModal,o.picklistsModuleModal),m.setDisplayDependency(o.moduleModal,o.recordModal),o.moduleModalForm[e.name].$error.unique&&o.moduleModalForm[e.name].$setValidity("unique",!0)},o.isModalField=function(e){return e.validation.required&&e.display_form&&!e.deleted?!0:!1}}}]);