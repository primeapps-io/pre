"use strict";angular.module("primeapps").controller("ModuleDetailController",["$rootScope","$scope","ngToast","$filter","helper","sipHelper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","entityTypes","operations","config","guidEmpty","$popover","$timeout","$modal","$sce","yesNo","activityTypes","transactionTypes","$anchorScroll","blockUI","FileUploader","DocumentService","ModuleService","$http","components",function(e,t,r,o,a,n,i,s,l,d,u,c,p,m,f,h,_,g,v,y,M,w,P,k,F,b,S,T,A,D,R){if(t.type=l.type,t.id=i.search().id,t.parentType=i.search().ptype,t.parentId=i.search().pid,t.returnParentType=i.search().rptype,t.returnTab=i.search().rtab,t.previousParentType=i.search().pptype,t.previousParentId=i.search().ppid,t.previousReturnTab=i.search().prtab,t.returnPreviousParentType=i.search().rpptype,t.returnPreviousParentId=i.search().rppid,t.returnPreviousReturnTab=i.search().rprtab,t.back=i.search().back,t.module=o("filter")(e.modules,{name:t.type},!0)[0],t.operations=f,t.hasPermission=a.hasPermission,t.hasDocumentsPermission=a.hasDocumentsPermission,t.hasFieldDisplayPermission=A.hasFieldDisplayPermission,t.hasFieldFullPermission=A.hasFieldFullPermission,t.hasSectionDisplayPermission=A.hasSectionDisplayPermission,t.hasSectionFullPermission=A.hasSectionFullPermission,t.hasActionButtonDisplayPermission=A.hasActionButtonDisplayPermission,t.loading=!0,t.pdfUrl="",t.isDetail=!0,t.refreshSubModules={},t.editLookup={},t.tab="general",t.activityTypes=P,t.transactionTypes=k,t.lookupUser=a.lookupUser,t.isActive={},t.waitingForApproval=!1,t.isProcessRecord=!1,t.isApproved=!1,t.isRejectedRequest=!1,t.appId=e.user.app_id,t.hasManuelProcess=!1,t.manuelApproveRequest=!1,t.freeze=i.search().freeze,t.currentModuleProcess=null,t.customHide=!1,t.googleMapsApiKey=googleMapsApiKey,t.currentSectionComponentsTemplate=currentSectionComponentsTemplate,t.scriptRunning={},t.pageBlockUI=b.instances.get("pageBlockUI"),t.actionButtonDisabled=!1,!t.module)return r.create({content:o("translate")("Common.NotFound"),className:"warning"}),void s.go("app.dashboard");if(!t.id)return r.create({content:o("translate")("Common.NotFound"),className:"warning"}),void s.go("app.dashboard");R.run("BeforeDetailLoaded","script",t),t.setDropdownData=function(e){if(e.filters&&e.filters.length>0)t.dropdownFieldDatas[e.name]=null;else if(t.dropdownFieldDatas[e.name]&&t.dropdownFieldDatas[e.name].length>0)return;t.currentLookupField=e,t.lookup().then(function(r){t.dropdownFieldDatas[e.name]=r})},t.trustAsHtml=function(e){return M.trustAsHtml(e)},t.dropdownFields=o("filter")(t.module.fields,{data_type:"lookup",show_as_dropdown:!0},!0),t.dropdownFieldDatas={};for(var U=0;U<t.dropdownFields.length;U++)t.dropdownFieldDatas[t.dropdownFields[U].name]=[];t.tabconfig=t.module.detail_view_type?"flat"!=t.module.detail_view_type?!0:!1:"flat"!=e.detailViewType?!0:!1,t.returnPreviousParentType&&t.returnPreviousParentId!=t.id&&(t.parentType=angular.copy(t.returnPreviousParentType),t.parentId=angular.copy(t.returnPreviousParentId),t.returnTab=angular.copy(t.returnPreviousReturnTab));var I=function(){t.tabconfig?t.scrollHeightTab={height:u.innerHeight-255+"px"}:t.scrollHeight={height:u.innerHeight-165+"px"}};I(),angular.element(u).on("resize",function(){v(function(){I()})}),t.primaryField=o("filter")(t.module.fields,{primary:!0})[0],t.currentUser=A.processUser(e.user),t.currentDayMin=a.getCurrentDateMin().toISOString(),t.currentDayMax=a.getCurrentDateMax().toISOString(),t.currentHour=a.floorMinutes(new Date),t.entityTypes=m,t.guidEmpty=_,t.relatedToField=o("filter")(t.module.fields,{name:"related_to"},!0)[0],t.record={},t.allFields=[],t.showEditor=!1,t.isAdmin=e.user.profile.has_admin_rights;var z=o("filter")(t.modules,{name:"sales_invoices"},!0);t.salesInvoiceModule=z.length<1?!1:!0,angular.forEach(t.module.fields,function(e){A.hasFieldDisplayPermission(e)&&t.allFields.push(angular.copy(e))});for(var B=0;B<e.approvalProcesses.length;B++){var E=e.approvalProcesses[B];E.module_id===t.module.id&&(t.currentModuleProcess=E)}if(t.currentModuleProcess){var C=t.currentModuleProcess.profiles.split(",");t.hasProcessEditPermission=!1;for(var U=0;U<C.length;U++)C[U]===e.user.profile.id.toString()&&(t.hasProcessEditPermission=!0)}if(t.module.relations&&angular.forEach(t.module.relations,function(r){if(!r.deleted){var a=o("filter")(e.modules,{name:r.related_module},!0)[0],n={};if("activities"!==r.related_module&&"mails"!==r.related_module||"many_to_many"===r.relation_type)if("many_to_many"===r.relation_type){if(!a)return;var i=o("filter")(a.fields,{primary:!0},!0)[0],l=r.related_module+"_id."+r.related_module+"."+i.name;n={fields:["total_count()",l],filters:[{field:t.module.name+"_id",operator:"equals",value:t.id,no:1}],limit:1,offset:0,many_to_many:t.module.name}}else n={fields:["total_count()"],filters:[{field:r.relation_field,operator:"equals",value:t.id,no:1}],limit:1,offset:0};else n={fields:["total_count()"],filters:[{field:r.relation_field,operator:"equals",value:t.id,no:1},{field:"related_module",operator:"is",value:t.module["label_"+e.user.tenant_language+"_singular"],no:1}],limit:1,offset:0};A.findRecords(r.related_module,n).then(function(e){var o=e.data;o[0]&&o[0].total_count?r.total=o[0].total_count:delete r.total,"flat"===r.detail_view_type&&(t.changeTab(r),t.returnParentType==r.id&&(t.activeType="tab",t.tab="general"))}).then(function(){t.isActive[s.params.rptype]=!0})}}),t.parentType){if("activities"===t.type||"mails"===t.type||t.many)t.parentModule=t.parentType;else{var L=o("filter")(t.module.fields,{name:t.parentType},!0)[0];L?t.parentModule=L.lookup_type:(t.parentModule=t.parentType,t.returnType="general")}t.previousParentType||(t.previousParentType=angular.copy(t.parentType),t.previousParentId=angular.copy(t.parentId),!t.previousReturnTab&&t.returnTab&&(t.previousReturnTab=angular.copy(t.returnTab)))}t.module.default_tab&&(t.tab=t.module.default_tab),t.returnParentType&&(t.tab=t.returnParentType,t.tabconfig||(t.isActive[t.returnParentType]=!0,i.hash("relation"+t.returnParentType),F()));var q=function(){if("izinler"===t.module.name&&(t.hasManuelProcess&&(t.record.owner.id===t.currentUser.id||t.hasProcessRights)&&!t.record.process_id||3===t.record.process_status&&t.record.owner.id===t.currentUser.id&&!t.waitingForApproval)&&t.record.izin_turu){var e=moment().date(1).month(1).year(moment().year()).format("YYYY-MM-DD");if(t.record.goreve_baslama_tarihi=t.record.calisan.ise_baslama_tarihi,t.record.izin_turu_data=t.record.izin_turu,t.record.dogum_tarihi=t.record.calisan.dogum_tarihi,t.record.calisan_data=t.record.calisan,t.record.izin_turu_data.yillik_izin){var r=moment(t.record.calisan_data.ise_baslama_tarihi),o=r.get("date"),a=r.get("month"),n=moment().get("year"),i=moment().date(o).month(a).year(n).format("YYYY-MM-DD");moment(i).isAfter(moment().format("YYYY-MM-DD"))&&(n-=1),e=moment().date(o).month(a).year(n).format("YYYY-MM-DD")}t.record.izin_turu_data.her_ay_yenilenir&&(e=moment().date(1).month(moment().month()).year(moment().year()).format("YYYY-MM-DD"));var s={fields:["hesaplanan_alinacak_toplam_izin","baslangic_tarihi","bitis_tarihi","izin_turu","process.process_requests.process_status","system_code"],filters:[{field:"calisan",operator:"equals",value:t.record.calisan.id,no:1},{field:"baslangic_tarihi",operator:"greater_equal",value:e,no:2},{field:"deleted",operator:"equals",value:!1,no:3},{field:"process.process_requests.process_status",operator:"not_equal",value:3,no:4}],limit:999999};A.findRecords("izinler",s).then(function(e){e.data.length>0&&(t.record.alinan_izinler=e.data)})}};t.picklistFilter=function(){return function(e){return t.componentFilter={},t.componentFilter.item=e,t.componentFilter.result=!0,R.run("PicklistFilter","Script",t),!e.hidden&&!e.inactive&&t.componentFilter.result}};var N=function(){A.getPicklists(t.module).then(function(a){t.picklistsModule=a,A.getRecord(t.module.name,t.id).then(function(a){0===Object.keys(a.data).length&&(r.create({content:o("translate")("Common.Forbidden"),className:"warning"}),s.go("app.dashboard")),"activities"!=t.module.name&&angular.forEach(t.module.fields,function(e){A.setDependency(e,t.module,t.record,t.picklistsModule),e.default_value&&"picklist"==e.data_type&&(t.record[e.name]=o("filter")(t.picklistsModule[e.picklist_id],{id:e.default_value})[0],t.fieldValueChange(e))});for(var n=A.processRecordSingle(a.data,t.module,t.picklistsModule),i=0;i<e.approvalProcesses.length;i++){var l=e.approvalProcesses[i];l.module_id===t.module.id&&"manuel"===l.trigger_time&&(t.hasManuelProcess=!0),l.module_id===t.module.id&&(t.currentModuleProcess=l)}for(var d=0;d<t.module.fields.length;d++){var u=t.module.fields[d],c=!1;if(u.encrypted&&u.encryption_authorized_users_list.length>0&&n[u.name])for(var p=0;p<u.encryption_authorized_users_list.length;p++){var m=u.encryption_authorized_users_list[p];e.user.id==parseInt(m)&&(c=!0)}u.show_lock=u.encrypted&&!c?!0:!1}if(n.process_status&&(2===n.process_status&&(t.isApproved=!0),(1===n.process_status||2===n.process_status||3===n.process_status&&n.created_by.id!=t.currentUser.id)&&(n.freeze=!0),A.getProcess(n.process_id).then(function(r){var a=r.data.approvers;if(a.length>0){var i=o("filter")(a,{id:t.currentUser.id},!0)[0];i||3===n.process_status||(t.waitingForApproval=!0),i&&(i.order===n.process_status_order?t.isApprovalRecord=!0:3!==n.process_status&&(t.waitingForApproval=!0))}else if(1===n.process_status_order){var s=n.custom_approver;s===e.user.email?t.isApprovalRecord=!0:s!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(2===n.process_status_order){var l=n.custom_approver_2;l===e.user.email?t.isApprovalRecord=!0:l!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(3===n.process_status_order){var d=n.custom_approver_3;d===e.user.email?t.isApprovalRecord=!0:d!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(4===n.process_status_order){var u=n.custom_approver_4;u===e.user.email?t.isApprovalRecord=!0:u!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(5===n.process_status_order){var c=n.custom_approver_5;c===e.user.email?t.isApprovalRecord=!0:c!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}if(0===n.operation_type&&2===n.process_status)for(var p=0;p<r.data.operations_array.length;p++){var m=r.data.operations_array[p];"update"===m&&(n.freeze=!1)}1===n.operation_type&&2===n.process_status&&(n.freeze=!1),"izinler"===t.module.name&&q()})),t.module.dependencies.length>0){var f=o("filter")(t.module.dependencies,{dependency_type:"freeze"},!0);angular.forEach(f,function(e){var r=o("filter")(t.module.fields,{name:e.parent_field},!0);angular.forEach(r,function(t){angular.forEach(e.values_array,function(e){!n[t.name]||e!=n[t.name]&&e!=n[t.name].id||(n.freeze=!0)})})})}if(t.freeze&&(n.freeze=!0),null!==t.currentModuleProcess){if(t.currentModuleProcess.profile_list&&t.currentModuleProcess.profile_list.length>0)for(var h=0;h<t.currentModuleProcess.profile_list.length;h++){var _=t.currentModuleProcess.profile_list[h];parseInt(_)===e.user.profile.id&&(n.freeze=!1)}e.user.profile.has_admin_rights&&(n.freeze=!1)}A.formatRecordFieldValues(angular.copy(a.data),t.module,t.picklistsModule),t.title=t.primaryField.valueFormatted;var g=function(r){t.record=r,t.recordState=angular.copy(t.record),A.setDisplayDependency(t.module,t.record),t.record.currency&&(t.currencySymbol=t.record.currency.value||e.currencySymbol),R.run("AfterRecordLoaded","Script",t,t.record),t.currentModuleProcess&&t.currentModuleProcess.profile_list&&(t.hasProcessRights=t.currentModuleProcess.profile_list.indexOf(e.user.profile.ID.toString())>-1?!0:!1),"izinler"===t.module.name&&q()};if(A.getActionButtons(t.module.id).then(function(e){t.actionButtons=o("filter")(e,function(e){return"List"!==e.trigger&&"Form"!==e.trigger&&"Relation"!==e.trigger},!0),angular.forEach(t.actionButtons,function(e){e.isShown=!1,e.dependent_field?n[e.dependent_field]&&n[e.dependent_field].labelStr==e.dependent&&(e.isShown=!0):e.isShown=!0})}),t.relatedToField&&n.related_to&&n[t.relatedToField.lookup_relation]){var v=o("filter")(e.modules,{id:n[t.relatedToField.lookup_relation].id-9e5},!0)[0],y=o("filter")(v.fields,{primary:!0},!0)[0];A.getRecord(v.name,n.related_to,!0).then(function(e){e=e.data,e.primary_value=e[y.name],n.related_to=e,g(n),t.loading=!1,t.refreshing=!1,t.pageBlockUI.stop()})["catch"](function(e){404===e.status&&(n.related_to=null,g(n)),t.loading=!1,t.refreshing=!1,t.pageBlockUI.stop()})}else g(n),t.loading=!1,t.refreshing=!1,t.pageBlockUI.stop()})["catch"](function(){t.loading=!1,t.refreshing=!1,t.pageBlockUI.stop()}),t.yesNo=A.getYesNo(w)})};N(),t.refreshSubModules[t.type]={},t.refresh=function(){t.refreshing=!0,t.pageBlockUI.start(),N(),angular.forEach(t.module.relations,function(e){t.refreshSubModules[t.type][e.related_module]=t.getCurrentTime()})},t.changeTab=function(e){"flat"!=e.detail_view_type?(t.tab=angular.copy(e.id.toString()),t.activeType="flat"):t.activeType="tab",t.isActive=[],t.isActive[e.id]=!0},t.lookup=function(r){if("users"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="full_name",t.currentLookupField.lookupModulePrimaryField=a}if("profiles"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="name",t.currentLookupField.lookupModulePrimaryField=a}if("roles"===t.currentLookupField.lookup_type&&!t.currentLookupField.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="label_"+e.user.tenantLanguage,t.currentLookupField.lookupModulePrimaryField=a}if("relation"===t.currentLookupField.lookup_type){if(!t.record.related_module)return t.$broadcast("angucomplete-alt:clearInput",t.currentLookupField.name),d.defer().promise;var n=o("filter")(e.modules,{name:t.record.related_module.value},!0)[0];if(!n)return t.$broadcast("angucomplete-alt:clearInput",t.currentLookupField.name),d.defer().promise;t.currentLookupField.lookupModulePrimaryField=o("filter")(n.fields,{primary:!0},!0)[0]}return"number"!==t.currentLookupField.lookupModulePrimaryField.data_type&&"number_auto"!==t.currentLookupField.lookupModulePrimaryField.data_type||!isNaN(parseFloat(r))?A.lookup(r,t.currentLookupField,t.record):(t.$broadcast("angucomplete-alt:clearInput",t.currentLookupField.name),d.defer().promise)},t.multiselect=function(e,r){var o=[];return angular.forEach(t.picklistsModule[r.picklist_id],function(t){t.inactive||t.hidden||(t.labelStr.toLowerCase().indexOf(e.toLowerCase())>-1||t.labelStr.toUpperCase().indexOf(e.toUpperCase())>-1||t.labelStr.toLowerCaseTurkish().indexOf(e.toLowerCaseTurkish())>-1||t.labelStr.toUpperCaseTurkish().indexOf(e.toUpperCaseTurkish())>-1)&&o.push(t)}),o},t.setCurrentLookupField=function(e){t.currentLookupField=e},t.validate=function(e,t,r){if(r){if(r.required&&!e)return o("translate")("Module.Required");if("lookup"===t&&e&&"object"!=typeof e)return o("translate")("Module.RequiredAutoCompleteError");if("email"===t&&e){var a=/^[a-z0-9!#$%&'*+\/=?^_`{|}~.-]+@[a-z0-9]([a-z0-9-]*[a-z0-9])?(\.[a-z0-9]([a-z0-9-]*[a-z0-9])?)*$/i;if(!a.test(e))return o("translate")("Module.EmailInvalid")}if("url"===t&&e){var n=/(http|https|file|ftp):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;if(!n.test(e))return o("translate")("Module.UrlInvalid")}if("checkbox"===t&&void 0===e&&(e=!1),r.min&&e){var i=parseFloat(e),s=parseFloat(r.min);if(s>i)return o("translate")("Module.MinError")}if(r.min&&e){var l=parseFloat(e),d=parseFloat(r.max);if(d>l)return o("translate")("Module.MaxError")}return r.min_length&&e&&e.length<r.min_length?o("translate")("Module.MinLengthError"):!0}},t.update=function(){t.updating=!0;var a=A.prepareRecord(t.record,t.module,t.recordState);a.activity_type_system&&delete a.activity_type_system,a.transaction_type_system&&delete a.transaction_type_system,A.updateRecord(t.module.name,a).then(function(r){var a=function(){t.recordState=angular.copy(t.record),x(),angular.forEach(t.actionButtons,function(e){e.isShown=!1,e.dependent_field?r[e.dependent_field]&&r[e.dependent_field]==e.dependent&&(e.isShown=!0):e.isShown=!0})},n=o("filter")(e.approvalProcesses,{module_id:t.module.id},!0);if(n){for(var i=!1,s=0;s<n.length;s++)(0===n[s].user_id||n[s].user_id===t.currentUser.id)&&n[s].operations.indexOf("update")>-1&&(i=!0);i&&3!==t.record.process_status?(t.record.freeze=!0,setTimeout(function(){A.getRecord(t.module.name,t.record.id).then(function(a){var n=A.processRecordSingle(a.data,t.module,t.picklistsModule);if(n.process_status&&(2===n.process_status?t.isApproved=!0:1===n.process_status&&(t.isApproved=!1),(1===n.process_status||2===n.process_status||3===n.process_status&&n.created_by.id!=t.currentUser.id)&&(n.freeze=!0),A.getProcess(n.process_id).then(function(r){var a=r.data.approvers;if(a.length>0){var i=o("filter")(a,{id:t.currentUser.id},!0)[0];i||3===n.process_status||(t.waitingForApproval=!0),i&&(i.order===n.process_status_order?t.isApprovalRecord=!0:3!==n.process_status&&(t.waitingForApproval=!0))}else if(1===n.process_status_order){var s=n.custom_approver;s===e.user.email?t.isApprovalRecord=!0:s!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(2===n.process_status_order){var l=n.custom_approver_2;l===e.user.email?t.isApprovalRecord=!0:l!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(3===n.process_status_order){var d=n.custom_approver_3;d===e.user.email?t.isApprovalRecord=!0:d!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(4===n.process_status_order){var u=n.custom_approver_4;u===e.user.email?t.isApprovalRecord=!0:u!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}else if(5===n.process_status_order){var c=n.custom_approver_5;c===e.user.email?t.isApprovalRecord=!0:c!==e.user.email&&3!==n.process_status&&(t.waitingForApproval=!0)}if(0===n.operation_type&&2===n.process_status)for(var p=0;p<r.data.operations_array.length;p++){var m=r.data.operations_array[p];"update"===m&&(n.freeze=!1)}1===n.operation_type&&2===n.process_status&&(n.freeze=!1)})),t.module.dependencies.length>0){var i=o("filter")(t.module.dependencies,{dependency_type:"freeze"},!0);angular.forEach(i,function(e){var r=o("filter")(t.module.fields,{name:e.parent_field},!0);angular.forEach(r,function(t){angular.forEach(e.values_array,function(e){!n[t.name]||e!=n[t.name]&&e!=n[t.name].id||(n.freeze=!0)})})})}if(null!==t.currentModuleProcess&&t.currentModuleProcess.profile_list&&t.currentModuleProcess.profile_list.length>0)for(var s=0;s<t.currentModuleProcess.profile_list.length;s++){var l=t.currentModuleProcess.profile_list[s];parseInt(l)===e.user.profile.id&&(n.freeze=!1)}A.formatRecordFieldValues(angular.copy(a.data),t.module,t.picklistsModule),t.title=t.primaryField.valueFormatted;var d=function(r){t.record=r,t.recordState=angular.copy(t.record),A.setDisplayDependency(t.module,t.record),t.record.currency&&(t.currencySymbol=t.record.currency.value||e.currencySymbol),getProducts(t.type)};if(angular.forEach(t.actionButtons,function(e){e.isShown=!1,e.dependent_field?r[e.dependent_field]&&r[e.dependent_field]==e.dependent&&(e.isShown=!0):e.isShown=!0}),t.relatedToField&&n.related_to){var u=o("filter")(e.modules,{id:n[t.relatedToField.lookup_relation].id-9e5},!0)[0],c=o("filter")(u.fields,{primary:!0},!0)[0];A.getRecord(u.name,n.related_to,!0).then(function(e){e=e.data,e.primary_value=e[c.name],n.related_to=e,d(n),t.updating=!1})["catch"](function(e){404===e.status&&(n.related_to=null,d(n)),t.updating=!1})}else d(n),t.updating=!1})["catch"](function(){t.updating=!1})},2e3)):a()}else a()})["catch"](function(e,a){409===a&&(r.create({content:o("translate")("Module.UniqueError"),className:"danger"}),t.record[e.field]=t.recordState[e.field])})},t["delete"]=function(){t.executeCode=!1,R.run("BeforeDelete","Script",t,t.record),t.executeCode||A.deleteRecord(t.module.name,t.record.id).then(function(){return R.run("AfterDelete","Script",t,t.record),x(),t.parentId?void s.go("app.moduleDetail",{type:t.parentModule,id:t.parentId}):void s.go("app.moduleList",{type:t.type})})};var x=function(){var r=t.module.name+"_"+t.module.name;if(t.parentId){r=(t.relatedToField?"related_to":t.parentType)+t.parentId+"_"+t.module.name;var o=t.parentType+"_"+t.parentType;p.remove(r),p.remove(o)}else p.remove(r),"opportunities"===t.module.name&&p.remove("opportunity"+t.id+"_stage_history");e.activePages&&e.activePages[t.module.name]&&(e.activePages[t.module.name]=null),(t.module.display_calendar||"activities"===t.module.name)&&p.remove("calendar_events")};if(t.calculate=function(e){A.calculate(e,t.module,t.record)},t.fieldValueChange=function(r){A.setDependency(r,t.module,t.record,t.picklistsModule),t.record.currency&&(t.currencySymbol=t.record.currency.value||e.currencySymbol)},t.reformatFieldValues=function(){A.formatRecordFieldValues(t.record,t.module,t.picklistsModule)},t.hideCreateNew=function(e){return"users"===e.lookup_type?!0:"relation"!==e.lookup_type||t.record.related_module?!1:!0},t.openFormModal=function(e){t.primaryValueModal=e,t.formModalShown=!0,t.formModal=t.formModal||y({scope:t,templateUrl:"view/app/module/moduleFormModal.html",animation:"",backdrop:"static",show:!1,tag:"formModal"}),t.formModal.$promise.then(t.formModal.show)},t.$on("modal.hide",function(e,r){"formModal"==r.$options.tag&&(t.formModalShown=!1,"object"!=typeof t.record[t.currentLookupField.name]?t.lookupFocusOut():(delete t.editLookup[t.currentLookupField.name],t.update())),"relatedModuleInModal"==r.$options.tag&&(t.selectedRelatedModule.relatedModuleInModal=!1)}),t.lookupFocusOut=function(){v(function(){t.formModalShown||t.updating||(t.record[t.currentLookupField.name]=t.recordState[t.currentLookupField.name],t.$broadcast("angucomplete-alt:changeInput",t.currentLookupField.name,t.recordState[t.currentLookupField.name]),delete t.editLookup[t.currentLookupField.name])},200)},t.getAttachments=function(){a.hasDocumentsPermission(t.operations.read)&&T.getEntityDocuments(e.workgroup.tenant_id,t.id,t.module.id).then(function(r){t.documentsResultSet=T.processDocuments(r.data,e.users),t.documents=t.documentsResultSet.documentList,t.loadingDocuments=!1})},t.showActivityButtons=function(){t.activityButtonsPopover=t.activityButtonsPopover||g(angular.element(document.getElementById("activityButtons")),{templateUrl:"view/common/newactivity.html",placement:"bottom",autoClose:!0,scope:t,show:!0})},t.showTransactionButtons=function(){t.transactionButtonsPopover=t.transactionButtonsPopover||g(angular.element(document.getElementById("transactionButtons")),{templateUrl:"view/common/newtransaction.html",placement:"bottom",autoClose:!0,scope:t,show:!0})},t.getCurrentTime=function(){var e=new Date;return e.getTime()},t.openExportDialog=function(){t.pdfCreating=!0;var a=function(){t.PdfModal=t.PdfModal||y({scope:t,templateUrl:"view/app/module/modulePdfModal.html",animation:"",backdrop:"static",show:!1}),t.PdfModal.$promise.then(t.PdfModal.show)};t.quoteTemplates&&(a(),t.quoteTemplate=t.quoteTemplates[0]),A.getTemplates(t.module.name,"module").then(function(n){if(0==n.data.length)r.create(e.preview?{content:o("translate")("Setup.Templates.TemplateDefined"),className:"warning"}:{content:o("translate")("Setup.Templates.TemplateNotFound"),className:"warning"}),t.pdfCreating=!1;else{var i=n.data;t.quoteTemplates=o("filter")(i,{active:!0},!0),t.isShownWarning=!0;for(var s=0;s<t.quoteTemplates.length;s++){var l=t.quoteTemplates[s];if(l.permissions.length>0){var d=o("filter")(l.permissions,{profile_id:e.user.profile.id},!0)[0];l.isShown="none"===d.type?!1:!0,1==l.isShown&&(t.isShownWarning=!1)}else l.isShown=!0,t.isShownWarning=!1}t.quoteTemplate=t.quoteTemplates[0],t.PdfModal=t.PdfModal||y({scope:t,templateUrl:"view/app/module/modulePdfModal.html",animation:"",backdrop:"static",show:!1}),a()}})["catch"](function(){t.pdfCreating=!1})},t.getDownloadUrl=function(a){u.open("/attach/export?module="+t.type+"&id="+t.id+"&templateId="+t.quoteTemplate.id+"&access_token="+c.read("access_token")+"&format="+a+"&locale="+e.locale+"&timezoneOffset="+-1*(new Date).getTimezoneOffset(),"_blank"),r.create({content:o("translate")("Module.ExcelDesktop"),className:"success"})},t.openAddModal=function(e){t.selectedRelatedModule=e,t.selectedRelatedModule.relatedModuleInModal=!0,t.addModal=t.addModal||y({scope:t,templateUrl:"view/app/module/moduleAddModal.html",animation:"",backdrop:"static",show:!1,tag:"relatedModuleInModal"}),t.addModal.$promise.then(t.addModal.show)},t.showEMailModal=function(r,o){if(!e.system.messaging.SystemEMail&&!e.system.messaging.PersonalEMail){var a="mailto:"+o,n=u.open(a,"_blank");return void(n.document.title="Ofisim.com")}t.mailModal=t.mailModal||y({scope:t,templateUrl:"view/app/email/singleEmailModal.html",backdrop:"static",show:!1}),r||t.mailModal.$promise.then(t.mailModal.show)},t.showQuoteEMailModal=function(a){return e.system.messaging.SystemEMail||e.system.messaging.PersonalEMail?(t.mailModal=t.mailModal||y({scope:t,templateUrl:"view/app/email/singleEmailModal.html",backdrop:"static",show:!1}),void(a||t.mailModal.$promise.then(t.mailModal.show))):void r.create({content:o("translate")("EMail.NoProvider"),className:"warning"})},t.showSingleSMSModal=function(){return e.system.messaging.SMS?(t.smsModal=t.smsModal||y({scope:t,templateUrl:"view/app/sms/singleSMSModal.html",backdrop:"static",show:!1}),void t.smsModal.$promise.then(t.smsModal.show)):void r.create({content:o("translate")("SMS.NoProvider"),className:"warning"})},t.showModuleFrameModal=function(e){if(new RegExp("https:").test(e)){var r,o,a;r="myPop1",o=document.body.offsetWidth-200,a=document.body.offsetHeight-200;var n=screen.width/2-o/2,i=screen.height/2-a/2;window.open(e,r,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+o+", height="+a+", top="+i+", left="+n)}else t.frameUrl=e,t.frameModal=t.frameModal||y({scope:t,controller:"ActionButtonFrameController",templateUrl:"view/app/actionbutton/actionButtonFrameModal.html",backdrop:"static",show:!1}),t.frameModal.$promise.then(t.frameModal.show)},t.dropdownHide=function(){angular.element(document.getElementsByClassName("dropdown-menu"))[0].click(),angular.element(document.getElementsByClassName("dropdown-menu"))[1].click()},t.documentDownload=function(e){u.location="/storage/record_file_download?fileName="+e},t.showTransactionButtons=function(){t.transactionButtonsPopover=t.transactionButtonsPopover||g(angular.element(document.getElementById("transactionButtons")),{templateUrl:"view/common/newtransaction.html",placement:"bottom",autoClose:!0,scope:t,show:!0})},t.getmoduledownloadurl=function(e,r){return e?h.apiUrl+"Document/download_module_document?module="+t.module.name+"&fileNameExt="+a.getFileExtension(e)+"&fileName="+e+"&fieldName="+r+"&recordId="+t.record.id+"&access_token="+c.read("access_token"):void 0},t.showHideSipPhone=function(t){function a(t){var a=e.sipUser.session;a?r.create({content:o("translate")("Phone.AlreadyInCall"),className:"warning"}):(e.sipUser.numberToDial=t,e.sipUser.numberToDial.length>2?(e.sipUser.lineInfo.PhoneStatus=o("translate")("Setup.Phone.Dialing"),e.sipUser.lineInfo.State="Dialing",e.sipUser.lineInfo.TalkingNumber=e.sipUser.numberToDial,n.dial(e.sipUser.lineInfo.TalkingNumber,!1),e.sipUser.activePhoneScreen="connectingScreen"):r.create({content:o("translate")("Phone.NoNumber"),className:"warning"}))}e.sipUser&&e.sipPhone&&e.sipPhone[e.app]?(e.sipUser.lineInfo.State="Dialing",a(t),e.sipPhone.crm.show()):v(function(){e.sipPhone?e.sipPhone.crm.show():e.showSipPhone("call"),a(t)},1e3)},t.showLightBox=function(e){t.lightBox=!0,t.ImageUrl=e},t.closeLightBox=function(){t.lightBox=!1},t.openLocationModal=function(e){t.filedName=e,t.locationModal=t.frameModal||y({scope:t,controller:"locationFormModalController",templateUrl:"view/app/location/locationFormModal.html",backdrop:"static",show:!1}),t.locationModal.$promise.then(t.locationModal.show)},t.webhookRequest=function(a){var a=angular.copy(a),n=new XMLHttpRequest;n.onreadystatechange=function(){4==this.readyState&&(v(function(){t.webhookRequesting[a.id]=!1}),r.create(200==this.status?{content:o("translate")("Module.ActionButtonWebhookSuccess"),className:"success"}:{content:o("translate")("Module.ActionButtonWebhookFail"),className:"warning"}))};var i={},s=[],l=a.parameters.split(","),d=a.headers.split(",");if(t.webhookRequesting={},t.webhookRequesting[a.id]=!0,angular.forEach(l,function(e){var r=e.split("|"),o=r[0],a=r[1],n=r[2];i[o]=a!=t.module.name?t.record[a]?t.record[a][n]:null:t.record[n]?t.record[n]:null}),angular.forEach(d,function(r){var o=null,a=r.split("|"),n=a[0],i=a[1],l=a[2],d=a[3],u={};switch(n){case"module":var c=d;o=i!=t.module.name?t.record[i]?t.record[i][c]:t.record[i][c]:t.record[c]?t.record[c]:null;break;case"static":switch(d){case"{:app:}":o=e.user.app_id;break;case"{:tenant:}":o=e.user.tenant_id;break;case"{:user:}":o=e.user.id;break;default:o=null}break;case"custom":o=d;break;default:o=null}u.key=l,u.value=o,s.push(u)}),"post"===a.method_type)n.open("POST",a.url,!0),a.url.indexOf(window.location.host)>-1&&n.setRequestHeader("Authorization","Bearer "+c.read("access_token")),n.setRequestHeader("Content-Type","application/json"),angular.forEach(s,function(e){n.setRequestHeader(e.key,e.value)}),n.send(JSON.stringify(i));else if("get"===a.method_type){var u="";for(var p in i)u+=p+"="+i[p]+"&";u.length>0&&(u=u.substring(0,u.length-1)),a.url+=a.url.indexOf("?")<0?"?":"&",n.open("GET",a.url+u,!0),a.url.indexOf(window.location.host)>-1&&n.setRequestHeader("Authorization","Bearer "+c.read("access_token")),angular.forEach(s,function(e){n.setRequestHeader(e.key,e.value)}),n.send()}},t.approveProcess=function(){t.executeCode=!1,R.run("BeforeApproveProcess","Script",t),t.executeCode||(t.approving=!0,A.approveProcessRequest(t.record.operation_type,t.module.name,t.record.id).then(function(e){"approved"===e.data.status?(t.isApproved=!0,t.record.freeze=!0,R.run("AfterApproveProcess","Script",t)):t.record.process_status_order++,t.approving=!1,t.waitingForApproval=!0})["catch"](function(){t.approving=!1}))},t.rejectProcess=function(e){t.executeCode=!1,R.run("BeforeRejectProcess","Script",t),t.executeCode||(t.rejecting=!0,A.rejectProcessRequest(t.record.operation_type,t.module.name,e,t.record.id).then(function(){t.isRejectedRequest=!0,t.rejecting=!1,t.record.process_status=3,t.rejectModal.hide()})["catch"](function(){t.rejecting=!1}))},t.reApproveProcess=function(){t.reapproving=!0,A.send_approval(t.record.operation_type,t.module.name,t.record.id).then(function(){t.waitingForApproval=!0,t.record.freeze=!0,t.reapproving=!1,t.record.process_status=1,t.record.process_status_order++})["catch"](function(){t.reapproving=!1})},t.openRejectApprovalModal=function(){t.rejectModal=t.rejectModal||y({scope:t,templateUrl:"view/app/module/rejectProcessModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),t.rejectModal.$promise.then(t.rejectModal.show)},t.sendToProcessApproval=function(){if(t.executeCode=!1,R.run("BeforeSendToProcessApproval","Script",t,t.record),!t.executeCode){if("izinler"===t.module.name){var e="";if(t.skipValidation||(e=A.customValidations(t.module,t.record)),""!=e)return void r.create({content:e,className:"warning",timeout:8e3})}t.manuelApproveRequest=!0;var a={record_id:t.record.id,module_id:t.module.id};A.sendApprovalManuel(a).then(function(){R.run("AfterSendToProcessApproval","Script",t,t.record),t.hasManuelProcess=!1,t.waitingForApproval=!0,t.record.freeze=!0,t.manuelApproveRequest=!1,t.record.process_status=1,t.record.process_status_order++})["catch"](function(e){t.manuelApproveRequest=!1,400===e.status&&(e.data.model_state&&e.data.model_state.filters_not_match&&r.create({content:o("translate")("Common.FiltersNotMatched"),className:"warning"}),e.data.model_state&&e.data.model_state.approver_not_found&&r.create({content:o("translate")("Common.ApproverNotFound"),className:"warning"}))
})}},t.convertSalesOrder=function(){var a={};a.sales_order_id=t.id,a.deleted=!1,A.convertSalesInvoice(a).then(function(a){t.converted=a.data,t.convertDisable=!0,r.create({content:o("translate")("Convert.Success",{type:t.module["label_"+e.language+"_singular"]}),className:"success"}),u.location.href="#/app/module/sales_invoices?id="+a.data.sales_invoice_id+"&back=sales_orders"})["catch"](function(e){409===e.status&&t.moduleForm[e.data.field].$setValidity("unique",!1)})["finally"](function(){t.loading=!1})},t.convertPurchaseOrder=function(){var a={};a.purchase_order_id=t.id,a.deleted=!1,A.convertPurchaseInvoice(a).then(function(a){t.converted=a.data,t.convertDisable=!0,r.create({content:o("translate")("Convert.Success",{type:t.module["label_"+e.language+"_singular"]}),className:"success"}),u.location.href="#/app/module/purchase_invoices?id="+a.data.purchase_invoice_id+"&back=purchase_orders"})["catch"](function(e){409===e.status&&t.moduleForm[e.data.field].$setValidity("unique",!1)})["finally"](function(){t.loading=!1})},t.module.relations.length>0){t.relationActionButtons=[];var $=o("filter")(t.module.relations,{deleted:!1},!0),O=function(e){e.isShown=!1,e.dependent_field?record[e.dependent_field]&&record[e.dependent_field].labelStr==e.dependent&&(e.isShown=!0):e.isShown=!0};if($.length>0)for(var U=0;U<$.length;U++){var Y=o("filter")(e.modules,{name:$[U].related_module},!0)[0];A.getActionButtons(Y.id).then(function(e){if(e.length>0){var r=o("filter")(e,function(e){return"Detail"!==e.trigger&&"Form"!==e.trigger&&"List"!==e.trigger},!0);if(r)for(var a=0;a<r.length;a++){var n=r[a];n.module_name=Y.name,t.relationActionButtons.push(n),O(n)}}})}}R.run("AfterDetailLoaded","script",t)}]);