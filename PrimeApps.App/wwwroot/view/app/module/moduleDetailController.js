"use strict";angular.module("primeapps").controller("ModuleDetailController",["$rootScope","$scope","$filter","helper","$location","$state","$stateParams","$q","$window","$localStorage","$cache","entityTypes","operations","config","guidEmpty","$timeout","$sce","yesNo","$anchorScroll","blockUI","FileUploader","DocumentService","ModuleService","$http","components","$mdDialog","mdToast",function(e,r,t,o,a,n,i,l,s,d,u,c,p,m,f,_,h,g,v,y,M,w,k,F,P,b,S){if(r.type=i.type,r.id=a.search().id,r.parentType=a.search().ptype,r.parentId=a.search().pid,r.returnParentType=a.search().rptype,r.returnTab=a.search().rtab,r.previousParentType=a.search().pptype,r.previousParentId=a.search().ppid,r.previousReturnTab=a.search().prtab,r.returnPreviousParentType=a.search().rpptype,r.returnPreviousParentId=a.search().rppid,r.returnPreviousReturnTab=a.search().rprtab,r.back=a.search().back,r.module=t("filter")(e.modules,{name:r.type},!0)[0],r.operations=p,r.hasPermission=o.hasPermission,r.hasDocumentsPermission=o.hasDocumentsPermission,r.hasFieldDisplayPermission=k.hasFieldDisplayPermission,r.hasFieldFullPermission=k.hasFieldFullPermission,r.hasSectionDisplayPermission=k.hasSectionDisplayPermission,r.hasSectionFullPermission=k.hasSectionFullPermission,r.hasActionButtonDisplayPermission=k.hasActionButtonDisplayPermission,r.loading=!0,r.pdfUrl="",r.isDetail=!0,r.refreshSubModules={},r.editLookup={},r.tab="general",r.lookupUser=o.lookupUser,r.isActive={},r.waitingForApproval=!1,r.isProcessRecord=!1,r.isApproved=!1,r.isRejectedRequest=!1,r.appId=e.user.app_id,r.hasManuelProcess=!1,r.manuelApproveRequest=!1,r.freeze=a.search().freeze,r.currentModuleProcess=null,r.customHide=!1,r.googleMapsApiKey=googleMapsApiKey,r.currentSectionComponentsTemplate=currentSectionComponentsTemplate,r.scriptRunning={},r.pageBlockUI=y.instances.get("pageBlockUI"),r.actionButtonDisabled=!1,!r.module)return S.warning(t("translate")("Common.NotFound")),void n.go("app.dashboard");if(!r.id)return S.warning(t("translate")("Common.NotFound")),void n.go("app.dashboard");P.run("BeforeDetailLoaded","script",r),r.setDropdownData=function(e){if(e.filters&&e.filters.length>0)r.dropdownFieldDatas[e.name]=null;else if(r.dropdownFieldDatas[e.name]&&r.dropdownFieldDatas[e.name].length>0)return;r.currentLookupField=e,r.lookup().then(function(t){r.dropdownFieldDatas[e.name]=t})},r.trustAsHtml=function(e){return h.trustAsHtml(e)},r.dropdownFields=t("filter")(r.module.fields,{data_type:"lookup",show_as_dropdown:!0},!0),r.dropdownFieldDatas={};for(var T=0;T<r.dropdownFields.length;T++)r.dropdownFieldDatas[r.dropdownFields[T].name]=[];r.tabconfig=r.module.detail_view_type?"flat"!=r.module.detail_view_type?!0:!1:"flat"!=e.detailViewType?!0:!1,r.returnPreviousParentType&&r.returnPreviousParentId!=r.id&&(r.parentType=angular.copy(r.returnPreviousParentType),r.parentId=angular.copy(r.returnPreviousParentId),r.returnTab=angular.copy(r.returnPreviousReturnTab));var A=function(){r.tabconfig?r.scrollHeightTab={height:s.innerHeight-255+"px"}:r.scrollHeight={height:s.innerHeight-165+"px"}};A(),angular.element(s).on("resize",function(){_(function(){A()})}),r.primaryField=t("filter")(r.module.fields,{primary:!0})[0],r.currentUser=k.processUser(e.user),r.currentDayMin=o.getCurrentDateMin().toISOString(),r.currentDayMax=o.getCurrentDateMax().toISOString(),r.currentHour=o.floorMinutes(new Date),r.entityTypes=c,r.guidEmpty=f,r.relatedToField=t("filter")(r.module.fields,{name:"related_to"},!0)[0],r.record={},r.allFields=[],r.showEditor=!1,r.isAdmin=e.user.profile.has_admin_rights,angular.forEach(r.module.fields,function(e){k.hasFieldDisplayPermission(e)&&r.allFields.push(angular.copy(e))});for(var R=0;R<e.approvalProcesses.length;R++){var D=e.approvalProcesses[R];D.module_id===r.module.id&&(r.currentModuleProcess=D)}if(r.currentModuleProcess){var z=r.currentModuleProcess.profiles.split(",");r.hasProcessEditPermission=!1;for(var T=0;T<z.length;T++)z[T]===e.user.profile.id.toString()&&(r.hasProcessEditPermission=!0)}if(r.module.relations&&angular.forEach(r.module.relations,function(o){if(!o.deleted){var a=t("filter")(e.modules,{name:o.related_module},!0)[0],i={};if("activities"!==o.related_module&&"mails"!==o.related_module||"many_to_many"===o.relation_type)if("many_to_many"===o.relation_type){if(!a)return;var l=t("filter")(a.fields,{primary:!0},!0)[0],s=o.related_module+"_id."+o.related_module+"."+l.name;i={fields:["total_count()",s],filters:[{field:r.module.name+"_id",operator:"equals",value:r.id,no:1}],limit:1,offset:0,many_to_many:r.module.name}}else i={fields:["total_count()"],filters:[{field:o.relation_field,operator:"equals",value:r.id,no:1}],limit:1,offset:0};else i={fields:["total_count()"],filters:[{field:o.relation_field,operator:"equals",value:r.id,no:1},{field:"related_module",operator:"is",value:r.module["label_"+e.user.tenant_language+"_singular"],no:1}],limit:1,offset:0};k.findRecords(o.related_module,i).then(function(e){var t=e.data;t[0]&&t[0].total_count?o.total=t[0].total_count:delete o.total,"flat"===o.detail_view_type&&(r.changeTab(o),r.returnParentType==o.id&&(r.activeType="tab",r.tab="general"))}).then(function(){r.isActive[n.params.rptype]=!0})}}),r.parentType){if("activities"===r.type||"mails"===r.type||r.many)r.parentModule=r.parentType;else{var L=t("filter")(r.module.fields,{name:r.parentType},!0)[0];L?r.parentModule=L.lookup_type:(r.parentModule=r.parentType,r.returnType="general")}r.previousParentType||(r.previousParentType=angular.copy(r.parentType),r.previousParentId=angular.copy(r.parentId),!r.previousReturnTab&&r.returnTab&&(r.previousReturnTab=angular.copy(r.returnTab)))}r.module.default_tab&&(r.tab=r.module.default_tab),r.returnParentType&&(r.tab=r.returnParentType,r.tabconfig||(r.isActive[r.returnParentType]=!0,a.hash("relation"+r.returnParentType),v()));var C=function(){if("izinler"===r.module.name&&(r.hasManuelProcess&&(r.record.owner.id===r.currentUser.id||r.hasProcessRights)&&!r.record.process_id||3===r.record.process_status&&r.record.owner.id===r.currentUser.id&&!r.waitingForApproval)&&r.record.izin_turu){var e=moment().date(1).month(1).year(moment().year()).format("YYYY-MM-DD");if(r.record.goreve_baslama_tarihi=r.record.calisan.ise_baslama_tarihi,r.record.izin_turu_data=r.record.izin_turu,r.record.dogum_tarihi=r.record.calisan.dogum_tarihi,r.record.calisan_data=r.record.calisan,r.record.izin_turu_data.yillik_izin){var t=moment(r.record.calisan_data.ise_baslama_tarihi),o=t.get("date"),a=t.get("month"),n=moment().get("year"),i=moment().date(o).month(a).year(n).format("YYYY-MM-DD");moment(i).isAfter(moment().format("YYYY-MM-DD"))&&(n-=1),e=moment().date(o).month(a).year(n).format("YYYY-MM-DD")}r.record.izin_turu_data.her_ay_yenilenir&&(e=moment().date(1).month(moment().month()).year(moment().year()).format("YYYY-MM-DD"));var l={fields:["hesaplanan_alinacak_toplam_izin","baslangic_tarihi","bitis_tarihi","izin_turu","process.process_requests.process_status","system_code"],filters:[{field:"calisan",operator:"equals",value:r.record.calisan.id,no:1},{field:"baslangic_tarihi",operator:"greater_equal",value:e,no:2},{field:"deleted",operator:"equals",value:!1,no:3},{field:"process.process_requests.process_status",operator:"not_equal",value:3,no:4}],limit:999999};k.findRecords("izinler",l).then(function(e){e.data.length>0&&(r.record.alinan_izinler=e.data)})}};r.picklistFilter=function(){return function(e){return r.componentFilter={},r.componentFilter.item=e,r.componentFilter.result=!0,P.run("PicklistFilter","Script",r),!e.hidden&&!e.inactive&&r.componentFilter.result}};var E=function(){k.getPicklists(r.module).then(function(o){r.picklistsModule=o,k.getRecord(r.module.name,r.id).then(function(o){0===Object.keys(o.data).length&&(S.error(t("translate")("Common.Forbidden")),n.go("app.dashboard")),"activities"!=r.module.name&&angular.forEach(r.module.fields,function(e){k.setDependency(e,r.module,r.record,r.picklistsModule),e.default_value&&"picklist"==e.data_type&&(r.record[e.name]=t("filter")(r.picklistsModule[e.picklist_id],{id:e.default_value})[0],r.fieldValueChange(e))});for(var a=k.processRecordSingle(o.data,r.module,r.picklistsModule),i=0;i<e.approvalProcesses.length;i++){var l=e.approvalProcesses[i];l.module_id===r.module.id&&"manuel"===l.trigger_time&&(r.hasManuelProcess=!0),l.module_id===r.module.id&&(r.currentModuleProcess=l)}for(var s=0;s<r.module.fields.length;s++){var d=r.module.fields[s],u=!1;if(d.encrypted&&d.encryption_authorized_users_list.length>0&&a[d.name])for(var c=0;c<d.encryption_authorized_users_list.length;c++){var p=d.encryption_authorized_users_list[c];e.user.id==parseInt(p)&&(u=!0)}d.show_lock=d.encrypted&&!u?!0:!1}if(a.process_status&&(2===a.process_status&&(r.isApproved=!0),(1===a.process_status||2===a.process_status||3===a.process_status&&a.created_by.id!=r.currentUser.id)&&(a.freeze=!0),k.getProcess(a.process_id).then(function(o){var n=o.data.approvers;if(n.length>0){var i=t("filter")(n,{id:r.currentUser.id},!0)[0];i||3===a.process_status||(r.waitingForApproval=!0),i&&(i.order===a.process_status_order?r.isApprovalRecord=!0:3!==a.process_status&&(r.waitingForApproval=!0))}else if(1===a.process_status_order){var l=a.custom_approver;l===e.user.email?r.isApprovalRecord=!0:l!==e.user.email&&3!==a.process_status&&(r.waitingForApproval=!0)}else if(2===a.process_status_order){var s=a.custom_approver_2;s===e.user.email?r.isApprovalRecord=!0:s!==e.user.email&&3!==a.process_status&&(r.waitingForApproval=!0)}else if(3===a.process_status_order){var d=a.custom_approver_3;d===e.user.email?r.isApprovalRecord=!0:d!==e.user.email&&3!==a.process_status&&(r.waitingForApproval=!0)}else if(4===a.process_status_order){var u=a.custom_approver_4;u===e.user.email?r.isApprovalRecord=!0:u!==e.user.email&&3!==a.process_status&&(r.waitingForApproval=!0)}else if(5===a.process_status_order){var c=a.custom_approver_5;c===e.user.email?r.isApprovalRecord=!0:c!==e.user.email&&3!==a.process_status&&(r.waitingForApproval=!0)}if(0===a.operation_type&&2===a.process_status)for(var p=0;p<o.data.operations_array.length;p++){var m=o.data.operations_array[p];"update"===m&&(a.freeze=!1)}1===a.operation_type&&2===a.process_status&&(a.freeze=!1),"izinler"===r.module.name&&C()})),r.module.dependencies.length>0){var m=t("filter")(r.module.dependencies,{dependency_type:"freeze",deleted:!1},!0);angular.forEach(m,function(e){var o=t("filter")(r.module.fields,{name:e.parent_field},!0);angular.forEach(o,function(r){angular.forEach(e.values_array,function(e){!a[r.name]||e!=a[r.name]&&e!=a[r.name].id||(a.freeze=!0)})})})}if(r.freeze&&(a.freeze=!0),null!==r.currentModuleProcess){if(r.currentModuleProcess.profile_list&&r.currentModuleProcess.profile_list.length>0)for(var f=0;f<r.currentModuleProcess.profile_list.length;f++){var _=r.currentModuleProcess.profile_list[f];parseInt(_)===e.user.profile.id&&(a.freeze=!1)}e.user.profile.has_admin_rights&&(a.freeze=!1)}k.formatRecordFieldValues(angular.copy(o.data),r.module,r.picklistsModule),r.title=r.primaryField.valueFormatted;var h=function(t){r.record=t,r.recordState=angular.copy(r.record),k.setDisplayDependency(r.module,r.record),r.record.currency&&(r.currencySymbol=r.record.currency.value||e.currencySymbol),P.run("AfterRecordLoaded","Script",r,r.record),r.currentModuleProcess&&r.currentModuleProcess.profile_list&&(r.hasProcessRights=r.currentModuleProcess.profile_list.indexOf(e.user.profile.ID.toString())>-1?!0:!1),"izinler"===r.module.name&&C()};if(k.getActionButtons(r.module.id).then(function(e){r.actionButtons=t("filter")(e,function(e){return"List"!==e.trigger&&"Form"!==e.trigger&&"Relation"!==e.trigger},!0),angular.forEach(r.actionButtons,function(e){e.isShown=!1,e.dependent_field?a[e.dependent_field]&&a[e.dependent_field].labelStr==e.dependent&&(e.isShown=!0):e.isShown=!0})}),r.relatedToField&&a.related_to&&a[r.relatedToField.lookup_relation]){var g=t("filter")(e.modules,{id:a[r.relatedToField.lookup_relation].id-9e5},!0)[0],v=t("filter")(g.fields,{primary:!0},!0)[0];k.getRecord(g.name,a.related_to,!0).then(function(e){e=e.data,e.primary_value=e[v.name],a.related_to=e,h(a),r.loading=!1,r.refreshing=!1,r.pageBlockUI.stop()})["catch"](function(e){404===e.status&&(a.related_to=null,h(a)),r.loading=!1,r.refreshing=!1,r.pageBlockUI.stop()})}else h(a),r.loading=!1,r.refreshing=!1,r.pageBlockUI.stop()})["catch"](function(){r.loading=!1,r.refreshing=!1,r.pageBlockUI.stop()}),r.yesNo=k.getYesNo(g)})};E(),r.refreshSubModules[r.type]={},r.refresh=function(){r.refreshing=!0,r.pageBlockUI.start(),E(),angular.forEach(r.module.relations,function(e){r.refreshSubModules[r.type][e.related_module]=r.getCurrentTime()})},r.changeTab=function(e){"flat"!=e.detail_view_type?(r.tab=angular.copy(e.id.toString()),r.activeType="flat"):r.activeType="tab",r.isActive=[],r.isActive[e.id]=!0},r.lookup=function(o){if("users"===r.currentLookupField.lookup_type&&!r.currentLookupField.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="full_name",r.currentLookupField.lookupModulePrimaryField=a}if("profiles"===r.currentLookupField.lookup_type&&!r.currentLookupField.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="name",r.currentLookupField.lookupModulePrimaryField=a}if("roles"===r.currentLookupField.lookup_type&&!r.currentLookupField.lookupModulePrimaryField){var a={};a.data_type="text_single",a.name="label_"+e.user.tenantLanguage,r.currentLookupField.lookupModulePrimaryField=a}if("relation"===r.currentLookupField.lookup_type){if(!r.record.related_module)return r.$broadcast("angucomplete-alt:clearInput",r.currentLookupField.name),l.defer().promise;var n=t("filter")(e.modules,{name:r.record.related_module.value},!0)[0];if(!n)return r.$broadcast("angucomplete-alt:clearInput",r.currentLookupField.name),l.defer().promise;r.currentLookupField.lookupModulePrimaryField=t("filter")(n.fields,{primary:!0},!0)[0]}return"number"!==r.currentLookupField.lookupModulePrimaryField.data_type&&"number_auto"!==r.currentLookupField.lookupModulePrimaryField.data_type||!isNaN(parseFloat(o))?k.lookup(o,r.currentLookupField,r.record):(r.$broadcast("angucomplete-alt:clearInput",r.currentLookupField.name),l.defer().promise)},r.multiselect=function(e,t){var o=[];return angular.forEach(r.picklistsModule[t.picklist_id],function(r){r.inactive||r.hidden||(r.labelStr.toLowerCase().indexOf(e.toLowerCase())>-1||r.labelStr.toUpperCase().indexOf(e.toUpperCase())>-1||r.labelStr.toLowerCaseTurkish().indexOf(e.toLowerCaseTurkish())>-1||r.labelStr.toUpperCaseTurkish().indexOf(e.toUpperCaseTurkish())>-1)&&o.push(r)}),o},r.setCurrentLookupField=function(e){r.currentLookupField=e},r.validate=function(e,r,o){if(o){if(o.required&&!e)return t("translate")("Module.Required");if("lookup"===r&&e&&"object"!=typeof e)return t("translate")("Module.RequiredAutoCompleteError");if("email"===r&&e){var a=/^[a-z0-9!#$%&'*+\/=?^_`{|}~.-]+@[a-z0-9]([a-z0-9-]*[a-z0-9])?(\.[a-z0-9]([a-z0-9-]*[a-z0-9])?)*$/i;if(!a.test(e))return t("translate")("Module.EmailInvalid")}if("url"===r&&e){var n=/(http|https|file|ftp):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;if(!n.test(e))return t("translate")("Module.UrlInvalid")}if("checkbox"===r&&void 0===e&&(e=!1),o.min&&e){var i=parseFloat(e),l=parseFloat(o.min);if(l>i)return t("translate")("Module.MinError")}if(o.min&&e){var s=parseFloat(e),d=parseFloat(o.max);if(d>s)return t("translate")("Module.MaxError")}return o.min_length&&e&&e.length<o.min_length?t("translate")("Module.MinLengthError"):!0}},r.update=function(){r.updating=!0;var o=k.prepareRecord(r.record,r.module,r.recordState);o.activity_type_system&&delete o.activity_type_system,k.updateRecord(r.module.name,o).then(function(o){var a=function(){r.recordState=angular.copy(r.record),q(),angular.forEach(r.actionButtons,function(e){e.isShown=!1,e.dependent_field?o[e.dependent_field]&&o[e.dependent_field]==e.dependent&&(e.isShown=!0):e.isShown=!0})},n=t("filter")(e.approvalProcesses,{module_id:r.module.id},!0);if(n){for(var i=!1,l=0;l<n.length;l++)(0===n[l].user_id||n[l].user_id===r.currentUser.id)&&n[l].operations.indexOf("update")>-1&&(i=!0);i&&3!==r.record.process_status?(r.record.freeze=!0,setTimeout(function(){k.getRecord(r.module.name,r.record.id).then(function(a){var n=k.processRecordSingle(a.data,r.module,r.picklistsModule);if(n.process_status&&(2===n.process_status?r.isApproved=!0:1===n.process_status&&(r.isApproved=!1),(1===n.process_status||2===n.process_status||3===n.process_status&&n.created_by.id!=r.currentUser.id)&&(n.freeze=!0),k.getProcess(n.process_id).then(function(o){var a=o.data.approvers;if(a.length>0){var i=t("filter")(a,{id:r.currentUser.id},!0)[0];i||3===n.process_status||(r.waitingForApproval=!0),i&&(i.order===n.process_status_order?r.isApprovalRecord=!0:3!==n.process_status&&(r.waitingForApproval=!0))}else if(1===n.process_status_order){var l=n.custom_approver;l===e.user.email?r.isApprovalRecord=!0:l!==e.user.email&&3!==n.process_status&&(r.waitingForApproval=!0)}else if(2===n.process_status_order){var s=n.custom_approver_2;s===e.user.email?r.isApprovalRecord=!0:s!==e.user.email&&3!==n.process_status&&(r.waitingForApproval=!0)}else if(3===n.process_status_order){var d=n.custom_approver_3;d===e.user.email?r.isApprovalRecord=!0:d!==e.user.email&&3!==n.process_status&&(r.waitingForApproval=!0)}else if(4===n.process_status_order){var u=n.custom_approver_4;u===e.user.email?r.isApprovalRecord=!0:u!==e.user.email&&3!==n.process_status&&(r.waitingForApproval=!0)}else if(5===n.process_status_order){var c=n.custom_approver_5;c===e.user.email?r.isApprovalRecord=!0:c!==e.user.email&&3!==n.process_status&&(r.waitingForApproval=!0)}if(0===n.operation_type&&2===n.process_status)for(var p=0;p<o.data.operations_array.length;p++){var m=o.data.operations_array[p];"update"===m&&(n.freeze=!1)}1===n.operation_type&&2===n.process_status&&(n.freeze=!1)})),r.module.dependencies.length>0){var i=t("filter")(r.module.dependencies,{dependency_type:"freeze"},!0);angular.forEach(i,function(e){var o=t("filter")(r.module.fields,{name:e.parent_field},!0);angular.forEach(o,function(r){angular.forEach(e.values_array,function(e){!n[r.name]||e!=n[r.name]&&e!=n[r.name].id||(n.freeze=!0)})})})}if(null!==r.currentModuleProcess&&r.currentModuleProcess.profile_list&&r.currentModuleProcess.profile_list.length>0)for(var l=0;l<r.currentModuleProcess.profile_list.length;l++){var s=r.currentModuleProcess.profile_list[l];parseInt(s)===e.user.profile.id&&(n.freeze=!1)}k.formatRecordFieldValues(angular.copy(a.data),r.module,r.picklistsModule),r.title=r.primaryField.valueFormatted;var d=function(t){r.record=t,r.recordState=angular.copy(r.record),k.setDisplayDependency(r.module,r.record),r.record.currency&&(r.currencySymbol=r.record.currency.value||e.currencySymbol),getProducts(r.type)};if(angular.forEach(r.actionButtons,function(e){e.isShown=!1,e.dependent_field?o[e.dependent_field]&&o[e.dependent_field]==e.dependent&&(e.isShown=!0):e.isShown=!0}),r.relatedToField&&n.related_to){var u=t("filter")(e.modules,{id:n[r.relatedToField.lookup_relation].id-9e5},!0)[0],c=t("filter")(u.fields,{primary:!0},!0)[0];k.getRecord(u.name,n.related_to,!0).then(function(e){e=e.data,e.primary_value=e[c.name],n.related_to=e,d(n),r.updating=!1})["catch"](function(e){404===e.status&&(n.related_to=null,d(n)),r.updating=!1})}else d(n),r.updating=!1})["catch"](function(){r.updating=!1})},2e3)):a()}else a()})["catch"](function(e,o){409===o&&(S.error(t("translate")("Module.UniqueError")),r.record[e.field]=r.recordState[e.field])})},r["delete"]=function(){r.executeCode=!1,P.run("BeforeDelete","Script",r,r.record),r.executeCode||k.deleteRecord(r.module.name,r.record.id).then(function(){return P.run("AfterDelete","Script",r,r.record),q(),r.parentId?void n.go("app.moduleDetail",{type:r.parentModule,id:r.parentId}):void n.go("app.moduleList",{type:r.type})})};var q=function(){var t=r.module.name+"_"+r.module.name;if(r.parentId){t=(r.relatedToField?"related_to":r.parentType)+r.parentId+"_"+r.module.name;var o=r.parentType+"_"+r.parentType;u.remove(t),u.remove(o)}else u.remove(t);e.activePages&&e.activePages[r.module.name]&&(e.activePages[r.module.name]=null),(r.module.display_calendar||"activities"===r.module.name)&&u.remove("calendar_events")};if(r.calculate=function(e){k.calculate(e,r.module,r.record)},r.fieldValueChange=function(t){k.setDependency(t,r.module,r.record,r.picklistsModule),r.record.currency&&(r.currencySymbol=r.record.currency.value||e.currencySymbol)},r.reformatFieldValues=function(){k.formatRecordFieldValues(r.record,r.module,r.picklistsModule)},r.hideCreateNew=function(e){return"users"===e.lookup_type?!0:"relation"!==e.lookup_type||r.record.related_module?!1:!0},r.openFormModal=function(e){r.primaryValueModal=e,r.formModalShown=!0},r.$on("modal.hide",function(e,t){"formModal"==t.$options.tag&&(r.formModalShown=!1,"object"!=typeof r.record[r.currentLookupField.name]?r.lookupFocusOut():(delete r.editLookup[r.currentLookupField.name],r.update())),"relatedModuleInModal"==t.$options.tag&&(r.selectedRelatedModule.relatedModuleInModal=!1)}),r.lookupFocusOut=function(){_(function(){r.formModalShown||r.updating||(r.record[r.currentLookupField.name]=r.recordState[r.currentLookupField.name],r.$broadcast("angucomplete-alt:changeInput",r.currentLookupField.name,r.recordState[r.currentLookupField.name]),delete r.editLookup[r.currentLookupField.name])},200)},r.getAttachments=function(){o.hasDocumentsPermission(r.operations.read)&&w.getEntityDocuments(e.workgroup.tenant_id,r.id,r.module.id).then(function(t){r.documentsResultSet=w.processDocuments(t.data,e.users),r.documents=r.documentsResultSet.documentList,r.loadingDocuments=!1})},r.getAttachments(),r.showActivityButtons=function(){r.activityButtonsPopover=r.activityButtonsPopover||$popover(angular.element(document.getElementById("activityButtons")),{templateUrl:"view/common/newactivity.html",placement:"bottom",autoClose:!0,scope:r,show:!0})},r.getCurrentTime=function(){var e=new Date;return e.getTime()},r.openExportDialog=function(){r.pdfCreating=!0;var o=function(){r.PdfModal=r.PdfModal||$modal({scope:r,templateUrl:"view/app/module/modulePdfModal.html",animation:"",backdrop:"static",show:!1}),r.PdfModal.$promise.then(r.PdfModal.show)};r.quoteTemplates&&(o(),r.quoteTemplate=r.quoteTemplates[0]),k.getTemplates(r.module.name,"module").then(function(a){if(0==a.data.length)S.warning(e.preview?t("translate")("Setup.Templates.TemplateDefined"):t("translate")("Setup.Templates.TemplateNotFound")),r.pdfCreating=!1;else{var n=a.data;r.quoteTemplates=t("filter")(n,{active:!0},!0),r.isShownWarning=!0;for(var i=0;i<r.quoteTemplates.length;i++){var l=r.quoteTemplates[i];if(l.permissions.length>0){var s=t("filter")(l.permissions,{profile_id:e.user.profile.id},!0)[0];l.isShown="none"===s.type?!1:!0,1==l.isShown&&(r.isShownWarning=!1)}else l.isShown=!0,r.isShownWarning=!1}r.quoteTemplate=r.quoteTemplates[0],r.PdfModal=r.PdfModal||$modal({scope:r,templateUrl:"view/app/module/modulePdfModal.html",animation:"",backdrop:"static",show:!1}),o()}})["catch"](function(){r.pdfCreating=!1})},r.getDownloadUrl=function(o){s.open("/attach/export?module="+r.type+"&id="+r.id+"&templateId="+r.quoteTemplate.id+"&access_token="+d.read("access_token")+"&format="+o+"&locale="+e.locale+"&timezoneOffset="+-1*(new Date).getTimezoneOffset(),"_blank"),S.success(t("translate")("Module.ExcelDesktop"))},r.openAddModal=function(e){r.selectedRelatedModule=e,r.selectedRelatedModule.relatedModuleInModal=!0},r.showEMailModal=function(r,t){if(!e.system.messaging.SystemEMail&&!e.system.messaging.PersonalEMail){var o="mailto:"+t,a=s.open(o,"_blank");return void(a.document.title="Ofisim.com")}},r.showQuoteEMailModal=function(e){if(!e){var t=angular.element(document.body);b.show({parent:t,templateUrl:"view/app/email/singleEmailModal.html",clickOutsideToClose:!1,scope:r,preserveScope:!0})}},r.showSingleSMSModal=function(){if(!e.system.messaging.SMS)return void S.warning(t("translate")("SMS.NoProvider"));var o=angular.element(document.body);b.show({parent:o,templateUrl:"view/app/sms/singleSMSModal.html",clickOutsideToClose:!1,scope:r,preserveScope:!0})},r.showModuleFrameModal=function(e){if(new RegExp("https:").test(e)){var t,o,a;t="myPop1",o=document.body.offsetWidth-200,a=document.body.offsetHeight-200;var n=screen.width/2-o/2,i=screen.height/2-a/2;window.open(e,t,"toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=no, copyhistory=no, width="+o+", height="+a+", top="+i+", left="+n)}else r.frameUrl=e,r.frameModal=r.frameModal||$modal({scope:r,controller:"ActionButtonFrameController",templateUrl:"view/app/actionbutton/actionButtonFrameModal.html",backdrop:"static",show:!1}),r.frameModal.$promise.then(r.frameModal.show)},r.dropdownHide=function(){angular.element(document.getElementsByClassName("dropdown-menu"))[0].click(),angular.element(document.getElementsByClassName("dropdown-menu"))[1].click()},r.documentDownload=function(e){s.location="/storage/record_file_download?fileName="+e},r.getmoduledownloadurl=function(e,t){return e?m.apiUrl+"Document/download_module_document?module="+r.module.name+"&fileNameExt="+o.getFileExtension(e)+"&fileName="+e+"&fieldName="+t+"&recordId="+r.record.id+"&access_token="+d.read("access_token"):void 0},r.showLightBox=function(e){r.lightBox=!0,r.ImageUrl=e},r.closeLightBox=function(){r.lightBox=!1},r.openLocationModal=function(e){r.filedName=e,r.locationModal=r.frameModal||$modal({scope:r,controller:"locationFormModalController",templateUrl:"view/app/location/locationFormModal.html",backdrop:"static",show:!1}),r.locationModal.$promise.then(r.locationModal.show)},r.webhookRequest=function(o){var o=angular.copy(o),a=new XMLHttpRequest;a.onreadystatechange=function(){4==this.readyState&&(_(function(){r.webhookRequesting[o.id]=!1}),200==this.status?S.success(t("translate")("Module.ActionButtonWebhookSuccess")):S.warning(t("translate")("Module.ActionButtonWebhookFail")))};var n={},i=[],l=o.parameters.split(","),s=o.headers.split(",");if(r.webhookRequesting={},r.webhookRequesting[o.id]=!0,angular.forEach(l,function(e){var t=e.split("|"),o=t[0],a=t[1],i=t[2];n[o]=a!=r.module.name?r.record[a]?r.record[a][i]:null:r.record[i]?r.record[i]:null}),angular.forEach(s,function(t){var o=null,a=t.split("|"),n=a[0],l=a[1],s=a[2],d=a[3],u={};switch(n){case"module":var c=d;o=l!=r.module.name?r.record[l]?r.record[l][c]:r.record[l][c]:r.record[c]?r.record[c]:null;break;case"static":switch(d){case"{:app:}":o=e.user.app_id;break;case"{:tenant:}":o=e.user.tenant_id;break;case"{:user:}":o=e.user.id;break;default:o=null}break;case"custom":o=d;break;default:o=null}u.key=s,u.value=o,i.push(u)}),"post"===o.method_type)a.open("POST",o.url,!0),o.url.indexOf(window.location.host)>-1&&a.setRequestHeader("Authorization","Bearer "+d.read("access_token")),a.setRequestHeader("Content-Type","application/json"),angular.forEach(i,function(e){a.setRequestHeader(e.key,e.value)}),a.send(JSON.stringify(n));else if("get"===o.method_type){var u="";for(var c in n)u+=c+"="+n[c]+"&";u.length>0&&(u=u.substring(0,u.length-1)),o.url+=o.url.indexOf("?")<0?"?":"&",a.open("GET",o.url+u,!0),o.url.indexOf(window.location.host)>-1&&a.setRequestHeader("Authorization","Bearer "+d.read("access_token")),angular.forEach(i,function(e){a.setRequestHeader(e.key,e.value)}),a.send()}},r.approveProcess=function(){r.executeCode=!1,P.run("BeforeApproveProcess","Script",r),r.executeCode||(r.approving=!0,k.approveProcessRequest(r.record.operation_type,r.module.name,r.record.id).then(function(e){"approved"===e.data.status?(r.isApproved=!0,r.record.freeze=!0,P.run("AfterApproveProcess","Script",r)):r.record.process_status_order++,r.approving=!1,r.waitingForApproval=!0})["catch"](function(){r.approving=!1}))},r.rejectProcess=function(e){r.executeCode=!1,P.run("BeforeRejectProcess","Script",r),r.executeCode||(r.rejecting=!0,k.rejectProcessRequest(r.record.operation_type,r.module.name,e,r.record.id).then(function(){r.isRejectedRequest=!0,r.rejecting=!1,r.record.process_status=3,r.rejectModal.hide()})["catch"](function(){r.rejecting=!1}))},r.reApproveProcess=function(){r.reapproving=!0,k.send_approval(r.record.operation_type,r.module.name,r.record.id).then(function(){r.waitingForApproval=!0,r.record.freeze=!0,r.reapproving=!1,r.record.process_status=1,r.record.process_status_order++})["catch"](function(){r.reapproving=!1})},r.openRejectApprovalModal=function(){r.rejectModal=r.rejectModal||$modal({scope:r,templateUrl:"view/app/module/rejectProcessModal.html",animation:"",backdrop:"static",show:!1,tag:"createModal"}),r.rejectModal.$promise.then(r.rejectModal.show)},r.sendToProcessApproval=function(){if(r.executeCode=!1,P.run("BeforeSendToProcessApproval","Script",r,r.record),!r.executeCode){if("izinler"===r.module.name){var e="";if(r.skipValidation||(e=k.customValidations(r.module,r.record)),""!=e)return void S.warning({content:e,timeout:8e3})}r.manuelApproveRequest=!0;var o={record_id:r.record.id,module_id:r.module.id};k.sendApprovalManuel(o).then(function(){P.run("AfterSendToProcessApproval","Script",r,r.record),r.hasManuelProcess=!1,r.waitingForApproval=!0,r.record.freeze=!0,r.manuelApproveRequest=!1,r.record.process_status=1,r.record.process_status_order++})["catch"](function(e){r.manuelApproveRequest=!1,400===e.status&&(e.data.model_state&&e.data.model_state.filters_not_match&&S.warning(t("translate")("Common.FiltersNotMatched")),e.data.model_state&&e.data.model_state.approver_not_found&&S.warning(t("translate")("Common.ApproverNotFound")))})}},r.module.relations.length>0){r.relationActionButtons=[];var U=t("filter")(r.module.relations,{deleted:!1},!0),B=function(e){e.isShown=!1,e.dependent_field?record[e.dependent_field]&&record[e.dependent_field].labelStr==e.dependent&&(e.isShown=!0):e.isShown=!0};if(U.length>0)for(var T=0;T<U.length;T++){var I=t("filter")(e.modules,{name:U[T].related_module},!0)[0];k.getActionButtons(I.id).then(function(e){if(e.length>0){var o=t("filter")(e,function(e){return"Detail"!==e.trigger&&"Form"!==e.trigger&&"List"!==e.trigger},!0);if(o)for(var a=0;a<o.length;a++){var n=o[a];n.module_name=I.name,r.relationActionButtons.push(n),B(n)}}})}}P.run("AfterDetailLoaded","script",r);var x=/\[([^\[\]]+)\]\(([^)]+)/;r.getUrlFieldText=function(e){if(!e)return e;var r=e.match(x);return r?r[1]:e},r.getUrlFieldLink=function(e){if(!e)return e;var r=e.match(x);return r?r[2]:e}}]);