"use strict";angular.module("primeapps").directive("documentList",["$filter","guidEmpty","entityTypes","helper","operations","DocumentService","$localStorage","config","$stateParams","$window","$mdDialog","mdToast","$rootScope",function(e,t,n,o,a,i,c,r,s,l,u,d,m){return{restrict:"EA",scope:{documents:"=",entityId:"=",entityType:"=",isAll:"="},templateUrl:"view/app/documents/documentList.html",controller:["$scope",function(c){c.editedDocument=null,c.documentState={},c.documentUpdating=!1,c.apiUrl=c.$root.config.apiUrl,c.guidEmpty=t,c.hasPermission=o.hasPermission,c.hasDocumentsPermission=o.hasDocumentsPermission,c.entityTypes=n,c.operations=a,c.lightBox=!1,c.type=s.type,c.module=e("filter")(c.$root.modules,{name:s.type},!0)[0],c.moduleId=c.module.id,c.blobUrl=blobUrl;var p=c.$root.workgroup.tenant_id,f=c.entityId,g=c.moduleId;c.edit=function(e){m.processLanguage(e),c.editedDocument=e,c.documentState=angular.copy(e),e.editing=!0,c.copyDesc=angular.copy(e.languages[m.globalization.Label].description),c.copyNamePlain=angular.copy(e.name_plain)},c.cancelEdit=function(){this.document=c.documentState,c.editedDocument=null},c.update=function(t){if(!c.editedDocument||!c.editedDocument.name_plain||!c.editedDocument.name_plain.trim()||h())return void(c.editedDocument=null);c.documentUpdating=!0;var n=c.editedDocument.name_plain.trim()+"."+c.editedDocument.extension;c.editedDocument.languages[m.globalization.Label].name=n,c.editedDocument.languages[m.globalization.Label].description=c.editedDocument.description,i.update(c.editedDocument.id,c.$root.workgroup.tenant_id,c.editedDocument,c.editedDocument.record_id,c.editedDocument.module_id).then(function(){c.documentUpdating=!1,c.editedDocument=null,t.name=n,t.languages[m.globalization.Label].name=n,t.languages[m.globalization.Label].description=c.editedDocument.description,d.success(e("translate")("Module.AttachUploadSuccess"))})["catch"](function(){c.documentUpdating=!1})},c.remove=function(t,n){var o=u.confirm().title(e("translate")("Common.AreYouSure")).targetEvent(t).ok(e("translate")("Common.Yes")).cancel(e("translate")("Common.No"));u.show(o).then(function(){i.remove(n).then(function(){d.success(e("translate")("Module.AttachSuccesDeleteRecordMessage")),c.isAll?i.getDocuments(p,f,g).then(function(e){m.processLanguages(e.data.documents);var t=i.processDocuments(e.data,c.$root.users);c.$parent.documents=t.documentList,c.$parent.documentsResultSet&&(c.$parent.documentsResultSet.totalDocumentCount=e.data.total_documents_count)}):i.getEntityDocuments(p,f,g).then(function(e){m.processLanguages(e.data.documents);var t=i.processDocuments(e.data,c.$root.users);c.$parent.documents=t.documentList,c.$parent.documentsResultSet.totalDocumentCount=e.data.total_documents_count})})},function(){})},c.getParentEntityName=function(t,n){var o=e("filter")(c.$root.clientData,{EntityType:t,EntityID:n})[0];return o?o.EntityName:""},c.icon=function(e){var t="fas ";switch(e){case"doc":case"docx":t+="fa-file-word";break;case"xls":case"xlsx":t+="fa-file-excel";break;case"ppt":case"pptx":t+="fa-file-powerpoint";break;case"pdf":t+="fa-file-pdf";break;case"txt":t+="fa-file-alt";break;case"bmp":case"jpeg":case"jpg":case"png":case"gif":t+="fa-file-image";break;case"zip":t+="fa-file-archive";break;case"rar":t+="fa-file-archive";break;case"eml":case"msg":t+="fa fa-envelope";break;default:t+="fa-file"}return t},c.downloadDocument=function(t){i.getDocument(t.id).then(function(n){n.data?l.open("/storage/download?fileId="+t.id,"_blank"):d.warning(e("translate")("Documents.NotFound"))})},c.getDownloadUrl=function(e){return r.apiUrl+"storage/download?fileID="+e.id},c.showLightBox=function(e,t,n){c.lightBox=!0,c.fileData=t,c.Index=n,u.show({contentElement:"#mdLightbox-doc",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:!1})},c.closeLightBox=function(){c.lightBox=!1,u.hide()};var h=function(){return c.copyNamePlain===c.editedDocument.name_plain&&c.copyDesc===c.editedDocument.description}}]}}]).directive("documentForm",["config","guidEmpty","$localStorage","$filter","$q","helper","FileUploader","resizeService","DocumentService","$timeout","$stateParams","$cookies","mdToast","$rootScope",function(e,t,n,o,a,i,c,r,s,l,u,d,m,p){return{restrict:"EA",scope:{entityId:"=",entityType:"=",isAll:"=",show:"=",hideCloseButton:"=",hideUploadButton:"=",hideAllPanel:"=",customUploader:"=",entityIdFunc:"&",moduleId:"="},templateUrl:"view/app/documents/documentForm.html",controller:["$scope","$timeout",function(e,t){function n(e){var t=a.defer(),n=new FileReader;return n.onload=function(e){t.resolve(e.target.result)},n.readAsDataURL(e),t.promise}e.documentCreating=!1;var l=e.$root.workgroup.tenant_id,d=e.entityId,f=u.type;e.module=o("filter")(e.$root.modules,{name:f},!0)[0];var g=e.module.id,h=e.uploader=e.customUploader||new c({url:"storage/upload_whole"});e.entityId||(e.$parent.$parent.uploader=e.uploader),h.onCompleteItem=function(t,n,a){if(200===a){var i=n.unique_name,c=n.chunks,r=t.file.name,u=n.content_type,p=t._file.size,f=r||"";d=d?d:e.$parent.entityIdFunc(),s.create(l,i,r,u,p,f,d,g,c).then(e.customUploader?function(){m.success(o("translate")("Module.AttachUploadSuccess"))}:function(){m.success(o("translate")("Module.AttachUploadSuccess"))})}},e.customUploader||(h.onCompleteAll=function(){t(function(){e.isAll?s.getDocuments(l,d,g).then(function(t){p.processLanguages(t.data.documents);var n=s.processDocuments(t.data,e.$root.users);e.$parent.documents=n.documentList,e.$parent.documentsResultSet.totalDocumentCount=t.data.total_documents_count}):s.getEntityDocuments(l,d,g).then(function(t){p.processLanguages(t.data.documents);var n=s.processDocuments(t.data,e.$root.users);e.$parent.documents=n.documentList,e.$parent.documentsResultSet.totalDocumentCount=t.data.total_documents_count})},2e3)}),h.onWhenAddingFileFailed=function(e,t){switch(t.name){case"docFilter":m.warning(o("translate")("Documents.FormatError"));break;case"sizeFilter":m.warning(o("translate")("Documents.SizeError"));break;case"limitFilter":m.warning(o("translate")("Documents.LimitError"))}},h.onAfterAddingFile=function(e){var t="|"+e.file.type.slice(e.file.type.lastIndexOf("/")+1)+"|";"|jpg|png|jpeg|bmp|gif".indexOf(t)>-1&&n(e._file).then(function(t){e.image=t;var n=new Image;n.onload=function(){n.width<=1024||r.resizeImage(e.image,{width:1024},function(t,n){t||(e._file=D(n),e.file.size=e._file.size)})},n.src=t})},h.filters.push({name:"docFilter",fn:function(e){var t=i.getFileExtension(e.name);if("mpp"===t)return!0;if("rar"===t)var n="|x-rar-compressed|";else if("zip"===t)var n="|zip|";else if("eml"===t)var n="|eml|";else if("msg"===t)var n="|msg|";else var n="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return"|msword|x-rar-compressed|zip|eml|msg|vnd.ms-excel|vnd.ms-powerpoint|vnd.openxmlformats-officedocument.wordprocessingml.document|vnd.openxmlformats-officedocument.wordprocessingml.template|vnd.openxmlformats-officedocument.spreadsheetml.sheet|vnd.openxmlformats-officedocument.presentationml.presentation|vnd.openxmlformats-officedocument.presentationml.template|vnd.openxmlformats-officedocument.presentationml.slideshow|rtf|pdf|plain|tiff|bmp|jpeg|jpg|png|gif|".indexOf(n)>-1}}),h.filters.push({name:"sizeFilter",fn:function(e){return e.size<10485760}});var D=function(e){for(var t=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],o=[],a=0;a<t.length;a++)o.push(t.charCodeAt(a));return new Blob([new Uint8Array(o)],{type:n})};e.close=function(){e.$parent.showDocumentForm=!e.$parent.showDocumentForm}}]}}]).directive("lightboxDirective",function(){return{restrict:"E",transclude:!0,template:"<section ng-transclude></section>"}});