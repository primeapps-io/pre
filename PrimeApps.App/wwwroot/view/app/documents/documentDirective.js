"use strict";angular.module("primeapps").directive("documentList",["$filter","guidEmpty","entityTypes","helper","operations","DocumentService","$localStorage","config","$stateParams","$window","$mdDialog","mdToast",function(e,t,n,o,a,i,r,c,s,l,u,d){return{restrict:"EA",scope:{documents:"=",entityId:"=",entityType:"=",isAll:"="},templateUrl:"view/app/documents/documentList.html",controller:["$scope",function(m){m.editedDocument=null,m.documentState={},m.documentUpdating=!1,m.apiUrl=m.$root.config.apiUrl,m.guidEmpty=t,m.hasPermission=o.hasPermission,m.hasDocumentsPermission=o.hasDocumentsPermission,m.entityTypes=n,m.operations=a,m.lightBox=!1,m.type=s.type,m.module=e("filter")(m.$root.modules,{name:s.type},!0)[0],m.moduleId=m.module.id,m.blobUrl=blobUrl;var p=m.$root.workgroup.tenant_id,f=m.entityId,g=m.moduleId;m.edit=function(e){m.editedDocument=e,m.documentState=angular.copy(e),e.editing=!0,m.copyDesc=angular.copy(e.description),m.copyNamePlain=angular.copy(e.name_plain)},m.cancelEdit=function(){this.document=m.documentState,m.editedDocument=null},m.update=function(t){if(!m.editedDocument||!m.editedDocument.name_plain||!m.editedDocument.name_plain.trim()||h())return void(m.editedDocument=null);m.documentUpdating=!0;var n=m.editedDocument.name_plain.trim()+"."+m.editedDocument.extension;i.update(m.editedDocument.id,m.$root.workgroup.tenant_id,n,m.editedDocument.description,m.editedDocument.record_id,m.editedDocument.module_id).then(function(){m.documentUpdating=!1,m.editedDocument=null,t.name=n,d.success(e("translate")("Module.AttachUploadSuccess"))})["catch"](function(){m.documentUpdating=!1})},m.remove=function(t,n){var o=u.confirm().title(e("translate")("Common.AreYouSure")).targetEvent(t).ok(e("translate")("Common.Yes")).cancel(e("translate")("Common.No"));u.show(o).then(function(){i.remove(n).then(function(){d.success(e("translate")("Module.AttachSuccesDeleteRecordMessage")),m.isAll?i.getDocuments(p,f,g).then(function(e){var t=i.processDocuments(e.data,m.$root.users);m.$parent.documents=t.documentList,m.$parent.documentsResultSet&&(m.$parent.documentsResultSet.totalDocumentCount=e.data.total_documents_count)}):i.getEntityDocuments(p,f,g).then(function(e){var t=i.processDocuments(e.data,m.$root.users);m.$parent.documents=t.documentList,m.$parent.documentsResultSet.totalDocumentCount=e.data.total_documents_count})})},function(){})},m.getParentEntityName=function(t,n){var o=e("filter")(m.$root.clientData,{EntityType:t,EntityID:n})[0];return o?o.EntityName:""},m.icon=function(e){var t="fas ";switch(e){case"doc":case"docx":t+="fa-file-word";break;case"xls":case"xlsx":t+="fa-file-excel";break;case"ppt":case"pptx":t+="fa-file-powerpoint";break;case"pdf":t+="fa-file-pdf";break;case"txt":t+="fa-file-alt";break;case"bmp":case"jpeg":case"jpg":case"png":case"gif":t+="fa-file-image";break;case"zip":t+="fa-file-archive";break;case"rar":t+="fa-file-archive";break;case"eml":case"msg":t+="fa fa-envelope";break;default:t+="fa-file"}return t},m.downloadDocument=function(t){i.getDocument(t.id).then(function(n){n.data?l.open("/storage/download?fileId="+t.id,"_blank"):d.warning(e("translate")("Documents.NotFound"))})},m.getDownloadUrl=function(e){return c.apiUrl+"storage/download?fileID="+e.id+"&access_token="+r.read("access_token")},m.showLightBox=function(e,t,n){m.lightBox=!0,m.fileData=t,m.Index=n,u.show({contentElement:"#mdLightbox-doc",parent:angular.element(document.body),targetEvent:e,clickOutsideToClose:!0,fullscreen:!1})},m.closeLightBox=function(){m.lightBox=!1,u.hide()};var h=function(){return m.copyNamePlain===m.editedDocument.name_plain&&m.copyDesc===m.editedDocument.description}}]}}]).directive("documentForm",["config","guidEmpty","$localStorage","$filter","$q","helper","FileUploader","resizeService","DocumentService","$timeout","$stateParams","$cookies","mdToast",function(e,t,n,o,a,i,r,c,s,l,u,d,m){return{restrict:"EA",scope:{entityId:"=",entityType:"=",isAll:"=",show:"=",hideCloseButton:"=",hideUploadButton:"=",hideAllPanel:"=",customUploader:"=",entityIdFunc:"&",moduleId:"="},templateUrl:"view/app/documents/documentForm.html",controller:["$scope","$timeout",function(e,t){function n(e){var t=a.defer(),n=new FileReader;return n.onload=function(e){t.resolve(e.target.result)},n.readAsDataURL(e),t.promise}e.documentCreating=!1;var l=e.$root.workgroup.tenant_id,d=e.entityId,p=u.type;e.module=o("filter")(e.$root.modules,{name:p},!0)[0];var f=e.module.id,g=e.uploader=e.customUploader||new r({url:"storage/upload_whole"});e.entityId||(e.$parent.$parent.uploader=e.uploader),g.onCompleteItem=function(t,n,a){if(200===a){var i=n.unique_name,r=n.chunks,c=t.file.name,u=n.content_type,p=t._file.size,g="";d=d?d:e.$parent.entityIdFunc(),s.create(l,i,c,u,p,g,d,f,r).then(e.customUploader?function(){m.success(o("translate")("Module.AttachUploadSuccess"))}:function(){m.success(o("translate")("Module.AttachUploadSuccess"))})}},e.customUploader||(g.onCompleteAll=function(){t(function(){e.isAll?s.getDocuments(l,d,f).then(function(t){var n=s.processDocuments(t.data,e.$root.users);e.$parent.documents=n.documentList,e.$parent.documentsResultSet.totalDocumentCount=t.data.total_documents_count}):s.getEntityDocuments(l,d,f).then(function(t){var n=s.processDocuments(t.data,e.$root.users);e.$parent.documents=n.documentList,e.$parent.documentsResultSet.totalDocumentCount=t.data.total_documents_count})},2e3)}),g.onWhenAddingFileFailed=function(e,t){switch(t.name){case"docFilter":m.warning(o("translate")("Documents.FormatError"));break;case"sizeFilter":m.warning(o("translate")("Documents.SizeError"));break;case"limitFilter":m.warning(o("translate")("Documents.LimitError"))}},g.onAfterAddingFile=function(e){var t="|"+e.file.type.slice(e.file.type.lastIndexOf("/")+1)+"|";"|jpg|png|jpeg|bmp|gif".indexOf(t)>-1&&n(e._file).then(function(t){e.image=t;var n=new Image;n.onload=function(){n.width<=1024||c.resizeImage(e.image,{width:1024},function(t,n){t||(e._file=h(n),e.file.size=e._file.size)})},n.src=t})},g.filters.push({name:"docFilter",fn:function(e){var t=i.getFileExtension(e.name);if("mpp"===t)return!0;if("rar"===t)var n="|x-rar-compressed|";else if("zip"===t)var n="|zip|";else if("eml"===t)var n="|eml|";else if("msg"===t)var n="|msg|";else var n="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return"|msword|x-rar-compressed|zip|eml|msg|vnd.ms-excel|vnd.ms-powerpoint|vnd.openxmlformats-officedocument.wordprocessingml.document|vnd.openxmlformats-officedocument.wordprocessingml.template|vnd.openxmlformats-officedocument.spreadsheetml.sheet|vnd.openxmlformats-officedocument.presentationml.presentation|vnd.openxmlformats-officedocument.presentationml.template|vnd.openxmlformats-officedocument.presentationml.slideshow|rtf|pdf|plain|tiff|bmp|jpeg|jpg|png|gif|".indexOf(n)>-1}}),g.filters.push({name:"sizeFilter",fn:function(e){return e.size<10485760}});var h=function(e){for(var t=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],o=[],a=0;a<t.length;a++)o.push(t.charCodeAt(a));return new Blob([new Uint8Array(o)],{type:n})};e.close=function(){e.$parent.showDocumentForm=!e.$parent.showDocumentForm}}]}}]).directive("lightboxDirective",function(){return{restrict:"E",transclude:!0,template:"<section ng-transclude></section>"}});