"use strict";angular.module("primeapps").controller("AuditLogController",["$rootScope","$scope","config","$filter","AuditLogService","$sce","mdToast","$state","helper","AppService",function(e,t,a,d,r,i,o,n,l,s){t.loading=!0,s.checkPermission().then(function(a){function l(e){return'<td class="hide-on-m2"><span>{{dataItem.created_by.full_name}}</span></td><td class="hide-on-m2"><span>{{dataItem.module.label_'+t.language+'_plural}}</span></td><td class="hide-on-m2"><span>'+t.getAction(e.record_action_type||e.setup_action_type)+'</span></td><td class="hide-on-m2">'+t.getRelatedRecord(e)+'</td><td class="hide-on-m2"><span>'+t.getTime(e.created_at)+'</span></td><td class="show-on-m2"><div>'+d("translate")("Setup.AuditLog.Date")+": <strong>"+t.getTime(e.created_at)+"</strong></div><div>"+d("translate")("Setup.AuditLog.User")+": <strong>{{dataItem.created_by.full_name}}</strong></div><div>"+d("translate")("Common.Module")+": <strong>{{dataItem.module.label_"+t.language+"_plural}}</strong></div><div>"+d("translate")("Setup.AuditLog.RelatedRecord")+": <strong>"+t.getRelatedRecord(e)+"</strong></div><div>"+d("translate")("Setup.AuditLog.ActionType")+": <strong>"+t.getAction(e.record_action_type||e.setup_action_type)+"</strong></div></td>"}if(a&&a.data){var s=JSON.parse(a.data.profile),u=void 0;if(a.data.customProfilePermissions&&(u=JSON.parse(a.data.customProfilePermissions)),!s.HasAdminRights){var p=void 0;u&&(p=u.permissions.indexOf("audit_log")>-1),p||(o.error(d("translate")("Common.Forbidden")),n.go("app.dashboard"))}}e.breadcrumblist=[{title:d("translate")("Layout.Menu.Dashboard"),link:"#/app/dashboard"},{title:d("translate")("Setup.Nav.Data"),link:"#/app/setup/importhistory"},{title:d("translate")("Setup.Nav.Tabs.AuditLog")}],t.allModules||r.getDeletedModules().then(function(a){t.allModules=e.modules.concat(a.data)}),t.getTime=function(e){return kendo.toString(kendo.parseDate(e),"g")},t.getAction=function(e){return e.indexOf("module_")>-1&&(e=e.replace("module_","")),e.charAt(0).toUpperCase()+e.slice(1)},t.getRelatedRecord=function(e){var t="";return"record"===e.audit_type&&"deleted"!==e.record_action_type?t='<div class="grid-list-button"> <span>{{dataItem.record_name}}</span><a href="#/app/record/{{dataItem.module.name}}?id={{dataItem.record_id}}"><i class= "fas fa-external-link-alt"></i></a> </div>':("deleted"===e.record_action_type||"setup"===e.audit_type)&&(t='<div class="grid-list-button"> <span>{{dataItem.record_name}}</span></div>'),i.trustAsHtml(t)};var c=function(){var a=new kendo.data.DataSource({type:"odata-v4",page:1,pageSize:10,serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:{url:"/api/data/find_audit_logs",type:"GET",dataType:"json",beforeSend:e.beforeSend(),data:{}}},schema:{data:"items",total:"count",parse:function(e){return e.items=r.process(e.items,t.allModules),e},model:{id:"id",fields:{CreatedAt:{type:"date"},RecordActionType:{type:"enums"}}}}});t.gridOptions={dataSource:a,scrollable:!1,persistSelection:!0,noRecords:!0,sortable:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100],buttonCount:5,info:!0},filterable:!0,filter:function(e){if(e.filter&&"RecordActionType"!==e.field)for(var t=0;t<e.filter.filters.length;t++)e.filter.filters[t].ignoreCase=!0},rowTemplate:function(e){return"<tr>"+l(e)+"</tr>"},altRowTemplate:function(e){return'<tr class="k-alt">'+l(e)+"</tr>"},columns:[{field:"CreatedBy.FullName",title:d("translate")("Setup.AuditLog.User"),media:"(min-width: 575px)"},{field:"Module.Label"+t.language+"plural",title:d("translate")("Common.Module"),media:"(min-width: 575px)"},{field:"RecordActionType",title:d("translate")("Setup.AuditLog.ActionType"),values:[{text:"Inserted",value:"Inserted"},{text:"Updated",value:"Updated"},{text:"Deleted",value:"Deleted"}],media:"(min-width: 575px)"},{field:"RecordName",title:d("translate")("Setup.AuditLog.RelatedRecord"),media:"(min-width: 575px)"},{field:"CreatedAt",title:d("translate")("Setup.AuditLog.Date"),filterable:{ui:function(e){e.kendoDateTimePicker({format:"{0: dd-MM-yyyy  hh:mm}"})}},media:"(min-width: 575px)"}]},a.fetch(function(){t.loading=!1,e.isMobile()||$(".k-pager-wrap").removeClass("k-pager-sm")})};angular.element(document).ready(function(){c()})})}]);