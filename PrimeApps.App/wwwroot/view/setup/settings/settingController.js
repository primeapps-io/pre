"use strict";angular.module("primeapps").controller("SettingController",["$rootScope","$scope","$localStorage","$window","$timeout","$filter","blockUI","FileUploader","SettingService","EmailService","AppService","AuthService","$cookies","$state","officeHelper","mdToast","$mdDialog",function(e,a,t,n,r,l,s,o,i,u,d,c,p,m,g,f,h){function S(){a.userModel={},a.userModel.first_name=e.user.first_name,a.userModel.last_name=e.user.last_name,a.userModel.email=e.user.email,a.userModel.phone=e.user.phone,a.userModel.picture=e.user.picture,e.processLanguage(e.user.profile),a.userModel.profileName=e.getLanguageValue(e.user.profile.languages,"name"),a.copyUserModel=angular.copy(a.userModel);var t=document.getElementsByTagName("title")[0];a.userModel.appName=t.textContent}function M(){c.logoutComplete(),window.location="/logout"}function v(e){const a=l("filter")(w,function(a){return a.Culture.contains(e+"-")},!0)[0];return a?a.Culture:""}a.activeTabHeaderTitle=l("translate")("Setup.Nav.PersonalSettings"),a.activeTab=m.params.tab?m.params.tab:"email",("general"===a.activeTab||"security"===a.activeTab)&&(f.warning(l("translate")("Common.NotFound")),m.go("app.dashboard")),a.tempPicture=e.user.picture?blobUrl+"/"+angular.copy(e.user.picture):null,a.disablePasswordChange=disablePasswordChange;const w=l("filter")(e.globalizations,{Status:1},!0);e.breadcrumblist=[{title:l("translate")("Layout.Menu.Dashboard"),link:"#/app/dashboard"},{title:l("translate")("Setup.Nav.PersonalSettings"),link:"#/app/setup/settings"},{title:null}],a.loading=!1,a.loadingModal=!1,a.changedCulture=!1,a.croppedImage=null,a.formatArray=[{value:"tr",label:l("translate")("Setup.Settings.Turkey")},{value:"en",label:l("translate")("Setup.Settings.UnitedStates")}],a.changeTab=function(t){a.activeTab=t,e.breadcrumblist[2].title=l("translate")("Setup.Nav.Tabs."+t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()),m.go("app.setup.settings",{tab:t},{notify:!1})},S(),a.selectedLanguage=v(e.language),a.selectedLocale=angular.copy(e.locale),a.useUserSettings=useUserSettings,a.showPasswordControl=!1,g.officeTenantInfo().then(function(t){t.data&&t.data.email===e.user.email||(a.showPasswordControl=!0)}),a.emailModel=angular.copy(e.system.messaging.PersonalEMail),a.newSender={},a.addingNewSender=!1,null!=a.emailModel&&a.emailModel.hasOwnProperty("provider")||(a.emailModel={provider:"smtp",user_name:"",password:"",senders:[],enable_ssl:!0,dont_send_bulk_email_result:!1}),a.editUser=function(t,r){function s(){a.cancel(),o||!r?(a.userUpdating=!0,t.id=e.user.id,a.loading=!0,i.editUser(t).then(function(){e.user.first_name=t.first_name,e.user.last_name=t.last_name,e.user.email=t.email,e.user.phone=t.phone,e.user.picture=t.picture,a.tempPicture=e.user.picture?blobUrl+"/"+angular.copy(e.user.picture):null,e.userPicture=e.user.picture?blobUrl+"/"+angular.copy(e.user.picture):null,a.userUpdating=!1,a.loading=!1,a.newUserEmail="",a.croppedImage=null,a.$parent.croppedImage=null,o?(M(),f.success(l("translate")("Setup.Settings.UpdateSuccessEmail"))):f.success(l("translate")("Setup.Settings.UpdateSuccess")),a.changedCulture?n.location.reload():m.reload()})["catch"](function(){a.loading=!1,a.userForm.$submitted=!1,a.userModel=a.copyUserModel,f.error(l("translate")("Common.Error"))})):f.warning(l("translate")("Setup.Settings.EmailWarning"))}if(a.userForm.$valid){var o=!1;e.user.email!==t.email&&(o=!0),o?c.isUniqueEmail(t.email,a.user.app_id).then(function(e){return e.data&&"NotAvailable"!==e.data?void s():(r||a.userForm.$setValidity("uniqueEmail",!1),a.userModel=a.copyUserModel,a.userUpdating=!1,void f.warning(l("translate")("Setup.Settings.EmailWarning")))}):s()}},a.passwordModel={},a.changePassword=function(e){a.userForm.$valid&&(a.loading=!0,i.changePassword(e.current,e.password,e.confirm).then(function(){f.success(l("translate")("Setup.Settings.PasswordSuccess")),a.userForm.$setPristine(),a.passwordModel={},a.userForm.$setUntouched(),a.loading=!1})["catch"](function(e){400===e.status&&a.userForm.current.$setValidity("wrongPassword",!1),a.loading=!1}))},a.passwordNotMatch=function(e,t){e!==t&&a.showError("compareTo")},a.changeLanguage=function(n){if(n){const r=n.split("-"),l=r[0];if(l===e.language)return;a.userModel.language=l,e.language=l,a.changedCulture=!0,t.write("NG_TRANSLATE_LANG_KEY",l),p.put("_lang",l)}},a.changeLocale=function(n){n!==e.locale&&(a.changedCulture=!0,a.userModel.culture="tr"===n?"tr-TR":"en-US",t.write("locale_key",n))},a.changeCurrency=function(a){i.changeCurrency(a).then(function(){e.user.currency=a,f.success(l("translate")("Setup.Settings.CurrencySuccess"))})},a.deleteAccount=function(e){s.start(),a.accountDeleting=!0,i.removeUser(e).then(function(){t.remove("access_token"),t.remove("refresh_token"),t.remove("Workgroup"),t.remove("NG_TRANSLATE_LANG_KEY"),t.remove("currency"),n.location.href="#auth/login",r(function(){n.location.reload(!0)})})["catch"](function(e){400===e.status&&f.error(l("translate")("Setup.Settings.InvalidPassword")),a.accountDeleting=!1,s.stop()})},a.showNewSenderForm=function(){a.email=null,a.alias=null;var e=angular.element(document.body);h.show({parent:e,templateUrl:"view/setup/email/senderAdd.html",clickOutsideToClose:!0,scope:a,preserveScope:!0})},a.addNewSender=function(e,t){return a.loadingModal=!0,this.senderForm.alias.$valid&&this.senderForm.email.$valid?(null===a.emailModel.senders&&(a.emailModel.senders=[]),a.emailModel.senders.push({alias:e,email:t}),a.close(),a.loadingModal=!1,void a.userForm.$setValidity("noSender",!0)):void(a.loadingModal=!1)},a.removeSender=function(e,t){var n=h.confirm().title(l("translate")("Common.AreYouSure")).targetEvent(e).ok(l("translate")("Common.Yes")).cancel(l("translate")("Common.No"));h.show(n).then(function(){if(null!==a.emailModel.senders){var e=a.emailModel.senders.indexOf(t);a.emailModel.senders.splice(e,1)}},function(){a.status="You decided to keep your debt."})},a.editEMail=function(){return a.addingNewSender?void(a.addingNewSender=!1):(0===a.emailModel.senders.length&&a.userForm.$setValidity("noSender",!1),void(a.userForm.$valid&&(a.emailUpdating=!0,a.emailModel.provider="smtp",a.emailModel.host.indexOf("yandex")>-1&&(a.emailModel.host="smtp.yandex.ru",a.emailModel.port="587",a.emailModel.enable_ssl=!0),u.updatePersonalEMailSettings(a.emailModel).then(function(){f.success(l("translate")("Setup.Settings.UpdateSuccess")),u.getSetting().then(function(a){var t=a.data;t.SystemEMail&&(t.SystemEMail.enable_ssl="True"===t.SystemEMail.enable_ssl),t.SystemEMail&&t.SystemEMail.dont_send_bulk_email_result&&(t.SystemEMail.dont_send_bulk_email_result="True"===t.SystemEMail.dont_send_bulk_email_result),t.PersonalEMail&&(t.PersonalEMail.enable_ssl="True"===t.PersonalEMail.enable_ssl),t.PersonalEMail&&t.PersonalEMail.dont_send_bulk_email_result&&(t.PersonalEMail.dont_send_bulk_email_result="True"===t.PersonalEMail.dont_send_bulk_email_result),e.system.messaging=t}),a.emailUpdating=!1}))))},a.resetEMailForm=function(){a.emailModel=angular.copy(e.system.messaging.PersonalEMail)},a.removePersonalEMailSettings=function(){u.removePersonalEMailSettings(a.emailModel).then(function(){a.emailModel=null,e.system.messaging.PersonalEMail=null})};var _=p.get(preview?"preview_app_id":"app_id"),b=p.get(preview?"preview_tenant_id":"tenant_id"),y=a.uploader=new o({url:"storage/upload_profile_picture",headers:{Authorization:"Bearer "+window.localStorage.getItem("access_token"),Accept:"application/json","Content-Type":"application/x-www-form-urlencoded;charset=utf-8","X-Tenant-Id":b,"X-App-Id":_},queueLimit:1});y.onCompleteItem=function(e,t,n){200===n&&(a.userModel.picture=t,a.croppedImage=null,a.$parent.croppedImage=null,y.clearQueue())},y.onWhenAddingFileFailed=function(e,a){switch(a.name){case"imageFilter":f.warning(l("translate")("Setup.Settings.ImageError"));break;case"sizeFilter":f.warning(l("translate")("Setup.Settings.SizeError"))}},y.onAfterAddingFile=function(e){var t=new FileReader;t.onload=function(t){a.$apply(function(){e.image=t.target.result})},t.readAsDataURL(e._file)},y.filters.push({name:"imageFilter",fn:function(e){var a="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|".indexOf(a)>-1}}),y.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}});var E=function(e){for(var a=atob(e.split(",")[1]),t=e.split(",")[0].split(":")[1].split(";")[0],n=[],r=0;r<a.length;r++)n.push(a.charCodeAt(r));return new Blob([new Uint8Array(n)],{type:t})};a.removeProfileImage=function(){a.tempPicture=null,a.croppedImage=null,a.$parent.croppedImage=null,a.userModel.id=e.user.id,a.userModel.picture=null},a.submitGeneral=function(){if(!a.userForm.$valid)return void f.error(l("translate")("Module.RequiredError"));switch(a.activeTab){case"general":a.editUser(a.userModel);break;case"security":a.changePassword(a.passwordModel);break;case"email":a.editEMail(a.emailModel)}},a.close=function(){h.hide()},a.languageOptions={dataSource:w,dataTextField:"Language",dataValueField:"Culture",filter:w>10?"startswith":null,optionLabel:l("translate")("Common.Select"),change:function(){return a.changeLanguage(this.value())}},a.formatOptions={dataSource:a.formatArray,dataTextField:"label",dataValueField:"value",change:function(){return a.changeLanguage(this.value())}},a.changeEmailModal=function(){var e=angular.element(document.body);h.show({parent:e,templateUrl:"view/setup/settings/pages/changeEmail.html",clickOutsideToClose:!0,scope:a,preserveScope:!0})},a.changeEmail=function(e){return e.validate()?(a.userModel.email=a.newUserEmail,void a.editUser(a.userModel,!0)):void f.error(l("translate")("Module.RequiredError"))},a.cancel=function(){h.cancel()},a.showError=function(e){switch(e){case"compareTo":f.error(l("translate")("Setup.Settings.PasswordNotMatch"));break;case"minlength":f.error(l("translate")("Setup.Settings.PasswordMinimum"));break;case"wrongPassword":f.error(l("translate")("Setup.Settings.PasswordWrong"))}},a.uploadFunc=function(e,a){e._file=E(a),e.upload()}}]);