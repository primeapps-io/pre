"use strict";angular.module("primeapps").controller("SettingController",["$rootScope","$scope","$translate","tmhDynamicLocale","$localStorage","ngToast","config","$window","$timeout","$filter","blockUI","FileUploader","SettingService","MessagingService","AppService","AuthService","ngTableParams","$popover","$cookies","$state","officeHelper",function(e,a,n,t,s,r,o,l,i,c,d,u,m,g,p,f,h,S,w,M,v){a.userModel={},a.userModel.first_name=e.user.first_name,a.userModel.last_name=e.user.last_name,a.userModel.email=e.user.email,a.userModel.phone=e.user.phone,a.selectedLanguage=angular.copy(e.language),a.selectedLocale=angular.copy(e.locale),a.multiLanguage=multiLanguage,a.showPasswordControl=!1,v.officeTenantInfo().then(function(n){n.data&&n.data.email===e.user.email||(a.showPasswordControl=!0)}),a.emailModel=angular.copy(e.system.messaging.PersonalEMail),a.newSender={},a.addingNewSender=!1,null!=a.emailModel&&a.emailModel.hasOwnProperty("provider")||(a.emailModel={provider:"",user_name:"",password:"",senders:[],enable_ssl:!1}),a.tableParams=new h({page:1,count:10},{total:0,getData:function(e,n){a.emailModel.senders&&(n.total(a.emailModel.senders.length),e.resolve(a.emailModel.senders.slice((n.page()-1)*n.count(),n.page()*n.count())))},$scope:a}),a.tableParams.reload(),a.editUser=function(n){function t(){a.userUpdating=!0,n.id=e.user.id,m.editUser(n).then(function(){e.user.first_name=n.first_name,e.user.last_name=n.last_name,e.user.email=n.email,e.user.phone=n.phone,a.userUpdating=!1,r.create(s?{content:c("translate")("Setup.Settings.UpdateSuccessEmail"),className:"success",timeout:6e3}:{content:c("translate")("Setup.Settings.UpdateSuccess"),className:"success"})})["catch"](function(){a.userUpdating=!1})}if(a.userForm.$valid){var s=!1;e.user.email!==n.email&&(s=!0),s?f.isUniqueEmail(n.email).then(function(e){return e.data?void t():(a.userForm.$setValidity("uniqueEmail",!1),void(a.userUpdating=!1))}):t()}},a.changePassword=function(e){a.passwordForm.$valid&&(a.passwordUpdating=!0,m.changePassword(e.current,e.password,e.confirm).then(function(){e.current=null,e.password=null,e.confirm=null,a.passwordForm.current.$setPristine(),a.passwordForm.password.$setPristine(),a.passwordForm.confirm.$setPristine(),a.passwordForm.$setPristine(),a.passwordUpdating=!1,r.create({content:c("translate")("Setup.Settings.PasswordSuccess"),className:"success"})})["catch"](function(e){400===e.status&&a.passwordForm.current.$setValidity("wrongPassword",!1),a.passwordUpdating=!1}))},a.changeLanguage=function(){a.selectedLanguage!==e.language&&(d.start(),s.write("NG_TRANSLATE_LANG_KEY",a.selectedLanguage),w.put("_lang",a.selectedLanguage),l.location.reload())},a.changeLocale=function(){a.selectedLocale!==e.locale&&(d.start(),s.write("locale_key",a.selectedLocale),l.location.reload())},a.changeCurrency=function(a){m.changeCurrency(a).then(function(){e.user.currency=a,r.create({content:c("translate")("Setup.Settings.CurrencySuccess"),className:"success"})})},a.deleteAccount=function(e){d.start(),a.accountDeleting=!0,m.removeUser(e).then(function(){s.remove("access_token"),s.remove("refresh_token"),s.remove("Workgroup"),s.remove("NG_TRANSLATE_LANG_KEY"),s.remove("currency"),l.location.href="#auth/login",i(function(){l.location.reload(!0)})})["catch"](function(e){400===e.status&&r.create({content:c("translate")("Setup.Settings.InvalidPassword"),className:"danger",timeout:6e3}),a.accountDeleting=!1,d.stop()})},a.showNewSenderForm=function(){a.senderPopover=a.senderPopover||S(angular.element(document.getElementsByName("addSender")),{templateUrl:"view/setup/messaging/senderAdd.html",placement:"left",scope:a,autoClose:!0,show:!0})},a.addNewSender=function(e,n){a.addingNewSender=!0,this.senderForm.alias.$valid&&this.senderForm.email.$valid&&(null===a.emailModel.senders&&(a.emailModel.senders=[]),a.emailModel.senders.push({alias:e,email:n}),a.senderPopover.hide(),a.tableParams.reload(),a.emailForm.$setValidity("noSender",!0))},a.removeSender=function(e){if(null!==a.emailModel.senders){var n=a.emailModel.senders.indexOf(e);a.emailModel.senders.splice(n,1),a.tableParams.reload()}},a.editEMail=function(){return a.addingNewSender?void(a.addingNewSender=!1):(0===a.emailModel.senders.length&&a.emailForm.$setValidity("noSender",!1),void(a.emailForm.$valid&&(a.emailUpdating=!0,a.emailModel.host.indexOf("yandex")>-1&&(a.emailModel.host="smtp.yandex.ru",a.emailModel.port="587",a.emailModel.enable_ssl=!0),g.updatePersonalEMailSettings(a.emailModel).then(function(){r.create({content:c("translate")("Setup.Settings.UpdateSuccess"),className:"success"}),g.getSetting().then(function(a){var n=a.data;n.SystemEMail&&(n.SystemEMail.enable_ssl="True"===n.SystemEMail.enable_ssl),n.PersonalEMail&&(n.PersonalEMail.enable_ssl="True"===n.PersonalEMail.enable_ssl),e.system.messaging=n}),a.emailUpdating=!1}))))},a.resetEMailForm=function(){a.emailModel=angular.copy(e.system.messaging.PersonalEMail)},a.removePersonalEMailSettings=function(){g.removePersonalEMailSettings(a.emailModel).then(function(){a.emailModel=null,e.system.messaging.PersonalEMail=null})};var y=w.get("app_id"),_=w.get("tenant_id"),P=a.uploader=new u({url:"storage/upload_profile_picture",headers:{Authorization:"Bearer "+window.localStorage.getItem("access_token"),Accept:"application/json","X-Tenant-Id":_,"X-App-Id":y},queueLimit:1});P.onCompleteItem=function(a,n,t){if(200===t){var s=angular.copy(e.user);s.picture=o.storage_host+n,m.editUser(s).then(function(){P.clearQueue(),p.getMyAccount(!0)})}},P.onWhenAddingFileFailed=function(e,a){switch(a.name){case"imageFilter":r.create({content:c("translate")("Setup.Settings.ImageError"),className:"warning"});break;case"sizeFilter":r.create({content:c("translate")("Setup.Settings.SizeError"),className:"warning"})}},P.onAfterAddingFile=function(e){a.croppedImage="";var n=new FileReader;n.onload=function(n){a.$apply(function(){e.image=n.target.result})},n.readAsDataURL(e._file)},P.onBeforeUploadItem=function(e){e._file=$(a.croppedImage)},P.filters.push({name:"imageFilter",fn:function(e){var a="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return"|jpg|png|jpeg|bmp|".indexOf(a)>-1}}),P.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}});var $=function(e){for(var a=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],t=[],s=0;s<a.length;s++)t.push(a.charCodeAt(s));return new Blob([new Uint8Array(t)],{type:n})};a.themes=m.getThemes(),a.setThemeColor=function(n){a.selectedTheme=n.name,e.theme=n.name},a.removeProfileImage=function(){var n=a.userModel;n.id=e.user.id,n.picture="",m.editUser(n).then(function(){e.user.picture=null,M.reload()})}}]);