"use strict";angular.module("primeapps").controller("UserController",["$rootScope","$scope","$filter","$state","ngToast","guidEmpty","$popover","helper","UserService","WorkgroupService","AppService","ProfileService","RoleService","LicenseService","$q","officeHelper",function(e,t,s,r,i,a,o,n,l,c,d,u,f,m,p){function h(){var r=[];r.push(l.getAllUser()),r.push(u.getAll()),r.push(f.getAll()),r.push(m.getUserLicenseStatus()),p.all(r).then(function(r){var i=r[0].data,a=r[1].data,o=r[2].data,n=r[3].data;e.workgroup.users=i,t.profiles=u.getProfiles(a,e.workgroup.tenant_id,!0),e.user.profile.has_admin_rights||(t.profiles=s("filter")(t.profiles,{has_admin_rights:!1},!0)),t.roles=o,t.users=l.getUsers(i,t.profiles,t.roles);var c=s("filter")(t.users,{is_admin:!0},!0)[0],d=s("filter")(t.users,{is_subscriber:!0},!0)[0];c&&(c.show_account_owner=e.showAccountOwner?JSON.parse(e.showAccountOwner.value):!0),d&&(d.show_subscriber=e.showSubscriber?JSON.parse(e.showSubscriber.value):!0),t.licensesBought=n.total||0,t.licensesUsed=n.used||0,t.licenseAvailable=t.licensesBought-t.licensesUsed,t.loading=!1})}t.hasAdminRight=s("filter")(e.profiles,{id:e.user.profile.id},!0)[0].has_admin_rights,t.hasAdminRight||n.hasCustomProfilePermission("users")||(i.create({content:s("translate")("Common.Forbidden"),className:"warning"}),r.go("app.dashboard")),t.loading=!0,t.isOfficeConnected=!1,t.officeUserReady=!1,t.officeUsers=null,t.selectedOfficeUser={},t.addUserModel={},t.addUserForm=!0,t.submitting=!1,t.hideSendEmailToUser=!1,t.officeUserChanged=function(e){t.addUserModel.email=e.email,t.addUserModel.phone=e.phone,t.addUserModel.fullName=e.fullName,t.addUserModel.firstName=e.name,t.addUserModel.lastName=e.surname},t.sendOfficeUserPassword=function(){var r="crm";switch(e.user.appId){case 2:r="kobi";break;case 3:r="asistan";break;case 4:r="ik";break;case 5:r="cagri";break;default:r="crm"}t.submitting=!0;var a={};a.full_name=t.addedUser.fullName,a.password=t.userPassword,a.email=t.addedUser.email,l.sendPasswordToOfficeUser(a).then(function(){t.closeUserInfoPopover(),i.create({content:s("translate")("Setup.Office.SendEmailSuccess"),className:"success",timeout:5e3})})["catch"](function(){t.closeUserInfoPopover(),i.create({content:s("translate")("Setup.Office.SendEmailError"),className:"danger",timeout:5e3})})},t.closeUserInfoPopover=function(){t.submitting=!1,t.addUserForm=!0,t.userPassword=null,t.hideSendEmailToUser=!1,t.createOfficePopover?t.createOfficePopover.hide():t.createPopover&&t.createPopover.hide(),t.addedUser={}},h(),t.showCreateForm=function(){t.addedUser={},t.addUserForm=!0,t.createPopover=t.createPopover||o(angular.element(document.getElementById("createButton")),{templateUrl:"view/setup/users/userCreate.html",placement:"bottom-right",scope:t,autoClose:!0,show:!0})},t.showOfficeUserCreateForm=function(){t.addedUser={},t.addUserForm=!0,t.createOfficePopover=t.createOfficePopover||o(angular.element(document.getElementById("officeCreateButton")),{templateUrl:"view/setup/users/officeUserCreate.html",placement:"bottom-right",scope:t,autoClose:!0,show:!0})},t.addUser=function(e){e&&e.email&&e.profile&&e.role&&e.firstName&&e.lastName&&(e.fullName||(e.fullName=e.firstName+" "+e.lastName),t.userInviting=!0,e.profileId=e.profile,e.roleId=e.role,t.addedUser=angular.copy(e),e=n.SnakeToCamel(e),l.addUser(e).then(function(e){e.data&&(h(),t.userInviting=!1,i.create({content:s("translate")("Setup.Users.NewUserSuccess"),className:"success"}),t.userPassword=e.data.password,t.hideSendEmailToUser=e.data.password.contains("***"),t.addUserForm=!1,t.addUserModel={})})["catch"](function(e){t.userInviting=!1,409===e.status&&i.create({content:s("translate")("Setup.Users.NewUserError"),className:"warning"})}))},t.showEditForm=function(e){t.selectedUser=e,t.editModel={},t.editModel.profile=e.profile.id,t.editModel.role=e.role.id,t.editModel.activeDirectoryEmail=e.activeDirectoryEmail,t.userHaveActiveDirectoryEmail=null!==e.activeDirectoryEmail&&"null"!==e.activeDirectoryEmail&&""!==e.activeDirectoryEmail,t.editModelState=angular.copy(t.editModel),t["editPopover"+e.id]=t["editPopover"+e.id]||o(angular.element(document.getElementById("editButton"+e.id)),{templateUrl:"view/setup/users/userEdit.html",placement:"left",scope:t,autoClose:!0,show:!0})},t.edit=function(){if(t.userEditing=!0,t.editModel.profile===t.editModelState.profile&&t.editModel.role===t.editModelState.role&&t.editModel.activeDirectoryEmail===t.editModelState.activeDirectoryEmail)return t.userEditing=!1,void t.popover.hide();var r=function(){h(),t.userEditing=!1,t.popover.hide(),i.create({content:s("translate")("Setup.Users.EditSuccess"),className:"success"})},a=function(){l.updateActiveDirectoryEmail(t.selectedUser.id,t.editModel.activeDirectoryEmail).then(function(){r()})["catch"](function(e){t.userEditing=!1,409===e.status&&i.create({content:s("translate")("Setup.Users.NewUserError"),className:"warning"})})};u.changeUserProfile(t.selectedUser.id,e.workgroup.tenant_id,t.editModel.profile).then(function(){f.updateUserRole(t.selectedUser.id,t.editModel.role).then(function(){null===t.editModel.activeDirectoryEmail&&""===t.editModel.activeDirectoryEmail||t.editModel.activeDirectoryEmail===t.editModelState.activeDirectoryEmail?r():a()})["catch"](function(){t.userEditing=!1})})["catch"](function(){t.userEditing=!1})},t.dismiss=function(r,a,o){t.userDeleting=!0,l.dismiss(r,e.workgroup.tenant_id).then(function(){t.users.splice(a,1),t.userDeleting=!1,i.create({content:s("translate")("Setup.Users.DismissSuccess"),className:"success"}),d.getMyAccount(!0),m.getUserLicenseStatus().then(function(e){t.licensesBought=e.data.total||0,t.licensesUsed=e.data.used||0,t.licenseAvailable=t.licensesBought-t.licensesUsed}),o()})["catch"](function(){t.userDeleting=!1,o()})},t.gotoLicencePage=function(){var e=s("filter")(t.$parent.menuItems,{link:"#/app/setup/license"})[0];t.$parent.selectMenuItem(e),r.go("app.setup.license")}}]);