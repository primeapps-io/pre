"use strict";angular.module("primeapps").controller("UserController",["$rootScope","$scope","$filter","$state","guidEmpty","helper","UserService","WorkgroupService","AppService","ProfileService","RoleService","LicenseService","$q","officeHelper","$localStorage","mdToast","$mdDialog",function(e,t,a,s,r,i,n,o,d,l,c,u,p,m,f,g,U){d.checkPermission().then(function(r){function o(){var s=[];s.push(l.getAll()),s.push(c.getAll()),p.all(s).then(function(s){var r=s[0].data;t.roles=angular.copy(s[1].data),t.profiles=l.getProfiles(r,e.workgroup.tenant_id,!0),e.user.profile.has_admin_rights||(t.profiles=a("filter")(t.profiles,{has_admin_rights:!1},!0)),S()})}if(r&&r.data){var u=JSON.parse(r.data.profile),m=void 0;if(r.data.customProfilePermissions&&(m=JSON.parse(r.data.customProfilePermissions)),!u.HasAdminRights){var f=void 0;m&&(f=m.permissions.indexOf("users")>-1),f||s.go("app.setup.usergroups")}}e.breadcrumblist=[{title:a("translate")("Layout.Menu.Dashboard"),link:"#/app/dashboard"},{title:a("translate")("Setup.Nav.Users"),link:"#/app/setup/users"},{title:a("translate")("Setup.Nav.Tabs.Users")}],t.loading=!0,t.isOfficeConnected=!1,t.officeUserReady=!1,t.officeUsers=null,t.selectedOfficeUser={},t.addUserModel={},t.addUserForm=!0,t.submitting=!1,t.hideSendEmailToUser=!1,t.officeUserChanged=function(e){t.addUserModel.email=e.email,t.addUserModel.phone=e.phone,t.addUserModel.full_name=e.fullName,t.addUserModel.first_bame=e.name,t.addUserModel.last_name=e.surname},t.sendOfficeUserPassword=function(){var s="crm";switch(e.user.appId){case 2:s="kobi";break;case 3:s="asistan";break;case 4:s="ik";break;case 5:s="cagri";break;default:s="crm"}t.submitting=!0;var r={};r.full_name=t.addedUser.first_name+" "+t.addedUser.last_name,r.password=t.userPassword,r.email=t.addedUser.email,n.sendPasswordToOfficeUser(r).then(function(){t.closeUserInfoPopover(),g.success({content:a("translate")("Setup.Office.SendEmailSuccess"),timeout:5e3})})["catch"](function(){t.closeUserInfoPopover(),g.error({content:a("translate")("Setup.Office.SendEmailError"),timeout:5e3})})},t.closeUserInfoPopover=function(){t.submitting=!1,t.addUserForm=!0,t.userPassword=null,t.hideSendEmailToUser=!1,e.closeSide("sideModal"),t.addedUser={},t.grid.dataSource.read()},o(),t.showCreateForm=function(){t.addedUser={},t.addUserModel={},t.addUserForm=!0,t.showSideModal()},t.showOfficeUserCreateForm=function(){t.addedUser={},t.addUserForm=!0,t.createOfficePopover=t.createOfficePopover||$popover(angular.element(document.getElementById("officeCreateButton")),{templateUrl:"view/setup/users/officeUserCreate.html",placement:"bottom-right",scope:t,autoClose:!0,show:!0})},t.addUser=function(e){if(!(e&&e.email&&e.profile&&e.role&&e.first_name&&e.last_name))return void g.error(a("translate")("Module.RequiredError"));t.loadingModal=!0;var s={};return e.id?void t.edit(e):(t.userInviting=!0,s.firstName=e.first_name,s.LastName=e.last_name,s.email=e.email,s.profileId=e.profile.id,s.roleId=e.role.id,t.addedUser=angular.copy(e),s=i.SnakeToCamel(s),void n.addUser(s).then(function(e){e.data&&(o(),t.userInviting=!1,g.success(a("translate")("Setup.Users.NewUserSuccess")),t.grid.dataSource.read(),t.loadingModal=!1,t.userPassword=e.data.password,t.hideSendEmailToUser=e.data.password.contains("***"),t.addUserForm=!1,t.addUserModel={})})["catch"](function(e){t.userInviting=!1,t.loadingModal=!1,409===e.status&&g.warning(a("translate")("Setup.Users.NewUserError"))}))},t.showEditForm=function(e){t.loadingModal=!0,t.selectedUser=angular.copy(e),t.addUserModel=e,t.editModel={},t.editModel.profile=e.profile.id,t.editModel.role=e.role.id,t.editModel.activeDirectoryEmail=e.activeDirectoryEmail,t.userHaveActiveDirectoryEmail=null!==e.activeDirectoryEmail&&"null"!==e.activeDirectoryEmail&&""!==e.activeDirectoryEmail,t.editModelState=angular.copy(t.editModel),t.showSideModal()},t.edit=function(s){if(t.loadingModal=!0,t.editModel=s,t.editModel.profile===t.editModelState.profile&&t.editModel.role===t.editModelState.role&&t.editModel.activeDirectoryEmail===t.editModelState.activeDirectoryEmail)return void(t.loadingModal=!1);var r=function(){o(),t.loadingModal=!1,t.closeUserInfoPopover(),g.success(a("translate")("Setup.Users.EditSuccess"))},i=function(){n.updateActiveDirectoryEmail(t.selectedUser.id,t.editModel.activeDirectoryEmail).then(function(){r()})["catch"](function(e){t.loadingModal=!1,409===e.status&&g.warning(a("translate")("Setup.Users.NewUserError"))})};l.changeUserProfile(t.selectedUser.id,e.workgroup.tenant_id,t.editModel.profile.id).then(function(){c.updateUserRole(t.selectedUser.id,t.editModel.role.id).then(function(){null===t.editModel.activeDirectoryEmail&&""===t.editModel.activeDirectoryEmail||t.editModel.activeDirectoryEmail===t.editModelState.activeDirectoryEmail?r():i()})["catch"](function(){t.loadingModal=!1,t.userEditing=!1})})["catch"](function(){t.loadingModal=!1,t.userEditing=!1})},t.dismiss=function(s){if(s){var r=a("filter")(t.users,{id:s},!0)[0];n.dismiss(r,e.workgroup.tenant_id).then(function(){t.closeUserInfoPopover(),g.success(a("translate")("Setup.Users.DismissSuccess")),d.getMyAccount(!0)})["catch"](function(){})}},t.showConfirm=function(e,s){var r=U.confirm(a("translate")("Setup.Users.UserDeleteMessage")).title(a("translate")("Common.AreYouSure")).targetEvent(s).ok(a("translate")("Common.Yes")).cancel(a("translate")("Common.No"));U.show(r).then(function(){t.dismiss(e)},function(){})},t.showSideModal=function(){e.sideLoad=!1,e.buildToggler("sideModal","view/setup/users/userSideModal.html"),t.loadingModal=!1},t.copySuccess=function(){g.success(a("translate")("Setup.Users.PasswordCopySuccess"))},t.goUrl2=function(e){var a=window.getSelection();0===a.toString().length&&t.showEditForm(angular.copy(e))};var S=function(){var s=new kendo.data.DataSource({type:"odata-v4",page:1,pageSize:10,serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:{url:"/api/user/find_users",type:"GET",dataType:"json",beforeSend:e.beforeSend()}},schema:{data:"items",total:"count",model:{id:"id",fields:{email:{type:"string"},user_name:{type:"string"},first_name:{type:"string"},last_name:{type:"string"}}}}});t.usersGridOptions={dataSource:s,scrollable:!1,persistSelection:!0,sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100],buttonCount:5,info:!0},filterable:!0,filter:function(e){if(e.filter&&e.field!=="Role.Label"+t.language&&"Profile.Name"!==e.field)for(var a=0;a<e.filter.filters.length;a++)e.filter.filters[a].ignoreCase=!0},rowTemplate:function(e){var s='<tr ng-click="goUrl2(dataItem)">';s+='<td class="hide-on-m2"><span>{{dataItem.email}}</span></td>',s+='<td class="hide-on-m2"><span ng-if="'+e.has_account+'">'+e.user_name+"</span></td>",s+='<td class="hide-on-m2"><span>{{dataItem.profile.name}}</span></td>',s+='<td class="hide-on-m2"><span>{{dataItem.role.label_'+t.language+"}}</span></td>",s+=e.is_admin?'<td class="hide-on-m2"><span>'+a("translate")("Setup.Users.GroupOwner")+"</span></td>":e.has_account?'<td class="hide-on-m2"><span>'+a("translate")("Setup.Users.UserStatus1")+"</span></td>":'<td class="hide-on-m2"><span>'+a("translate")("Setup.Users.UserStatus2")+"</span></td>",s+='<td class="show-on-m2">';var r="<div>"+a("translate")("Setup.Users.UserEmail")+": <strong>{{dataItem.email}}</strong></div>";return r+="<div>"+a("translate")("Setup.Users.UserFullName")+': <strong ng-if="'+e.has_account+'">'+e.user_name+"</strong></div>",r+="<div>"+a("translate")("Setup.Users.Profile")+": <strong>{{dataItem.profile.name}}</strong></div>",r+="<div> "+a("translate")("Setup.Users.Role")+": <strong>{{dataItem.role.label_"+t.language+"}}</strong></div>",r+=e.is_admin?"<div> "+a("translate")("Setup.Users.UserStatus")+": <strong>"+a("translate")("Setup.Users.GroupOwner")+"</strong></div>":e.has_account?"<div> "+a("translate")("Setup.Users.UserStatus")+": <strong>"+a("translate")("Setup.Users.UserStatus1")+"</strong></div>":"<div> "+a("translate")("Setup.Users.UserStatus")+": <strong>"+a("translate")("Setup.Users.UserStatus2")+"</strong></div>",s+=r+"</td>",s+='<td ng-click="$event.stopPropagation();"><span><md-button class="md-icon-button" aria-label=" " ng-disabled="'+(e.is_admin||e.profile.has_admin_rights&&e.id===t.user.id)+'" ng-click="showConfirm('+e.id+')"><i class="fas fa-trash"></i> </md-button></span></td>',s+="</tr>"},altRowTemplate:function(e){var s='<tr class="k-alt" ng-click="goUrl2(dataItem)">';s+='<td class="hide-on-m2"><span>{{dataItem.email}}</span></td>',s+='<td class="hide-on-m2"><span ng-if="'+e.has_account+'">'+e.user_name+"</span></td>",s+='<td class="hide-on-m2"><span>{{dataItem.profile.name}}</span></td>',s+='<td class="hide-on-m2"><span>{{dataItem.role.label_'+t.language+"}}</span></td>",s+=e.is_admin?'<td class="hide-on-m2"><span>'+a("translate")("Setup.Users.GroupOwner")+"</span></td>":e.has_account?'<td class="hide-on-m2"><span>'+a("translate")("Setup.Users.UserStatus1")+"</span></td>":'<td class="hide-on-m2"><span>'+a("translate")("Setup.Users.UserStatus2")+"</span></td>",s+='<td class="show-on-m2">';var r="<div>"+a("translate")("Setup.Users.UserEmail")+": <strong>{{dataItem.email}}</strong></div>";return r+="<div>"+a("translate")("Setup.Users.UserFullName")+': <strong ng-if="'+e.has_account+'">'+e.user_name+"</strong></div>",r+="<div>"+a("translate")("Setup.Users.Profile")+": <strong>{{dataItem.profile.name}}</strong></div>",r+="<div> "+a("translate")("Setup.Users.Role")+": <strong>{{dataItem.role.label_"+t.language+"}}</strong></div>",r+=e.is_admin?"<div> "+a("translate")("Setup.Users.UserStatus")+": <strong>"+a("translate")("Setup.Users.GroupOwner")+"</strong></div>":e.has_account?"<div> "+a("translate")("Setup.Users.UserStatus")+": <strong>"+a("translate")("Setup.Users.UserStatus1")+"</strong></div>":"<div> "+a("translate")("Setup.Users.UserStatus")+": <strong>"+a("translate")("Setup.Users.UserStatus2")+"</strong></div>",s+=r+"</td>",s+='<td ng-click="$event.stopPropagation();"><span><md-button class="md-icon-button" aria-label=" " ng-disabled="'+(e.is_admin||e.profile.has_admin_rights&&e.id===t.user.id)+'" ng-click="showConfirm('+e.id+')"><i class="fas fa-trash"></i> </md-button></span></td>',s+="</tr>"},columns:[{field:"Email",title:a("translate")("Setup.Users.UserEmail"),media:"(min-width: 575px)"},{field:"UserName",title:a("translate")("Setup.Users.UserFullName"),media:"(min-width: 575px)"},{field:"Profile.Name",title:a("translate")("Setup.Users.Profile"),media:"(min-width: 575px)"},{field:"Role.Label"+t.language,title:a("translate")("Setup.Users.Role"),media:"(min-width: 575px)"},{field:"",title:a("translate")("Setup.Users.UserStatus"),filterable:!1,media:"(min-width: 575px)"},{title:"Items",media:"(max-width: 575px)"},{field:"",title:"",filterable:!1,width:"40px"}]},s.fetch(function(){t.loading=!1})};t.profileOptions={dataSource:a("orderBy")(t.profiles,"name_"+t.language),dataTextField:"name_"+t.language,dataValueField:"id"},t.roleOptions={dataSource:{transport:{read:function(e){e.success(a("orderBy")(t.roles,"label_"+t.language))}}},autoBind:!1,filter:"contains",dataTextField:"label_"+t.language,dataValueField:"id"}})}]);