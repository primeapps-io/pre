"use strict";angular.module("primeapps").controller("UserController",["$rootScope","$scope","$filter","$state","guidEmpty","helper","UserService","WorkgroupService","AppService","ProfileService","RoleService","$q","officeHelper","$localStorage","mdToast","$mdDialog",function(e,t,a,s,i,r,o,l,d,n,c,u,p,f,m,g){t.loading=!0,d.checkPermission().then(function(i){function l(){var s=[];s.push(n.getAll()),s.push(c.getAll()),u.all(s).then(function(s){var i=s[0].data;t.roles=angular.copy(s[1].data),t.profiles=n.getProfiles(i,e.workgroup.tenant_id,!0),e.user.profile.has_admin_rights||(t.profiles=a("filter")(t.profiles,{has_admin_rights:!1},!0)),v()})}if(i&&i.data){var p=JSON.parse(i.data.profile),f=void 0;if(i.data.customProfilePermissions&&(f=JSON.parse(i.data.customProfilePermissions)),!p.HasAdminRights){var h=void 0;f&&(h=f.permissions.indexOf("users")>-1),h||s.go("app.setup.usergroups")}}e.breadcrumblist=[{title:a("translate")("Layout.Menu.Dashboard"),link:"#/app/dashboard"},{title:a("translate")("Setup.Nav.Users"),link:"#/app/setup/users"},{title:a("translate")("Setup.Nav.Tabs.Users")}],t.isOfficeConnected=!1,t.officeUserReady=!1,t.officeUsers=null,t.selectedOfficeUser={},t.addUserModel={},t.addUserForm=!0,t.submitting=!1,t.hideSendEmailToUser=!1,t.selectedRows=[],t.selectedUsers=[],t.isAllSelected=!1,t.field=null,t.transferValue=null,t.officeUserChanged=function(e){t.addUserModel.email=e.email,t.addUserModel.phone=e.phone,t.addUserModel.full_name=e.fullName,t.addUserModel.first_bame=e.name,t.addUserModel.last_name=e.surname},t.sendOfficeUserPassword=function(){var s="crm";switch(e.user.appId){case 2:s="kobi";break;case 3:s="asistan";break;case 4:s="ik";break;case 5:s="cagri";break;default:s="crm"}t.submitting=!0;var i={};i.full_name=t.addedUser.first_name+" "+t.addedUser.last_name,i.password=t.userPassword,i.email=t.addedUser.email,o.sendPasswordToOfficeUser(i).then(function(){t.closeUserInfoPopover(),m.success({content:a("translate")("Setup.Office.SendEmailSuccess"),timeout:5e3})})["catch"](function(){t.closeUserInfoPopover(),m.error({content:a("translate")("Setup.Office.SendEmailError"),timeout:5e3})})},t.closeUserInfoPopover=function(){t.submitting=!1,t.addUserForm=!0,t.userPassword=null,t.hideSendEmailToUser=!1,e.closeSide("sideModal"),t.addedUser={},t.grid.dataSource.read()},l(),t.showCreateForm=function(){t.addedUser={},t.addUserModel={},t.addUserForm=!0,t.showSideModal()},t.showOfficeUserCreateForm=function(){t.addedUser={},t.addUserForm=!0,t.createOfficePopover=t.createOfficePopover||$popover(angular.element(document.getElementById("officeCreateButton")),{templateUrl:"view/setup/users/officeUserCreate.html",placement:"bottom-right",scope:t,autoClose:!0,show:!0})},t.addUser=function(s){if(!(s&&s.email&&s.profile&&s.role&&s.first_name&&s.last_name))return void m.error(a("translate")("Module.RequiredError"));t.loadingModal=!0;var i={};return s.id?void t.edit(s):(t.userInviting=!0,i.firstName=s.first_name,i.LastName=s.last_name,i.email=s.email,i.profileId=s.profile.id,i.roleId=s.role.id,t.addedUser=angular.copy(s),i=r.SnakeToCamel(i),void o.addUser(i).then(function(s){s.data&&(l(),t.userInviting=!1,m.success(a("translate")("Setup.Users.NewUserSuccess")),t.grid.dataSource.read(),t.loadingModal=!1,t.userPassword=s.data.password,t.hideSendEmailToUser=s.data.password.contains("***"),t.addUserForm=!1,t.addUserModel={}),o.getAllUser().then(function(t){e.users=t.data})})["catch"](function(e){t.userInviting=!1,t.loadingModal=!1,409===e.status&&m.warning(a("translate")("Setup.Users.NewUserError"))}))},t.showEditForm=function(e){t.addUserForm=!0,t.loadingModal=!0,t.selectedUser=angular.copy(e),t.addUserModel=e,t.editModel={},t.editModel.profile=e.profile.id,t.editModel.role=e.role.id,t.editModel.activeDirectoryEmail=e.activeDirectoryEmail,t.userHaveActiveDirectoryEmail=null!==e.activeDirectoryEmail&&"null"!==e.activeDirectoryEmail&&""!==e.activeDirectoryEmail,t.editModelState=angular.copy(t.editModel),t.showSideModal()},t.edit=function(s){if(t.loadingModal=!0,t.editModel=s,t.editModel.profile===t.editModelState.profile&&t.editModel.role===t.editModelState.role&&t.editModel.activeDirectoryEmail===t.editModelState.activeDirectoryEmail)return void(t.loadingModal=!1);var i=function(){l(),t.loadingModal=!1,t.closeUserInfoPopover(),m.success(a("translate")("Setup.Users.EditSuccess"))},r=function(){o.updateActiveDirectoryEmail(t.selectedUser.id,t.editModel.activeDirectoryEmail).then(function(){i()})["catch"](function(e){t.loadingModal=!1,409===e.status&&m.warning(a("translate")("Setup.Users.NewUserError"))})};o.updateUserStatus({email:t.editModel.email,is_active:t.addUserModel.is_active}),n.changeUserProfile(t.selectedUser.id,e.workgroup.tenant_id,t.editModel.profile.id).then(function(){c.updateUserRole(t.selectedUser.id,t.editModel.role.id).then(function(){null===t.editModel.activeDirectoryEmail&&""===t.editModel.activeDirectoryEmail||t.editModel.activeDirectoryEmail===t.editModelState.activeDirectoryEmail?i():r()})["catch"](function(){t.loadingModal=!1,t.userEditing=!1})})["catch"](function(){t.loadingModal=!1,t.userEditing=!1})},t.dismiss=function(s){if(s){var i=a("filter")(t.users,{id:s},!0)[0];o.dismiss(i,e.workgroup.tenant_id).then(function(){t.closeUserInfoPopover(),m.success(a("translate")("Setup.Users.DismissSuccess")),d.getMyAccount(!0)})["catch"](function(){})}},t.showConfirm=function(e,s){var i=g.confirm(a("translate")("Setup.Users.UserDeleteMessage")).title(a("translate")("Common.AreYouSure")).targetEvent(s).ok(a("translate")("Common.Yes")).cancel(a("translate")("Common.No"));g.show(i).then(function(){t.dismiss(e)},function(){})},t.showSideModal=function(){e.sideLoad=!1,e.buildToggler("sideModal","view/setup/users/userSideModal.html"),t.loadingModal=!1},t.copySuccess=function(){m.success(a("translate")("Setup.Users.PasswordCopySuccess"))},t.showBulkUpdate=function(e){var a=angular.element(document.body);g.show({parent:a,templateUrl:"view/setup/users/userBulkUpdateModal.html",clickOutsideToClose:!1,targetEvent:e,scope:t,preserveScope:!0})},t.updateSelected=function(s){return s.$submitted=!0,!s.$invalid&&t.field&&t.transferValue?void(!t.field||t.selectedRows.length<1||!t.transferValue||("profile"===t.field.value&&n.changeUsersProfile(t.selectedRows,e.workgroup.tenant_id,t.transferValue.id).then(function(){t.closeLightBox(),l(),t.grid.dataSource.read(),m.success(a("translate")("Setup.Users.EditsSuccess"))}),"role"===t.field.value&&c.roleChangeUsers(t.selectedRows,t.transferValue.id).then(function(){t.closeLightBox(),l(),t.grid.dataSource.read(),m.success(a("translate")("Setup.Users.EditsSuccess"))}))):void m.error(a("translate")("Module.RequiredError"))},t.deleteSelecteds=function(e){if(!t.selectedRows||!t.selectedRows.length)return void m.warning(a("translate")("Module.NoRecordSelected"));var s=g.confirm().title(a("translate")("Common.AreYouSure")).textContent(a("translate")("Setup.Users.SelectedUsersCount")+t.selectedRows.length).targetEvent(e).ok(a("translate")("Common.Yes")).cancel(a("translate")("Common.No"));g.show(s).then(function(){o.dismissUsers(t.selectedRows).then(function(){l(),t.grid.dataSource.read(),t.closeLightBox(),m.success(a("translate")("Setup.Users.DismissesSuccess"))})},function(){t.status="You decided to keep your debt."})},t.closeLightBox=function(){g.hide(),t.field=null,t.isAllSelected=!1,t.transferValue=null,t.selectedRows=[]},t.selectAll=function(e,a){if(t.selectedRows=[],t.isAllSelected){t.isAllSelected=!1;for(var s=0;s<a.length;s++)a[s].selected&&(a[s].selected=!1)}else{t.isAllSelected=!0;for(var s=0;s<a.length;s++)a[s].selected=!0,t.selectedRows.push(a[s].id)}},t.selectRow=function(e,a){return e.target.checked?(a.selected=!0,void t.selectedRows.push(a.id)):(a.selected=!1,t.selectedRows=t.selectedRows.filter(function(e){return e!==a.id}),void(t.isAllSelected=!1))},t.isRowSelected=function(e){return t.selectedRows.filter(function(t){return t===e}).length>0},t.goUrl2=function(e){var a=window.getSelection();0===a.toString().length&&t.showEditForm(angular.copy(e))};var v=function(){var s=new kendo.data.DataSource({type:"odata-v4",page:1,pageSize:10,serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:{url:"/api/user/find_users",type:"GET",dataType:"json",beforeSend:e.beforeSend()}},schema:{data:"items",total:"count",model:{id:"id",fields:{email:{type:"string"},user_name:{type:"string"},first_name:{type:"string"},last_name:{type:"string"}}}}});t.usersGridOptions={dataSource:s,scrollable:!1,persistSelection:!0,sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100],buttonCount:5,info:!0},filterable:!0,filter:function(e){if(e.filter&&e.field!=="Role.Label"+t.language&&"Profile.Name"!==e.field)for(var a=0;a<e.filter.filters.length;a++)e.filter.filters[a].ignoreCase=!0},rowTemplate:function(e){var a='<tr ng-click="goUrl2(dataItem)">';a+='<td ng-click="$event.stopPropagation();" class="position-relative"><input ng-click="selectRow($event,dataItem);$event.stopPropagation();" ng-checked="isRowSelected(dataItem.id) || dataItem.selected"  type="checkbox" id="{{dataItem.id}}" class="k-checkbox row-checkbox"><label class="k-checkbox-label" for="{{dataItem.id}}"></label></td>',a+='<td class="hide-on-m2"><span ng-if="'+e.has_account+'">'+e.user_name+"</span></td>",a+='<td class="hide-on-m2"><span>{{dataItem.email}}</span></td>',a+=e.profile?'<td class="hide-on-m2"><span>{{dataItem.profile.name_'+t.language+"}}</span></td>":'<td class="hide-on-m2"><span>-</span></td>',a+=e.role?'<td class="hide-on-m2"><span>{{dataItem.role.label_'+t.language+"}}</span></td>":'<td class="hide-on-m2"><span>-</span></td>',a+='<td class="hide-on-m2"><span>{{getStatus(dataItem.is_active)}}</span></td>',a+='<td class="show-on-m2">';var s='<div><strong ng-if="'+e.has_account+'">'+e.user_name+"</strong></div>";return s+=e.profile?'<strong class="k-info-colored paddingl5 paddingr5">{{dataItem.profile.name_'+t.language+"}}</strong> ":"<strong></strong> ",s+="<div><span>{{dataItem.email}}</span></div>",a+=s+"</td>",a+='<td ng-click="$event.stopPropagation();"><span><md-button class="md-icon-button" aria-label=" " ng-disabled="'+(e.is_admin||e.profile.has_admin_rights&&e.id===t.user.id)+'" ng-click="showConfirm('+e.id+')"><i class="fas fa-trash"></i> </md-button></span></td>',a+="</tr>"},altRowTemplate:function(e){var a='<tr class="k-alt" ng-click="goUrl2(dataItem)">';a+='<td ng-click="$event.stopPropagation();" class="position-relative"><input ng-click="selectRow($event,dataItem);$event.stopPropagation();" ng-checked="isRowSelected(dataItem.id) || dataItem.selected"  type="checkbox" id="{{dataItem.id}}" class="k-checkbox row-checkbox"><label class="k-checkbox-label" for="{{dataItem.id}}"></label></td>',a+='<td class="hide-on-m2"><span ng-if="'+e.has_account+'">'+e.user_name+"</span></td>",a+='<td class="hide-on-m2"><span>{{dataItem.email}}</span></td>',a+=e.profile?'<td class="hide-on-m2"><span>{{dataItem.profile.name_'+t.language+"}}</span></td>":'<td class="hide-on-m2"><span>-</span></td>',a+=e.role?'<td class="hide-on-m2"><span>{{dataItem.role.label_'+t.language+"}}</span></td>":'<td class="hide-on-m2"><span>-</span></td>',a+='<td class="hide-on-m2"><span>{{getStatus(dataItem.is_active)}}</span></td>',a+='<td class="show-on-m2">';var s='<div><strong ng-if="'+e.has_account+'">'+e.user_name+"</strong></div>";return s+=e.profile?'<strong class="k-info-colored paddingl5 paddingr5">{{dataItem.profile.name_'+t.language+"}}</strong> ":"<strong></strong> ",s+="<div><span>{{dataItem.email}}</span></div>",a+=s+"</td>",a+='<td ng-click="$event.stopPropagation();"><span><md-button class="md-icon-button" aria-label=" " ng-disabled="'+(e.is_admin||e.profile.has_admin_rights&&e.id===t.user.id)+'" ng-click="showConfirm('+e.id+')"><i class="fas fa-trash"></i> </md-button></span></td>',a+="</tr>"},columns:[{width:"40px",headerTemplate:"<input type='checkbox' ng-if='grid.dataSource.data().length>0' ng-checked='isAllSelected' ng-click='selectAll($event, grid.dataSource.data())' id='header-chb' class='k-checkbox header-checkbox'><label class='k-checkbox-label' for='header-chb'></label>"},{field:"UserName",title:a("translate")("Setup.Users.UserFullName"),media:"(min-width: 575px)"},{field:"Email",title:a("translate")("Setup.Users.UserEmail"),media:"(min-width: 575px)"},{field:"Profile.Name",title:a("translate")("Setup.Users.Profile"),media:"(min-width: 575px)"},{field:"Role.Label"+t.language,title:a("translate")("Setup.Users.Role"),media:"(min-width: 575px)"},{field:"",title:a("translate")("Setup.Users.UserStatus"),filterable:!1,media:"(min-width: 575px)"},{title:a("translate")("Setup.Nav.Tabs.Users"),media:"(max-width: 575px)"},{field:"",title:"",filterable:!1,width:"40px"}]},s.fetch(function(){t.loading=!1,e.isMobile()||$(".k-pager-wrap").removeClass("k-pager-sm")})};t.fieldOptions={dataSource:[{label:a("translate")("Setup.Users.Profile"),value:"profile"},{label:a("translate")("Setup.Users.Role"),value:"role"}],dataTextField:"label",dataValueField:"value"},t.profileOptions={dataSource:{transport:{read:function(e){e.success(a("orderBy")(t.profiles,"name_"+t.language))}}},filter:"contains",dataTextField:"name_"+t.language,dataValueField:"id"},t.getStatus=function(e){return a("translate")(e?"Common.Active":"Common.Deactivated")},t.roleOptions={dataSource:{transport:{read:function(e){e.success(a("orderBy")(t.roles,"label_"+t.language))}}},autoBind:!1,filter:"contains",dataTextField:"label_"+t.language,dataValueField:"id"}})}]);