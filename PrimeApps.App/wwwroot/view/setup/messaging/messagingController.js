"use strict";angular.module("primeapps").controller("MessagingController",["$rootScope","$scope","$translate","$localStorage","ngToast","config","$window","$timeout","$filter","blockUI","MessagingService","ngTableParams","$popover","AppService",function(e,s,l,a,n,t,i,o,m,d,r,u,M){s.hasAdminRight=m("filter")(e.profiles,{id:e.user.profile.id},!0)[0].has_admin_rights,s.smsModel=angular.copy(e.system.messaging.SMS),s.emailModel=angular.copy(e.system.messaging.SystemEMail),s.newSender={},s.smsEditMode=!1,s.emailEditMode=!1,null!=s.emailModel&&s.emailModel.hasOwnProperty("provider")||(s.emailModel={provider:"",user_name:"",password:"",senders:[],enable_ssl:!1,dont_send_bulk_email_result:!1}),s.tableParams=new u({page:1,count:10},{total:0,getData:function(e,l){s.emailModel.senders&&(l.total(s.emailModel.senders.length),e.resolve(s.emailModel.senders.slice((l.page()-1)*l.count(),l.page()*l.count())))},$scope:s}),s.tableParams.reload(),s.editSMS=function(){s.smsForm.$valid&&(s.smsUpdating=!0,r.updateSMSSettings(s.smsModel).then(function(){n.create({content:m("translate")("Setup.Settings.UpdateSuccess"),className:"success"}),e.system.messaging.SMS||(e.system.messaging.SMS={}),e.system.messaging.SMS.provider=s.smsModel.provider,e.system.messaging.SMS.user_name=s.smsModel.user_name,e.system.messaging.SMS.alias=s.smsModel.alias,s.smsUpdating=!1}))},s.showNewSenderForm=function(){s.senderPopover=s.senderPopover||M(angular.element(document.getElementsByName("addSender")),{templateUrl:"view/setup/messaging/senderAdd.html",placement:"left",scope:s,autoClose:!0,show:!0})},s.addNewSender=function(e,l){this.senderForm.alias.$valid&&this.senderForm.email.$valid&&(null==s.emailModel.senders&&(s.emailModel.senders=[]),s.emailModel.senders.push({alias:e,email:l}),s.senderPopover.hide(),s.tableParams.reload(),s.addNewSender=!0,s.emailForm.$setValidity("noSender",!0))},s.removeSender=function(e){if(null!=s.emailModel.senders){var l=s.emailModel.senders.indexOf(e);s.emailModel.senders.splice(l,1),s.tableParams.reload()}},s.editEMail=function(){0==s.emailModel.senders.length&&s.emailForm.$setValidity("noSender",!1),s.emailForm.$valid&&(s.emailUpdating=!0,s.emailModel.host.indexOf("yandex")>-1&&(s.emailModel.host="smtp.yandex.ru",s.emailModel.port="587",s.emailModel.enable_ssl=!0),r.updateEMailSettings(s.emailModel).then(function(){n.create({content:m("translate")("Setup.Settings.UpdateSuccess"),className:"success"}),r.getSetting().then(function(s){var l=s.data;l.SystemEMail&&(l.SystemEMail.enable_ssl="True"===l.SystemEMail.enable_ssl),l.SystemEMail&&l.SystemEMail.dont_send_bulk_email_result&&(l.SystemEMail.dont_send_bulk_email_result="True"===l.SystemEMail.dont_send_bulk_email_result),l.PersonalEMail&&(l.PersonalEMail.enable_ssl="True"===l.PersonalEMail.enable_ssl),l.PersonalEMail&&l.PersonalEMail.dont_send_bulk_email_result&&(l.PersonalEMail.dont_send_bulk_email_result="True"===l.PersonalEMail.dont_send_bulk_email_result),e.system.messaging=l}),s.emailUpdating=!1}))},s.resetEMailForm=function(){s.emailModel=angular.copy(e.system.messaging.SystemEMail)},s.resetSMSForm=function(){s.smsModel=angular.copy(e.system.messaging.SMS)},s.removeSMSSettings=function(){r.removeSMSSettings(s.smsModel).then(function(){s.smsModel=null,e.system.messaging.SMS=null})},s.removeEMailSettings=function(){r.removeEMailSettings(s.emailModel).then(function(){s.emailModel=null,e.system.messaging.SystemEMail=null})}}]);