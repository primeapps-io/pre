"use strict";angular.module("primeapps").controller("TemplateFormController",["$rootScope","$scope","$filter","$state","$location","helper","config","$localStorage","TemplateService","$cookies","mdToast",function(e,t,a,i,n,l,s,o,p,m,r){t.id=n.search().id,t.documentexcel=!0,t.documentword=!0;var d={};t.addNewPermissions=function(i){i.permissions=[],angular.forEach(e.profiles,function(e){e.is_persistent&&e.has_admin_rights&&(e.name=a("translate")("Setup.Profiles.Administrator")),e.is_persistent&&!e.has_admin_rights&&(e.name=a("translate")("Setup.Profiles.Standard")),i.permissions.push({profile_id:e.id,profile_name:e.name,type:"full",profile_is_admin:e.has_admin_rights}),t.temp=i.permissions})},d.isNew=!0,d.isNew?t.addNewPermissions(d):d.permissions&&d.permissions.length>0?angular.forEach(d.permissions,function(t){var i=a("filter")(e.profiles,{id:t.profile_id},!0)[0];t.profile_name=i.Name,t.profile_is_admin=i.has_admin_rights}):t.addNewPermissions(d),t.template=d,t.id&&p.get(t.id).then(function(i){t.template=i.data,"excel"===t.template.template_type?(t.documentword=!1,t.document="excel"):(t.documentexcel=!1,t.document="word"),t.template.module=a("filter")(e.modules,{name:i.data.module},!0)[0],0==t.template.permissions&&(t.template.permissions=t.temp,t.template.subject="Word"),angular.forEach(i.data.permissions,function(t){var i=a("filter")(e.profiles,{id:t.profile_id},!0)[0];t.profile_name=i.name,t.profile_is_admin=i.has_admin_rights}),t.getDownloadUrl()});var c=function(){t.saving=!1,i.go("app.setup.templates"),r.success(a("translate")("Setup.Templates.SaveSuccess"))};t.fileUpload={settings:{runtimes:"html5",url:"storage/upload_template",chunk_size:"5mb",multipart:!0,unique_names:!0,headers:{Authorization:"Bearer "+o.read("access_token"),Accept:"application/json","X-Tenant-Id":m.get("tenant_id"),"X-App-Id":e.currentAppId},filters:{mime_types:[{title:"Template Files",extensions:"doc,docx"}],max_file_size:"10mb"}},events:{fileUploaded:function(e,a,i){var n=JSON.parse(i.response),l={name:t.template.name,module:t.template.module.name,template_type:"module",content:n.unique_name,content_type:n.content_type,chunks:n.chunks,subject:"Word",active:t.template.active,permissions:t.template.permissions};t.id?(l.id=t.template.id,p.update(l).then(function(){c()})["catch"](function(){t.saving=!1})):p.create(l).then(function(){c()})["catch"](function(){t.saving=!1})}}},t.fileUploadExcel={settings:{runtimes:"html5",url:"storage/upload_template",chunk_size:"5mb",multipart:!0,unique_names:!0,headers:{Authorization:"Bearer "+o.read("access_token"),Accept:"application/json","X-Tenant-Id":m.get("tenant_id"),"X-App-Id":e.currentAppId},filters:{mime_types:[{title:"Template Files",extensions:"xls,xlsx"}],max_file_size:"10mb"}},events:{fileUploaded:function(e,a,i){var n=JSON.parse(i.response),l={name:t.template.name,module:t.template.module.name,template_type:"excel",content:n.unique_name,content_type:n.content_type,chunks:n.chunks,subject:"Excel",active:t.template.active,permissions:t.template.permissions};t.id?(l.id=t.template.id,p.update(l).then(function(){c()})["catch"](function(){t.saving=!1})):p.create(l).then(function(){c()})["catch"](function(){t.saving=!1})}}},t.save=function(){t.uploadForm.$valid&&(t.saving=!0,t.id?t.templateFileCleared?t.fileUpload.uploader.start():(t.template.module=t.template.module.name,p.update(t.template).then(function(){c()})["catch"](function(){t.saving=!1})):t.fileUpload.uploader.start())},t.saveExcel=function(){t.uploadForm.$valid&&(t.saving=!0,t.id?t.templateFileCleared?t.fileUploadExcel.uploader.start():(t.template.module=t.template.module.name,p.update(t.template).then(function(){c()})["catch"](function(){t.saving=!1})):t.fileUploadExcel.uploader.start())},t.getDownloadUrl=function(){t.template&&t.template.id&&(t.templateDownloadUrl="attach/download_template?template_id="+t.template.id+"&access_token="+o.read("access_token"))},t.clearTemplateFile=function(){t.fileUpload.uploader.files[0]&&t.fileUpload.uploader.removeFile(t.fileUpload.uploader.files[0]),t.template&&t.template.content&&(t.template.content=void 0),t.templateFileCleared=!0}}]);