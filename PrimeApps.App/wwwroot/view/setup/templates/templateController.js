"use strict";angular.module("primeapps").controller("TemplateController",["$rootScope","$scope","$filter","$state","helper","$localStorage","config","TemplateService","FileUploader","mdToast","$mdDialog","AppService","$window",function(e,t,a,n,i,l,r,o,s,c,d,u,m){t.loading=!0,u.checkPermission().then(function(u){function p(){var e='<td class="hide-on-m2"><span>{{dataItem.name}}</span></td>';e+="<td class=\"hide-on-m2\"><span>{{ modulus[dataItem.module]['label_'+ language+ '_plural']}}</span></td>",e+='<td class="hide-on-m2"><span>{{'+M+" }}</span></td>",e+='<td class="show-on-m2">';var t="<div>"+a("translate")("Setup.Templates.TemplateName")+": <strong>{{dataItem.name}}</strong></div>";return t+="<div>"+a("translate")("Common.Module")+": <strong>{{ modulus[dataItem.module]['label_'+ language+ '_plural']}}</strong></div>",t+="<div>"+a("translate")("Setup.Templates.Status")+": <strong>{{"+M+" }}</strong></div>",e+=t+"</td>",e+='<td ng-click="$event.stopPropagation();"><span><md-button class="md-icon-button" aria-label=" " ng-click="delete($event,dataItem)"><i class="fas fa-trash"></i> </md-button></span></td>'}if(u&&u.data){var f=JSON.parse(u.data.profile),g=void 0;if(u.data.customProfilePermissions&&(g=JSON.parse(u.data.customProfilePermissions)),t.hasEmailPermission=t.hasSMSPermission=t.hasExcelPermission=t.hasDocumentPermission=!0,!f.HasAdminRights){var h=void 0;g&&(h=g.permissions.indexOf("profiles")>-1),h||(f.SendEmail||f.SendSMS||f.ExportData||f.WordPdfDownload?(t.hasEmailPermission=f.SendEmail,t.hasSMSPermission=f.SendSMS,t.hasExcelPermission=f.ExportData,t.hasDocumentPermission=f.WordPdfDownload):(c.error(a("translate")("Common.Forbidden")),n.go("app.dashboard")))}}e.breadcrumblist=[{title:a("translate")("Layout.Menu.Dashboard"),link:"#/app/dashboard"},{title:a("translate")("Layout.Menu.Templates"),link:"#/app/setup/templates"},{title:null}],t.templateActiveTab=f.HasAdminRights||t.hasEmailPermission?n.params.tab?n.params.tab:"email":t.hasDocumentPermission?n.params.tab?n.params.tab:"document":t.hasExcelPermission?n.params.tab?n.params.tab:"excel":n.params.tab?n.params.tab:"sms";var b={name:"docFilter",fn:function(e){var t=i.getFileExtension(e.name);return"docx"===t||"doc"===t}},v={name:"excelFilter",fn:function(e){var t=i.getFileExtension(e.name);return"xls"===t||"xlsx"===t}};t.goUrl=function(n){e.breadcrumblist[2].title=a("translate")("Setup.Nav.Tabs."+n.charAt(0).toUpperCase()+n.substr(1).toLowerCase()+"Template"),t.gridOptions&&t.grid&&t.grid.dataSource.filter(t.filters[n])},t.changeTemplateActiveTab=function(e){t.templateActiveTab=e;var a=_.filters.indexOf(b),n=_.filters.indexOf(v);"document"===e?-1===a&&(_.filters[_.filters.length-1]=b,n=_.filters.indexOf(v),n>-1&&delete _.filters[n]):"excel"===e&&-1===n&&(_.filters[_.filters.length-1]=v,a>-1&&delete _.filters[a]),t.fileUpload=_},t.currentChangeModule=function(){t.module=a("filter")(e.modules,{name:t.current.module},!0)[0],t.moduleFields=o.getFields(t.module)},t.searchTags=function(e){var a=[];return angular.forEach(t.moduleFields,function(t){"seperator"!==t.name&&t.label.indexOf(e)>=0&&a.push(t)}),t.tags=a,a},t.getTagTextRaw=function(e){return e.name.indexOf("seperator")>=0?void 0:'<i style="color:#0f1015;font-style:normal">{'+e.name+"}</i>"};var S={Authorization:"Bearer "+window.localStorage.getItem("access_token"),Accept:"application/json","x-app-id":e.user.app_id};t.wordDownload=function(e){m.open("/storage/download_template?fileId="+e.id+"&tempType="+e.template_type,"_blank")};var _=t.fileUpload=new s({url:"storage/upload_template",chunk_size:"256kb",queueLimit:1});_.onAfterAddingFile=function(e){var t=new FileReader;t.readAsDataURL(e._file)},_.onWhenAddingFileFailed=function(e,t){switch(t.name){case"docFilter":c.warning(a("translate")("Setup.Settings.DocumentTypeError"));break;case"excelFilter":c.warning(a("translate")("Data.Import.FormatError"));break;case"sizeFilter":c.warning(a("translate")("Setup.Settings.SizeError"))}},_.filters.push({name:"sizeFilter",fn:function(e){return e.size<10485760}}),_.onAfterAddingFile=function(e){t.current.content=e._file.name,t.requiredColor=void 0},t.remove=function(){_.queue[0]&&_.queue[0].remove(),t.current.content=void 0,t.templateFileCleared=!0},t.showSideModal=function(){_.queue[0]&&_.queue[0].remove(),e.sideLoad=!1,e.buildToggler("sideModal","view/setup/templates/templateForm.html"),t.loadingModal=!1},t.openFormModal=function(e){"new"===e&&(t.current={active:!0}),t.showSideModal()},t.save=function(e){if(!e.$valid)return!1;if(t.current.id)o.update(t.current).then(function(){t.grid.dataSource.read(),c.success(a("translate")("Template.SuccessMessage")),t.closeSide("sideModal")});else{switch(t.templateActiveTab){case"email":t.current.template_type="email";break;case"document":t.current.template_type="module",t.current.subject="Document";break;case"excel":t.current.template_type="excel",t.current.subject="Excel";break;case"sms":t.current.template_type="email",t.current.subject="SMS"}"document"===t.templateActiveTab||"excel"===t.templateActiveTab?(_.queue[0].uploader.headers=S,_.queue[0].headers=S,_.queue[0].upload(),_.onCompleteItem=function(e,n){t.current.content=n.unique_name,t.current.chunks=n.chunks,t.current.content=n.unique_name,t.current.subject="Word",o.create(t.current).then(function(){t.grid.dataSource.read(),c.success(a("translate")("Template.SuccessMessage")),t.closeSide("sideModal")})}):o.create(t.current).then(function(){c.success(a("translate")("Template.SuccessMessage")),t.grid.dataSource.read(),t.closeSide("sideModal")})}},t.current={},t.iframeElement={},t.changeModule=function(){},t.moduleOptions={dataSource:a("filter")(t.modules,function(e){return"roles"!==e.name&&"users"!==e.name&&"profiles"!==e.name}),dataTextField:"label_"+t.language+"_plural",dataValueField:"name"};for(var w=[],T=0;T<t.profiles.length;T++)w.push({profile_id:t.profiles[T].id,name:t.profiles[T]["name_"+t.language]});t.profileOptions={dataSource:w,dataTextField:"name",dataValueField:"profile_id"},t.clickRow=function(e){var a=window.getSelection();0===a.toString().length&&(t.current=angular.copy(e),t.openFormModal())};var x,y,k=plupload.guid();t.imgUpload={settings:{multi_selection:!1,url:r.apiUrl+"document/upload_attachment",headers:{Authorization:"Bearer "+l.read("access_token"),Accept:"application/json","X-App-Id":applicationId,"X-Tenant-Id":tenantId},multipart_params:{container:k},filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png"}],max_file_size:"2mb"},resize:{quality:90}},events:{filesAdded:function(e){e.start(),tinymce.activeEditor.windowManager.open({title:a("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+a("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,t,a){tinymce.activeEditor.windowManager.close();var n=JSON.parse(a.response);x(blobUrl+"/"+n.public_url,{alt:t.name}),x=null},error:function(e,t){switch(t.code){case-600:tinymce.activeEditor.windowManager.alert(a("translate")("EMail.MaxImageSizeExceeded"))}y&&(y(),y=null)}}},t.fileUpload={settings:{multi_selection:!1,unique_names:!1,url:r.apiUrl+"document/upload_attachment",headers:{Authorization:"Bearer "+l.read("access_token"),Accept:"application/json"},multipart_params:{container:k},filters:{mime_types:[{title:"Email Attachments",extensions:"pdf,doc,docx,xls,xlsx,csv"}],max_file_size:"50mb"}},events:{filesAdded:function(e){e.start(),tinymce.activeEditor.windowManager.open({title:a("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+a("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,t,a){var n=JSON.parse(a.response);x(n.PublicURL,{alt:t.name}),x=null,tinymce.activeEditor.windowManager.close()},error:function(e,t){switch(t.code){case-600:tinymce.activeEditor.windowManager.alert(a("translate")("EMail.MaxFileSizeExceeded"))}y&&(y(),y=null)}}},t.tinymceOptions=function(n){t[n]={setup:function(e){e.addButton("addParameter",{type:"button",text:a("translate")("EMail.AddParameter"),onclick:function(){tinymce.activeEditor.execCommand("mceInsertContent",!1,"#")}}),e.on("init",function(){t.loadingModal=!1})},onChange:function(){},inline:!1,height:200,language:e.language,plugins:["advlist autolink lists link image charmap print preview anchor table","searchreplace visualblocks code fullscreen","insertdatetime table contextmenu paste imagetools wordcount textcolor colorpicker"],toolbar:"addParameter | addQuoteTemplate | styleselect | bold italic underline | forecolor backcolor | alignleft aligncenter alignright alignjustify | link image imagetools | table bullist numlist  blockquote code fullscreen",menubar:"false",templates:[{title:"Test template 1",content:"Test 1"},{title:"Test template 2",content:"Test 2"}],skin:"lightgray",theme:"modern",file_picker_callback:function(e,t,a){if(x=e,"file"===a.filetype){var n=document.getElementById("uploadFile");n.click()}if("image"===a.filetype){var n=document.getElementById("uploadImage");n.click()}},image_advtab:!0,file_browser_callback_types:"image file",paste_data_images:!0,paste_as_text:!0,spellchecker_language:e.language,images_upload_handler:function(e,a,n){var i=e.blob();x=a,y=n,t.imgUpload.uploader.addFile(i)},init_instance_callback:function(e){t.iframeElement[n]=e.iframeElement},resize:!1,width:"99,9%",toolbar_items_size:"small",statusbar:!1,convert_urls:!1,remove_script_host:!1}},t.tinymceOptions("tinymceTemplate"),t.tinymceOptions("tinymceTemplateEdit"),t.filters={email:[{field:"Subject",operator:"ne",value:"SMS"},{logic:"or",filters:[{field:"TemplateType",operator:"eq",value:"Sms"},{field:"TemplateType",operator:"eq",value:"System"}]}],document:[{field:"TemplateType",operator:"eq",value:"Module"}],excel:[{field:"TemplateType",operator:"eq",value:"Excel"}],sms:[{field:"TemplateType",operator:"eq",value:"Sms"},{field:"Subject",operator:"eq",value:"SMS"}]};var M="dataItem.active ? ('Setup.Modules.Active' | translate) : ('Setup.Modules.Passive' | translate)";t["delete"]=function(e,n){var i=d.confirm().title(a("translate")("Common.AreYouSure")).targetEvent(e).ok(a("translate")("Common.Yes")).cancel(a("translate")("Common.No"));d.show(i).then(function(){o["delete"](n.id).then(function(){t.grid.dataSource.read(),c.success(a("translate")("Template.SuccessDelete"))})},function(){t.status="You decided to keep your debt."})};var E=function(){var n=new kendo.data.DataSource({type:"odata-v4",page:1,pageSize:10,serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:{url:"/api/template/get_all_template_list",type:"GET",dataType:"json",beforeSend:e.beforeSend()}},schema:{data:"items",total:"count",model:{id:"id",fields:{CreatedAt:{type:"date"},AuditType:{type:"enums"}}}},filter:t.filters[t.templateActiveTab]});t.gridOptions={dataSource:n,scrollable:!1,persistSelection:!0,sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100],buttonCount:5,info:!0},filterable:!0,rowTemplate:function(e){return'<tr ng-click="clickRow(dataItem)">'+p(e)+"</tr>"},altRowTemplate:function(e){return'<tr ng-click="clickRow(dataItem)" class="k-alt">'+p(e)+"</tr>"},columns:[{field:"Name",title:a("translate")("Setup.Templates.TemplateName"),media:"(min-width: 575px)"},{field:"Module",title:a("translate")("Common.Module"),media:"(min-width: 575px)"},{field:"Active",title:a("translate")("Setup.Templates.Status"),media:"(min-width: 575px)"},{title:"Items",media:"(max-width: 575px)"},{field:"",title:"",filterable:!1,width:"40px"}]},n.fetch(function(){t.loading=!1})};angular.element(document).ready(function(){E()})})}]);