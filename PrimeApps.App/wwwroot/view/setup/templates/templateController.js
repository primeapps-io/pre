"use strict";angular.module("primeapps").controller("TemplateController",["$rootScope","$scope","$filter","$state","helper","$localStorage","config","TemplateService","FileUploader","mdToast","$mdDialog","AppService","$window","$timeout",function(e,t,a,l,n,i,r,o,s,u,d,c,m,p){function f(a){return a&&t.modulus[a]?e.getLanguageValue(t.modulus[a].languages,"label","plural"):""}function g(){t.current.id?o.update(t.current).then(function(){t.grid.dataSource.read(),u.success(a("translate")("Template.SuccessMessage")),t.closeSide("sideModal")}):o.create(t.current).then(function(){t.grid.dataSource.read(),u.success(a("translate")("Template.SuccessMessage")),t.closeSide("sideModal")})}t.loading=!0,t.searchOldValues={},t.showAddParameter=!1,c.checkPermission().then(function(c){function h(e){return'<td class="hide-on-m2"><span>'+e.name+'</span></td><td class="hide-on-m2"><span>'+f(e.module)+'</span></td><td class="hide-on-m2"><span>{{'+C+' }}</span></td><td class="show-on-m2"><div>'+a("translate")("Setup.Templates.TemplateName")+": <strong>"+e.name+"</strong></div><div>"+a("translate")("Common.Module")+": <strong>"+f(e.module)+"</strong></div><div>"+a("translate")("Setup.Templates.Status")+": <strong>{{"+C+' }}</strong></div></td><td ng-click="$event.stopPropagation();"><span><md-button class="md-icon-button" aria-label=" " ng-click="delete($event,dataItem)"><i class="fas fa-trash"></i> </md-button></span></td>'}if(c&&c.data){var v=JSON.parse(c.data.profile),b=void 0;if(c.data.customProfilePermissions&&(b=JSON.parse(c.data.customProfilePermissions)),t.hasEmailPermission=t.hasSMSPermission=t.hasExcelPermission=t.hasDocumentPermission=!0,!v.HasAdminRights){var _=void 0;b&&(_=b.permissions.indexOf("profiles")>-1),_||(v.SendEmail||v.SendSMS||v.ExportData||v.WordPdfDownload?(t.hasEmailPermission=v.SendEmail,t.hasSMSPermission=v.SendSMS,t.hasExcelPermission=v.ExportData,t.hasDocumentPermission=v.WordPdfDownload):(u.error(a("translate")("Common.Forbidden")),l.go("app.dashboard")))}}e.breadcrumblist=[{title:a("translate")("Layout.Menu.Dashboard"),link:"#/app/dashboard"},{title:a("translate")("Layout.Menu.Templates"),link:"#/app/setup/templates"},{title:null}],t.templateActiveTab=v.HasAdminRights||t.hasEmailPermission?l.params.tab?l.params.tab:"email":t.hasDocumentPermission?l.params.tab?l.params.tab:"document":t.hasExcelPermission?l.params.tab?l.params.tab:"excel":l.params.tab?l.params.tab:"sms";var y={name:"docFilter",fn:function(e){var t=n.getFileExtension(e.name);return"txt"===t||"docx"===t||"pdf"===t||"doc"===t}},S={name:"excelFilter",fn:function(e){var t=n.getFileExtension(e.name);return"xls"===t||"xlsx"===t}};t.goUrl=function(n){e.breadcrumblist[2].title=a("translate")("Setup.Nav.Tabs."+n.charAt(0).toUpperCase()+n.substr(1).toLowerCase()+"Template"),t.gridOptions&&t.grid&&t.grid.dataSource.filter(t.filters[n]),l.go("app.setup.templates",{tab:n},{notify:!1})};var x={name:"sizeFilter",fn:function(e){return e.size<10485760}};t.changeTemplateActiveTab=function(e){t.templateActiveTab=e;var a=T.filters.indexOf(y),l=T.filters.indexOf(S);if("document"===e?-1===a&&(T.filters[T.filters.length-1]=y,l=T.filters.indexOf(S),l>-1&&delete T.filters[l]):"excel"===e&&-1===l&&(T.filters[T.filters.length-1]=S,a>-1&&delete T.filters[a]),"document"===e||"excel"===e){var n=T.filters.indexOf(x);-1===n&&T.filters.push(x),T.filters=T.filters.filter(function(e){return e})}t.fileUpload=T},t.currentChangeModule=function(){t.module=a("filter")(e.modules,{name:t.current.module},!0)[0],t.moduleFields=o.getFields(t.module),t.moduleRequired()},t.searchTags=function(e){var a=[];p(function(){if(t.moduleFields&&t.moduleFields.length>0){for(var l=0;l<t.moduleFields.length;l++){var n=t.moduleFields[l];if("seperator"===n.name)return;n.name&&n.name.match("seperator")&&(n.name=n.label),n.name&&n.name.indexOf(e)>=0&&a.push(n)}return t.tags=a,a}},150)},t.getTagTextRaw=function(e){return p(function(){t.$broadcast("$tinymce:refreshContent")},50),e.name.indexOf("seperator")<0?'<i style="color:#0f1015;font-style:normal">{'+e.name+"}</i>":void 0};var w={Authorization:"Bearer "+window.localStorage.getItem("access_token"),Accept:"application/json","x-app-id":e.user.app_id};t.download=function(e){m.open("/storage/download_template?fileId="+e.id+"&tempType="+e.template_type,"_blank")};var T=t.fileUpload=new s({url:"storage/upload_template",chunk_size:"256kb",queueLimit:1});T.onAfterAddingFile=function(e){var t=new FileReader;t.readAsDataURL(e._file)},T.onWhenAddingFileFailed=function(e,t){switch(t.name){case"docFilter":u.warning(a("translate")("Setup.Settings.DocumentTypeError"));break;case"excelFilter":u.warning(a("translate")("Data.Import.FormatError"));break;case"sizeFilter":u.warning(a("translate")("Documents.SizeError"))}},T.filters.push({name:"sizeFilter",fn:function(e){return e.size<10485760}}),T.onAfterAddingFile=function(e){t.current.content=e._file.name,t.requiredColor=void 0},t.remove=function(){T.queue[0]&&T.queue[0].remove(),t.current.content=void 0,t.templateFileCleared=!0},t.showSideModal=function(){T.queue[0]&&T.queue[0].remove(),e.sideLoad=!1,e.buildToggler("sideModal","view/setup/templates/templateForm.html"),t.loadingModal=!1,t.templateFileCleared=!1,t.saving=!1,t.showAddParameter=!1,t.current.module&&(t.module=a("filter")(e.modules,{name:t.current.module},!0)[0],t.moduleFields=o.getFields(t.module))},t.openFormModal=function(e){"new"===e&&(t.current={active:!0},t.current.profile=[],t.current.sharesData=[],t.current.sharing_type="me"),t.showSideModal()},t.moduleRequired=function(){var e=document.getElementById("module"),t=document.getElementsByClassName("k-dropdown")[1];t.className=null===e.value||void 0===e.value||"? undefined:undefined ?"===e.value||""===e.value?"k-widget k-dropdown form-control ng-pristine ng-empty ng-invalid ng-invalid-required k-valid ng-touched":"k-widget k-dropdown form-control ng-pristine ng-untouched ng-empty ng-invalid ng-invalid-required"},t.save=function(e){t.saving=!0;var l=!0;if(t.moduleRequired(),"document"===t.templateActiveTab||"excel"===t.templateActiveTab){var n=document.getElementById("fileUploadReq");n&&(l=!1,n.style="color:#ff000075")}var i="";if(t.current.content&&(i=t.current.content.replace(/<[^>]+>/g,"").replace(/&[^;]+;/g,"").replace(/\n/g,"")),"email"===t.templateActiveTab&&(""===e.tinymceModel.$viewValue||""===i))return u.error(a("translate")("Template.ContentRequired")),t.saving=!1,!1;if("profile"===t.current.sharing_type&&(!t.current.profile||0===t.current.profile.length)||"custom"===t.current.sharing_type&&(!t.current.sharesData||0===t.current.sharesData.length))return t.saving=!1,!1;if(!e.$valid||!l)return t.saving=!1,!1;if("profile"===t.current.sharing_type&&t.current.profile&&t.current.profile.length>0){for(var r=[],o=0;o<t.current.profile.length;o++)r.push(t.current.profile[o].id);t.current.profiles=r}else t.current.profiles=null;if("custom"===t.current.sharing_type&&t.current.sharesData&&t.current.sharesData.length>0){for(var s=[],o=0;o<t.current.sharesData.length;o++)s.push(t.current.sharesData[o].id);t.current.shares=s}else t.current.shares=[];switch(t.templateActiveTab){case"email":t.current.template_type="email";break;case"document":t.current.template_type="module",t.current.subject="Document";break;case"excel":t.current.template_type="excel",t.current.subject="Excel";break;case"sms":t.current.template_type="email",t.current.subject="SMS"}"document"===t.templateActiveTab||"excel"===t.templateActiveTab?(T.queue[0].uploader.headers=w,T.queue[0].headers=w,T.queue[0].upload(),T.onCompleteItem=function(e,l,n){200===n?(t.current.content=l.unique_name,t.current.chunks=l.chunks,t.current.content=l.unique_name,t.current.subject="Word",g()):u.error(a("translate")("Common.Error"))}):g()},t.current={},t.iframeElement={},t.changeModule=function(){},t.moduleOptions={dataSource:a("filter")(t.modules,function(e){return"roles"!==e.name&&"users"!==e.name&&"profiles"!==e.name}),dataTextField:"languages."+e.globalization.Label+".label.plural",dataValueField:"name",filter:"contains"};for(var M=[],k=0;k<t.profiles.length;k++)M.push({profile_id:t.profiles[k].id,name:e.getLanguageValue(t.profiles[k].languages,"name")});t.profileOptions={dataSource:M,dataTextField:"name",dataValueField:"profile_id"},t.clickRow=function(e){var a=window.getSelection();0===a.toString().length&&(t.current=angular.copy(e),"profile"===t.current.sharing_type&&(t.current.profile=t.getProfilisByIds(t.current.profile_list)),"custom"===t.current.sharing_type&&(t.current.sharesData=t.getUsersByIds(t.current.shares)),t.openFormModal())};var F,E,A=plupload.guid();t.imgUpload={settings:{multi_selection:!1,url:r.apiUrl+"document/upload_attachment",headers:{Authorization:"Bearer "+i.read("access_token"),Accept:"application/json","X-App-Id":applicationId,"X-Tenant-Id":tenantId},multipart_params:{container:A},filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png"}],max_file_size:"2mb"},resize:{quality:90}},events:{filesAdded:function(e){e.start(),tinymce.activeEditor.windowManager.open({title:a("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+a("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,t,a){tinymce.activeEditor.windowManager.close();var l=JSON.parse(a.response);F(blobUrl+"/"+l.public_url,{alt:t.name}),F=null},error:function(e,t){switch(t.code){case-600:tinymce.activeEditor.windowManager.alert(a("translate")("EMail.MaxImageSizeExceeded"))}E&&(E(),E=null)}}},t.fileUpload={settings:{multi_selection:!1,unique_names:!1,url:r.apiUrl+"document/upload_attachment",headers:{Authorization:"Bearer "+i.read("access_token"),Accept:"application/json"},multipart_params:{container:A},filters:{mime_types:[{title:"Email Attachments",extensions:"pdf,doc,docx,xls,xlsx,csv"}],max_file_size:"50mb"}},events:{filesAdded:function(e){e.start(),tinymce.activeEditor.windowManager.open({title:a("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+a("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,t,a){var l=JSON.parse(a.response);F(l.PublicURL,{alt:t.name}),F=null,tinymce.activeEditor.windowManager.close()},error:function(e,t){switch(t.code){case-600:tinymce.activeEditor.windowManager.alert(a("translate")("EMail.MaxFileSizeExceeded"))}E&&(E(),E=null)}}},t.tinymceOptions=function(e){t[e]={setup:function(e){e.addButton("addParameter",{type:"button",text:a("translate")("EMail.AddParameter"),onclick:function(){t.showAddParameter=!0,tinymce.activeEditor.execCommand("mceInsertContent",!1,"#")}}),e.on("init",function(){t.loadingModal=!1}),e.on("FullscreenStateChanged",function(){$("#mceu_52").hide()})},onChange:function(){},inline:!1,height:200,plugins:["advlist autolink lists link image charmap print preview anchor table","searchreplace visualblocks code fullscreen","insertdatetime table contextmenu paste imagetools wordcount textcolor colorpicker"],toolbar:"addParameter | addQuoteTemplate | styleselect | bold italic underline | forecolor backcolor | alignleft aligncenter alignright alignjustify | link image imagetools | table bullist numlist  blockquote code fullscreen",menubar:"false",templates:[{title:"Test template 1",content:"Test 1"},{title:"Test template 2",content:"Test 2"}],skin:"lightgray",theme:"modern",file_picker_callback:function(e,t,a){if(F=e,"file"===a.filetype){var l=document.getElementById("uploadFile");l.click()}if("image"===a.filetype){var l=document.getElementById("uploadImage");l.click()}},image_advtab:!0,file_browser_callback_types:"image file",paste_data_images:!0,paste_as_text:!0,images_upload_handler:function(e,a,l){var n=e.blob();F=a,E=l,t.imgUpload.uploader.addFile(n)},init_instance_callback:function(a){t.iframeElement[e]=a.iframeElement},resize:!1,width:"99,9%",toolbar_items_size:"small",statusbar:!1,convert_urls:!1,remove_script_host:!1}},t.tinymceOptions("tinymceTemplate"),t.tinymceOptions("tinymceTemplateEdit"),t.filters={email:[{field:"Subject",operator:"ne",value:"SMS"},{logic:"or",filters:[{field:"TemplateType",operator:"eq",value:"Sms"},{field:"TemplateType",operator:"eq",value:"System"}]}],document:[{field:"TemplateType",operator:"eq",value:"Module"}],excel:[{field:"TemplateType",operator:"eq",value:"Excel"}],sms:[{field:"TemplateType",operator:"eq",value:"Sms"},{field:"Subject",operator:"eq",value:"SMS"}]};var C="dataItem.active ? ('Setup.Modules.Active' | translate) : ('Setup.Modules.Passive' | translate)";t["delete"]=function(e,l){var n=d.confirm().title(a("translate")("Common.AreYouSure")).targetEvent(e).ok(a("translate")("Common.Yes")).cancel(a("translate")("Common.No"));d.show(n).then(function(){o["delete"](l.id).then(function(){t.grid.dataSource.read(),u.success(a("translate")("Template.SuccessDelete"))})},function(){t.status="You decided to keep your debt."})};var P=function(){var l=new kendo.data.DataSource({type:"odata-v4",page:1,pageSize:10,serverPaging:!0,serverFiltering:!0,serverSorting:!0,transport:{read:{url:"/api/template/get_all_template_list",type:"GET",dataType:"json",beforeSend:e.beforeSend()}},schema:{data:"items",total:"count",model:{id:"id",fields:{name:{type:"string"},module:{type:"string"},active:{type:"boolean"}}}},filter:t.filters[t.templateActiveTab]});t.gridOptions={dataSource:l,scrollable:!1,persistSelection:!0,sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100],buttonCount:5,info:!0},filterable:!0,filter:function(e){if(e.filter&&"active"!==e.field)for(var a=0;a<e.filter.filters.length;a++)if(e.filter.filters[a].ignoreCase=!0,"module"===e.field){var l=n.getSlug(e.filter.filters[a].value,"_");t.searchOldValues[l]=e.filter.filters[a].value,e.filter.filters[a].value=l}},filterMenuOpen:function(e){"module"===e.field&&e.container[0]&&(e.container[0][1].value=t.searchOldValues[e.container[0][1].value]?t.searchOldValues[e.container[0][1].value]:e.container[0][1].value,e.container[0][4].value=t.searchOldValues[e.container[0][4].value]?t.searchOldValues[e.container[0][4].value]:e.container[0][4].value)},rowTemplate:function(e){return'<tr ng-click="clickRow(dataItem)">'+h(e)+"</tr>"},altRowTemplate:function(e){return'<tr ng-click="clickRow(dataItem)" class="k-alt">'+h(e)+"</tr>"},columns:[{field:"name",title:a("translate")("Setup.Templates.TemplateName"),media:"(min-width: 575px)"},{field:"module",title:a("translate")("Common.Module"),media:"(min-width: 575px)"},{field:"active",title:a("translate")("Setup.Templates.Status"),media:"(min-width: 575px)",values:[{value:"true",text:a("translate")("Setup.Modules.Active")},{value:"false",text:a("translate")("Setup.Modules.Passive")}]},{title:"Items",media:"(max-width: 575px)"},{field:"",title:"",filterable:!1,width:"40px"}]},l.fetch(function(){t.loading=!1,e.isMobile()||$(".k-pager-wrap").removeClass("k-pager-sm")})};angular.element(document).ready(function(){P()})}),t.sharesOptions={dataSource:t.users,filter:"contains",dataTextField:"full_name",dataValueField:"id",optionLabel:a("translate")("Common.Select")},t.profilesOptions={dataSource:e.profiles,filter:"contains",dataTextField:"languages."+e.globalization.Label+".name",dataValueField:"id",optionLabel:a("translate")("Common.Select")},t.getProfilisByIds=function(t){for(var l=[],n=0;n<t.length;n++){var i=a("filter")(e.profiles,{id:parseInt(t[n])},!0);i&&l.push(i[0])}return l},t.getUsersByIds=function(t){for(var l=[],n=0;n<t.length;n++){var i=a("filter")(e.users,{id:parseInt(t[n].user_id)},!0);i&&l.push(i[0])}return l},t.showTemplateGuideModal=function(){e.sideLoad=!1,t.selectedSubModule=null,t.selectedModule=null,t.tempalteFieldName="/"+a("translate")("Setup.Templates.TemplateFieldName"),e.buildToggler("sideModal","view/setup/templates/wordTemplateGuide.html")},t.moduleChanged=function(a){t.selectedModule=e.modulus[a],t.lookupModules=h(t.selectedModule),t.getModuleRelations(t.selectedModule),t.selectedSubModule=null},t.subModuleOptions={dataTextField:"languages."+e.globalization.Label+".label.plural",dataValueField:"name",filter:"contains"},t.subModuleChanged=function(e){t.selectedSubModule=a("filter")(t.selectedModule.relatedModules,{name:e},!0)[0]};var h=function(t){if(t){for(var a=[],l=0;l<t.fields.length;l++)if("lookup"===t.fields[l].data_type)for(var n=0;n<e.modules.length;n++)if(t.fields[l].lookup_type===e.modules[n].name){var i=angular.copy(e.modules[n]);i.parent_field=t.fields[l],a.push(i);break}a.length&&(t.lookupModules=a)}};t.getModuleRelations=function(a){a&&(a.relatedModules=[],angular.forEach(a.relations,function(t){var l=e.modulus[t.related_module];!t.deleted&&l&&0!==l.order&&(l=angular.copy(l),"many_to_many"===t.relation_type?angular.forEach(l.fields,function(e){e.name=t.related_module+"_id."+e.name}):h(l),a.relatedModules.push(l))}),t.guideLoading=!1,v(a))};var v=function(a){var l={};l.type="custom",l.name="notes",l.languages={},l.languages[e.globalization.Label]={label:{singular:"Note",plural:"Notes"}},l.order=9999,l.fields=[];var n={id:1,name:"text",label_tr:"Not",label_en:"Note",languages:{}};n.languages[e.globalization.Label]={label:"Note"},l.fields.push(n);var i={id:2,name:"first_name",label_tr:"Oluşturan - Adı",label_en:"First Name",languages:{}};i.languages[e.globalization.Label]=t.defaultSystemFields.first_name,l.fields.push(i);var r={id:3,name:"last_name",label_tr:"Oluşturan - Soyadı",label_en:"Last Name",languages:{}};r.languages[e.globalization.Label]=t.defaultSystemFields.last_name,l.fields.push(r);var o={id:4,name:"full_name",label_tr:"Oluşturan - Adı Soyadı",label_en:"Full Name",languages:{}};o.languages[e.globalization.Label]=t.defaultSystemFields.full_name,l.fields.push(o);var s={id:5,name:"email",label_tr:"Oluşturan - Eposta",label_en:"Email",languages:{}};s.languages[e.globalization.Label]=t.defaultSystemFields.email,l.fields.push(s);var u={id:6,name:"created_at",label_tr:"Oluşturulma Tarihi",label_en:"Created at",languages:{}};u.languages[e.globalization.Label]=t.defaultSystemFields.created_at,l.fields.push(u),a.relatedModules.push(l)};t.copyToClipboard=function(e){var t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style.position="absolute",t.style.left="-9999px",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),u.success("Copied: "+e)},t.getRelatedFieldName=function(e,t){return t.parent_field.name+"."+(e.multiline_type_use_html?"html__":"")+e.name},t.getDownloadUrlExcel=function(){m.open("/attach/export_excel?module="+t.selectedModule.name+"&locale="+e.locale,"_blank"),u.success(a("translate")("Module.ExcelDesktop"))},t.languageOptions={dataSource:e.globalizations,dataTextField:"Language",dataValueField:"Label",filter:e.globalizations.length>10?"startswith":null,optionLabel:a("translate")("Common.Select")}}]);