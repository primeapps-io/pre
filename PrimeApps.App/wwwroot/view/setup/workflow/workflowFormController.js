"use strict";angular.module("primeapps").controller("WorkflowFormController",["$rootScope","$location","$scope","$filter","helper","blockUI","$state","operators","$q","WorkflowService","ModuleService","config","$localStorage","FileUploader","$http","$cookies","mdToast",function(e,o,l,t,a,i,d,r,n,u,s,f,w,c,p,k,m){l.loading=!0,l.wizardStep=0,l.id=o.search().id,l.scheduleItems=u.getScheduleItems(),l.dueDateItems=u.getDueDateItems(),l.showProcessFilter=!1;var _,M,g=t("filter")(e.modules,{name:"activities"},!0)[0];l.$parent.collapsed=!0;var b=function(){l.taskFields={},l.taskFields.owner=t("filter")(g.fields,{name:"owner"},!0)[0],l.taskFields.subject=t("filter")(g.fields,{name:"subject"},!0)[0],l.taskFields.task_due_date=t("filter")(g.fields,{name:"task_due_date"},!0)[0],l.taskFields.task_status=t("filter")(g.fields,{name:"task_status"},!0)[0],l.taskFields.task_priority=t("filter")(g.fields,{name:"task_priority"},!0)[0],l.taskFields.task_notification=t("filter")(g.fields,{name:"task_notification"},!0)[0],l.taskFields.description=t("filter")(g.fields,{name:"description"},!0)[0]};b(),s.getPicklists(g,!1).then(function(o){l.picklistsActivity=o,l.id?u.get(l.id).then(function(o){o=o.data,l.module=t("filter")(e.modules,{id:o.module_id},!0)[0],t("filter")(e.approvalProcesses,{module_id:l.module.id},!0)[0]&&(l.showProcessFilter=!0),s.getPicklists(l.module).then(function(a){l.modulePicklists=a,l.filters=[];for(var i=0;5>i;i++){var d={};d.id=i,d.field=null,d.operator=null,d.value=null,d.no=i+1,l.filters.push(d)}if(o.field_update&&o.field_update.module!==l.module.name){var r;if(o.field_update.module.split(",").length>1){var n=o.field_update.module.split(",")[0];r=n===l.module.name?t("filter")(e.modules,{name:n},!0)[0]:t("filter")(e.modules,{name:l.module.name},!0)[0]}else r=t("filter")(e.modules,{name:o.field_update.module},!0)[0];s.getPicklists(r).then(function(e){l.picklistsModule=e,l.getSendNotificationUpdatableModules(l.module),l.getDynamicFieldUpdateModules(l.module),l.workflowModel=u.processWorkflow(o,l.module,l.modulePicklists,l.filters,l.scheduleItems,l.dueDateItems,l.picklistsActivity,l.taskFields,e,l.fieldUpdateModulesForNotification,l.dynamicfieldUpdateModules),l.getUpdatableModules(),l.generateHookModules()})}else l.picklistsModule=a,l.getSendNotificationUpdatableModules(l.module),l.getDynamicFieldUpdateModules(l.module),l.workflowModel=u.processWorkflow(o,l.module,l.modulePicklists,l.filters,l.scheduleItems,l.dueDateItems,l.picklistsActivity,l.taskFields,a,l.fieldUpdateModulesForNotification,l.dynamicfieldUpdateModules),l.getUpdatableModules(),l.generateHookModules();l.prepareFilters(),l.lastStepClicked=!0,l.loading=!1})}):(l.workflowModel={},l.workflowModel.active=!0,l.workflowModel.processFilter="none",l.workflowModel.frequency="continuous",l.loading=!1)}),l.selectModule=function(){l.loadingFilter=!0,l.module=angular.copy(l.workflowModel.module),t("filter")(e.approvalProcesses,{module_id:l.module.id},!0)[0]?(l.showProcessFilter=!0,l.workflowModel.processFilter="all"):(l.workflowModel.processFilter="none",l.showProcessFilter=!1),angular.forEach(l.module.fields,function(e){"lookup"===e.data_type&&(e.operators=[],e.operators.push(r.equals),e.operators.push(r.not_equal),e.operators.push(r.empty),e.operators.push(r.not_empty))}),s.getPicklists(l.module).then(function(e){l.modulePicklists=e,l.filters=[];for(var o=0;5>o;o++){var t={};t.id=o,t.field=null,t.operator=null,t.value=null,t.no=o+1,l.filters.push(t)}l.loadingFilter=!1}),l.getUpdatableModules(),l.getSendNotificationUpdatableModules(),l.getDynamicFieldUpdateModules(),T()},l.getTagTextRaw=function(e,o){return e.name.indexOf("seperator")<0?"input"==o?"{"+e.name+"}":'<i style="color:#0f1015;font-style:normal">{'+e.name+"}</i>":""},l.operatorChanged=function(e,o){var t=l.filters[o];t&&t.operator&&("empty"===t.operator.name||"not_empty"===t.operator.name?(t.value=null,t.disabled=!0):t.disabled=!1)},l.searchTags=function(e){l.moduleFields||(l.moduleFields=u.getFields(l.module));var o=[];return angular.forEach(l.moduleFields,function(l){"seperator"!=l.name&&l.label.indexOf(e)>=0&&o.push(l)}),l.tags=o,o};var h=plupload.guid();l.imgUpload={settings:{multi_selection:!1,url:f.apiUrl+"Document/upload_attachment",headers:{Authorization:"Bearer "+w.read("access_token"),Accept:"application/json","X-Tenant-Id":k.get("tenant_id")},multipart_params:{container:h},filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png"}],max_file_size:"2mb"},resize:{quality:90}},events:{filesAdded:function(e){e.start(),tinymce.activeEditor.windowManager.open({title:t("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+t("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,o,l){tinymce.activeEditor.windowManager.close();var t=JSON.parse(l.response);_(f.storage_host+t.public_url,{alt:o.name}),_=null},error:function(e,o){switch(o.code){case-600:tinymce.activeEditor.windowManager.alert(t("translate")("EMail.MaxImageSizeExceeded"))}M&&(M(),M=null)}}},l.fileUpload={settings:{multi_selection:!1,unique_names:!1,url:f.apiUrl+"Document/upload_attachment",headers:{Authorization:"Bearer "+w.read("access_token"),Accept:"application/json","X-Tenant-Id":k.get("tenant_id")},multipart_params:{container:h},filters:{mime_types:[{title:"Email Attachments",extensions:"pdf,doc,docx,xls,xlsx,csv"}],max_file_size:"50mb"}},events:{filesAdded:function(e){e.start(),tinymce.activeEditor.windowManager.open({title:t("translate")("Common.PleaseWait"),width:50,height:50,body:[{type:"container",name:"container",label:"",html:"<span>"+t("translate")("EMail.UploadingAttachment")+"</span>"}],buttons:[]})},uploadProgress:function(){},fileUploaded:function(e,o,l){var t=JSON.parse(l.response);_(f.storage_host+t.public_url,{alt:o.name}),_=null,tinymce.activeEditor.windowManager.close()},error:function(e,o){switch(o.code){case-600:tinymce.activeEditor.windowManager.alert(t("translate")("EMail.MaxFileSizeExceeded"))}M&&(M(),M=null)}}},l.tinymceOptions={setup:function(e){e.addButton("addParameter",{type:"button",text:t("translate")("EMail.AddParameter"),onclick:function(){tinymce.activeEditor.execCommand("mceInsertContent",!1,"#")}}),e.on("init",function(){l.loadingModal=!1})},onChange:function(){},inline:!1,height:300,language:e.language,plugins:["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime table contextmenu paste imagetools wordcount textcolor colorpicker"],toolbar:"addParameter | styleselect | bold italic underline | forecolor backcolor | alignleft aligncenter alignright alignjustify | link image imagetools | table bullist numlist  blockquote code fullscreen",menubar:"false",templates:[{title:"Test template 1",content:"Test 1"},{title:"Test template 2",content:"Test 2"}],skin:"lightgray",theme:"modern",file_picker_callback:function(e,o,l){if(_=e,"file"==l.filetype){var t=document.getElementById("uploadFile");t.click()}if("image"==l.filetype){var t=document.getElementById("uploadImage");t.click()}},image_advtab:!0,file_browser_callback_types:"image file",paste_data_images:!0,paste_as_text:!0,spellchecker_language:e.language,images_upload_handler:function(e,o,t){var a=e.blob();_=o,M=t,l.imgUpload.uploader.addFile(a)},init_instance_callback:function(e){l.iframeElement=e.iframeElement},resize:!1,width:"99,9%",toolbar_items_size:"small",statusbar:!1,convert_urls:!1,remove_script_host:!1};var y=function(o){var t="";return"lookup"===o.field.data_type&&"users"===o.field.lookup_type?t=o.value[0].full_name:"lookup"===o.field.data_type&&"users"!=o.field.lookup_type?t=o.value.primary_value:"picklist"===o.field.data_type?t=o.value.labelStr:"multiselect"===o.field.data_type?(t="",angular.forEach(o.value,function(e){t+=e.labelStr+"; "}),t=t.slice(0,-2)):"tag"===o.field.data_type?(t="",angular.forEach(o.value,function(e){t+=e.text+"; "})):"checkbox"===o.field.data_type?t=o.value.label[e.language]:(s.formatFieldValue(o.field,o.value,l.picklistsActivity),t=angular.copy(o.field.valueFormatted)),t};l.validate=function(e){return l.workflowForm.$submitted=!0,l.validateOperations(),l.workflowForm.workflowName.$valid&&l.workflowForm.module.$valid&&l.workflowForm.operation.$valid?l.workflowModel.changed_field_checkbox&&!l.workflowForm.changed_field.$valid?!1:l.validateActions(e):!1},l.validateOperations=function(){return l.workflowForm.operation.$setValidity("operations",!1),l.workflowModel.operation?(angular.forEach(l.workflowModel.operation,function(e){return e?(l.workflowForm.operation.$setValidity("operations",!0),!0):void 0}),!1):!1},l.validateSendNotification=function(){return l.workflowModel.send_notification&&(l.workflowModel.send_notification.recipients&&l.workflowModel.send_notification.recipients.length||l.workflowModel.send_notification.customRecipient)&&l.workflowModel.send_notification.subject&&l.workflowModel.send_notification.message},l.validateCreateTask=function(){return l.workflowModel.create_task&&l.workflowModel.create_task.owner&&1==l.workflowModel.create_task.owner.length&&l.workflowModel.create_task.subject&&l.workflowModel.create_task.task_due_date},l.validateUpdateField=function(){if(l.workflowModel.field_update){if(l.workflowModel.field_update.updateOption&&"1"===l.workflowModel.field_update.updateOption)return l.workflowModel.field_update.updateOption&&l.workflowModel.field_update.module&&l.workflowModel.field_update.field&&void 0!=l.workflowModel.field_update.value&&null!=l.workflowModel.field_update.value;if(l.workflowModel.field_update.updateOption&&"2"===l.workflowModel.field_update.updateOption)return l.workflowModel.field_update.updateOption&&l.workflowModel.field_update.firstModule&&l.workflowModel.field_update.secondModule&&l.workflowModel.field_update.first_field&&l.workflowModel.field_update.second_field}},l.validateWebHook=function(){return l.workflowModel.webHook&&l.workflowModel.webHook.callbackUrl&&l.workflowModel.webHook.methodType},l.sendNotificationIsNullOrEmpty=function(){return l.workflowModel.send_notification&&(l.workflowModel.send_notification.recipients&&l.workflowModel.send_notification.recipients.length||l.workflowModel.send_notification.subject||l.workflowModel.send_notification.schedule||l.workflowModel.send_notification.message)?!1:!0},l.createTaskIsNullOrEmpty=function(){return l.workflowModel.create_task&&(l.workflowModel.create_task.owner&&l.workflowModel.create_task.owner.length||l.workflowModel.create_task.subject||l.workflowModel.create_task.task_due_date||l.workflowModel.create_task.task_status||l.workflowModel.create_task.task_priority||l.workflowModel.create_task.task_notification||l.workflowModel.create_task.description)?!1:!0},l.fieldUpdateIsNullOrEmpty=function(){if(!l.workflowModel.field_update)return!0;if("1"===l.workflowModel.field_update.updateOption){if(!l.workflowModel.field_update.module&&!l.workflowModel.field_update.field&&!l.workflowModel.field_update.value)return!0}else if(!(l.workflowModel.field_update.firstModule||l.workflowModel.field_update.secondModule||l.workflowModel.field_update.first_field||l.workflowModel.field_update.second_field))return!0;return!1},l.webHookIsNullOrEmpty=function(){return l.workflowModel.webHook&&(l.workflowModel.webHook.callbackUrl||l.workflowModel.webHook.methodType)?!1:!0},l.getUpdatableModules=function(){l.updatableModules=[],l.updatableModules.push(l.workflowModel.module),angular.forEach(l.workflowModel.module.fields,function(o){if(o.lookup_type&&o.lookup_type!=l.workflowModel.module.name&&"users"!=o.lookup_type&&!o.deleted){var a=t("filter")(e.modules,{name:o.lookup_type},!0)[0];l.updatableModules.push(a)}}),l.fieldUpdateModules=angular.copy(l.updatableModules),l.fieldUpdateModules.unshift(t("filter")(e.modules,{name:"users"},!0)[0])},l.getSendNotificationUpdatableModules=function(o){var a,i=[],d={};a=o?o:l.workflowModel.module,d.module=a,d.name=a["label_"+e.language+"_singular"],d.isSameModule=!0,d.systemName=null,d.id=1,i.push(d);var r=2;angular.forEach(a.fields,function(o){if(o.lookup_type&&"users"!==o.lookup_type&&!o.deleted&&"activities"!==a.name){var l={};o.lookup_type===a.name?(l.module=t("filter")(e.modules,{name:o.lookup_type},!0)[0],l.name=o["label_"+e.language]+" ("+l.module["label_"+e.language+"_singular"]+")",l.isSameModule=!1,l.systemName=o.name,l.id=r):(l.module=t("filter")(e.modules,{name:o.lookup_type},!0)[0],l.name=o["label_"+e.language]+" ("+l.module["label_"+e.language+"_singular"]+")",l.isSameModule=!1,l.systemName=o.name,l.id=r),i.push(l),r++}});var n=angular.copy(i);d.module=t("filter")(e.modules,{name:"users"},!0)[0],d.name=t("filter")(e.modules,{name:"users"},!0)[0]["label_"+e.language+"_singular"],d.isSameModule=!1,d.systemName=null,d.id=r,n.unshift(d),l.fieldUpdateModulesForNotification=n},l.getDynamicFieldUpdateModules=function(o){var a,i=[],d={};a=o?o:l.workflowModel.module,d.module=a,d.name=a["label_"+e.language+"_singular"],d.isSameModule=!0,d.systemName=a.name,d.id=1,i.push(d);var r=2;angular.forEach(a.fields,function(o){if(o.lookup_type&&"users"!==o.lookup_type&&!o.deleted&&"activities"!==a.name){var l={};o.lookup_type===a.name?(l.module=t("filter")(e.modules,{name:o.lookup_type},!0)[0],l.name=o["label_"+e.language]+" ("+l.module["label_"+e.language+"_singular"]+")",l.isSameModule=!1,l.systemName=o.name,l.id=r):(l.module=t("filter")(e.modules,{name:o.lookup_type},!0)[0],l.name=o["label_"+e.language]+" ("+l.module["label_"+e.language+"_singular"]+")",l.isSameModule=!1,l.systemName=o.name,l.id=r),i.push(l),r++}}),l.dynamicfieldUpdateModules=angular.copy(i)},l.generateHookModules=function(){if(l.id&&l.workflowModel.webHook&&l.workflowModel.webHook.parameters){l.hookParameters=[];var e=l.workflowModel.webHook.parameters.split(",");angular.forEach(e,function(e){var o=e.split("|",3),a={};a.parameterName=o[0],a.selectedModules=angular.copy(l.updatableModules);var i;if(l.module.name===o[1])i=t("filter")(a.selectedModules,{name:o[1]},!0)[0];else{var d=t("filter")(l.module.fields,{name:o[1]},!0)[0].lookup_type;i=t("filter")(a.selectedModules,{name:d},!0)[0]}i&&(a.selectedModule=i,a.selectedField=t("filter")(a.selectedModule.fields,{name:o[2]},!0)[0],l.hookParameters.push(a))})}else T()};var v=function(){l.workflowModel.field_update.value=null,l.$broadcast("angucomplete-alt:clearInput"),l.workflowModel.field_update.field&&"image"===l.workflowModel.field_update.field.data_type&&l.fileUploader("image"),l.workflowModel.field_update.field&&"document"===l.workflowModel.field_update.field.data_type&&l.fileUploader("document")};l.updateModuleChanged=function(){return l.workflowModel.field_update&&l.workflowModel.field_update.module?(s.getPicklists(l.workflowModel.field_update.module).then(function(e){l.picklistsModule=e}),l.workflowModel.field_update.field=null,void v()):(l.workflowModel.field_update.field=null,void v())},l.optionChanged=function(){l.workflowModel.field_update&&l.workflowModel.field_update.updateOption&&"1"===l.workflowModel.field_update.updateOption&&(l.workflowModel.field_update.module&&(l.workflowModel.field_update.module=null),l.workflowModel.field_update.field&&(l.workflowModel.field_update.field=null),l.workflowModel.field_update.value&&(l.workflowModel.field_update.value=null)),l.workflowModel.field_update&&l.workflowModel.field_update.updateOption&&"2"===l.workflowModel.field_update.updateOption&&(l.workflowModel.field_update.firstModule&&(l.workflowModel.field_update.firstModule=null),l.workflowModel.field_update.secondModule&&(l.workflowModel.field_update.secondModule=null),l.workflowModel.field_update.first_field&&(l.workflowModel.field_update.first_field=null),l.workflowModel.field_update.second_field&&(l.workflowModel.field_update.second_field=null))},l.SendNotificationModuleChanged=function(){l.workflowModel.send_notification_module&&l.workflowModel.send_notification&&(l.workflowModel.send_notification.recipients&&(l.workflowModel.send_notification.recipients=null),l.workflowModel.send_notification.customRecipient&&(l.workflowModel.send_notification.customRecipient=null))},l.SendNotificationCCModuleChanged=function(){l.workflowModel.send_notification&&l.workflowModel.send_notification.cc&&0==l.workflowModel.send_notification.cc.length&&(l.workflowModel.send_notification.cc=null),l.workflowModel.send_notification_ccmodule&&l.workflowModel.send_notification&&(l.workflowModel.send_notification.cc&&(l.workflowModel.send_notification.cc=null),l.workflowModel.send_notification.customCC&&(l.workflowModel.send_notification.customCC=null))},l.SendNotificationBccModuleChanged=function(){l.workflowModel.send_notification&&l.workflowModel.send_notification.bcc&&0==l.workflowModel.send_notification.bcc.length&&(l.workflowModel.send_notification.bcc=null),l.workflowModel.send_notification_bccmodule&&l.workflowModel.send_notification&&(l.workflowModel.send_notification.bcc&&(l.workflowModel.send_notification.bcc=null),l.workflowModel.send_notification.customBcc&&(l.workflowModel.send_notification.customBcc=null))},l.operationUpdateChanged=function(e){e||(l.workflowModel.frequency="continuous",l.id&&(l.workflowModel.delete_logs=!1)),l.workflowModel.changed_field_checkbox=!1,l.workflowModel.changed_field=null},l.changeFieldCheckboxChanged=function(e){e||(l.workflowModel.changed_field=null)},l.frequencyChanged=function(e){l.id&&"continuous"===e&&(l.workflowModel.delete_logs=!1)},l.updatableField=function(e){return"lookup"===e.data_type&&"relation"===e.lookup_type?!1:e.validation&&e.validation.readonly?!1:!0},l.updateFieldChanged=function(){v()};var F=function(){var o=n.defer();return s.getRecord(l.workflowModel.field_update.field.lookup_type,l.workflowModel.field_update.value).then(function(a){if(a=a.data,"users"===l.workflowModel.field_update.field.lookup_type)a.primary_value=a.full_name;else{var i=t("filter")(e.modules,{name:l.workflowModel.field_update.field.lookup_type},!0)[0],d=t("filter")(i.fields,{primary:!0},!0)[0];a.primary_value=a[d.name]}l.workflowModel.field_update.value=a,l.$broadcast("angucomplete-alt:changeInput","updateValue",a),o.resolve(a)})["catch"](function(e){o.reject(e.data)}),o.promise};l.updateFieldTabClicked=function(){l.id&&l.workflowModel.field_update&&l.workflowModel.field_update.field&&"lookup"===l.workflowModel.field_update.field.data_type&&!angular.isObject(l.workflowModel.field_update.value)&&F()},l.prepareFilters=function(){angular.forEach(l.filters,function(o){if(o.field&&"lookup"===o.field.data_type&&!angular.isObject(o.value)){if("empty"===o.operator.name||"not_empty"===o.operator.name)return;var a=null;if(a=o.value?o.value:o.valueState,!a)return;if("users"===o.field.lookup_type&&0==a){var i={};return i.id=0,i.email="[me]",i.full_name=t("translate")("Common.LoggedInUser"),i.primary_value=i.full_name,void(o.value=[i])}s.getRecord(o.field.lookup_type,a).then(function(a){if(a=a.data,"users"===o.field.lookup_type)a.primary_value=a.full_name,o.value=[a];else{var i=t("filter")(e.modules,{name:o.field.lookup_type},!0)[0],d=t("filter")(i.fields,{primary:!0},!0)[0];a.primary_value=a[d.name],o.value=a,l.$broadcast("angucomplete-alt:changeInput","filterLookup"+o.no,a)}})}})},l.lookup=function(e){if("users"===l.currentLookupField.lookup_type&&!l.currentLookupField.lookupModulePrimaryField){var o={};o.data_type="text_single",o.name="full_name",l.currentLookupField.lookupModulePrimaryField=o}return"number"!==l.currentLookupField.lookupModulePrimaryField.data_type&&"number_auto"!==l.currentLookupField.lookupModulePrimaryField.data_type||!isNaN(parseFloat(e))?s.lookup(e,l.currentLookupField,null):(l.$broadcast("angucomplete-alt:clearInput",l.currentLookupField.name),n.defer().promise)},l.lookupUser=a.lookupUser,l.multiselect=function(e,o){var t=[];return angular.forEach(l.modulePicklists[o.picklist_id],function(o){o.inactive||o.labelStr.toLowerCase().indexOf(e)>-1&&t.push(o)}),t},l.tags=function(e,o){return p.get(f.apiUrl+"tag/get_tag/"+o.id).then(function(o){var l=o.data;return l.filter(function(o){return-1!=o.text.toLowerCase().indexOf(e.toLowerCase())})})},l.setCurrentLookupField=function(e){l.currentLookupField=e},l.validateActions=function(e){if(!l.lastStepClicked&&!e)return l.workflowForm.$submitted=!1,!0;var o=l.sendNotificationIsNullOrEmpty(),t=l.createTaskIsNullOrEmpty(),a=l.fieldUpdateIsNullOrEmpty(),i=l.webHookIsNullOrEmpty();if(l.workflowForm.actions.$setValidity("actionRequired",!0),o&&t&&a&&i)return e?(l.workflowForm.$submitted=!1,!0):(l.workflowForm.$submitted=!1,l.workflowForm.recipients&&l.workflowForm.recipients.$setValidity("minTags",!0),l.workflowForm.customRecipient&&l.workflowForm.customRecipient.$setValidity("required",!0),l.workflowForm.subjectNotification.$setValidity("required",!0),l.workflowForm.message.$setValidity("required",!0),l.workflowForm.owner.$setValidity("required",!0),l.workflowForm.subjectTask.$setValidity("required",!0),l.workflowForm.dueDate.$setValidity("required",!0),l.workflowForm.updateOption.$setValidity("required",!0),l.workflowForm.callbackUrl.$setValidity("required",!0),l.workflowForm.methodType.$setValidity("required",!0),l.workflowForm.updateField&&"1"===l.workflowModel.field_update.updateOption&&l.workflowForm.updateField.$setValidity("required",!0),l.workflowForm.updateValue&&"1"===l.workflowModel.field_update.updateOption&&l.workflowForm.updateValue.$setValidity("required",!0),l.workflowForm.actions.$setValidity("actionRequired",!1),!1);if(l.workflowForm.subjectNotification.$pristine&&l.workflowForm.message.$pristine&&l.workflowForm.owner.$pristine&&l.workflowForm.subjectTask.$pristine&&l.workflowForm.dueDate.$pristine&&l.workflowForm.updateField&&l.workflowForm.updateField.$pristine&&l.workflowForm.updateValue&&l.workflowForm.updateValue.$pristine&&l.workflowForm.callbackUrl.$pristine)return l.workflowForm.$submitted=!1,!0;o||l.workflowModel.send_notification.recipients&&l.workflowModel.send_notification.recipients.length||l.workflowModel.send_notification.customRecipient||l.workflowForm.recipients.$setValidity("minTags",!1),o||l.workflowModel.send_notification.subject||l.workflowForm.subjectNotification.$setValidity("required",!1),o||l.workflowModel.send_notification.message||l.workflowForm.message.$setValidity("required",!1),t||l.workflowModel.create_task.owner&&l.workflowModel.create_task.owner.length||l.workflowForm.owner.$setValidity("minTags",!1),t||l.workflowModel.create_task.subject||l.workflowForm.subjectTask.$setValidity("required",!1),t||l.workflowModel.create_task.task_due_date||l.workflowForm.dueDate.$setValidity("required",!1),a||"1"!==l.workflowModel.field_update.updateOption||!l.workflowModel.field_update.module||l.workflowModel.field_update.field||l.workflowForm.updateField.$setValidity("required",!1),a||"1"!==l.workflowModel.field_update.updateOption||!l.workflowModel.field_update.module||!l.workflowModel.field_update.field||void 0!==l.workflowModel.field_update.value&&null!==l.workflowModel.field_update.value||l.workflowForm.updateValue.$setValidity("required",!1),i||l.workflowModel.webHook.callbackUrl||l.workflowForm.callbackUrl.$setValidity("required",!1),i||l.workflowModel.webHook.methodType||l.workflowForm.methodType.$setValidity("required",!1);var d=l.validateSendNotification(),r=l.validateCreateTask(),n=l.validateUpdateField(),u=l.validateWebHook();return d&&r&&n&&u||d&&r||d&&n||r&&n||u&&d||u&&n||u&&r||d||r||n||u?(l.workflowForm.$submitted=!1,!0):!1},l.setFormValid=function(){l.workflowForm.$submitted=!1,l.workflowForm.recipients&&l.workflowForm.recipients.$setValidity("minTags",!0),l.workflowForm.subjectNotification.$setValidity("required",!0),l.workflowForm.message.$setValidity("required",!0),l.workflowForm.owner.$setValidity("minTags",!0),l.workflowForm.subjectTask.$setValidity("required",!0),l.workflowForm.dueDate.$setValidity("required",!0),l.workflowForm.actions.$setValidity("actionRequired",!0),l.workflowForm.updateOption.$setValidity("required",!0),l.workflowForm.callbackUrl.$setValidity("required",!0),l.workflowForm.updateField&&"1"===l.workflowModel.field_update.updateOption&&l.workflowForm.updateField.$setValidity("required",!0),l.workflowForm.updateValue&&"1"===l.workflowModel.field_update.updateOption&&l.workflowForm.updateValue.$setValidity("required",!0)},l.getSummary=function(){if(l.workflowModel.name&&l.workflowModel.module&&l.workflowModel.operation){var o=function(){l.ruleTriggerText="",l.ruleFilterText="",l.ruleActionsText="";var o=t("translate")("Common.And"),a=t("translate")("Common.Or");if(l.workflowModel.operation.insert&&(l.ruleTriggerText+=t("translate")("Setup.Workflow.RuleTriggers.insertLabel")+" "+a+" "),l.workflowModel.operation.update){var i=t("translate")("Setup.Workflow.RuleTriggers.updateLabel")+" "+a+" ";l.ruleTriggerText+=l.ruleTriggerText?i.toLowerCase():i}if(l.workflowModel.operation["delete"]){var d=t("translate")("Setup.Workflow.RuleTriggers.deleteLabel")+" "+a+" ";l.ruleTriggerText+=l.ruleTriggerText?d.toLowerCase():d}l.ruleTriggerText=l.ruleTriggerText.slice(0,-(a.length+2)),angular.forEach(l.filters,function(t){t.field&&t.operator&&t.value&&(l.ruleFilterText+=t.field["label_"+e.language]+' <b class="operation-highlight">'+t.operator.label[e.language]+"</b> "+y(t)+' <b class="operation-highlight">'+o+"</b><br> ")}),l.ruleFilterText=l.ruleFilterText.slice(0,-(o.length+41));var r=l.validateSendNotification(),n=l.validateCreateTask(),u=l.validateUpdateField(),f=l.validateWebHook();if(r&&(l.ruleActionsText+='<b class="operation-highlight">'+t("translate")("Setup.Workflow.SendNotification")+"</b><br>",l.ruleActionsText+=t("translate")("Setup.Workflow.SendNotificationSummary",{subject:l.workflowModel.send_notification.subject})+"<br>",angular.forEach(l.workflowModel.send_notification.recipients,function(e){l.ruleActionsText+=e.full_name+", "}),l.ruleActionsText=l.ruleActionsText.slice(0,-2)+"<br>",l.workflowModel.send_notification.schedule&&(l.ruleActionsText+=t("translate")("Setup.Workflow.Schedule")+": "+l.workflowModel.send_notification.schedule.label)),n&&(r&&(l.ruleActionsText+="<br><br>"),l.ruleActionsText+='<b class="operation-highlight">'+t("translate")("Setup.Workflow.AssignTask")+"</b><br>",l.ruleActionsText+=t("translate")("Setup.Workflow.AssignTaskSummary",{subject:l.workflowModel.create_task.subject})+"<br>",l.ruleActionsText+=l.workflowModel.create_task.owner[0].full_name+"<br>",l.workflowModel.create_task.task_due_date&&(l.ruleActionsText+=t("translate")("Setup.Workflow.Schedule")+": "+l.workflowModel.create_task.task_due_date.label)),u){(r||n)&&(l.ruleActionsText+="<br><br>"),l.ruleActionsText+='<b class="operation-highlight">'+t("translate")("Setup.Workflow.FieldUpdate")+"</b><br>";var w={};if("1"===l.workflowModel.field_update.updateOption){w[l.workflowModel.field_update.field.name]=angular.copy(l.workflowModel.field_update.value),w=s.prepareRecord(w,l.workflowModel.field_update.module),s.formatFieldValue(l.workflowModel.field_update.field,l.updateFieldValue,l.picklistsModule);var c=l.workflowModel.field_update.field.valueFormatted;switch(l.workflowModel.field_update.field.data_type){case"lookup":c=l.workflowModel.field_update.value.primary_value,l.updateFieldValue=l.workflowModel.field_update.value.id;break;case"picklist":l.updateFieldValue=l.workflowModel.field_update.value.label[e.language],c=l.updateFieldValue;break;case"multiselect":l.updateFieldValue="",angular.forEach(l.workflowModel.field_update.value,function(o){var t=o.label[e.language];l.updateFieldValue+=t+"|",c+=t+"; "}),l.updateFieldValue=l.updateFieldValue.slice(0,-1),c=c.slice(0,-2);break;case"tag":l.updateFieldValue="",angular.forEach(l.workflowModel.field_update.value,function(e){l.updateFieldValue+=e.text+"|",c+=e.text+"; "}),l.updateFieldValue=l.updateFieldValue.slice(0,-1),c=c.slice(0,-2);break;case"checkbox":var p=l.workflowModel.field_update.value;void 0===p&&(p=!1);var k=t("filter")(l.picklistsModule.yes_no,{system_code:p.toString()},!0)[0];c=k.label[e.language],l.updateFieldValue=p;break;default:l.updateFieldValue=w[l.workflowModel.field_update.field.name]}l.ruleActionsText+=t("translate")("Setup.Workflow.FieldUpdateSummary",{module:l.workflowModel.field_update.module["label_"+e.language+"_singular"],field:l.workflowModel.field_update.field["label_"+e.language],value:c})+"<br>"}else l.ruleActionsText+=t("translate")("Setup.Workflow.FieldUpdateSummaryDynamic")+"<br>"}if(f&&((r||n||u)&&(l.ruleActionsText+="<br><br>"),l.ruleActionsText+='<b class="operation-highlight">'+t("translate")("Setup.Workflow.WebHook")+"</b><br>",l.ruleActionsText+=t("translate")("Setup.Workflow.WebhookSummary",{callbackUrl:l.workflowModel.webHook.callbackUrl,methodType:l.workflowModel.webHook.methodType})+"<br>",l.hookParameters.length>0)){var m=l.hookParameters[l.hookParameters.length-1];m.parameterName&&null!=m.selectedField&&m.selectedModule?(l.showWebhookSummaryTable=!0,l.workflowModel.webHook.hookParameters=l.hookParameters):l.showWebhookSummaryTable=!1}};l.workflowModel.field_update&&l.workflowModel.field_update.field&&"lookup"===l.workflowModel.field_update.field.data_type&&!angular.isObject(l.workflowModel.field_update.value)?F().then(function(){o()}):o()}},l.save=function(){l.saving=!0,l.sendNotificationIsNullOrEmpty()&&delete l.workflowModel.send_notification,l.createTaskIsNullOrEmpty()&&delete l.workflowModel.create_task,l.fieldUpdateIsNullOrEmpty()&&delete l.workflowModel.field_update,l.webHookIsNullOrEmpty()&&delete l.workflowModel.webHook;var e=u.prepareWorkflow(l.workflowModel,l.filters,l.updateFieldValue),o=function(){l.saving=!1,d.go("app.setup.workflows"),m.success(t("translate")("Setup.Workflow.SubmitSuccess"))};l.id?(e.id=l.workflowModel.id,e._rev=l.workflowModel._rev,e.type=l.workflowModel.type,e.created_by=l.workflowModel.created_by,e.updated_by=l.workflowModel.updated_by,e.created_at=l.workflowModel.created_at,e.updated_at=l.workflowModel.updated_at,e.deleted=l.workflowModel.deleted,u.update(e).then(function(){o()})["catch"](function(){l.saving=!1})):u.create(e).then(function(){o()})["catch"](function(){l.saving=!1})};var T=function(){l.hookParameters=[],l.hookModules=[],angular.forEach(l.updatableModules,function(e){l.hookModules.push(e)});var e={};e.parameterName=null,e.selectedModules=l.hookModules,e.selectedField=null,e.selectedModule=l.workflowModel.module,l.hookParameters.push(e)};l.workflowModuleParameterAdd=function(e){var o={};o.parameterName=e.parameterName,o.selectedModules=e.selectedModules,o.selectedField=e.selectedField,o.parameterName&&o.selectedModules&&o.selectedField&&(l.hookParameters.length<=10?l.hookParameters.push(o):m.warning(t("translate")("Setup.Workflow.MaximumHookWarning")));var a=l.hookParameters[l.hookParameters.length-1];a.parameterName=null,a.selectedField=null,a.selectedModule=l.workflowModel.module},l.workflowModuleParameterRemove=function(e){var o=l.hookParameters.indexOf(e);l.hookParameters.splice(o,1)},l.fileUploader=function(o){var i,d,r;"image"===o?(i="document/upload_large",d=t("translate")("Setup.Settings.ImageError"),r=t("translate")("Setup.Settings.SizeError")):(i="document/upload_attachment",d=t("translate")("Setup.Settings.DocumentTypeError"),r=t("translate")("Setup.Settings.SizeError"));var n=l.uploader=new c({url:f.apiUrl+i,headers:{Authorization:"Bearer "+w.read("access_token"),Accept:"application/json","X-Tenant-Id":k.get("tenant_id")},autoUpload:!0});n.onAfterAddingFile=function(e){l.workflowModel.field_update.value=e.uploader.queue[0].file.name,l.fileLoading=!0},n.onWhenAddingFileFailed=function(e,o){switch(o.name){case"imgFilter":m.warning(d);break;case"sizeFilter":m.warning(r)}},n.filters.push({name:"imgFilter",fn:function(e){var l=a.getFileExtension(e.name);return"image"===o?"jpg"===l||"jpeg"==l||"png"==l||"doc"==l||"gif"==l:"txt"===l||"docx"==l||"pdf"==l||"doc"==l}}),n.filters.push({name:"sizeFilter",fn:function(e){return e.size<5242880}}),n.onSuccessItem=function(t,a){l.workflowModel.field_update.value=a.UniqueName,"image"===o&&p.post(f.apiUrl+"Document/image_create",{UniqueFileName:a.UniqueName,MimeType:t.uploader.queue[0].Type,ChunkSize:1,instanceId:e.workgroup.tenant_id}).then(function(e){l.workflowModel.field_update.value=e.data
}),l.fileLoading=!1}},l.removeFile=function(){l.workflowModel.field_update.value=null,l.uploader.queue=[]}}]);