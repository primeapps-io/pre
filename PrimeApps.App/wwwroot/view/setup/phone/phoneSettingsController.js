"use strict";angular.module("primeapps").controller("PhoneSettingsController",["$rootScope","$scope","$translate","$localStorage","config","$window","$timeout","$filter","blockUI","PhoneSettingsService","ngTableParams","mdToast",function($rootScope,$scope,$translate,$localStorage,config,$window,$timeout,$filter,blockUI,PhoneSettingsService,ngTableParams,mdToast){function renewSipUsers(e){$scope.sipProvider=$scope.sipSettings.provider,e?PhoneSettingsService.getSipConfig().then(function(e){$scope.sipUsers=e.data.sipUsers,angular.forEach($scope.sipUsers,function(e){var s=$filter("filter")($scope.users,{id:parseInt(e.userId)},!0)[0];e.name=s.full_name}),$scope.sipCompanyKey=$scope.sipSettings.sipCompanyKey,$scope.sipSettings.sipLicenseCount>0&&($scope.sipLicenseAvailable=!0,$scope.licensesBought=$scope.sipSettings.sipLicenseCount,$scope.licensesUsed=$scope.sipUsers?$scope.sipUsers.length:0,$scope.licenseAvailable=parseInt($scope.licensesBought)-parseInt($scope.licensesUsed))}):($scope.sipUsers=$scope.sipSettings.sipUsers,angular.forEach($scope.sipUsers,function(e){var s=$filter("filter")($scope.users,{id:parseInt(e.userId)},!0)[0];e.name=s.full_name}),$scope.sipCompanyKey=$scope.sipSettings.sipCompanyKey,$scope.sipSettings.sipLicenseCount>0&&($scope.sipLicenseAvailable=!0,$scope.licensesBought=$scope.sipSettings.sipLicenseCount,$scope.licensesUsed=$scope.sipUsers?$scope.sipUsers.length:0,$scope.licenseAvailable=parseInt($scope.licensesBought)-parseInt($scope.licensesUsed)))}$scope.sipSettings=$rootScope.phoneSettings,$scope.sipLicenseAvailable=!1,$scope.users=$rootScope.users,$scope.hasAdminRight=$filter("filter")($rootScope.profiles,{id:$rootScope.user.role.role_id},!0)[0].has_admin_rights,$scope.sipSettings&&renewSipUsers(!1),$scope.editSipProvider=function(){if($scope.sipProviderForm.$valid&&$scope.sipProvider){$scope.sipProviderUpdating=!0;var e={};e.provider=$scope.sipProvider,e.company_key=$scope.sipCompanyKey,PhoneSettingsService.saveSipProvider(e).then(function(){mdToast.success($filter("translate")("Setup.Settings.UpdateSuccess")),$scope.sipProviderUpdating=!1,$rootScope.phoneSettings={},$rootScope.phoneSettings.provider=$scope.sipProvider,$scope.sipSettings=$rootScope.phoneSettings})}},$scope.recordDetailPhoneFieldNameFilter=function(e){return"number"===e.dataType.name||"text_single"===e.dataType.name&&e.deleted===!1?e:void 0},$scope.sipAccountFilter=function(e){if(void 0===$scope.sipUsers)return e;var s=$filter("filter")($scope.sipUsers,{userId:e.id});return 0===s.length?e:void 0},$scope.showCreateAccountForm=function(){$scope.createSipPopover=$scope.createSipPopover||$popover(angular.element(document.getElementById("createButton")),{templateUrl:"view/setup/phone/sipAccountCreate.html",placement:"left",scope:$scope,autoClose:!0,show:!0})},$scope.showEditAccountForm=function(sipAccount){var module=$filter("filter")($scope.modules,{name:sipAccount.recordDetailModuleName})[0],field=$filter("filter")(module.fields,{name:sipAccount.recordDetailPhoneFieldName})[0];$scope.sipAccount={UserId:parseInt(sipAccount.userId),Extension:sipAccount.extension,Password:null,IsAutoRegister:eval(sipAccount.isAutoRegister),IsAutoRecordDetail:eval(sipAccount.isAutoRecordDetail),RecordDetailModuleName:module,RecordDetailPhoneFieldName:field},$scope.editSipPopover=$popover(angular.element(document.getElementById("editButton"+sipAccount.userId)),{templateUrl:"view/setup/phone/sipAccountEdit.html",placement:"left",scope:$scope,autoClose:!0,show:!0})},$scope.addSipAccount=function(e){e&&e.Extension&&e.Password&&e.UserId&&$scope.sipProvider?($scope.userInviting=!0,e.connector=$scope.sipProvider,e.company_key=$scope.sipCompanyKey,e.user_id=parseInt(e.UserId),e.record_detail_module_name=e.RecordDetailModuleName.name,e.record_detail_phone_field_name=e.RecordDetailPhoneFieldName.name,e.is_auto_register=e.IsAutoRegister,e.is_auto_record_detail=e.IsAutoRecordDetail,PhoneSettingsService.saveSipAccount(e).then(function(){renewSipUsers(!0),$scope.userInviting=!1,$scope.createSipPopover.hide()})):mdToast.warning($filter("translate")("Setup.Phone.RequiredFields"))},$scope.removeSipAccount=function(e,s){$scope.userDeleting=!0,PhoneSettingsService.deleteSipAccount(e).then(function(){$scope.sipUsers.splice(s,1),$scope.userDeleting=!1,mdToast.success($filter("translate")("Setup.Users.DismissSuccess")),renewSipUsers(!0)})["catch"](function(){$scope.userDeleting=!1})}}]);