"use strict";angular.module("primeapps").controller("ApprovelProcessFormController",["$rootScope","$location","$scope","$filter","helper","blockUI","$state","operators","$q","ModuleService","ApprovelProcessService","mdToast",function(e,o,r,l,t,a,s,i,d,u,p,n){r.loading=!0,r.wizardStep=0,r.id=o.search().id,r.hookParameters=[],r.approvers=e.workgroup.users,r.approversLength=e.workgroup.users.length,r.scheduleItems=p.getScheduleItems(),r.dueDateItems=p.getDueDateItems(),r.isEdit=!1,r.isChosenModule=!0,r.users=angular.copy(e.workgroup.users),r.$parent.collapsed=!0,r.allowEdit=!0,l("filter")(r.users,{id:0},!0)[0]||r.users.unshift({id:0,email:l("translate")("Setup.Workflow.ApprovelProcess.AllUsers")});var f=l("filter")(e.modules,{name:"activities"},!0)[0],c=function(){r.taskFields={},r.taskFields.owner=l("filter")(f.fields,{name:"owner"},!0)[0],r.taskFields.subject=l("filter")(f.fields,{name:"subject"},!0)[0],r.taskFields.task_due_date=l("filter")(f.fields,{name:"task_due_date"},!0)[0],r.taskFields.task_status=l("filter")(f.fields,{name:"task_status"},!0)[0],r.taskFields.task_priority=l("filter")(f.fields,{name:"task_priority"},!0)[0],r.taskFields.task_notification=l("filter")(f.fields,{name:"task_notification"},!0)[0],r.taskFields.description=l("filter")(f.fields,{name:"description"},!0)[0]};c(),u.getPicklists(f,!1).then(function(o){r.picklistsActivity=o,r.id?p.get(r.id).then(function(o){p.getAllProcessRequests(r.id).then(function(e){l("filter")(e.data,{status:"!approved"},!0).length>0&&(r.allowEdit=!1)}),o=o.data,r.module=l("filter")(e.modules,{id:o.module_id},!0)[0],u.getPicklists(r.module).then(function(e){r.modulePicklists=e,r.filters=[];for(var l=0;5>l;l++){var t={};t.id=l,t.field=null,t.operator=null,t.value=null,t.no=l+1,r.filters.push(t)}r.filteredModules=r.modules,r.picklistsModule=e,r.getDynamicProcessModules(r.module,o,!0),r.workflowModel=p.processWorkflow(o,r.module,r.modulePicklists,r.filters,r.scheduleItems,r.dueDateItems,r.picklistsActivity,r.taskFields,e,r.dynamicprocessModules),r.getUpdatableModules(),r.generateHookModules(o),r.firstApproverLookupChange(!0,o),r.secondApproverLookupChange(!0,o),r.prepareFilters(),r.isEdit=!0,r.lastStepClicked=!0,r.loading=!1})}):(r.workflowModel={},r.workflowModel.active=!0,r.workflowModel.frequency="continuous",r.workflowModel.trigger_time="instant",r.loading=!1,r.filteredModules=r.modules,u.getAllProcess().then(function(e){for(var o=e.data,t=0;t<o.length;t++){var a=o[t],s=l("filter")(r.modules,{id:a.module_id},!0)[0].name;s&&0===a.user_id&&(r.filteredModules=l("filter")(r.filteredModules,{name:"!"+s},!0))}}))}),r.selectModule=function(o){r.loadingFilter=!0,r.isChosenModule=!1,r.module=angular.copy(r.workflowModel.module),r.users=angular.copy(e.workgroup.users),l("filter")(r.users,{id:0},!0)[0]||r.users.unshift({id:0,email:l("translate")("Setup.Workflow.ApprovelProcess.AllUsers")}),r.fakeUsers=angular.copy(r.users);for(var t=0;t<e.approvalProcesses.length;t++){var a=e.approvalProcesses[t],s=l("filter")(r.fakeUsers,{id:a.user_id},!0)[0].email;a&&o.id===a.module_id&&(r.users=l("filter")(r.users,{email:"!"+s},!0))}r.users.length!==r.fakeUsers.length&&r.users.shift(),angular.forEach(r.module.fields,function(e){"lookup"===e.data_type&&(e.operators=[],e.operators.push(i.equals),e.operators.push(i.not_equal),e.operators.push(i.empty),e.operators.push(i.not_empty))}),u.getPicklists(r.module).then(function(e){r.modulePicklists=e,r.filters=[];for(var o=0;5>o;o++){var l={};l.id=o,l.field=null,l.operator=null,l.value=null,l.no=o+1,r.filters.push(l)}r.loadingFilter=!1}),r.getUpdatableModules(),r.getDynamicProcessModules(),m()};var k=function(o){var l="";return"lookup"===o.field.data_type&&"users"===o.field.lookup_type?l=o.value[0].full_name:"lookup"===o.field.data_type&&"users"!=o.field.lookup_type?l=o.value.primary_value:"picklist"===o.field.data_type?l=o.value.labelStr:"multiselect"===o.field.data_type?(l="",angular.forEach(o.value,function(e){l+=e.labelStr+"; "}),l=l.slice(0,-2)):"checkbox"===o.field.data_type?l=o.value.label[e.language]:(u.formatFieldValue(o.field,o.value,r.picklistsActivity),l=angular.copy(o.field.valueFormatted)),l};r.validate=function(e){return r.workflowForm.$submitted=!0,r.validateOperations(),r.workflowForm.workflowName.$valid&&r.workflowForm.module.$valid&&r.workflowForm.user.$valid&&r.workflowForm.operation.$valid?r.validateActions(e):!1},r.validateOperations=function(){return r.workflowForm.operation.$setValidity("operations",!1),r.workflowModel.operation?(angular.forEach(r.workflowModel.operation,function(e){return e?(r.workflowForm.operation.$setValidity("operations",!0),!0):void 0}),!1):!1},r.getUpdatableModules=function(){r.updatableModules=[],r.updatableModules.push(r.workflowModel.module),angular.forEach(r.workflowModel.module.fields,function(o){if(o.lookup_type&&o.lookup_type!==r.workflowModel.module.name&&"users"!==o.lookup_type&&!o.deleted){var t=l("filter")(e.modules,{name:o.lookup_type},!0)[0];r.updatableModules.push(t)}})},r.prepareFilters=function(){angular.forEach(r.filters,function(o){if(o.field&&"lookup"===o.field.data_type&&!angular.isObject(o.value)){if("empty"===o.operator.name||"not_empty"===o.operator.name)return;var t=null;if(t=o.value?o.value:o.valueState,!t)return;if("users"===o.field.lookup_type&&0==t){var a={};return a.id=0,a.email="[me]",a.full_name=l("translate")("Common.LoggedInUser"),a.primary_value=a.full_name,void(o.value=[a])}u.getRecord(o.field.lookup_type,t).then(function(t){if(t=t.data,"users"===o.field.lookup_type)t.primary_value=t.full_name,o.value=[t];else{var a=l("filter")(e.modules,{name:o.field.lookup_type},!0)[0],s=l("filter")(a.fields,{primary:!0},!0)[0];t.primary_value=t[s.name],o.value=t,r.$broadcast("angucomplete-alt:changeInput","filterLookup"+o.no,t)}})}})},r.lookup=function(e){if("users"===r.currentLookupField.lookup_type&&!r.currentLookupField.lookupModulePrimaryField){var o={};o.data_type="text_single",o.name="full_name",r.currentLookupField.lookupModulePrimaryField=o}return"number"!==r.currentLookupField.lookupModulePrimaryField.data_type&&"number_auto"!==r.currentLookupField.lookupModulePrimaryField.data_type||!isNaN(parseFloat(e))?u.lookup(e,r.currentLookupField,null):(r.$broadcast("angucomplete-alt:clearInput",r.currentLookupField.name),d.defer().promise)},r.lookupUser=t.lookupUser,r.multiselect=function(e,o){var l=[];return angular.forEach(r.modulePicklists[o.picklist_id],function(o){o.inactive||o.labelStr.toLowerCase().indexOf(e)>-1&&l.push(o)}),l},r.multiselectProfiles=function(){return l("filter")(e.profiles,{deleted:!1,has_admin_rights:!1},!0)},r.setCurrentLookupField=function(e){r.currentLookupField=e},r.validateActions=function(e){if(!r.lastStepClicked&&!e)return r.workflowForm.$submitted=!1,!0;if("dynamicApprover"===r.workflowModel.approver_type){if(r.workflowModel.firstApproverModule&&r.workflowModel.first_approver_lookup&&r.workflowModel.first_approver_field){if(!r.workflowModel.secondApproverModule)return r.workflowModel.$submitted=!1,!0;if(r.workflowModel.secondApproverModule&&r.workflowModel.second_approver_field&&r.workflowModel.second_approver_lookup)return r.workflowModel.$submitted=!1,!0}}else if("staticApprover"===r.workflowModel.approver_type&&r.hookParameters[0].approver)return r.workflowModel.$submitted=!1,!0;return!1},r.getDynamicProcessModules=function(o,t,a){if(!a||"staticApprover"!==t.approver_type){var s,i=[];s=o?o:r.workflowModel.module;var d=1;angular.forEach(s.fields,function(o){if(o.lookup_type&&"users"!==o.lookup_type&&!o.deleted){var r={};o.lookup_type===s.name?(r.module=l("filter")(e.modules,{name:o.lookup_type},!0)[0],r.name=o["label_"+e.language]+" ("+r.module["label_"+e.language+"_singular"]+")",r.isSameModule=!1,r.systemName=o.name,r.id=d):(r.module=l("filter")(e.modules,{name:o.lookup_type},!0)[0],r.name=o["label_"+e.language]+" ("+r.module["label_"+e.language+"_singular"]+")",r.isSameModule=!1,r.systemName=o.name,r.id=d),i.push(r),d++}}),r.dynamicprocessModules=angular.copy(i)}},r.firstApproverLookupChange=function(o,t){o&&"staticApprover"===t.approver_type||(r.firstDynamicApproverFields=l("filter")(e.modules,{name:r.workflowModel.first_approver_lookup.lookup_type},!0)[0],o||r.workflowModel.first_approver_field&&(r.workflowModel.first_approver_field=null))},r.secondApproverLookupChange=function(o,t){o&&"staticApprover"===t.approver_type||(r.secondDynamicApproverFields=l("filter")(e.modules,{name:r.workflowModel.first_approver_lookup.lookup_type},!0)[0],o||r.workflowModel.second_approver_field&&(r.workflowModel.second_approver_field=null))},r.getSummary=function(){if(r.workflowModel.name&&r.workflowModel.module&&r.workflowModel.operation){var o=function(){r.ruleTriggerText="",r.ruleFilterText="",r.ruleActionsText="";var o=l("translate")("Common.And"),t=l("translate")("Common.Or");if(r.workflowModel.operation.insert&&(r.ruleTriggerText+=l("translate")("Setup.Workflow.RuleTriggers.insertLabel")+" "+t+" "),r.workflowModel.operation.update){var a=l("translate")("Setup.Workflow.RuleTriggers.updateLabel")+" "+t+" ";r.ruleTriggerText+=r.ruleTriggerText?a.toLowerCase():a}if(r.ruleTriggerText=r.ruleTriggerText.slice(0,-(t.length+2)),angular.forEach(r.filters,function(l){l.field&&l.operator&&l.value&&(r.ruleFilterText+=l.field["label_"+e.language]+' <b class="operation-highlight">'+l.operator.label[e.language]+"</b> "+k(l)+' <b class="operation-highlight">'+o+"</b><br> ")}),r.ruleFilterText=r.ruleFilterText.slice(0,-(o.length+41)),r.hookParameters){for(var s=[],i=0;i<r.hookParameters.length;i++)if(r.hookParameters[i].approver){var d={};d.user_id=r.hookParameters[i].approver.id,d.order=i+1,s.push(d)}r.workflowModel.approvers=s}};o()}},r.save=function(){r.saving=!0;var e=p.prepareWorkflow(r.workflowModel,r.filters),o=function(){if(!r.id&&"dynamicApprover"===e.approver_type&&l("filter")(r.module.fields,{name:"custom_approver"},!0).length<1){for(var o=angular.copy(r.module),t=1;3>t;t++){var a={};a.data_type="email",a.deleted=!1,a.display_detail=!1,a.display_list=!1,a.editable=!1,a.label_en=t+". Approver",a.label_tr=t+". Onaylayıcı",a.name=1===t?"custom_approver":"custom_approver_2",a.order=r.module.fields.length+t,a.primary=!1,a.section=l("filter")(r.module.fields,{name:"created_by"},!0)[0].section,a.section_column=2,a.show_label=!0,a.system_type=1,a.validation={readonly:!1,required:!1},o.fields.push(a)}u.update(o,o.id).then(function(){r.saving=!1,s.go("app.setup.approvel_process"),n.success(l("translate")("Setup.Workflow.ApprovelProcess.SubmitSuccess"))})}else r.saving=!1,s.go("app.setup.approvel_process"),n.success(l("translate")("Setup.Workflow.ApprovelProcess.SubmitSuccess"))};r.id?(e.id=r.workflowModel.id,e._rev=r.workflowModel._rev,e.type=r.workflowModel.type,e.created_by=r.workflowModel.created_by,e.updated_by=r.workflowModel.updated_by,e.created_at=r.workflowModel.created_at,e.updated_at=r.workflowModel.updated_at,e.deleted=r.workflowModel.deleted,p.update(e).then(function(){o()})["catch"](function(){r.saving=!1})):p.create(e).then(function(){o()})["catch"](function(){r.saving=!1})},r.generateHookModules=function(o){if(r.id){r.hookParameters=[];var t=o.approvers;angular.forEach(t,function(o){var t={};t.selectedUsers=r.approvers;for(var a=0;a<t.selectedUsers.length;a++){var s=t.selectedUsers[a];s.isSelected=!1}t.approver=l("filter")(e.workgroup.users,{id:o.id},!0)[0];var i=o.order;r.hookParameters[i-1]=t})}};var m=function(){r.hookParameters=[];var e={};e.selectedUsers=r.approvers;for(var o=0;o<e.selectedUsers.length;o++){var l=e.selectedUsers[o];l.isSelected=!1}r.hookParameters.push(e)};r.addNewApprover=function(e,o){var t=angular.copy(e.selectedUsers),a={},s=l("filter")(t,{email:e.approver.email},!0)[0];s.isSelected=!0,a.selectedUsers=t;for(var i=0;i<r.hookParameters.length;i++)if(i!==o){var d=l("filter")(r.hookParameters[i].selectedUsers,{email:e.approver.email},!0)[0];d.isSelected=!0}t.length&&(r.hookParameters.length<=10?r.hookParameters.push(a):n.warning(l("translate")("Setup.Workflow.MaximumHookWarning")))},r.removeApprover=function(e,o){var t=r.hookParameters.indexOf(e);if(o+1!==r.approversLength)for(var a=0;a<r.hookParameters.length;a++)if(e.approver){var s=l("filter")(r.hookParameters[a].selectedUsers,{email:e.approver.email},!0)[0];s.isSelected=!1}r.hookParameters.splice(t,1)},r.approverTypeChanged=function(){r.workflowModel.approver_type&&"dynamicApprover"===r.workflowModel.approver_type?r.hookParameters&&m():(r.workflowModel.firtsApproverLookup&&delete r.workflowModel.firtsApproverLookup,r.workflowModel.first_approver_field&&delete r.workflowModel.first_approver_field)},r.firstApproverModuleChanged=function(){r.workflowModel.first_approver_lookup&&(r.workflowModel.first_approver_lookup=null),r.workflowModel.first_approver_field&&(r.workflowModel.first_approver_field=null),r.workflowModel.secondApproverModule&&(r.workflowModel.secondApproverModule=null),r.workflowModel.second_approver_lookup&&(r.workflowModel.second_approver_lookup=null),r.workflowModel.second_approver_field&&(r.workflowModel.second_approver_field=null)},r.secondApproverModuleChanged=function(){r.workflowModel.second_approver_lookup&&(r.workflowModel.second_approver_lookup=null),r.workflowModel.second_approver_field&&(r.workflowModel.second_approver_field=null)}}]);