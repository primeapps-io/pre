"use strict";angular.module("primeapps").factory("ApprovelProcessService",["$rootScope","$http","config","$filter","operators","helper","ModuleService",function(e,r,a,t,l){return{get:function(e){return r.get(a.apiUrl+"process/get/"+e)},getAll:function(){return r.get(a.apiUrl+"process/get_all")},create:function(e){return r.post(a.apiUrl+"process/create",e)},update:function(e){return r.put(a.apiUrl+"process/update/"+e.id,e)},"delete":function(e){return r["delete"](a.apiUrl+"process/delete/"+e)},getAllProcess:function(){return r.get(a.apiUrl+"process/get_all")},getAllProcessRequests:function(e){return r.get(a.apiUrl+"process_request/get_requests/"+e)},process:function(r){return angular.forEach(r,function(r){var a=t("filter")(e.modules,{id:r.module_id},!0)[0];if(a){r.moduleStr=a["label_"+e.language+"_singular"],r.statusStr=t("translate")(r.active?"Common.Yes":"Common.No"),r.operationsStr="";var l=r.operations.split(",");angular.forEach(l,function(e){r.operationsStr+=t("translate")("Setup.Workflow.RuleTriggers."+e)+", "}),r.operationsStr=r.operationsStr.slice(0,-2)}}),r},getScheduleItems:function(){var e=[],r={};r.label=t("translate")("Setup.Workflow.ScheduleItem0"),r.value="now",e.push(r);var a={};a.label=t("translate")("Setup.Workflow.ScheduleItem1"),a.value=1,e.push(a);for(var l=2;31>l;l++){var o={};o.label=t("translate")("Setup.Workflow.ScheduleItemMany",{day:l}),o.value=l,e.push(o)}return e},getDueDateItems:function(){var e=[],r={};r.label=t("translate")("Setup.Workflow.DueDateItem0"),r.value="now",e.push(r);var a={};a.label=t("translate")("Setup.Workflow.DueDateItem1"),a.value=1,e.push(a);for(var l=2;31>l;l++){var o={};o.label=t("translate")("Setup.Workflow.DueDateItemMany",{day:l}),o.value=l,e.push(o)}return e},processWorkflow:function(r,a,o,p,u,i,s,n,d,f){var v={};v.id=r.id,v.created_by=r.created_by,v.updated_by=r.updated_by,v.created_at=r.created_at,v.updated_at=r.updated_at,v.deleted=r.deleted,v.name=r.name,v.module=a,v.active=r.active,v.frequency=r.frequency||"one_time",v.trigger_time=r.trigger_time,v.approver_type=r.approver_type;var c=[];if(r.profile_list.length>0)for(var m=0;m<r.profile_list.length;m++){var _=t("filter")(e.profiles,{id:parseInt(r.profile_list[m])},!0)[0];c.push(_)}if(v.profiles=c,"dynamicApprover"===v.approver_type){var y={},g=r.approver_field.split(","),h=g[0].split("."),k=t("filter")(v.module.fields,{name:h[0]},!0)[0],S=t("filter")(e.modules,{name:k.lookup_type},!0)[0],b=t("filter")(f,{systemName:h[0]},!0)[0];y.module=S,y.name=k["label_"+e.language]+" ("+y.module["label_"+e.language+"_singular"]+")",y.isSameModule=b.isSameModule,y.systemName=h[0],y.id=b.id,v.firstApproverModule=y,v.first_approver_lookup=t("filter")(S.fields,{name:h[1]},!0)[0];var w=t("filter")(e.modules,{name:v.first_approver_lookup.lookup_type},!0)[0];if(v.first_approver_field=t("filter")(w.fields,{name:h[2]},!0)[0],g.length>1){var M={},A=g[1].split("."),q=t("filter")(v.module.fields,{name:A[0]},!0)[0],D=t("filter")(e.modules,{name:q.lookup_type},!0)[0],I=t("filter")(f,{systemName:A[0]},!0)[0];M.module=D,M.name=q["label_"+e.language]+" ("+M.module["label_"+e.language+"_singular"]+")",M.isSameModule=I.isSameModule,M.systemName=A[0],M.id=I.id,v.secondApproverModule=M,v.second_approver_lookup=t("filter")(D.fields,{name:A[1]},!0)[0];var W=t("filter")(e.modules,{name:v.second_approver_lookup.lookup_type},!0)[0];v.second_approver_field=t("filter")(W.fields,{name:A[2]},!0)[0]}}if(v.operation={},angular.forEach(r.operations_array,function(e){v.operation[e]=!0}),v.user=r.user_id,r.filters){r.filters=t("orderBy")(r.filters,"no");for(var E=0;E<r.filters.length;E++){var N=r.filters[E],U=t("filter")(v.module.fields,{name:N.field},!0)[0],P=null;if(!U)return;switch(U.data_type){case"picklist":P=t("filter")(o[U.picklist_id],{labelStr:N.value},!0)[0];break;case"multiselect":var $=N.value.split("|");P=[],angular.forEach($,function(e){var r=t("filter")(o[U.picklist_id],{labelStr:e},!0)[0];r&&P.push(r)});break;case"lookup":"users"===U.lookup_type?(P=null,N.valueState=angular.copy(N.value)):P=N.value;break;case"checkbox":P=t("filter")(o.yes_no,{system_code:N.value})[0];break;default:P=N.value}N.field=U,N.operator=l[N.operator],N.value=P,"lookup"===U.data_type&&(U.operators=[],U.operators.push(l.equals),U.operators.push(l.not_equal),U.operators.push(l.empty),U.operators.push(l.not_empty)),p[E]=N}}return v},prepareWorkflow:function(e,r){var a={};a.module_id=e.module.id,a.name=e.name,a.user_id=e.user,a.frequency=e.frequency,a.active=e.active,a.trigger_time=e.trigger_time,a.approver_type=e.approver_type;var t=null;if(e.profiles&&e.profiles.length)for(var l=0;l<e.profiles.length;l++){var o=e.profiles[l];null===t?t=o.id:t+=","+o.id}if(a.profiles=t,"dynamicApprover"===e.approver_type&&(a.approver_field=e.firstApproverModule.systemName+"."+e.first_approver_lookup.name+"."+e.first_approver_field.name,e.second_approver_field)){var p=e.secondApproverModule.systemName+"."+e.second_approver_lookup.name+"."+e.second_approver_field.name;a.approver_field+=","+p}return a.operations=[],angular.forEach(e.operation,function(e,r){e&&a.operations.push(r)}),r&&r.length&&(a.filters=[],angular.forEach(r,function(e){if(e.field&&e.operator&&("empty"===e.operator.name||"not_empty"===e.operator.name||null!=e.value&&void 0!=e.value)){var r=e.field,t={};if(t.field=r.name,t.operator=e.operator.name,t.value=e.value,t.no=e.no,"empty"!==e.operator.name&&"not_empty"!==e.operator.name){if(("date"===r.data_type||"date_time"===r.data_type||"time"===r.data_type)&&(t.value=new Date(t.value).getTime()),"picklist"===r.data_type&&(t.value=t.value.id),"multiselect"===r.data_type){var l="";angular.forEach(t.value,function(e){l+=e.id+","}),t.value=l.slice(0,-1)}"lookup"===r.data_type&&"users"!=r.lookup_type&&(t.value=t.value.id),"lookup"===r.data_type&&"users"===r.lookup_type&&(t.value=t.value[0].id),"checkbox"===r.data_type&&(t.value=t.value.system_code)}else t.value="-";a.filters.push(t)}})),e.approvers&&(a.approvers=e.approvers),a}}}]);