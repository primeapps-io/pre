"use strict";angular.module("primeapps").controller("EmailController",["$rootScope","$scope","$filter","EmailService","$mdDialog","mdToast","$stateParams","helper","$state","AppService",function(e,l,a,s,i,n,t,r,o,d){d.checkPermission().then(function(t){if(t&&t.data){var r=JSON.parse(t.data.profile),d=void 0;if(t.data.customProfilePermissions&&(d=JSON.parse(t.data.customProfilePermissions)),!r.HasAdminRights){var m=void 0;d&&(m=d.permissions.indexOf("email")>-1),m||(n.error(a("translate")("Common.Forbidden")),o.go("app.dashboard"))}}e.breadcrumblist=[{title:a("translate")("Layout.Menu.Dashboard"),link:"#/app/dashboard"},{title:a("translate")("Setup.Nav.System"),link:"#/app/setup/general"},{title:a("translate")("Setup.Messaging.EMail.Title")}],l.emailModel=angular.copy(e.system.messaging.SystemEMail)||{},l.newSender={},l.loading=!1,l.goUrl=function(e){window.location=e},null!=l.emailModel&&l.emailModel.hasOwnProperty("provider")||(l.emailModel={provider:"",user_name:"",password:"",senders:[],enable_ssl:!1,dont_send_bulk_email_result:!1}),l.showNewSenderForm=function(){var e=angular.element(document.body);i.show({parent:e,templateUrl:"view/setup/email/senderAdd.html",clickOutsideToClose:!0,scope:l,preserveScope:!0})},l.addNewSender=function(e,s){return this.senderForm.alias.$valid&&this.senderForm.email.$valid?(null==l.emailModel.senders&&(l.emailModel.senders=[]),l.emailModel.senders.push({alias:e,email:s}),l.close(),l.addNewSender=!0,void l.systemForm.$setValidity("noSender",!0)):void n.error(a("translate")("Module.RequiredError"))},l.removeSender=function(e){if(null!=l.emailModel.senders){var a=l.emailModel.senders.indexOf(e);l.emailModel.senders.splice(a,1)}},l.editEMail=function(){0==l.emailModel.senders.length&&l.systemForm.$setValidity("noSender",!1),l.systemForm.$valid&&(l.loading=!0,l.emailModel.host.indexOf("yandex")>-1?(l.emailModel.host="smtp.yandex.ru",l.emailModel.port="587",l.emailModel.enable_ssl=!0):l.emailModel.provider="smtp",s.updateEMailSettings(l.emailModel).then(function(){n.success(a("translate")("Setup.Settings.UpdateSuccess")),s.getSetting().then(function(l){var a=l.data;a.SystemEMail&&(a.SystemEMail.enable_ssl="True"===a.SystemEMail.enable_ssl),a.SystemEMail&&a.SystemEMail.dont_send_bulk_email_result&&(a.SystemEMail.dont_send_bulk_email_result="True"===a.SystemEMail.dont_send_bulk_email_result),a.PersonalEMail&&(a.PersonalEMail.enable_ssl="True"===a.PersonalEMail.enable_ssl),a.PersonalEMail&&a.PersonalEMail.dont_send_bulk_email_result&&(a.PersonalEMail.dont_send_bulk_email_result="True"===a.PersonalEMail.dont_send_bulk_email_result),e.system.messaging=a}),l.loading=!1}))},l.resetEMailForm=function(){l.emailModel=angular.copy(e.system.messaging.SystemEMail)},l.removeEMailSettings=function(){s.removeEMailSettings(l.emailModel).then(function(){l.emailModel=null,e.system.messaging.SystemEMail=null})},l.close=function(){i.hide()},l.submitGeneral=function(){return l.systemForm.$valid?void l.editEMail(l.emailModel):void n.error(a("translate")("Module.RequiredError"))}})}]);