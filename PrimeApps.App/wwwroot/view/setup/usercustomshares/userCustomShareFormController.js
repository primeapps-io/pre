"use strict";angular.module("primeapps").controller("UserCustomShareFormController",["$rootScope","$location","$scope","$filter","guidEmpty","blockUI","$state","UserCustomShareService","helper","mdToast",function(e,r,s,a,t,u,l,d,n,o){s.$parent.$parent.selectedShare&&(s.id=s.$parent.$parent.selectedShare.id,s.language=e.language,s.userOwner={},s.lookupUserAndGroup=n.lookupUserAndGroup,d.getAll().then(function(e){if(s.userCustomShares=e.data,!s.id)for(var r=0;r<e.data.length;r++){var t=e.data[r];if(a("filter")(s.users,{id:t.user_id},!0)[0]){var u=a("filter")(s.users,{id:t.user_id},!0)[0].email;s.users=a("filter")(s.users,{email:"!"+u},!0)}}}),s.multiselect=function(){return a("filter")(e.modules,function(e){return 0!==e.order},!0)},s.id&&(s.loadingModal=!0,d.get(s.id).then(function(r){s.userOwner.user=r.data.user_id,s.userOwner.shared_user=r.data.shared_user_id;var t=[],u=[];if(r.data.user_groups_list.length>0&&"{}"!==r.data.user_groups_list[0]&&d.getUserGroups().then(function(e){for(var s=r.data.user_groups.replace("{","").replace("}","").split(","),u=0;u<r.data.user_groups_list.length;u++){var l=a("filter")(e.data,{id:parseInt(s[u])},!0)[0],d={description:"User Group",id:l.id,name:l.name,type:"group"};t.push(d)}}),r.data.users_list.length>0)for(var l=0;l<r.data.users_list.length;l++){var n=a("filter")(e.users,{id:parseInt(r.data.users_list[l])},!0)[0],o={description:n.Email,id:n.id,name:n.FullName,type:"user"};t.push(o)}if(r.data.module_list.length>0)for(var i=0;i<r.data.module_list.length;i++){var p=a("filter")(e.modules,{name:r.data.module_list[i]},!0)[0];u.push(p)}s.userOwner.modules=u,s.userOwner.owners=t,s.loadingModal=!1})),s.setFormValid=function(){s.userOwnerForm.shared.$setValidity("minTags",!0)},s.save=function(){if(s.userOwnerForm.$valid){s.loadingModal=!0;var r=null;if(s.userOwner.owners&&s.userOwner.owners.length){s.shared_users=null,s.shared_user_groups=null;for(var t=0;t<s.userOwner.owners.length;t++){var u=s.userOwner.owners[t];"user"===u.type&&(null===s.shared_users?s.shared_users=u.id:s.shared_users+=","+u.id),"group"===u.type&&(null===s.shared_user_groups?s.shared_user_groups=u.id:s.shared_user_groups+=","+u.id)}}if(s.userOwner.modules&&s.userOwner.modules.length)for(var l=0;l<s.userOwner.modules.length;l++){var n=s.userOwner.modules[l];null===r?r=n.name:r+=","+n.name}var i={user_id:s.userOwner.user,shared_user_id:s.userOwner.shared_user,users:s.shared_users,user_groups:s.shared_user_groups,modules:r};s.id?d.update(s.id,i).then(function(){o.success(a("translate")("Setup.UserCustomShares.EditSuccess")),e.closeSide("sideModal"),s.$parent.$parent.grid.dataSource.read()})["catch"](function(){error(data,status),e.closeSide("sideModal"),s.loadingModal=!1}):d.create(i).then(function(){o.success(a("translate")("Setup.UserCustomShares.SaveSuccess")),s.$parent.$parent.grid.dataSource.read(),e.closeSide("sideModal")})["catch"](function(){error(data,status),s.loadingModal=!1})}else o.error(a("translate")("Module.RequiredError"))},s.usersOptions={dataSource:s.users,filter:"contains",dataValueField:"id",dataTextField:"full_name",optionLabel:a("translate")("Setup.Workflow.ApprovelProcess.SelectUser"),template:"<span>{{dataItem.full_name}} - {{dataItem.email}}</span>",valueTemplate:"<span>{{dataItem.full_name}} - {{dataItem.email}}</span>"},s.modulesOptions={dataSource:a("filter")(e.modules,function(e){return"users"!==e.name&&"profiles"!==e.name&&"roles"!==e.name}),filter:"contains",dataTextField:"label_"+s.language+"_plural",dataValueField:"id"})}]);