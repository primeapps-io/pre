"use strict";angular.module("primeapps").controller("ModuleRelationController",["$rootScope","$scope","$filter","$state","$stateParams","$timeout","helper","dragularService","ModuleSetupService","ModuleService","AppService","mdToast",function(e,l,a,t,n,o,r,i,u,d,s,c){var p=a("filter")(e.modules,{name:n.module},!0)[0];if(!p)return c.warning(a("translate")("Common.NotFound")),void t.go("app.dashboard");l.module=angular.copy(p),l.relations=u.processRelations(l.module.relations),l.relationsState=angular.copy(l.relations),l.showFormModal=function(t){if(!t){t={};var n=[];angular.forEach(l.relations,function(e){n.push(e.order)});var o=Math.max.apply(null,n);o=0>o?0:o,t.order=o+1,t.relation_type="one_to_many",t.isNew=!0}l.currentRelation=t,l.currentRelation.hasRelationField=!0,l.currentRelationState=angular.copy(l.currentRelation),l.fields=u.getFields(l.currentRelation),l.currentRelation.detail_view_type||(l.currentRelation.detail_view_type="tab");var r={};r["label_"+e.language+"_plural"]="!"+l.module["label_"+e.language+"_plural"],l.moduleLists=a("filter")(e.modules,r,!0)};var m,f;l.bindDragDrop=function(){o(function(){function e(e,l,a){return a!=l?!0:void 0}m&&m.destroy(),f&&f.destroy();var a=document.querySelector("#availableFields"),t=document.querySelector("#selectedFields");m=i([a],{scope:l,containersModel:[l.fields.availableFields],classes:{mirror:"gu-mirror-option",transit:"gu-transit-option"},accepts:e,moves:function(e,l,a){return a.classList.contains("dragable")}}),f=i([t],{scope:l,classes:{mirror:"gu-mirror-option",transit:"gu-transit-option"},containersModel:[l.fields.selectedFields]})},100)},l.relatedModuleChanged=function(){l.currentRelation.relationField=null,l.currentRelation.relatedModule&&(l.currentRelation.hasRelationField=a("filter")(l.currentRelation.relatedModule.fields,{data_type:"lookup",lookup_type:n.module,deleted:!1},!0).length>0),l.currentRelation.display_fields=null,l.fields=u.getFields(l.currentRelation),"many_to_many"===l.currentRelation.relation_type&&l.bindDragDrop()},l.relationTypeChanged=function(){"many_to_many"===l.currentRelation.relation_type&&l.bindDragDrop()},l.save=function(t){if(t.$valid){if(l.saving=!0,t.two_way)var o=t;else var o=angular.copy(l.currentRelation);if(o.display_fields=[],l.fields.selectedFields&&l.fields.selectedFields.length>0)angular.forEach(l.fields.selectedFields,function(l){if(o.display_fields.push(l.name),l.lookup_type){var t=a("filter")(e.modules,{name:l.lookup_type},!0)[0],n=a("filter")(t.fields,{primary:!0},!0)[0];o.display_fields.push(l.name+"."+t.name+"."+n.name+".primary")}});else{var r=a("filter")(o.relatedModule.fields,{primary:!0})[0];o.display_fields.push(r.name)}o.isNew&&(delete o.isNew,l.relations||(l.relations=[]),"many_to_many"===o.relation_type&&(o.relationField={},o.relationField.name=p.name)),u.prepareRelation(o);var i=function(){var e={display_fields:null,hasRelationField:!1,isNew:!0,order:l.currentRelation.order,relatedModule:l.module,relationField:null,relation_type:"many_to_many",$valid:!0,two_way:!0,mainModule:o.related_module};l.currentRelation.hasOwnProperty("label_en_singular")?(e.label_en_singular=l.module.label_en_singular,e.label_en_plural=l.module.label_en_plural):(e.label_tr_singular=l.module.label_tr_singular,e.label_tr_plural=l.module.label_tr_plural),l.fields.selectedFields=[],l.save(e)},m=function(){!o.two_way&&"many_to_many"===o.relation_type&&l.currentRelation.isNew?i():s.getMyAccount(!0).then(function(){l.module=angular.copy(a("filter")(e.modules,{name:n.module},!0)[0]),l.relations=u.processRelations(l.module.relations),c.success(a("translate")("Setup.Modules.RelationSaveSuccess")),l.saving=!1,l.formModal.hide()})},f=function(){l.relations=l.relationsState,l.formModal&&(l.formModal.hide(),l.saving=!1)};if(o.id)d.updateModuleRelation(o,l.module.id).then(function(){m()})["catch"](function(){f()});else{if(o.mainModule)var _=a("filter")(e.modules,{name:o.mainModule},!0)[0].id;d.createModuleRelation(o,o.two_way?_:l.module.id).then(function(){m()})["catch"](function(){f()})}}},l["delete"]=function(e){d.deleteModuleRelation(e.id).then(function(){s.getMyAccount(!0).then(function(){var t=r.arrayObjectIndexOf(l.relations,e);l.relations.splice(t,1),c.success(a("translate")("Setup.Modules.RelationDeleteSuccess"))})})["catch"](function(){l.relations=l.relationsState,l.formModal&&(l.formModal.hide(),l.saving=!1)})},l.cancel=function(){angular.forEach(l.currentRelation,function(e,a){l.currentRelation[a]=l.currentRelationState[a]}),l.formModal.hide()}}]);