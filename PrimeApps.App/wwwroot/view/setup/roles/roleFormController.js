"use strict";angular.module("primeapps").controller("RoleFormController",["$rootScope","$location","$scope","$filter","guidEmpty","blockUI","$state","RoleService","mdToast",function(e,r,a,t,l,o,s,i,n){function d(e){var r=t("filter")(a.roles,{reports_to:e});a.roles=t("filter")(a.roles,{reports_to:"!"+e}),angular.forEach(r,function(e){d(e.id)})}if(a.hasAdminRight=t("filter")(e.profiles,{id:e.user.profile.id},!0)[0].has_admin_rights,a.hasAdminRight||helper.hasCustomProfilePermission("roles")||(n.error(t("translate")("Common.Forbidden")),s.go("app.dashboard")),a.$parent.$parent.currentRole){a.loading=!0,a.id=a.$parent.$parent.currentRole.id;var p=a.$parent.$parent.currentRole.reportsTo;a.roleUsers=[],a.role={},a.role.share_data=!1,a.role_change=!1,a.reportsTo_disabled=!0,a.id||(a.reportsTo_disabled=!1),i.getAll().then(function(r){a.allRoles=r.data,a.roles=t("filter")(a.allRoles,{id:"!"+a.id}),a.id?(d(a.id),a.role=t("filter")(a.allRoles,{id:a.id},!0)[0],a.role.label=a.role["label_"+e.language],a.role.description=a.role["description_"+e.language],a.role.master||(a.role.reports_to=t("filter")(a.allRoles,{id:a.role.reports_to},!0)[0].id),(void 0===a.role.share_data||null===a.role.share_data)&&(a.role.share_data=!1),angular.forEach(a.role.users,function(r){var l=t("filter")(e.workgroup.users,{id:r},!0)[0];if(l){var o=t("filter")(e.users,{id:l.id,full_name:"!Integration User"},!0)[0];o&&a.roleUsers.push(o)}})):p&&(a.role.reports_to=p),a.loading=!1}),a.save=function(){if(a.roleForm.$valid&&a.role.reports_to){a.saving=!0;var r=angular.copy(a.role),l=null,o=a.role_change,s="Setup.Roles.SaveSuccess";r.label_tr=r.label,r.label_en=r.label,r.description_tr=r.description,r.description_en=r.description,l=a.id?i.update(r,o):i.create(r),l.then(function(){o&&(s="Setup.Roles.LongSaveSuccess"),n.success(t("translate")(s)),e.closeSide("sideModal"),a.$parent.$parent.$parent.loading=!0,a.$parent.$parent.$parent.load()})["finally"](function(){a.saving=!1})}else n.error(t("translate")("Module.RequiredError"))},a.roleUpdateChange=function(){a.role_change=!0},a.reportToOptions={dataSource:new kendo.data.HierarchicalDataSource({data:a.$parent.$parent.tree}),valuePrimitive:!0,dataTextField:"title",dataValueField:"id",filter:"contains",select:function(e){var r=e.sender.dataItem(e.node);r.id===a.id?(e.preventDefault(),n.warning(t("translate")("Setup.Roles.Warning"))):a.roleUpdateChange()},placeholder:t("translate")("Common.Select")},a.usersGridOptions={dataSource:{data:a.roleUsers,page:1,pageSize:10,serverPaging:!1,serverFiltering:!1,serverSorting:!1,schema:{model:{id:"id",fields:{full_name:{type:"string"},email:{type:"string"}}}}},scrollable:!1,persistSelection:!0,sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100],buttonCount:5,info:!0},columns:[{field:"email",title:t("translate")("Setup.Users.UserEmail")},{field:"full_name",title:t("translate")("Setup.Users.UserFullName")},{field:"",title:t("translate")("Setup.Users.UserStatus"),template:function(e){return e.is_subscriber?"<span>"+t("translate")("Setup.Users.GroupOwner")+"</span>":e.id?"<span>"+t("translate")("Setup.Users.UserStatus1")+"</span>":"<span>"+t("translate")("Setup.Users.UserStatus2")+"</span>"}}]}}}]);