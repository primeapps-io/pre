"use strict";angular.module("primeapps").controller("RoleFormController",["$rootScope","$location","$scope","$filter","guidEmpty","blockUI","$state","RoleService","mdToast",function(e,r,a,t,l,s,o,n,i){function d(e){var r=t("filter")(a.roles,{reports_to:e});a.roles=t("filter")(a.roles,{reports_to:"!"+e}),angular.forEach(r,function(e){d(e.id)})}if(a.hasAdminRight=t("filter")(e.profiles,{id:e.user.profile.id},!0)[0].has_admin_rights,a.hasAdminRight||helper.hasCustomProfilePermission("roles")||(i.error(t("translate")("Common.Forbidden")),o.go("app.dashboard")),a.$parent.$parent.currentRole){a.loading=!0,a.id=a.$parent.$parent.currentRole.id;var p=a.$parent.$parent.currentRole.reportsTo;a.roleUsers=[],a.role={},a.role.share_data=!1,a.role_change=!1,a.reportsTo_disabled=a.id,n.getAll().then(function(r){a.allRoles=r.data,e.processLanguages(a.allRoles),a.roles=t("filter")(a.allRoles,{id:"!"+a.id}),a.id?(d(a.id),a.role=t("filter")(a.allRoles,{id:a.id},!0)[0],a.role.master||(a.role.reports_to=t("filter")(a.allRoles,{id:a.role.reports_to},!0)[0].id),(void 0===a.role.share_data||null===a.role.share_data)&&(a.role.share_data=!1),angular.forEach(a.role.users,function(r){var l=t("filter")(e.users,{id:r,full_name:"!Integration User",deleted:!1},!0)[0];l&&a.roleUsers.push(l)})):p&&(a.role.reports_to=p),a.loading=!1}),a.save=function(){if(a.roleForm.validate()){a.saving=!0;var r=angular.copy(a.role),l=null,s=a.role_change,o="Setup.Roles.SaveSuccess";e.languageStringify(r),l=a.id?n.update(r,s):n.create(r),l.then(function(){s&&(o="Setup.Roles.LongSaveSuccess"),i.success(t("translate")(o)),e.closeSide("sideModal"),a.$parent.$parent.$parent.loading=!0,a.$parent.$parent.$parent.load()})["finally"](function(){a.saving=!1})["catch"](function(){a.saving=!1,e.closeSide("sideModal"),a.$parent.$parent.$parent.load()})}else i.error(t("translate")("Module.RequiredError"))},a.roleUpdateChange=function(){a.role_change=!0},a.reportToOptions={dataSource:new kendo.data.HierarchicalDataSource({data:a.$parent.$parent.tree}),dataTextField:"title",dataValueField:"id",select:function(e){var r=e.sender.dataItem(e.node);r.id===a.id?(e.preventDefault(),i.warning(t("translate")("Setup.Roles.Warning"))):a.roleUpdateChange()},placeholder:t("translate")("Common.Select")},a.usersGridOptions={dataSource:{data:a.roleUsers,page:1,pageSize:10,serverPaging:!1,serverFiltering:!1,serverSorting:!1,schema:{model:{id:"id",fields:{full_name:{type:"string"},email:{type:"string"}}}}},scrollable:!0,persistSelection:!0,sortable:!0,noRecords:!0,pageable:{refresh:!0,pageSize:10,pageSizes:[10,25,50,100],buttonCount:5,info:!0},columns:[{field:"email",title:t("translate")("Setup.Users.UserEmail")},{field:"full_name",title:t("translate")("Setup.Users.UserFullName")},{field:"",title:t("translate")("Setup.Users.UserStatus"),template:function(e){return e.is_subscriber?"<span>"+t("translate")("Setup.Users.GroupOwner")+"</span>":e.id?"<span>"+t("translate")("Setup.Users.UserStatus1")+"</span>":"<span>"+t("translate")("Setup.Users.UserStatus2")+"</span>"}}]}}}]);